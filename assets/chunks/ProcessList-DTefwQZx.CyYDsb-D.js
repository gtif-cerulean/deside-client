import{a as T,V as b,L as P,M as C,N as O,H as R,K as B,O as x,I as f,P as L,Q as D,R as J,S as N,T as E,l as U,J as $,i as k,W as F,X as I,Y as G,Z as M,$ as V}from"./eo-dash.BafBzV9i.js";import{g as H}from"./utils.C66ckBg2.js";import{T as v}from"./index-4CT7Tz83.vFq5hY8q.js";import{p as W,al as z,v as A,c as w,o as g,b as K,e as Q,k as d,w as X,j as n,F as Y,B as Z,t as m,as as h,G as p}from"./framework.aZ46aqSj.js";import"./commonjsHelpers.BosuxZz1.js";import"./index.BSpBAx16.js";import"./VTooltip-CfeefrXI.CqM19jxq.js";import"./VOverlay-BzOdRu9h.6A-FMRef.js";import"./forwardRefs-Bon_Kku1.B726PJ_w.js";import"./transition-C5I57hn6.BcGHjbSd.js";function xe(e){return Object.keys((e==null?void 0:e.properties)??{}).find(t=>(e==null?void 0:e.properties[t].format)==="bounding-box")}function q(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(t=>(e==null?void 0:e.properties[t].type)==="geojson")}function _e(e,t){const o=q(t);for(const s of o)e[s]&&(H(t==null?void 0:t.properties[s])?e[s]=e[s].features.map(a=>JSON.stringify(a.geometry)):e[s]=JSON.stringify(e[s].geometry))}async function j(e,t,o,s,a){let r=null;"eox:flatstyle"in(e??{})&&(r=await R.get(e["eox:flatstyle"]).then(c=>c.data));let u,i;if(r){const c=B(t??"",r);u=c.layerConfig,i=c.style}o=o.sort();const l=o.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!i,sources:o.map(c=>({url:c}))},properties:{id:t+"_geotiff_process"+a,title:"Results "+t,...u&&{layerConfig:u},layerControlToolsExpand:!0},...i&&{style:i}}:void 0;return s&&l&&(l.source.projection=s),l}const S=(e,t)=>{if(!t)return;let o=t;if(typeof t=="object"){t=JSON.stringify(t);const a=new Blob([t],{type:"text"});o=URL.createObjectURL(a)}const s=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(s.href=o,s.download=e,s.click()),URL.revokeObjectURL(o),s.remove()},y=W([]);async function ke({processUrl:e,isPolling:t,pollInterval:o=1e4,maxRetries:s=560}){let a=0;for(t.value=!0,setTimeout(()=>{_(y,f)},500);a<s&&t.value;){try{const r=new Date().getTime(),i=(await x.get(`${e}?t=${r}`)).data;if(i.status==="successful"){console.log("Process completed successfully. Fetching result item...");const l=i.links[1].href;if(!l)throw new Error("Result links not found in the process report.");const c=await x.get(l);return console.log("Result file fetched successfully:",c.data),c.data}if(i.status==="failed")throw t.value=!1,new Error("Process failed.",i);console.log(`Status: ${i.status}. Retrying in ${o/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,o)),a++}if(!t.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function _(e,t){const o=JSON.parse(localStorage.getItem(t.value)||"[]"),s=await Promise.all(o.map(a=>fetch(a).then(r=>r.json())));s.sort((a,r)=>new Date(r.job_start_datetime).getTime()-new Date(a.job_start_datetime).getTime()),e.value=s}const ee=async e=>{const o=JSON.parse(localStorage.getItem(f.value)||"[]").filter(s=>!s.includes(e.jobID));localStorage.setItem(f.value,JSON.stringify(o)),_(y,f)},te=async(e,t)=>{const o=[];await fetch(e.links[1].href).then(s=>s.json()).then(s=>{o.push(...s.urls)}),o.forEach(s=>{if(!s)return;let a="";typeof s=="string"?(a=s.includes("/")?s.split("/").pop()??"":s,a=a.includes("?")?a.split("?")[0]:a):a=(t==null?void 0:t.id)+"_process_results.json",S(a,s)})},se=async(e,t)=>{const o=[];await x.get(e.links[1].href).then(s=>o.push(s.data)),await oe({selectedStac:t,results:o,jobId:e.jobID})};async function oe({selectedStac:e,results:t,jobId:o}){var r;const s=e==null?void 0:e.links.filter(u=>u.rel==="service"&&u.type==="image/tiff"),a=await j(s==null?void 0:s[0],(e==null?void 0:e.id)??"",t==null?void 0:t[0].urls,((r=e==null?void 0:e["eodash:mapProjection"])==null?void 0:r.name)??null,o);if(U.debug("rendered layers after loading previous process:",a),a){const u=[...a?[a]:[]];let i=[...$()],l=i.find(c=>c.properties.id.includes("AnalysisGroup"));l==null||l.layers.push(...u),k.value&&(k.value.layers=[...i])}}const ae=D({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...M(),...G(),...I(),...F()},"VTable"),re=L()({name:"VTable",props:ae(),setup(e,t){let{slots:o,emit:s}=t;const{themeClasses:a}=J(e),{densityClasses:r}=N(e);return E(()=>p(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!o.top,"v-table--has-bottom":!!o.bottom,"v-table--hover":e.hover},a.value,r.value,e.class],style:e.style},{default:()=>{var u,i,l;return[(u=o.top)==null?void 0:u.call(o),o.default?p("div",{class:"v-table__wrapper",style:{height:V(e.height)}},[p("table",null,[o.default()])]):(i=o.wrapper)==null?void 0:i.call(o),(l=o.bottom)==null?void 0:l.call(o)]}})),{}}}),ie={style:{padding:"0px"}},le={style:{padding:"0px"}},ne={style:{padding:"0px"}},ue={__name:"ProcessList",setup(e){const{selectedStac:t}=z(T());return A(()=>_(y,f)),(o,s)=>(g(),w("div",null,[d(y).length?(g(),K(re,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:X(()=>[s[0]||(s[0]=n("thead",null,[n("tr",null,[n("th",{class:"text-left"},"Executed on"),n("th",{class:"text-left"},"Status"),n("th",{class:"text-left"}),n("th",{class:"text-left"}),n("th",{class:"text-left"})])],-1)),n("tbody",null,[(g(!0),w(Y,null,Z(d(y),a=>(g(),w("tr",{key:a.date},[n("td",null,m(new Date(a.job_start_datetime).toISOString().slice(0,16)),1),n("td",null,m(a.status),1),n("td",ie,[h(p(b,{disabled:a.status!=="successful",color:"primary",onClick:r=>d(se)(a,d(t)),icon:[d(P)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Load results to map"]])]),n("td",le,[h(p(b,{disabled:a.status!=="successful",color:"primary",onClick:r=>d(te)(a,d(t)),icon:[d(C)],variant:"text"},null,8,["disabled","onClick","icon"]),[[v,"Download results"]])]),n("td",ne,[h(p(b,{color:"#ff5252",onClick:r=>d(ee)(a),icon:[d(O)],variant:"text"},null,8,["onClick","icon"]),[[v,"Remove job"]])])]))),128))])]),_:1})):Q("v-if",!0)]))}},me=Object.freeze(Object.defineProperty({__proto__:null,default:ue},Symbol.toStringTag,{value:"Module"}));export{me as P,ue as _,j as c,S as d,_e as e,xe as g,y as j,ke as p,_ as u};
