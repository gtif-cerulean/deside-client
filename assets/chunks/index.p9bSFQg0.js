const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.CwDvYQhx.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/GeoJSON.BpNGZz9Z.js","assets/chunks/extent.D0Y4ddoY.js","assets/chunks/WMTS.CXwKjwDx.js","assets/chunks/Group.CgQ1XIRJ.js","assets/chunks/WKT.DOYiNvu3.js","assets/chunks/framework.74XsaJss.js","assets/chunks/item.koN_VtZd.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var gu=Object.defineProperty;var pu=(i,e,t)=>e in i?gu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>pu(i,typeof e!="symbol"?e+"":e,t);import{O as mu,F as Ke,A as oe,Q as De,T as _u,U as yu,V as Un,n as Ki,l as Zr,M as us,P as cr,L as Et,j as et,W as hs,X as Eu,k as xu,Y as bu,Z as Tu,G as Br,S as Ao,_ as wu,$ as wi,a0 as Gr,a1 as Lo,a2 as Ei,a as Ie,c as fs,a3 as Su,a4 as Io,a5 as Ru,a6 as ds,p as Ja,b as xt,R as vu,a7 as Pu,a8 as Qa,m as zr,a9 as Au,aa as $r,ab as Lu,q as Iu,t as Cu,ac as Co,ad as Fo,J as gs,C as Bn,z as el,ae as Oo,af as Fu,s as Ou}from"./GeoJSON.BpNGZz9Z.js";import{P as Mu,G as Si,Q as Ri,o as tl,n as Je,d as ps,r as ms,R as Nu,S as Du,U as Uu,W as ft,j as kr,i as Ji,X as Lt,p as ur,g as Ce,c as ye,Y as hr,Z as sr,f as ce,D as rl,_ as Bu,T as Gu,E as Be,$ as zu,a0 as $u,e as ku,I as Yr,l as mt,C as _s,u as vi,L as il,a1 as rt,B as nl,H as ju,x as Gn,J as Mo,a2 as Vu,t as Xu,s as Wu,w as Hu,a3 as No,a4 as Zu,M as Yu,A as qu}from"./extent.D0Y4ddoY.js";import{a9 as Qi,aa as z,ab as U,ac as F,ad as Pi,ae as Ku,af as It,ag as X,ah as b,ai as K,aj as fe,ak as We,al as _r,am as Pt,an as jr,ao as sl,ap as Ai,aq as Li,ar as O,as as x,at as C,au as en,av as Ee,aw as Ne,ax as ys,ay as ol,az as Ii,aA as Gt,aB as Ju,aC as ue,aD as tt,aE as ht,v as Qu,K as eh,aF as th,aG as rh,o as al,a3 as Ci,a2 as xi,aH as Do,a8 as Fi,h as $t,p as tn,aI as ih,aJ as q,aK as Es,aL as it,aM as nh,aN as xs,aO as zn,aP as $n,aQ as Ft,aR as sh,R as xn,aS as oh,aT as kn,aU as ll,aV as tr,aW as qr,aX as ah,aY as lh,aZ as ie,a_ as rn,a$ as Vr,b0 as $e,b1 as Ot,b2 as yr,b3 as ch,b4 as W,b5 as cl,b6 as ul,b7 as uh,b8 as hh,u as At,m as Mt,B as nn,b9 as hl,ba as kt,bb as fh,bc as dh,bd as gh,be as ph,L as bs,bf as mh,bg as _h,bh as yh,bi as Eh,bj as xh,bk as bh,$ as Ts,a5 as Wt,bl as Ht,bm as Th,bn as wh,bo as bn,bp as sn,O as Er,I as Zt,F as ws,bq as Tt,br as fl,bs as Sh,bt as Rh,y as vh,Z as Ss,a1 as Ph,U as dl,X as Oi,Y as Ah,bu as gl,_ as Lh,Q as Ih,S as jn,x as Ch,w as Fh,bv as Rs,bw as Vn,bx as pl,by as Uo,bz as Mi,bA as ml,bB as Oh,bC as _l,T as Mh,bD as vs,bE as Nh,bF as Dh,bG as Uh,bH as Bh,bI as Gh,bJ as zh,bK as $h,bL as kh}from"./WMTS.CXwKjwDx.js";import{T as yl,W as jh}from"./WKT.DOYiNvu3.js";import{C as Vh,b as Xn,L as Xh}from"./Group.CgQ1XIRJ.js";import{g as El}from"./commonjsHelpers.BosuxZz1.js";import{O as Dt}from"./framework.74XsaJss.js";import{S as Wh,a as Hh,u as Ps,b as xl,C as bl,I as As,M as Zh,A as ui,c as Ar,d as Yh,f as qh,g as Bo,i as Go}from"./item.koN_VtZd.js";class Ls extends Wh{constructor(e,t=null,r={},n=[]){super(e,t,r,n)}getAll(){return[]}}class Kh extends Hh{constructor(e,t=null){super(e,t)}}class Jh extends Ls{constructor(e,t=null){const r={collections:n=>n.map(s=>new bl(s))};super(e,t,r)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return Ps(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return xl(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class Tl extends Ls{constructor(e,t=null){const r={features:n=>n.map(s=>new As(s))};super(e,t,r)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return Ps(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return xl(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function hi(i,e=!0,t=!1){return e&&(i=Zh.stac(i,t)),i.type==="Feature"?new As(i):i.type==="FeatureCollection"?new Tl(i):i.type==="Collection"||!i.type&&typeof i.extent<"u"&&typeof i.license<"u"?new bl(i):!i.type&&Array.isArray(i.collections)?new Jh(i):new Kh(i)}const Qh={Point:nf,LineString:sf,Polygon:cf,MultiPoint:af,MultiLineString:of,MultiPolygon:lf},ef={Point:uf,LineString:hf,Polygon:ff,MultiPoint:gf,MultiLineString:df,MultiPolygon:pf};class tf extends mu{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,r){const n=e,s=zo(n.geometry,t),o=new Ke;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[r];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const r=e,n=[],s=r.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return zo(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const r=e.spatialReference.wkid;return oe("EPSG:"+r)}return null}writeGeometryObject(e,t){return $o(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const r={};if(!e.hasProperties())return r.attributes={},r;const n=e.getProperties(),s=e.getGeometry();if(s){r.geometry=$o(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(r.geometry.spatialReference={wkid:Number(oe(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Mu(n)?r.attributes={}:r.attributes=n,r}writeFeaturesObject(e,t){t=this.adaptOptions(t);const r=[];for(let n=0,s=e.length;n<s;++n)r.push(this.writeFeatureObject(e[n],t));return{features:r}}}function zo(i,e){if(!i)return null;let t;if(typeof i.x=="number"&&typeof i.y=="number")t="Point";else if(i.points)t="MultiPoint";else if(i.paths)i.paths.length===1?t="LineString":t="MultiLineString";else if(i.rings){const n=i,s=xr(n),o=rf(n.rings,s);o.length===1?(t="Polygon",i=Object.assign({},i,{rings:o[0]})):(t="MultiPolygon",i=Object.assign({},i,{rings:o}))}const r=Qh[t];return De(r(i),!1,e)}function rf(i,e){const t=[],r=[],n=[];let s,o;for(s=0,o=i.length;s<o;++s)t.length=0,_u(t,0,i[s],e.length),yu(t,0,t.length,e.length)?r.push([i[s]]):n.push(i[s]);for(;n.length;){const a=n.shift();let l=!1;for(s=r.length-1;s>=0;s--){const c=r[s][0];if(Si(new Un(c).getExtent(),new Un(a).getExtent())){r[s].push(a),l=!0;break}}l||r.push([a.reverse()])}return r}function nf(i){let e;return i.m!==void 0&&i.z!==void 0?e=new et([i.x,i.y,i.z,i.m],"XYZM"):i.z!==void 0?e=new et([i.x,i.y,i.z],"XYZ"):i.m!==void 0?e=new et([i.x,i.y,i.m],"XYM"):e=new et([i.x,i.y]),e}function sf(i){const e=xr(i);return new Et(i.paths[0],e)}function of(i){const e=xr(i);return new Zr(i.paths,e)}function xr(i){let e="XY";return i.hasZ===!0&&i.hasM===!0?e="XYZM":i.hasZ===!0?e="XYZ":i.hasM===!0&&(e="XYM"),e}function af(i){const e=xr(i);return new us(i.points,e)}function lf(i){const e=xr(i);return new Ki(i.rings,e)}function cf(i){const e=xr(i);return new cr(i.rings,e)}function uf(i,e){const t=i.getCoordinates();let r;const n=i.getLayout();if(n==="XYZ")r={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")r={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")r={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")r={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return r}function Kr(i){const e=i.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function hf(i,e){const t=Kr(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:[i.getCoordinates()]}}function ff(i,e){const t=Kr(i);return{hasZ:t.hasZ,hasM:t.hasM,rings:i.getCoordinates(!1)}}function df(i,e){const t=Kr(i);return{hasZ:t.hasZ,hasM:t.hasM,paths:i.getCoordinates()}}function gf(i,e){const t=Kr(i);return{hasZ:t.hasZ,hasM:t.hasM,points:i.getCoordinates()}}function pf(i,e){const t=Kr(i),r=i.getCoordinates(!1),n=[];for(let s=0;s<r.length;s++)for(let o=r[s].length-1;o>=0;o--)n.push(r[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function $o(i,e){const t=ef[i.getType()];return t(De(i,!0,e),e)}const yt="http://www.opengis.net/gml",mf=/^\s*$/;class D extends Qi{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:U(this.readFeaturesInternal),featureMembers:z(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const r=e.localName;let n=null;if(r=="FeatureCollection")n=F([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(r=="featureMembers"||r=="featureMember"||r=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",c="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,g=e.childNodes.length;f<g;++f){const d=e.childNodes[f];if(d.nodeType===1){const p=d.nodeName.split(":").pop();if(!o.includes(p)){let m="",y=0;const _=d.namespaceURI;for(const E in a){if(a[E]===_){m=E;break}++y}m||(m=l+y,a[m]=_),o.push(m+":"+p)}}}r!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[c]=f}const h={},u=Array.isArray(o)?o:[o];for(const f in a){const g={};for(let d=0,p=u.length;d<p;++d)(u[d].includes(":")?u[d].split(":")[0]:c)===f&&(g[u[d].split(":").pop()]=r=="featureMembers"?U(this.readFeatureElement,this):z(this.readFeatureElement,this));h[a[f]]=g}r=="featureMember"||r=="member"?n=F(void 0,h,e,t):n=F([],h,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const r=t[0];return r.srsName=e.firstElementChild.getAttribute("srsName"),r.srsDimension=e.firstElementChild.getAttribute("srsDimension"),F(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?hs(n,r):void 0}readGeometryElement(e,t){const r=t[0],n=this.readGeometryOrExtent(e,t);return n?De(n,!1,r):void 0}readFeatureElementInternal(e,t,r){let n;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let c;const h=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(c=Pi(l,!1),mf.test(c)&&(c=void 0)):(r&&(c=h==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),c?h!=="boundedBy"&&(n=h):c=this.readFeatureElementInternal(l,t,!1));const u=l.attributes.length;if(u>0&&!(c instanceof Eu)){c={_content_:c};for(let f=0;f<u;f++){const g=l.attributes[f].name;c[g]=l.attributes[f].value}}s[h]?(s[h]instanceof Array||(s[h]=[s[h]]),s[h].push(c)):s[h]=c}if(!r)return s;const o=new Ke(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||Ku(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new et(r,"XYZ")}readMultiPoint(e,t){const r=F([],this.MULTIPOINT_PARSERS,e,t,this);if(r)return new us(r)}readMultiLineString(e,t){const r=F([],this.MULTILINESTRING_PARSERS,e,t,this);if(r)return new Zr(r)}readMultiPolygon(e,t){const r=F([],this.MULTIPOLYGON_PARSERS,e,t,this);if(r)return new Ki(r)}pointMemberParser(e,t){It(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){It(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){It(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Et(r,"XYZ")}readFlatLinearRing(e,t){const r=F(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(r)return r}readLinearRing(e,t){const r=this.readFlatCoordinatesFromNode(e,t);if(r)return new Un(r,"XYZ")}readPolygon(e,t){const r=F([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ri(n,r[o]),s.push(n.length);return new cr(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return F(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const r=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return r||null}readFeaturesFromNode(e,t){const r={featureType:this.featureType,featureNS:this.featureNS};return r&&Object.assign(r,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[r])||[]}readProjectionFromNode(e){return oe(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}D.prototype.namespace=yt;D.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};D.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:U(D.prototype.pointMemberParser),pointMembers:U(D.prototype.pointMemberParser)}};D.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:U(D.prototype.lineStringMemberParser),lineStringMembers:U(D.prototype.lineStringMemberParser)}};D.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:U(D.prototype.polygonMemberParser),polygonMembers:U(D.prototype.polygonMemberParser)}};D.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:U(D.prototype.readFlatCoordinatesFromNode)}};D.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(D.prototype.readLineString)}};D.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(D.prototype.readPolygon)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing)}};const _f=yt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",yf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class Y extends D{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[yt].featureMember=U(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:_f}readFlatCoordinates(e,t){const r=Pi(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const c=oe(s);c&&(o=c.getAxisOrientation())}const a=r.trim().split(/\s+/),l=[];for(let c=0,h=a.length;c<h;c++){const u=a[c].split(/,+/),f=parseFloat(u[0]),g=parseFloat(u[1]),d=u.length===3?parseFloat(u[2]):0;o.startsWith("en")?l.push(f,g,d):l.push(g,f,d)}return l}readBox(e,t){const r=F([null],this.BOX_PARSERS_,e,t,this);return tl(r[1][0],r[1][1],r[1][3],r[1][4])}innerBoundaryIsParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}outerBoundaryIsParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="MultiLineString"&&a===!0&&(r="MultiCurve")),X("http://www.opengis.net/gml",r)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const u=t.getProperties();for(const f in u){const g=u[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(K)))}}const h=Object.assign({},s);h.node=e,fe(h,s.serializers,We(void 0,o),c,r,l)}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}else if(e.nodeName==="Curve"){const o=X(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();fe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=hs(t,n):o=De(t,!0,n),fe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}createCoordinatesNode_(e){const t=X(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),l=a.length,c=new Array(l);for(let h=0;h<l;++h){const u=a[h];c[h]=this.getCoords_(u,o,s)}K(e,c.join(" "))}writeCurveSegments_(e,t,r){const n=X(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();fe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=X(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),X(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,r){const n=X(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeRing(e,t,r){const n=X(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}getCoords_(e,t,r){let s=(t?oe(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(r){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),c=this.getCoords_(l,o,s);K(a,c)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();fe({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,We("pointMember"),a,r,void 0,this)}writePointMember(e,t,r){const n=X(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,r)}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();fe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];fe({node:e},this.ENVELOPE_SERIALIZERS,_r,a,r,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return X("http://www.opengis.net/gml",yf[n.nodeName])}}Y.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:z(Y.prototype.readFlatCoordinates)}};Y.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:Y.prototype.innerBoundaryIsParser,outerBoundaryIs:Y.prototype.outerBoundaryIsParser}};Y.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:U(Y.prototype.readFlatCoordinates)}};Y.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Box:z(Y.prototype.readBox)}};Y.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(Y.prototype.writeCurveOrLineString),MultiCurve:b(Y.prototype.writeMultiCurveOrLineString),Point:b(Y.prototype.writePoint),MultiPoint:b(Y.prototype.writeMultiPoint),LineString:b(Y.prototype.writeCurveOrLineString),MultiLineString:b(Y.prototype.writeMultiCurveOrLineString),LinearRing:b(Y.prototype.writeLinearRing),Polygon:b(Y.prototype.writeSurfaceOrPolygon),MultiPolygon:b(Y.prototype.writeMultiSurfaceOrPolygon),Surface:b(Y.prototype.writeSurfaceOrPolygon),MultiSurface:b(Y.prototype.writeMultiSurfaceOrPolygon),Envelope:b(Y.prototype.writeEnvelope)}};Y.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(Y.prototype.writeLineStringOrCurveMember),curveMember:b(Y.prototype.writeLineStringOrCurveMember)}};Y.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:b(Y.prototype.writeRing),innerBoundaryIs:b(Y.prototype.writeRing)}};Y.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(Y.prototype.writePointMember)}};Y.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(Y.prototype.writeSurfaceOrPolygonMember),polygonMember:b(Y.prototype.writeSurfaceOrPolygonMember)}};Y.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(K),upperCorner:b(K)}};const Ef=yt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",xf={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class P extends D{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:Ef,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const r=F([],this.MULTICURVE_PARSERS,e,t,this);if(r)return new Zr(r)}readFlatCurveRing(e,t){const r=F([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=r.length;s<o;++s)Ri(n,r[s].getFlatCoordinates());return n}readMultiSurface(e,t){const r=F([],this.MULTISURFACE_PARSERS,e,t,this);if(r)return new Ki(r)}curveMemberParser(e,t){It(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){It(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return F([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return F([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return F([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return F([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);r&&t[t.length-1].push(r)}exteriorParser(e,t){const r=F(void 0,this.RING_PARSERS,e,t,this);if(r){const n=t[t.length-1];n[0]=r}}readSurface(e,t){const r=F([null],this.SURFACE_PARSERS,e,t,this);if(r&&r[0]){const n=r[0],s=[n.length];let o,a;for(o=1,a=r.length;o<a;++o)Ri(n,r[o]),s.push(n.length);return new cr(n,"XYZ",s)}}readCurve(e,t){const r=F([null],this.CURVE_PARSERS,e,t,this);if(r)return new Et(r,"XYZ")}readEnvelope(e,t){const r=F([null],this.ENVELOPE_PARSERS,e,t,this);return tl(r[1][0],r[1][1],r[2][0],r[2][1])}readFlatPos(e,t){let r=Pi(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(r);)s.push(parseFloat(o[1])),r=r.substr(o[0].length);if(r!=="")return;const l=t[0].srsName;if((l?oe(l).getAxisOrientation():"enu")==="neu")for(let u=0,f=s.length;u<f;u+=3){const g=s[u],d=s[u+1];s[u]=d,s[u+1]=g}const h=s.length;if(h==2&&s.push(0),h!==0)return s}readFlatPosList(e,t){const r=Pi(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?oe(s).getAxisOrientation():"enu",l=r.split(/\s+/);let c=2;e.getAttribute("srsDimension")?c=Pt(e.getAttribute("srsDimension")):e.getAttribute("dimension")?c=Pt(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?c=Pt(e.parentNode.getAttribute("srsDimension")):o&&(c=Pt(o));const h=a.startsWith("en");let u,f,g;const d=[];for(let p=0,m=l.length;p<m;p+=c)u=parseFloat(l[p]),f=parseFloat(l[p+1]),g=c===3?parseFloat(l[p+2]):0,h?d.push(u,f,g):d.push(f,u,g);return d}writePos_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=a?oe(a).getAxisOrientation():"enu",c=t.getCoordinates();let h=l.startsWith("en")?c[0]+" "+c[1]:c[1]+" "+c[0];if(s){const u=c[2]||0;h+=" "+u}K(e,h)}getCoords_(e,t,r){let s=(t?oe(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(r){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,r){const n=r[r.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=t.getCoordinates(),c=l.length,h=new Array(c);let u;for(let f=0;f<c;++f)u=l[f],h[f]=this.getCoords_(u,a,s);K(e,h.join(" "))}writePoint(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=X(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,r)}writeEnvelope(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];fe({node:e},this.ENVELOPE_SERIALIZERS,_r,a,r,o,this)}writeLinearRing(e,t,r){const s=r[r.length-1].srsName;s&&e.setAttribute("srsName",s);const o=X(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}RING_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),X(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();fe({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,r,void 0,this)}else if(e.nodeName==="Surface"){const a=X(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,r)}}writeCurveOrLineString(e,t,r){const s=r[r.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=X(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,r)}else if(e.nodeName==="Curve"){const o=X(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,r)}}writeMultiSurfaceOrPolygon(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();fe({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeMultiPoint(e,t,r){const n=r[r.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();fe({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,We("pointMember"),a,r,void 0,this)}writeMultiCurveOrLineString(e,t,r){const n=r[r.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();fe({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,r,void 0,this)}writeRing(e,t,r){const n=X(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,r)}writeSurfaceOrPolygonMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r))}writePointMember(e,t,r){const n=X(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,r)}writeLineStringOrCurveMember(e,t,r){const n=this.GEOMETRY_NODE_FACTORY_(t,r);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,r))}writeSurfacePatches_(e,t,r){const n=X(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,r)}writeCurveSegments_(e,t,r){const n=X(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,r)}writeGeometryElement(e,t,r){const n=r[r.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=hs(t,n):o=De(t,!0,n),fe(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],r,void 0,this)}writeFeatureElement(e,t,r){const n=t.getId();n&&e.setAttribute("fid",n);const s=r[r.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const u=t.getProperties();for(const f in u){const g=u[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=b(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=b(K)))}}const h=Object.assign({},s);h.node=e,fe(h,s.serializers,We(void 0,o),c,r,l)}writeFeatureMembers_(e,t,r){const n=r[r.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=b(this.writeFeatureElement,this);const l=Object.assign({},n);l.node=e,fe(l,a,We(s,o),t,r)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,r){const n=t[t.length-1].node;return X(this.namespace,xf[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,r){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,l=n.multiCurve;return Array.isArray(e)?r="Envelope":(r=e.getType(),r==="MultiPolygon"&&s===!0?r="MultiSurface":r==="Polygon"&&o===!0?r="Surface":r==="LineString"&&a===!0?r="Curve":r==="MultiLineString"&&l===!0&&(r="MultiCurve")),X(this.namespace,r)}writeGeometryNode(e,t){t=this.adaptOptions(t);const r=X(this.namespace,"geom"),n={node:r,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(r,e,[n]),r}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=X(this.namespace,"featureMembers");r.setAttributeNS(jr,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(r,e,[n]),r}}P.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:z(P.prototype.readFlatPos),posList:z(P.prototype.readFlatPosList),coordinates:z(Y.prototype.readFlatCoordinates)}};P.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};P.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(P.prototype.readSurface),MultiSurface:z(P.prototype.readMultiSurface),Curve:z(P.prototype.readCurve),MultiCurve:z(P.prototype.readMultiCurve),Envelope:z(P.prototype.readEnvelope)}};P.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};P.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};P.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:U(D.prototype.readLineString),Curve:U(P.prototype.readCurve)}};P.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:U(D.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};P.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:z(P.prototype.readPatch)}};P.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:z(P.prototype.readSegment)}};P.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};P.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:z(P.prototype.readPolygonPatch)}};P.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:sl(P.prototype.readLineStringSegment)}};D.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(P.prototype.readFlatCurveRing)}};P.prototype.writeFeatures;P.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};P.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:b(K),upperCorner:b(K)}};P.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};P.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:b(P.prototype.writePointMember)}};P.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};P.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(P.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};const Is=P;Is.prototype.writeFeatures;Is.prototype.writeFeaturesNode;const _e=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],bf="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Tf={rte:wl,trk:Sl,wpt:Rl},wf=O(_e,{rte:U(wl),trk:U(Sl),wpt:U(Rl)}),Sf=O(_e,{text:x(C,"linkText"),type:x(C,"linkType")}),Rf=O(_e,{name:x(C),email:Jf,link:Jr}),vf=O(_e,{name:x(C),desc:x(C),author:x(Yf),copyright:x(qf),link:Jr,time:x(en),keywords:x(C),bounds:Kf,extensions:on}),Pf=O(_e,{year:x(Ee),license:x(C)}),Af=O(_e,{rte:b(rd),trk:b(id),wpt:b(sd)});class Lf extends Qi{constructor(e){super(),e=e||{},this.dataProjection=oe("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,r=e.length;t<r;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(Ai(e)):Li(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const r=this.readMetadataFromNode(t);if(r)return r}return null}readMetadataFromNode(e){if(!_e.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(_e.includes(t.namespaceURI)&&t.localName==="metadata")return F({},vf,t,[]);return null}readFeatureFromNode(e,t){if(!_e.includes(e.namespaceURI))return null;const r=Tf[e.localName];if(!r)return null;const n=r(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!_e.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const r=F([],wf,e,[this.getReadOptions(e,t)]);return r?(this.handleReadExtensions_(r),r):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const r=X("http://www.topografix.com/GPX/1/1","gpx");return r.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",jr),r.setAttributeNS(jr,"xsi:schemaLocation",bf),r.setAttribute("version","1.1"),r.setAttribute("creator","OpenLayers"),fe({node:r},Af,Zf,e,[t]),r}}const If=O(_e,{name:x(C),cmt:x(C),desc:x(C),src:x(C),link:Jr,number:x(Ee),extensions:on,type:x(C),rtept:Qf}),Cf=O(_e,{ele:x(Ne),time:x(en)}),Ff=O(_e,{name:x(C),cmt:x(C),desc:x(C),src:x(C),link:Jr,number:x(Ee),type:x(C),extensions:on,trkseg:td}),Of=O(_e,{trkpt:ed}),Mf=O(_e,{ele:x(Ne),time:x(en)}),Nf=O(_e,{ele:x(Ne),time:x(en),magvar:x(Ne),geoidheight:x(Ne),name:x(C),cmt:x(C),desc:x(C),src:x(C),link:Jr,sym:x(C),type:x(C),fix:x(C),sat:x(Ee),hdop:x(Ne),vdop:x(Ne),pdop:x(Ne),ageofdgpsdata:x(Ne),dgpsid:x(Ee),extensions:on}),Df=["text","type"],Uf=O(_e,{text:b(K),type:b(K)}),Bf=O(_e,["name","cmt","desc","src","link","number","type","rtept"]),Gf=O(_e,{name:b(K),cmt:b(K),desc:b(K),src:b(K),link:b(Os),number:b(Ii),type:b(K),rtept:ol(b(Ms))}),zf=O(_e,["ele","time"]),$f=O(_e,["name","cmt","desc","src","link","number","type","trkseg"]),kf=O(_e,{name:b(K),cmt:b(K),desc:b(K),src:b(K),link:b(Os),number:b(Ii),type:b(K),trkseg:ol(b(nd))}),jf=We("trkpt"),Vf=O(_e,{trkpt:b(Ms)}),Xf=O(_e,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Wf=O(_e,{ele:b(Gt),time:b(Ju),magvar:b(Gt),geoidheight:b(Gt),name:b(K),cmt:b(K),desc:b(K),src:b(K),link:b(Os),sym:b(K),type:b(K),fix:b(K),sat:b(Ii),hdop:b(Gt),vdop:b(Gt),pdop:b(Gt),ageofdgpsdata:b(Gt),dgpsid:b(Ii)}),Hf={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function Zf(i,e,t){const r=i.getGeometry();if(r){const n=Hf[r.getType()];if(n){const s=e[e.length-1].node;return X(s.namespaceURI,n)}}}function Cs(i,e,t,r){return i.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in r?(i.push(r.ele),delete r.ele,e.hasZ=!0):i.push(0),"time"in r?(i.push(r.time),delete r.time,e.hasM=!0):i.push(0),i}function Fs(i,e,t){let r="XY",n=2;if(i.hasZ&&i.hasM?(r="XYZM",n=4):i.hasZ?(r="XYZ",n=3):i.hasM&&(r="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],i.hasZ&&(e[s*n+2]=e[s*4+2]),i.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return r}function Yf(i,e){const t=F({},Rf,i,e);if(t)return t}function qf(i,e){const t=F({},Pf,i,e);if(t){const r=i.getAttribute("author");return r!==null&&(t.author=r),t}}function Kf(i,e){const t=e[e.length-1],r=i.getAttribute("minlat"),n=i.getAttribute("minlon"),s=i.getAttribute("maxlat"),o=i.getAttribute("maxlon");n!==null&&r!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(r)],[parseFloat(o),parseFloat(s)]])}function Jf(i,e){const t=e[e.length-1],r=i.getAttribute("id"),n=i.getAttribute("domain");r!==null&&n!==null&&(t.email=`${r}@${n}`)}function Jr(i,e){const t=e[e.length-1],r=i.getAttribute("href");r!==null&&(t.link=r),It(Sf,i,e)}function on(i,e){const t=e[e.length-1];t.extensionsNode_=i}function Qf(i,e){const t=F({},Cf,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Cs(n,s,i,t)}}function ed(i,e){const t=F({},Mf,i,e);if(t){const r=e[e.length-1],n=r.flatCoordinates,s=r.layoutOptions;Cs(n,s,i,t)}}function td(i,e){const t=e[e.length-1];It(Of,i,e);const r=t.flatCoordinates;t.ends.push(r.length)}function wl(i,e){const t=e[0],r=F({flatCoordinates:[],layoutOptions:{}},If,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.layoutOptions;delete r.layoutOptions;const o=Fs(s,n),a=new Et(n,o);De(a,!1,t);const l=new Ke(a);return l.setProperties(r,!0),l}function Sl(i,e){const t=e[0],r=F({flatCoordinates:[],ends:[],layoutOptions:{}},Ff,i,e);if(!r)return;const n=r.flatCoordinates;delete r.flatCoordinates;const s=r.ends;delete r.ends;const o=r.layoutOptions;delete r.layoutOptions;const a=Fs(o,n,s),l=new Zr(n,a,s);De(l,!1,t);const c=new Ke(l);return c.setProperties(r,!0),c}function Rl(i,e){const t=e[0],r=F({},Nf,i,e);if(!r)return;const n={},s=Cs([],n,i,r),o=Fs(n,s),a=new et(s,o);De(a,!1,t);const l=new Ke(a);return l.setProperties(r,!0),l}function Os(i,e,t){i.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];fe({node:i},Uf,_r,s,t,Df)}function Ms(i,e,t){const r=t[t.length-1],s=r.node.namespaceURI,o=r.properties;switch(i.setAttributeNS(null,"lat",String(e[1])),i.setAttributeNS(null,"lon",String(e[0])),r.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=i.nodeName=="rtept"?zf[s]:Xf[s],c=ys(o,l);fe({node:i,properties:o},Wf,_r,c,t,l)}function rd(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const h=De(o,!0,r);s.geometryLayout=h.getLayout(),n.rtept=h.getCoordinates()}const a=t[t.length-1].node,l=Bf[a.namespaceURI],c=ys(n,l);fe(s,Gf,_r,c,t,l)}function id(i,e,t){const r=t[0],n=e.getProperties(),s={node:i};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const h=De(o,!0,r);n.trkseg=h.getLineStrings()}const a=t[t.length-1].node,l=$f[a.namespaceURI],c=ys(n,l);fe(s,kf,_r,c,t,l)}function nd(i,e,t){const r={node:i};r.geometryLayout=e.getLayout(),r.properties={},fe(r,Vf,jf,e.getCoordinates(),t)}function sd(i,e,t){const r=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=De(s,!0,r);n.geometryLayout=o.getLayout(),Ms(i,o.getCoordinates(),t)}}const od=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,ad=/^H.([A-Z]{3}).*?:(.*)/,ld=/^HFDTE(\d{2})(\d{2})(\d{2})/,cd=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,ud=/\r\n|\r|\n/;class hd extends yl{constructor(e){super(),e=e||{},this.dataProjection=oe("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const r=this.altitudeMode_,n=e.split(ud),s={},o=[];let a=2e3,l=0,c=1,h=-1,u,f;for(u=0,f=n.length;u<f;++u){const m=n[u];let y;if(m.charAt(0)=="B"){if(y=od.exec(m),y){const _=parseInt(y[1],10),E=parseInt(y[2],10),w=parseInt(y[3],10);let S=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(S+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(S=-S);let T=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(T+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(T=-T),o.push(T,S),r!="none"){let I;r=="gps"?I=parseInt(y[11],10):r=="barometric"?I=parseInt(y[12],10):I=0,o.push(I)}let v=Date.UTC(a,l,c,_,E,w);v<h&&(v=Date.UTC(a,l,c+1,_,E,w)),o.push(v/1e3),h=v}}else if(m.charAt(0)=="H")y=cd.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=ld.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=ad.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let E=0;E<_;E++){const w=m.slice(7+E*7,10+E*7);if(w==="LAD"||w==="LOD"){const S=parseInt(m.slice(3+E*7,5+E*7),10)-1,T=parseInt(m.slice(5+E*7,7+E*7),10);w==="LAD"?(this.lad_=!0,this.ladStart_=S,this.ladStop_=T):w==="LOD"&&(this.lod_=!0,this.lodStart_=S,this.lodStop_=T)}}}}if(o.length===0)return null;const g=r=="none"?"XYM":"XYZM",d=new Et(o,g),p=new Ke(De(d,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const r=this.readFeatureFromText(e,t);return r?[r]:[]}}const Te={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},Vt={};Vt[Te.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};Vt[Te.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};Vt[Te.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};Vt.none={none:{supports:[],formats:[],qualities:[]}};const fd=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,ko=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,dd=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function gd(i){let e=i.getComplianceLevelSupportedFeatures();return e===void 0&&(e=Vt[Te.VERSION1].level0),{url:i.imageInfo["@id"]===void 0?void 0:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,i.imageInfo.formats===void 0?[]:i.imageInfo.formats],qualities:[...e.qualities,i.imageInfo.qualities===void 0?[]:i.imageInfo.qualities],resolutions:i.imageInfo.scale_factors,tileSize:i.imageInfo.tile_width!==void 0?i.imageInfo.tile_height!==void 0?[i.imageInfo.tile_width,i.imageInfo.tile_height]:[i.imageInfo.tile_width,i.imageInfo.tile_width]:i.imageInfo.tile_height!=null?[i.imageInfo.tile_height,i.imageInfo.tile_height]:void 0}}function pd(i){const e=i.getComplianceLevelSupportedFeatures(),t=Array.isArray(i.imageInfo.profile)&&i.imageInfo.profile.length>1,r=t&&i.imageInfo.profile[1].supports?i.imageInfo.profile[1].supports:[],n=t&&i.imageInfo.profile[1].formats?i.imageInfo.profile[1].formats:[],s=t&&i.imageInfo.profile[1].qualities?i.imageInfo.profile[1].qualities:[];return{url:i.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(o){return o.width})[0],i.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...r],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function md(i){const e=i.getComplianceLevelSupportedFeatures(),t=i.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...i.imageInfo.extraFormats],r=i.imageInfo.preferredFormats!==void 0&&Array.isArray(i.imageInfo.preferredFormats)&&i.imageInfo.preferredFormats.length>0?i.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:i.imageInfo.id,sizes:i.imageInfo.sizes===void 0?void 0:i.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:i.imageInfo.tiles===void 0?void 0:[i.imageInfo.tiles.map(function(n){return n.width})[0],i.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:i.imageInfo.tiles===void 0?void 0:i.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:i.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...i.imageInfo.extraFeatures],formats:t,qualities:i.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...i.imageInfo.extraQualities],preferredFormat:r}}const an={};an[Te.VERSION1]=gd;an[Te.VERSION2]=pd;an[Te.VERSION3]=md;class _d{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return Te.VERSION1;case"http://iiif.io/api/image/2/context.json":return Te.VERSION2;case"http://iiif.io/api/image/3/context.json":return Te.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(Te.VERSION1)&&this.imageInfo.identifier)return Te.VERSION1;break}Je(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case Te.VERSION1:if(fd.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Te.VERSION3:if(dd.test(this.imageInfo.profile))return this.imageInfo.profile;break;case Te.VERSION2:if(typeof this.imageInfo.profile=="string"&&ko.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&ko.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const r=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(r)?r[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?Vt.none.none:Vt[e][t]}getTileSourceOptions(e){const t=e||{},r=this.getImageApiVersion();if(r===void 0)return;const n=r===void 0?void 0:an[r](this);if(n!==void 0)return{url:n.url,version:r,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class Ns{read(e){if(!e)return null;if(typeof e=="string"){const t=Ai(e);return this.readFromDocument(t)}return Li(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){ps()}}const yd="http://www.w3.org/1999/xlink";function br(i){return i.getAttributeNS(yd,"href")}const ke=[null,"http://www.opengis.net/ows/1.1"],Ed=O(ke,{ServiceIdentification:x(jd),ServiceProvider:x(Xd),OperationsMetadata:x($d)});class vl extends Ns{constructor(){super()}readFromNode(e){const t=F({},Ed,e,[]);return t||null}}const xd=O(ke,{DeliveryPoint:x(C),City:x(C),AdministrativeArea:x(C),PostalCode:x(C),Country:x(C),ElectronicMailAddress:x(C)}),bd=O(ke,{Value:ue(Wd)}),Td=O(ke,{AllowedValues:x(Md)}),wd=O(ke,{Phone:x(kd),Address:x(Od)}),Sd=O(ke,{HTTP:x(Gd)}),Rd=O(ke,{Get:ue(Bd),Post:void 0}),vd=O(ke,{DCP:x(Ud)}),Pd=O(ke,{Operation:zd}),Ad=O(ke,{Voice:x(C),Facsimile:x(C)}),Ld=O(ke,{Constraint:ue(Nd)}),Id=O(ke,{IndividualName:x(C),PositionName:x(C),ContactInfo:x(Dd)}),Cd=O(ke,{Abstract:x(C),AccessConstraints:x(C),Fees:x(C),Title:x(C),ServiceTypeVersion:x(C),ServiceType:x(C)}),Fd=O(ke,{ProviderName:x(C),ProviderSite:x(br),ServiceContact:x(Vd)});function Od(i,e){return F({},xd,i,e)}function Md(i,e){return F({},bd,i,e)}function Nd(i,e){const t=i.getAttribute("name");if(t)return F({name:t},Td,i,e)}function Dd(i,e){return F({},wd,i,e)}function Ud(i,e){return F({},Sd,i,e)}function Bd(i,e){const t=br(i);if(t)return F({href:t},Ld,i,e)}function Gd(i,e){return F({},Rd,i,e)}function zd(i,e){const t=i.getAttribute("name"),r=F({},vd,i,e);if(!r)return;const n=e[e.length-1];n[t]=r}function $d(i,e){return F({},Pd,i,e)}function kd(i,e){return F({},Ad,i,e)}function jd(i,e){return F({},Cd,i,e)}function Vd(i,e){return F({},Id,i,e)}function Xd(i,e){return F({},Fd,i,e)}function Wd(i,e){return C(i)}function jo(i,e,t,r,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=i[o++];n[s++]=i[o++],n[s++]=a;for(let l=2;l<r;++l)n[s++]=i[o++]}return n.length=s,n}class Hd extends yl{constructor(e){super(),e=e||{},this.dataProjection=oe("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const r=this.readGeometryFromText(e,t);return new Ke(r)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const r=xu(this.geometryLayout_),n=Yd(e,r,this.factor_);jo(n,0,n.length,r,n);const s=bu(n,0,n.length,r),o=new Et(s,this.geometryLayout_);return De(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const r=e.getGeometry();if(r)return this.writeGeometryText(r,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=De(e,!0,this.adaptOptions(t));const r=e.getFlatCoordinates(),n=e.getStride();return jo(r,0,r.length,n,r),Zd(r,n,this.factor_)}}function Zd(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;for(let s=0,o=i.length;s<o;)for(r=0;r<e;++r,++s){const a=i[s],l=a-n[r];n[r]=a,i[s]=l}return qd(i,t)}function Yd(i,e,t){t=t||1e5;let r;const n=new Array(e);for(r=0;r<e;++r)n[r]=0;const s=Kd(i,t);for(let o=0,a=s.length;o<a;)for(r=0;r<e;++r,++o)n[r]+=s[o],s[o]=n[r];return s}function qd(i,e){e=e||1e5;for(let t=0,r=i.length;t<r;++t)i[t]=Math.round(i[t]*e);return Jd(i)}function Kd(i,e){e=e||1e5;const t=Qd(i);for(let r=0,n=t.length;r<n;++r)t[r]/=e;return t}function Jd(i){for(let e=0,t=i.length;e<t;++e){const r=i[e];i[e]=r<0?~(r<<1):r<<1}return eg(i)}function Qd(i){const e=tg(i);for(let t=0,r=e.length;t<r;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function eg(i){let e="";for(let t=0,r=i.length;t<r;++t)e+=rg(i[t]);return e}function tg(i){const e=[];let t=0,r=0;for(let n=0,s=i.length;n<s;++n){const o=i.charCodeAt(n)-63;t|=(o&31)<<r,o<32?(e.push(t),t=0,r=0):r+=5}return e}function rg(i){let e,t="";for(;i>=32;)e=(32|i&31)+63,t+=String.fromCharCode(e),i>>=5;return e=i+63,t+=String.fromCharCode(e),t}class te extends P{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,r){const n=r[r.length-1];r[r.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,r)}}te.prototype.namespace="http://www.opengis.net/gml/3.2";te.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:z(P.prototype.readFlatPos),posList:z(P.prototype.readFlatPosList),coordinates:z(Y.prototype.readFlatCoordinates)}};te.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:P.prototype.interiorParser,exterior:P.prototype.exteriorParser}};te.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:z(D.prototype.readPoint),MultiPoint:z(D.prototype.readMultiPoint),LineString:z(D.prototype.readLineString),MultiLineString:z(D.prototype.readMultiLineString),LinearRing:z(D.prototype.readLinearRing),Polygon:z(D.prototype.readPolygon),MultiPolygon:z(D.prototype.readMultiPolygon),Surface:z(te.prototype.readSurface),MultiSurface:z(P.prototype.readMultiSurface),Curve:z(te.prototype.readCurve),MultiCurve:z(P.prototype.readMultiCurve),Envelope:z(te.prototype.readEnvelope)}};te.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:U(P.prototype.curveMemberParser),curveMembers:U(P.prototype.curveMemberParser)}};te.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:U(P.prototype.surfaceMemberParser),surfaceMembers:U(P.prototype.surfaceMemberParser)}};te.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(D.prototype.readLineString),Curve:U(P.prototype.readCurve)}};te.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(D.prototype.readPolygon),Surface:U(P.prototype.readSurface)}};te.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:z(P.prototype.readPatch)}};te.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:z(P.prototype.readSegment)}};te.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:U(P.prototype.readFlatPosList),upperCorner:U(P.prototype.readFlatPosList)}};te.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:z(P.prototype.readPolygonPatch)}};te.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:sl(P.prototype.readLineStringSegment)}};te.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:U(D.prototype.pointMemberParser),pointMembers:U(D.prototype.pointMemberParser)}};te.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:U(D.prototype.lineStringMemberParser),lineStringMembers:U(D.prototype.lineStringMemberParser)}};te.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:U(D.prototype.polygonMemberParser),polygonMembers:U(D.prototype.polygonMemberParser)}};te.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:U(D.prototype.readFlatCoordinatesFromNode)}};te.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:U(D.prototype.readLineString)}};te.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:U(D.prototype.readPolygon)}};te.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:z(D.prototype.readFlatLinearRing),Ring:z(te.prototype.readFlatCurveRing)}};te.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:b(P.prototype.writeRing),interior:b(P.prototype.writeRing)}};te.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:b(K),upperCorner:b(K)}};te.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:b(P.prototype.writeSurfaceOrPolygonMember),polygonMember:b(P.prototype.writeSurfaceOrPolygonMember)}};te.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:b(P.prototype.writePointMember)}};te.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:b(P.prototype.writeLineStringOrCurveMember),curveMember:b(P.prototype.writeLineStringOrCurveMember)}};te.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:b(P.prototype.writeCurveOrLineString),MultiCurve:b(P.prototype.writeMultiCurveOrLineString),Point:b(te.prototype.writePoint),MultiPoint:b(P.prototype.writeMultiPoint),LineString:b(P.prototype.writeCurveOrLineString),MultiLineString:b(P.prototype.writeMultiCurveOrLineString),LinearRing:b(P.prototype.writeLinearRing),Polygon:b(P.prototype.writeSurfaceOrPolygon),MultiPolygon:b(P.prototype.writeMultiSurfaceOrPolygon),Surface:b(P.prototype.writeSurfaceOrPolygon),MultiSurface:b(P.prototype.writeMultiSurfaceOrPolygon),Envelope:b(P.prototype.writeEnvelope)}};class Pl{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class ig extends Pl{constructor(e,t){super(e),this.conditions=t,Je(this.conditions.length>=2,"At least 2 conditions are required")}}class ng extends ig{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class sg extends Pl{constructor(e,t,r){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=r}}function og(i){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(ng,e))}function ag(i,e,t){return new sg(i,e,t)}const Vo={"http://www.opengis.net/gml":{boundedBy:x(D.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:U(D.prototype.readFeaturesInternal)}},lg={"http://www.opengis.net/wfs":{totalInserted:x(Ee),totalUpdated:x(Ee),totalDeleted:x(Ee)},"http://www.opengis.net/wfs/2.0":{totalInserted:x(Ee),totalUpdated:x(Ee),totalDeleted:x(Ee)}},cg={"http://www.opengis.net/wfs":{TransactionSummary:x(Wo,"transactionSummary"),InsertResults:x(Zo,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:x(Wo,"transactionSummary"),InsertResults:x(Zo,"insertIds")}},ug={"http://www.opengis.net/wfs":{PropertyName:b(K)},"http://www.opengis.net/wfs/2.0":{PropertyName:b(K)}},Al={"http://www.opengis.net/wfs":{Insert:b(Yo),Update:b(Ko),Delete:b(qo),Property:b(Jo),Native:b(Qo)},"http://www.opengis.net/wfs/2.0":{Insert:b(Yo),Update:b(Ko),Delete:b(qo),Property:b(Jo),Native:b(Qo)}},Ll="feature",Ds="http://www.w3.org/2000/xmlns/",Us={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},Wn={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},Bs={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},Xo={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},Gs={"2.0.0":te,"1.1.0":P,"1.0.0":Y},hg="1.1.0";class fg extends Qi{constructor(e){super(),e=e||{},this.version_=e.version?e.version:hg,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new Gs[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:Xo[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const r={node:e};Object.assign(r,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(r,this.getReadOptions(e,t||{}));const n=[r];let s;this.version_==="2.0.0"?s=Vo:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=F([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=Ai(e);return this.readTransactionResponseFromDocument(t)}return Li(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=Ai(e);return this.readFeatureCollectionMetadataFromDocument(t)}return Li(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},r=Pt(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=r,F(t,Vo,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return F({},cg,e,[])}writeGetFeature(e){const t=X(Wn[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(jr,"xsi:schemaLocation",this.schemaLocation_);const r={node:t};if(Object.assign(r,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),Je(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(Je(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(r,{geometryName:e.geometryName,filter:n}),ca(t,e.featureTypes,[r])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(r,{geometryName:n.geometryName,filter:s}),ca(t,[n.name],[r])});return t}combineBboxAndFilter(e,t,r,n){const s=ag(e,t,r);return n?og(n,s):s}writeTransaction(e,t,r,n){const s=[],o=n.version?n.version:this.version_,a=X(Wn[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;n&&(l=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS(jr,"xsi:schemaLocation",Xo[o]);const c=dg(a,l,o,n);return e&&fi("Insert",e,s,c),t&&fi("Update",t,s,c),r&&fi("Delete",r,s,c),n.nativeElements&&fi("Native",n.nativeElements,s,c),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const r=[{}];return this.gmlFormat_.readGeometryElement(t,r),oe(r.pop().srsName)}}return null}}function dg(i,e,t,r){const n=r.featurePrefix?r.featurePrefix:Ll;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:i},{version:t,featureNS:r.featureNS,featureType:r.featureType,featurePrefix:n,gmlVersion:s,hasZ:r.hasZ,srsName:r.srsName},e)}function fi(i,e,t,r){fe(r,Al,We(i),e,t)}function Wo(i,e){return F({},lg,i,e)}const gg={"http://www.opengis.net/ogc":{FeatureId:U(function(i,e){return i.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:U(function(i,e){return i.getAttribute("fid")})}};function Ho(i,e){It(gg,i,e)}const pg={"http://www.opengis.net/wfs":{Feature:Ho},"http://www.opengis.net/wfs/2.0":{Feature:Ho}};function Zo(i,e){return F([],pg,i,e)}function Yo(i,e,t){const r=t[t.length-1],n=r.featureType,s=r.featureNS,o=r.gmlVersion,a=X(s,n);i.appendChild(a),o===2?Y.prototype.writeFeatureElement(a,e,t):o===3?P.prototype.writeFeatureElement(a,e,t):te.prototype.writeFeatureElement(a,e,t)}function Il(i,e,t){const n=t[t.length-1].version,s=Us[n],o=X(s,"Filter"),a=X(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),i.appendChild(o)}function zs(i,e){i=i||Ll;const t=i+":";return e.startsWith(t)?e:t+e}function qo(i,e,t){const r=t[t.length-1];Je(e.getId()!==void 0,"Features must have an id set");const n=r.featureType,s=r.featurePrefix,o=r.featureNS,a=zs(s,n);i.setAttribute("typeName",a),i.setAttributeNS(Ds,"xmlns:"+s,o);const l=e.getId();l!==void 0&&Il(i,l,t)}function Ko(i,e,t){const r=t[t.length-1];Je(e.getId()!==void 0,"Features must have an id set");const n=r.version,s=r.featureType,o=r.featurePrefix,a=r.featureNS,l=zs(o,s),c=e.getGeometryName();i.setAttribute("typeName",l),i.setAttributeNS(Ds,"xmlns:"+o,a);const h=e.getId();if(h!==void 0){const u=e.getKeys(),f=[];for(let g=0,d=u.length;g<d;g++){const p=e.get(u[g]);if(p!==void 0){let m=u[g];p&&typeof p.getSimplifiedGeometry=="function"&&(m=c),f.push({name:m,value:p})}}fe({version:n,gmlVersion:r.gmlVersion,node:i,hasZ:r.hasZ,srsName:r.srsName},Al,We("Property"),f,t),Il(i,h,t)}}function Jo(i,e,t){const r=t[t.length-1],n=r.version,s=Wn[n],a=X(s,n==="2.0.0"?"ValueReference":"Name"),l=r.gmlVersion;if(i.appendChild(a),K(a,e.name),e.value!==void 0&&e.value!==null){const c=X(s,"Value");i.appendChild(c),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?Y.prototype.writeGeometryElement(c,e.value,t):l===3?P.prototype.writeGeometryElement(c,e.value,t):te.prototype.writeGeometryElement(c,e.value,t):K(c,e.value)}}function Qo(i,e,t){e.vendorId&&i.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&i.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&K(i,e.value)}const ln={"http://www.opengis.net/wfs":{Query:b(ea)},"http://www.opengis.net/wfs/2.0":{Query:b(ea)},"http://www.opengis.net/ogc":{During:b(ia),And:b(di),Or:b(di),Not:b(na),BBOX:b(ta),Contains:b(Rt),Intersects:b(Rt),Within:b(Rt),DWithin:b(ra),PropertyIsEqualTo:b(He),PropertyIsNotEqualTo:b(He),PropertyIsLessThan:b(He),PropertyIsLessThanOrEqualTo:b(He),PropertyIsGreaterThan:b(He),PropertyIsGreaterThanOrEqualTo:b(He),PropertyIsNull:b(sa),PropertyIsBetween:b(oa),PropertyIsLike:b(aa)},"http://www.opengis.net/fes/2.0":{During:b(ia),And:b(di),Or:b(di),Not:b(na),BBOX:b(ta),Contains:b(Rt),Disjoint:b(Rt),Intersects:b(Rt),ResourceId:b(_g),Within:b(Rt),DWithin:b(ra),PropertyIsEqualTo:b(He),PropertyIsNotEqualTo:b(He),PropertyIsLessThan:b(He),PropertyIsLessThanOrEqualTo:b(He),PropertyIsGreaterThan:b(He),PropertyIsGreaterThanOrEqualTo:b(He),PropertyIsNull:b(sa),PropertyIsBetween:b(oa),PropertyIsLike:b(aa)}};function ea(i,e,t){const r=t[t.length-1],n=r.version,s=r.featurePrefix,o=r.featureNS,a=r.propertyNames,l=r.srsName;let c;s?c=zs(s,e):c=e;let h;n==="2.0.0"?h="typeNames":h="typeName",i.setAttribute(h,c),l&&i.setAttribute("srsName",l),o&&i.setAttributeNS(Ds,"xmlns:"+s,o);const u=Object.assign({},r);u.node=i,fe(u,ug,We("PropertyName"),a,t);const f=r.filter;if(f){const g=X(cn(n),"Filter");i.appendChild(g),mg(g,f,t)}}function mg(i,e,t){const r=t[t.length-1],n={node:i};Object.assign(n,{context:r}),fe(n,ln,We(e.getTagName()),[e],t)}function ta(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Gs[s];Tr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.extent,t)}function _g(i,e,t){i.setAttribute("rid",e.rid)}function Rt(i,e,t){const r=t[t.length-1],s=r.context.version;r.srsName=e.srsName;const o=Gs[s];Tr(s,i,e.geometryName),o.prototype.writeGeometryElement(i,e.geometry,t)}function ra(i,e,t){const s=t[t.length-1].context.version;Rt(i,e,t);const o=X(cn(s),"Distance");K(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),i.appendChild(o)}function ia(i,e,t){const s=t[t.length-1].context.version;Ni(Bs[s],"ValueReference",i,e.propertyName);const o=X(yt,"TimePeriod");i.appendChild(o);const a=X(yt,"begin");o.appendChild(a),la(a,e.begin);const l=X(yt,"end");o.appendChild(l),la(l,e.end)}function di(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const c=o[a];fe(s,ln,We(c.getTagName()),[c],t)}}function na(i,e,t){const n=t[t.length-1].context,s={node:i};Object.assign(s,{context:n});const o=e.condition;fe(s,ln,We(o.getTagName()),[o],t)}function He(i,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Tr(s,i,e.propertyName),Di(s,i,""+e.expression)}function sa(i,e,t){const s=t[t.length-1].context.version;Tr(s,i,e.propertyName)}function oa(i,e,t){const s=t[t.length-1].context.version,o=cn(s);Tr(s,i,e.propertyName);const a=X(o,"LowerBoundary");i.appendChild(a),Di(s,a,""+e.lowerBoundary);const l=X(o,"UpperBoundary");i.appendChild(l),Di(s,l,""+e.upperBoundary)}function aa(i,e,t){const s=t[t.length-1].context.version;i.setAttribute("wildCard",e.wildCard),i.setAttribute("singleChar",e.singleChar),i.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&i.setAttribute("matchCase",e.matchCase.toString()),Tr(s,i,e.propertyName),Di(s,i,""+e.pattern)}function Ni(i,e,t,r){const n=X(i,e);K(n,r),t.appendChild(n)}function Di(i,e,t){Ni(cn(i),"Literal",e,t)}function Tr(i,e,t){i==="2.0.0"?Ni(Bs[i],"ValueReference",e,t):Ni(Us[i],"PropertyName",e,t)}function la(i,e){const t=X(yt,"TimeInstant");i.appendChild(t);const r=X(yt,"timePosition");t.appendChild(r),K(r,e)}function ca(i,e,t){const r=t[t.length-1],n=Object.assign({},r);n.node=i,fe(n,ln,We("Query"),e,t)}function cn(i){let e;return i==="2.0.0"?e=Bs[i]:e=Us[i],e}const he={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class ua{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let r=0;r<e;r++)t.push(this.readLineString());return t}readWkbHeader(e){const r=this.readUint8()>0,n=this.readUint32(r),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,l=!!(n&536870912),c=(n&268435455)%1e3,h=["XY",o?"Z":"",a?"M":""].join(""),u=l?this.readUint32(r):null;if(e!==void 0&&e!==c)throw new Error("Unexpected WKB geometry type "+c);if(this.initialized_){if(this.isLittleEndian_!==r)throw new Error("Inconsistent endian");if(this.layout_!==h)throw new Error("Inconsistent geometry layout");if(u&&this.srid_!==u)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=r,this.hasZ_=o,this.hasM_=a,this.layout_=h,this.srid_=u,this.initialized_=!0;return c}readWkbPayload(e){switch(e){case he.POINT:return this.readPoint();case he.LINE_STRING:return this.readLineString();case he.POLYGON:case he.TRIANGLE:return this.readPolygon();case he.MULTI_POINT:return this.readMultiPoint();case he.MULTI_LINE_STRING:return this.readMultiLineString();case he.MULTI_POLYGON:case he.POLYHEDRAL_SURFACE:case he.TIN:return this.readMultiPolygon();case he.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const r=this.readUint32(),n=[];for(let s=0;s<r;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,he.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,he.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,he.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case he.POINT:return new et(t,this.layout_);case he.LINE_STRING:return new Et(t,this.layout_);case he.POLYGON:case he.TRIANGLE:return new cr(t,this.layout_);case he.MULTI_POINT:return new us(t,this.layout_);case he.MULTI_LINE_STRING:return new Zr(t,this.layout_);case he.MULTI_POLYGON:case he.POLYHEDRAL_SURFACE:case he.TIN:return new Ki(t,this.layout_);case he.GEOMETRY_COLLECTION:return new Br(t);default:return null}}getSrid(){return this.srid_}}class yg{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const r=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in r?r[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writePoint(e[r],t)}writePolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeLineString(e[r],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(1),this.writePoint(e[r],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(2),this.writeLineString(e[r],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let r=0;r<e.length;r++)this.writeWkbHeader(3),this.writePolygon(e[r],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const r=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof Ao)return r(e.getLayout(),t);if(e instanceof Br){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const r={Point:he.POINT,LineString:he.LINE_STRING,Polygon:he.POLYGON,MultiPoint:he.MULTI_POINT,MultiLineString:he.MULTI_LINE_STRING,MultiPolygon:he.MULTI_POLYGON,GeometryCollection:he.GEOMETRY_COLLECTION},n=e.getType(),s=r[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof Ao?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof Br&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),r=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:r.setUint8(n,s[1]);break;case 4:r.setUint32(n,s[1],this.isLittleEndian_);break;case 8:r.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class Eg extends Tu{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new Ke({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let r=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof Br?r=n.getGeometriesArray():r=[n],r.map(s=>new Ke({geometry:s}))}readGeometry(e,t){const r=ha(e);if(!r)return null;const s=new ua(r).readGeometry();return this.viewCache_=r,t=this.getReadOptions(e,t),this.viewCache_=null,De(s,!1,t)}readProjection(e){const t=this.viewCache_||ha(e);if(!t)return;const r=new ua(t);return r.readWkbHeader(),r.getSrid()&&oe("EPSG:"+r.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new Br(e.map(r=>r.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const r=new yg({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&oe(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}r.writeGeometry(De(e,!0,t),n);const s=r.getBuffer();return this.hex_?xg(s):s}}function xg(i){const e=new Uint8Array(i);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function bg(i){const e=new Uint8Array(i.length/2);for(let t=0;t<i.length/2;t++)e[t]=parseInt(i.substr(t*2,2),16);return new DataView(e.buffer)}function ha(i){return typeof i=="string"?bg(i):ArrayBuffer.isView(i)?i instanceof DataView?i:new DataView(i.buffer,i.byteOffset,i.byteLength):i instanceof ArrayBuffer?new DataView(i):null}const we=[null,"http://www.opengis.net/wms"];function wr(i){return wu(i[0].version,"1.3")>=0}const Tg=O(we,{Service:x(Xg),Capability:x(Vg)}),Cl={Request:x(ep),Exception:x(Yg),Layer:x(qg)},wg=O(we,{...Cl,UserDefinedSymbolization:x(kg)}),Sg=O(we,Cl);class Rg extends Ns{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=F({version:this.version},Tg,e,[]);return t||null}}const Fl={Name:x(C),Title:x(C),Abstract:x(C),KeywordList:x(Bl),OnlineResource:x(br),ContactInformation:x(Wg),Fees:x(C),AccessConstraints:x(C)},vg=O(we,Fl),Pg=O(we,{...Fl,LayerLimit:x(Ee),MaxWidth:x(Ee),MaxHeight:x(Ee)}),Ag=O(we,{ContactPersonPrimary:x(Hg),ContactPosition:x(C),ContactAddress:x(Zg),ContactVoiceTelephone:x(C),ContactFacsimileTelephone:x(C),ContactElectronicMailAddress:x(C)}),Lg=O(we,{ContactPerson:x(C),ContactOrganization:x(C)}),Ig=O(we,{AddressType:x(C),Address:x(C),City:x(C),StateOrProvince:x(C),PostCode:x(C),Country:x(C)}),Cg=O(we,{Format:U(C)}),Ol={Name:x(C),Title:x(C),Abstract:x(C),KeywordList:x(Bl),BoundingBox:ue(Dl),Dimension:ue(Kg),Attribution:x($g),AuthorityURL:ue(ip),Identifier:ue(C),MetadataURL:ue(np),DataURL:ue(bt),FeatureListURL:ue(bt),Style:ue(sp),Layer:ue(un)},Ml=O(we,{...Ol,SRS:ue(C),Extent:x(Jg),ScaleHint:ue(Qg),LatLonBoundingBox:x((i,e)=>Dl(i,e,!1)),Layer:ue(un)}),Nl=O(we,{...Ol,CRS:ue(C),EX_GeographicBoundingBox:x(jg),MinScaleDenominator:x(Ne),MaxScaleDenominator:x(Ne),Layer:ue(un)}),Fg=O(we,{Title:x(C),OnlineResource:x(br),LogoURL:x(Ul)}),Og=O(we,{westBoundLongitude:x(Ne),eastBoundLongitude:x(Ne),southBoundLatitude:x(Ne),northBoundLatitude:x(Ne)}),Mg=O(we,{GetCapabilities:x(Tn),GetMap:x(Tn),GetFeatureInfo:x(Tn)}),Ng=O(we,{Format:ue(C),DCPType:ue(tp)}),Dg=O(we,{HTTP:x(rp)}),Ug=O(we,{Get:x(bt),Post:x(bt)}),Bg=O(we,{Name:x(C),Title:x(C),Abstract:x(C),LegendURL:ue(Ul),StyleSheetURL:x(bt),StyleURL:x(bt)}),Gg=O(we,{Format:x(C),OnlineResource:x(br)}),zg=O(we,{Keyword:U(C)});function $g(i,e){return F({},Fg,i,e)}function kg(i,e){return{SupportSLD:!!tt(i.getAttribute("UserDefinedSymbolization")),UserLayer:!!tt(i.getAttribute("UserLayer")),UserStyle:!!tt(i.getAttribute("UserStyle")),RemoteWFS:!!tt(i.getAttribute("RemoteWFS"))}}function Dl(i,e,t=!0){const r=[ht(i.getAttribute("minx")),ht(i.getAttribute("miny")),ht(i.getAttribute("maxx")),ht(i.getAttribute("maxy"))],n=[ht(i.getAttribute("resx")),ht(i.getAttribute("resy"))],s={extent:r,res:n};return t&&(wr(e)?s.crs=i.getAttribute("CRS"):s.srs=i.getAttribute("SRS")),s}function jg(i,e){const t=F({},Og,i,e);if(!t)return;const r=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(r===void 0||n===void 0||s===void 0||o===void 0))return[r,n,s,o]}function Vg(i,e){return F({},wr(e)?Sg:wg,i,e)}function Xg(i,e){return F({},wr(e)?Pg:vg,i,e)}function Wg(i,e){return F({},Ag,i,e)}function Hg(i,e){return F({},Lg,i,e)}function Zg(i,e){return F({},Ig,i,e)}function Yg(i,e){return F([],Cg,i,e)}function qg(i,e){const t=F({},wr(e)?Nl:Ml,i,e);return t.Layer===void 0?Object.assign(t,un(i,e)):t}function un(i,e){const t=wr(e),r=e[e.length-1],n=F({},t?Nl:Ml,i,e);if(!n)return;let s=tt(i.getAttribute("queryable"));s===void 0&&(s=r.queryable),n.queryable=s!==void 0?s:!1;let o=Pt(i.getAttribute("cascaded"));o===void 0&&(o=r.cascaded),n.cascaded=o;let a=tt(i.getAttribute("opaque"));a===void 0&&(a=r.opaque),n.opaque=a!==void 0?a:!1;let l=tt(i.getAttribute("noSubsets"));l===void 0&&(l=r.noSubsets),n.noSubsets=l!==void 0?l:!1;let c=ht(i.getAttribute("fixedWidth"));c||(c=r.fixedWidth),n.fixedWidth=c;let h=ht(i.getAttribute("fixedHeight"));h||(h=r.fixedHeight),n.fixedHeight=h;const u=["Style","AuthorityURL"];t?u.push("CRS"):u.push("SRS","Dimension"),u.forEach(function(g){if(g in r){const d=n[g]||[];n[g]=d.concat(r[g])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(g){if(!(g in n)){const d=r[g];n[g]=d}}),n}function Kg(i,e){const t={name:i.getAttribute("name"),units:i.getAttribute("units"),unitSymbol:i.getAttribute("unitSymbol")};return wr(e)&&Object.assign(t,{default:i.getAttribute("default"),multipleValues:tt(i.getAttribute("multipleValues")),nearestValue:tt(i.getAttribute("nearestValue")),current:tt(i.getAttribute("current")),values:C(i)}),t}function Jg(i,e){return{name:i.getAttribute("name"),default:i.getAttribute("default"),nearestValue:tt(i.getAttribute("nearestValue"))}}function Qg(i,e){return{min:ht(i.getAttribute("min")),max:ht(i.getAttribute("max"))}}function bt(i,e){return F({},Gg,i,e)}function ep(i,e){return F({},Mg,i,e)}function tp(i,e){return F({},Dg,i,e)}function rp(i,e){return F({},Ug,i,e)}function Tn(i,e){return F({},Ng,i,e)}function Ul(i,e){const t=bt(i,e);if(t){const r=[Pt(i.getAttribute("width")),Pt(i.getAttribute("height"))];return t.size=r,t}}function ip(i,e){const t=bt(i,e);if(t)return t.name=i.getAttribute("name"),t}function np(i,e){const t=bt(i,e);if(t)return t.type=i.getAttribute("type"),t}function sp(i,e){return F({},Bg,i,e)}function Bl(i,e){return F([],zg,i,e)}const op="_feature",ap="_layer";class lp extends Qi{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new Y,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const r=e.localName;let n=[];if(e.childNodes.length===0)return n;if(r=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,c=t[0],h=ap,u=l.localName.replace(h,"");if(this.layers_&&!this.layers_.includes(u))continue;const f=u+op;c.featureType=f,c.featureNS=this.featureNS_;const g={};g[f]=U(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=O([c.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const p=F([],d,l,t,this.gmlFormat_);p&&Ri(n,p)}if(r=="FeatureCollection"){const s=F([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const r={};return t&&Object.assign(r,this.getReadOptions(e,t)),this.readFeatures_(e,[r])}}const dt=[null,"http://www.opengis.net/wmts/1.0"],Sr=[null,"http://www.opengis.net/ows/1.1"],cp=O(dt,{Contents:x(Ep)});let $s=class extends Ns{constructor(){super(),this.owsParser_=new vl}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let r=this.owsParser_.readFromNode(e);return r?(r.version=t,r=F(r,cp,e,[]),r||null):null}};const up=O(dt,{Layer:ue(xp),TileMatrixSet:ue(bp)}),hp=O(dt,{Style:ue(Tp),Format:ue(C),TileMatrixSetLink:ue(wp),Dimension:ue(Sp),ResourceURL:ue(Rp)},O(Sr,{Title:x(C),Abstract:x(C),WGS84BoundingBox:x(zl),BoundingBox:ue(vp),Identifier:x(C)})),fp=O(dt,{LegendURL:ue(Pp)},O(Sr,{Title:x(C),Identifier:x(C)})),dp=O(dt,{TileMatrixSet:x(C),TileMatrixSetLimits:x(Lp)}),gp=O(dt,{TileMatrixLimits:U(Ip)}),pp=O(dt,{TileMatrix:x(C),MinTileRow:x(Ee),MaxTileRow:x(Ee),MinTileCol:x(Ee),MaxTileCol:x(Ee)}),mp=O(dt,{Default:x(C),Value:ue(C)},O(Sr,{Identifier:x(C)})),Gl=O(Sr,{LowerCorner:U(Hn),UpperCorner:U(Hn)}),_p=O(dt,{WellKnownScaleSet:x(C),TileMatrix:ue(Ap)},O(Sr,{SupportedCRS:x(C),Identifier:x(C),BoundingBox:x(zl)})),yp=O(dt,{TopLeftCorner:x(Hn),ScaleDenominator:x(Ne),TileWidth:x(Ee),TileHeight:x(Ee),MatrixWidth:x(Ee),MatrixHeight:x(Ee)},O(Sr,{Identifier:x(C)}));function Ep(i,e){return F({},up,i,e)}function xp(i,e){return F({},hp,i,e)}function bp(i,e){return F({},_p,i,e)}function Tp(i,e){const t=F({},fp,i,e);if(!t)return;const r=i.getAttribute("isDefault")==="true";return t.isDefault=r,t}function wp(i,e){return F({},dp,i,e)}function Sp(i,e){return F({},mp,i,e)}function Rp(i,e){const t=i.getAttribute("format"),r=i.getAttribute("template"),n=i.getAttribute("resourceType"),s={};return t&&(s.format=t),r&&(s.template=r),n&&(s.resourceType=n),s}function zl(i,e){const t=F([],Gl,i,e);if(t.length==2)return ms(t)}function vp(i,e){const t=i.getAttribute("crs"),r=F([],Gl,i,e);if(r.length==2)return{extent:ms(r),crs:t}}function Pp(i,e){const t={};return t.format=i.getAttribute("format"),t.href=br(i),t}function Hn(i,e){const t=C(i).split(/\s+/);if(!t||t.length!=2)return;const r=+t[0],n=+t[1];if(!(isNaN(r)||isNaN(n)))return[r,n]}function Ap(i,e){return F({},yp,i,e)}function Lp(i,e){return F([],gp,i,e)}function Ip(i,e){return F({},pp,i,e)}window.eoxMapAdvancedOlFormats={EsriJSON:tf,GML:Is,GPX:Lf,IGC:hd,IIIFInfo:_d,KML:eh,OWS:vl,Polyline:Hd,TopoJSON:Qu,WFS:fg,WKB:Eg,WKT:jh,WMSCapabilities:Rg,WMSGetFeatureInfo:lp,WMTSCapabilities:$s};function $l(i,e,t){const r=[];let n=i(0),s=i(1),o=e(n),a=e(s);const l=[s,n],c=[a,o],h=[1,0],u={};let f=1e5,g,d,p,m,y,_;for(;--f>0&&h.length>0;)p=h.pop(),n=l.pop(),o=c.pop(),_=p.toString(),_ in u||(r.push(o[0],o[1]),u[_]=!0),m=h.pop(),s=l.pop(),a=c.pop(),y=(p+m)/2,g=i(y),d=e(g),Nu(d[0],d[1],o[0],o[1],a[0],a[1])<t?(r.push(a[0],a[1]),_=m.toString(),u[_]=!0):(h.push(m,y,y,p),c.push(a,d,d,o),l.push(s,g,g,n));return r}function Cp(i,e,t,r,n){const s=oe("EPSG:4326");return $l(function(o){return[i,e+(t-e)*o]},wi(s,r),n)}function Fp(i,e,t,r,n){const s=oe("EPSG:4326");return $l(function(o){return[e+(t-e)*o,i]},wi(s,r),n)}function Op(i){if(!(i.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=i.inversePixelTransform[0],t=i.inversePixelTransform[1],r=Math.sqrt(e*e+t*t),n=i.frameState,s=Gr(i.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=th(n.viewState.resolution,r);let a;return new rh(i.context,r,n.extent,s,n.viewState.rotation,o,a)}const Mp=new Ci({color:"rgba(0,0,0,0.2)"}),Np=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Dp extends al{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:Mp,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?Lo.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?Lo.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new xi({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new Do({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new Fi({color:"rgba(0,0,0,1)"}),stroke:new Ci({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=r=>{const n=r.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new xi({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new Do({font:"12px Calibri,sans-serif",textAlign:"right",fill:new Fi({color:"rgba(0,0,0,1)"}),stroke:new Ci({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=r=>{const n=r.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener($t.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:Np,this.setSource(new tn({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new Vh,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new xi({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let r=e.slice();return this.projection_&&this.getSource().getWrapX()&&Du(r,this.projection_),this.loadedExtent_&&(Uu(this.loadedExtent_,r,t)?r=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[r]}loaderFunction(e,t,r){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=ft(s,e);if(this.renderedExtent_&&kr(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,Ji(o)))return;const a=Lt(o),l=t*t/4;(!this.projection_||!Ei(this.projection_,r))&&this.updateProjectionInfo_(r),this.createGraticule_(o,a,t,l);let h=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(h+=this.meridians_.length),this.parallelsLabels_&&(h+=this.parallels_.length);let u;for(;h>this.featurePool_.length;)u=new Ke,this.featurePool_.push(u);const f=n.getFeaturesCollection();f.clear();let g=0,d,p;for(d=0,p=this.meridians_.length;d<p;++d)u=this.featurePool_[g++],u.setGeometry(this.meridians_[d]),u.setStyle(this.lineStyle_),f.push(u);for(d=0,p=this.parallels_.length;d<p;++d)u=this.featurePool_[g++],u.setGeometry(this.parallels_[d]),u.setStyle(this.lineStyle_),f.push(u)}addMeridian_(e,t,r,n,s,o){const a=this.getMeridian_(e,t,r,n,o);if(ur(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new et([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,r,n,s,o){const a=this.getParallel_(e,t,r,n,o);if(ur(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new et([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,r=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=Lt(s);let a=s;if(t){const d=n[0]*r,p=n[1]*r;a=[o[0]-d/2,o[1]-p/2,o[0]+d/2,o[1]+p/2]}let l=0,c=0,h=this.latLabelPosition_<.5;const u=this.projection_.getExtent(),f=Ce(u);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Si(u,s)){l=Math.floor((s[0]-u[0])/f),c=Math.ceil((s[2]-u[2])/f);const d=Math.abs(t)>Math.PI/2;h=h!==d}const g=Op(e);for(let d=l;d<=c;++d){let p=this.meridians_.length+this.parallels_.length,m,y,_,E;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const w=this.meridians_[y];if(!t&&d===0)E=this.getMeridianPoint_(w,s,y);else{const S=w.clone();S.translate(d*f,0),S.rotate(-t,o),E=this.getMeridianPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.meridiansLabels_[y].text),g.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&h||d===c&&!h))for(y=0,_=this.parallels_.length;y<_;++y){const w=this.parallels_[y];if(!t&&d===0)E=this.getParallelPoint_(w,s,y);else{const S=w.clone();S.translate(d*f,0),S.rotate(-t,o),E=this.getParallelPoint_(S,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.parallelsLabels_[y].text),g.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,r,n){const s=this.getInterval_(r);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Ce(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!Si(a,e)&&(Ce(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const c=[ye(t[0],this.minX_,this.maxX_),ye(t[1],this.minY_,this.maxY_)],h=this.toLonLatTransform_(c);isNaN(h[1])&&(h[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let u=ye(h[0],this.minLon_,this.maxLon_),f=ye(h[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let d,p,m,y,_=e;o||(_=[ye(e[0],this.minX_,this.maxX_),ye(e[1],this.minY_,this.maxY_),ye(e[2],this.minX_,this.maxX_),ye(e[3],this.minY_,this.maxY_)]);const E=hr(_,this.toLonLatTransform_,void 0,8);let w=E[3],S=E[2],T=E[1],v=E[0];if(o||(sr(_,this.bottomLeft_)&&(v=this.minLon_,T=this.minLat_),sr(_,this.bottomRight_)&&(S=this.maxLon_,T=this.minLat_),sr(_,this.topLeft_)&&(v=this.minLon_,w=this.maxLat_),sr(_,this.topRight_)&&(S=this.maxLon_,w=this.maxLat_),w=ye(w,f,this.maxLat_),S=ye(S,u,this.maxLon_),T=ye(T,this.minLat_,f),v=ye(v,this.minLon_,u)),u=Math.floor(u/s)*s,y=ye(u,this.minLon_,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,0),d=0,o)for(;(y-=s)>=v&&d++<g;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.minLon_&&d++<g;)y=Math.max(y-s,this.minLon_),p=this.addMeridian_(y,T,w,n,e,p);if(y=ye(u,this.minLon_,this.maxLon_),d=0,o)for(;(y+=s)<=S&&d++<g;)p=this.addMeridian_(y,T,w,n,e,p);else for(;y!=this.maxLon_&&d++<g;)y=Math.min(y+s,this.maxLon_),p=this.addMeridian_(y,T,w,n,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=ye(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,v,S,n,e,0),d=0;m!=this.minLat_&&d++<g;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,v,S,n,e,p);for(m=ye(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<g;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,v,S,n,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],r=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,c=this.intervals_.length;l<c;++l){const h=ye(this.intervals_[l]/2,0,90),u=ye(r,-90+h,90-h);if(o[0]=t-h,o[1]=u-h,a[0]=t+h,a[1]=u+h,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[l]}return n}getMeridian_(e,t,r,n,s){const o=Cp(e,t,r,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new Et(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,r){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),l=Math.min(t[3],n[o]),c=ye(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),u=[n[s-1]+(n[o-1]-n[s-1])*(c-n[s])/(n[o]-n[s]),c],f=this.meridiansLabels_[r].geom;return f.setCoordinates(u),f}getMeridians(){return this.meridians_}getParallel_(e,t,r,n,s){const o=Fp(e,t,r,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new Et(o,"XY"),a}getParallelPoint_(e,t,r){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),l=Math.min(t[2],n[o]),c=ye(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),h=n[s+1]+(n[o+1]-n[s+1])*(c-n[s])/(n[o]-n[s]),u=[c,h],f=this.parallelsLabels_[r].geom;return f.setCoordinates(u),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=oe("EPSG:4326"),r=e.getWorldExtent();this.maxLat_=r[3],this.maxLon_=r[2],this.minLat_=r[1],this.minLon_=r[0];const n=wi(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,c){c=c||2;const h=n(a,l,c);for(let u=0,f=h.length;u<f;u+=c)h[u]<o&&(h[u]+=360);return h}}this.fromLonLatTransform_=wi(t,e);const s=hr([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Lt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function Yt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Ui(i,e){return i[0]=e[0],i[1]=e[1],i[4]=e[2],i[5]=e[3],i[12]=e[4],i[13]=e[5],i}function Zn(i,e,t,r,n,s,o){o=o??Yt();const a=1/(i-e),l=1/(t-r),c=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*c,o[11]=0,o[12]=(i+e)*a,o[13]=(r+t)*l,o[14]=(s+n)*c,o[15]=1,o}function fa(i,e,t,r,n){return n=n??Yt(),n[0]=i[0]*e,n[1]=i[1]*e,n[2]=i[2]*e,n[3]=i[3]*e,n[4]=i[4]*t,n[5]=i[5]*t,n[6]=i[6]*t,n[7]=i[7]*t,n[8]=i[8]*r,n[9]=i[9]*r,n[10]=i[10]*r,n[11]=i[11]*r,n[12]=i[12],n[13]=i[13],n[14]=i[14],n[15]=i[15],n}function Up(i,e,t,r,n){n=n??Yt();let s,o,a,l,c,h,u,f,g,d,p,m;return i===n?(n[12]=i[0]*e+i[4]*t+i[8]*r+i[12],n[13]=i[1]*e+i[5]*t+i[9]*r+i[13],n[14]=i[2]*e+i[6]*t+i[10]*r+i[14],n[15]=i[3]*e+i[7]*t+i[11]*r+i[15]):(s=i[0],o=i[1],a=i[2],l=i[3],c=i[4],h=i[5],u=i[6],f=i[7],g=i[8],d=i[9],p=i[10],m=i[11],n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=c,n[5]=h,n[6]=u,n[7]=f,n[8]=g,n[9]=d,n[10]=p,n[11]=m,n[12]=s*e+c*t+g*r+i[12],n[13]=o*e+h*t+d*r+i[13],n[14]=a*e+u*t+p*r+i[14],n[15]=l*e+f*t+m*r+i[15]),n}function Bp(i,e,t,r){return r=r??Yt(),r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=i,r[13]=e,r[14]=t,r[15]=1,r}const Qr=34962,ei=34963,ks=35044,Bi=35048,Gp=5121,zp=5123,$p=5125,kl=5126,da=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function kp(i,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!ih},e);const t=da.length;for(let r=0;r<t;++r)try{const n=i.getContext(da[r],e);if(n)return n}catch{}return null}const jp={STATIC_DRAW:ks};class fr{constructor(e,t){this.array_=null,this.type_=e,Je(e===Qr||e===ei,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:jp.STATIC_DRAW}ofSize(e){return this.array_=new(gi(this.type_))(e),this}fromArray(e){return this.array_=gi(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(gi(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=gi(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function gi(i){switch(i){case Qr:return Float32Array;case ei:return Uint32Array;default:return Float32Array}}const pi={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},Vp=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Xp=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class ga{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const r=t.createShader(t.VERTEX_SHADER);t.shaderSource(r,e.vertexShader||Vp),t.compileShader(r);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||Xp),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,r),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),r=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,r[0],r[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==r[0]||this.renderTargetTextureSize_[1]!==r[1]){this.renderTargetTextureSize_=r;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,r[0],r[1],o,a,l,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,r[0],r[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,r,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=ce(s.canvas);if(!e.renderTargets[l]){const c=s.getContextAttributes();c&&c.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),r&&r(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let r,n=1;this.uniforms_.forEach(function(s){if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,r.width,r.height,0,t.UNSIGNED_BYTE,new Uint8Array(r.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),t.uniform1i(s.location,n++);else if(Array.isArray(r))switch(r.length){case 2:t.uniform2f(s.location,r[0],r[1]);return;case 3:t.uniform3f(s.location,r[0],r[1],r[2]);return;case 4:t.uniform4f(s.location,r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(s.location,r)})}}const ut={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},xe={UNSIGNED_BYTE:Gp,UNSIGNED_SHORT:zp,UNSIGNED_INT:$p,FLOAT:kl},Gi={};function pa(i){return"shared/"+i}let ma=0;function Wp(){const i="unique/"+ma;return ma+=1,i}function Hp(i){let e=Gi[i];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:kp(t)},Gi[i]=e}return e.users+=1,e.context}function Zp(i){const e=Gi[i];if(!e||(e.users-=1,e.users>0))return;const t=e.context,r=t.getExtension("WEBGL_lose_context");r&&r.loseContext();const n=t.canvas;n.width=1,n.height=1,delete Gi[i]}class Yp extends rl{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?pa(e.canvasCacheKey):Wp(),this.gl_=Hp(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(pi.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(pi.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Ie(),this.offsetScaleMatrix_=Ie(),this.tmpMat4_=Yt(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(r=>new ga({webGlContext:this.gl_,scaleRatio:r.scaleRatio,vertexShader:r.vertexShader,fragmentShader:r.fragmentShader,uniforms:r.uniforms})):[new ga({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===pa(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,r=ce(e);let n=this.bufferCache_[r];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[r]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=ce(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(pi.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(pi.RESTORED,this.boundHandleWebGLContextRestored_),Zp(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,r){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),r?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const r=this.getGL();r.bindFramebuffer(r.FRAMEBUFFER,e),t&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const r=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}bindTexture(e,t,r){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(r),t)}bindAttribute(e,t,r){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,r,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,r,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,r?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const r=this.gl_;this.getExtension("OES_element_index_uint");const n=r.UNSIGNED_INT,s=4,o=t-e,a=e*s;r.drawElements(r.TRIANGLES,o,n,a)}finalizeDraw(e,t,r){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,r):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,r=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(ut.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(ut.ZOOM,e.viewState.zoom),this.setUniformFloatValue(ut.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(ut.PIXEL_RATIO,n),this.setUniformFloatVec2(ut.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(ut.ROTATION,r)}applyHitDetectionUniform(e){const t=this.getUniformLocation(ut.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(ut.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let r,n=0;this.uniforms_.forEach(s=>{if(r=typeof s.value=="function"?s.value(e):s.value,r instanceof HTMLCanvasElement||r instanceof HTMLImageElement||r instanceof ImageData||r instanceof WebGLTexture){r instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=r):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(r instanceof HTMLImageElement)||r.complete;!(r instanceof WebGLTexture)&&o&&s.prevValue!==r&&(s.prevValue=r,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)),n++}else if(Array.isArray(r)&&r.length===6)this.setUniformMatrixValue(s.name,Ui(this.tmpMat4_,r));else if(Array.isArray(r)&&r.length<=4)switch(r.length){case 2:t.uniform2f(this.getUniformLocation(s.name),r[0],r[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),r[0],r[1],r[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),r[0],r[1],r[2],r[3]);return;default:return}else typeof r=="number"&&t.uniform1f(this.getUniformLocation(s.name),r)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const r=this.gl_,n=r.createShader(t);return r.shaderSource(n,e),r.compileShader(n),n}getProgram(e,t){const r=this.gl_,n=this.compileShader(e,r.FRAGMENT_SHADER),s=this.compileShader(t,r.VERTEX_SHADER),o=r.createProgram();if(r.attachShader(o,n),r.attachShader(o,s),r.linkProgram(o),!r.getShaderParameter(n,r.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${r.getShaderInfoLog(n)}`;throw new Error(a)}if(r.deleteShader(n),!r.getShaderParameter(s,r.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${r.getShaderInfoLog(s)}`;throw new Error(a)}if(r.deleteShader(s),!r.getProgramParameter(o,r.LINK_STATUS)){const a=`GL program linking failed: ${r.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=ce(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=ce(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const r=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return fs(t,0,0,2/(s*r[0]),2/(s*r[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,r,n,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,r,!1,n,s))}enableAttributes(e){const t=qp(e);let r=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||kl,t,r),r+=s.size*jl(s.type)}}handleWebGLContextLost(e){Bu(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,r,n){const s=this.gl_;r=r||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,r),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,c=0,h=s.RGBA,u=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,h,u,t):t?s.texImage2D(s.TEXTURE_2D,a,l,h,u,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,h,u,null),r}}function qp(i){let e=0;for(let t=0;t<i.length;t++){const r=i[t];e+=r.size*jl(r.type)}return e}function jl(i){switch(i){case xe.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case xe.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case xe.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Kp extends Gu{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(Be.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===q.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Es){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(Be.CHANGE,this.handleTileChange_)}}uploadTile(){ps()}setReady(){this.ready=!0,this.dispatchEvent(Be.CHANGE)}handleTileChange_(){this.tile.getState()===q.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(Be.CHANGE,this.handleTileChange_)}}function Vl(i,e,t){const r=t?i.LINEAR:i.NEAREST;i.bindTexture(i.TEXTURE_2D,e),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,r)}function Jp(i,e,t,r){Vl(i,e,r),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}function _a(i,e,t,r,n,s){const o=i.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,i.getExtension("OES_texture_float"),l=i.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Vl(o,e,s&&l);const c=t.byteLength/r[1];let h=1;c%8===0?h=8:c%4===0?h=4:c%2===0&&(h=2);let u;switch(n){case 1:{u=o.LUMINANCE;break}case 2:{u=o.LUMINANCE_ALPHA;break}case 3:{u=o.RGB;break}case 4:{u=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,h),o.texImage2D(o.TEXTURE_2D,0,u,r[0],r[1],0,u,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let rr=null;function Qp(){rr=Ft(1,1,void 0,{willReadFrequently:!0})}class em extends Kp{constructor(e){super(e),this.textures=[],this.renderSize_=it(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new fr(Qr,ks);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var r;const t=(r=this.helper)==null?void 0:r.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),r=this.tile;this.textures.length=0;let n;r instanceof Es||r instanceof nh?n=r.getImage():n=r.getData();const s=$n(n);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,Jp(t,_,s,r.interpolate),this.setReady();return}n=zn(n);const o=r.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=n instanceof Float32Array,c=a[0]*a[1],h=l?Float32Array:Uint8Array,u=h.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/u/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const _=t.createTexture();this.textures.push(_),_a(e,_,n,a,this.bandCount,r.interpolate),this.setReady();return}const d=new Array(g);for(let _=0;_<g;++_){const E=t.createTexture();this.textures.push(E);const w=_<g-1?4:(this.bandCount-1)%4+1;d[_]=new h(c*w)}let p=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let E=0;E<y;++E){const w=n[m+E],S=Math.floor(p/this.bandCount),T=E%this.bandCount,v=Math.floor(T/4),I=d[v],A=I.length/c,R=T%4;I[S*A+R]=w,++p}m+=f/u}for(let _=0;_<g;++_){const E=this.textures[_],w=d[_],S=w.length/c;_a(e,E,w,a,S,r.interpolate)}this.setReady()}getImagePixelData_(e,t,r){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];rr||Qp(),rr.clearRect(0,0,1,1);const a=e.width,l=e.height,c=a-2*n,h=l-2*n,u=n+Math.floor(c*(t/s)),f=n+Math.floor(h*(r/o));let g;try{rr.drawImage(e,u,f,1,1,0,0,1,1),g=rr.getImageData(0,0,1,1).data}catch{return rr=null,null}return g}getArrayPixelData_(e,t,r,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],c=t[1],h=l+2*s,u=c+2*s,f=s+Math.floor(l*(r/o)),g=s+Math.floor(c*(n/a));if(e instanceof DataView){const p=e.byteLength/(h*u),m=p*(g*h+f),y=e.buffer.slice(m,m+p);return new DataView(y)}const d=this.bandCount*(g*h+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof xs){const r=this.tile.getData(),n=zn(r);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_($n(r),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class ti extends sh{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Ie(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(Xn.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const r=this.getLayer();if(r.hasListener($t.PRECOMPOSE)){const n=new xn($t.PRECOMPOSE,void 0,t,e);r.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const r=this.getLayer();if(r.hasListener($t.POSTCOMPOSE)){const n=new xn($t.POSTCOMPOSE,void 0,t,e);r.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,r=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,c=l.getRenderer();if(!(c instanceof ti)){t=!0;continue}const h=l.getClassName();if((t||h!==n)&&(r+=1,t=!1),n=h,c===this)break}const s="map/"+e.mapId+"/group/"+r;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Yp({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(Xn.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,r){const n=this.getLayer();if(n.hasListener(e)){fs(this.inversePixelTransform_,0,0,r.pixelRatio,-r.pixelRatio,0,0,-r.size[1]);const s=new xn(e,this.inversePixelTransform_,r,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_($t.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_($t.POSTRENDER,e,t)}}const tm={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function ya(i){return 1/(i+2)}function rm(){return{tileIds:new Set,representationsByZ:{}}}function Ea(i,e){return i.tileIds.has(ce(e))}function xa(i,e,t){const r=i.representationsByZ;t in r||(r[t]=new Set),r[t].add(e),i.tileIds.add(ce(e.tile))}function wn(i,e){const t=i.layerStatesArray[i.layerIndex];t.extent&&(e=ft(e,Ja(t.extent,i.viewState.projection)));const r=t.layer.getRenderSource();if(!r.getWrapX()){const n=r.getTileGridForProjection(i.viewState.projection).getExtent();n&&(e=ft(e,n))}return e}function Yn(i,e){return`${i.getKey()},${i.getRevision()},${tr(e)}`}class im extends ti{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Ie(),this.tempMat4=Yt(),this.tempTileRange_=new oh(0,0,0,0),this.tempTileCoord_=kn(0,0,0),this.tempSize_=[0,0];const r=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new ll(r),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const r=this.getLayer().getRenderSource();return!r||Ji(wn(e,e.extent))?!1:r.getState()==="ready"}createTileRepresentation(e){return ps()}enqueueTiles(e,t,r,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),c=l.getTileGridForProjection(o.projection),h=l.getGutterForProjection(o.projection),u=ce(l);u in e.wantedTiles||(e.wantedTiles[u]={});const f=e.wantedTiles[u],g=this.tileRepresentationCache,d=a.getMapInternal(),p=Math.max(r-s,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),l.zDirection)),m=o.rotation,y=m?zu(o.center,o.resolution,m,e.size):void 0;for(let _=r;_>=p;--_){const E=c.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),w=c.getResolution(_);for(let S=E.minX;S<=E.maxX;++S)for(let T=E.minY;T<=E.maxY;++T){if(m&&!c.tileCoordIntersectsViewport([_,S,T],y))continue;const v=kn(_,S,T,this.tempTileCoord_),I=Yn(l,v);let A,R;if(g.containsKey(I)&&(A=g.get(I),R=A.tile),(!A||A.tile.key!==l.getKey())&&(R=l.getTile(_,S,T,e.pixelRatio,o.projection),!R)||Ea(n,R))continue;A?A.setTile(R):(A=this.createTileRepresentation({tile:R,grid:c,helper:this.helper,gutter:h}),g.set(I,A)),xa(n,A,_);const M=R.getKey();f[M]=!0,R.getState()===q.IDLE&&(e.tileQueue.isKeyQueued(M)||e.tileQueue.enqueue([R,u,c.getTileCoordCenter(v),w]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,r,n,s,o,a,l,c,h,u){}renderTileMask(e,t,r,n){}drawTile_(e,t,r,n,s,o,a){if(!t.ready)return;const c=t.tile.tileCoord,h=tr(c),u=h in o?o[h]:1,f=a.getResolution(r),g=it(a.getTileSize(r),this.tempSize_),d=a.getOrigin(r),p=a.getTileCoordExtent(c),m=u<1?-1:ya(r);u<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],E=y.center[1],w=g[0]+2*n,S=g[1]+2*n,T=w/S,v=(_-d[0])/(g[0]*f),I=(d[1]-E)/(g[1]*f),A=y.resolution/f,R=c[1],M=c[2];Su(this.tileTransform_),Io(this.tileTransform_,2/(e.size[0]*A/w),-2/(e.size[1]*A/w)),Ru(this.tileTransform_,y.rotation),Io(this.tileTransform_,1,1/T),ds(this.tileTransform_,(g[0]*(R-v)-n)/w,(g[1]*(M-I)-n)/S),this.renderTile(t,this.tileTransform_,e,s,f,g,d,p,m,n,u)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const r=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(r.projection),a=s.getGutterForProjection(r.projection),l=wn(e,e.extent),c=o.getZForResolution(r.resolution,s.zDirection),h=rm(),u=n.getPreload();if(e.nextExtent){const E=o.getZForResolution(r.nextResolution,s.zDirection),w=wn(e,e.nextExtent);this.enqueueTiles(e,w,E,h,u)}this.enqueueTiles(e,l,c,h,0),u>0&&setTimeout(()=>{this.enqueueTiles(e,l,c-1,h,u-1)},0);const f={};let g=!1;const d=h.representationsByZ;if(c in d){const E=ce(this),w=e.time;for(const S of d[c]){const T=S.tile;if(T.getState()===q.EMPTY)continue;const v=T.tileCoord;if(S.ready){const R=T.getAlpha(E,w);if(R===1){T.endTransition(E);continue}g=!0;const M=tr(v);f[M]=R}if(this.renderComplete=!1,this.findAltTiles_(o,v,c+1,h))continue;const A=o.getMinZoom();for(let R=c-1;R>=A&&!this.findAltTiles_(o,v,R,h);--R);}}const p=Object.keys(d).map(Number).sort($u);if(this.beforeTilesMaskRender(e))for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of d[S]){const v=T.tile.tileCoord;if(tr(v)in f)continue;const A=o.getTileCoordExtent(v);this.renderTileMask(T,S,A,ya(S))}}this.beforeTilesRender(e,g);for(let E=0,w=p.length;E<w;++E){const S=p[E];for(const T of d[S]){const v=T.tile.tileCoord;tr(v)in f||this.drawTile_(e,T,S,a,l,f,o)}}if(c in d)for(const E of d[c]){const w=E.tile.tileCoord;tr(w)in f&&this.drawTile_(e,E,c,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas(),_=this.tileRepresentationCache;for(;_.canExpireCache();)_.pop().dispose();return this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,r,n){const s=e.getTileRangeForTileCoordAndZ(t,r,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let c=s.minX;c<=s.maxX;++c)for(let h=s.minY;h<=s.maxY;++h){const u=Yn(l,[r,c,h]);let f=!1;if(a.containsKey(u)){const g=a.get(u);g.ready&&!Ea(n,g.tile)&&(xa(n,g,r),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const V={...tm,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},bi={TEXTURE_COORD:"a_textureCoord"},nm=[{name:bi.TEXTURE_COORD,size:2,type:xe.FLOAT}];class sm extends im{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new fr(ei,ks),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const r of this.paletteTextures_)r.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const r of this.paletteTextures_)r.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new em(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,r,n,s,o,a,l,c,h,u){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(nm);let g=0;for(;g<e.textures.length;){const T=`${V.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,T),++g}for(let T=0;T<this.paletteTextures_.length;++T){const v=this.paletteTextures_[T],I=v.getTexture(f);this.helper.bindTexture(I,g,v.name),++g}const d=r.viewState,p=o[0]+2*h,m=o[1]+2*h,_=e.tile.tileCoord,E=_[1],w=_[2];this.helper.setUniformMatrixValue(V.TILE_TRANSFORM,Ui(this.tempMat4,t)),this.helper.setUniformFloatValue(V.TRANSITION_ALPHA,u),this.helper.setUniformFloatValue(V.DEPTH,c);let S=n;h>0&&(S=l,ft(S,n,S)),this.helper.setUniformFloatVec4(V.RENDER_EXTENT,S),this.helper.setUniformFloatValue(V.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(V.ZOOM,d.zoom),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(V.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(V.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_X,a[0]+E*o[0]*s-h*s),this.helper.setUniformFloatValue(V.TEXTURE_ORIGIN_Y,a[1]-w*o[1]*s+h*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const r=this.frameState;if(!r)return null;const n=this.getLayer(),s=xt(r.pixelToCoordinateTransform,e.slice()),o=r.viewState,a=n.getExtent();if(a&&!sr(Ja(a,o.projection),s))return null;const l=n.getSources(ms([s]),o.resolution);let c,h,u;for(c=l.length-1;c>=0;--c)if(h=l[c],h.getState()==="ready"){if(u=h.getTileGridForProjection(o.projection),h.getWrapX())break;const g=u.getExtent();if(!g||sr(g,s))break}if(c<0)return null;const f=this.tileRepresentationCache;for(let g=u.getZForResolution(o.resolution);g>=u.getMinZoom();--g){const d=u.getTileCoordForCoordAndZ(s,g),p=Yn(h,d);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===q.EMPTY)return null;if(!m.loaded)continue;const _=u.getOrigin(g),E=it(u.getTileSize(g)),w=u.getResolution(g),S=(s[0]-_[0])/w-d[1]*E[0],T=(_[1]-s[1])/w-d[2]*E[1];return m.getPixelData(S,T)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const r of this.paletteTextures_)r.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class om{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function am(i,e){return`operator_${i}_${Object.keys(e.functions).length}`}function Ct(i){const e=i.toString();return e.includes(".")?e:e+".0"}function js(i){if(i.length<2||i.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${i.length}(${i.map(Ct).join(", ")})`}function Ti(i){const e=qr(i),t=e.length>3?e[3]:1;return js([e[0]/255,e[1]/255,e[2]/255,t])}function lm(i){const e=it(i);return js(e)}const Sn={};let cm=0;function dr(i){return i in Sn||(Sn[i]=cm++),Sn[i]}function pt(i){return Ct(dr(i))}function hn(i){return"u_var_"+i}function Vs(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Rn="getBandValue",Xl="u_paletteTextures",Wl="featureId",Hl="geometryType",qn=-9999999;function um(i,e,t,r){const n=ah(i,e,t);return Xs(n,e,r)}function se(i){return(e,t,r)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=Xs(t.args[o],r,e);return i(s,e)}}const hm={[W.Get]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),"a_prop_"+r},[W.Id]:i=>(i.featureId=!0,"a_"+Wl),[W.GeometryType]:i=>(i.geometryType=!0,"a_"+Hl),[W.LineMetric]:()=>"currentLineMetric",[W.Var]:(i,e)=>{const r=e.args[0].value;return r in i.variables||(i.variables[r]={name:r,type:e.type}),hn(r)},[W.Has]:(i,e)=>{const r=e.args[0].value;return r in i.properties||(i.properties[r]={name:r,type:e.type}),`(a_prop_${r} != ${Ct(qn)})`},[W.Resolution]:()=>"u_resolution",[W.Zoom]:()=>"u_zoom",[W.Time]:()=>"u_time",[W.Any]:se(i=>`(${i.join(" || ")})`),[W.All]:se(i=>`(${i.join(" && ")})`),[W.Not]:se(([i])=>`(!${i})`),[W.Equal]:se(([i,e])=>`(${i} == ${e})`),[W.NotEqual]:se(([i,e])=>`(${i} != ${e})`),[W.GreaterThan]:se(([i,e])=>`(${i} > ${e})`),[W.GreaterThanOrEqualTo]:se(([i,e])=>`(${i} >= ${e})`),[W.LessThan]:se(([i,e])=>`(${i} < ${e})`),[W.LessThanOrEqualTo]:se(([i,e])=>`(${i} <= ${e})`),[W.Multiply]:se(i=>`(${i.join(" * ")})`),[W.Divide]:se(([i,e])=>`(${i} / ${e})`),[W.Add]:se(i=>`(${i.join(" + ")})`),[W.Subtract]:se(([i,e])=>`(${i} - ${e})`),[W.Clamp]:se(([i,e,t])=>`clamp(${i}, ${e}, ${t})`),[W.Mod]:se(([i,e])=>`mod(${i}, ${e})`),[W.Pow]:se(([i,e])=>`pow(${i}, ${e})`),[W.Abs]:se(([i])=>`abs(${i})`),[W.Floor]:se(([i])=>`floor(${i})`),[W.Ceil]:se(([i])=>`ceil(${i})`),[W.Round]:se(([i])=>`floor(${i} + 0.5)`),[W.Sin]:se(([i])=>`sin(${i})`),[W.Cos]:se(([i])=>`cos(${i})`),[W.Atan]:se(([i,e])=>e!==void 0?`atan(${i}, ${e})`:`atan(${i})`),[W.Sqrt]:se(([i])=>`sqrt(${i})`),[W.Match]:se(i=>{const e=i[0],t=i[i.length-1];let r=null;for(let n=i.length-3;n>=1;n-=2){const s=i[n],o=i[n+1];r=`(${e} == ${s} ? ${o} : ${r||t})`}return r}),[W.Between]:se(([i,e,t])=>`(${i} >= ${e} && ${i} <= ${t})`),[W.Interpolate]:se(([i,e,...t])=>{let r="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=r||t[n+1],a=t[n+2],l=t[n+3];let c;i===Ct(1)?c=`(${e} - ${s}) / (${a} - ${s})`:c=`(pow(${i}, (${e} - ${s})) - 1.0) / (pow(${i}, (${a} - ${s})) - 1.0)`,r=`mix(${o}, ${l}, clamp(${c}, 0.0, 1.0))`}return r}),[W.Case]:se(i=>{const e=i[i.length-1];let t=null;for(let r=i.length-3;r>=0;r-=2){const n=i[r],s=i[r+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[W.In]:se(([i,...e],t)=>{const r=am("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[r]=`bool ${r}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${r}(${i})`}),[W.Array]:se(i=>`vec${i.length}(${i.join(", ")})`),[W.Color]:se(i=>{if(i.length===1)return`vec4(vec3(${i[0]} / 255.0), 1.0)`;if(i.length===2)return`vec4(vec3(${i[0]} / 255.0), ${i[1]})`;const e=i.slice(0,3).map(r=>`${r} / 255.0`);if(i.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=i[3];return`vec4(${e.join(", ")}, ${t})`}),[W.Band]:se(([i,e,t],r)=>{if(!(Rn in r.functions)){let n="";const s=r.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const c=`${V.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}r.functions[Rn]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${V.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${V.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${Rn}(${i}, ${e??"0.0"}, ${t??"0.0"})`}),[W.Palette]:(i,e)=>{const[t,...r]=e.args,n=r.length,s=new Uint8Array(n*4);for(let c=0;c<r.length;c++){const h=r[c].value,u=qr(h),f=c*4;s[f]=u[0],s[f+1]=u[1],s[f+2]=u[2],s[f+3]=u[3]*255}i.paletteTextures||(i.paletteTextures=[]);const o=`${Xl}[${i.paletteTextures.length}]`,a=new om(o,s);i.paletteTextures.push(a);const l=Xs(t,ie,i);return`texture2D(${o}, vec2((${l} + 0.5) / ${n}.0, 0.5))`}};function Xs(i,e,t){if(i instanceof lh){const r=hm[i.operator];if(r===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(i.operator)}`);return r(t,i,e)}if((i.type&ie)>0)return Ct(i.value);if((i.type&rn)>0)return i.value.toString();if((i.type&Vr)>0)return pt(i.value.toString());if((i.type&$e)>0)return Ti(i.value);if((i.type&Ot)>0)return js(i.value);if((i.type&yr)>0)return lm(i.value);throw new Error(`Unexpected expression ${i.value} (expected type ${ch(e)})`)}function fm(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const ba=.985,Kt=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,Jt=fm();class Zl{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Ct(Jt["circle-radius"])} + ${Ct(Jt["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Ti(Jt["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Ct(Jt["stroke-width"]),this.strokeColorExpression_=Ti(Jt["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=pt("round"),this.strokeJoinExpression_=pt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Ti(Jt["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e){return this.uniforms_.push(e),this}addAttribute(e,t,r,n){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:n??t,varyingExpression:r??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_};
  ${this.symbolRotateWithView_?"angle += u_rotation;":""}
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y); 
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;

varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);
  
  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${ba} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${ba}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${pt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${pt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${pt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${pt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
      
  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx;
  float currentRadiusPx = distanceFromSegment(currentPoint, v_segmentStart, v_segmentEnd);
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPoint / segmentLength);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${Kt}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}function $(i,e,t){const r=cl();return um(e,t,r,i)}function dm(i){const e=qr(i),t=e[0]*256,r=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+r,n+s]}const gm=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function Ws(i){return i===$e||i===yr?2:i===Ot?4:1}function Kn(i){const e=Ws(i);return e>1?`vec${e}`:"float"}function Yl(i,e){for(const t in e.variables){const r=e.variables[t],n=hn(r.name);let s=Kn(r.type);r.type===$e&&(s="vec4"),i.addUniform(`${s} ${n}`)}for(const t in e.properties){const r=e.properties[t],n=Kn(r.type),s=`a_prop_${r.name}`;r.type===$e?(i.addAttribute(s,n,`unpackColor(${s})`,"vec4"),i.addVertexShaderFunction(gm)):i.addAttribute(s,n)}for(const t in e.functions)i.addVertexShaderFunction(e.functions[t]),i.addFragmentShaderFunction(e.functions[t])}function ql(i,e){const t={};for(const r in i.variables){const n=i.variables[r],s=hn(n.name);t[s]=()=>{const o=e[n.name];return typeof o=="number"?o:typeof o=="boolean"?o?1:0:n.type===$e?qr(o||"#eee"):typeof o=="string"?dr(o):o}}return t}function Kl(i){const e={};for(const t in i.properties){const r=i.properties[t],n=s=>{const o=s.get(r.name);return r.type===$e?dm([...qr(o||"#eee")]):typeof o=="string"?dr(o):typeof o=="boolean"?o?1:0:o};e[`prop_${r.name}`]={size:Ws(r.type),callback:n}}return e}class zi{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let r=0;r<e.length;r++)this.addFeature(e[r],t)}addFeature(e,t){let r=e.getGeometry();r&&(t&&(r=r.clone(),r.applyTransform(t)),this.addGeometry_(r,e))}clearFeatureEntryInPointBatch_(e){const t=ce(e),r=this.pointBatch.entries[t];if(r)return this.pointBatch.geometriesCount-=r.flatCoordss.length,delete this.pointBatch.entries[t],r}clearFeatureEntryInLineStringBatch_(e){const t=ce(e),r=this.lineStringBatch.entries[t];if(r)return this.lineStringBatch.verticesCount-=r.verticesCount,this.lineStringBatch.geometriesCount-=r.flatCoordss.length,delete this.lineStringBatch.entries[t],r}clearFeatureEntryInPolygonBatch_(e){const t=ce(e),r=this.polygonBatch.entries[t];if(r)return this.polygonBatch.verticesCount-=r.verticesCount,this.polygonBatch.ringsCount-=r.ringsCount,this.polygonBatch.geometriesCount-=r.flatCoordss.length,delete this.polygonBatch.entries[t],r}addGeometry_(e,t){var n;const r=e.getType();switch(r){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEndss(),t,ce(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ce(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),s.getEnds(),t,ce(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(r,s.getFlatCoordinates(),null,t,ce(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,r,n,s,o,a){let l;switch(e){case"MultiPolygon":{const c=r;for(let h=0,u=c.length;h<u;h++){let f=c[h];const g=h>0?c[h-1]:null,d=g?g[g.length-1]:0,p=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,p),f,n,s,o,a)}break}case"MultiLineString":{const c=r;for(let h=0,u=c.length;h<u;h++){const f=h>0?c[h-1]:0;this.addCoordinates_("LineString",t.slice(f,c[h]),null,n,s,o,a)}break}case"MultiPoint":for(let c=0,h=t.length;c<h;c+=o)this.addCoordinates_("Point",t.slice(c,c+2),null,n,s,null,null);break;case"Polygon":{const c=r;if(n instanceof vu){const f=Pu(t,c);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const h=r.length,u=r.map((f,g,d)=>g>0?(f-d[g-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=h,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(pm(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(u),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=h;for(let f=0,g=c.length;f<g;f++){const d=f>0?c[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,c[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(mm(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const r=this.uidToRef_.get(e),n=r||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,r||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e){if(!this.uidToRef_.get(ce(e)))return;this.removeFeature(e);const t=e.getGeometry();t&&this.addGeometry_(t,e)}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,ce(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new zi;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let r=!0;for(const n of this.refToFeature_.values())e(n)&&(t.addFeature(n),r=!1);return r?new zi:t}}function pm(i,e){return e===2?i:i.filter((t,r)=>r%e<2)}function mm(i,e,t){return e===3&&t==="XYM"?i:e===4?i.filter((r,n)=>n%e!==2):e===3?i.map((r,n)=>n%e!==2?r:0):new Array(i.length*1.5).fill(0).map((r,n)=>n%3===2?0:i[Math.round(n/1.5)])}function Jl(){const i='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let u=e(t,0,i,x,!0);const l=[];if(!u||u.next===u.prev)return l;let c,h,y;if(o&&(u=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const u=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);u===u.next&&(u.steiner=!0),o.push(a(u))}o.sort(f);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,u,x)),t.length>80*x){c=1/0,h=1/0;let e=-1/0,n=-1/0;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<h&&(h=o),x>e&&(e=x),o>n&&(n=o)}y=Math.max(e-c,n-h),y=0!==y?32767/y:0}return r(u,l,x,c,h,y,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=w(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=w(x/r|0,t[x],t[x+1],o);return o&&g(o,o.next)&&(A(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!g(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(A(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,f,s,l,a,h){if(!t)return;!h&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let y=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),A(t),t=p.next,y=p.next;else if((t=p)===y){h?1===h?r(t=i(n(t),e),e,f,s,l,a,2):2===h&&u(t,e,f,s,l,a):r(n(t),e,f,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=h&&y(x,u,o,f,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,a=o.y,h=i.y,p=Math.min(u,f,s),g=Math.min(l,a,h),b=Math.max(u,f,s),M=Math.max(l,a,h),m=c(p,g,e,n,r),Z=c(b,M,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!g(n,x)&&b(n,r,r.next,x)&&Z(n,x)&&Z(x,n)&&(e.push(n.i,r.i,x.i),A(r),A(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function u(t,e,x,o,i,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&p(f,t)){let s=d(f,t);return f=n(f,f.next),s=n(s,s.next),r(f,e,x,o,i,u,0),void r(s,e,x,o,i,u,0)}t=t.next}f=f.next}while(f!==t)}function f(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(g(t,n))return n;do{if(g(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&h(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);Z(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==u);return o}(t,e);if(!r)return e;const x=d(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function h(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function y(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&h(t,e,n,r,x,o,i,u)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Z(t,e)&&Z(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||g(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function g(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){const x=m(v(t,e,n)),o=m(v(t,e,r)),i=m(v(n,r,t)),u=m(v(n,r,e));return x!==o&&i!==u||(!(0!==x||!M(t,n,e))||(!(0!==o||!M(t,r,e))||(!(0!==i||!M(n,t,r))||!(0!==u||!M(n,e,r)))))}function M(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function m(t){return t>0?1:t<0?-1:0}function Z(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function d(t,e){const n=E(t.i,t.x,t.y),r=E(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function w(t,e,n,r){const x=E(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function A(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function I(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function z(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const F=[],P={vertexPosition:0,indexPosition:0};function B(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function N(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=F;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return B(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,P.vertexPosition=l,P.indexPosition=c,P}function R(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=I(f,[...h]),b=I(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,I(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,I(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function S(e,n,r,x,o){const i=2+o;let u=n;const f=e.slice(u,u+o);u+=o;const s=e[u++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[u++],t<s-1&&(c[t]=l);const a=e.slice(u,u+2*l),h=t(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...f);return u+2*l}const T="GENERATE_POLYGON_BUFFERS",_="GENERATE_POINT_BUFFERS",O="GENERATE_LINE_STRING_BUFFERS",U=self;U.onmessage=t=>{const e=t.data;switch(e.type){case _:{const t=3,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x,u=4*i*(r+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=x)l=N(o,t,s,f,r,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},e);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case O:{const t=[],n=[],r=e.customAttributesSize,x=3,o=new Float32Array(e.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(z(u,e.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+r)),i+=r,f=o[i++];const e=i,l=i+(f-1)*x,c=o[e]===o[l]&&o[e+1]===o[l+1];let a=0,h=0;for(let r=0;r<f-1;r++){let y=null;r>0?y=i+(r-1)*x:c&&(y=l-x);let p=null;r<f-2?p=i+(r+2)*x:c&&(p=e+x);const v=R(o,i+r*x,i+(r+1)*x,y,p,t,n,s,u,a,h);a=v.length,h=v.angle}i+=f*x}const l=Uint32Array.from(n),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},e);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case T:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=S(x,o,t,n,r);const i=Uint32Array.from(n),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:x.buffer},e);U.postMessage(f,[u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(i,"binary").toString("base64"):URL.createObjectURL(new Blob([i],{type:"application/javascript"})))}const Or={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function Ql(i,e){e=e||[];const t=256,r=t-1;return e[0]=Math.floor(i/t/t/t)/r,e[1]=Math.floor(i/t/t)%t/r,e[2]=Math.floor(i/t)%t/r,e[3]=i%t/r,e}function ec(i){let e=0;const t=256,r=t-1;return e+=Math.round(i[0]*t*t*t*r),e+=Math.round(i[1]*t*t*r),e+=Math.round(i[2]*t*r),e+=Math.round(i[3]*r),e}function Hs(i,e,t,r){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===qn&&console.warn('The "has" operator might return false positives.'),l===void 0?l=qn:l===null&&(l=0),i[r+n++]=l,!(!o.size||o.size===1)&&(i[r+n++]=a[1],!(o.size<3)&&(i[r+n++]=a[2],!(o.size<4)&&(i[r+n++]=a[3])))}return n}function fn(i){return Object.keys(i).reduce((e,t)=>e+(i[t].size||1),0)}function _m(i,e,t,r){const n=(2+fn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++)s[0]=l.flatCoordss[c][0],s[1]=l.flatCoordss[c][1],xt(r,s),e[o++]=s[0],e[o++]=s[1],o+=Hs(e,t,l,o)}return e}function ym(i,e,t,r){const n=3*i.verticesCount+(1+fn(t))*i.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++){s.length=l.flatCoordss[c].length,Qa(l.flatCoordss[c],0,s.length,3,r,s,3),o+=Hs(e,t,l,o),e[o++]=s.length/3;for(let u=0,f=s.length;u<f;u+=3)e[o++]=s[u],e[o++]=s[u+1],e[o++]=s[u+2]}}return e}function Em(i,e,t,r){const n=2*i.verticesCount+(1+fn(t))*i.geometriesCount+i.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in i.entries){const l=i.entries[a];for(let c=0,h=l.flatCoordss.length;c<h;c++){s.length=l.flatCoordss[c].length,Qa(l.flatCoordss[c],0,s.length,2,r,s),o+=Hs(e,t,l,o),e[o++]=l.ringsVerticesCounts[c].length;for(let u=0,f=l.ringsVerticesCounts[c].length;u<f;u++)e[o++]=l.ringsVerticesCounts[c][u];for(let u=0,f=s.length;u<f;u+=2)e[o++]=s[u],e[o++]=s[u+1]}}return e}function $i(i){return(JSON.stringify(i).split("").reduce((t,r)=>(t<<5)-t+r.charCodeAt(0),0)>>>0).toString()}function Zs(i,e,t,r){if(`${r}radius`in i&&r!=="icon-"){let n=$(t,i[`${r}radius`],ie);if(`${r}radius2`in i){const s=$(t,i[`${r}radius2`],ie);n=`max(${n}, ${s})`}`${r}stroke-width`in i&&(n=`(${n} + ${$(t,i[`${r}stroke-width`],ie)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${r}scale`in i){const n=$(t,i[`${r}scale`],yr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${r}displacement`in i&&e.setSymbolOffsetExpression($(t,i[`${r}displacement`],Ot)),`${r}rotation`in i&&e.setSymbolRotationExpression($(t,i[`${r}rotation`],ie)),`${r}rotate-with-view`in i&&e.setSymbolRotateWithView(!!i[`${r}rotate-with-view`])}function tc(i,e,t,r,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&r!==null){const l=`smoothstep(-${r} + 0.63, -${r} - 0.58, ${i})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${i}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function Ys(i,e,t,r,n){const s=new Image;s.crossOrigin=i[`${r}cross-origin`]===void 0?"anonymous":i[`${r}cross-origin`],Je(typeof i[`${r}src`]=="string",`WebGL layers do not support expressions for the ${r}src style property`),s.src=i[`${r}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`vec2 u_texture${n}_size`);const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`sampler2D u_texture${n}`),o}function qs(i,e,t,r,n){let s=$(t,i[`${e}offset`],Ot);if(`${e}offset-origin`in i)switch(i[`${e}offset-origin`]){case"top-right":s=`vec2(${r}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${r}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${r} - ${n} - ${s}`;break}return s}function xm(i,e,t,r){r.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,Zs(i,e,r,"circle-");let n=null;"circle-opacity"in i&&(n=$(r,i["circle-opacity"],ie));let s="coordsPx";"circle-scale"in i&&(s=`coordsPx / ${$(r,i["circle-scale"],yr)}`);let o=null;"circle-fill-color"in i&&(o=$(r,i["circle-fill-color"],$e));let a=null;"circle-stroke-color"in i&&(a=$(r,i["circle-stroke-color"],$e));let l=$(r,i["circle-radius"],ie),c=null;"circle-stroke-width"in i&&(c=$(r,i["circle-stroke-width"],ie),l=`(${l} + ${c} * 0.5)`);const h=`circleDistanceField(${s}, ${l})`,u=tc(h,o,a,c,n);e.setSymbolColorExpression(u)}function bm(i,e,t,r){r.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,r.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,r.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,Zs(i,e,r,"shape-");let n=null;"shape-opacity"in i&&(n=$(r,i["shape-opacity"],ie));let s="coordsPx";"shape-scale"in i&&(s=`coordsPx / ${$(r,i["shape-scale"],yr)}`);let o=null;"shape-fill-color"in i&&(o=$(r,i["shape-fill-color"],$e));let a=null;"shape-stroke-color"in i&&(a=$(r,i["shape-stroke-color"],$e));let l=null;"shape-stroke-width"in i&&(l=$(r,i["shape-stroke-width"],ie));const c=$(r,i["shape-points"],ie);let h="0.";"shape-angle"in i&&(h=$(r,i["shape-angle"],ie));let u,f=$(r,i["shape-radius"],ie);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in i){let d=$(r,i["shape-radius2"],ie);l!==null&&(d=`${d} + ${l} * 0.5`),u=`starDistanceField(${s}, ${c}, ${f}, ${d}, ${h})`}else u=`regularDistanceField(${s}, ${c}, ${f}, ${h})`;const g=tc(u,o,a,l,n);e.setSymbolColorExpression(g)}function Tm(i,e,t,r){let n="vec4(1.0)";"icon-color"in i&&(n=$(r,i["icon-color"],$e)),"icon-opacity"in i&&(n=`${n} * vec4(1.0, 1.0, 1.0, ${$(r,i["icon-opacity"],ie)})`);const s=$i(i["icon-src"]),o=Ys(i,e,t,"icon-",s);if(e.setSymbolColorExpression(`${n} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in i&&"icon-height"in i&&e.setSymbolSizeExpression(`vec2(${$(r,i["icon-width"],ie)}, ${$(r,i["icon-height"],ie)})`),"icon-offset"in i&&"icon-size"in i){const a=$(r,i["icon-size"],Ot),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const c=qs(i,"icon-",r,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${c}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(Zs(i,e,r,"icon-"),"icon-anchor"in i){const a=$(r,i["icon-anchor"],Ot);let l="1.0";"icon-scale"in i&&(l=$(r,i["icon-scale"],yr));let c;i["icon-anchor-x-units"]==="pixels"&&i["icon-anchor-y-units"]==="pixels"?c=`${a} * ${l}`:i["icon-anchor-x-units"]==="pixels"?c=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:i["icon-anchor-y-units"]==="pixels"?c=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:c=`${a} * v_quadSizePx`;let h=`v_quadSizePx * vec2(0.5, -0.5) + ${c} * vec2(-1., 1.)`;if("icon-anchor-origin"in i)switch(i["icon-anchor-origin"]){case"top-right":h=`v_quadSizePx * -0.5 + ${c}`;break;case"bottom-left":h=`v_quadSizePx * 0.5 - ${c}`;break;case"bottom-right":h=`v_quadSizePx * vec2(-0.5, 0.5) + ${c} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${h}`)}}function wm(i,e,t,r){if("stroke-color"in i&&e.setStrokeColorExpression($(r,i["stroke-color"],$e)),"stroke-pattern-src"in i){const n=$i(i["stroke-pattern-src"]),s=Ys(i,e,t,"stroke-pattern-",n);let o=s,a="vec2(0.)";"stroke-pattern-offset"in i&&"stroke-pattern-size"in i&&(o=$(r,i["stroke-pattern-size"],Ot),a=qs(i,"stroke-pattern-",r,s,o));let l="0.";"stroke-pattern-spacing"in i&&(l=$(r,i["stroke-pattern-spacing"],ie)),r.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const c=`u_texture${n}`;let h="1.";"stroke-color"in i&&(h=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${h} * sampleStrokePattern(${c}, ${s}, ${a}, ${o}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in i&&e.setStrokeWidthExpression($(r,i["stroke-width"],ie)),"stroke-offset"in i&&e.setStrokeOffsetExpression($(r,i["stroke-offset"],ie)),"stroke-line-cap"in i&&e.setStrokeCapExpression($(r,i["stroke-line-cap"],Vr)),"stroke-line-join"in i&&e.setStrokeJoinExpression($(r,i["stroke-line-join"],Vr)),"stroke-miter-limit"in i&&e.setStrokeMiterLimitExpression($(r,i["stroke-miter-limit"],ie)),"stroke-line-dash"in i){r.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${pt("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${pt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let n=i["stroke-line-dash"].map(f=>$(r,f,ie));n.length%2===1&&(n=[...n,...n]);let s="0.";"stroke-line-dash-offset"in i&&(s=$(r,i["stroke-line-dash-offset"],ie));const a=`dashDistanceField_${$i(i["stroke-line-dash"])}`,l=n.map((f,g)=>`float dashLength${g} = ${f};`),c=n.map((f,g)=>`dashLength${g}`).join(" + ");let h="0.",u=`getSingleDashDistance(distance, radius, ${h}, dashLength0, totalDashLength, capType, lineWidth)`;for(let f=2;f<n.length;f+=2)h=`${h} + dashLength${f-2} + dashLength${f-1}`,u=`min(${u}, getSingleDashDistance(distance, radius, ${h}, dashLength${f}, totalDashLength, capType, lineWidth))`;r.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth) {
  ${l.join(`
  `)}
  float totalDashLength = ${c};
  return ${u};
}`,e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width)`)}}function Sm(i,e,t,r){if("fill-color"in i&&e.setFillColorExpression($(r,i["fill-color"],$e)),"fill-pattern-src"in i){const n=$i(i["fill-pattern-src"]),s=Ys(i,e,t,"fill-pattern-",n);let o=s,a="vec2(0.)";"fill-pattern-offset"in i&&"fill-pattern-size"in i&&(o=$(r,i["fill-pattern-size"],Ot),a=qs(i,"fill-pattern-",r,s,o)),r.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${n}`;let c="1.";"fill-color"in i&&(c=e.getFillColorExpression()),e.setFillColorExpression(`${c} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function rc(i,e,t){const r=Vs(),n=new Zl,s={};if("icon-src"in i?Tm(i,n,s,r):"shape-points"in i?bm(i,n,s,r):"circle-radius"in i&&xm(i,n,s,r),wm(i,n,s,r),Sm(i,n,s,r),t){const l=$(r,t,rn);n.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,c,h,u){if(!r[l])return;const f=Kn(h),g=Ws(h);n.addAttribute(`a_${c}`,f),o[c]={size:g,callback:u}}return a("geometryType",Hl,Vr,l=>dr(ul(l.getGeometry()))),a("featureId",Wl,Vr|ie,l=>{const c=l.getId()??null;return typeof c=="string"?dr(c):c}),Yl(n,r),{builder:n,attributes:{...o,...Kl(r)},uniforms:{...s,...ql(r,e)}}}function Rm(i){const e=Array.isArray(i)?i:[i];if("style"in e[0]){const t=[],r=e,n=[];for(const s of r){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&n.length&&(a=["all",...n.map(c=>["!",c])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&n.push(s.filter);const l=o.map(c=>({style:c,...a&&{filter:a}}));t.push(...l)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const vm=[];let vn;function Pm(){return vn||(vn=Jl()),vn}let Am=0;const st={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class Lm{constructor(e,t,r,n,s){this.helper_,this.hitDetectionEnabled_=!!n;let o=e;if(!("builder"in e)){const h=e,u=rc(h.style,t,h.filter);o={builder:u.builder,attributes:u.attributes,uniforms:u.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const l=this.hitDetectionEnabled_?{hitColor:{callback(){return Ql(this.ref,vm)},size:4}}:{};this.customAttributes_=Object.assign({},l,o.attributes),this.uniforms_=o.uniforms;const c=Object.entries(this.customAttributes_).map(([h,u])=>({name:`a_${h}`,size:u.size||1,type:xe.FLOAT}));this.polygonAttributesDesc_=[{name:st.POSITION,size:2,type:xe.FLOAT},...c],this.lineStringAttributesDesc_=[{name:st.SEGMENT_START,size:2,type:xe.FLOAT},{name:st.MEASURE_START,size:1,type:xe.FLOAT},{name:st.SEGMENT_END,size:2,type:xe.FLOAT},{name:st.MEASURE_END,size:1,type:xe.FLOAT},{name:st.JOIN_ANGLES,size:2,type:xe.FLOAT},{name:st.DISTANCE,size:1,type:xe.FLOAT},{name:st.PARAMETERS,size:1,type:xe.FLOAT},...c],this.pointAttributesDesc_=[{name:st.POSITION,size:2,type:xe.FLOAT},{name:st.INDEX,size:1,type:xe.FLOAT},...c],this.setHelper(r)}computeFeatureFilter(e){const t=cl();let r;try{r=uh(e,rn,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const n=hh();return s=>{if(n.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?n.featureId=o:n.featureId=null}return n.geometryType=ul(s.getGeometry()),r(n)}}async generateBuffers(e,t){let r=e;if(this.featureFilter_&&(r=r.filter(this.featureFilter_),r.isEmpty()))return null;const n=this.generateRenderInstructions_(r,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(n.polygonInstructions,"Polygon",t),this.generateBuffersForType_(n.lineStringInstructions,"LineString",t),this.generateBuffersForType_(n.pointInstructions,"Point",t)]),l=zr(Ie(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:l}}generateRenderInstructions_(e,t){const r=this.hasFill_?Em(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?ym(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?_m(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:r,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,r){if(e===null)return null;const n=Am++;let s;switch(t){case"Polygon":s=Or.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Or.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Or.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:r,customAttributesSize:fn(this.customAttributes_)},a=Pm();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const c=h=>{const u=h.data;if(u.id!==n||(a.removeEventListener("message",c),!this.helper_.getGL()))return;const f=new fr(Qr,Bi).fromArrayBuffer(u.vertexBuffer),g=new fr(ei,Bi).fromArrayBuffer(u.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(g),l([g,f])};a.addEventListener("message",c)})}render(e,t,r){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,r),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,r),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,r)}renderInternal_(e,t,r,n,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(r,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const ot=new Uint8Array(4);class ic{constructor(e,t){this.helper_=e;const r=e.getGL();this.texture_=r.createTexture(),this.framebuffer_=r.createFramebuffer(),this.depthbuffer_=r.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){ku(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return ot[0]=0,ot[1]=0,ot[2]=0,ot[3]=0,ot;this.readAll();const r=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return ot[0]=this.data_[r*4],ot[1]=this.data_[r*4+1],ot[2]=this.data_[r*4+2],ot[3]=this.data_[r*4+3],ot}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function nc(i,e){const t=i.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=i.extent,a=n?Ce(s):null,l=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,l,a]}const Qt={...ut,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class sc extends ti{constructor(e,t){const r={[Qt.RENDER_EXTENT]:[0,0,0,0],[Qt.PATTERN_ORIGIN]:[0,0],[Qt.GLOBAL_ALPHA]:1};super(e,{uniforms:r,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=Yr(),this.currentTransform_=Ie(),this.tmpCoords_=[0,0],this.tmpTransform_=Ie(),this.tmpMat4_=Yt(),this.currentFrameStateTransform_=Ie(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new zi,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let r;this.batch_.addFeatures(t.getFeatures(),r),this.sourceListenKeys_=[mt(t,At.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,r)),mt(t,At.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),mt(t,At.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mt(t,At.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=Rm(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new Lm(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ic(this.helper))}handleSourceFeatureAdded_(e,t){const r=t.feature;this.batch_.addFeature(r,e)}handleSourceFeatureChanged_(e){const t=e.feature;this.batch_.changeFeature(t)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){Au(this.tmpTransform_,this.currentFrameStateTransform_),Gr(this.tmpTransform_,e),this.helper.setUniformMatrixValue(Qt.PROJECTION_MATRIX,Ui(this.tmpMat4_,this.tmpTransform_)),zr(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(Qt.SCREEN_TO_WORLD_MATRIX,Ui(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,zr(this.tmpTransform_,e),xt(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(Qt.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=nc(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Mt.ANIMATING]&&!e.viewHints[Mt.INTERACTING],o=!kr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,h=t instanceof nn?t.getRenderBuffer():0,u=_s(e.extent,h*c);r.loadFeatures(u,c,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Ie()),g=this.styleRenderers_.map((d,p)=>d.generateBuffers(this.batch_,f).then(m=>{this.buffers_[p]&&this.disposeBuffers(this.buffers_[p]),this.buffers_[p]=m}));Promise.all(g).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,r,n,s){let o=r;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),ds(this.currentFrameStateTransform_,o*s,0);for(let a=0,l=this.styleRenderers_.length;a<l;a++){const c=this.styleRenderers_[a],h=this.buffers_[a];h&&c.render(h,e,()=>{this.applyUniforms_(h.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<n)}forEachFeatureAtCoordinate(e,t,r,n,s){if(Je(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=xt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=ec(l),h=this.batch_.getFeatureFromRef(c);if(h)return n(h,this.getLayer(),null)}disposeBuffers(e){const t=r=>{for(const n of r)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){vi(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const gt={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},Im=["#00f","#0ff","#0f0","#ff0","#f00"];class Cm extends nn{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(gt.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:Im),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const r=e.weight?e.weight:"weight";this.weight_=r,this.setRenderOrder(null)}getBlur(){return this.get(gt.BLUR)}getGradient(){return this.get(gt.GRADIENT)}getRadius(){return this.get(gt.RADIUS)}handleGradientChanged_(){this.gradient_=Fm(this.getGradient())}setBlur(e){const t=this.get(gt.BLUR);if(this.set(gt.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(gt.GRADIENT,e)}setRadius(e){const t=this.get(gt.RADIUS);if(this.set(gt.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new Zl,t=Vs(),r=$(t,this.filter_,rn);let n=$(t,this.getRadius(),ie),s=$(t,this.getBlur(),ie);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("float a_blur")),typeof this.getRadius()=="number"&&(n="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("float a_radius"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const u=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const g=u(f);return g!==void 0?ye(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const u=["clamp",this.weight_,0,1];l=$(t,u,ie)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${n};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${n} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${n} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${r}`),Yl(e,t);const c=Kl(t),h=ql(t,this.styleVariables_);return new sc(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...c,...a},uniforms:{...h,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function Fm(i){const r=Ft(1,256),n=r.createLinearGradient(0,0,1,256),s=1/(i.length-1);for(let o=0,a=i.length;o<a;++o)n.addColorStop(o*s,i[o]);return r.fillStyle=n,r.fillRect(0,0,1,256),r.canvas}class Ks extends hl{constructor(e,t,r,n,s){const o=s!==void 0?kt.IDLE:kt.LOADED;super(e,t,r,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=kt.ERROR):this.state=kt.LOADED,this.changed()}load(){this.state==kt.IDLE&&(this.state=kt.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class Om extends fh{constructor(e){super(e),this.vectorRenderer_=new dh(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Ie(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=xt(this.coordinateToVectorPixelTransform_,xt(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const t=e.pixelRatio,r=e.viewState,n=r.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),il(a,this.layerImageRatio_));const l=Ce(a)/n,c=rt(a)/n;if(!s[Mt.ANIMATING]&&!s[Mt.INTERACTING]&&!Ji(a)){o.useContainer(null,null);const h=o.context,u=e.layerStatesArray[e.layerIndex],f=Object.assign({},u,{opacity:1}),g=Object.assign({},e,{extent:a,size:[l,c],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[f],layerIndex:0,declutter:null}),d=this.getLayer().getDeclutter();d&&(g.declutter={[d]:new gh(9)});const p=new Ks(a,n,t,h.canvas,function(m){o.prepareFrame(g)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(g,null),o.renderDeclutter(g),o.renderDeferred(g),m())});p.addEventListener(Be.CHANGE,()=>{if(p.getState()!==kt.LOADED)return;this.image=p;const m=p.getPixelRatio(),y=ph(p.getResolution())*t/m;this.renderedResolution=y,this.coordinateToVectorPixelTransform_=fs(this.coordinateToVectorPixelTransform_,l/2,c/2,1/y,-1/y,0,-r.center[0],-r.center[1])}),p.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!this.getLayer().getSource().loading&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,r,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,r,n,s):super.forEachFeatureAtCoordinate(e,t,r,n,s)}}class Mm extends nn{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new Om(this)}}class Nm extends ti{constructor(e,t){const r=t.uniforms||{},n=Ie();r[ut.PROJECTION_MATRIX]=n,super(e,{uniforms:r,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new fr(Qr,Bi),this.indicesBuffer_=new fr(ei,Bi),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:xe.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:xe.FLOAT},{name:"a_index",size:1,type:xe.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:xe.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:xe.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=Yr(),this.currentTransform_=n,this.renderTransform_=Ie(),this.invertRenderTransform_=Ie(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=Jl(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===Or.GENERATE_POINT_BUFFERS){const c=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=c,zr(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[mt(o,At.ADDFEATURE,this.handleSourceFeatureAdded_,this),mt(o,At.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),mt(o,At.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),mt(o,At.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[ce(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new ic(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,r=t.getGeometry();r&&r.getType()==="Point"&&(this.featureCache_[ce(t)]={feature:t,properties:t.getProperties(),flatCoordinates:r.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,r=ce(t),n=this.featureCache_[r],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[r],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[r]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,r=ce(t);r in this.featureCache_&&(delete this.featureCache_[r],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[r,n,s]=nc(e,this.getLayer());return this.renderWorlds(e,!1,r,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,r,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),r=t.getSource(),n=e.viewState,s=!e.viewHints[Mt.ANIMATING]&&!e.viewHints[Mt.INTERACTING],o=!kr(this.previousExtent_,e.extent),a=this.sourceRevision_<r.getRevision();if(a&&(this.sourceRevision_=r.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,h=t instanceof nn?t.getRenderBuffer():0,u=_s(e.extent,h*c);r.loadFeatures(u,c,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=Ie();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let c=-1;e.viewState.projection;for(const u in this.featureCache_){const f=this.featureCache_[u];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],xt(t,a),o[++c]=a[0],o[++c]=a[1],this.hitDetectionEnabled_){const g=Ql(c+5,l);o[++c]=g[0],o[++c]=g[1],o[++c]=g[2],o[++c]=g[3],o[++c]=Number(u)}for(let g=0;g<this.customAttributes.length;g++){const d=this.customAttributes[g].callback(f.feature,f.properties);o[++c]=d}}const h={id:++this.lastSentId,type:Or.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};h.projectionTransform=t,this.ready=!1,this.worker_.postMessage(h,[o.buffer])}forEachFeatureAtCoordinate(e,t,r,n,s){if(Je(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=xt(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=ec(l),h=this.renderInstructions_[c],u=Math.floor(h).toString(),g=this.getLayer().getSource().getFeatureByUid(u);if(g)return n(g,this.getLayer(),null)}renderWorlds(e,t,r,n,s){let o=r;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),ds(this.currentTransform_,o*s,0),Gr(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){vi(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class Dm extends bs{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=rc(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new Nm(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function Ta(i,e){const t=`
    attribute vec2 ${bi.TEXTURE_COORD};
    uniform mat4 ${V.TILE_TRANSFORM};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.TEXTURE_RESOLUTION};
    uniform float ${V.TEXTURE_ORIGIN_X};
    uniform float ${V.TEXTURE_ORIGIN_Y};
    uniform float ${V.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${bi.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${V.TEXTURE_ORIGIN_X} + ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${V.TEXTURE_ORIGIN_Y} - ${V.TEXTURE_RESOLUTION} * ${V.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${V.TILE_TRANSFORM} * vec4(${bi.TEXTURE_COORD}, ${V.DEPTH}, 1.0);
    }
  `,r={...Vs(),bandCount:e},n=[];if(i.color!==void 0){const u=$(r,i.color,$e);n.push(`color = ${u};`)}if(i.contrast!==void 0){const u=$(r,i.contrast,ie);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb - (${u} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.exposure!==void 0){const u=$(r,i.exposure,ie);n.push(`color.rgb = clamp((${u} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(i.saturation!==void 0){const u=$(r,i.saturation,ie);n.push(`
      float saturation = ${u} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(i.gamma!==void 0){const u=$(r,i.gamma,ie);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${u}));`)}if(i.brightness!==void 0){const u=$(r,i.brightness,ie);n.push(`color.rgb = clamp(color.rgb + ${u}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(r.variables).length;if(o>1&&!i.variables)throw new Error(`Missing variables in style (expected ${r.variables})`);for(let u=0;u<o;++u){const f=r.variables[Object.keys(r.variables)[u]];if(!(f.name in i.variables))throw new Error(`Missing '${f.name}' in style variables`);const g=hn(f.name);s[g]=function(){let d=i.variables[f.name];return typeof d=="string"&&(d=dr(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(u){return`uniform float ${u};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${V.TILE_TEXTURE_ARRAY}[${l}];`),r.paletteTextures&&a.push(`uniform sampler2D ${Xl}[${r.paletteTextures.length}];`);const c=Object.keys(r.functions).map(function(u){return r.functions[u]}),h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${V.RENDER_EXTENT};
    uniform float ${V.TRANSITION_ALPHA};
    uniform float ${V.TEXTURE_PIXEL_WIDTH};
    uniform float ${V.TEXTURE_PIXEL_HEIGHT};
    uniform float ${V.RESOLUTION};
    uniform float ${V.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${V.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${V.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${V.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${V.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${V.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${V.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:h,uniforms:s,paletteTextures:r.paletteTextures}}class ki extends mh{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(Xn.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const r=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:r?[r]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=Ta(this.style_,this.getSourceBandCount_());return new sm(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const r=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],r.prepareFrame(e)&&(n=r.renderFrame(e));return n}render(e,t){this.rendered=!0;const r=e.viewState,n=this.getSources(e.extent,r.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const c=n[a],h=c.getState();if(h=="loading"){const u=()=>{c.getState()=="ready"&&(c.removeEventListener("change",u),this.changed())};c.addEventListener("change",u)}s=s&&h=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=r.resolution,o;if(this.renderedResolution_>.5*r.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=Ta(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}ki.prototype.dispose;class Um extends bs{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new sc(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}var Ve=Uint8Array,or=Uint16Array,Bm=Int32Array,oc=new Ve([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),ac=new Ve([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Gm=new Ve([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),lc=function(i,e){for(var t=new or(31),r=0;r<31;++r)t[r]=e+=1<<i[r-1];for(var n=new Bm(t[30]),r=1;r<30;++r)for(var s=t[r];s<t[r+1];++s)n[s]=s-t[r]<<5|r;return{b:t,r:n}},cc=lc(oc,2),uc=cc.b,zm=cc.r;uc[28]=258,zm[258]=28;var $m=lc(ac,0),km=$m.b,Jn=new or(32768);for(var me=0;me<32768;++me){var St=(me&43690)>>1|(me&21845)<<1;St=(St&52428)>>2|(St&13107)<<2,St=(St&61680)>>4|(St&3855)<<4,Jn[me]=((St&65280)>>8|(St&255)<<8)>>1}var Mr=function(i,e,t){for(var r=i.length,n=0,s=new or(e);n<r;++n)i[n]&&++s[i[n]-1];var o=new or(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;if(t){a=new or(1<<e);var l=15-e;for(n=0;n<r;++n)if(i[n])for(var c=n<<4|i[n],h=e-i[n],u=o[i[n]-1]++<<h,f=u|(1<<h)-1;u<=f;++u)a[Jn[u]>>l]=c}else for(a=new or(r),n=0;n<r;++n)i[n]&&(a[n]=Jn[o[i[n]-1]++]>>15-i[n]);return a},ri=new Ve(288);for(var me=0;me<144;++me)ri[me]=8;for(var me=144;me<256;++me)ri[me]=9;for(var me=256;me<280;++me)ri[me]=7;for(var me=280;me<288;++me)ri[me]=8;var hc=new Ve(32);for(var me=0;me<32;++me)hc[me]=5;var jm=Mr(ri,9,1),Vm=Mr(hc,5,1),Pn=function(i){for(var e=i[0],t=1;t<i.length;++t)i[t]>e&&(e=i[t]);return e},Qe=function(i,e,t){var r=e/8|0;return(i[r]|i[r+1]<<8)>>(e&7)&t},An=function(i,e){var t=e/8|0;return(i[t]|i[t+1]<<8|i[t+2]<<16)>>(e&7)},Xm=function(i){return(i+7)/8|0},Wm=function(i,e,t){return(t==null||t>i.length)&&(t=i.length),new Ve(i.subarray(e,t))},Hm=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],je=function(i,e,t){var r=new Error(e||Hm[i]);if(r.code=i,Error.captureStackTrace&&Error.captureStackTrace(r,je),!t)throw r;return r},Js=function(i,e,t,r){var n=i.length,s=0;if(!n||e.f&&!e.l)return t||new Ve(0);var o=!t,a=o||e.i!=2,l=e.i;o&&(t=new Ve(n*3));var c=function(ai){var li=t.length;if(ai>li){var ci=new Ve(Math.max(li*2,ai));ci.set(t),t=ci}},h=e.f||0,u=e.p||0,f=e.b||0,g=e.l,d=e.d,p=e.m,m=e.n,y=n*8;do{if(!g){h=Qe(i,u,1);var _=Qe(i,u+1,3);if(u+=3,_)if(_==1)g=jm,d=Vm,p=9,m=5;else if(_==2){var T=Qe(i,u,31)+257,v=Qe(i,u+10,15)+4,I=T+Qe(i,u+5,31)+1;u+=14;for(var A=new Ve(I),R=new Ve(19),M=0;M<v;++M)R[Gm[M]]=Qe(i,u+M*3,7);u+=v*3;for(var N=Pn(R),k=(1<<N)-1,j=Mr(R,N,1),M=0;M<I;){var B=j[Qe(i,u,k)];u+=B&15;var E=B>>4;if(E<16)A[M++]=E;else{var ee=0,G=0;for(E==16?(G=3+Qe(i,u,3),u+=2,ee=A[M-1]):E==17?(G=3+Qe(i,u,7),u+=3):E==18&&(G=11+Qe(i,u,127),u+=7);G--;)A[M++]=ee}}var ae=A.subarray(0,T),H=A.subarray(T);p=Pn(ae),m=Pn(H),g=Mr(ae,p,1),d=Mr(H,m,1)}else je(1);else{var E=Xm(u)+4,w=i[E-4]|i[E-3]<<8,S=E+w;if(S>n){l&&je(0);break}a&&c(f+w),t.set(i.subarray(E,S),f),e.b=f+=w,e.p=u=S*8,e.f=h;continue}if(u>y){l&&je(0);break}}a&&c(f+131072);for(var ne=(1<<p)-1,ge=(1<<m)-1,be=u;;be=u){var ee=g[An(i,u)&ne],re=ee>>4;if(u+=ee&15,u>y){l&&je(0);break}if(ee||je(2),re<256)t[f++]=re;else if(re==256){be=u,g=null;break}else{var ve=re-254;if(re>264){var M=re-257,Se=oc[M];ve=Qe(i,u,(1<<Se)-1)+uc[M],u+=Se}var Re=d[An(i,u)&ge],Oe=Re>>4;Re||je(3),u+=Re&15;var H=km[Oe];if(Oe>3){var Se=ac[Oe];H+=An(i,u)&(1<<Se)-1,u+=Se}if(u>y){l&&je(0);break}a&&c(f+131072);var qt=f+ve;if(f<H){var Bt=s-H,wt=Math.min(H,qt);for(Bt+f<0&&je(3);f<wt;++f)t[f]=r[Bt+f]}for(;f<qt;++f)t[f]=t[f-H]}}e.l=g,e.p=be,e.b=f,e.f=h,g&&(h=1,e.m=p,e.d=d,e.n=m)}while(!h);return f!=t.length&&o?Wm(t,0,f):t.subarray(0,f)},Zm=new Ve(0),Ym=function(i){(i[0]!=31||i[1]!=139||i[2]!=8)&&je(6,"invalid gzip data");var e=i[3],t=10;e&4&&(t+=(i[10]|i[11]<<8)+2);for(var r=(e>>3&1)+(e>>4&1);r>0;r-=!i[t++]);return t+(e&2)},qm=function(i){var e=i.length;return(i[e-4]|i[e-3]<<8|i[e-2]<<16|i[e-1]<<24)>>>0},Km=function(i,e){return((i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31)&&je(6,"invalid zlib data"),(i[1]>>5&1)==1&&je(6,"invalid zlib data: "+(i[1]&32?"need":"unexpected")+" dictionary"),(i[1]>>3&4)+2};function Jm(i,e){return Js(i,{i:2},e,e)}function Qm(i,e){var t=Ym(i);return t+8>i.length&&je(6,"invalid gzip data"),Js(i.subarray(t,-8),{i:2},new Ve(qm(i)),e)}function e_(i,e){return Js(i.subarray(Km(i),-4),{i:2},e,e)}function t_(i,e){return i[0]==31&&i[1]==139&&i[2]==8?Qm(i,e):(i[0]&15)!=8||i[0]>>4>7||(i[0]<<8|i[1])%31?Jm(i,e):e_(i,e)}var r_=typeof TextDecoder<"u"&&new TextDecoder,i_=0;try{r_.decode(Zm,{stream:!0}),i_=1}catch{}var n_=Object.defineProperty,Nr=Math.pow,de=(i,e)=>n_(i,"name",{value:e,configurable:!0}),Ae=(i,e,t)=>new Promise((r,n)=>{var s=l=>{try{a(t.next(l))}catch(c){n(c)}},o=l=>{try{a(t.throw(l))}catch(c){n(c)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(i,e)).next())});de((i,e)=>{let t=!1,r="",n=L.GridLayer.extend({createTile:de((s,o)=>{let a=document.createElement("img"),l=new AbortController,c=l.signal;return a.cancel=()=>{l.abort()},t||(i.getHeader().then(h=>{h.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):h.tileType===2?r="image/png":h.tileType===3?r="image/jpeg":h.tileType===4?r="image/webp":h.tileType===5&&(r="image/avif")}),t=!0),i.getZxy(s.z,s.x,s.y,c).then(h=>{if(h){let u=new Blob([h.data],{type:r}),f=window.URL.createObjectURL(u);a.src=f,a.cancel=void 0,o(void 0,a)}}).catch(h=>{if(h.name!=="AbortError")throw h}),a},"createTile"),_removeTile:de(function(s){let o=this._tiles[s];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[s],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(s)}))},"_removeTile")});return new n(e)},"leafletRasterLayer");var s_=de(i=>(e,t)=>{if(t instanceof AbortController)return i(e,t);let r=new AbortController;return i(e,r).then(n=>t(void 0,n.data,n.cacheControl||"",n.expires||""),n=>t(n)).catch(n=>t(n)),{cancel:de(()=>r.abort(),"cancel")}},"v3compat"),o_=class{constructor(e){this.tilev4=de((t,r)=>Ae(this,null,function*(){if(t.type==="json"){let g=t.url.substr(10),d=this.tiles.get(g);if(d||(d=new Xr(g),this.tiles.set(g,d)),this.metadata)return{data:yield d.getTileJson(t.url)};let p=yield d.getHeader();return(p.minLon>=p.maxLon||p.minLat>=p.maxLat)&&console.error(`Bounds of PMTiles archive ${p.minLon},${p.minLat},${p.maxLon},${p.maxLat} are not valid.`),{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:p.minZoom,maxzoom:p.maxZoom,bounds:[p.minLon,p.minLat,p.maxLon,p.maxLat]}}}let n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=t.url.match(n);if(!s)throw new Error("Invalid PMTiles protocol URL");let o=s[1],a=this.tiles.get(o);a||(a=new Xr(o),this.tiles.set(o,a));let l=s[2],c=s[3],h=s[4],u=yield a.getHeader(),f=yield a==null?void 0:a.getZxy(+l,+c,+h,r.signal);if(f)return{data:new Uint8Array(f.data),cacheControl:f.cacheControl,expires:f.expires};if(u.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=s_(this.tilev4),this.tiles=new Map,this.metadata=(e==null?void 0:e.metadata)||!1,this.errorOnMissingTile=(e==null?void 0:e.errorOnMissingTile)||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};de(o_,"Protocol");function fc(i,e){return(e>>>0)*4294967296+(i>>>0)}de(fc,"toNum");function dc(i,e){let t=e.buf,r=t[e.pos++],n=(r&112)>>4;if(r<128||(r=t[e.pos++],n|=(r&127)<<3,r<128)||(r=t[e.pos++],n|=(r&127)<<10,r<128)||(r=t[e.pos++],n|=(r&127)<<17,r<128)||(r=t[e.pos++],n|=(r&127)<<24,r<128)||(r=t[e.pos++],n|=(r&1)<<31,r<128))return fc(i,n);throw new Error("Expected varint not more than 10 bytes")}de(dc,"readVarintRemainder");function ir(i){let e=i.buf,t=e[i.pos++],r=t&127;return t<128||(t=e[i.pos++],r|=(t&127)<<7,t<128)||(t=e[i.pos++],r|=(t&127)<<14,t<128)||(t=e[i.pos++],r|=(t&127)<<21,t<128)?r:(t=e[i.pos],r|=(t&15)<<28,dc(r,i))}de(ir,"readVarint");function Qs(i,e,t,r){if(r===0){t===1&&(e[0]=i-1-e[0],e[1]=i-1-e[1]);let n=e[0];e[0]=e[1],e[1]=n}}de(Qs,"rotate");function gc(i,e){let t=Nr(2,i),r=e,n=e,s=e,o=[0,0],a=1;for(;a<t;)r=1&s/2,n=1&(s^r),Qs(a,o,r,n),o[0]+=a*r,o[1]+=a*n,s=s/4,a*=2;return[i,o[0],o[1]]}de(gc,"idOnLevel");var a_=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function pc(i,e,t){if(i>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(e>Nr(2,i)-1||t>Nr(2,i)-1)throw new Error("tile x/y outside zoom level bounds");let r=a_[i],n=Nr(2,i),s=0,o=0,a=0,l=[e,t],c=n/2;for(;c>0;)s=(l[0]&c)>0?1:0,o=(l[1]&c)>0?1:0,a+=c*c*(3*s^o),Qs(c,l,s,o),c=c/2;return r+a}de(pc,"zxyToTileId");function l_(i){let e=0;for(let t=0;t<27;t++){let r=(1<<t)*(1<<t);if(e+r>i)return gc(t,i-e);e+=r}throw new Error("Tile zoom level exceeds max safe number limit (26)")}de(l_,"tileIdToZxy");var c_=(i=>(i[i.Unknown=0]="Unknown",i[i.None=1]="None",i[i.Gzip=2]="Gzip",i[i.Brotli=3]="Brotli",i[i.Zstd=4]="Zstd",i))(c_||{});function dn(i,e){return Ae(this,null,function*(){if(e===1||e===0)return i;if(e===2){if(typeof globalThis.DecompressionStream>"u")return t_(new Uint8Array(i));let t=new Response(i).body;if(!t)throw new Error("Failed to read response stream");let r=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(r).arrayBuffer()}throw new Error("Compression method not supported")})}de(dn,"defaultDecompress");var nr=(i=>(i[i.Unknown=0]="Unknown",i[i.Mvt=1]="Mvt",i[i.Png=2]="Png",i[i.Jpeg=3]="Jpeg",i[i.Webp=4]="Webp",i[i.Avif=5]="Avif",i))(nr||{});function mc(i){return i===1?".mvt":i===2?".png":i===3?".jpg":i===4?".webp":i===5?".avif":""}de(mc,"tileTypeExt");var u_=127;function _c(i,e){let t=0,r=i.length-1;for(;t<=r;){let n=r+t>>1,s=e-i[n].tileId;if(s>0)t=n+1;else if(s<0)r=n-1;else return i[n]}return r>=0&&(i[r].runLength===0||e-i[r].tileId<i[r].runLength)?i[r]:null}de(_c,"findTile");var h_=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return Ae(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}};de(h_,"FileSource");var yc=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let n=r.indexOf("Windows")>-1,s=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,n&&s&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,n){return Ae(this,null,function*(){let s,o;r?o=r:(s=new AbortController,o=s.signal);let a=new Headers(this.customHeaders);a.set("range",`bytes=${e}-${e+t-1}`);let l;this.mustReload?l="reload":this.chromeWindowsNoCache&&(l="no-store");let c=yield fetch(this.url,{signal:o,cache:l,headers:a});if(e===0&&c.status===416){let f=c.headers.get("Content-Range");if(!f||!f.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let g=+f.substr(8);c=yield fetch(this.url,{signal:o,cache:"reload",headers:{range:`bytes=0-${g-1}`}})}let h=c.headers.get("Etag");if(h!=null&&h.startsWith("W/")&&(h=null),c.status===416||n&&h&&h!==n)throw this.mustReload=!0,new Qn(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(c.status>=300)throw new Error(`Bad response code: ${c.status}`);let u=c.headers.get("Content-Length");if(c.status===200&&(!u||+u>t))throw s&&s.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield c.arrayBuffer(),etag:h||void 0,cacheControl:c.headers.get("Cache-Control")||void 0,expires:c.headers.get("Expires")||void 0}})}};de(yc,"FetchSource");var f_=yc;function Ze(i,e){let t=i.getUint32(e+4,!0),r=i.getUint32(e+0,!0);return t*Nr(2,32)+r}de(Ze,"getUint64");function Ec(i,e){let t=new DataView(i),r=t.getUint8(7);if(r>3)throw new Error(`Archive is spec version ${r} but this library supports up to spec version 3`);return{specVersion:r,rootDirectoryOffset:Ze(t,8),rootDirectoryLength:Ze(t,16),jsonMetadataOffset:Ze(t,24),jsonMetadataLength:Ze(t,32),leafDirectoryOffset:Ze(t,40),leafDirectoryLength:Ze(t,48),tileDataOffset:Ze(t,56),tileDataLength:Ze(t,64),numAddressedTiles:Ze(t,72),numTileEntries:Ze(t,80),numTileContents:Ze(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}de(Ec,"bytesToHeader");function eo(i){let e={buf:new Uint8Array(i),pos:0},t=ir(e),r=[],n=0;for(let s=0;s<t;s++){let o=ir(e);r.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)r[s].runLength=ir(e);for(let s=0;s<t;s++)r[s].length=ir(e);for(let s=0;s<t;s++){let o=ir(e);o===0&&s>0?r[s].offset=r[s-1].offset+r[s-1].length:r[s].offset=o-1}return r}de(eo,"deserializeIndex");var xc=class extends Error{};de(xc,"EtagMismatch");var Qn=xc;function to(i,e){return Ae(this,null,function*(){let t=yield i.getBytes(0,16384);if(new DataView(t.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let r=t.data.slice(0,u_),n=Ec(r,t.etag),s=t.data.slice(n.rootDirectoryOffset,n.rootDirectoryOffset+n.rootDirectoryLength),o=`${i.getKey()}|${n.etag||""}|${n.rootDirectoryOffset}|${n.rootDirectoryLength}`,a=eo(yield e(s,n.internalCompression));return[n,[o,a.length,a]]})}de(to,"getHeaderAndRoot");function ro(i,e,t,r,n){return Ae(this,null,function*(){let s=yield i.getBytes(t,r,void 0,n.etag),o=yield e(s.data,n.internalCompression),a=eo(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}de(ro,"getDirectory");var d_=class{constructor(e=100,t=!0,r=dn){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Ae(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let n=yield to(e,this.decompress);return n[1]&&this.cache.set(n[1][0],{lastUsed:this.counter++,data:n[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:n[0]}),this.prune(),n[0]})}getDirectory(e,t,r,n){return Ae(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,o.data;let a=yield ro(e,this.decompress,t,r,n);return this.cache.set(s,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return Ae(this,null,function*(){this.cache.delete(e.getKey())})}};de(d_,"ResolvedValueCache");var bc=class{constructor(e=100,t=!0,r=dn){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return Ae(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let n=new Promise((s,o)=>{to(e,this.decompress).then(a=>{a[1]&&this.cache.set(a[1][0],{lastUsed:this.counter++,data:Promise.resolve(a[1][2])}),s(a[0]),this.prune()}).catch(a=>{o(a)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,r,n){return Ae(this,null,function*(){let s=`${e.getKey()}|${n.etag||""}|${t}|${r}`,o=this.cache.get(s);if(o)return o.lastUsed=this.counter++,yield o.data;let a=new Promise((l,c)=>{ro(e,this.decompress,t,r,n).then(h=>{l(h),this.prune()}).catch(h=>{c(h)})});return this.cache.set(s,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return Ae(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((n,s)=>{this.getHeader(e).then(o=>{n(),this.invalidations.delete(t)}).catch(o=>{s(o)})});this.invalidations.set(t,r)})}};de(bc,"SharedPromiseCache");var g_=bc,Tc=class{constructor(e,t,r){typeof e=="string"?this.source=new f_(e):this.source=e,r?this.decompress=r:this.decompress=dn,t?this.cache=t:this.cache=new g_}getHeader(){return Ae(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,n){return Ae(this,null,function*(){let s=pc(e,t,r),o=yield this.cache.getHeader(this.source);if(e<o.minZoom||e>o.maxZoom)return;let a=o.rootDirectoryOffset,l=o.rootDirectoryLength;for(let c=0;c<=3;c++){let h=yield this.cache.getDirectory(this.source,a,l,o),u=_c(h,s);if(u){if(u.runLength>0){let f=yield this.source.getBytes(o.tileDataOffset+u.offset,u.length,n,o.etag);return{data:yield this.decompress(f.data,o.tileCompression),cacheControl:f.cacheControl,expires:f.expires}}a=o.leafDirectoryOffset+u.offset,l=u.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,r,n){return Ae(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,n)}catch(s){if(s instanceof Qn)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,n);throw s}})}getMetadataAttempt(){return Ae(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return Ae(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof Qn)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return Ae(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),n=mc(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};de(Tc,"PMTiles");var Xr=Tc;class p_ extends nl{constructor(e){super(Be.ERROR),this.error=e}}function Fe(i){return(e,...t)=>m_(i,e,t)}function Rr(i,e){return Fe(wc(i,e).get)}const{apply:m_,getOwnPropertyDescriptor:wc,getPrototypeOf:io,ownKeys:__}=Reflect,{iterator:ii,toStringTag:y_}=Symbol,E_=Object,{create:no,defineProperty:x_}=E_,b_=Array,T_=b_.prototype,Sc=T_[ii],w_=Fe(Sc),Rc=ArrayBuffer,S_=Rc.prototype;Rr(S_,"byteLength");const wa=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;wa&&Rr(wa.prototype,"byteLength");const vc=io(Uint8Array);vc.from;const Ge=vc.prototype;Ge[ii];Fe(Ge.keys);Fe(Ge.values);Fe(Ge.entries);Fe(Ge.set);Fe(Ge.reverse);Fe(Ge.fill);Fe(Ge.copyWithin);Fe(Ge.sort);Fe(Ge.slice);Fe(Ge.subarray);Rr(Ge,"buffer");Rr(Ge,"byteOffset");Rr(Ge,"length");Rr(Ge,y_);const R_=Uint8Array,Pc=Uint16Array,so=Uint32Array,v_=Float32Array,Wr=io([][ii]()),Ac=Fe(Wr.next),P_=Fe(function*(){}().next),A_=io(Wr),L_=DataView.prototype,I_=Fe(L_.getUint16),oo=WeakMap,Lc=oo.prototype,Ic=Fe(Lc.get),C_=Fe(Lc.set),Cc=new oo,F_=no(null,{next:{value:function(){const e=Ic(Cc,this);return Ac(e)}},[ii]:{value:function(){return this}}});function O_(i){if(i[ii]===Sc&&Wr.next===Ac)return i;const e=no(F_);return C_(Cc,e,w_(i)),e}const M_=new oo,N_=no(A_,{next:{value:function(){const e=Ic(M_,this);return P_(e)},writable:!0,configurable:!0}});for(const i of __(Wr))i!=="next"&&x_(N_,i,wc(Wr,i));const Fc=new Rc(4),D_=new v_(Fc),U_=new so(Fc),at=new Pc(512),lt=new R_(512);for(let i=0;i<256;++i){const e=i-127;e<-24?(at[i]=0,at[i|256]=32768,lt[i]=24,lt[i|256]=24):e<-14?(at[i]=1024>>-e-14,at[i|256]=1024>>-e-14|32768,lt[i]=-e-1,lt[i|256]=-e-1):e<=15?(at[i]=e+15<<10,at[i|256]=e+15<<10|32768,lt[i]=13,lt[i|256]=13):e<128?(at[i]=31744,at[i|256]=64512,lt[i]=24,lt[i|256]=24):(at[i]=31744,at[i|256]=64512,lt[i]=13,lt[i|256]=13)}const ao=new so(2048);for(let i=1;i<1024;++i){let e=i<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,ao[i]=e|t}for(let i=1024;i<2048;++i)ao[i]=939524096+(i-1024<<13);const vr=new so(64);for(let i=1;i<31;++i)vr[i]=i<<23;vr[31]=1199570944;vr[32]=2147483648;for(let i=33;i<63;++i)vr[i]=2147483648+(i-32<<23);vr[63]=3347054592;const Oc=new Pc(64);for(let i=1;i<64;++i)i!==32&&(Oc[i]=1024);function B_(i){const e=i>>10;return U_[0]=ao[Oc[e]+(i&1023)]+vr[e],D_[0]}function Mc(i,e,...t){return B_(I_(i,e,...O_(t)))}var lo={exports:{}};function Nc(i,e,t){const r=t&&t.debug||!1;r&&console.log("[xml-utils] getting "+e+" in "+i);const n=typeof i=="object"?i.outer:i,s=n.slice(0,n.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],c=e+"\\="+l+"([^"+l+"]*)"+l;r&&console.log("[xml-utils] pattern:",c);const u=new RegExp(c).exec(s);if(r&&console.log("[xml-utils] match:",u),u)return u[1]}}lo.exports=Nc;lo.exports.default=Nc;var G_=lo.exports;const Ln=El(G_);var co={exports:{}},uo={exports:{}},ho={exports:{}};function Dc(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index:-1}ho.exports=Dc;ho.exports.default=Dc;var z_=ho.exports,fo={exports:{}};function Uc(i,e,t){const n=new RegExp(e).exec(i.slice(t));return n?t+n.index+n[0].length-1:-1}fo.exports=Uc;fo.exports.default=Uc;var $_=fo.exports,go={exports:{}};function Bc(i,e){const t=new RegExp(e,"g"),r=i.match(t);return r?r.length:0}go.exports=Bc;go.exports.default=Bc;var k_=go.exports;const j_=z_,In=$_,Sa=k_;function Gc(i,e,t){const r=t&&t.debug||!1,n=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;r&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=j_(i,`<${e}[ 
>/]`,s);if(r&&console.log("[xml-utils] start:",o),o===-1)return;const a=i.slice(o+e.length);let l=In(a,"^[^<]*[ /]>",0);const c=l!==-1&&a[l-1]==="/";if(r&&console.log("[xml-utils] selfClosing:",c),c===!1)if(n){let g=0,d=1,p=0;for(;(l=In(a,"[ /]"+e+">",g))!==-1;){const m=a.substring(g,l+1);if(d+=Sa(m,"<"+e+`[ 
	>]`),p+=Sa(m,"</"+e+">"),p>=d)break;g=l}}else l=In(a,"[ /]"+e+">",0);const h=o+e.length+l+1;if(r&&console.log("[xml-utils] end:",h),h===-1)return;const u=i.slice(o,h);let f;return c?f=null:f=u.slice(u.indexOf(">")+1,u.lastIndexOf("<")),{inner:f,outer:u,start:o,end:h}}uo.exports=Gc;uo.exports.default=Gc;var V_=uo.exports;const X_=V_;function zc(i,e,t){const r=[],n=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=X_(i,e,{debug:n,startIndex:o});)s?o=a.start+1+e.length:o=a.end,r.push(a);return n&&console.log("findTagsByName found",r.length,"tags"),r}co.exports=zc;co.exports.default=zc;var W_=co.exports;const H_=El(W_),Dr={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},ct={};for(const i in Dr)Dr.hasOwnProperty(i)&&(ct[Dr[i]]=parseInt(i,10));const Z_=[ct.BitsPerSample,ct.ExtraSamples,ct.SampleFormat,ct.StripByteCounts,ct.StripOffsets,ct.StripRowCounts,ct.TileByteCounts,ct.TileOffsets,ct.SubIFDs],Cn={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},Z={};for(const i in Cn)Cn.hasOwnProperty(i)&&(Z[Cn[i]]=parseInt(i,10));const ze={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},Y_={Unspecified:0},ax={AddCompression:1},lx={None:0,Deflate:1,Zstandard:2},q_={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function K_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=256-i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function J_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3);let s;for(let o=0,a=0;o<i.length;++o,a+=3)s=i[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function Q_(i,e){const{width:t,height:r}=i,n=new Uint8Array(t*r*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<i.length;++a,l+=3){const c=i[a];n[l]=e[c]/65536*256,n[l+1]=e[c+s]/65536*256,n[l+2]=e[c+o]/65536*256}return n}function ey(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=4,s+=3){const o=i[n],a=i[n+1],l=i[n+2],c=i[n+3];r[s]=255*((255-o)/256)*((255-c)/256),r[s+1]=255*((255-a)/256)*((255-c)/256),r[s+2]=255*((255-l)/256)*((255-c)/256)}return r}function ty(i){const{width:e,height:t}=i,r=new Uint8ClampedArray(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n],a=i[n+1],l=i[n+2];r[s]=o+1.402*(l-128),r[s+1]=o-.34414*(a-128)-.71414*(l-128),r[s+2]=o+1.772*(a-128)}return r}const ry=.95047,iy=1,ny=1.08883;function sy(i){const{width:e,height:t}=i,r=new Uint8Array(e*t*3);for(let n=0,s=0;n<i.length;n+=3,s+=3){const o=i[n+0],a=i[n+1]<<24>>24,l=i[n+2]<<24>>24;let c=(o+16)/116,h=a/500+c,u=c-l/200,f,g,d;h=ry*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),c=iy*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),u=ny*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),f=h*3.2406+c*-1.5372+u*-.4986,g=h*-.9689+c*1.8758+u*.0415,d=h*.0557+c*-.204+u*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,r[s]=Math.max(0,Math.min(1,f))*255,r[s+1]=Math.max(0,Math.min(1,g))*255,r[s+2]=Math.max(0,Math.min(1,d))*255}return r}const $c=new Map;function Ut(i,e){Array.isArray(i)||(i=[i]),i.forEach(t=>$c.set(t,e))}async function kc(i){const e=$c.get(i.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${i.Compression}`);const t=await e();return new t(i)}Ut([void 0,1],()=>Dt(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(i=>i.default));Ut(5,()=>Dt(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(i=>i.default));Ut(6,()=>{throw new Error("old style JPEG compression is not supported.")});Ut(7,()=>Dt(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(i=>i.default));Ut([8,32946],()=>Dt(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(i=>i.default));Ut(32773,()=>Dt(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(i=>i.default));Ut(34887,()=>Dt(()=>import("./lerc.CwDvYQhx.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15])).then(async i=>(await i.zstd.init(),i)).then(i=>i.default));Ut(50001,()=>Dt(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([16,1])).then(i=>i.default));function gn(i,e,t,r=1){return new(Object.getPrototypeOf(i)).constructor(e*t*r)}function oy(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=gn(a,r,n);for(let c=0;c<n;++c){const h=Math.min(Math.round(o*c),t-1);for(let u=0;u<r;++u){const f=Math.min(Math.round(s*u),e-1),g=a[h*e+f];l[c*r+u]=g}}return l})}function ar(i,e,t){return(1-t)*i+t*e}function ay(i,e,t,r,n){const s=e/r,o=t/n;return i.map(a=>{const l=gn(a,r,n);for(let c=0;c<n;++c){const h=o*c,u=Math.floor(h),f=Math.min(Math.ceil(h),t-1);for(let g=0;g<r;++g){const d=s*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1),_=a[u*e+m],E=a[u*e+y],w=a[f*e+m],S=a[f*e+y],T=ar(ar(_,E,p),ar(w,S,p),h%1);l[c*r+g]=T}}return l})}function ly(i,e,t,r,n,s="nearest"){switch(s.toLowerCase()){case"nearest":return oy(i,e,t,r,n);case"bilinear":case"linear":return ay(i,e,t,r,n);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function cy(i,e,t,r,n,s){const o=e/r,a=t/n,l=gn(i,r,n,s);for(let c=0;c<n;++c){const h=Math.min(Math.round(a*c),t-1);for(let u=0;u<r;++u){const f=Math.min(Math.round(o*u),e-1);for(let g=0;g<s;++g){const d=i[h*e*s+f*s+g];l[c*r*s+u*s+g]=d}}}return l}function uy(i,e,t,r,n,s){const o=e/r,a=t/n,l=gn(i,r,n,s);for(let c=0;c<n;++c){const h=a*c,u=Math.floor(h),f=Math.min(Math.ceil(h),t-1);for(let g=0;g<r;++g){const d=o*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1);for(let _=0;_<s;++_){const E=i[u*e*s+m*s+_],w=i[u*e*s+y*s+_],S=i[f*e*s+m*s+_],T=i[f*e*s+y*s+_],v=ar(ar(E,w,p),ar(S,T,p),h%1);l[c*r*s+g*s+_]=v}}}return l}function hy(i,e,t,r,n,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return cy(i,e,t,r,n,s);case"bilinear":case"linear":return uy(i,e,t,r,n,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function fy(i,e,t){let r=0;for(let n=e;n<t;++n)r+=i[n];return r}function es(i,e,t){switch(i){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function dy(i,e){return(i===1||i===2)&&e<=32&&e%8===0?!1:!(i===3&&(e===16||e===32||e===64))}function gy(i,e,t,r,n,s,o){const a=new DataView(i),l=t===2?o*s:o*s*r,c=t===2?1:r,h=es(e,n,l),u=parseInt("1".repeat(n),2);if(e===1){let f;t===1?f=r*n:f=n;let g=s*f;g&7&&(g=g+7&-8);for(let d=0;d<o;++d){const p=d*g;for(let m=0;m<s;++m){const y=p+m*c*n;for(let _=0;_<c;++_){const E=y+_*n,w=(d*s+m)*c+_,S=Math.floor(E/8),T=E%8;if(T+n<=8)h[w]=a.getUint8(S)>>8-n-T&u;else if(T+n<=16)h[w]=a.getUint16(S)>>16-n-T&u;else if(T+n<=24){const v=a.getUint16(S)<<8|a.getUint8(S+2);h[w]=v>>24-n-T&u}else h[w]=a.getUint32(S)>>32-n-T&u}}}}return h.buffer}class jc{constructor(e,t,r,n,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=r,this.littleEndian=n,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,r=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(r<=8)return DataView.prototype.getUint8;if(r<=16)return DataView.prototype.getUint16;if(r<=32)return DataView.prototype.getUint32;break;case 2:if(r<=8)return DataView.prototype.getInt8;if(r<=16)return DataView.prototype.getInt16;if(r<=32)return DataView.prototype.getInt32;break;case 3:switch(r){case 16:return function(n,s){return Mc(this,n,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const r=this.getSampleFormat(e),n=this.getBitsPerSample(e);return es(r,n,t)}async getTileOrStrip(e,t,r,n,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:c}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=r*o*a+t*o+e);let h,u;this.isTiled?(h=this.fileDirectory.TileOffsets[l],u=this.fileDirectory.TileByteCounts[l]):(h=this.fileDirectory.StripOffsets[l],u=this.fileDirectory.StripByteCounts[l]);const f=(await this.source.fetch([{offset:h,length:u}],s))[0];let g;return c===null||!c[l]?(g=(async()=>{let d=await n.decode(this.fileDirectory,f);const p=this.getSampleFormat(),m=this.getBitsPerSample();return dy(p,m)&&(d=gy(d,p,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),d})(),c!==null&&(c[l]=g)):g=c[l],{x:e,y:t,sample:r,data:await g}}async _readRaster(e,t,r,n,s,o,a,l,c){const h=this.getTileWidth(),u=this.getTileHeight(),f=this.getWidth(),g=this.getHeight(),d=Math.max(Math.floor(e[0]/h),0),p=Math.min(Math.ceil(e[2]/h),Math.ceil(f/h)),m=Math.max(Math.floor(e[1]/u),0),y=Math.min(Math.ceil(e[3]/u),Math.ceil(g/u)),_=e[2]-e[0];let E=this.getBytesPerPixel();const w=[],S=[];for(let I=0;I<t.length;++I)this.planarConfiguration===1?w.push(fy(this.fileDirectory.BitsPerSample,0,t[I])/8):w.push(0),S.push(this.getReaderForSample(t[I]));const T=[],{littleEndian:v}=this;for(let I=m;I<y;++I)for(let A=d;A<p;++A){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(A,I,0,s,c));for(let M=0;M<t.length;++M){const N=M,k=t[M];this.planarConfiguration===2&&(E=this.getSampleByteSize(k),R=this.getTileOrStrip(A,I,k,s,c));const j=R.then(B=>{const ee=B.data,G=new DataView(ee),ae=this.getBlockHeight(B.y),H=B.y*u,ne=B.x*h,ge=H+ae,be=(B.x+1)*h,re=S[N],ve=Math.min(ae,ae-(ge-e[3]),g-H),Se=Math.min(h,h-(be-e[2]),f-ne);for(let Re=Math.max(0,e[1]-H);Re<ve;++Re)for(let Oe=Math.max(0,e[0]-ne);Oe<Se;++Oe){const qt=(Re*h+Oe)*E,Bt=re.call(G,qt+w[N],v);let wt;n?(wt=(Re+H-e[1])*_*t.length+(Oe+ne-e[0])*t.length+N,r[wt]=Bt):(wt=(Re+H-e[1])*_+Oe+ne-e[0],r[N][wt]=Bt)}});T.push(j)}}if(await Promise.all(T),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let I;return n?I=hy(r,e[2]-e[0],e[3]-e[1],o,a,t.length,l):I=ly(r,e[2]-e[0],e[3]-e[1],o,a,l),I.width=o,I.height=a,I}return r.width=o||e[2]-e[0],r.height=a||e[3]-e[1],r}async readRasters({window:e,samples:t=[],interleave:r,pool:n=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:c}={}){const h=e||[0,0,this.getWidth(),this.getHeight()];if(h[0]>h[2]||h[1]>h[3])throw new Error("Invalid subsets");const u=h[2]-h[0],f=h[3]-h[1],g=u*f,d=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<d;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let p;if(r){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,E=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=es(_,E,g*t.length),l&&p.fill(l)}else{p=[];for(let _=0;_<t.length;++_){const E=this.getArrayForSample(t[_],g);Array.isArray(l)&&_<l.length?E.fill(l[_]):l&&!Array.isArray(l)&&E.fill(l),p.push(E)}}const m=n||await kc(this.fileDirectory);return await this._readRaster(h,t,p,r,m,s,o,a,c)}async readRGB({window:e,interleave:t=!0,pool:r=null,width:n,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const h=this.fileDirectory.PhotometricInterpretation;if(h===ze.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==Y_.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:r,width:n,height:s,resampleMethod:o,signal:l})}let u;switch(h){case ze.WhiteIsZero:case ze.BlackIsZero:case ze.Palette:u=[0];break;case ze.CMYK:u=[0,1,2,3];break;case ze.YCbCr:case ze.CIELab:u=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:c,interleave:!0,samples:u,pool:r,width:n,height:s,resampleMethod:o,signal:l},{fileDirectory:g}=this,d=await this.readRasters(f),p=2**this.fileDirectory.BitsPerSample[0];let m;switch(h){case ze.WhiteIsZero:m=K_(d,p);break;case ze.BlackIsZero:m=J_(d,p);break;case ze.Palette:m=Q_(d,g.ColorMap);break;case ze.CMYK:m=ey(d);break;case ze.YCbCr:m=ty(d);break;case ze.CIELab:m=sy(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),E=new Uint8Array(m.length/3);for(let w=0,S=0;w<m.length;w+=3,++S)y[S]=m[w],_[S]=m[w+1],E[S]=m[w+2];m=[y,_,E]}return m.width=d.width,m.height=d.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const r=this.fileDirectory.GDAL_METADATA;let n=H_(r,"Item");e===null?n=n.filter(s=>Ln(s,"sample")===void 0):n=n.filter(s=>Number(Ln(s,"sample"))===e);for(let s=0;s<n.length;++s){const o=n[s];t[Ln(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,r=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(r)return r[1]===0&&r[4]===0?[r[0],-r[5],r[10]]:[Math.sqrt(r[0]*r[0]+r[4]*r[4]),-Math.sqrt(r[1]*r[1]+r[5]*r[5]),r[10]];if(e){const[n,s,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),r=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[n,s,o,a,l,c,h,u]=this.fileDirectory.ModelTransformation,g=[[0,0],[0,t],[r,0],[r,t]].map(([m,y])=>[a+n*m+s*y,u+l*m+c*y]),d=g.map(m=>m[0]),p=g.map(m=>m[1]);return[Math.min(...d),Math.min(...p),Math.max(...d),Math.max(...p)]}else{const n=this.getOrigin(),s=this.getResolution(),o=n[0],a=n[1],l=o+s[0]*r,c=a+s[1]*t;return[Math.min(o,l),Math.min(a,c),Math.max(o,l),Math.max(a,c)]}}}class py{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const r=this.getUint32(e,t),n=this.getUint32(e+4,t);let s;if(t){if(s=r+2**32*n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*r+n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let r=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),r+=a*256**o}return n&&(r=-r),r}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return Mc(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class my{constructor(e,t,r,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=r,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),r=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+r,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const r=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));r&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**s}return r&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const _y=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class yy{constructor(e=_y,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(r=>{Dt(()=>import("./decoder.tqM1uIvc.js"),[]).then(n=>{r(n.create)})}),this._awaitingDecoder.then(r=>{this._awaitingDecoder=null,this.workers=[];for(let n=0;n<e;n++)this.workers.push({worker:r(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?kc(e).then(r=>r.decode(e,t)):new Promise(r=>{const n=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];n.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(n.idle=!0,r(a.data.decoded),n.worker.removeEventListener("message",o))};n.worker.addEventListener("message",o),n.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const Ra=`\r
\r
`;function Vc(i){if(typeof Object.fromEntries<"u")return Object.fromEntries(i);const e={};for(const[t,r]of i)e[t.toLowerCase()]=r;return e}function Ey(i){const e=i.split(`\r
`).map(t=>{const r=t.split(":").map(n=>n.trim());return r[0]=r[0].toLowerCase(),r});return Vc(e)}function xy(i){const[e,...t]=i.split(";").map(n=>n.trim()),r=t.map(n=>n.split("="));return{type:e,params:Vc(r)}}function ts(i){let e,t,r;return i&&([,e,t,r]=i.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),r=parseInt(r,10)),{start:e,end:t,total:r}}function by(i,e){let t=null;const r=new TextDecoder("ascii"),n=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)r.decode(new Uint8Array(i,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<i.byteLength;){const a=r.decode(new Uint8Array(i,t,Math.min(s.length+1024,i.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const c=l.indexOf(Ra),h=Ey(l.substr(0,c)),{start:u,end:f,total:g}=ts(h["content-range"]),d=t+s.length+c+Ra.length,p=parseInt(f,10)+1-parseInt(u,10);n.push({headers:h,data:i.slice(d,d+p),offset:u,length:p,fileSize:g}),t=d+p+4}return n}class po{async fetch(e,t=void 0){return Promise.all(e.map(r=>this.fetchSlice(r,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class Ty extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,r]of e)this.onEviction(t,r.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const r=t.get(e);return this._getItemValue(e,r)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield e)}for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:r=this.maxAge}={}){const n=typeof r=="number"&&r!==Number.POSITIVE_INFINITY?Date.now()+r:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],r=t.length-e;r<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(r>0&&this._emitEvictions(t.slice(0,r)),this.oldCache=new Map(t.slice(r)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,r]=e;this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}for(const e of this.oldCache){const[t,r]=e;this.cache.has(t)||this._deleteIfExpired(t,r)===!1&&(yield[t,r.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const r=e[t],[n,s]=r;this.cache.has(n)||this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[r,n]of this.entriesAscending())e.call(t,n,r,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function wy(i){return new Promise(e=>setTimeout(e,i))}function Sy(i,e){const t=Array.isArray(i)?i:Array.from(i),r=Array.isArray(e)?e:Array.from(e);return t.map((n,s)=>[n,r[s]])}class gr extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,gr),this.name="AbortError"}}class Ry extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const vy=Ry;class Py{constructor(e,t,r=null){this.offset=e,this.length=t,this.data=r}get top(){return this.offset+this.length}}class va{constructor(e,t,r){this.offset=e,this.length=t,this.blockIds=r}}class Ay extends po{constructor(e,{blockSize:t=65536,cacheSize:r=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new Ty({maxSize:r,onEviction:(n,s)=>{this.evictedBlocks.set(n,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const r=[],n=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:g}of e){let d=f+g;const{fileSize:p}=this;p!==null&&(d=Math.min(d,p));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<d;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),n.push(_)),this.blockRequests.has(_)&&r.push(this.blockRequests.get(_)),s.push(_)}}await wy(),this.fetchBlocks(t);const o=[];for(const f of n)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(r),await Promise.allSettled(o);const a=[],l=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(l.forEach(f=>this.blockIdsToFetch.add(f)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of l){const g=this.blockRequests.get(f);if(!g)throw new Error(`Block ${f} is not in the block requests`);a.push(g)}await Promise.allSettled(a)}if(t&&t.aborted)throw new gr("Request was aborted");const c=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),h=c.filter(f=>!f);if(h.length)throw new vy(h,"Request failed");const u=new Map(Sy(s,c));return this.readSliceData(e,u)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),r=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const s=t[n];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await r)[n],l=o*this.blockSize,c=l-a.offset,h=Math.min(c+this.blockSize,a.data.byteLength),u=a.data.slice(c,h),f=new Py(l,u.byteLength,u,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let r=[],n=null;const s=[];for(const o of t)n===null||n+1===o?(r.push(o),n=o):(s.push(new va(r[0]*this.blockSize,r.length*this.blockSize,r)),r=[o],n=o);return s.push(new va(r[0]*this.blockSize,r.length*this.blockSize,r)),s}readSliceData(e,t){return e.map(r=>{let n=r.offset+r.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const s=Math.floor(r.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(r.length),l=new Uint8Array(a);for(let c=s;c<=o;++c){const h=t.get(c),u=h.offset-r.offset,f=h.top-n;let g=0,d=0,p;u<0?g=-u:u>0&&(d=u),f<0?p=h.length-g:p=n-h.offset-g;const m=new Uint8Array(h.data,g,p);l.set(m,d)}return a})}}class mo{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class _o{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class Ly extends mo{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class Iy extends _o{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const r=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new Ly(r)}}class Cy extends mo{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class Fy extends _o{constructRequest(e,t){return new Promise((r,n)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;r(new Cy(s,o))},s.onerror=n,s.onabort=()=>n(new gr("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const Fn={};class Oy extends mo{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class My extends _o{constructor(e){super(e),this.parsedUrl=Fn.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",Fn)}constructRequest(e,t){return new Promise((r,n)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const c=[];o.on("data",h=>{c.push(h)}),o.on("end",()=>{const h=Buffer.concat(c).buffer;l(h)}),o.on("error",n)});r(new Oy(o,a))});s.on("error",n),t&&(t.aborted&&s.destroy(new gr("Request aborted")),t.addEventListener("abort",()=>s.destroy(new gr("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class yo extends po{constructor(e,t,r,n){super(),this.client=e,this.headers=t,this.maxRanges=r,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(r=>this.fetchSlice(r,t))))}async fetchSlices(e,t){const r=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:s})=>`${n}-${n+s}`).join(",")}`},signal:t});if(r.ok)if(r.status===206){const{type:n,params:s}=xy(r.getHeader("content-type"));if(n==="multipart/byteranges"){const u=by(await r.getData(),s.boundary);return this._fileSize=u[0].fileSize||null,u}const o=await r.getData(),{start:a,end:l,total:c}=ts(r.getHeader("content-range"));this._fileSize=c||null;const h=[{data:o,offset:a,length:l-a}];if(e.length>1){const u=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return h.concat(u)}return h}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await r.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:r,length:n}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${r}-${r+n}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=ts(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:r,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function Eo(i,{blockSize:e,cacheSize:t}){return e===null?i:new Ay(i,{blockSize:e,cacheSize:t})}function Ny(i,{headers:e={},credentials:t,maxRanges:r=0,allowFullFile:n=!1,...s}={}){const o=new Iy(i,t),a=new yo(o,e,r,n);return Eo(a,s)}function Dy(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new Fy(i),o=new yo(s,e,t,r);return Eo(o,n)}function Uy(i,{headers:e={},maxRanges:t=0,allowFullFile:r=!1,...n}={}){const s=new My(i),o=new yo(s,e,t,r);return Eo(o,n)}function rs(i,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?Ny(i,t):typeof XMLHttpRequest<"u"?Dy(i,t):Uy(i,t)}class By extends po{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((r,n)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>r(a.target.result),o.onerror=n,o.onabort=n,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Gy(i){return new By(i)}function is(i){switch(i){case Z.BYTE:case Z.ASCII:case Z.SBYTE:case Z.UNDEFINED:return 1;case Z.SHORT:case Z.SSHORT:return 2;case Z.LONG:case Z.SLONG:case Z.FLOAT:case Z.IFD:return 4;case Z.RATIONAL:case Z.SRATIONAL:case Z.DOUBLE:case Z.LONG8:case Z.SLONG8:case Z.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${i}`)}}function zy(i){const e=i.GeoKeyDirectory;if(!e)return null;const t={};for(let r=4;r<=e[3]*4;r+=4){const n=q_[e[r]],s=e[r+1]?Dr[e[r+1]]:null,o=e[r+2],a=e[r+3];let l=null;if(!s)l=a;else{if(l=i[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[n]=l}return t}function er(i,e,t,r){let n=null,s=null;const o=is(e);switch(e){case Z.BYTE:case Z.ASCII:case Z.UNDEFINED:n=new Uint8Array(t),s=i.readUint8;break;case Z.SBYTE:n=new Int8Array(t),s=i.readInt8;break;case Z.SHORT:n=new Uint16Array(t),s=i.readUint16;break;case Z.SSHORT:n=new Int16Array(t),s=i.readInt16;break;case Z.LONG:case Z.IFD:n=new Uint32Array(t),s=i.readUint32;break;case Z.SLONG:n=new Int32Array(t),s=i.readInt32;break;case Z.LONG8:case Z.IFD8:n=new Array(t),s=i.readUint64;break;case Z.SLONG8:n=new Array(t),s=i.readInt64;break;case Z.RATIONAL:n=new Uint32Array(t*2),s=i.readUint32;break;case Z.SRATIONAL:n=new Int32Array(t*2),s=i.readInt32;break;case Z.FLOAT:n=new Float32Array(t),s=i.readFloat32;break;case Z.DOUBLE:n=new Float64Array(t),s=i.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===Z.RATIONAL||e===Z.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=s.call(i,r+a*o),n[a+1]=s.call(i,r+(a*o+4));else for(let a=0;a<t;++a)n[a]=s.call(i,r+a*o);return e===Z.ASCII?new TextDecoder("utf-8").decode(n):n}class $y{constructor(e,t,r){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=r}}class mi extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Xc{async readRasters(e={}){const{window:t,width:r,height:n}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let c=l;const h=await this.getImageCount(),u=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(r||n){if(t){const[d,p]=l.getOrigin(),[m,y]=l.getResolution();a=[d+t[0]*m,p+t[1]*y,d+t[2]*m,p+t[3]*y]}const g=a||u;if(r){if(s)throw new Error("Both width and resX passed");s=(g[2]-g[0])/r}if(n){if(o)throw new Error("Both width and resY passed");o=(g[3]-g[1])/n}}if(s||o){const g=[];for(let d=0;d<h;++d){const p=await this.getImage(d),{SubfileType:m,NewSubfileType:y}=p.fileDirectory;(d===0||m===2||y&1)&&g.push(p)}g.sort((d,p)=>d.getWidth()-p.getWidth());for(let d=0;d<g.length;++d){const p=g[d],m=(u[2]-u[0])/p.getWidth(),y=(u[3]-u[1])/p.getHeight();if(c=p,s&&s>m||o&&o>y)break}}let f=t;if(a){const[g,d]=l.getOrigin(),[p,m]=c.getResolution(l);f=[Math.round((a[0]-g)/p),Math.round((a[1]-d)/m),Math.round((a[2]-g)/p),Math.round((a[3]-d)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return c.readRasters({...e,window:f})}}class pr extends Xc{constructor(e,t,r,n,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=r,this.firstIFDOffset=n,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const r=this.bigTiff?4048:1024;return new my((await this.source.fetch([{offset:e,length:typeof t<"u"?t:r}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,r=this.bigTiff?8:2;let n=await this.getSlice(e);const s=this.bigTiff?n.readUint64(e):n.readUint16(e),o=s*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let u=0;u<s;l+=t,++u){const f=n.readUint16(l),g=n.readUint16(l+2),d=this.bigTiff?n.readUint64(l+4):n.readUint32(l+4);let p,m;const y=is(g),_=l+(this.bigTiff?12:8);if(y*d<=(this.bigTiff?8:4))p=er(n,g,d,_);else{const E=n.readOffset(_),w=is(g)*d;if(n.covers(E,w))p=er(n,g,d,E);else{const S=await this.getSlice(E,w);p=er(S,g,d,E)}}d===1&&Z_.indexOf(f)===-1&&!(g===Z.RATIONAL||g===Z.SRATIONAL)?m=p[0]:m=p,a[Dr[f]]=m}const c=zy(a),h=n.readOffset(e+r+t*s);return new $y(a,c,h)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof mi?new mi(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new mi(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new jc(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(r){if(r instanceof mi)t=!1;else throw r}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",r=t.length+100;let n=await this.getSlice(e,r);if(t===er(n,Z.ASCII,t.length,e)){const o=er(n,Z.ASCII,r,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>r&&(n=await this.getSlice(e,a));const l=er(n,Z.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(c=>c.length>0).map(c=>c.split("=")).forEach(([c,h])=>{this.ghostValues[c]=h})}return this.ghostValues}static async fromSource(e,t,r){const n=(await e.fetch([{offset:0,length:1024}],r))[0],s=new py(n),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let c;if(l===42)c=!1;else if(l===43){if(c=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const h=c?s.getUint64(8,a):s.getUint32(4,a);return new pr(e,a,c,h,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class ky extends Xc{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,r=0;for(let n=0;n<this.imageFiles.length;n++){const s=this.imageFiles[n];for(let o=0;o<this.imageCounts[n];o++){if(e===t){const a=await s.requestIFD(r);return new jc(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,r++}r=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,r)=>t+r,0),this.imageCount}}async function jy(i,e={},t){return pr.fromSource(rs(i,e),t)}async function Vy(i,e){return pr.fromSource(Gy(i),e)}async function Xy(i,e=[],t={},r){const n=await pr.fromSource(rs(i,t),r),s=await Promise.all(e.map(o=>pr.fromSource(rs(o,t))));return new ky(n,s)}const Wy=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,Hy=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class Zy{constructor(e){this.gl_=e,this.program_=ns(e,Hy,Wy),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,r,n,s,o,a,l,c,h,u,f,g){const d=this.gl_;l===void 0&&(l=n),c===void 0&&(c=s),o===void 0&&(o=t),a===void 0&&(a=r),h===void 0&&(h=o),u===void 0&&(u=a),f===void 0&&(f=d.canvas.width),g===void 0&&(g=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let p=Zn(0,f,0,g,-1,1);p=Up(p,l,c,0),p=fa(p,h,u,1),d.uniformMatrix4fv(this.matrixLocation,!1,p);let m=Bp(n/t,s/r,0);m=fa(m,o/t,a/r,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function Pa(i,e,t){const r=i.createShader(e);if(r===null)throw new Error("Shader compilation failed");if(i.shaderSource(r,t),i.compileShader(r),!i.getShaderParameter(r,i.COMPILE_STATUS)){const n=i.getShaderInfoLog(r);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return r}function ns(i,e,t){const r=i.createProgram(),n=Pa(i,i.VERTEX_SHADER,t),s=Pa(i,i.FRAGMENT_SHADER,e);if(r===null)throw new Error("Program creation failed");if(i.attachShader(r,n),i.attachShader(r,s),i.linkProgram(r),!i.getProgramParameter(r,i.LINK_STATUS))throw i.getProgramInfoLog(r)===null?new Error("Program info log creation failed"):new Error;return r}const Yy=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,qy=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,Ky=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,Jy=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function Qy(i,e,t,r){let n;return t&&t.length?n=t.shift():_h?n=new OffscreenCanvas(i||300,e||300):n=document.createElement("canvas"),i&&(n.width=i),e&&(n.height=e),n.getContext("webgl",r)}function e0(i){const e=i.canvas;e.width=1,e.height=1,i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT|i.STENCIL_BUFFER_BIT)}const Aa=[];function t0(i,e,t,r,n,s,o,a,l,c,h,u,f,g){const d=Math.round(r*e),p=Math.round(r*t);i.canvas.width=d,i.canvas.height=p;let m,y;if(y=i.createTexture(),i.bindTexture(i.TEXTURE_2D,y),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,d,p,0,i.RGBA,h,null),m=i.createFramebuffer(),i.bindFramebuffer(i.FRAMEBUFFER,m),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:p,framebuffer:m,texture:y};const _=Yr();l.forEach(function(R,M,N){ju(_,R.extent)});let E,w,S;const T=1/n;{if(E=i.createTexture(),y===null)throw new Error("Could not create texture");w=Math.round(Ce(_)*T),S=Math.round(rt(_)*T);const R=i.getParameter(i.MAX_TEXTURE_SIZE),M=Math.max(w,S),N=M>R?R/M:1,k=Math.round(w*N),j=Math.round(S*N);i.bindTexture(i.TEXTURE_2D,E),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),f?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST)),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,k,j,0,i.RGBA,h,null);const B=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,B),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,E,0);const ee=new Zy(i);l.forEach(function(G,ae,H){const ne=(G.extent[0]-_[0])*T*N,ge=-(G.extent[3]-_[3])*T*N,be=Ce(G.extent)*T*N,re=rt(G.extent)*T*N;if(i.bindFramebuffer(i.FRAMEBUFFER,B),i.viewport(0,0,k,j),G.clipExtent){const ve=(G.clipExtent[0]-_[0])*T*N,Se=-(G.clipExtent[3]-_[3])*T*N,Re=Ce(G.clipExtent)*T*N,Oe=rt(G.clipExtent)*T*N;i.enable(i.SCISSOR_TEST),i.scissor(f?ve:Math.round(ve),f?Se:Math.round(Se),f?Re:Math.round(ve+Re)-Math.round(ve),f?Oe:Math.round(Se+Oe)-Math.round(Se))}ee.drawImage(G.texture,G.width,G.height,c,c,G.width-2*c,G.height-2*c,f?ne:Math.round(ne),f?ge:Math.round(ge),f?be:Math.round(ne+be)-Math.round(ne),f?re:Math.round(ge+re)-Math.round(ge),k,j),i.disable(i.SCISSOR_TEST)}),i.deleteFramebuffer(B)}const v=Gn(o),I=Gn(_),A=R=>{const M=(R[0][0]-v[0])/s*r,N=-(R[0][1]-v[1])/s*r,k=(R[1][0]-v[0])/s*r,j=-(R[1][1]-v[1])/s*r,B=(R[2][0]-v[0])/s*r,ee=-(R[2][1]-v[1])/s*r;return{u1:k,v1:j,u0:M,v0:N,u2:B,v2:ee}};i.bindFramebuffer(i.FRAMEBUFFER,m),i.viewport(0,0,d,p);{const R=[],M=[],N=ns(i,Jy,Ky);i.useProgram(N);const k=i.getUniformLocation(N,"u_texture");i.bindTexture(i.TEXTURE_2D,E),i.uniform1i(k,0),a.getTriangles().forEach(function(ne,ge,be){const re=ne.source,ve=ne.target,{u1:Se,v1:Re,u0:Oe,v0:qt,u2:Bt,v2:wt}=A(ve),ai=(re[0][0]-I[0])/n/w,li=-(re[0][1]-I[1])/n/S,ci=(re[1][0]-I[0])/n/w,hu=-(re[1][1]-I[1])/n/S,fu=(re[2][0]-I[0])/n/w,du=-(re[2][1]-I[1])/n/S;R.push(Se,Re,Oe,qt,Bt,wt),M.push(ci,hu,ai,li,fu,du)});const j=Zn(0,d,p,0,-1,1),B=i.getUniformLocation(N,"u_matrix");i.uniformMatrix4fv(B,!1,j);const ee=i.getAttribLocation(N,"a_position"),G=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,G),i.bufferData(i.ARRAY_BUFFER,new Float32Array(R),i.STATIC_DRAW),i.vertexAttribPointer(ee,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(ee);const ae=i.getAttribLocation(N,"a_texcoord"),H=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,H),i.bufferData(i.ARRAY_BUFFER,new Float32Array(M),i.STATIC_DRAW),i.vertexAttribPointer(ae,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(ae),i.drawArrays(i.TRIANGLES,0,R.length/2)}if(u){const R=ns(i,qy,Yy);i.useProgram(R);const M=Zn(0,d,p,0,-1,1),N=i.getUniformLocation(R,"u_matrix");i.uniformMatrix4fv(N,!1,M);const k=Array.isArray(u)?u:[0,0,0,255],j=i.getUniformLocation(R,"u_val");i.uniform4fv(j,k);const B=i.getAttribLocation(R,"a_position"),ee=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,ee),i.vertexAttribPointer(B,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(B);const G=a.getTriangles().reduce(function(ae,H){const ne=H.target,{u1:ge,v1:be,u0:re,v0:ve,u2:Se,v2:Re}=A(ne);return ae.concat([ge,be,re,ve,re,ve,Se,Re,Se,Re,ge,be])},[]);i.bufferData(i.ARRAY_BUFFER,new Float32Array(G),i.STATIC_DRAW),i.drawArrays(i.LINES,0,G.length/2)}return{width:d,height:p,framebuffer:m,texture:y}}class r0 extends xs{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,r=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?ft(r,n):r:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?ft(s,o):s;if(Mo(l)===0){this.state=q.EMPTY;return}r&&(a?a=ft(a,r):a=r);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),h=e.targetProj,u=yh(t,h,l,c);if(!isFinite(u)||u<=0){this.state=q.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:Eh;if(this.triangulation_=new xh(t,h,l,a,u*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=q.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(u);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=ye(g[1],a[1],a[3]),g[3]=ye(g[3],a[1],a[3])):g=ft(g,a)),!Mo(g))this.state=q.EMPTY;else{let d=0,p=0;t.canWrapX()&&(d=Ce(r),p=Math.floor((g[0]-r[0])/d)),Vu(g.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),E=e.getTileFunction;for(let w=_.minX;w<=_.maxX;w++)for(let S=_.minY;S<=_.maxY;S++){const T=E(this.sourceZ_,w,S,this.pixelRatio_);if(T){const v=p*d;this.sourceTiles_.push({tile:T,offset:v})}}++p}),this.sourceTiles_.length===0&&(this.state=q.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(w=>{var ge;const S=w.tile;if(!S||S.getState()!==q.LOADED)return;const T=S.getSize(),v=this.gutter_;let I;const A=zn(S.getData());A?I=A:(t=!0,I=bh($n(S.getData())));const R=[T[0]+2*v,T[1]+2*v],M=I instanceof Float32Array,N=R[0]*R[1],k=M?Float32Array:Uint8ClampedArray,j=new k(I.buffer),B=k.BYTES_PER_ELEMENT,ee=B*j.length/N,G=j.byteLength/R[1],ae=Math.floor(G/B/R[0]),H=this.sourceTileGrid_.getTileCoordExtent(S.tileCoord);H[0]+=w.offset,H[2]+=w.offset;const ne=(ge=this.clipExtent_)==null?void 0:ge.slice();ne&&(ne[0]+=w.offset,ne[2]+=w.offset),e.push({extent:H,clipExtent:ne,data:j,dataType:k,bytesPerPixel:ee,pixelSize:R,bandCount:ae})}),this.sourceTiles_.length=0,e.length===0){this.state=q.ERROR,this.changed();return}const r=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(r),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=s*this.pixelRatio_,l=o*this.pixelRatio_,c=this.targetTileGrid_.getResolution(r),h=this.sourceTileGrid_.getResolution(this.sourceZ_),u=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,g=new e[0].dataType(f*a*l),d=Qy(a,l,Aa,{premultipliedAlpha:!1,antialias:!1});let p;const m=d.RGBA;let y;e[0].dataType==Float32Array?(y=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),p=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=d.UNSIGNED_BYTE,p=this.interpolate);const _=4,E=Math.ceil(f/_);for(let w=E-1;w>=0;--w){const S=[];for(let k=0,j=e.length;k<j;++k){const B=e[k],ee=B.pixelSize,G=ee[0],ae=ee[1],H=new B.dataType(_*G*ae),ne=B.data;let ge=w*_;for(let re=0,ve=H.length;re<ve;re+=_)H[re]=ne[ge],H[re+1]=ne[ge+1],H[re+2]=ne[ge+2],H[re+3]=ne[ge+3],ge+=f;const be=d.createTexture();d.bindTexture(d.TEXTURE_2D,be),p?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,G,ae,0,m,y,H),S.push({extent:B.extent,clipExtent:B.clipExtent,texture:be,width:G,height:ae})}const{framebuffer:T,width:v,height:I}=t0(d,s,o,this.pixelRatio_,h,c,u,this.triangulation_,S,this.gutter_,y,this.renderEdges_,p),A=v,R=I*_,M=new e[0].dataType(A*R);d.bindFramebuffer(d.FRAMEBUFFER,T),d.readPixels(0,0,v,I,d.RGBA,y,M);let N=w*_;for(let k=0,j=M.length;k<j;k+=_){const B=(A-1-(k/R|0))*R+k%R;g[N]=M[B],g[N+1]=M[B+1],g[N+2]=M[B+2],g[N+3]=M[B+3],N+=f}}if(e0(d),Aa.push(d.canvas),t){const w=Ft(s,o),S=new ImageData(g,s);w.putImageData(S,0,0),this.reprojData_=w.canvas}else this.reprojData_=g;this.reprojSize_=[Math.round(a),Math.round(l)],this.state=q.LOADED,this.changed()}load(){if(this.state!==q.IDLE&&this.state!==q.ERROR)return;this.state=q.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const r=t.getState();if(r!==q.IDLE&&r!==q.LOADING)return;e++;const n=mt(t,Be.CHANGE,()=>{const s=t.getState();(s==q.LOADED||s==q.ERROR||s==q.EMPTY)&&(vi(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==q.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(vi),this.sourcesListenerKeys_=null}}class ni extends Ts{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let r=e.tileGrid;r===void 0&&t&&(r=Wt({extent:Ht(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:r,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?it(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?it(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||Ei(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,r,n,s){const o=this.tileGrid||this.getTileGridForProjection(s||n),a=Math.max.apply(null,o.getResolutions().map((g,d)=>{const p=it(o.getTileSize(d)),m=this.getTileSize(d);return Math.max(m[0]/p[0],m[1]/p[1])})),l=this.getTileGridForProjection(n),c=[e,t,r],h=this.getTileCoordForTileUrlFunction(c,n),u=Object.assign({sourceProj:s||n,sourceTileGrid:o,targetProj:n,targetTileGrid:l,tileCoord:c,wrappedTileCoord:h,pixelRatio:a,gutter:this.gutter_,getTileFunction:(g,d,p,m)=>this.getTile(g,d,p,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new r0(u);return f.key=this.getKey(),f}getTile(e,t,r,n,s){var E;const o=this.getProjection();if(s&&(o&&!Ei(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,r,s,o);const a=this.getTileSize(e),l=this.loader_,c=new AbortController,h={signal:c.signal,crossOrigin:this.crossOrigin_},u=this.getTileCoordForTileUrlFunction([e,t,r]);if(!u)return null;const f=u[0],g=u[1],d=u[2],p=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(f);p&&(h.maxY=p.getHeight()-1);function m(){return Xu(function(){return l(f,g,d,h)})}const y=Object.assign({tileCoord:[e,t,r],loader:m,size:a,controller:c},this.tileOptions),_=new xs(y);return _.key=this.getKey(),_.addEventListener(Be.CHANGE,this.handleTileChange_),_}handleTileChange_(e){const t=e.target,r=ce(t),n=t.getState();let s;n==q.LOADING?(this.tileLoadingKeys_[r]=!0,s=bn.TILELOADSTART):r in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[r],s=n==q.ERROR?bn.TILELOADERROR:n==q.LOADED?bn.TILELOADEND:void 0),s&&this.dispatchEvent(new Th(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||Ei(t,e))&&!this.transformMatrix)return this.tileGrid;const r=ce(e);return r in this.tileGridForProjection_||(this.tileGridForProjection_[r]=wh(e)),this.tileGridForProjection_[r]}setTileGridForProjection(e,t){const r=oe(e);if(r){const n=ce(r);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function i0(i){return((i.fileDirectory.NewSubfileType||0)&4)===4}function n0(i,e){if(!i)return!1;if(i===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,r=ze;return t===r.CMYK||t===r.YCbCr||t===r.CIELab||t===r.ICCLab}const La="STATISTICS_MAXIMUM",Ia="STATISTICS_MINIMUM",On=256;let Mn;function s0(){return Mn||(Mn=new yy),Mn}function o0(i){try{return i.getBoundingBox(!0)}catch{return[0,0,i.getWidth(),i.getHeight()]}}function a0(i){try{return i.getOrigin().slice(0,2)}catch{return[0,i.getHeight()]}}function l0(i,e){try{return i.getResolution(e)}catch{return[e.getWidth()/i.getWidth(),e.getHeight()/i.getHeight()]}}function c0(i){const e=i.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let r=oe(t);if(!r){const n=Co(e.ProjLinearUnitsGeoKey);n&&(r=new Fo({code:t,units:n}))}return r}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let r=oe(t);if(!r){const n=Co(e.GeogAngularUnitsGeoKey);n&&(r=new Fo({code:t,units:n}))}return r}return null}function u0(i){return i.getImageCount().then(function(e){const t=new Array(e);for(let r=0;r<e;++r)t[r]=i.getImage(r);return Promise.all(t)})}function h0(i,e){let t;return i.blob?t=Vy(i.blob):i.overviews?t=Xy(i.url,i.overviews,e):t=jy(i.url,e),t.then(u0)}function Fr(i,e,t,r,n){if(Array.isArray(i)){const s=i.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(r);throw n(o),o}for(let o=0;o<s;++o)Fr(i[o],e[o],t,r,n);return}if(e=e,Math.abs(i-e)>t*i)throw new Error(r)}function f0(i){return i instanceof Int8Array?-128:i instanceof Int16Array?-32768:i instanceof Int32Array?-2147483648:i instanceof Float32Array?12e-39:0}function d0(i){return i instanceof Int8Array?127:i instanceof Uint8Array||i instanceof Uint8ClampedArray?255:i instanceof Int16Array?32767:i instanceof Uint16Array?65535:i instanceof Int32Array?2147483647:i instanceof Uint32Array?4294967295:i instanceof Float32Array?34e37:255}class xo extends ni{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const r=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=h0(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){r.configure_(s)}).catch(function(s){$r(s),r.error_=s,r.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const n=t[r],s=c0(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let r=t.length-1;r>=0;--r){const s=t[r].fileDirectory.ModelTransformation;if(s){const[o,a,l,c,h,u,f,g]=s,d=Gr(Gr([1/Math.sqrt(o*o+h*h),0,0,-1/Math.sqrt(a*a+u*u),c,g],[o,h,a,u,0,0]),[1,0,0,1,-c,-g]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,r,n,s,o;const a=new Array(e.length),l=new Array(e.length),c=new Array(e.length);let h=0;const u=e.length;for(let m=0;m<u;++m){const y=[],_=[];e[m].forEach(A=>{i0(A)?_.push(A):y.push(A)});const E=y.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let w,S;const T=new Array(E),v=new Array(E),I=new Array(E);l[m]=new Array(E),c[m]=new Array(E);for(let A=0;A<E;++A){const R=y[A],M=R.getGDALNoData();c[m][A]=R.getGDALMetadata(0),l[m][A]=M;const N=this.sourceInfo_[m].bands;a[m]=N?N.length:R.getSamplesPerPixel();const k=E-(A+1);w||(w=o0(R)),S||(S=a0(R));const j=l0(R,y[0]);I[k]=j[0];const B=[R.getTileWidth(),R.getTileHeight()];B[0]!==B[1]&&B[1]<On&&(B[0]=On,B[1]=On),T[k]=B;const ee=j[0]/Math.abs(j[1]);v[k]=[B[0],B[1]/ee]}if(t?ft(t,w,t):t=w,!r)r=S;else{const A=`Origin mismatch for source ${m}, got [${S}] but expected [${r}]`;Fr(r,S,0,A,this.viewRejector)}if(!o)o=I,this.resolutionFactors_[m]=1;else{o.length-h>I.length&&(h=o.length-I.length);const A=o[o.length-1]/I[I.length-1];this.resolutionFactors_[m]=A;const R=I.map(N=>N*=A),M=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;Fr(o.slice(h,o.length),R,.02,M,this.viewRejector)}n?Fr(n.slice(h,n.length),v,.01,`Tile size mismatch for source ${m}`,this.viewRejector):n=v,s?Fr(s.slice(h,s.length),T,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=T,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=c;e:for(let m=0;m<u;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=l[m],_=this.sourceInfo_[m].bands;if(_){for(let E=0;E<_.length;++E)if(y[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<y.length;++E)if(y[E]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<u;++m)f+=a[m];this.bandCount=f;const g=new sn({extent:t,minZoom:h,origin:r,resolutions:o,tileSizes:n});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=zr(Ie(),this.transformMatrix.slice()),y=Lu(_=>xt(m,_));p=hr(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:Cu(Lt(p),this.projection),extent:Iu(p,this.projection),zoom:d})}loadTile_(e,t,r,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,c=this.sourceInfo_,h=s0();for(let u=0;u<o;++u){const f=c[u],g=this.resolutionFactors_[u],d=[Math.round(t*(s[0]*g)),Math.round(r*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((r+1)*(s[1]*g))],p=this.sourceImagery_[u][e];let m;f.bands&&(m=f.bands.map(function(S){return S-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(S){return l[u][S]}):y=l[u];const _={window:d,width:s[0],height:s[1],samples:m,fillValue:y,pool:h,interleave:!1,signal:n.signal};n0(this.convertToRGB_,p)?a[u]=p.readRGB(_):a[u]=p.readRasters(_);const E=o+u,w=this.sourceMasks_[u][e];if(!w){a[E]=Promise.resolve(null);continue}a[E]=w.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:h,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(u){throw $r(u),u})}composeTile_(e,t){const r=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,c=this.normalize_,h=this.addAlpha_,u=e[0]*e[1],f=u*o;let g;c?g=new Uint8Array(f):g=new Float32Array(f);let d=0;for(let p=0;p<u;++p){let m=h;for(let y=0;y<s;++y){const _=n[y];let E=_.min,w=_.max,S,T;if(c){const v=r[y][0];E===void 0&&(v&&Ia in v?E=parseFloat(v[Ia]):E=f0(t[y][0])),w===void 0&&(v&&La in v?w=parseFloat(v[La]):w=d0(t[y][0])),S=255/(w-E),T=-E*S}for(let v=0;v<a[y];++v){const I=t[y][v][p];let A;if(c?A=ye(S*I+T,0,255):A=I,!h)g[d]=A;else{let R=_.nodata;if(R===void 0){let N;_.bands?N=_.bands[v]-1:N=v,R=l[y][N]}const M=isNaN(R);(!M&&I!==R||M&&!isNaN(I))&&(m=!1,g[d]=A)}d++}if(!m){const v=s+y,I=t[v];I&&!I[0][p]&&(m=!0)}}h&&(m||(g[d]=255),d++)}return g}}xo.prototype.getView;class pe{constructor(e){this.name=e}toString(){return this.name}}pe.GeoTIFF=new pe("GeoTIFF");pe.ImageStatic=new pe("ImageStatic");pe.PMTilesRaster=new pe("PMTilesRaster");pe.PMTilesVector=new pe("PMTilesVector");pe.TileJSON=new pe("TileJSON");pe.TileWMS=new pe("TileWMS");pe.WMTS=new pe("WMTS");pe.XYZ=new pe("XYZ");function g0(i){const e=i.load||Er,t=i.imageExtent,r=i.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=r,e(n,i.url).then(s=>{const o=Ce(t)/s.width,a=rt(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Wc extends Zt{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,r=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws;super({attributions:e.attributions,interpolate:e.interpolate,projection:oe(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new hl(this.imageExtent_,void 0,1,g0({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),r(this.image,s),Er(n))})),this.image.addEventListener(Be.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,r,n){return ur(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function bo(i,e,t,r){const n=document.createElement("script"),s="olc_"+ce(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=i+(i.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(n)}class p0 extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class m0 extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Hc(i){return new Promise(function(e,t){function r(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(c){const h="Error parsing response text as JSON: "+c.message;t(new Error(h));return}e(l);return}t(new p0(a))}function n(o){t(new m0(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",r),s.addEventListener("error",n),s.open("GET",i),s.setRequestHeader("Accept","application/json"),s.send()})}function Zc(i,e){return e.includes("://")?e:new URL(e,i).href}class Yc extends Tt{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:oe("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)bo(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=oe("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const c=gs(t,r);n=hr(e.bounds,c)}const s=Ht(r),o=e.minzoom||0,a=e.maxzoom||22,l=Wt({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=fl(e.tiles,l),e.attribution&&!this.getAttributions()){const c=n!==void 0?n:s;this.setAttributions(function(h){return ur(c,h.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}const _0="https://stac-extensions.github.io/label/v1.*/schema.json",qc=new Fi({color:"rgba(0,0,0,0)"});function Kc(i,e,t="rgba(255,255,255,0.4)",r=5){let n=qc;t&&(n=new Fi({color:t}));const s=new Ci({color:i,width:e});return new xi({image:new Sh({fill:n,stroke:s,radius:r}),fill:n,stroke:s})}const y0=Kc("#3399CC",3),Ca=Kc("#ff9933",2,null);function E0(i,e){const t={url:i.getAbsoluteUrl()};let r=i;i.getBands().length===1&&(r=i.getBand(0));const{minimum:n,maximum:s}=r.getMinMaxValues();typeof n=="number"&&(t.min=n),typeof s=="number"&&(t.max=s);const o=r.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function Fa(i,e=void 0){let t=e;if(Rh()){const r=i.getMetadata("proj:code");if(r)try{if(r.startsWith("EPSG:")){const n=parseInt(r.replace("EPSG:",""),10);t=await vh(n)}}catch{}}return t}function Oa(i,e){const t=i.clone();return e.hasOnlyBounds()||t.setFill(qc),t}function x0(i){let e=i.href;if(e.includes("{s}"))if(Array.isArray(i["href:servers"])&&i["href:servers"].length>0){const t=Math.random()*i["href:servers"].length|0;e=e.replace("{s}",i["href:servers"][t])}else return null;return e}var Jc=Object.defineProperty,Ma=Object.getOwnPropertySymbols,b0=Object.prototype.hasOwnProperty,T0=Object.prototype.propertyIsEnumerable,Na=(i,e,t)=>e in i?Jc(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ji=(i,e)=>{for(var t in e||(e={}))b0.call(e,t)&&Na(i,t,e[t]);if(Ma)for(var t of Ma(e))T0.call(e,t)&&Na(i,t,e[t]);return i},pn=(i,e)=>Jc(i,"name",{value:e,configurable:!0}),w0=(i,e,t)=>new Promise((r,n)=>{var s=l=>{try{a(t.next(l))}catch(c){n(c)}},o=l=>{try{a(t.throw(l))}catch(c){n(c)}},a=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(i,e)).next())}),Qc=class extends ni{constructor(e){super(ji(ji({},e),{state:"loading"})),this.loadImage=pn(r=>new Promise((n,s)=>{const o=new Image;o.addEventListener("load",()=>n(o)),o.addEventListener("error",()=>s(new Error("load failed"))),o.src=r}),"loadImage");const t=new Xr(e.url);t.getHeader().then(r=>{const n=e.projection===void 0?"EPSG:3857":e.projection;this.tileGrid=e.tileGrid||Wt({extent:Ht(n),maxResolution:e.maxResolution,minZoom:r.minZoom,maxZoom:r.maxZoom,tileSize:e.tileSize}),this.setLoader((s,o,a)=>w0(this,null,function*(){const l=yield t.getZxy(s,o,a);if(!l)return new Uint8Array;const c=URL.createObjectURL(new Blob([l.data])),h=yield this.loadImage(c);return URL.revokeObjectURL(c),h})),this.setState("ready")})}};pn(Qc,"PMTilesRasterSource");var Da=Qc,eu=class extends Ss{constructor(e){super(ji(ji({},e),{state:"loading",url:"pmtiles://{z}/{x}/{y}",format:e.format||new Ph})),this.tileLoadFunction=pn((t,r)=>{const n=t,s=new RegExp(/pmtiles:\/\/(\d+)\/(\d+)\/(\d+)/),o=r.match(s);if(!(o&&o.length>=4))throw Error("Could not parse tile URL");const a=+o[1],l=+o[2],c=+o[3];n.setLoader((h,u,f)=>{this.pmtiles_.getZxy(a,l,c).then(g=>{if(g){const d=n.getFormat();n.setFeatures(d.readFeatures(g.data,{extent:h,featureProjection:f})),n.setState(q.LOADED)}else n.setFeatures([]),n.setState(q.EMPTY)}).catch(g=>{n.setFeatures([]),n.setState(q.ERROR)})})},"tileLoadFunction"),this.pmtiles_=new Xr(e.url),this.pmtiles_.getHeader().then(t=>{const r=e.projection||"EPSG:3857",n=e.extent||Ht(r);this.tileGrid=e.tileGrid||Wt({extent:n,maxResolution:e.maxResolution,maxZoom:e.maxZoom!==void 0?e.maxZoom:t.maxZoom,minZoom:t.minZoom,tileSize:e.tileSize||512}),this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}};pn(eu,"PMTilesVectorSource");var S0=eu;class To extends Xh{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(r=>t[r]=e[r]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||y0,this.collectionStyle_=e.collectionStyle||Ca,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(r){this.handleError_(r)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(r=>this.configure_(r,e.url,e.children,e.assets,e.bands)).catch(r=>this.handleError_(r))}async fetch_(e,t="json"){const r=await fetch(e);if(!r.ok)throw new Error(`Unexpected response from ${e}: ${r.status}`);return t==="json"?await r.json():t==="text"?await r.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const r=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!r||Ji(r)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new p_(e))}configure_(e,t=null,r=null,n=null,s=[]){let o;e instanceof ui||e instanceof Ar?o=e:(o=hi(e,!this.disableMigration_),t&&t.includes("://")&&o.setAbsoluteUrl(t)),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(Oa(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=u=>this.handleError_(u),c=this.setChildren(r).catch(l),h=this.setAssets(n).catch(l);Promise.all([c,h]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const r=e.map(n=>{const s={data:n,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new To(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(r)}async addPreviewImage_(e){const t=await Fa(e,"EPSG:4326"),r=e.getContext().getBoundingBoxes();if(r.length!==1)return;const n=r[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:Bn(n,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(pe.ImageStatic,s,e));const o=new dl({source:new Wc(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=x0(e);if(!t)return;const r={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},n=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new Xr(r.url).getHeader();let l;switch(a.tileType){case nr.Mvt:l=new S0(await n(pe.PMTilesVector,r));break;case nr.Avif:case nr.Jpeg:case nr.Png:case nr.Webp:l=new Da(await n(pe.PMTilesRaster,r));break;default:return}s.push(l);break;case"tilejson":s.push(new Yc(await n(pe.TileJSON,r)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const u in e["wms:layers"]){const f=e["wms:layers"][u]||"";let g="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][u]=="string"&&(g=e["wms:styles"][u]);const d=Object.assign({LAYERS:f,STYLES:g},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(d.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(d.FORMAT=e.type);const p=await n(pe.TileWMS,Object.assign({},r,{params:d}));s.push(new Lh(p))}break;case"wmts":const c=await this.getWmtsCapabilities_(t);if(!c)return;const h=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const u of h){let f=Object.assign({},r,{layer:u});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await n(pe.WMTS,f),s.push(new Ah(gl(c,f)))}break;case"xyz":s.push(new Oi(await n(pe.XYZ,r)));break;default:return}return s.map(o=>{let a;return o instanceof Ss?a=new Ih({source:o,declutter:!0}):o instanceof Da?a=new ki({source:o}):a=new jn({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let r={sources:[E0(e,this.bands_)],convertToRGB:"auto"};const n=await Fa(e);n&&(r.projection=n),this.getSourceOptions_&&(r=await this.getSourceOptions_(pe.GeoTIFF,r,e));const s=new xo(r),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new ki({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let r={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(r=await this.getSourceOptions_(pe.XYZ,r,e));const n=new jn({source:new Oi(r)});return this.addLayer_(n,e),n}addLayer_(e,t=null,r=0){t&&e.set("stac",t),e.setZIndex(r),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Yh(t.getBoundingBox()):e=t.toGeoJSON(),e){const r=this.createGeoJsonLayer_(e,Oa(this.boundsStyle_,this),this.displayFootprint_);return r.set("bounds",!0),r.on("change",()=>this.setMap_(r.getMapInternal())),this.addLayer_(r,t,1),r}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),r=this.createGeoJsonLayer_(t);return this.addLayer_(r,e),r}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,r=!0){const n=new el,s=new tn({format:n,loader:(o,a,l)=>{e=qh(e);const c=n.readFeatures(e,{featureProjection:l});s.addFeatures(c)}});return t||(t=Ca),new al({source:s,style:t,visible:r})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof As))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),r;t.length>1&&(r=t.find(s=>s.roles.includes("labels-vector"))),r||(r=e.getAsset("vector_labels")),r||(t=e.getAssets().filter(s=>s.type===Bo&&!s.roles),t.length===1&&(r=t[0]));const n=e.getLinksWithRels(["source"]);if(r&&n.length>0){const s=n.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return hi(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof Ar);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(r)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let n=e.getLength()-1;n>=0;n--){const s=e.item(n);s.get("stac")&&!s.get("bounds")&&e.removeAt(n)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const n=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(n)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const r=this.getAssets();if(r){const n=r.map(async s=>{if(s){if(s.type===Bo)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(n)}if(this.hasOnlyBounds()){if(t instanceof Ls)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof Ar){if(t.isItem()&&t.supportsExtension(_0)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const n=this.getWebMapLinks();if(n.length>0)await this.addLayerForLink(n[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(r=>r!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof ui)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let r=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?r=this.displayWebMapLink_.map(n=>{if(typeof n=="string"){const s=r.find(o=>o.id===n);return s||null}return n}).filter(n=>!!n):r.sort((n,s)=>{const o=t.indexOf(n.rel),a=t.indexOf(s.rel);return o-a}),r}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(r=>t instanceof Ar&&typeof r=="string"?t.getAsset(r):r instanceof ui?r:new ui(r))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t=null){e instanceof Tl?this.children_=e.getAll():Go(e)&&e.type==="FeatureCollection"?this.children_=hi(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(r=>r instanceof Ar?r:hi(r,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.children_&&Go(t)&&(this.childrenOptions_=t),await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const r=this.getData();r&&(t=r.getBoundingBox());const n=this.getChildren();if(n){const s=n.map(o=>o.getBoundingBox());t=Ps(s)}if(t)return Bn(t,"EPSG:4326",e.getProjection())}getLayerState(){const e=super.getLayerState();return e.extent=void 0,e}getAttributions(){const e=[],t=this.getData();if(t){const r=t.getMetadata("attribution");r&&r.push(r)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const r=await this.fetch_(t.toString(),"text");return new $s().read(r)}catch{return null}}}Ch(Fh);window.eoxMapAdvancedOlLayers={Graticule:Dp,Heatmap:Cm,Image,Layer:bs,VectorImage:Mm,WebGLPoints:Dm,WebGLTile:ki,WebGLVector:Um,STAC:To};function R0(i){const e=i[0],t=new Array(e);let r=1<<e-1,n,s;for(n=0;n<e;++n)s=48,i[1]&r&&(s+=1),i[2]&r&&(s+=2),t[n]=String.fromCharCode(s),r>>=1;return t.join("")}const v0='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class P0 extends Tt{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:oe("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const r="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(r).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],r=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=Ht(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=Wt({extent:s,minZoom:t.zoomMin,maxZoom:r,tileSize:a});this.tileGrid=l;const c=this.culture_,h=this.hidpi_,u=this.placeholderTiles_;if(this.tileUrlFunction=Rs(t.imageUrlSubdomains.map(function(f){const g=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",c);return function(p,m,y){if(!p)return;kn(p[0],p[1],p[2],g);const _=new URL(d.replace("{quadkey}",R0(g))),E=_.searchParams;return h&&(E.set("dpi","d1"),E.set("device","mobile")),u===!0?E.delete("n"):u===!1&&E.set("n","z"),_.toString()}})),t.imageryProviders){const f=gs(oe("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const d=[],p=g.viewState,m=this.getTileGrid(),y=m.getZForResolution(p.resolution,this.zDirection),E=m.getTileCoordForCoordAndZ(p.center,y)[0];return t.imageryProviders.map(function(w){let S=!1;const T=w.coverageAreas;for(let v=0,I=T.length;v<I;++v){const A=T[v];if(E>=A.zoomMin&&E<=A.zoomMax){const R=A.bbox,M=[R[1],R[0],R[3],R[2]],N=hr(M,f);if(ur(N,g.extent)){S=!0;break}}}S&&d.push(w.attribution)}),d.push(v0),d})}this.setState("ready")}}class A0 extends Oi{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const r=new XMLHttpRequest;r.addEventListener("load",this.handleInitResponse_.bind(this,e)),r.addEventListener("error",this.handleInitError_.bind(this)),r.open("POST",t),r.setRequestHeader("Content-type","application/json"),r.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const r=t.target;if(!r.status||r.status>=200&&r.status<300){let n;try{n=JSON.parse(r.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}const L0="https://tile.googleapis.com/v1/createSession",I0="https://tile.googleapis.com/v1/2dtiles",C0="https://tile.googleapis.com/tile/v1/viewport",F0=22;class O0 extends Tt{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const r={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(r.imageFormat=e.imageFormat),e.scale&&(r.scale=e.scale),t&&(r.highDpi=!0),e.layerTypes&&(r.layerTypes=e.layerTypes),e.styles&&(r.styles=e.styles),e.overlay===!0&&(r.overlay=!0),e.apiOptions&&(r.apiOptions=e.apiOptions),this.sessionTokenRequest_=r,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=L0+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},r=await this.fetchSessionToken(e,t);if(!r.ok){try{const u=await r.json();this.error_=new Error(u.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await r.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=Wt({extent:Ht(this.getProjection()),maxZoom:F0,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const l=this.apiKey_;this.tileUrlFunction=function(u,f,g){const d=u[0],p=u[1],m=u[2];return`${I0}/${d}/${p}/${m}?session=${a}&key=${l}`};const c=parseInt(n.expiry,10)*1e3,h=Math.max(c-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),h),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[Mt.ANIMATING]||e.viewHints[Mt.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,r]=Oo(Wu(e.extent),e.viewState.projection),[n,s]=Oo(Hu(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${r}&east=${n}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const c=this.sessionTokenValue_,h=this.apiKey_,u=`${C0}?session=${c}&key=${h}&${l}`;return this.previousViewportAttribution_=await fetch(u).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let tu=class extends Es{constructor(e,t,r,n,s,o,a){super(t,r,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==q.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const r=Ft(t[0],t[1]);return r.drawImage(e,0,0),this.zoomifyImage_=r.canvas,r.canvas}return e}};class M0 extends Tt{constructor(e){const t=e.size,r=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||Vn;let c=l*n;switch(r){case"default":for(;s>c||o>c;)a.push([Math.ceil(s/c),Math.ceil(o/c)]),c+=c;break;case"truncated":let T=s,v=o;for(;T>c||v>c;)a.push([Math.ceil(T/c),Math.ceil(v/c)]),T>>=1,v>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const h=[n],u=[0];for(let T=1,v=a.length;T<v;T++)h.push(n<<T),u.push(a[T-1][0]*a[T-1][1]+u[T-1]);h.reverse();const f=new sn({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:h});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const d=pl(g);let p=l*n;function m(T){return function(v,I,A){if(!v)return;const R=v[0],M=v[1],N=v[2],k=M+N*a[R][0],j=(k+u[R])/p|0,B={z:R,x:M,y:N,tileIndex:k,TileGroup:"TileGroup"+j};return T.replace(/\{(\w+?)\}/g,function(ee,G){return B[G]})}}const y=Rs(d.map(m)),_=tu.bind(null,it(l*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const E=f.getTileCoordForCoordAndResolution(Lt(f.getExtent()),h[h.length-1]),w=y(E,1,null),S=new Image;S.addEventListener("error",()=>{p=l,this.changed()}),S.src=w}}function Lr(i){return i.toLocaleString("en",{maximumFractionDigits:10})}class N0 extends Tt{constructor(e){const t=e||{};let r=t.url||"";r=r+(r.lastIndexOf("/")===r.length-1||r===""?"":"/");const n=t.version||Te.VERSION2,s=t.sizes||[],o=t.size;Je(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],c=t.tileSize,h=t.tilePixelRatio||1,u=t.format||"jpg",f=t.quality||(t.version==Te.VERSION1?"native":"default");let g=t.resolutions||[];const d=t.supports||[],p=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=c!==void 0&&(typeof c=="number"&&Number.isInteger(c)&&c>0||Array.isArray(c)&&c.length>0),_=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let E,w,S;if(g.sort(function(A,R){return R-A}),y||_)if(c!=null&&(typeof c=="number"&&Number.isInteger(c)&&c>0?(E=c,w=c):Array.isArray(c)&&c.length>0&&((c.length==1||c[1]==null&&Number.isInteger(c[0]))&&(E=c[0],w=c[0]),c.length==2&&(Number.isInteger(c[0])&&Number.isInteger(c[1])?(E=c[0],w=c[1]):c[0]==null&&Number.isInteger(c[1])&&(E=c[1],w=c[1])))),(E===void 0||w===void 0)&&(E=Vn,w=Vn),g.length==0){S=Math.max(Math.ceil(Math.log(a/E)/Math.LN2),Math.ceil(Math.log(l/w)/Math.LN2));for(let A=S;A>=0;A--)g.push(Math.pow(2,A))}else{const A=Math.max(...g);S=Math.round(Math.log(A)/Math.LN2)}else if(E=a,w=l,g=[],m){s.sort(function(R,M){return R[0]-M[0]}),S=-1;const A=[];for(let R=0;R<s.length;R++){const M=a/s[R][0];if(g.length>0&&g[g.length-1]==M){A.push(R);continue}g.push(M),S++}if(A.length>0)for(let R=0;R<A.length;R++)s.splice(A[R]-R,1)}else g.push(1),s.push([a,l]),S=0;const T=new sn({tileSize:[E,w],extent:p,origin:Gn(p),resolutions:g}),v=function(A,R,M){let N,k;const j=A[0];if(j>S)return;const B=A[1],ee=A[2],G=g[j];if(!(B===void 0||ee===void 0||G===void 0||B<0||Math.ceil(a/G/E)<=B||ee<0||Math.ceil(l/G/w)<=ee)){if(_||y){const ae=B*E*G,H=ee*w*G;let ne=E*G,ge=w*G,be=E,re=w;if(ae+ne>a&&(ne=a-ae),H+ge>l&&(ge=l-H),ae+E*G>a&&(be=Math.floor((a-ae+G-1)/G)),H+w*G>l&&(re=Math.floor((l-H+G-1)/G)),ae==0&&ne==a&&H==0&&ge==l)N="full";else if(!_||d.includes("regionByPx"))N=ae+","+H+","+ne+","+ge;else if(d.includes("regionByPct")){const ve=Lr(ae/a*100),Se=Lr(H/l*100),Re=Lr(ne/a*100),Oe=Lr(ge/l*100);N="pct:"+ve+","+Se+","+Re+","+Oe}n==Te.VERSION3&&(!_||d.includes("sizeByWh"))?k=be+","+re:!_||d.includes("sizeByW")?k=be+",":d.includes("sizeByH")?k=","+re:d.includes("sizeByWh")?k=be+","+re:d.includes("sizeByPct")&&(k="pct:"+Lr(100/G))}else if(N="full",m){const ae=s[j][0],H=s[j][1];n==Te.VERSION3?ae==a&&H==l?k="max":k=ae+","+H:ae==a?k="full":k=ae+","}else k=n==Te.VERSION3?"max":"full";return r+N+"/"+k+"/0/"+f+"."+u}},I=tu.bind(null,it(c||256).map(function(A){return A*h}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:I,tileGrid:T,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:v,transition:t.transition}),this.zDirection=t.zDirection}}function ru(i,e,t,r,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/r,l=[No(Ce(e)/a,Uo),No(rt(e)/a,Uo)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*r:90*r);const c=i.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Mi(c,s)}function D0(i){const e=i.load?i.load:Er,t=oe(i.projection||"EPSG:3857"),r=i.ratio??1.5,n=i.crossOrigin??null;return function(s,o,a){a=i.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,i.params),s=ml(s,o,a,r);const c=ru(i.url,s,o,a,t,l),h=new Image;return h.crossOrigin=n,e(h,c).then(u=>{const f=Ce(s)/u.width*a;return{image:u,extent:s,resolution:f,pixelRatio:a}})}}class U0 extends Zt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=D0({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Er(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class B0 extends Zt{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,r,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==r&&Si(s.getExtent(),e))return s;e=e.slice(),il(e,this.ratio_);const o=Ce(e)/t,a=rt(e)/t,l=[o*r,a*r],c=this.canvasFunction_.call(this,e,t,r,l,n);return c&&(s=new Ks(e,t,r,c)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function G0(i,e,t,r){const n=Ce(i),s=rt(i),o=e[0],a=e[1],l=.0254/r;return a*n>o*s?n*t/(o*l):s*t/(a*l)}function z0(i,e,t,r,n,s,o){const a=G0(t,r,s,o),l=Lt(t),c={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(r[0]),SETDISPLAYHEIGHT:Math.round(r[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(c,e),Mi(i,c)}function $0(i){const e=i.load||Er,t=i.useOverlay??!1,r=i.metersPerUnit||1,n=i.displayDpi||96,s=i.ratio??1,o=i.crossOrigin??null;return function(a,l,c){const h=new Image;h.crossOrigin=o,a=ml(a,l,c,s);const u=Ce(a)/l,f=rt(a)/l,g=[u*c,f*c],d=z0(i.url,i.params,a,g,t,r,n);return e(h,d).then(p=>({image:p,extent:a,pixelRatio:c}))}}class k0 extends Zt{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:ws,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,r,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=$0({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Er(s))})),super.getImageInternal(e,t,r,n))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const j0=new Error("Image failed to load");function iu(i,e,t,r,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(j0)),a.src=_l(i,e,t,r,n.maxY)})}function Ua(i){return function(e,t,r,n){const s=Oh(i,e,t,r);return iu(s,e,t,r,n)}}function V0(i){return function(e,t,r,n){const s=i(e,t,r,n);return iu(s,e,t,r,n)}}function Ba(i){let e;if(Array.isArray(i))e=Ua(i);else if(typeof i=="string"){const t=pl(i);e=Ua(t)}else if(typeof i=="function")e=V0(i);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let Ga=0;function za(i){return Array.isArray(i)?i.join(`
`):typeof i=="string"?i:(++Ga,"url-function-key-"+Ga)}class nu extends ni{constructor(e){e=e||{};let t=e.loader,r;e.url&&(t=Ba(e.url),r=za(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:r,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Ba(e);this.setLoader(t),this.setKey(za(e)),this.getState()!=="ready"&&this.setState("ready")}}const X0={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},W0={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function su(i,e){if(!e.length)return i;const t=new URL(i,"file:/");if(t.pathname.split("/").includes("collections"))return $r('The "collections" query parameter cannot be added to collection endpoints'),i;const r=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",r);const n=i.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function H0(i,e,t){let r,n;for(let s=0;s<i.length;++s){const o=i[s];if(o.rel==="item"){if(o.type===e){r=o.href;break}(X0[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!r)if(n)r=n;else throw new Error('Could not find "item" link');return t&&(r=su(r,t)),r}function Z0(i,e,t,r){let n,s;const o={};for(let a=0;a<i.length;++a){const l=i[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){n=l.href;break}W0[l.type]&&(s=l.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){n=o[l];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return r&&(n=su(n,r)),n}function $a(i,e,t,r){let n=i.projection;if(!n&&(typeof e.crs=="string"?n=oe(e.crs):"uri"in e.crs&&(n=oe(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(T=>T.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,c={};for(let T=0;T<l.length;++T){const v=l[T];c[v.id]=v}const h={},u=[];if(r)for(let T=0;T<r.length;++T){const v=r[T],I=v.tileMatrix;u.push(I),h[I]=v}else for(let T=0;T<l.length;++T){const v=l[T].id;u.push(v)}const f=u.length,g=new Array(f),d=new Array(f),p=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let T=0;T<f;++T){const v=u[T],I=c[v],A=I.pointOfOrigin;a?g[T]=[A[1],A[0]]:g[T]=A,d[T]=I.cellSize,p[T]=[I.matrixWidth,I.matrixHeight],m[T]=[I.tileWidth,I.tileHeight];const R=h[v];if(R){const M=I.cellSize*I.tileWidth,N=g[T][0]+R.minTileCol*M,k=g[T][0]+(R.maxTileCol+1)*M,j=I.cellSize*I.tileHeight,B=I.cornerOfOrigin==="bottomLeft";let ee,G;B?(ee=g[T][1]+R.minTileRow*j,G=g[T][1]+(R.maxTileRow+1)*j):(ee=g[T][1]-(R.maxTileRow+1)*j,G=g[T][1]-R.minTileRow*j),ft(y,[N,ee,k,G],y)}}const _=new sn({origins:g,resolutions:d,sizes:p,tileSizes:m,extent:r?y:void 0}),E=i.context,w=i.url;function S(T,v,I){if(!T)return;const A=u[T[0]],R=c[A],M=R.cornerOfOrigin==="bottomLeft",N={tileMatrix:A,tileCol:T[1],tileRow:M?-T[2]-1:T[2]};if(r){const j=h[R.id];if(N.tileCol<j.minTileCol||N.tileCol>j.maxTileCol||N.tileRow<j.minTileRow||N.tileRow>j.maxTileRow)return}Object.assign(N,E);const k=t.replace(/\{(\w+?)\}/g,function(j,B){return N[B]});return Zc(w,k)}return{grid:_,projection:n,urlTemplate:t,urlFunction:S}}function Y0(i,e){const t=e.tileMatrixSetLimits;let r;if(e.dataType==="map")r=H0(e.links,i.mediaType,i.collections);else if(e.dataType==="vector")r=Z0(e.links,i.mediaType,i.supportedMediaTypes,i.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return $a(i,e.tileMatrixSet,r,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=Zc(i.url,s);return Hc(o).then(function(a){return $a(i,a,r,t)})}function ou(i){return Hc(i.url).then(function(e){return Y0(i,e)})}class q0 extends Tt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};ou(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){$r(e),this.setState("error")}}class K0 extends Ss{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};ou(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){$r(e),this.setState("error")}}function au(i){return function(e){const t=e.buffers,r=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(n){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return i(f,r).data.buffer}const c=new Uint8ClampedArray(l),h=new Array(a),u=new Array(a);for(let f=0;f<a;++f)h[f]=new Uint8ClampedArray(t[f]),u[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const p=h[d];u[d][0]=p[f],u[d][1]=p[f+1],u[d][2]=p[f+2],u[d][3]=p[f+3]}const g=i(u,r);c[f]=g[0],c[f+1]=g[1],c[f+2]=g[2],c[f+3]=g[3]}return c.buffer}}function J0(i,e){const r=Object.keys(i.lib||{}).map(function(s){return"const "+s+" = "+i.lib[s].toString()+";"}).concat(["const __minion__ = ("+au.toString()+")(",i.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(r.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(r,{type:"text/javascript"})));return n.addEventListener("message",e),n}function Q0(i,e){const t=au(i.operation);let r=!1;return{postMessage:function(n){setTimeout(function(){r||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){r=!0}}}class eE extends rl{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const r=new Array(t);if(t)for(let n=0;n<t;++n)r[n]=J0(e,this.onWorkerMessage_.bind(this,n));else r[0]=Q0(e,this.onWorkerMessage_.bind(this,0));this.workers_=r,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,r){this.enqueue_({inputs:e,meta:t,callback:r}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,r=e.inputs[0].height,n=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const c=l*a,h=[];for(let u=0,f=n.length;u<f;++u)h.push(n[u].slice(c,c+a));this.workers_[l].postMessage({buffers:h,meta:e.meta,imageOps:this.imageOps_,width:t,height:r},h)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let r,n;if(t===1)r=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;r=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,c=a*o;r.set(new Uint8ClampedArray(l),c),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(r,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const ka={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class ja extends nl{constructor(e,t,r){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=r}}class lu extends Zt{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=iE(e.sources);const t=this.changed.bind(this);for(let r=0,n=this.layers_.length;r<n;++r)this.layers_[r].addEventListener(Be.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Mh(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Ie(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:rE(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Ie(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:ce(this),renderTargets:{}},this.setAttributions(function(r){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],c=l instanceof vs?l:l.getSource();if(!c)continue;const h=(s=c.getAttributions())==null?void 0:s(r);typeof h=="string"?n.push(h):h!==void 0&&n.push(...h)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new eE({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,r){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=Lt(e);n.size[0]=Math.ceil(Ce(e)/t),n.size[1]=Math.ceil(rt(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=r,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let r=0,n=this.layers_.length;r<n;++r)if(t=this.layers_[r].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,r,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!kr(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,r=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=tE(this.layers_[s],e);if(o)r[s]=o;else return}const n={};this.dispatchEvent(new ja(ka.BEFOREOPERATIONS,e,n)),this.processor_.process(r,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,r,n){if(t||!r)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!kr(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Ce(s)/o),c=Math.round(rt(s)/o);a=Ft(l,c),this.renderedImageCanvas_=new Ks(s,o,1,a.canvas)}a.putImageData(r,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new ja(ka.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let r=0,n=this.layers_.length;r<n&&(t=this.layers_[r].getSource().getResolutions(e),!t);++r);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}lu.prototype.dispose;let zt=null;function tE(i,e){const t=i.getRenderer();if(!t)throw new Error("Unsupported layer type: "+i);if(!t.prepareFrame(e))return null;const r=e.size[0],n=e.size[1];if(r===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===r&&o.height===n)return o.getContext("2d").getImageData(0,0,r,n)}if(!zt)zt=Ft(r,n,void 0,{willReadFrequently:!0});else{const a=zt.canvas;a.width!==r||a.height!==n?zt=Ft(r,n,void 0,{willReadFrequently:!0}):zt.clearRect(0,0,r,n)}return zt.drawImage(o,0,0,r,n),zt.getImageData(0,0,r,n)}function rE(i){return i.map(function(e){return e.getLayerState()})}function iE(i){const e=i.length,t=new Array(e);for(let r=0;r<e;++r)t[r]=nE(i[r]);return t}function nE(i){let e;return i instanceof vs?i instanceof Ts?e=new jn({source:i}):i instanceof Zt&&(e=new dl({source:i})):e=i,e}const sE='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',oE='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',aE='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',lE={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},cE={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class uE extends Oi{constructor(e){const t=e.layer.indexOf("-"),r=t==-1?e.layer:e.layer.slice(0,t),n=cE[r]||{minZoom:0,maxZoom:20,retina:!0},s=lE[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,c=[sE,oE,Nh];e.layer.startsWith("stamen_")&&c.splice(1,0,aE),super({attributions:c,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class hE extends Tt{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=Yr(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const r in this.params_)t[e++]=r+"-"+this.params_[r];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,r,n,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const c=Zu(Dh(e),a.length);l=a[c]}return ru(l,r,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,r){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(r)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=it(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Uh(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,r,a)}}class fE extends nu{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",r=e.source;super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:r!==void 0?r.getWrapX():void 0});const n=()=>{var o;this.projection=e.projection!==void 0?oe(e.projection):r!==void 0?r.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:r!==void 0?r.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:r!==void 0?r.zDirection:this.zDirection,r instanceof ni&&(this.transformMatrix=((o=r.transformMatrix)==null?void 0:o.slice())||null);const s=this.tileGrid;s&&this.setTileSizes(s.getResolutions().map((a,l)=>it(s.getTileSize(l)).map(c=>Math.max(Math.floor(c),1)))),this.setLoader((a,l,c,h)=>{const u=_l(t,a,l,c,h.maxY),[f,g]=this.getTileSize(a),d=Ft(f,g);return d.strokeStyle="grey",d.strokeRect(.5,.5,f+.5,g+.5),d.fillStyle="grey",d.strokeStyle="white",d.textAlign="center",d.textBaseline="middle",d.font="24px sans-serif",d.lineWidth=4,d.strokeText(u,f/2,g/2,f),d.fillText(u,f/2,g/2,f),Promise.resolve(d.canvas)}),this.setState("ready")};if(r===void 0||r.getState()==="ready")n();else{const s=()=>{r.getState()==="ready"&&(r.removeEventListener(Be.CHANGE,s),n())};r.addEventListener(Be.CHANGE,s)}}}class dE extends zh{constructor(e,t,r,n,s,o){super(e,t),this.src_=r,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),r=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-r)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,r){this.state==q.EMPTY&&r===!0?(this.state=q.IDLE,Yu(this,Be.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):r===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=q.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=q.LOADED,this.changed()}loadInternal_(){if(this.state==q.IDLE)if(this.state=q.LOADING,this.jsonp_)bo(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(r)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(q.EMPTY)}}class gE extends Ts{constructor(e){if(super({projection:oe("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=Bh,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new ll(512),e.url)if(this.jsonp_)bo(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let r;try{r=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(r)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,r,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==q.IDLE&&a.load(),a.forDataAtCoordinate(e,r,n)}else n===!0?setTimeout(function(){r(null)},0):r(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=oe("EPSG:4326"),r=this.getProjection();let n;if(e.bounds!==void 0){const h=gs(t,r);n=hr(e.bounds,h)}const s=Ht(r),o=e.minzoom||0,a=e.maxzoom||22,l=Wt({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const c=e.grids;if(!c){this.setState("error");return}if(this.tileUrlFunction_=fl(c,l),e.attribution){const h=n!==void 0?n:s;this.setAttributions(function(u){return ur(h,u.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,r,n,s){const o=[e,t,r],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,n,s),c=`${this.getKey()},${Gh(e,t,r)}`;if(this.tileCache_.containsKey(c))return this.tileCache_.get(c);this.tileCache_.expireCache();const h=new dE(o,l!==void 0?q.IDLE:q.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(c,h),h}}class pE extends tn{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const r=t.getGeometry();return Je(!r||r.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),r},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,r){var n;(n=this.source)==null||n.loadFeatures(e,t,r),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(Be.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(Be.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const r=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==r;this.distance=e,this.minDistance=t,this.interpolationRatio=r,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=Yr(),t=this.distance*this.resolution,r=this.source.getFeatures(),n={};for(let s=0,o=r.length;s<o;s++){const a=r[s];if(!(ce(a)in n)){const l=this.geometryFunction(a);if(l){const c=l.getCoordinates();qu(c,e),_s(e,t,e);const h=this.source.getFeaturesInExtent(e).filter(function(u){const f=ce(u);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(h,e))}}}}createCluster(e,t){const r=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Fu(r,l.getCoordinates()):e.splice(a,1)}Ou(r,1/e.length);const n=Lt(t),s=this.interpolationRatio,o=new et([r[0]*(1-s)+n[0]*s,r[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new Ke({geometry:o,features:e})}}class Vi extends pE{constructor(e={}){super({...e,createCluster:Vi.defaultCreateCluster,geometryFunction:Vi.defaultGeometryFunction})}static defaultCreateCluster(e,t){const r=t.length===1&&t[0].getGeometry()instanceof cr?t[0].getGeometry():e,n=new Ke({geometry:r,features:t});if(t.length===1){const s=t[0];for(const o in s.getProperties())o!=="geometry"&&n.set(o,s.get(o))}return n}static defaultGeometryFunction(e){const t=e&&e.getGeometry();return t instanceof et?t:t instanceof cr?t.getInteriorPoint():null}}class mE extends Tt{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new $s().read(e),s=gl(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=Rs(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,r={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(r,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Mi(e,r):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in r?r[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=Mi(l,a):l=l.replace(/\{(\w+?)\}/g,(c,h)=>a[h]),l}}}const _t=new Uint8Array([102,103,98,3,102,103,98,0]),Xe=4,Ir=4,Cr=4,si=4,vt=new Int32Array(2),Va=new Float32Array(vt.buffer),Xa=new Float64Array(vt.buffer),_i=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var ss;(function(i){i[i.UTF8_BYTES=1]="UTF8_BYTES",i[i.UTF16_STRING=2]="UTF16_STRING"})(ss||(ss={}));class nt{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new nt(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return vt[0]=this.readInt32(e),Va[0]}readFloat64(e){return vt[_i?0:1]=this.readInt32(e),vt[_i?1:0]=this.readInt32(e+4),Xa[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Va[0]=t,this.writeInt32(e,vt[0])}writeFloat64(e,t){Xa[0]=t,this.writeInt32(e,vt[_i?0:1]),this.writeInt32(e+4,vt[_i?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+Ir+Cr)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<Cr;t++)e+=String.fromCharCode(this.readInt8(this.position_+Ir+t));return e}__offset(e,t){const r=e-this.readInt32(e);return t<this.readInt16(r)?this.readInt16(r+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const r=this.readInt32(e);e+=Ir;const n=this.bytes_.subarray(e,e+r);return t===ss.UTF8_BYTES?n:this.text_decoder_.decode(n)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+Ir}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=Cr)throw new Error("FlatBuffers: file identifier must be length "+Cr);for(let t=0;t<Cr;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+Ir+t))return!1;return!0}createScalarList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s)}return r}createObjList(e,t){const r=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&r.push(s.unpack())}return r}}var le,Le=((le={})[le.Byte=0]="Byte",le[le.UByte=1]="UByte",le[le.Bool=2]="Bool",le[le.Short=3]="Short",le[le.UShort=4]="UShort",le[le.Int=5]="Int",le[le.UInt=6]="UInt",le[le.Long=7]="Long",le[le.ULong=8]="ULong",le[le.Float=9]="Float",le[le.Double=10]="Double",le[le.String=11]="String",le[le.Json=12]="Json",le[le.DateTime=13]="DateTime",le[le.Binary=14]="Binary",le);class Pe{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Pe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+si),(t||new Pe).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):Le.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,Le.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,r,n,s,o,a,l,c,h,u,f){return Pe.startColumn(e),Pe.addName(e,t),Pe.addType(e,r),Pe.addTitle(e,n),Pe.addDescription(e,s),Pe.addWidth(e,o),Pe.addPrecision(e,a),Pe.addScale(e,l),Pe.addNullable(e,c),Pe.addUnique(e,h),Pe.addPrimaryKey(e,u),Pe.addMetadata(e,f),Pe.endColumn(e)}}var J,Me=((J={})[J.Unknown=0]="Unknown",J[J.Point=1]="Point",J[J.LineString=2]="LineString",J[J.Polygon=3]="Polygon",J[J.MultiPoint=4]="MultiPoint",J[J.MultiLineString=5]="MultiLineString",J[J.MultiPolygon=6]="MultiPolygon",J[J.GeometryCollection=7]="GeometryCollection",J[J.CircularString=8]="CircularString",J[J.CompoundCurve=9]="CompoundCurve",J[J.CurvePolygon=10]="CurvePolygon",J[J.MultiCurve=11]="MultiCurve",J[J.MultiSurface=12]="MultiSurface",J[J.Curve=13]="Curve",J[J.Surface=14]="Surface",J[J.PolyhedralSurface=15]="PolyhedralSurface",J[J.TIN=16]="TIN",J[J.Triangle=17]="Triangle",J);class Ue{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+si),(t||new Ue).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):Me.Unknown}parts(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Ue).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addInt32(t[r]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addInt64(t[r]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,Me.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,r,n,s,o,a,l,c){return Ue.startGeometry(e),Ue.addEnds(e,t),Ue.addXy(e,r),Ue.addZ(e,n),Ue.addM(e,s),Ue.addT(e,o),Ue.addTm(e,a),Ue.addType(e,l),Ue.addParts(e,c),Ue.endGeometry(e)}}class qe{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new qe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+si),(t||new qe).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Ue).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let r=this.bb.__offset(this.bb_pos,8);return r?(t||new Pe).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let r=t.length-1;r>=0;r--)e.addInt8(t[r]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,r,n){return qe.startFeature(e),qe.addGeometry(e,t),qe.addProperties(e,r),qe.addColumns(e,n),qe.endFeature(e)}}function Nn(i,e){let t=[];for(let r=0;r<i.length;r+=2){let n=[i[r],i[r+1]];e&&n.push(e[r>>1]),t.push(n)}return t}new TextEncoder;let Wa=new TextDecoder;function _E(i,e){let t={};if(!e||e.length===0)return t;let r=i.propertiesArray();if(!r)return t;let n=new DataView(r.buffer,r.byteOffset),s=i.propertiesLength(),o=0;for(;o<s;){let a=n.getUint16(o,!0);o+=2;let l=e[a],c=l.name;switch(l.type){case Le.Bool:t[c]=!!n.getUint8(o),o+=1;break;case Le.Byte:t[c]=n.getInt8(o),o+=1;break;case Le.UByte:t[c]=n.getUint8(o),o+=1;break;case Le.Short:t[c]=n.getInt16(o,!0),o+=2;break;case Le.UShort:t[c]=n.getUint16(o,!0),o+=2;break;case Le.Int:t[c]=n.getInt32(o,!0),o+=4;break;case Le.UInt:t[c]=n.getUint32(o,!0),o+=4;break;case Le.Long:t[c]=Number(n.getBigInt64(o,!0)),o+=8;break;case Le.ULong:t[c]=Number(n.getBigUint64(o,!0)),o+=8;break;case Le.Float:t[c]=n.getFloat32(o,!0),o+=4;break;case Le.Double:t[c]=n.getFloat64(o,!0),o+=8;break;case Le.DateTime:case Le.String:{let h=n.getUint32(o,!0);o+=4,t[c]=Wa.decode(r.subarray(o,o+h)),o+=h;break}case Le.Json:{let h=n.getUint32(o,!0);o+=4;let u=Wa.decode(r.subarray(o,o+h));t[c]=JSON.parse(u),o+=h;break}case Le.Binary:{let h=n.getUint32(o,!0);o+=4,t[c]=r.subarray(o,o+h),o+=h;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const wo=new Uint8Array(0);function yE(){return this._source.cancel()}function EE(i,e){if(!i.length)return e;if(!e.length)return i;var t=new Uint8Array(i.length+e.length);return t.set(i),t.set(e,i.length),t}function xE(){var i=this,e=i._array.subarray(i._index);return i._source.read().then(function(t){return i._array=wo,i._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:EE(e,t.value)}})}function bE(i){if((i|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+i<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=i));var r=new Uint8Array(i);return r.set(this._array.subarray(this._index)),function n(){return e._source.read().then(function(s){return s.done?(e._array=wo,e._index=0,t>0?r.subarray(0,t):null):t+s.value.length>=i?(e._array=s.value,e._index=i-t,r.set(s.value.subarray(0,i-t),t),r):(r.set(s.value,t),t+=s.value.length,n())})}()}function TE(i){return typeof i.slice=="function"?i:new mn(typeof i.read=="function"?i:i.getReader())}function mn(i){this._source=i,this._array=wo,this._index=0}mn.prototype.read=xE;mn.prototype.slice=bE;mn.prototype.cancel=yE;class Ye{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Ye).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+si),(t||new Ye).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,r,n,s,o,a){return Ye.startCrs(e),Ye.addOrg(e,t),Ye.addCode(e,r),Ye.addName(e,n),Ye.addDescription(e,s),Ye.addWkt(e,o),Ye.addCodeString(e,a),Ye.endCrs(e)}}class Xi{constructor(){Q(this,"bb",null);Q(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new Xi).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+si),(t||new Xi).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):Me.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let r=this.bb.__offset(this.bb_pos,18);return r?(t||new Pe).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+r)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Ye).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let r=t.length-1;r>=0;r--)e.addFloat64(t[r]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,Me.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let r=t.length-1;r>=0;r--)e.addOffset(t[r]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function _n(i){let e=Xi.getRootAsHeader(i),t=e.featuresCount(),r=e.indexNodeSize(),n=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");n.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:n,envelope:null,featuresCount:Number(t),indexNodeSize:r,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const qi=class qi{constructor(){Q(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};Q(qi,"global",new qi);let Wi=qi;const wE=40,SE=16;function yn(i,e){e=Math.min(Math.max(+e,2),65535);let t=i,r=t;do r+=t=Math.ceil(t/e);while(t!==1);return 40*r}function RE(i,e){if(e<2)throw Error("Node size must be at least 2");if(i===0)throw Error("Number of items must be greater than 0");let t=i,r=t,n=[t];do r+=t=Math.ceil(t/e),n.push(t);while(t!==1);let s=[];for(let a of(t=r,n))s.push(t-a),t-=a;let o=[];for(let a=0;a<n.length;a++)o.push([s[a],s[a]+n[a]]);return o}async function*cu(i,e,t,r){class n{constructor(g,d){Q(this,"_level");Q(this,"nodes");this._level=d,this.nodes=g}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(g){this.nodes[1]=g}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,c=RE(i,e),h=c[0][0],u=[new n([0,1],c.length-1)];for(;u.length!==0;){let f=u.shift(),g=f.startNodeIdx(),d=g>=h,p=(()=>{let[,_]=c[f.level()],E=Math.min(f.endNodeIdx()+e,_);return d&&E<_?E+1:E})(),m=p-g,y=new DataView(await r(40*g,40*m));for(let _=g;_<p;_++){let E=_-g,w=40*E;if(a<y.getFloat64(w+0,!0)||l<y.getFloat64(w+8,!0)||s>y.getFloat64(w+16,!0)||o>y.getFloat64(w+24,!0))continue;let S=y.getBigUint64(w+32,!0);if(d){let A=(()=>{if(_<i-1){let M=(E+1)*40;return y.getBigUint64(M+32,!0)-S}return null})(),R=_-h;yield[Number(S),R,Number(A)];continue}let T=Wi.global.extraRequestThreshold()/40,v=u[u.length-1];if(v!==void 0&&v.level()===f.level()-1&&S<v.endNodeIdx()+T){v.extendEndNodeIdx(Number(S));continue}let I=(()=>{let A=f.level()-1;return new n([Number(S),Number(S)+1],A)})();v!==void 0&&(v.level(),I.level()),u.push(I)}}}class So{constructor(e,t,r,n){Q(this,"bytes");Q(this,"header");Q(this,"headerLength");Q(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=r,this.indexLength=n}static open(e){if(!e.subarray(0,3).every((o,a)=>_t[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let r=e.subarray(12,12+t),n=_n(new nt(r)),s=yn(n.featuresCount,n.indexNodeSize);return new So(e,n,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=async(n,s)=>{let o=t+n;return this.bytes.slice(o,o+s).buffer};for await(let n of cu(this.header.featuresCount,this.header.indexNodeSize,e,r)){let[s,o]=n,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return _t.length+Xe+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),r=new DataView(this.bytes.buffer).getUint32(t,!0),n=this.bytes.subarray(t+4,t+4+r),s=new Uint8Array(r+Xe);s.set(n,Xe);let o=new nt(s);return o.setPosition(Xe),qe.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var os=function(i,e){return os=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,r){t.__proto__=r}||function(t,r){for(var n in r)r.hasOwnProperty(n)&&(t[n]=r[n])},os(i,e)};function vE(i,e){os(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function mr(i,e,t,r){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(h){try{c(r.next(h))}catch(u){o(u)}}function l(h){try{c(r.throw(h))}catch(u){o(u)}}function c(h){h.done?s(h.value):n(h.value).then(a,l)}c((r=r.apply(i,[])).next())})}function Nt(i,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},r,n,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(c){return function(h){return l([c,h])}}function l(c){if(r)throw new TypeError("Generator is already executing.");for(;t;)try{if(r=1,n&&(s=c[0]&2?n.return:c[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,c[1])).done)return s;switch(n=0,s&&(c=[c[0]&2,s.value]),c[0]){case 0:case 1:s=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,n=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!s||c[1]>s[0]&&c[1]<s[3])){t.label=c[1];break}if(c[0]===6&&t.label<s[1]){t.label=s[1],s=c;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(c);break}s[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(i,t)}catch(h){c=[6,h],n=0}finally{r=s=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function Pr(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],r=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&r>=i.length&&(i=void 0),{value:i&&i[r++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function Hr(i){return this instanceof Hr?(this.v=i,this):new Hr(i)}function PE(i,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(i,e||[]),n,s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(f){r[f]&&(n[f]=function(g){return new Promise(function(d,p){s.push([f,g,d,p])>1||a(f,g)})})}function a(f,g){try{l(r[f](g))}catch(d){u(s[0][3],d)}}function l(f){f.value instanceof Hr?Promise.resolve(f.value.v).then(c,h):u(s[0][2],f)}function c(f){a("next",f)}function h(f){a("throw",f)}function u(f,g){f(g),s.shift(),s.length&&a(s[0][0],s[0][1])}}var uu=function(i){vE(e,i);function e(t){var r=i.call(this,t)||this;return Object.defineProperty(r,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(r,r.constructor.prototype):r.__proto__=r.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(r,r.constructor),r}return e}(Error);(function(){function i(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),i.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();(function(){function i(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(i.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),i.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},i.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},i})();function as(i){i!=null&&typeof i.then=="function"&&i.then(Yi,Yi)}var Dn=0,Ha=1,Xt=2,Hi=3,ls=4,Zi=1024,Yi=function(){};function lr(i){var e=i.err,t=Promise.resolve(i.execution).then(function(r){if(e!=null)throw e;return r});return i.err=void 0,i.execution=t.then(function(){},function(){}),i.pending===void 0?t:i.pending.then(function(){return t})}function jt(i,e){var t=i.state>=Hi;return Promise.resolve(e).then(function(r){return!t&&i.state>=ls?lr(i).then(function(n){return{value:n,done:!0}}):{value:r,done:t}})}function Ro(i,e){var t,r;if(!(i.state>=Xt))if(i.state=Xt,i.onnext(),i.onstop(),i.err==null&&(i.err=e),i.pushes.length===0&&(typeof i.buffer>"u"||i.buffer.empty))Ur(i);else try{for(var n=Pr(i.pushes),s=n.next();!s.done;s=n.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(r=n.return)&&r.call(n)}finally{if(t)throw t.error}}}function Ur(i){var e,t;if(!(i.state>=Hi)){i.state<Xt&&Ro(i),i.state=Hi,i.buffer=void 0;try{for(var r=Pr(i.nexts),n=r.next();!n.done;n=r.next()){var s=n.value,o=i.pending===void 0?lr(i):i.pending.then(function(){return lr(i)});s.resolve(jt(i,o))}}catch(a){e={error:a}}finally{try{n&&!n.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}i.pushes=[],i.nexts=[]}}function Za(i){i.state>=ls||(i.state<Hi&&Ur(i),i.state=ls)}function AE(i,e){if(as(e),i.pushes.length>=Zi)throw new uu("No more than "+Zi+" pending calls to push are allowed on a single repeater.");if(i.state>=Xt)return Promise.resolve(void 0);var t=i.pending===void 0?Promise.resolve(e):i.pending.then(function(){return e});t=t.catch(function(l){i.state<Xt&&(i.err=l),Za(i)});var r;if(i.nexts.length){var n=i.nexts.shift();n.resolve(jt(i,t)),i.nexts.length?r=Promise.resolve(i.nexts[0].value):typeof i.buffer<"u"&&!i.buffer.full?r=Promise.resolve(void 0):r=new Promise(function(l){return i.onnext=l})}else typeof i.buffer<"u"&&!i.buffer.full?(i.buffer.add(t),r=Promise.resolve(void 0)):r=new Promise(function(l){return i.pushes.push({resolve:l,value:t})});var s=!0,o={},a=r.catch(function(l){if(s)throw l});return o.then=function(l,c){return s=!1,Promise.prototype.then.call(r,l,c)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(r,l)},o.finally=r.finally.bind(r),i.pending=t.then(function(){return a}).catch(function(l){i.err=l,Za(i)}),o}function LE(i){var e=Ro.bind(null,i),t=new Promise(function(r){return i.onstop=r});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function IE(i){if(!(i.state>=Ha)){i.state=Ha;var e=AE.bind(null,i),t=LE(i);i.execution=new Promise(function(r){return r(i.executor(e,t))}),i.execution.catch(function(){return Ro(i)})}}var yi=new WeakMap,oi=function(){function i(e,t){yi.set(this,{executor:e,buffer:t,err:void 0,state:Dn,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:Yi,onstop:Yi})}return i.prototype.next=function(e){as(e);var t=yi.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=Zi)throw new uu("No more than "+Zi+" pending calls to next are allowed on a single repeater.");if(t.state<=Dn&&IE(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var r=jt(t,t.buffer.remove());if(t.pushes.length){var n=t.pushes.shift();t.buffer.add(n.value),t.onnext=n.resolve}return r}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,jt(t,s.value)}else if(t.state>=Xt)return Ur(t),jt(t,lr(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},i.prototype.return=function(e){as(e);var t=yi.get(this);if(t===void 0)throw new Error("WeakMap error");return Ur(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),jt(t,lr(t))},i.prototype.throw=function(e){var t=yi.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=Dn||t.state>=Xt||typeof t.buffer<"u"&&!t.buffer.empty?(Ur(t),t.err==null&&(t.err=e),jt(t,lr(t))):this.next(Promise.reject(e))},i.prototype[Symbol.asyncIterator]=function(){return this},i.race=CE,i.merge=FE,i.zip=OE,i.latest=ME,i}();function En(i,e){var t,r,n=[],s=function(c){c!=null&&typeof c[Symbol.asyncIterator]=="function"?n.push(c[Symbol.asyncIterator]()):c!=null&&typeof c[Symbol.iterator]=="function"?n.push(c[Symbol.iterator]()):n.push(function(){return PE(this,arguments,function(){return Nt(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,Hr(c)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,Hr(c)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=Pr(i),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(c){t={error:c}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}function CE(i){var e=this,t=En(i,{returnValues:!0});return new oi(function(r,n){return mr(e,void 0,void 0,function(){var s,o,a,l,c,h;return Nt(this,function(u){switch(u.label){case 0:if(!t.length)return n(),[2];o=!1,n.then(function(){s(),o=!0}),u.label=1;case 1:u.trys.push([1,,5,7]),l=void 0,c=0,h=function(){var f,g,d,p,m,y;return Nt(this,function(_){switch(_.label){case 0:f=c;try{for(g=(m=void 0,Pr(t)),d=g.next();!d.done;d=g.next())p=d.value,Promise.resolve(p.next()).then(function(E){E.done?(n(),a===void 0&&(a=E)):c===f&&(c++,s(E))},function(E){return n(E)})}catch(E){m={error:E}}finally{try{d&&!d.done&&(y=g.return)&&y.call(g)}finally{if(m)throw m.error}}return[4,new Promise(function(E){return s=E})];case 1:return l=_.sent(),l===void 0?[3,3]:[4,r(l.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},u.label=2;case 2:return o?[3,4]:[5,h()];case 3:return u.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return n(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return u.sent(),[7];case 7:return[2]}})})})}function FE(i){var e=this,t=En(i,{yieldValues:!0});return new oi(function(r,n){return mr(e,void 0,void 0,function(){var s,o,a,l=this;return Nt(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2];s=[],o=!1,n.then(function(){var h,u;o=!0;try{for(var f=Pr(s),g=f.next();!g.done;g=f.next()){var d=g.value;d()}}catch(p){h={error:p}}finally{try{g&&!g.done&&(u=f.return)&&u.call(f)}finally{if(h)throw h.error}}}),c.label=1;case 1:return c.trys.push([1,,3,4]),[4,Promise.all(t.map(function(h,u){return mr(l,void 0,void 0,function(){var f,g;return Nt(this,function(d){switch(d.label){case 0:d.trys.push([0,,6,9]),d.label=1;case 1:return o?[3,5]:(Promise.resolve(h.next()).then(function(p){return s[u](p)},function(p){return n(p)}),[4,new Promise(function(p){s[u]=p})]);case 2:return f=d.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,r(f.value)];case 3:d.sent(),d.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return g=h.return,g?[4,h.return()]:[3,8];case 7:g=d.sent(),d.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return c.sent(),[2,a&&a.value];case 3:return n(),[7];case 4:return[2]}})})})}function OE(i){var e=this,t=En(i,{returnValues:!0});return new oi(function(r,n){return mr(e,void 0,void 0,function(){var s,o,a,l;return Nt(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2,[]];o=!1,n.then(function(){s(),o=!0}),c.label=1;case 1:c.trys.push([1,,6,8]),c.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(h){return h.next()})).then(function(h){return s(h)},function(h){return n(h)}),[4,new Promise(function(h){return s=h})]);case 3:return a=c.sent(),a===void 0?[2]:(l=a.map(function(h){return h.value}),a.some(function(h){return h.done})?[2,l]:[4,r(l)]);case 4:return c.sent(),[3,2];case 5:return[3,8];case 6:return n(),[4,Promise.all(t.map(function(h){return h.return&&h.return()}))];case 7:return c.sent(),[7];case 8:return[2]}})})})}function ME(i){var e=this,t=En(i,{yieldValues:!0,returnValues:!0});return new oi(function(r,n){return mr(e,void 0,void 0,function(){var s,o,a,l,c,h=this;return Nt(this,function(u){switch(u.label){case 0:if(!t.length)return n(),[2,[]];o=[],a=!1,n.then(function(){var f,g;s();try{for(var d=Pr(o),p=d.next();!p.done;p=d.next()){var m=p.value;m()}}catch(y){f={error:y}}finally{try{p&&!p.done&&(g=d.return)&&g.call(d)}finally{if(f)throw f.error}}a=!0}),u.label=1;case 1:return u.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return n(f)}),[4,new Promise(function(f){return s=f})];case 2:return l=u.sent(),l===void 0?[2]:(c=l.map(function(f){return f.value}),l.every(function(f){return f.done})?[2,c]:[4,r(c.slice())]);case 3:return u.sent(),[4,Promise.all(t.map(function(f,g){return mr(h,void 0,void 0,function(){var d;return Nt(this,function(p){switch(p.label){case 0:if(l[g].done)return[2,l[g].value];p.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[g](m)},function(m){return n(m)}),[4,new Promise(function(m){return o[g]=m})]);case 2:return d=p.sent(),d===void 0?[2,l[g].value]:d.done?[2,d.value]:(c[g]=d.value,[4,r(c.slice())]);case 3:return p.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,u.sent()];case 5:return n(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return u.sent(),[7];case 7:return[2]}})})})}class vo{constructor(e,t,r,n,s,o={}){Q(this,"headerClient");Q(this,"header");Q(this,"headerLength");Q(this,"indexLength");Q(this,"nocache");Q(this,"headers");this.headerClient=e,this.header=t,this.headerLength=r,this.indexLength=n,this.nocache=s,this.headers=o}static async open(e,t,r={}){let n,s=new Ya(e,t,r),o=2024+(()=>{let h,u=0;for(h=0;h<3;h++)u+=SE**h*wE;return u})();if(!new Uint8Array(await s.getRange(0,8,o,"header")).subarray(0,3).every((h,u)=>_t[u]===h))throw Error("Not a FlatGeobuf file");if((n=new DataView(await s.getRange(8,4,o,"header")).getUint32(0,!0))>10485760||n<8)throw Error("Invalid header size");let a=await s.getRange(12,n,o,"header"),l=_n(new nt(new Uint8Array(a)));if(l.indexNodeSize===0)throw Error("No index found, cannot read features filtered by bbox");let c=yn(l.featuresCount,l.indexNodeSize);return new vo(s,l,n,c,t,r)}async*selectBbox(e){let t=this.lengthBeforeTree(),r=this.headerClient,n=async(l,c)=>r.getRange(t+l,c,0,"index"),s=[],o=[];for await(let l of cu(this.header.featuresCount,this.header.indexNodeSize,e,n)){let[c,h]=l,[,,u]=l;if(u||(u=4),o.length===0){o.push([c,u,h]);continue}let f=o[o.length-1];c-(f[0]+f[1])>Wi.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([c,u,h])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*oi.merge(a)}lengthBeforeTree(){return _t.length+Xe+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Ya(this.headerClient.httpClient,e,this.headers)}async*readFeatureBatch(e,t){let[r]=e[0],[n,s]=e[e.length-1],o=this.buildFeatureClient(t),a=n+s-r;for(let[l,,c]of e){let h=await this.readFeature(o,l,a);yield{id:c,feature:h},a=0}o.logUsage("feature")}async readFeature(e,t,r){let n,s=t+this.lengthBeforeFeatures();n=new DataView(await e.getRange(s,4,r,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,n,r,"feature data")),a=new Uint8Array(n+Xe);a.set(o,Xe);let l=new nt(a);return l.setPosition(Xe),qe.getRootAsFeature(l)}}class Ya{constructor(e,t,r={}){Q(this,"httpClient");Q(this,"bytesEverUsed",0);Q(this,"bytesEverFetched",0);Q(this,"buffer",new ArrayBuffer(0));Q(this,"head",0);if(typeof e=="string")this.httpClient=new qa(e,t,r);else if(e instanceof qa)this.httpClient=e;else throw Error("Unknown source")}async getRange(e,t,r,n){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,r);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,n),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class qa{constructor(e,t,r={}){Q(this,"url");Q(this,"nocache");Q(this,"headers");Q(this,"requestsEverMade",0);Q(this,"bytesEverRequested",0);this.url=e,this.nocache=t,this.headers=r}async getRange(e,t,r){this.requestsEverMade+=1,this.bytesEverRequested+=t;let n=`bytes=${e}-${e+t-1}`,s=new Headers(this.headers);return s.set("Range",n),this.nocache&&s.set("Cache-Control","no-cache, no-store"),await(await fetch(this.url,{headers:s})).arrayBuffer()}}async function*NE(i,e,t,r){if(!i.subarray(0,3).every((u,f)=>_t[f]===u))throw Error("Not a FlatGeobuf file");if(t){let u=So.open(i);for await(let f of u.selectBbox(t))yield e(f.id,f.feature,u.header);return}let n=new nt(i),s=n.readUint32(_t.length);n.setPosition(_t.length+Xe);let o=_n(n),a=_t.length+Xe+s,{indexNodeSize:l,featuresCount:c}=o;l>0&&(a+=yn(c,l));let h=0;for(;a<n.capacity();){let u=n.readUint32(a);n.setPosition(a+Xe);let f=qe.getRootAsFeature(n);yield e(h++,f,o),a+=Xe+u}}async function*DE(i,e,t){let r,n=TE(i),s=async g=>await n.slice(g),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((g,d)=>_t[d]===g))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new nt(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let c=_n(a=new nt(o)),{indexNodeSize:h,featuresCount:u}=c;if(h>0){let g=yn(u,h);await s(g)}let f=0;for(;r=await BE(s,c,e,f++);)yield r}async function*UE(i,e,t,r,n=!1,s={}){let o=await vo.open(i,n,s);for await(let a of o.selectBbox(e))yield t(a.id,a.feature,o.header)}async function BE(i,e,t,r){let n=new Uint8Array(await i(4,"feature length"));if(n.byteLength===0)return;let s=new nt(n),o=s.readUint32(0);n=new Uint8Array(await i(o,"feature data"));let a=new Uint8Array(o+4);return a.set(n,4),(s=new nt(a)).setPosition(Xe),t(r,qe.getRootAsFeature(s),e)}function cs(i,e){let t=e;if(t===Me.Unknown&&(t=i.type()),t===Me.GeometryCollection){let n=[];for(let s=0;s<i.partsLength();s++){let o=i.parts(s),a=o.type();n.push(cs(o,a))}return{type:Me[t],geometries:n}}if(t===Me.MultiPolygon){let n=[];for(let s=0;s<i.partsLength();s++)n.push(cs(i.parts(s),Me.Polygon));return{type:Me[t],coordinates:n.map(s=>s.coordinates)}}let r=function(n,s){let o=n.xyArray(),a=n.zArray();switch(s){case Me.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case Me.MultiPoint:case Me.LineString:return Nn(o,a);case Me.MultiLineString:case Me.Polygon:return function(l,c,h){let u;if(!h||h.length===0)return[Nn(l,c)];let f=0,g=Array.from(h).map(d=>l.slice(f,f=d<<1));return c&&(f=0,u=Array.from(h).map(d=>c.slice(f,f=d))),g.map((d,p)=>Nn(d,u?u[p]:void 0))}(o,a,n.endsArray())}}(i,t);return{type:Me[t],coordinates:r}}function Po(i,e,t){let r=t.columns;return{type:"Feature",id:i,geometry:cs(e.geometry(),t.geometryType),properties:_E(e,r)}}async function*GE(i,e,t){yield*NE(i,Po,e)}function zE(i,e){return DE(i,Po)}function $E(i,e,t,r=!1,n={}){return UE(i,e,Po,t,r,n)}function kE(i,e,t,r=!1,n={}){return i instanceof Uint8Array?GE(i,e):i instanceof ReadableStream?zE(i):$E(i,e,t,r,n)}const Ka=new el({featureProjection:"EPSG:3857"});class jE extends tn{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:Ka,strategy:$h}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const r=Bn(e,t.getCode(),"EPSG:4326");return{minX:r[0],minY:r[1],maxX:r[2],maxY:r[3]}}async loader(e,t,r,n,s){const o=this.fgbBoundingBox(e,r);try{if(o.minX!==-1/0){const a=[],l=kE(this.ressourceURL,o);for await(const c of l){const h=Ka.readFeature(c);a.push(h)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:P0,CartoDB:A0,Cluster:Vi,DataTile:ni,GeoTIFF:xo,Google:O0,IIIF:N0,Image:Zt,ImageArcGISRest:U0,ImageCanvas:B0,ImageMapGuide:k0,ImageStatic:Wc,ImageTile:nu,OGCMapTile:q0,OGCVectorTile:K0,Raster:lu,Source:vs,StadiaMaps:uE,TileArcGISRest:hE,TileDebug:fE,TileImage:Tt,TileJSON:Yc,UrlTile:kh,UTFGrid:gE,Zoomify:M0,WMTSCapabilities:mE,FlatGeoBuf:jE};const fx=Object.freeze(Object.defineProperty({__proto__:null},Symbol.toStringTag,{value:"Module"}));export{ax as L,lx as a,fx as i};
