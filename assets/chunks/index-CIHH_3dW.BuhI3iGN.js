const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/raw.DxtaBMev.js","assets/chunks/basedecoder.B2c5_Eok.js","assets/chunks/lzw.BikwkTY2.js","assets/chunks/jpeg.CbvpOiPg.js","assets/chunks/deflate.B4_27dB1.js","assets/chunks/pako.esm.BkaqWuDM.js","assets/chunks/packbits.D6Qr5eNi.js","assets/chunks/lerc.bDO2HJ0q.js","assets/chunks/commonjsHelpers.BosuxZz1.js","assets/chunks/main.B1iv-XOF.js","assets/chunks/lit-element.Deg-YTNa.js","assets/chunks/Group.BYuZJ7Kt.js","assets/chunks/getElement.Cn_OkwFN.js","assets/chunks/GeoJSON.D6-lg-cz.js","assets/chunks/mustache.BduQOOTh.js","assets/chunks/framework.aZ46aqSj.js","assets/chunks/eo-dash.BafBzV9i.js","assets/chunks/webimage.CU41Mh7j.js"])))=>i.map(i=>d[i]);
var ch=Object.defineProperty;var uh=(r,e,t)=>e in r?ch(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var re=(r,e,t)=>uh(r,typeof e!="symbol"?e+"":e,t);import{X as xn,m as V,a as $,p as O,g as Wi,b as hh,c as Ut,d as H,e as T,f as _e,h as qe,w as ee,O as Ar,r as Nt,i as Qr,j as Gl,k as ji,l as Hi,n as D,o as b,q as F,s as En,t as Te,u as De,v as zl,x as Zi,y as jt,z as fh,A as Bs,B as fe,C as it,D as mt,T as dh,K as gh,E as ph,F as mh,V as kl,S as Yi,G as zi,H as oa,I as qi,R as Zt,J as bn,L as _h,M as K,N as Gs,P as st,Q as yh,U as zs,W as os,Y as as,Z as zt,_ as xh,$ as zn,a0 as Eh,a1 as ls,a2 as $l,a3 as hr,a4 as ci,a5 as bh,a6 as Th,a7 as oe,a8 as Tn,a9 as ei,aa as We,ab as kt,ac as Pr,ad as wh,ae as Z,af as Vl,ag as Xl,ah as Sh,ai as vh,aj as Dt,ak as $t,al as wn,am as Wl,an as Yt,ao as Rh,ap as Ah,aq as Ph,ar as Lh,as as ks,at as Ih,au as Ch,av as Fh,aw as Oh,ax as Mh,ay as Nh,az as $s,aA as ui,aB as hi,aC as Dh,aD as Uh,aE as kn,aF as Sn,aG as Lr,aH as tr,aI as Vs,aJ as Ft,aK as jl,aL as Bh,aM as Gh,aN as zh,aO as Xs,aP as kh,aQ as Hl,aR as Ki,aS as $h,aT as Zl,aU as Vh,aV as Xh,aW as cs,aX as Wh,aY as jh,aZ as Ws,a_ as us,a$ as Yl,b0 as Ji,b1 as ql,b2 as aa,b3 as Hh,b4 as Kl,b5 as Zh,b6 as js,b7 as Yh,b8 as qh,b9 as Kh,ba as Jh,bb as Qh,bc as ef,bd as tf,be as rf}from"./main.B1iv-XOF.js";import{J as nf,F as lt,g as ce,t as Ue,d as sf,l as of,L as hs,M as vn,a as fi,b as Hs,P as Rn,c as Lt,e as xt,f as Zs,G as af,h as lf,i as cf,j as uf,k as ti,S as la,m as hf,n as Qi,o as ri,p as ca,q as ki,r as Ce,s as Ys,u as ff,v as ua,w as df,x as qs,y as Jl,z as It,R as gf,A as pf,B as Ql,C as ii,D as mf,E as ni,H as _f,I as yf,K as xf,N as ha,O as fa,Q as Ks,T as fs,U as ec,V as Ef,W as bf,X as da}from"./GeoJSON.D6-lg-cz.js";import{i as Tf,c as en,e as tn,a as tc,b as et,d as Js,f as Qs,s as wf,w as Sf,h as vf,j as Et,k as si,l as An,m as Bt,n as Er,o as Fe,p as Ee,q as br,r as pr,t as he,D as rc,u as Rf,T as Af,E as ze,v as Pf,x as Lf,y as If,z as di,A as Rt,B as eo,C as rn,F as ic,G as ot,H as nc,I as Cf,J as ds,K as ga,L as Ff,M as Of,N as Mf,O as Nf,P as Df,Q as pa,R as Uf,S as Bf}from"./getElement.Cn_OkwFN.js";import{T as sc,W as Gf,m as zf}from"./mustache.BduQOOTh.js";import{C as kf,a as gs,L as $f}from"./Group.BYuZJ7Kt.js";import{g as to}from"./commonjsHelpers.BosuxZz1.js";import{a0 as Xt,p as sr,ak as ma,h as $n,v as oc,c as Vf,o as Xf,j as Li,N as _a,k as ya,x as ac,q as Wf,P as xa,aE as jf}from"./framework.aZ46aqSj.js";import{p as Hf,U as ps,q as Ii,s as ms,a as _s,i as Zf,h as Yf,d as Ea,f as Vn,l as qt,r as qf,n as Kf,k as Jf,t as Hr,j as Qf,v as ed,E as ba,w as td}from"./eo-dash.BafBzV9i.js";const rd={Point:od,LineString:ad,Polygon:hd,MultiPoint:cd,MultiLineString:ld,MultiPolygon:ud},id={Point:fd,LineString:dd,Polygon:gd,MultiPoint:md,MultiLineString:pd,MultiPolygon:_d};class nd extends nf{constructor(e){e=e||{},super(),this.geometryName_=e.geometryName}readFeatureFromObject(e,t,i){const n=e,s=Ta(n.geometry,t),o=new lt;if(this.geometryName_&&o.setGeometryName(this.geometryName_),o.setGeometry(s),n.attributes){o.setProperties(n.attributes,!0);const a=n.attributes[i];a!==void 0&&o.setId(a)}return o}readFeaturesFromObject(e,t){if(t=t||{},e.features){const i=e,n=[],s=i.features;for(let o=0,a=s.length;o<a;++o)n.push(this.readFeatureFromObject(s[o],t,e.objectIdFieldName));return n}return[this.readFeatureFromObject(e,t)]}readGeometryFromObject(e,t){return Ta(e,t)}readProjectionFromObject(e){if(e.spatialReference&&e.spatialReference.wkid!==void 0){const i=e.spatialReference.wkid;return ce("EPSG:"+i)}return null}writeGeometryObject(e,t){return wa(e,this.adaptOptions(t))}writeFeatureObject(e,t){t=this.adaptOptions(t);const i={};if(!e.hasProperties())return i.attributes={},i;const n=e.getProperties(),s=e.getGeometry();if(s){i.geometry=wa(s,t);const o=t&&(t.dataProjection||t.featureProjection);o&&(i.geometry.spatialReference={wkid:Number(ce(o).getCode().split(":").pop())}),delete n[e.getGeometryName()]}return Tf(n)?i.attributes={}:i.attributes=n,i}writeFeaturesObject(e,t){t=this.adaptOptions(t);const i=[];for(let n=0,s=e.length;n<s;++n)i.push(this.writeFeatureObject(e[n],t));return{features:i}}}function Ta(r,e){if(!r)return null;let t;if(typeof r.x=="number"&&typeof r.y=="number")t="Point";else if(r.points)t="MultiPoint";else if(r.paths)r.paths.length===1?t="LineString":t="MultiLineString";else if(r.rings){const n=r,s=Ir(n),o=sd(n.rings,s);o.length===1?(t="Polygon",r=Object.assign({},r,{rings:o[0]})):(t="MultiPolygon",r=Object.assign({},r,{rings:o}))}const i=rd[t];return Ue(i(r),!1,e)}function sd(r,e){const t=[],i=[],n=[];let s,o;for(s=0,o=r.length;s<o;++s)t.length=0,sf(t,0,r[s],e.length),of(t,0,t.length,e.length)?i.push([r[s]]):n.push(r[s]);for(;n.length;){const a=n.shift();let l=!1;for(s=i.length-1;s>=0;s--){const c=i[s][0];if(en(new hs(c).getExtent(),new hs(a).getExtent())){i[s].push(a),l=!0;break}}l||i.push([a.reverse()])}return i}function od(r){let e;return r.m!==void 0&&r.z!==void 0?e=new xt([r.x,r.y,r.z,r.m],"XYZM"):r.z!==void 0?e=new xt([r.x,r.y,r.z],"XYZ"):r.m!==void 0?e=new xt([r.x,r.y,r.m],"XYM"):e=new xt([r.x,r.y]),e}function ad(r){const e=Ir(r);return new Lt(r.paths[0],e)}function ld(r){const e=Ir(r);return new fi(r.paths,e)}function Ir(r){let e="XY";return r.hasZ===!0&&r.hasM===!0?e="XYZM":r.hasZ===!0?e="XYZ":r.hasM===!0&&(e="XYM"),e}function cd(r){const e=Ir(r);return new Hs(r.points,e)}function ud(r){const e=Ir(r);return new vn(r.rings,e)}function hd(r){const e=Ir(r);return new Rn(r.rings,e)}function fd(r,e){const t=r.getCoordinates();let i;const n=r.getLayout();if(n==="XYZ")i={x:t[0],y:t[1],z:t[2]};else if(n==="XYM")i={x:t[0],y:t[1],m:t[2]};else if(n==="XYZM")i={x:t[0],y:t[1],z:t[2],m:t[3]};else if(n==="XY")i={x:t[0],y:t[1]};else throw new Error("Invalid geometry layout");return i}function gi(r){const e=r.getLayout();return{hasZ:e==="XYZ"||e==="XYZM",hasM:e==="XYM"||e==="XYZM"}}function dd(r,e){const t=gi(r);return{hasZ:t.hasZ,hasM:t.hasM,paths:[r.getCoordinates()]}}function gd(r,e){const t=gi(r);return{hasZ:t.hasZ,hasM:t.hasM,rings:r.getCoordinates(!1)}}function pd(r,e){const t=gi(r);return{hasZ:t.hasZ,hasM:t.hasM,paths:r.getCoordinates()}}function md(r,e){const t=gi(r);return{hasZ:t.hasZ,hasM:t.hasM,points:r.getCoordinates()}}function _d(r,e){const t=gi(r),i=r.getCoordinates(!1),n=[];for(let s=0;s<i.length;s++)for(let o=i[s].length-1;o>=0;o--)n.push(i[s][o]);return{hasZ:t.hasZ,hasM:t.hasM,rings:n}}function wa(r,e){const t=id[r.getType()];return t(Ue(r,!0,e),e)}const Pt="http://www.opengis.net/gml",yd=/^\s*$/;class B extends xn{constructor(e){super(),e=e||{},this.featureType=e.featureType,this.featureNS=e.featureNS,this.srsName=e.srsName,this.schemaLocation="",this.FEATURE_COLLECTION_PARSERS={},this.FEATURE_COLLECTION_PARSERS[this.namespace]={featureMember:$(this.readFeaturesInternal),featureMembers:V(this.readFeaturesInternal)},this.supportedMediaTypes=["application/gml+xml"]}readFeaturesInternal(e,t){const i=e.localName;let n=null;if(i=="FeatureCollection")n=O([],this.FEATURE_COLLECTION_PARSERS,e,t,this);else if(i=="featureMembers"||i=="featureMember"||i=="member"){const s=t[0];let o=s.featureType,a=s.featureNS;const l="p",c="p0";if(!o&&e.childNodes){o=[],a={};for(let f=0,g=e.childNodes.length;f<g;++f){const d=e.childNodes[f];if(d.nodeType===1){const p=d.nodeName.split(":").pop();if(!o.includes(p)){let m="",y=0;const _=d.namespaceURI;for(const E in a){if(a[E]===_){m=E;break}++y}m||(m=l+y,a[m]=_),o.push(m+":"+p)}}}i!="featureMember"&&(s.featureType=o,s.featureNS=a)}if(typeof a=="string"){const f=a;a={},a[c]=f}const u={},h=Array.isArray(o)?o:[o];for(const f in a){const g={};for(let d=0,p=h.length;d<p;++d)(h[d].includes(":")?h[d].split(":")[0]:c)===f&&(g[h[d].split(":").pop()]=i=="featureMembers"?$(this.readFeatureElement,this):V(this.readFeatureElement,this));u[a[f]]=g}i=="featureMember"||i=="member"?n=O(void 0,u,e,t):n=O([],u,e,t)}return n===null&&(n=[]),n}readGeometryOrExtent(e,t){const i=t[0];return i.srsName=e.firstElementChild.getAttribute("srsName"),i.srsDimension=e.firstElementChild.getAttribute("srsDimension"),O(null,this.GEOMETRY_PARSERS,e,t,this)}readExtentElement(e,t){const i=t[0],n=this.readGeometryOrExtent(e,t);return n?Zs(n,i):void 0}readGeometryElement(e,t){const i=t[0],n=this.readGeometryOrExtent(e,t);return n?Ue(n,!1,i):void 0}readFeatureElementInternal(e,t,i){let n;const s={};for(let l=e.firstElementChild;l;l=l.nextElementSibling){let c;const u=l.localName;l.childNodes.length===0||l.childNodes.length===1&&(l.firstChild.nodeType===3||l.firstChild.nodeType===4)?(c=Wi(l,!1),yd.test(c)&&(c=void 0)):(i&&(c=u==="boundedBy"?this.readExtentElement(l,t):this.readGeometryElement(l,t)),c?u!=="boundedBy"&&(n=u):c=this.readFeatureElementInternal(l,t,!1));const h=l.attributes.length;if(h>0&&!(c instanceof af)){c={_content_:c};for(let f=0;f<h;f++){const g=l.attributes[f].name;c[g]=l.attributes[f].value}}s[u]?(s[u]instanceof Array||(s[u]=[s[u]]),s[u].push(c)):s[u]=c}if(!i)return s;const o=new lt(s);n&&o.setGeometryName(n);const a=e.getAttribute("fid")||hh(e,this.namespace,"id");return a&&o.setId(a),o}readFeatureElement(e,t){return this.readFeatureElementInternal(e,t,!0)}readPoint(e,t){const i=this.readFlatCoordinatesFromNode(e,t);if(i)return new xt(i,"XYZ")}readMultiPoint(e,t){const i=O([],this.MULTIPOINT_PARSERS,e,t,this);if(i)return new Hs(i)}readMultiLineString(e,t){const i=O([],this.MULTILINESTRING_PARSERS,e,t,this);if(i)return new fi(i)}readMultiPolygon(e,t){const i=O([],this.MULTIPOLYGON_PARSERS,e,t,this);if(i)return new vn(i)}pointMemberParser(e,t){Ut(this.POINTMEMBER_PARSERS,e,t,this)}lineStringMemberParser(e,t){Ut(this.LINESTRINGMEMBER_PARSERS,e,t,this)}polygonMemberParser(e,t){Ut(this.POLYGONMEMBER_PARSERS,e,t,this)}readLineString(e,t){const i=this.readFlatCoordinatesFromNode(e,t);if(i)return new Lt(i,"XYZ")}readFlatLinearRing(e,t){const i=O(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this);if(i)return i}readLinearRing(e,t){const i=this.readFlatCoordinatesFromNode(e,t);if(i)return new hs(i,"XYZ")}readPolygon(e,t){const i=O([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this);if(i&&i[0]){const n=i[0],s=[n.length];let o,a;for(o=1,a=i.length;o<a;++o)tn(n,i[o]),s.push(n.length);return new Rn(n,"XYZ",s)}}readFlatCoordinatesFromNode(e,t){return O(null,this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}readGeometryFromNode(e,t){const i=this.readGeometryElement(e,[this.getReadOptions(e,t||{})]);return i||null}readFeaturesFromNode(e,t){const i={featureType:this.featureType,featureNS:this.featureNS};return i&&Object.assign(i,this.getReadOptions(e,t)),this.readFeaturesInternal(e,[i])||[]}readProjectionFromNode(e){return ce(this.srsName?this.srsName:e.firstElementChild.getAttribute("srsName"))}}B.prototype.namespace=Pt;B.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{}};B.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{}};B.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{}};B.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml":{pointMember:$(B.prototype.pointMemberParser),pointMembers:$(B.prototype.pointMemberParser)}};B.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml":{lineStringMember:$(B.prototype.lineStringMemberParser),lineStringMembers:$(B.prototype.lineStringMemberParser)}};B.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml":{polygonMember:$(B.prototype.polygonMemberParser),polygonMembers:$(B.prototype.polygonMemberParser)}};B.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml":{Point:$(B.prototype.readFlatCoordinatesFromNode)}};B.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:$(B.prototype.readLineString)}};B.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:$(B.prototype.readPolygon)}};B.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:V(B.prototype.readFlatLinearRing)}};const xd=Pt+" http://schemas.opengis.net/gml/2.1.2/feature.xsd",Ed={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class Q extends B{constructor(e){e=e||{},super(e),this.FEATURE_COLLECTION_PARSERS[Pt].featureMember=$(this.readFeaturesInternal),this.schemaLocation=e.schemaLocation?e.schemaLocation:xd}readFlatCoordinates(e,t){const i=Wi(e,!1).replace(/^\s*|\s*$/g,""),s=t[0].srsName;let o="enu";if(s){const c=ce(s);c&&(o=c.getAxisOrientation())}const a=i.trim().split(/\s+/),l=[];for(let c=0,u=a.length;c<u;c++){const h=a[c].split(/,+/),f=parseFloat(h[0]),g=parseFloat(h[1]),d=h.length===3?parseFloat(h[2]):0;o.startsWith("en")?l.push(f,g,d):l.push(g,f,d)}return l}readBox(e,t){const i=O([null],this.BOX_PARSERS_,e,t,this);return tc(i[1][0],i[1][1],i[1][3],i[1][4])}innerBoundaryIsParser(e,t){const i=O(void 0,this.RING_PARSERS,e,t,this);i&&t[t.length-1].push(i)}outerBoundaryIsParser(e,t){const i=O(void 0,this.RING_PARSERS,e,t,this);if(i){const n=t[t.length-1];n[0]=i}}GEOMETRY_NODE_FACTORY_(e,t,i){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.multiCurve;return Array.isArray(e)?i="Envelope":(i=e.getType(),i==="MultiPolygon"&&s===!0?i="MultiSurface":i==="Polygon"&&o===!0?i="Surface":i==="MultiLineString"&&a===!0&&(i="MultiCurve")),H("http://www.opengis.net/gml",i)}writeFeatureElement(e,t,i){const n=t.getId();n&&e.setAttribute("fid",n);const s=i[i.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=T(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=T(ee)))}}const u=Object.assign({},s);u.node=e,_e(u,s.serializers,qe(void 0,o),c,i,l)}writeCurveOrLineString(e,t,i){const s=i[i.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,i)}else if(e.nodeName==="Curve"){const o=H(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,i)}}writeLineStringOrCurveMember(e,t,i){const n=this.GEOMETRY_NODE_FACTORY_(t,i);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,i))}writeMultiCurveOrLineString(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();_e({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,i,void 0,this)}writeGeometryElement(e,t,i){const n=i[i.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=Zs(t,n):o=Ue(t,!0,n),_e(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],i,void 0,this)}createCoordinatesNode_(e){const t=H(e,"coordinates");return t.setAttribute("decimal","."),t.setAttribute("cs",","),t.setAttribute("ts"," "),t}writeCoordinates_(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName,a=t.getCoordinates(),l=a.length,c=new Array(l);for(let u=0;u<l;++u){const h=a[u];c[u]=this.getCoords_(h,o,s)}ee(e,c.join(" "))}writeCurveSegments_(e,t,i){const n=H(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,i)}writeSurfaceOrPolygon(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();_e({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,i,void 0,this)}else if(e.nodeName==="Surface"){const a=H(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,i)}}RING_NODE_FACTORY_(e,t,i){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),H(s.namespaceURI,o!==void 0?"innerBoundaryIs":"outerBoundaryIs")}writeSurfacePatches_(e,t,i){const n=H(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,i)}writeRing(e,t,i){const n=H(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,i)}getCoords_(e,t,i){let s=(t?ce(t).getAxisOrientation():"enu").startsWith("en")?e[0]+","+e[1]:e[1]+","+e[0];if(i){const o=e[2]||0;s+=","+o}return s}writePoint(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(a);const l=t.getCoordinates(),c=this.getCoords_(l,o,s);ee(a,c)}writeMultiPoint(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName;o&&e.setAttribute("srsName",o);const a=t.getPoints();_e({node:e,hasZ:s,srsName:o},this.POINTMEMBER_SERIALIZERS,qe("pointMember"),a,i,void 0,this)}writePointMember(e,t,i){const n=H(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,i)}writeLinearRing(e,t,i){const s=i[i.length-1].srsName;s&&e.setAttribute("srsName",s);const o=this.createCoordinatesNode_(e.namespaceURI);e.appendChild(o),this.writeCoordinates_(o,t,i)}writeMultiSurfaceOrPolygon(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();_e({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,i,void 0,this)}writeSurfaceOrPolygonMember(e,t,i){const n=this.GEOMETRY_NODE_FACTORY_(t,i);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,i))}writeEnvelope(e,t,i){const s=i[i.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];_e({node:e},this.ENVELOPE_SERIALIZERS,Ar,a,i,o,this)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,i){const n=t[t.length-1].node;return H("http://www.opengis.net/gml",Ed[n.nodeName])}}Q.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{coordinates:V(Q.prototype.readFlatCoordinates)}};Q.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{innerBoundaryIs:Q.prototype.innerBoundaryIsParser,outerBoundaryIs:Q.prototype.outerBoundaryIsParser}};Q.prototype.BOX_PARSERS_={"http://www.opengis.net/gml":{coordinates:$(Q.prototype.readFlatCoordinates)}};Q.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:V(B.prototype.readPoint),MultiPoint:V(B.prototype.readMultiPoint),LineString:V(B.prototype.readLineString),MultiLineString:V(B.prototype.readMultiLineString),LinearRing:V(B.prototype.readLinearRing),Polygon:V(B.prototype.readPolygon),MultiPolygon:V(B.prototype.readMultiPolygon),Box:V(Q.prototype.readBox)}};Q.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:T(Q.prototype.writeCurveOrLineString),MultiCurve:T(Q.prototype.writeMultiCurveOrLineString),Point:T(Q.prototype.writePoint),MultiPoint:T(Q.prototype.writeMultiPoint),LineString:T(Q.prototype.writeCurveOrLineString),MultiLineString:T(Q.prototype.writeMultiCurveOrLineString),LinearRing:T(Q.prototype.writeLinearRing),Polygon:T(Q.prototype.writeSurfaceOrPolygon),MultiPolygon:T(Q.prototype.writeMultiSurfaceOrPolygon),Surface:T(Q.prototype.writeSurfaceOrPolygon),MultiSurface:T(Q.prototype.writeMultiSurfaceOrPolygon),Envelope:T(Q.prototype.writeEnvelope)}};Q.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:T(Q.prototype.writeLineStringOrCurveMember),curveMember:T(Q.prototype.writeLineStringOrCurveMember)}};Q.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{outerBoundaryIs:T(Q.prototype.writeRing),innerBoundaryIs:T(Q.prototype.writeRing)}};Q.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:T(Q.prototype.writePointMember)}};Q.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:T(Q.prototype.writeSurfaceOrPolygonMember),polygonMember:T(Q.prototype.writeSurfaceOrPolygonMember)}};Q.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:T(ee),upperCorner:T(ee)}};const bd=Pt+" http://schemas.opengis.net/gml/3.1.1/profiles/gmlsfProfile/1.0.0/gmlsf.xsd",Td={MultiLineString:"lineStringMember",MultiCurve:"curveMember",MultiPolygon:"polygonMember",MultiSurface:"surfaceMember"};class I extends B{constructor(e){e=e||{},super(e),this.surface_=e.surface!==void 0?e.surface:!1,this.curve_=e.curve!==void 0?e.curve:!1,this.multiCurve_=e.multiCurve!==void 0?e.multiCurve:!0,this.multiSurface_=e.multiSurface!==void 0?e.multiSurface:!0,this.schemaLocation=e.schemaLocation?e.schemaLocation:bd,this.hasZ=e.hasZ!==void 0?e.hasZ:!1}readMultiCurve(e,t){const i=O([],this.MULTICURVE_PARSERS,e,t,this);if(i)return new fi(i)}readFlatCurveRing(e,t){const i=O([],this.MULTICURVE_PARSERS,e,t,this),n=[];for(let s=0,o=i.length;s<o;++s)tn(n,i[s].getFlatCoordinates());return n}readMultiSurface(e,t){const i=O([],this.MULTISURFACE_PARSERS,e,t,this);if(i)return new vn(i)}curveMemberParser(e,t){Ut(this.CURVEMEMBER_PARSERS,e,t,this)}surfaceMemberParser(e,t){Ut(this.SURFACEMEMBER_PARSERS,e,t,this)}readPatch(e,t){return O([null],this.PATCHES_PARSERS,e,t,this)}readSegment(e,t){return O([],this.SEGMENTS_PARSERS,e,t,this)}readPolygonPatch(e,t){return O([null],this.FLAT_LINEAR_RINGS_PARSERS,e,t,this)}readLineStringSegment(e,t){return O([null],this.GEOMETRY_FLAT_COORDINATES_PARSERS,e,t,this)}interiorParser(e,t){const i=O(void 0,this.RING_PARSERS,e,t,this);i&&t[t.length-1].push(i)}exteriorParser(e,t){const i=O(void 0,this.RING_PARSERS,e,t,this);if(i){const n=t[t.length-1];n[0]=i}}readSurface(e,t){const i=O([null],this.SURFACE_PARSERS,e,t,this);if(i&&i[0]){const n=i[0],s=[n.length];let o,a;for(o=1,a=i.length;o<a;++o)tn(n,i[o]),s.push(n.length);return new Rn(n,"XYZ",s)}}readCurve(e,t){const i=O([null],this.CURVE_PARSERS,e,t,this);if(i)return new Lt(i,"XYZ")}readEnvelope(e,t){const i=O([null],this.ENVELOPE_PARSERS,e,t,this);return tc(i[1][0],i[1][1],i[2][0],i[2][1])}readFlatPos(e,t){let i=Wi(e,!1);const n=/^\s*([+\-]?\d*\.?\d+(?:[eE][+\-]?\d+)?)\s*/,s=[];let o;for(;o=n.exec(i);)s.push(parseFloat(o[1])),i=i.substr(o[0].length);if(i!=="")return;const l=t[0].srsName;if((l?ce(l).getAxisOrientation():"enu")==="neu")for(let h=0,f=s.length;h<f;h+=3){const g=s[h],d=s[h+1];s[h]=d,s[h+1]=g}const u=s.length;if(u==2&&s.push(0),u!==0)return s}readFlatPosList(e,t){const i=Wi(e,!1).replace(/^\s*|\s*$/g,""),n=t[0],s=n.srsName,o=n.srsDimension,a=s?ce(s).getAxisOrientation():"enu",l=i.split(/\s+/);let c=2;e.getAttribute("srsDimension")?c=Nt(e.getAttribute("srsDimension")):e.getAttribute("dimension")?c=Nt(e.getAttribute("dimension")):e.parentNode.getAttribute("srsDimension")?c=Nt(e.parentNode.getAttribute("srsDimension")):o&&(c=Nt(o));const u=a.startsWith("en");let h,f,g;const d=[];for(let p=0,m=l.length;p<m;p+=c)h=parseFloat(l[p]),f=parseFloat(l[p+1]),g=c===3?parseFloat(l[p+2]):0,u?d.push(h,f,g):d.push(f,h,g);return d}writePos_(e,t,i){const n=i[i.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=a?ce(a).getAxisOrientation():"enu",c=t.getCoordinates();let u=l.startsWith("en")?c[0]+" "+c[1]:c[1]+" "+c[0];if(s){const h=c[2]||0;u+=" "+h}ee(e,u)}getCoords_(e,t,i){let s=(t?ce(t).getAxisOrientation():"enu").startsWith("en")?e[0]+" "+e[1]:e[1]+" "+e[0];if(i){const o=e[2]||0;s+=" "+o}return s}writePosList_(e,t,i){const n=i[i.length-1],s=n.hasZ,o=s?"3":"2";e.setAttribute("srsDimension",o);const a=n.srsName,l=t.getCoordinates(),c=l.length,u=new Array(c);let h;for(let f=0;f<c;++f)h=l[f],u[f]=this.getCoords_(h,a,s);ee(e,u.join(" "))}writePoint(e,t,i){const s=i[i.length-1].srsName;s&&e.setAttribute("srsName",s);const o=H(e.namespaceURI,"pos");e.appendChild(o),this.writePos_(o,t,i)}writeEnvelope(e,t,i){const s=i[i.length-1].srsName;s&&e.setAttribute("srsName",s);const o=["lowerCorner","upperCorner"],a=[t[0]+" "+t[1],t[2]+" "+t[3]];_e({node:e},this.ENVELOPE_SERIALIZERS,Ar,a,i,o,this)}writeLinearRing(e,t,i){const s=i[i.length-1].srsName;s&&e.setAttribute("srsName",s);const o=H(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,i)}RING_NODE_FACTORY_(e,t,i){const n=t[t.length-1],s=n.node,o=n.exteriorWritten;return o===void 0&&(n.exteriorWritten=!0),H(s.namespaceURI,o!==void 0?"interior":"exterior")}writeSurfaceOrPolygon(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName;if(e.nodeName!=="PolygonPatch"&&o&&e.setAttribute("srsName",o),e.nodeName==="Polygon"||e.nodeName==="PolygonPatch"){const a=t.getLinearRings();_e({node:e,hasZ:s,srsName:o},this.RING_SERIALIZERS,this.RING_NODE_FACTORY_,a,i,void 0,this)}else if(e.nodeName==="Surface"){const a=H(e.namespaceURI,"patches");e.appendChild(a),this.writeSurfacePatches_(a,t,i)}}writeCurveOrLineString(e,t,i){const s=i[i.length-1].srsName;if(e.nodeName!=="LineStringSegment"&&s&&e.setAttribute("srsName",s),e.nodeName==="LineString"||e.nodeName==="LineStringSegment"){const o=H(e.namespaceURI,"posList");e.appendChild(o),this.writePosList_(o,t,i)}else if(e.nodeName==="Curve"){const o=H(e.namespaceURI,"segments");e.appendChild(o),this.writeCurveSegments_(o,t,i)}}writeMultiSurfaceOrPolygon(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName,a=n.surface;o&&e.setAttribute("srsName",o);const l=t.getPolygons();_e({node:e,hasZ:s,srsName:o,surface:a},this.SURFACEORPOLYGONMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,i,void 0,this)}writeMultiPoint(e,t,i){const n=i[i.length-1],s=n.srsName,o=n.hasZ;s&&e.setAttribute("srsName",s);const a=t.getPoints();_e({node:e,hasZ:o,srsName:s},this.POINTMEMBER_SERIALIZERS,qe("pointMember"),a,i,void 0,this)}writeMultiCurveOrLineString(e,t,i){const n=i[i.length-1],s=n.hasZ,o=n.srsName,a=n.curve;o&&e.setAttribute("srsName",o);const l=t.getLineStrings();_e({node:e,hasZ:s,srsName:o,curve:a},this.LINESTRINGORCURVEMEMBER_SERIALIZERS,this.MULTIGEOMETRY_MEMBER_NODE_FACTORY_,l,i,void 0,this)}writeRing(e,t,i){const n=H(e.namespaceURI,"LinearRing");e.appendChild(n),this.writeLinearRing(n,t,i)}writeSurfaceOrPolygonMember(e,t,i){const n=this.GEOMETRY_NODE_FACTORY_(t,i);n&&(e.appendChild(n),this.writeSurfaceOrPolygon(n,t,i))}writePointMember(e,t,i){const n=H(e.namespaceURI,"Point");e.appendChild(n),this.writePoint(n,t,i)}writeLineStringOrCurveMember(e,t,i){const n=this.GEOMETRY_NODE_FACTORY_(t,i);n&&(e.appendChild(n),this.writeCurveOrLineString(n,t,i))}writeSurfacePatches_(e,t,i){const n=H(e.namespaceURI,"PolygonPatch");e.appendChild(n),this.writeSurfaceOrPolygon(n,t,i)}writeCurveSegments_(e,t,i){const n=H(e.namespaceURI,"LineStringSegment");e.appendChild(n),this.writeCurveOrLineString(n,t,i)}writeGeometryElement(e,t,i){const n=i[i.length-1],s=Object.assign({},n);s.node=e;let o;Array.isArray(t)?o=Zs(t,n):o=Ue(t,!0,n),_e(s,this.GEOMETRY_SERIALIZERS,this.GEOMETRY_NODE_FACTORY_,[o],i,void 0,this)}writeFeatureElement(e,t,i){const n=t.getId();n&&e.setAttribute("fid",n);const s=i[i.length-1],o=s.featureNS,a=t.getGeometryName();s.serializers||(s.serializers={},s.serializers[o]={});const l=[],c=[];if(t.hasProperties()){const h=t.getProperties();for(const f in h){const g=h[f];g!=null&&(l.push(f),c.push(g),f==a||typeof g.getSimplifiedGeometry=="function"?f in s.serializers[o]||(s.serializers[o][f]=T(this.writeGeometryElement,this)):f in s.serializers[o]||(s.serializers[o][f]=T(ee)))}}const u=Object.assign({},s);u.node=e,_e(u,s.serializers,qe(void 0,o),c,i,l)}writeFeatureMembers_(e,t,i){const n=i[i.length-1],s=n.featureType,o=n.featureNS,a={};a[o]={},a[o][s]=T(this.writeFeatureElement,this);const l=Object.assign({},n);l.node=e,_e(l,a,qe(s,o),t,i)}MULTIGEOMETRY_MEMBER_NODE_FACTORY_(e,t,i){const n=t[t.length-1].node;return H(this.namespace,Td[n.nodeName])}GEOMETRY_NODE_FACTORY_(e,t,i){const n=t[t.length-1],s=n.multiSurface,o=n.surface,a=n.curve,l=n.multiCurve;return Array.isArray(e)?i="Envelope":(i=e.getType(),i==="MultiPolygon"&&s===!0?i="MultiSurface":i==="Polygon"&&o===!0?i="Surface":i==="LineString"&&a===!0?i="Curve":i==="MultiLineString"&&l===!0&&(i="MultiCurve")),H(this.namespace,i)}writeGeometryNode(e,t){t=this.adaptOptions(t);const i=H(this.namespace,"geom"),n={node:i,hasZ:this.hasZ,srsName:this.srsName,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_};return t&&Object.assign(n,t),this.writeGeometryElement(i,e,[n]),i}writeFeaturesNode(e,t){t=this.adaptOptions(t);const i=H(this.namespace,"featureMembers");i.setAttributeNS(Qr,"xsi:schemaLocation",this.schemaLocation);const n={srsName:this.srsName,hasZ:this.hasZ,curve:this.curve_,surface:this.surface_,multiSurface:this.multiSurface_,multiCurve:this.multiCurve_,featureNS:this.featureNS,featureType:this.featureType};return t&&Object.assign(n,t),this.writeFeatureMembers_(i,e,[n]),i}}I.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml":{pos:V(I.prototype.readFlatPos),posList:V(I.prototype.readFlatPosList),coordinates:V(Q.prototype.readFlatCoordinates)}};I.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml":{interior:I.prototype.interiorParser,exterior:I.prototype.exteriorParser}};I.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml":{Point:V(B.prototype.readPoint),MultiPoint:V(B.prototype.readMultiPoint),LineString:V(B.prototype.readLineString),MultiLineString:V(B.prototype.readMultiLineString),LinearRing:V(B.prototype.readLinearRing),Polygon:V(B.prototype.readPolygon),MultiPolygon:V(B.prototype.readMultiPolygon),Surface:V(I.prototype.readSurface),MultiSurface:V(I.prototype.readMultiSurface),Curve:V(I.prototype.readCurve),MultiCurve:V(I.prototype.readMultiCurve),Envelope:V(I.prototype.readEnvelope)}};I.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml":{curveMember:$(I.prototype.curveMemberParser),curveMembers:$(I.prototype.curveMemberParser)}};I.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml":{surfaceMember:$(I.prototype.surfaceMemberParser),surfaceMembers:$(I.prototype.surfaceMemberParser)}};I.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml":{LineString:$(B.prototype.readLineString),Curve:$(I.prototype.readCurve)}};I.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml":{Polygon:$(B.prototype.readPolygon),Surface:$(I.prototype.readSurface)}};I.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml":{patches:V(I.prototype.readPatch)}};I.prototype.CURVE_PARSERS={"http://www.opengis.net/gml":{segments:V(I.prototype.readSegment)}};I.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml":{lowerCorner:$(I.prototype.readFlatPosList),upperCorner:$(I.prototype.readFlatPosList)}};I.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml":{PolygonPatch:V(I.prototype.readPolygonPatch)}};I.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml":{LineStringSegment:Gl(I.prototype.readLineStringSegment)}};B.prototype.RING_PARSERS={"http://www.opengis.net/gml":{LinearRing:V(B.prototype.readFlatLinearRing),Ring:V(I.prototype.readFlatCurveRing)}};I.prototype.writeFeatures;I.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml":{exterior:T(I.prototype.writeRing),interior:T(I.prototype.writeRing)}};I.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml":{lowerCorner:T(ee),upperCorner:T(ee)}};I.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{surfaceMember:T(I.prototype.writeSurfaceOrPolygonMember),polygonMember:T(I.prototype.writeSurfaceOrPolygonMember)}};I.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{pointMember:T(I.prototype.writePointMember)}};I.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml":{lineStringMember:T(I.prototype.writeLineStringOrCurveMember),curveMember:T(I.prototype.writeLineStringOrCurveMember)}};I.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml":{Curve:T(I.prototype.writeCurveOrLineString),MultiCurve:T(I.prototype.writeMultiCurveOrLineString),Point:T(I.prototype.writePoint),MultiPoint:T(I.prototype.writeMultiPoint),LineString:T(I.prototype.writeCurveOrLineString),MultiLineString:T(I.prototype.writeMultiCurveOrLineString),LinearRing:T(I.prototype.writeLinearRing),Polygon:T(I.prototype.writeSurfaceOrPolygon),MultiPolygon:T(I.prototype.writeMultiSurfaceOrPolygon),Surface:T(I.prototype.writeSurfaceOrPolygon),MultiSurface:T(I.prototype.writeMultiSurfaceOrPolygon),Envelope:T(I.prototype.writeEnvelope)}};const ro=I;ro.prototype.writeFeatures;ro.prototype.writeFeaturesNode;const xe=[null,"http://www.topografix.com/GPX/1/0","http://www.topografix.com/GPX/1/1"],wd="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd",Sd={rte:lc,trk:cc,wpt:uc},vd=D(xe,{rte:$(lc),trk:$(cc),wpt:$(uc)}),Rd=D(xe,{text:b(F,"linkText"),type:b(F,"linkType")}),Ad=D(xe,{name:b(F),email:eg,link:pi}),Pd=D(xe,{name:b(F),desc:b(F),author:b(Kd),copyright:b(Jd),link:pi,time:b(En),keywords:b(F),bounds:Qd,extensions:Pn}),Ld=D(xe,{year:b(Te),license:b(F)}),Id=D(xe,{rte:T(ng),trk:T(sg),wpt:T(ag)});class Cd extends xn{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.readExtensions_=e.readExtensions}handleReadExtensions_(e){e||(e=[]);for(let t=0,i=e.length;t<i;++t){const n=e[t];if(this.readExtensions_){const s=n.get("extensionsNode_")||null;this.readExtensions_(n,s)}n.set("extensionsNode_",void 0)}}readMetadata(e){return e?typeof e=="string"?this.readMetadataFromDocument(ji(e)):Hi(e)?this.readMetadataFromDocument(e):this.readMetadataFromNode(e):null}readMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType===Node.ELEMENT_NODE){const i=this.readMetadataFromNode(t);if(i)return i}return null}readMetadataFromNode(e){if(!xe.includes(e.namespaceURI))return null;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(xe.includes(t.namespaceURI)&&t.localName==="metadata")return O({},Pd,t,[]);return null}readFeatureFromNode(e,t){if(!xe.includes(e.namespaceURI))return null;const i=Sd[e.localName];if(!i)return null;const n=i(e,[this.getReadOptions(e,t)]);return n?(this.handleReadExtensions_([n]),n):null}readFeaturesFromNode(e,t){if(!xe.includes(e.namespaceURI))return[];if(e.localName=="gpx"){const i=O([],vd,e,[this.getReadOptions(e,t)]);return i?(this.handleReadExtensions_(i),i):[]}return[]}writeFeaturesNode(e,t){t=this.adaptOptions(t);const i=H("http://www.topografix.com/GPX/1/1","gpx");return i.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xsi",Qr),i.setAttributeNS(Qr,"xsi:schemaLocation",wd),i.setAttribute("version","1.1"),i.setAttribute("creator","OpenLayers"),_e({node:i},Id,qd,e,[t]),i}}const Fd=D(xe,{name:b(F),cmt:b(F),desc:b(F),src:b(F),link:pi,number:b(Te),extensions:Pn,type:b(F),rtept:tg}),Od=D(xe,{ele:b(De),time:b(En)}),Md=D(xe,{name:b(F),cmt:b(F),desc:b(F),src:b(F),link:pi,number:b(Te),type:b(F),extensions:Pn,trkseg:ig}),Nd=D(xe,{trkpt:rg}),Dd=D(xe,{ele:b(De),time:b(En)}),Ud=D(xe,{ele:b(De),time:b(En),magvar:b(De),geoidheight:b(De),name:b(F),cmt:b(F),desc:b(F),src:b(F),link:pi,sym:b(F),type:b(F),fix:b(F),sat:b(Te),hdop:b(De),vdop:b(De),pdop:b(De),ageofdgpsdata:b(De),dgpsid:b(Te),extensions:Pn}),Bd=["text","type"],Gd=D(xe,{text:T(ee),type:T(ee)}),zd=D(xe,["name","cmt","desc","src","link","number","type","rtept"]),kd=D(xe,{name:T(ee),cmt:T(ee),desc:T(ee),src:T(ee),link:T(so),number:T(Zi),type:T(ee),rtept:zl(T(oo))}),$d=D(xe,["ele","time"]),Vd=D(xe,["name","cmt","desc","src","link","number","type","trkseg"]),Xd=D(xe,{name:T(ee),cmt:T(ee),desc:T(ee),src:T(ee),link:T(so),number:T(Zi),type:T(ee),trkseg:zl(T(og))}),Wd=qe("trkpt"),jd=D(xe,{trkpt:T(oo)}),Hd=D(xe,["ele","time","magvar","geoidheight","name","cmt","desc","src","link","sym","type","fix","sat","hdop","vdop","pdop","ageofdgpsdata","dgpsid"]),Zd=D(xe,{ele:T(jt),time:T(fh),magvar:T(jt),geoidheight:T(jt),name:T(ee),cmt:T(ee),desc:T(ee),src:T(ee),link:T(so),sym:T(ee),type:T(ee),fix:T(ee),sat:T(Zi),hdop:T(jt),vdop:T(jt),pdop:T(jt),ageofdgpsdata:T(jt),dgpsid:T(Zi)}),Yd={Point:"wpt",LineString:"rte",MultiLineString:"trk"};function qd(r,e,t){const i=r.getGeometry();if(i){const n=Yd[i.getType()];if(n){const s=e[e.length-1].node;return H(s.namespaceURI,n)}}}function io(r,e,t,i){return r.push(parseFloat(t.getAttribute("lon")),parseFloat(t.getAttribute("lat"))),"ele"in i?(r.push(i.ele),delete i.ele,e.hasZ=!0):r.push(0),"time"in i?(r.push(i.time),delete i.time,e.hasM=!0):r.push(0),r}function no(r,e,t){let i="XY",n=2;if(r.hasZ&&r.hasM?(i="XYZM",n=4):r.hasZ?(i="XYZ",n=3):r.hasM&&(i="XYM",n=3),n!==4){for(let s=0,o=e.length/4;s<o;s++)e[s*n]=e[s*4],e[s*n+1]=e[s*4+1],r.hasZ&&(e[s*n+2]=e[s*4+2]),r.hasM&&(e[s*n+2]=e[s*4+3]);if(e.length=e.length/4*n,t)for(let s=0,o=t.length;s<o;s++)t[s]=t[s]/4*n}return i}function Kd(r,e){const t=O({},Ad,r,e);if(t)return t}function Jd(r,e){const t=O({},Ld,r,e);if(t){const i=r.getAttribute("author");return i!==null&&(t.author=i),t}}function Qd(r,e){const t=e[e.length-1],i=r.getAttribute("minlat"),n=r.getAttribute("minlon"),s=r.getAttribute("maxlat"),o=r.getAttribute("maxlon");n!==null&&i!==null&&o!==null&&s!==null&&(t.bounds=[[parseFloat(n),parseFloat(i)],[parseFloat(o),parseFloat(s)]])}function eg(r,e){const t=e[e.length-1],i=r.getAttribute("id"),n=r.getAttribute("domain");i!==null&&n!==null&&(t.email=`${i}@${n}`)}function pi(r,e){const t=e[e.length-1],i=r.getAttribute("href");i!==null&&(t.link=i),Ut(Rd,r,e)}function Pn(r,e){const t=e[e.length-1];t.extensionsNode_=r}function tg(r,e){const t=O({},Od,r,e);if(t){const i=e[e.length-1],n=i.flatCoordinates,s=i.layoutOptions;io(n,s,r,t)}}function rg(r,e){const t=O({},Dd,r,e);if(t){const i=e[e.length-1],n=i.flatCoordinates,s=i.layoutOptions;io(n,s,r,t)}}function ig(r,e){const t=e[e.length-1];Ut(Nd,r,e);const i=t.flatCoordinates;t.ends.push(i.length)}function lc(r,e){const t=e[0],i=O({flatCoordinates:[],layoutOptions:{}},Fd,r,e);if(!i)return;const n=i.flatCoordinates;delete i.flatCoordinates;const s=i.layoutOptions;delete i.layoutOptions;const o=no(s,n),a=new Lt(n,o);Ue(a,!1,t);const l=new lt(a);return l.setProperties(i,!0),l}function cc(r,e){const t=e[0],i=O({flatCoordinates:[],ends:[],layoutOptions:{}},Md,r,e);if(!i)return;const n=i.flatCoordinates;delete i.flatCoordinates;const s=i.ends;delete i.ends;const o=i.layoutOptions;delete i.layoutOptions;const a=no(o,n,s),l=new fi(n,a,s);Ue(l,!1,t);const c=new lt(l);return c.setProperties(i,!0),c}function uc(r,e){const t=e[0],i=O({},Ud,r,e);if(!i)return;const n={},s=io([],n,r,i),o=no(n,s),a=new xt(s,o);Ue(a,!1,t);const l=new lt(a);return l.setProperties(i,!0),l}function so(r,e,t){r.setAttribute("href",e);const n=t[t.length-1].properties,s=[n.linkText,n.linkType];_e({node:r},Gd,Ar,s,t,Bd)}function oo(r,e,t){const i=t[t.length-1],s=i.node.namespaceURI,o=i.properties;switch(r.setAttributeNS(null,"lat",String(e[1])),r.setAttributeNS(null,"lon",String(e[0])),i.geometryLayout){case"XYZM":e[3]!==0&&(o.time=e[3]);case"XYZ":e[2]!==0&&(o.ele=e[2]);break;case"XYM":e[2]!==0&&(o.time=e[2]);break}const l=r.nodeName=="rtept"?$d[s]:Hd[s],c=Bs(o,l);_e({node:r,properties:o},Zd,Ar,c,t,l)}function ng(r,e,t){const i=t[0],n=e.getProperties(),s={node:r};s.properties=n;const o=e.getGeometry();if(o.getType()=="LineString"){const u=Ue(o,!0,i);s.geometryLayout=u.getLayout(),n.rtept=u.getCoordinates()}const a=t[t.length-1].node,l=zd[a.namespaceURI],c=Bs(n,l);_e(s,kd,Ar,c,t,l)}function sg(r,e,t){const i=t[0],n=e.getProperties(),s={node:r};s.properties=n;const o=e.getGeometry();if(o.getType()=="MultiLineString"){const u=Ue(o,!0,i);n.trkseg=u.getLineStrings()}const a=t[t.length-1].node,l=Vd[a.namespaceURI],c=Bs(n,l);_e(s,Xd,Ar,c,t,l)}function og(r,e,t){const i={node:r};i.geometryLayout=e.getLayout(),i.properties={},_e(i,jd,Wd,e.getCoordinates(),t)}function ag(r,e,t){const i=t[0],n=t[t.length-1];n.properties=e.getProperties();const s=e.getGeometry();if(s.getType()=="Point"){const o=Ue(s,!0,i);n.geometryLayout=o.getLayout(),oo(r,o.getCoordinates(),t)}}const lg=/^B(\d{2})(\d{2})(\d{2})(\d{2})(\d{5})([NS])(\d{3})(\d{5})([EW])([AV])(\d{5})(\d{5})/,cg=/^H.([A-Z]{3}).*?:(.*)/,ug=/^HFDTE(\d{2})(\d{2})(\d{2})/,hg=/^HFDTEDATE:(\d{2})(\d{2})(\d{2}),(\d{2})/,fg=/\r\n|\r|\n/;class dg extends sc{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.altitudeMode_=e.altitudeMode?e.altitudeMode:"none",this.lad_=!1,this.lod_=!1,this.ladStart_=0,this.ladStop_=0,this.lodStart_=0,this.lodStop_=0}readFeatureFromText(e,t){const i=this.altitudeMode_,n=e.split(fg),s={},o=[];let a=2e3,l=0,c=1,u=-1,h,f;for(h=0,f=n.length;h<f;++h){const m=n[h];let y;if(m.charAt(0)=="B"){if(y=lg.exec(m),y){const _=parseInt(y[1],10),E=parseInt(y[2],10),S=parseInt(y[3],10);let v=parseInt(y[4],10)+parseInt(y[5],10)/6e4;this.lad_&&(v+=parseInt(m.slice(this.ladStart_,this.ladStop_),10)/6e4/10**(this.ladStop_-this.ladStart_)),y[6]=="S"&&(v=-v);let w=parseInt(y[7],10)+parseInt(y[8],10)/6e4;if(this.lod_&&(w+=parseInt(m.slice(this.lodStart_,this.lodStop_),10)/6e4/10**(this.lodStop_-this.lodStart_)),y[9]=="W"&&(w=-w),o.push(w,v),i!="none"){let C;i=="gps"?C=parseInt(y[11],10):i=="barometric"?C=parseInt(y[12],10):C=0,o.push(C)}let A=Date.UTC(a,l,c,_,E,S);A<u&&(A=Date.UTC(a,l,c+1,_,E,S)),o.push(A/1e3),u=A}}else if(m.charAt(0)=="H")y=hg.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=ug.exec(m),y?(c=parseInt(y[1],10),l=parseInt(y[2],10)-1,a=2e3+parseInt(y[3],10)):(y=cg.exec(m),y&&(s[y[1]]=y[2].trim())));else if(m.charAt(0)=="I"){const _=parseInt(m.slice(1,3),10);for(let E=0;E<_;E++){const S=m.slice(7+E*7,10+E*7);if(S==="LAD"||S==="LOD"){const v=parseInt(m.slice(3+E*7,5+E*7),10)-1,w=parseInt(m.slice(5+E*7,7+E*7),10);S==="LAD"?(this.lad_=!0,this.ladStart_=v,this.ladStop_=w):S==="LOD"&&(this.lod_=!0,this.lodStart_=v,this.lodStop_=w)}}}}if(o.length===0)return null;const g=i=="none"?"XYM":"XYZM",d=new Lt(o,g),p=new lt(Ue(d,!1,t));return p.setProperties(s,!0),p}readFeaturesFromText(e,t){const i=this.readFeatureFromText(e,t);return i?[i]:[]}}const ve={VERSION1:"version1",VERSION2:"version2",VERSION3:"version3"},Qt={};Qt[ve.VERSION1]={level0:{supports:[],formats:[],qualities:["native"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["native"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["native","color","grey","bitonal"]}};Qt[ve.VERSION2]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","sizeByW","sizeByH","sizeByPct"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByDistortedWh","sizeByWh"],formats:["jpg","png"],qualities:["default","bitonal"]}};Qt[ve.VERSION3]={level0:{supports:[],formats:["jpg"],qualities:["default"]},level1:{supports:["regionByPx","regionSquare","sizeByW","sizeByH","sizeByWh"],formats:["jpg"],qualities:["default"]},level2:{supports:["regionByPx","regionSquare","regionByPct","sizeByW","sizeByH","sizeByPct","sizeByConfinedWh","sizeByWh"],formats:["jpg","png"],qualities:["default"]}};Qt.none={none:{supports:[],formats:[],qualities:[]}};const gg=/^https?:\/\/library\.stanford\.edu\/iiif\/image-api\/(?:1\.1\/)?compliance\.html#level[0-2]$/,Sa=/^https?:\/\/iiif\.io\/api\/image\/2\/level[0-2](?:\.json)?$/,pg=/(^https?:\/\/iiif\.io\/api\/image\/3\/level[0-2](?:\.json)?$)|(^level[0-2]$)/;function mg(r){let e=r.getComplianceLevelSupportedFeatures();return e===void 0&&(e=Qt[ve.VERSION1].level0),{url:r.imageInfo["@id"]===void 0?void 0:r.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),supports:e.supports,formats:[...e.formats,r.imageInfo.formats===void 0?[]:r.imageInfo.formats],qualities:[...e.qualities,r.imageInfo.qualities===void 0?[]:r.imageInfo.qualities],resolutions:r.imageInfo.scale_factors,tileSize:r.imageInfo.tile_width!==void 0?r.imageInfo.tile_height!==void 0?[r.imageInfo.tile_width,r.imageInfo.tile_height]:[r.imageInfo.tile_width,r.imageInfo.tile_width]:r.imageInfo.tile_height!=null?[r.imageInfo.tile_height,r.imageInfo.tile_height]:void 0}}function _g(r){const e=r.getComplianceLevelSupportedFeatures(),t=Array.isArray(r.imageInfo.profile)&&r.imageInfo.profile.length>1,i=t&&r.imageInfo.profile[1].supports?r.imageInfo.profile[1].supports:[],n=t&&r.imageInfo.profile[1].formats?r.imageInfo.profile[1].formats:[],s=t&&r.imageInfo.profile[1].qualities?r.imageInfo.profile[1].qualities:[];return{url:r.imageInfo["@id"].replace(/\/?(?:info\.json)?$/g,""),sizes:r.imageInfo.sizes===void 0?void 0:r.imageInfo.sizes.map(function(o){return[o.width,o.height]}),tileSize:r.imageInfo.tiles===void 0?void 0:[r.imageInfo.tiles.map(function(o){return o.width})[0],r.imageInfo.tiles.map(function(o){return o.height===void 0?o.width:o.height})[0]],resolutions:r.imageInfo.tiles===void 0?void 0:r.imageInfo.tiles.map(function(o){return o.scaleFactors})[0],supports:[...e.supports,...i],formats:[...e.formats,...n],qualities:[...e.qualities,...s]}}function yg(r){const e=r.getComplianceLevelSupportedFeatures(),t=r.imageInfo.extraFormats===void 0?e.formats:[...e.formats,...r.imageInfo.extraFormats],i=r.imageInfo.preferredFormats!==void 0&&Array.isArray(r.imageInfo.preferredFormats)&&r.imageInfo.preferredFormats.length>0?r.imageInfo.preferredFormats.filter(function(n){return["jpg","png","gif"].includes(n)}).reduce(function(n,s){return n===void 0&&t.includes(s)?s:n},void 0):void 0;return{url:r.imageInfo.id,sizes:r.imageInfo.sizes===void 0?void 0:r.imageInfo.sizes.map(function(n){return[n.width,n.height]}),tileSize:r.imageInfo.tiles===void 0?void 0:[r.imageInfo.tiles.map(function(n){return n.width})[0],r.imageInfo.tiles.map(function(n){return n.height})[0]],resolutions:r.imageInfo.tiles===void 0?void 0:r.imageInfo.tiles.map(function(n){return n.scaleFactors})[0],supports:r.imageInfo.extraFeatures===void 0?e.supports:[...e.supports,...r.imageInfo.extraFeatures],formats:t,qualities:r.imageInfo.extraQualities===void 0?e.qualities:[...e.qualities,...r.imageInfo.extraQualities],preferredFormat:i}}const Ln={};Ln[ve.VERSION1]=mg;Ln[ve.VERSION2]=_g;Ln[ve.VERSION3]=yg;class xg{constructor(e){this.setImageInfo(e)}setImageInfo(e){typeof e=="string"?this.imageInfo=JSON.parse(e):this.imageInfo=e}getImageApiVersion(){if(this.imageInfo===void 0)return;let e=this.imageInfo["@context"]||"ol-no-context";typeof e=="string"&&(e=[e]);for(let t=0;t<e.length;t++)switch(e[t]){case"http://library.stanford.edu/iiif/image-api/1.1/context.json":case"http://iiif.io/api/image/1/context.json":return ve.VERSION1;case"http://iiif.io/api/image/2/context.json":return ve.VERSION2;case"http://iiif.io/api/image/3/context.json":return ve.VERSION3;case"ol-no-context":if(this.getComplianceLevelEntryFromProfile(ve.VERSION1)&&this.imageInfo.identifier)return ve.VERSION1;break}et(!1,"Cannot determine IIIF Image API version from provided image information JSON")}getComplianceLevelEntryFromProfile(e){if(!(this.imageInfo===void 0||this.imageInfo.profile===void 0))switch(e===void 0&&(e=this.getImageApiVersion()),e){case ve.VERSION1:if(gg.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ve.VERSION3:if(pg.test(this.imageInfo.profile))return this.imageInfo.profile;break;case ve.VERSION2:if(typeof this.imageInfo.profile=="string"&&Sa.test(this.imageInfo.profile))return this.imageInfo.profile;if(Array.isArray(this.imageInfo.profile)&&this.imageInfo.profile.length>0&&typeof this.imageInfo.profile[0]=="string"&&Sa.test(this.imageInfo.profile[0]))return this.imageInfo.profile[0];break}}getComplianceLevelFromProfile(e){const t=this.getComplianceLevelEntryFromProfile(e);if(t===void 0)return;const i=t.match(/level[0-2](?:\.json)?$/g);return Array.isArray(i)?i[0].replace(".json",""):void 0}getComplianceLevelSupportedFeatures(){if(this.imageInfo===void 0)return;const e=this.getImageApiVersion(),t=this.getComplianceLevelFromProfile(e);return t===void 0?Qt.none.none:Qt[e][t]}getTileSourceOptions(e){const t=e||{},i=this.getImageApiVersion();if(i===void 0)return;const n=i===void 0?void 0:Ln[i](this);if(n!==void 0)return{url:n.url,version:i,size:[this.imageInfo.width,this.imageInfo.height],sizes:n.sizes,format:t.format!==void 0&&n.formats.includes(t.format)?t.format:n.preferredFormat!==void 0?n.preferredFormat:"jpg",supports:n.supports,quality:t.quality&&n.qualities.includes(t.quality)?t.quality:n.qualities.includes("native")?"native":"default",resolutions:Array.isArray(n.resolutions)?n.resolutions.sort(function(s,o){return o-s}):void 0,tileSize:n.tileSize}}}class ao{read(e){if(!e)return null;if(typeof e=="string"){const t=ji(e);return this.readFromDocument(t)}return Hi(e)?this.readFromDocument(e):this.readFromNode(e)}readFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFromNode(t);return null}readFromNode(e){Js()}}const Eg="http://www.w3.org/1999/xlink";function Cr(r){return r.getAttributeNS(Eg,"href")}const je=[null,"http://www.opengis.net/ows/1.1"],bg=D(je,{ServiceIdentification:b(Wg),ServiceProvider:b(Hg),OperationsMetadata:b(Vg)});class hc extends ao{constructor(){super()}readFromNode(e){const t=O({},bg,e,[]);return t||null}}const Tg=D(je,{DeliveryPoint:b(F),City:b(F),AdministrativeArea:b(F),PostalCode:b(F),Country:b(F),ElectronicMailAddress:b(F)}),wg=D(je,{Value:fe(Zg)}),Sg=D(je,{AllowedValues:b(Dg)}),vg=D(je,{Phone:b(Xg),Address:b(Ng)}),Rg=D(je,{HTTP:b(kg)}),Ag=D(je,{Get:fe(zg),Post:void 0}),Pg=D(je,{DCP:b(Gg)}),Lg=D(je,{Operation:$g}),Ig=D(je,{Voice:b(F),Facsimile:b(F)}),Cg=D(je,{Constraint:fe(Ug)}),Fg=D(je,{IndividualName:b(F),PositionName:b(F),ContactInfo:b(Bg)}),Og=D(je,{Abstract:b(F),AccessConstraints:b(F),Fees:b(F),Title:b(F),ServiceTypeVersion:b(F),ServiceType:b(F)}),Mg=D(je,{ProviderName:b(F),ProviderSite:b(Cr),ServiceContact:b(jg)});function Ng(r,e){return O({},Tg,r,e)}function Dg(r,e){return O({},wg,r,e)}function Ug(r,e){const t=r.getAttribute("name");if(t)return O({name:t},Sg,r,e)}function Bg(r,e){return O({},vg,r,e)}function Gg(r,e){return O({},Rg,r,e)}function zg(r,e){const t=Cr(r);if(t)return O({href:t},Cg,r,e)}function kg(r,e){return O({},Ag,r,e)}function $g(r,e){const t=r.getAttribute("name"),i=O({},Pg,r,e);if(!i)return;const n=e[e.length-1];n[t]=i}function Vg(r,e){return O({},Lg,r,e)}function Xg(r,e){return O({},Ig,r,e)}function Wg(r,e){return O({},Og,r,e)}function jg(r,e){return O({},Fg,r,e)}function Hg(r,e){return O({},Mg,r,e)}function Zg(r,e){return F(r)}function va(r,e,t,i,n,s){n!==void 0?(n=n,s=s!==void 0?s:0):(n=[],s=0);let o=e;for(;o<t;){const a=r[o++];n[s++]=r[o++],n[s++]=a;for(let l=2;l<i;++l)n[s++]=r[o++]}return n.length=s,n}class Yg extends sc{constructor(e){super(),e=e||{},this.dataProjection=ce("EPSG:4326"),this.factor_=e.factor?e.factor:1e5,this.geometryLayout_=e.geometryLayout?e.geometryLayout:"XY"}readFeatureFromText(e,t){const i=this.readGeometryFromText(e,t);return new lt(i)}readFeaturesFromText(e,t){return[this.readFeatureFromText(e,t)]}readGeometryFromText(e,t){const i=lf(this.geometryLayout_),n=Kg(e,i,this.factor_);va(n,0,n.length,i,n);const s=cf(n,0,n.length,i),o=new Lt(s,this.geometryLayout_);return Ue(o,!1,this.adaptOptions(t))}writeFeatureText(e,t){const i=e.getGeometry();if(i)return this.writeGeometryText(i,t);throw new Error("Expected `feature` to have a geometry")}writeFeaturesText(e,t){return this.writeFeatureText(e[0],t)}writeGeometryText(e,t){e=Ue(e,!0,this.adaptOptions(t));const i=e.getFlatCoordinates(),n=e.getStride();return va(i,0,i.length,n,i),qg(i,n,this.factor_)}}function qg(r,e,t){t=t||1e5;let i;const n=new Array(e);for(i=0;i<e;++i)n[i]=0;for(let s=0,o=r.length;s<o;)for(i=0;i<e;++i,++s){const a=r[s],l=a-n[i];n[i]=a,r[s]=l}return Jg(r,t)}function Kg(r,e,t){t=t||1e5;let i;const n=new Array(e);for(i=0;i<e;++i)n[i]=0;const s=Qg(r,t);for(let o=0,a=s.length;o<a;)for(i=0;i<e;++i,++o)n[i]+=s[o],s[o]=n[i];return s}function Jg(r,e){e=e||1e5;for(let t=0,i=r.length;t<i;++t)r[t]=Math.round(r[t]*e);return ep(r)}function Qg(r,e){e=e||1e5;const t=tp(r);for(let i=0,n=t.length;i<n;++i)t[i]/=e;return t}function ep(r){for(let e=0,t=r.length;e<t;++e){const i=r[e];r[e]=i<0?~(i<<1):i<<1}return rp(r)}function tp(r){const e=ip(r);for(let t=0,i=e.length;t<i;++t){const n=e[t];e[t]=n&1?~(n>>1):n>>1}return e}function rp(r){let e="";for(let t=0,i=r.length;t<i;++t)e+=np(r[t]);return e}function ip(r){const e=[];let t=0,i=0;for(let n=0,s=r.length;n<s;++n){const o=r.charCodeAt(n)-63;t|=(o&31)<<i,o<32?(e.push(t),t=0,i=0):i+=5}return e}function np(r){let e,t="";for(;r>=32;)e=(32|r&31)+63,t+=String.fromCharCode(e),r>>=5;return e=r+63,t+=String.fromCharCode(e),t}class se extends I{constructor(e){e=e||{},super(e),this.schemaLocation=e.schemaLocation?e.schemaLocation:this.namespace+" http://schemas.opengis.net/gml/3.2.1/gml.xsd"}writeGeometryElement(e,t,i){const n=i[i.length-1];i[i.length-1]=Object.assign({multiCurve:!0,multiSurface:!0},n),super.writeGeometryElement(e,t,i)}}se.prototype.namespace="http://www.opengis.net/gml/3.2";se.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS={"http://www.opengis.net/gml/3.2":{pos:V(I.prototype.readFlatPos),posList:V(I.prototype.readFlatPosList),coordinates:V(Q.prototype.readFlatCoordinates)}};se.prototype.FLAT_LINEAR_RINGS_PARSERS={"http://www.opengis.net/gml/3.2":{interior:I.prototype.interiorParser,exterior:I.prototype.exteriorParser}};se.prototype.GEOMETRY_PARSERS={"http://www.opengis.net/gml/3.2":{Point:V(B.prototype.readPoint),MultiPoint:V(B.prototype.readMultiPoint),LineString:V(B.prototype.readLineString),MultiLineString:V(B.prototype.readMultiLineString),LinearRing:V(B.prototype.readLinearRing),Polygon:V(B.prototype.readPolygon),MultiPolygon:V(B.prototype.readMultiPolygon),Surface:V(se.prototype.readSurface),MultiSurface:V(I.prototype.readMultiSurface),Curve:V(se.prototype.readCurve),MultiCurve:V(I.prototype.readMultiCurve),Envelope:V(se.prototype.readEnvelope)}};se.prototype.MULTICURVE_PARSERS={"http://www.opengis.net/gml/3.2":{curveMember:$(I.prototype.curveMemberParser),curveMembers:$(I.prototype.curveMemberParser)}};se.prototype.MULTISURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{surfaceMember:$(I.prototype.surfaceMemberParser),surfaceMembers:$(I.prototype.surfaceMemberParser)}};se.prototype.CURVEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:$(B.prototype.readLineString),Curve:$(I.prototype.readCurve)}};se.prototype.SURFACEMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:$(B.prototype.readPolygon),Surface:$(I.prototype.readSurface)}};se.prototype.SURFACE_PARSERS={"http://www.opengis.net/gml/3.2":{patches:V(I.prototype.readPatch)}};se.prototype.CURVE_PARSERS={"http://www.opengis.net/gml/3.2":{segments:V(I.prototype.readSegment)}};se.prototype.ENVELOPE_PARSERS={"http://www.opengis.net/gml/3.2":{lowerCorner:$(I.prototype.readFlatPosList),upperCorner:$(I.prototype.readFlatPosList)}};se.prototype.PATCHES_PARSERS={"http://www.opengis.net/gml/3.2":{PolygonPatch:V(I.prototype.readPolygonPatch)}};se.prototype.SEGMENTS_PARSERS={"http://www.opengis.net/gml/3.2":{LineStringSegment:Gl(I.prototype.readLineStringSegment)}};se.prototype.MULTIPOINT_PARSERS={"http://www.opengis.net/gml/3.2":{pointMember:$(B.prototype.pointMemberParser),pointMembers:$(B.prototype.pointMemberParser)}};se.prototype.MULTILINESTRING_PARSERS={"http://www.opengis.net/gml/3.2":{lineStringMember:$(B.prototype.lineStringMemberParser),lineStringMembers:$(B.prototype.lineStringMemberParser)}};se.prototype.MULTIPOLYGON_PARSERS={"http://www.opengis.net/gml/3.2":{polygonMember:$(B.prototype.polygonMemberParser),polygonMembers:$(B.prototype.polygonMemberParser)}};se.prototype.POINTMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Point:$(B.prototype.readFlatCoordinatesFromNode)}};se.prototype.LINESTRINGMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{LineString:$(B.prototype.readLineString)}};se.prototype.POLYGONMEMBER_PARSERS={"http://www.opengis.net/gml/3.2":{Polygon:$(B.prototype.readPolygon)}};se.prototype.RING_PARSERS={"http://www.opengis.net/gml/3.2":{LinearRing:V(B.prototype.readFlatLinearRing),Ring:V(se.prototype.readFlatCurveRing)}};se.prototype.RING_SERIALIZERS={"http://www.opengis.net/gml/3.2":{exterior:T(I.prototype.writeRing),interior:T(I.prototype.writeRing)}};se.prototype.ENVELOPE_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lowerCorner:T(ee),upperCorner:T(ee)}};se.prototype.SURFACEORPOLYGONMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{surfaceMember:T(I.prototype.writeSurfaceOrPolygonMember),polygonMember:T(I.prototype.writeSurfaceOrPolygonMember)}};se.prototype.POINTMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{pointMember:T(I.prototype.writePointMember)}};se.prototype.LINESTRINGORCURVEMEMBER_SERIALIZERS={"http://www.opengis.net/gml/3.2":{lineStringMember:T(I.prototype.writeLineStringOrCurveMember),curveMember:T(I.prototype.writeLineStringOrCurveMember)}};se.prototype.GEOMETRY_SERIALIZERS={"http://www.opengis.net/gml/3.2":{Curve:T(I.prototype.writeCurveOrLineString),MultiCurve:T(I.prototype.writeMultiCurveOrLineString),Point:T(se.prototype.writePoint),MultiPoint:T(I.prototype.writeMultiPoint),LineString:T(I.prototype.writeCurveOrLineString),MultiLineString:T(I.prototype.writeMultiCurveOrLineString),LinearRing:T(I.prototype.writeLinearRing),Polygon:T(I.prototype.writeSurfaceOrPolygon),MultiPolygon:T(I.prototype.writeMultiSurfaceOrPolygon),Surface:T(I.prototype.writeSurfaceOrPolygon),MultiSurface:T(I.prototype.writeMultiSurfaceOrPolygon),Envelope:T(I.prototype.writeEnvelope)}};class fc{constructor(e){this.tagName_=e}getTagName(){return this.tagName_}}class sp extends fc{constructor(e,t){super(e),this.conditions=t,et(this.conditions.length>=2,"At least 2 conditions are required")}}class op extends sp{constructor(e){super("And",Array.prototype.slice.call(arguments))}}class ap extends fc{constructor(e,t,i){if(super("BBOX"),this.geometryName=e,this.extent=t,t.length!==4)throw new Error("Expected an extent with four values ([minX, minY, maxX, maxY])");this.srsName=i}}function lp(r){const e=[null].concat(Array.prototype.slice.call(arguments));return new(Function.prototype.bind.apply(op,e))}function cp(r,e,t){return new ap(r,e,t)}const Ra={"http://www.opengis.net/gml":{boundedBy:b(B.prototype.readExtentElement,"bounds")},"http://www.opengis.net/wfs/2.0":{member:$(B.prototype.readFeaturesInternal)}},up={"http://www.opengis.net/wfs":{totalInserted:b(Te),totalUpdated:b(Te),totalDeleted:b(Te)},"http://www.opengis.net/wfs/2.0":{totalInserted:b(Te),totalUpdated:b(Te),totalDeleted:b(Te)}},hp={"http://www.opengis.net/wfs":{TransactionSummary:b(Pa,"transactionSummary"),InsertResults:b(Ia,"insertIds")},"http://www.opengis.net/wfs/2.0":{TransactionSummary:b(Pa,"transactionSummary"),InsertResults:b(Ia,"insertIds")}},fp={"http://www.opengis.net/wfs":{PropertyName:T(ee)},"http://www.opengis.net/wfs/2.0":{PropertyName:T(ee)}},dc={"http://www.opengis.net/wfs":{Insert:T(Ca),Update:T(Oa),Delete:T(Fa),Property:T(Ma),Native:T(Na)},"http://www.opengis.net/wfs/2.0":{Insert:T(Ca),Update:T(Oa),Delete:T(Fa),Property:T(Ma),Native:T(Na)}},gc="feature",lo="http://www.w3.org/2000/xmlns/",co={"2.0.0":"http://www.opengis.net/ogc/1.1","1.1.0":"http://www.opengis.net/ogc","1.0.0":"http://www.opengis.net/ogc"},ys={"2.0.0":"http://www.opengis.net/wfs/2.0","1.1.0":"http://www.opengis.net/wfs","1.0.0":"http://www.opengis.net/wfs"},uo={"2.0.0":"http://www.opengis.net/fes/2.0","1.1.0":"http://www.opengis.net/fes","1.0.0":"http://www.opengis.net/fes"},Aa={"2.0.0":"http://www.opengis.net/wfs/2.0 http://schemas.opengis.net/wfs/2.0/wfs.xsd","1.1.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.1.0/wfs.xsd","1.0.0":"http://www.opengis.net/wfs http://schemas.opengis.net/wfs/1.0.0/wfs.xsd"},ho={"2.0.0":se,"1.1.0":I,"1.0.0":Q},dp="1.1.0";class gp extends xn{constructor(e){super(),e=e||{},this.version_=e.version?e.version:dp,this.featureType_=e.featureType,this.featureNS_=e.featureNS,this.gmlFormat_=e.gmlFormat?e.gmlFormat:new ho[this.version_],this.schemaLocation_=e.schemaLocation?e.schemaLocation:Aa[this.version_]}getFeatureType(){return this.featureType_}setFeatureType(e){this.featureType_=e}readFeaturesFromNode(e,t){const i={node:e};Object.assign(i,{featureType:this.featureType_,featureNS:this.featureNS_}),Object.assign(i,this.getReadOptions(e,t||{}));const n=[i];let s;this.version_==="2.0.0"?s=Ra:s=this.gmlFormat_.FEATURE_COLLECTION_PARSERS;let o=O([],s,e,n,this.gmlFormat_);return o||(o=[]),o}readTransactionResponse(e){if(e){if(typeof e=="string"){const t=ji(e);return this.readTransactionResponseFromDocument(t)}return Hi(e)?this.readTransactionResponseFromDocument(e):this.readTransactionResponseFromNode(e)}}readFeatureCollectionMetadata(e){if(e){if(typeof e=="string"){const t=ji(e);return this.readFeatureCollectionMetadataFromDocument(t)}return Hi(e)?this.readFeatureCollectionMetadataFromDocument(e):this.readFeatureCollectionMetadataFromNode(e)}}readFeatureCollectionMetadataFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readFeatureCollectionMetadataFromNode(t)}readFeatureCollectionMetadataFromNode(e){const t={},i=Nt(e.getAttribute("numberOfFeatures"));return t.numberOfFeatures=i,O(t,Ra,e,[],this.gmlFormat_)}readTransactionResponseFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readTransactionResponseFromNode(t)}readTransactionResponseFromNode(e){return O({},hp,e,[])}writeGetFeature(e){const t=H(ys[this.version_],"GetFeature");t.setAttribute("service","WFS"),t.setAttribute("version",this.version_),e.handle&&t.setAttribute("handle",e.handle),e.outputFormat&&t.setAttribute("outputFormat",e.outputFormat),e.maxFeatures!==void 0&&t.setAttribute("maxFeatures",String(e.maxFeatures)),e.resultType&&t.setAttribute("resultType",e.resultType),e.startIndex!==void 0&&t.setAttribute("startIndex",String(e.startIndex)),e.count!==void 0&&t.setAttribute("count",String(e.count)),e.viewParams!==void 0&&t.setAttribute("viewParams",e.viewParams),t.setAttributeNS(Qr,"xsi:schemaLocation",this.schemaLocation_);const i={node:t};if(Object.assign(i,{version:this.version_,srsName:e.srsName,featureNS:e.featureNS?e.featureNS:this.featureNS_,featurePrefix:e.featurePrefix,propertyNames:e.propertyNames?e.propertyNames:[]}),et(Array.isArray(e.featureTypes),"`options.featureTypes` must be an Array"),typeof e.featureTypes[0]=="string"){let n=e.filter;e.bbox&&(et(e.geometryName,"`options.geometryName` must also be provided when `options.bbox` is set"),n=this.combineBboxAndFilter(e.geometryName,e.bbox,e.srsName,n)),Object.assign(i,{geometryName:e.geometryName,filter:n}),Wa(t,e.featureTypes,[i])}else e.featureTypes.forEach(n=>{const s=this.combineBboxAndFilter(n.geometryName,n.bbox,e.srsName,e.filter);Object.assign(i,{geometryName:n.geometryName,filter:s}),Wa(t,[n.name],[i])});return t}combineBboxAndFilter(e,t,i,n){const s=cp(e,t,i);return n?lp(n,s):s}writeTransaction(e,t,i,n){const s=[],o=n.version?n.version:this.version_,a=H(ys[o],"Transaction");a.setAttribute("service","WFS"),a.setAttribute("version",o);let l;n&&(l=n.gmlOptions?n.gmlOptions:{},n.handle&&a.setAttribute("handle",n.handle)),a.setAttributeNS(Qr,"xsi:schemaLocation",Aa[o]);const c=pp(a,l,o,n);return e&&Ci("Insert",e,s,c),t&&Ci("Update",t,s,c),i&&Ci("Delete",i,s,c),n.nativeElements&&Ci("Native",n.nativeElements,s,c),a}readProjectionFromDocument(e){for(let t=e.firstChild;t;t=t.nextSibling)if(t.nodeType==Node.ELEMENT_NODE)return this.readProjectionFromNode(t);return null}readProjectionFromNode(e){if(e.firstElementChild&&e.firstElementChild.firstElementChild){e=e.firstElementChild.firstElementChild;for(let t=e.firstElementChild;t;t=t.nextElementSibling)if(!(t.childNodes.length===0||t.childNodes.length===1&&t.firstChild.nodeType===3)){const i=[{}];return this.gmlFormat_.readGeometryElement(t,i),ce(i.pop().srsName)}}return null}}function pp(r,e,t,i){const n=i.featurePrefix?i.featurePrefix:gc;let s;return t==="1.0.0"?s=2:t==="1.1.0"?s=3:t==="2.0.0"&&(s=3.2),Object.assign({node:r},{version:t,featureNS:i.featureNS,featureType:i.featureType,featurePrefix:n,gmlVersion:s,hasZ:i.hasZ,srsName:i.srsName},e)}function Ci(r,e,t,i){_e(i,dc,qe(r),e,t)}function Pa(r,e){return O({},up,r,e)}const mp={"http://www.opengis.net/ogc":{FeatureId:$(function(r,e){return r.getAttribute("fid")})},"http://www.opengis.net/ogc/1.1":{FeatureId:$(function(r,e){return r.getAttribute("fid")})}};function La(r,e){Ut(mp,r,e)}const _p={"http://www.opengis.net/wfs":{Feature:La},"http://www.opengis.net/wfs/2.0":{Feature:La}};function Ia(r,e){return O([],_p,r,e)}function Ca(r,e,t){const i=t[t.length-1],n=i.featureType,s=i.featureNS,o=i.gmlVersion,a=H(s,n);r.appendChild(a),o===2?Q.prototype.writeFeatureElement(a,e,t):o===3?I.prototype.writeFeatureElement(a,e,t):se.prototype.writeFeatureElement(a,e,t)}function pc(r,e,t){const n=t[t.length-1].version,s=co[n],o=H(s,"Filter"),a=H(s,"FeatureId");o.appendChild(a),a.setAttribute("fid",e),r.appendChild(o)}function fo(r,e){r=r||gc;const t=r+":";return e.startsWith(t)?e:t+e}function Fa(r,e,t){const i=t[t.length-1];et(e.getId()!==void 0,"Features must have an id set");const n=i.featureType,s=i.featurePrefix,o=i.featureNS,a=fo(s,n);r.setAttribute("typeName",a),r.setAttributeNS(lo,"xmlns:"+s,o);const l=e.getId();l!==void 0&&pc(r,l,t)}function Oa(r,e,t){const i=t[t.length-1];et(e.getId()!==void 0,"Features must have an id set");const n=i.version,s=i.featureType,o=i.featurePrefix,a=i.featureNS,l=fo(o,s),c=e.getGeometryName();r.setAttribute("typeName",l),r.setAttributeNS(lo,"xmlns:"+o,a);const u=e.getId();if(u!==void 0){const h=e.getKeys(),f=[];for(let g=0,d=h.length;g<d;g++){const p=e.get(h[g]);if(p!==void 0){let m=h[g];p&&typeof p.getSimplifiedGeometry=="function"&&(m=c),f.push({name:m,value:p})}}_e({version:n,gmlVersion:i.gmlVersion,node:r,hasZ:i.hasZ,srsName:i.srsName},dc,qe("Property"),f,t),pc(r,u,t)}}function Ma(r,e,t){const i=t[t.length-1],n=i.version,s=ys[n],a=H(s,n==="2.0.0"?"ValueReference":"Name"),l=i.gmlVersion;if(r.appendChild(a),ee(a,e.name),e.value!==void 0&&e.value!==null){const c=H(s,"Value");r.appendChild(c),e.value&&typeof e.value.getSimplifiedGeometry=="function"?l===2?Q.prototype.writeGeometryElement(c,e.value,t):l===3?I.prototype.writeGeometryElement(c,e.value,t):se.prototype.writeGeometryElement(c,e.value,t):ee(c,e.value)}}function Na(r,e,t){e.vendorId&&r.setAttribute("vendorId",e.vendorId),e.safeToIgnore!==void 0&&r.setAttribute("safeToIgnore",String(e.safeToIgnore)),e.value!==void 0&&ee(r,e.value)}const In={"http://www.opengis.net/wfs":{Query:T(Da)},"http://www.opengis.net/wfs/2.0":{Query:T(Da)},"http://www.opengis.net/ogc":{During:T(Ga),And:T(Fi),Or:T(Fi),Not:T(za),BBOX:T(Ua),Contains:T(Ot),Intersects:T(Ot),Within:T(Ot),DWithin:T(Ba),PropertyIsEqualTo:T(Ke),PropertyIsNotEqualTo:T(Ke),PropertyIsLessThan:T(Ke),PropertyIsLessThanOrEqualTo:T(Ke),PropertyIsGreaterThan:T(Ke),PropertyIsGreaterThanOrEqualTo:T(Ke),PropertyIsNull:T(ka),PropertyIsBetween:T($a),PropertyIsLike:T(Va)},"http://www.opengis.net/fes/2.0":{During:T(Ga),And:T(Fi),Or:T(Fi),Not:T(za),BBOX:T(Ua),Contains:T(Ot),Disjoint:T(Ot),Intersects:T(Ot),ResourceId:T(xp),Within:T(Ot),DWithin:T(Ba),PropertyIsEqualTo:T(Ke),PropertyIsNotEqualTo:T(Ke),PropertyIsLessThan:T(Ke),PropertyIsLessThanOrEqualTo:T(Ke),PropertyIsGreaterThan:T(Ke),PropertyIsGreaterThanOrEqualTo:T(Ke),PropertyIsNull:T(ka),PropertyIsBetween:T($a),PropertyIsLike:T(Va)}};function Da(r,e,t){const i=t[t.length-1],n=i.version,s=i.featurePrefix,o=i.featureNS,a=i.propertyNames,l=i.srsName;let c;s?c=fo(s,e):c=e;let u;n==="2.0.0"?u="typeNames":u="typeName",r.setAttribute(u,c),l&&r.setAttribute("srsName",l),o&&r.setAttributeNS(lo,"xmlns:"+s,o);const h=Object.assign({},i);h.node=r,_e(h,fp,qe("PropertyName"),a,t);const f=i.filter;if(f){const g=H(Cn(n),"Filter");r.appendChild(g),yp(g,f,t)}}function yp(r,e,t){const i=t[t.length-1],n={node:r};Object.assign(n,{context:i}),_e(n,In,qe(e.getTagName()),[e],t)}function Ua(r,e,t){const i=t[t.length-1],s=i.context.version;i.srsName=e.srsName;const o=ho[s];Fr(s,r,e.geometryName),o.prototype.writeGeometryElement(r,e.extent,t)}function xp(r,e,t){r.setAttribute("rid",e.rid)}function Ot(r,e,t){const i=t[t.length-1],s=i.context.version;i.srsName=e.srsName;const o=ho[s];Fr(s,r,e.geometryName),o.prototype.writeGeometryElement(r,e.geometry,t)}function Ba(r,e,t){const s=t[t.length-1].context.version;Ot(r,e,t);const o=H(Cn(s),"Distance");ee(o,e.distance.toString()),s==="2.0.0"?o.setAttribute("uom",e.unit):o.setAttribute("units",e.unit),r.appendChild(o)}function Ga(r,e,t){const s=t[t.length-1].context.version;nn(uo[s],"ValueReference",r,e.propertyName);const o=H(Pt,"TimePeriod");r.appendChild(o);const a=H(Pt,"begin");o.appendChild(a),Xa(a,e.begin);const l=H(Pt,"end");o.appendChild(l),Xa(l,e.end)}function Fi(r,e,t){const n=t[t.length-1].context,s={node:r};Object.assign(s,{context:n});const o=e.conditions;for(let a=0,l=o.length;a<l;++a){const c=o[a];_e(s,In,qe(c.getTagName()),[c],t)}}function za(r,e,t){const n=t[t.length-1].context,s={node:r};Object.assign(s,{context:n});const o=e.condition;_e(s,In,qe(o.getTagName()),[o],t)}function Ke(r,e,t){const s=t[t.length-1].context.version;e.matchCase!==void 0&&r.setAttribute("matchCase",e.matchCase.toString()),Fr(s,r,e.propertyName),sn(s,r,""+e.expression)}function ka(r,e,t){const s=t[t.length-1].context.version;Fr(s,r,e.propertyName)}function $a(r,e,t){const s=t[t.length-1].context.version,o=Cn(s);Fr(s,r,e.propertyName);const a=H(o,"LowerBoundary");r.appendChild(a),sn(s,a,""+e.lowerBoundary);const l=H(o,"UpperBoundary");r.appendChild(l),sn(s,l,""+e.upperBoundary)}function Va(r,e,t){const s=t[t.length-1].context.version;r.setAttribute("wildCard",e.wildCard),r.setAttribute("singleChar",e.singleChar),r.setAttribute("escapeChar",e.escapeChar),e.matchCase!==void 0&&r.setAttribute("matchCase",e.matchCase.toString()),Fr(s,r,e.propertyName),sn(s,r,""+e.pattern)}function nn(r,e,t,i){const n=H(r,e);ee(n,i),t.appendChild(n)}function sn(r,e,t){nn(Cn(r),"Literal",e,t)}function Fr(r,e,t){r==="2.0.0"?nn(uo[r],"ValueReference",e,t):nn(co[r],"PropertyName",e,t)}function Xa(r,e){const t=H(Pt,"TimeInstant");r.appendChild(t);const i=H(Pt,"timePosition");t.appendChild(i),ee(i,e)}function Wa(r,e,t){const i=t[t.length-1],n=Object.assign({},i);n.node=r,_e(n,In,qe("Query"),e,t)}function Cn(r){let e;return r==="2.0.0"?e=uo[r]:e=co[r],e}const ge={POINT:1,LINE_STRING:2,POLYGON:3,MULTI_POINT:4,MULTI_LINE_STRING:5,MULTI_POLYGON:6,GEOMETRY_COLLECTION:7,POLYHEDRAL_SURFACE:15,TIN:16,TRIANGLE:17};class ja{constructor(e){this.view_=e,this.pos_=0,this.initialized_=!1,this.isLittleEndian_=!1,this.hasZ_=!1,this.hasM_=!1,this.srid_=null,this.layout_="XY"}readUint8(){return this.view_.getUint8(this.pos_++)}readUint32(e){return this.view_.getUint32((this.pos_+=4)-4,e!==void 0?e:this.isLittleEndian_)}readDouble(e){return this.view_.getFloat64((this.pos_+=8)-8,e!==void 0?e:this.isLittleEndian_)}readPoint(){const e=[];return e.push(this.readDouble()),e.push(this.readDouble()),this.hasZ_&&e.push(this.readDouble()),this.hasM_&&e.push(this.readDouble()),e}readLineString(){const e=this.readUint32(),t=[];for(let i=0;i<e;i++)t.push(this.readPoint());return t}readPolygon(){const e=this.readUint32(),t=[];for(let i=0;i<e;i++)t.push(this.readLineString());return t}readWkbHeader(e){const i=this.readUint8()>0,n=this.readUint32(i),s=Math.floor((n&268435455)/1e3),o=!!(n&2147483648)||s===1||s===3,a=!!(n&1073741824)||s===2||s===3,l=!!(n&536870912),c=(n&268435455)%1e3,u=["XY",o?"Z":"",a?"M":""].join(""),h=l?this.readUint32(i):null;if(e!==void 0&&e!==c)throw new Error("Unexpected WKB geometry type "+c);if(this.initialized_){if(this.isLittleEndian_!==i)throw new Error("Inconsistent endian");if(this.layout_!==u)throw new Error("Inconsistent geometry layout");if(h&&this.srid_!==h)throw new Error("Inconsistent coordinate system (SRID)")}else this.isLittleEndian_=i,this.hasZ_=o,this.hasM_=a,this.layout_=u,this.srid_=h,this.initialized_=!0;return c}readWkbPayload(e){switch(e){case ge.POINT:return this.readPoint();case ge.LINE_STRING:return this.readLineString();case ge.POLYGON:case ge.TRIANGLE:return this.readPolygon();case ge.MULTI_POINT:return this.readMultiPoint();case ge.MULTI_LINE_STRING:return this.readMultiLineString();case ge.MULTI_POLYGON:case ge.POLYHEDRAL_SURFACE:case ge.TIN:return this.readMultiPolygon();case ge.GEOMETRY_COLLECTION:return this.readGeometryCollection();default:throw new Error("Unsupported WKB geometry type "+e+" is found")}}readWkbBlock(e){return this.readWkbPayload(this.readWkbHeader(e))}readWkbCollection(e,t){const i=this.readUint32(),n=[];for(let s=0;s<i;s++){const o=e.call(this,t);o&&n.push(o)}return n}readMultiPoint(){return this.readWkbCollection(this.readWkbBlock,ge.POINT)}readMultiLineString(){return this.readWkbCollection(this.readWkbBlock,ge.LINE_STRING)}readMultiPolygon(){return this.readWkbCollection(this.readWkbBlock,ge.POLYGON)}readGeometryCollection(){return this.readWkbCollection(this.readGeometry)}readGeometry(){const e=this.readWkbHeader(),t=this.readWkbPayload(e);switch(e){case ge.POINT:return new xt(t,this.layout_);case ge.LINE_STRING:return new Lt(t,this.layout_);case ge.POLYGON:case ge.TRIANGLE:return new Rn(t,this.layout_);case ge.MULTI_POINT:return new Hs(t,this.layout_);case ge.MULTI_LINE_STRING:return new fi(t,this.layout_);case ge.MULTI_POLYGON:case ge.POLYHEDRAL_SURFACE:case ge.TIN:return new vn(t,this.layout_);case ge.GEOMETRY_COLLECTION:return new ti(t);default:return null}}getSrid(){return this.srid_}}class Ep{constructor(e){e=e||{},this.layout_=e.layout,this.isLittleEndian_=e.littleEndian!==!1,this.isEWKB_=e.ewkb!==!1,this.writeQueue_=[],this.nodata_=Object.assign({X:0,Y:0,Z:0,M:0},e.nodata)}writeUint8(e){this.writeQueue_.push([1,e])}writeUint32(e){this.writeQueue_.push([4,e])}writeDouble(e){this.writeQueue_.push([8,e])}writePoint(e,t){const i=Object.assign.apply(null,t.split("").map((n,s)=>({[n]:e[s]})));for(const n of this.layout_)this.writeDouble(n in i?i[n]:this.nodata_[n])}writeLineString(e,t){this.writeUint32(e.length);for(let i=0;i<e.length;i++)this.writePoint(e[i],t)}writePolygon(e,t){this.writeUint32(e.length);for(let i=0;i<e.length;i++)this.writeLineString(e[i],t)}writeWkbHeader(e,t){e%=1e3,this.layout_.includes("Z")&&(e+=this.isEWKB_?2147483648:1e3),this.layout_.includes("M")&&(e+=this.isEWKB_?1073741824:2e3),this.isEWKB_&&Number.isInteger(t)&&(e|=536870912),this.writeUint8(this.isLittleEndian_?1:0),this.writeUint32(e),this.isEWKB_&&Number.isInteger(t)&&this.writeUint32(t)}writeMultiPoint(e,t){this.writeUint32(e.length);for(let i=0;i<e.length;i++)this.writeWkbHeader(1),this.writePoint(e[i],t)}writeMultiLineString(e,t){this.writeUint32(e.length);for(let i=0;i<e.length;i++)this.writeWkbHeader(2),this.writeLineString(e[i],t)}writeMultiPolygon(e,t){this.writeUint32(e.length);for(let i=0;i<e.length;i++)this.writeWkbHeader(3),this.writePolygon(e[i],t)}writeGeometryCollection(e){this.writeUint32(e.length);for(let t=0;t<e.length;t++)this.writeGeometry(e[t])}findMinimumLayout(e,t="XYZM"){const i=(n,s)=>n===s?n:n==="XYZM"?s:s==="XYZM"?n:"XY";if(e instanceof la)return i(e.getLayout(),t);if(e instanceof ti){const n=e.getGeometriesArray();for(let s=0;s<n.length&&t!=="XY";s++)t=this.findMinimumLayout(n[s],t)}return t}writeGeometry(e,t){const i={Point:ge.POINT,LineString:ge.LINE_STRING,Polygon:ge.POLYGON,MultiPoint:ge.MULTI_POINT,MultiLineString:ge.MULTI_LINE_STRING,MultiPolygon:ge.MULTI_POLYGON,GeometryCollection:ge.GEOMETRY_COLLECTION},n=e.getType(),s=i[n];if(!s)throw new Error("GeometryType "+n+" is not supported");this.layout_||(this.layout_=this.findMinimumLayout(e)),this.writeWkbHeader(s,t),e instanceof la?{Point:this.writePoint,LineString:this.writeLineString,Polygon:this.writePolygon,MultiPoint:this.writeMultiPoint,MultiLineString:this.writeMultiLineString,MultiPolygon:this.writeMultiPolygon}[n].call(this,e.getCoordinates(),e.getLayout()):e instanceof ti&&this.writeGeometryCollection(e.getGeometriesArray())}getBuffer(){const e=this.writeQueue_.reduce((s,o)=>s+o[0],0),t=new ArrayBuffer(e),i=new DataView(t);let n=0;return this.writeQueue_.forEach(s=>{switch(s[0]){case 1:i.setUint8(n,s[1]);break;case 4:i.setUint32(n,s[1],this.isLittleEndian_);break;case 8:i.setFloat64(n,s[1],this.isLittleEndian_);break}n+=s[0]}),t}}class bp extends uf{constructor(e){super(),e=e||{},this.splitCollection=!!e.splitCollection,this.viewCache_=null,this.hex_=e.hex!==!1,this.littleEndian_=e.littleEndian!==!1,this.ewkb_=e.ewkb!==!1,this.layout_=e.geometryLayout,this.nodataZ_=e.nodataZ||0,this.nodataM_=e.nodataM||0,this.srid_=e.srid}getType(){return this.hex_?"text":"arraybuffer"}readFeature(e,t){return new lt({geometry:this.readGeometry(e,t)})}readFeatures(e,t){let i=[];const n=this.readGeometry(e,t);return this.splitCollection&&n instanceof ti?i=n.getGeometriesArray():i=[n],i.map(s=>new lt({geometry:s}))}readGeometry(e,t){const i=Ha(e);if(!i)return null;const s=new ja(i).readGeometry();return this.viewCache_=i,t=this.getReadOptions(e,t),this.viewCache_=null,Ue(s,!1,t)}readProjection(e){const t=this.viewCache_||Ha(e);if(!t)return;const i=new ja(t);return i.readWkbHeader(),i.getSrid()&&ce("EPSG:"+i.getSrid())||void 0}writeFeature(e,t){return this.writeGeometry(e.getGeometry(),t)}writeFeatures(e,t){return this.writeGeometry(new ti(e.map(i=>i.getGeometry())),t)}writeGeometry(e,t){t=this.adaptOptions(t);const i=new Ep({layout:this.layout_,littleEndian:this.littleEndian_,ewkb:this.ewkb_,nodata:{Z:this.nodataZ_,M:this.nodataM_}});let n=Number.isInteger(this.srid_)?Number(this.srid_):null;if(this.srid_!==!1&&!Number.isInteger(this.srid_)){const o=t.dataProjection&&ce(t.dataProjection);if(o){const a=o.getCode();a.startsWith("EPSG:")&&(n=Number(a.substring(5)))}}i.writeGeometry(Ue(e,!0,t),n);const s=i.getBuffer();return this.hex_?Tp(s):s}}function Tp(r){const e=new Uint8Array(r);return Array.from(e.values()).map(t=>(t<16?"0":"")+Number(t).toString(16).toUpperCase()).join("")}function wp(r){const e=new Uint8Array(r.length/2);for(let t=0;t<r.length/2;t++)e[t]=parseInt(r.substr(t*2,2),16);return new DataView(e.buffer)}function Ha(r){return typeof r=="string"?wp(r):ArrayBuffer.isView(r)?r instanceof DataView?r:new DataView(r.buffer,r.byteOffset,r.byteLength):r instanceof ArrayBuffer?new DataView(r):null}const Re=[null,"http://www.opengis.net/wms"];function Or(r){return hf(r[0].version,"1.3")>=0}const Sp=D(Re,{Service:b(Hp),Capability:b(jp)}),mc={Request:b(rm),Exception:b(Kp),Layer:b(Jp)},vp=D(Re,{...mc,UserDefinedSymbolization:b(Xp)}),Rp=D(Re,mc);class Ap extends ao{constructor(){super(),this.version=void 0}readFromNode(e){this.version=e.getAttribute("version").trim();const t=O({version:this.version},Sp,e,[]);return t||null}}const _c={Name:b(F),Title:b(F),Abstract:b(F),KeywordList:b(wc),OnlineResource:b(Cr),ContactInformation:b(Zp),Fees:b(F),AccessConstraints:b(F)},Pp=D(Re,_c),Lp=D(Re,{..._c,LayerLimit:b(Te),MaxWidth:b(Te),MaxHeight:b(Te)}),Ip=D(Re,{ContactPersonPrimary:b(Yp),ContactPosition:b(F),ContactAddress:b(qp),ContactVoiceTelephone:b(F),ContactFacsimileTelephone:b(F),ContactElectronicMailAddress:b(F)}),Cp=D(Re,{ContactPerson:b(F),ContactOrganization:b(F)}),Fp=D(Re,{AddressType:b(F),Address:b(F),City:b(F),StateOrProvince:b(F),PostCode:b(F),Country:b(F)}),Op=D(Re,{Format:$(F)}),yc={Name:b(F),Title:b(F),Abstract:b(F),KeywordList:b(wc),BoundingBox:fe(bc),Dimension:fe(Qp),Attribution:b(Vp),AuthorityURL:fe(sm),Identifier:fe(F),MetadataURL:fe(om),DataURL:fe(Ct),FeatureListURL:fe(Ct),Style:fe(am),Layer:fe(Fn)},xc=D(Re,{...yc,SRS:fe(F),Extent:b(em),ScaleHint:fe(tm),LatLonBoundingBox:b((r,e)=>bc(r,e,!1)),Layer:fe(Fn)}),Ec=D(Re,{...yc,CRS:fe(F),EX_GeographicBoundingBox:b(Wp),MinScaleDenominator:b(De),MaxScaleDenominator:b(De),Layer:fe(Fn)}),Mp=D(Re,{Title:b(F),OnlineResource:b(Cr),LogoURL:b(Tc)}),Np=D(Re,{westBoundLongitude:b(De),eastBoundLongitude:b(De),southBoundLatitude:b(De),northBoundLatitude:b(De)}),Dp=D(Re,{GetCapabilities:b(Xn),GetMap:b(Xn),GetFeatureInfo:b(Xn)}),Up=D(Re,{Format:fe(F),DCPType:fe(im)}),Bp=D(Re,{HTTP:b(nm)}),Gp=D(Re,{Get:b(Ct),Post:b(Ct)}),zp=D(Re,{Name:b(F),Title:b(F),Abstract:b(F),LegendURL:fe(Tc),StyleSheetURL:b(Ct),StyleURL:b(Ct)}),kp=D(Re,{Format:b(F),OnlineResource:b(Cr)}),$p=D(Re,{Keyword:$(F)});function Vp(r,e){return O({},Mp,r,e)}function Xp(r,e){return{SupportSLD:!!it(r.getAttribute("UserDefinedSymbolization")),UserLayer:!!it(r.getAttribute("UserLayer")),UserStyle:!!it(r.getAttribute("UserStyle")),RemoteWFS:!!it(r.getAttribute("RemoteWFS"))}}function bc(r,e,t=!0){const i=[mt(r.getAttribute("minx")),mt(r.getAttribute("miny")),mt(r.getAttribute("maxx")),mt(r.getAttribute("maxy"))],n=[mt(r.getAttribute("resx")),mt(r.getAttribute("resy"))],s={extent:i,res:n};return t&&(Or(e)?s.crs=r.getAttribute("CRS"):s.srs=r.getAttribute("SRS")),s}function Wp(r,e){const t=O({},Np,r,e);if(!t)return;const i=t.westBoundLongitude,n=t.southBoundLatitude,s=t.eastBoundLongitude,o=t.northBoundLatitude;if(!(i===void 0||n===void 0||s===void 0||o===void 0))return[i,n,s,o]}function jp(r,e){return O({},Or(e)?Rp:vp,r,e)}function Hp(r,e){return O({},Or(e)?Lp:Pp,r,e)}function Zp(r,e){return O({},Ip,r,e)}function Yp(r,e){return O({},Cp,r,e)}function qp(r,e){return O({},Fp,r,e)}function Kp(r,e){return O([],Op,r,e)}function Jp(r,e){const t=O({},Or(e)?Ec:xc,r,e);return t.Layer===void 0?Object.assign(t,Fn(r,e)):t}function Fn(r,e){const t=Or(e),i=e[e.length-1],n=O({},t?Ec:xc,r,e);if(!n)return;let s=it(r.getAttribute("queryable"));s===void 0&&(s=i.queryable),n.queryable=s!==void 0?s:!1;let o=Nt(r.getAttribute("cascaded"));o===void 0&&(o=i.cascaded),n.cascaded=o;let a=it(r.getAttribute("opaque"));a===void 0&&(a=i.opaque),n.opaque=a!==void 0?a:!1;let l=it(r.getAttribute("noSubsets"));l===void 0&&(l=i.noSubsets),n.noSubsets=l!==void 0?l:!1;let c=mt(r.getAttribute("fixedWidth"));c||(c=i.fixedWidth),n.fixedWidth=c;let u=mt(r.getAttribute("fixedHeight"));u||(u=i.fixedHeight),n.fixedHeight=u;const h=["Style","AuthorityURL"];t?h.push("CRS"):h.push("SRS","Dimension"),h.forEach(function(g){if(g in i){const d=n[g]||[];n[g]=d.concat(i[g])}});const f=["BoundingBox","Attribution"];return t?f.push("Dimension","EX_GeographicBoundingBox","MinScaleDenominator","MaxScaleDenominator"):f.push("LatLonBoundingBox","ScaleHint","Extent"),f.forEach(function(g){if(!(g in n)){const d=i[g];n[g]=d}}),n}function Qp(r,e){const t={name:r.getAttribute("name"),units:r.getAttribute("units"),unitSymbol:r.getAttribute("unitSymbol")};return Or(e)&&Object.assign(t,{default:r.getAttribute("default"),multipleValues:it(r.getAttribute("multipleValues")),nearestValue:it(r.getAttribute("nearestValue")),current:it(r.getAttribute("current")),values:F(r)}),t}function em(r,e){return{name:r.getAttribute("name"),default:r.getAttribute("default"),nearestValue:it(r.getAttribute("nearestValue"))}}function tm(r,e){return{min:mt(r.getAttribute("min")),max:mt(r.getAttribute("max"))}}function Ct(r,e){return O({},kp,r,e)}function rm(r,e){return O({},Dp,r,e)}function im(r,e){return O({},Bp,r,e)}function nm(r,e){return O({},Gp,r,e)}function Xn(r,e){return O({},Up,r,e)}function Tc(r,e){const t=Ct(r,e);if(t){const i=[Nt(r.getAttribute("width")),Nt(r.getAttribute("height"))];return t.size=i,t}}function sm(r,e){const t=Ct(r,e);if(t)return t.name=r.getAttribute("name"),t}function om(r,e){const t=Ct(r,e);if(t)return t.type=r.getAttribute("type"),t}function am(r,e){return O({},zp,r,e)}function wc(r,e){return O([],$p,r,e)}const lm="_feature",cm="_layer";class um extends xn{constructor(e){super(),e=e||{},this.featureNS_="http://mapserver.gis.umn.edu/mapserver",this.gmlFormat_=new Q,this.layers_=e.layers?e.layers:null}getLayers(){return this.layers_}setLayers(e){this.layers_=e}readFeatures_(e,t){e.setAttribute("namespaceURI",this.featureNS_);const i=e.localName;let n=[];if(e.childNodes.length===0)return n;if(i=="msGMLOutput")for(let s=0,o=e.childNodes.length;s<o;s++){const a=e.childNodes[s];if(a.nodeType!==Node.ELEMENT_NODE)continue;const l=a,c=t[0],u=cm,h=l.localName.replace(u,"");if(this.layers_&&!this.layers_.includes(h))continue;const f=h+lm;c.featureType=f,c.featureNS=this.featureNS_;const g={};g[f]=$(this.gmlFormat_.readFeatureElement,this.gmlFormat_);const d=D([c.featureNS,null],g);l.setAttribute("namespaceURI",this.featureNS_);const p=O([],d,l,t,this.gmlFormat_);p&&tn(n,p)}if(i=="FeatureCollection"){const s=O([],this.gmlFormat_.FEATURE_COLLECTION_PARSERS,e,[{}],this.gmlFormat_);s&&(n=s)}return n}readFeaturesFromNode(e,t){const i={};return t&&Object.assign(i,this.getReadOptions(e,t)),this.readFeatures_(e,[i])}}const bt=[null,"http://www.opengis.net/wmts/1.0"],Mr=[null,"http://www.opengis.net/ows/1.1"],hm=D(bt,{Contents:b(bm)});let go=class extends ao{constructor(){super(),this.owsParser_=new hc}readFromNode(e){let t=e.getAttribute("version");t&&(t=t.trim());let i=this.owsParser_.readFromNode(e);return i?(i.version=t,i=O(i,hm,e,[]),i||null):null}};const fm=D(bt,{Layer:fe(Tm),TileMatrixSet:fe(wm)}),dm=D(bt,{Style:fe(Sm),Format:fe(F),TileMatrixSetLink:fe(vm),Dimension:fe(Rm),ResourceURL:fe(Am)},D(Mr,{Title:b(F),Abstract:b(F),WGS84BoundingBox:b(vc),BoundingBox:fe(Pm),Identifier:b(F)})),gm=D(bt,{LegendURL:fe(Lm)},D(Mr,{Title:b(F),Identifier:b(F)})),pm=D(bt,{TileMatrixSet:b(F),TileMatrixSetLimits:b(Cm)}),mm=D(bt,{TileMatrixLimits:$(Fm)}),_m=D(bt,{TileMatrix:b(F),MinTileRow:b(Te),MaxTileRow:b(Te),MinTileCol:b(Te),MaxTileCol:b(Te)}),ym=D(bt,{Default:b(F),Value:fe(F)},D(Mr,{Identifier:b(F)})),Sc=D(Mr,{LowerCorner:$(xs),UpperCorner:$(xs)}),xm=D(bt,{WellKnownScaleSet:b(F),TileMatrix:fe(Im)},D(Mr,{SupportedCRS:b(F),Identifier:b(F),BoundingBox:b(vc)})),Em=D(bt,{TopLeftCorner:b(xs),ScaleDenominator:b(De),TileWidth:b(Te),TileHeight:b(Te),MatrixWidth:b(Te),MatrixHeight:b(Te)},D(Mr,{Identifier:b(F)}));function bm(r,e){return O({},fm,r,e)}function Tm(r,e){return O({},dm,r,e)}function wm(r,e){return O({},xm,r,e)}function Sm(r,e){const t=O({},gm,r,e);if(!t)return;const i=r.getAttribute("isDefault")==="true";return t.isDefault=i,t}function vm(r,e){return O({},pm,r,e)}function Rm(r,e){return O({},ym,r,e)}function Am(r,e){const t=r.getAttribute("format"),i=r.getAttribute("template"),n=r.getAttribute("resourceType"),s={};return t&&(s.format=t),i&&(s.template=i),n&&(s.resourceType=n),s}function vc(r,e){const t=O([],Sc,r,e);if(t.length==2)return Qs(t)}function Pm(r,e){const t=r.getAttribute("crs"),i=O([],Sc,r,e);if(i.length==2)return{extent:Qs(i),crs:t}}function Lm(r,e){const t={};return t.format=r.getAttribute("format"),t.href=Cr(r),t}function xs(r,e){const t=F(r).split(/\s+/);if(!t||t.length!=2)return;const i=+t[0],n=+t[1];if(!(isNaN(i)||isNaN(n)))return[i,n]}function Im(r,e){return O({},Em,r,e)}function Cm(r,e){return O([],mm,r,e)}function Fm(r,e){return O({},_m,r,e)}window.eoxMapAdvancedOlFormats={EsriJSON:nd,GML:ro,GPX:Cd,IGC:dg,IIIFInfo:xg,KML:gh,OWS:hc,Polyline:Yg,TopoJSON:dh,WFS:gp,WKB:bp,WKT:Gf,WMSCapabilities:Ap,WMSGetFeatureInfo:um,WMTSCapabilities:go};function Rc(r,e,t){const i=[];let n=r(0),s=r(1),o=e(n),a=e(s);const l=[s,n],c=[a,o],u=[1,0],h={};let f=1e5,g,d,p,m,y,_;for(;--f>0&&u.length>0;)p=u.pop(),n=l.pop(),o=c.pop(),_=p.toString(),_ in h||(i.push(o[0],o[1]),h[_]=!0),m=u.pop(),s=l.pop(),a=c.pop(),y=(p+m)/2,g=r(y),d=e(g),wf(d[0],d[1],o[0],o[1],a[0],a[1])<t?(i.push(a[0],a[1]),_=m.toString(),h[_]=!0):(u.push(m,y,y,p),c.push(a,d,d,o),l.push(s,g,g,n));return i}function Om(r,e,t,i,n){const s=ce("EPSG:4326");return Rc(function(o){return[r,e+(t-e)*o]},Qi(s,i),n)}function Mm(r,e,t,i,n){const s=ce("EPSG:4326");return Rc(function(o){return[e+(t-e)*o,r]},Qi(s,i),n)}function Nm(r){if(!(r.context instanceof CanvasRenderingContext2D))throw new Error("Only works for render events from Canvas 2D layers");const e=r.inversePixelTransform[0],t=r.inversePixelTransform[1],i=Math.sqrt(e*e+t*t),n=r.frameState,s=ri(r.inversePixelTransform.slice(),n.coordinateToPixelTransform),o=ph(n.viewState.resolution,i);let a;return new mh(r.context,i,n.extent,s,n.viewState.rotation,o,a)}const Dm=new Yi({color:"rgba(0,0,0,0.2)"}),Um=[90,45,30,20,10,5,2,1,30/60,20/60,10/60,5/60,2/60,1/60,30/3600,20/3600,10/3600,5/3600,2/3600,1/3600];class Bm extends kl{constructor(e){e=e||{};const t=Object.assign({updateWhileAnimating:!0,updateWhileInteracting:!0,renderBuffer:0},e);delete t.maxLines,delete t.strokeStyle,delete t.targetSize,delete t.showLabels,delete t.lonLabelFormatter,delete t.latLabelFormatter,delete t.lonLabelPosition,delete t.latLabelPosition,delete t.lonLabelStyle,delete t.latLabelStyle,delete t.intervals,super(t),this.projection_=null,this.maxLat_=1/0,this.maxLon_=1/0,this.minLat_=-1/0,this.minLon_=-1/0,this.maxX_=1/0,this.maxY_=1/0,this.minX_=-1/0,this.minY_=-1/0,this.targetSize_=e.targetSize!==void 0?e.targetSize:100,this.maxLines_=e.maxLines!==void 0?e.maxLines:100,this.meridians_=[],this.parallels_=[],this.strokeStyle_=e.strokeStyle!==void 0?e.strokeStyle:Dm,this.fromLonLatTransform_=void 0,this.toLonLatTransform_=void 0,this.projectionCenterLonLat_=null,this.bottomLeft_=null,this.bottomRight_=null,this.topLeft_=null,this.topRight_=null,this.meridiansLabels_=null,this.parallelsLabels_=null,e.showLabels&&(this.lonLabelFormatter_=e.lonLabelFormatter==null?ca.bind(this,"EW"):e.lonLabelFormatter,this.latLabelFormatter_=e.latLabelFormatter==null?ca.bind(this,"NS"):e.latLabelFormatter,this.lonLabelPosition_=e.lonLabelPosition==null?0:e.lonLabelPosition,this.latLabelPosition_=e.latLabelPosition==null?1:e.latLabelPosition,this.lonLabelStyleBase_=new zi({text:e.lonLabelStyle!==void 0?e.lonLabelStyle.clone():new oa({font:"12px Calibri,sans-serif",textBaseline:"bottom",fill:new qi({color:"rgba(0,0,0,1)"}),stroke:new Yi({color:"rgba(255,255,255,1)",width:3})})}),this.lonLabelStyle_=i=>{const n=i.get("graticule_label");return this.lonLabelStyleBase_.getText().setText(n),this.lonLabelStyleBase_},this.latLabelStyleBase_=new zi({text:e.latLabelStyle!==void 0?e.latLabelStyle.clone():new oa({font:"12px Calibri,sans-serif",textAlign:"right",fill:new qi({color:"rgba(0,0,0,1)"}),stroke:new Yi({color:"rgba(255,255,255,1)",width:3})})}),this.latLabelStyle_=i=>{const n=i.get("graticule_label");return this.latLabelStyleBase_.getText().setText(n),this.latLabelStyleBase_},this.meridiansLabels_=[],this.parallelsLabels_=[],this.addEventListener(Zt.POSTRENDER,this.drawLabels_.bind(this))),this.intervals_=e.intervals!==void 0?e.intervals:Um,this.setSource(new bn({loader:this.loaderFunction.bind(this),strategy:this.strategyFunction.bind(this),features:new kf,overlaps:!1,useSpatialIndex:!1,wrapX:e.wrapX})),this.featurePool_=[],this.lineStyle_=new zi({stroke:this.strokeStyle_}),this.loadedExtent_=null,this.renderedExtent_=null,this.renderedResolution_=null,this.setRenderOrder(null)}strategyFunction(e,t){let i=e.slice();return this.projection_&&this.getSource().getWrapX()&&Sf(i,this.projection_),this.loadedExtent_&&(vf(this.loadedExtent_,i,t)?i=this.loadedExtent_.slice():this.getSource().removeLoadedExtent(this.loadedExtent_)),[i]}loaderFunction(e,t,i){this.loadedExtent_=e;const n=this.getSource(),s=this.getExtent()||[-1/0,-1/0,1/0,1/0],o=Et(s,e);if(this.renderedExtent_&&si(this.renderedExtent_,o)&&this.renderedResolution_===t||(this.renderedExtent_=o,this.renderedResolution_=t,An(o)))return;const a=Bt(o),l=t*t/4;(!this.projection_||!ki(this.projection_,i))&&this.updateProjectionInfo_(i),this.createGraticule_(o,a,t,l);let u=this.meridians_.length+this.parallels_.length;this.meridiansLabels_&&(u+=this.meridians_.length),this.parallelsLabels_&&(u+=this.parallels_.length);let h;for(;u>this.featurePool_.length;)h=new lt,this.featurePool_.push(h);const f=n.getFeaturesCollection();f.clear();let g=0,d,p;for(d=0,p=this.meridians_.length;d<p;++d)h=this.featurePool_[g++],h.setGeometry(this.meridians_[d]),h.setStyle(this.lineStyle_),f.push(h);for(d=0,p=this.parallels_.length;d<p;++d)h=this.featurePool_[g++],h.setGeometry(this.parallels_[d]),h.setStyle(this.lineStyle_),f.push(h)}addMeridian_(e,t,i,n,s,o){const a=this.getMeridian_(e,t,i,n,o);if(Er(a.getExtent(),s)){if(this.meridiansLabels_){const l=this.lonLabelFormatter_(e);o in this.meridiansLabels_?this.meridiansLabels_[o].text=l:this.meridiansLabels_[o]={geom:new xt([]),text:l}}this.meridians_[o++]=a}return o}addParallel_(e,t,i,n,s,o){const a=this.getParallel_(e,t,i,n,o);if(Er(a.getExtent(),s)){if(this.parallelsLabels_){const l=this.latLabelFormatter_(e);o in this.parallelsLabels_?this.parallelsLabels_[o].text=l:this.parallelsLabels_[o]={geom:new xt([]),text:l}}this.parallels_[o++]=a}return o}drawLabels_(e){const t=e.frameState.viewState.rotation,i=e.frameState.viewState.resolution,n=e.frameState.size,s=e.frameState.extent,o=Bt(s);let a=s;if(t){const d=n[0]*i,p=n[1]*i;a=[o[0]-d/2,o[1]-p/2,o[0]+d/2,o[1]+p/2]}let l=0,c=0,u=this.latLabelPosition_<.5;const h=this.projection_.getExtent(),f=Fe(h);if(this.getSource().getWrapX()&&this.projection_.canWrapX()&&!en(h,s)){l=Math.floor((s[0]-h[0])/f),c=Math.ceil((s[2]-h[2])/f);const d=Math.abs(t)>Math.PI/2;u=u!==d}const g=Nm(e);for(let d=l;d<=c;++d){let p=this.meridians_.length+this.parallels_.length,m,y,_,E;if(this.meridiansLabels_)for(y=0,_=this.meridiansLabels_.length;y<_;++y){const S=this.meridians_[y];if(!t&&d===0)E=this.getMeridianPoint_(S,s,y);else{const v=S.clone();v.translate(d*f,0),v.rotate(-t,o),E=this.getMeridianPoint_(v,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.meridiansLabels_[y].text),g.drawFeature(m,this.lonLabelStyle_(m))}if(this.parallelsLabels_&&(d===l&&u||d===c&&!u))for(y=0,_=this.parallels_.length;y<_;++y){const S=this.parallels_[y];if(!t&&d===0)E=this.getParallelPoint_(S,s,y);else{const v=S.clone();v.translate(d*f,0),v.rotate(-t,o),E=this.getParallelPoint_(v,a,y),E.rotate(t,o)}m=this.featurePool_[p++],m.setGeometry(E),m.set("graticule_label",this.parallelsLabels_[y].text),g.drawFeature(m,this.latLabelStyle_(m))}}}createGraticule_(e,t,i,n){const s=this.getInterval_(i);if(s==-1){this.meridians_.length=0,this.parallels_.length=0,this.meridiansLabels_&&(this.meridiansLabels_.length=0),this.parallelsLabels_&&(this.parallelsLabels_.length=0);return}let o=!1;const a=this.projection_.getExtent(),l=Fe(a);this.getSource().getWrapX()&&this.projection_.canWrapX()&&!en(a,e)&&(Fe(e)>=l?(e[0]=a[0],e[2]=a[2]):o=!0);const c=[Ee(t[0],this.minX_,this.maxX_),Ee(t[1],this.minY_,this.maxY_)],u=this.toLonLatTransform_(c);isNaN(u[1])&&(u[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_);let h=Ee(u[0],this.minLon_,this.maxLon_),f=Ee(u[1],this.minLat_,this.maxLat_);const g=this.maxLines_;let d,p,m,y,_=e;o||(_=[Ee(e[0],this.minX_,this.maxX_),Ee(e[1],this.minY_,this.maxY_),Ee(e[2],this.minX_,this.maxX_),Ee(e[3],this.minY_,this.maxY_)]);const E=br(_,this.toLonLatTransform_,void 0,8);let S=E[3],v=E[2],w=E[1],A=E[0];if(o||(pr(_,this.bottomLeft_)&&(A=this.minLon_,w=this.minLat_),pr(_,this.bottomRight_)&&(v=this.maxLon_,w=this.minLat_),pr(_,this.topLeft_)&&(A=this.minLon_,S=this.maxLat_),pr(_,this.topRight_)&&(v=this.maxLon_,S=this.maxLat_),S=Ee(S,f,this.maxLat_),v=Ee(v,h,this.maxLon_),w=Ee(w,this.minLat_,f),A=Ee(A,this.minLon_,h)),h=Math.floor(h/s)*s,y=Ee(h,this.minLon_,this.maxLon_),p=this.addMeridian_(y,w,S,n,e,0),d=0,o)for(;(y-=s)>=A&&d++<g;)p=this.addMeridian_(y,w,S,n,e,p);else for(;y!=this.minLon_&&d++<g;)y=Math.max(y-s,this.minLon_),p=this.addMeridian_(y,w,S,n,e,p);if(y=Ee(h,this.minLon_,this.maxLon_),d=0,o)for(;(y+=s)<=v&&d++<g;)p=this.addMeridian_(y,w,S,n,e,p);else for(;y!=this.maxLon_&&d++<g;)y=Math.min(y+s,this.maxLon_),p=this.addMeridian_(y,w,S,n,e,p);for(this.meridians_.length=p,this.meridiansLabels_&&(this.meridiansLabels_.length=p),f=Math.floor(f/s)*s,m=Ee(f,this.minLat_,this.maxLat_),p=this.addParallel_(m,A,v,n,e,0),d=0;m!=this.minLat_&&d++<g;)m=Math.max(m-s,this.minLat_),p=this.addParallel_(m,A,v,n,e,p);for(m=Ee(f,this.minLat_,this.maxLat_),d=0;m!=this.maxLat_&&d++<g;)m=Math.min(m+s,this.maxLat_),p=this.addParallel_(m,A,v,n,e,p);this.parallels_.length=p,this.parallelsLabels_&&(this.parallelsLabels_.length=p)}getInterval_(e){const t=this.projectionCenterLonLat_[0],i=this.projectionCenterLonLat_[1];let n=-1;const s=Math.pow(this.targetSize_*e,2),o=[],a=[];for(let l=0,c=this.intervals_.length;l<c;++l){const u=Ee(this.intervals_[l]/2,0,90),h=Ee(i,-90+u,90-u);if(o[0]=t-u,o[1]=h-u,a[0]=t+u,a[1]=h+u,this.fromLonLatTransform_(o,o),this.fromLonLatTransform_(a,a),Math.pow(a[0]-o[0],2)+Math.pow(a[1]-o[1],2)<=s)break;n=this.intervals_[l]}return n}getMeridian_(e,t,i,n,s){const o=Om(e,t,i,this.projection_,n);let a=this.meridians_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):(a=new Lt(o,"XY"),this.meridians_[s]=a),a}getMeridianPoint_(e,t,i){const n=e.getFlatCoordinates();let s=1,o=n.length-1;n[s]>n[o]&&(s=o,o=1);const a=Math.max(t[1],n[s]),l=Math.min(t[3],n[o]),c=Ee(t[1]+Math.abs(t[1]-t[3])*this.lonLabelPosition_,a,l),h=[n[s-1]+(n[o-1]-n[s-1])*(c-n[s])/(n[o]-n[s]),c],f=this.meridiansLabels_[i].geom;return f.setCoordinates(h),f}getMeridians(){return this.meridians_}getParallel_(e,t,i,n,s){const o=Mm(e,t,i,this.projection_,n);let a=this.parallels_[s];return a?(a.setFlatCoordinates("XY",o),a.changed()):a=new Lt(o,"XY"),a}getParallelPoint_(e,t,i){const n=e.getFlatCoordinates();let s=0,o=n.length-2;n[s]>n[o]&&(s=o,o=0);const a=Math.max(t[0],n[s]),l=Math.min(t[2],n[o]),c=Ee(t[0]+Math.abs(t[0]-t[2])*this.latLabelPosition_,a,l),u=n[s+1]+(n[o+1]-n[s+1])*(c-n[s])/(n[o]-n[s]),h=[c,u],f=this.parallelsLabels_[i].geom;return f.setCoordinates(h),f}getParallels(){return this.parallels_}updateProjectionInfo_(e){const t=ce("EPSG:4326"),i=e.getWorldExtent();this.maxLat_=i[3],this.maxLon_=i[2],this.minLat_=i[1],this.minLon_=i[0];const n=Qi(e,t);if(this.minLon_<this.maxLon_)this.toLonLatTransform_=n;else{const o=this.minLon_+this.maxLon_/2;this.maxLon_+=360,this.toLonLatTransform_=function(a,l,c){c=c||2;const u=n(a,l,c);for(let h=0,f=u.length;h<f;h+=c)u[h]<o&&(u[h]+=360);return u}}this.fromLonLatTransform_=Qi(t,e);const s=br([this.minLon_,this.minLat_,this.maxLon_,this.maxLat_],this.fromLonLatTransform_,void 0,8);this.minX_=s[0],this.maxX_=s[2],this.minY_=s[1],this.maxY_=s[3],this.bottomLeft_=this.fromLonLatTransform_([this.minLon_,this.minLat_]),this.bottomRight_=this.fromLonLatTransform_([this.maxLon_,this.minLat_]),this.topLeft_=this.fromLonLatTransform_([this.minLon_,this.maxLat_]),this.topRight_=this.fromLonLatTransform_([this.maxLon_,this.maxLat_]),this.projectionCenterLonLat_=this.toLonLatTransform_(Bt(e.getExtent())),isNaN(this.projectionCenterLonLat_[1])&&(this.projectionCenterLonLat_[1]=Math.abs(this.maxLat_)>=Math.abs(this.minLat_)?this.maxLat_:this.minLat_),this.projection_=e}}function rr(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function on(r,e){return r[0]=e[0],r[1]=e[1],r[4]=e[2],r[5]=e[3],r[12]=e[4],r[13]=e[5],r}function Es(r,e,t,i,n,s,o){o=o??rr();const a=1/(r-e),l=1/(t-i),c=1/(n-s);return o[0]=-2*a,o[1]=0,o[2]=0,o[3]=0,o[4]=0,o[5]=-2*l,o[6]=0,o[7]=0,o[8]=0,o[9]=0,o[10]=2*c,o[11]=0,o[12]=(r+e)*a,o[13]=(i+t)*l,o[14]=(s+n)*c,o[15]=1,o}function Za(r,e,t,i,n){return n=n??rr(),n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e,n[3]=r[3]*e,n[4]=r[4]*t,n[5]=r[5]*t,n[6]=r[6]*t,n[7]=r[7]*t,n[8]=r[8]*i,n[9]=r[9]*i,n[10]=r[10]*i,n[11]=r[11]*i,n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],n}function Gm(r,e,t,i,n){n=n??rr();let s,o,a,l,c,u,h,f,g,d,p,m;return r===n?(n[12]=r[0]*e+r[4]*t+r[8]*i+r[12],n[13]=r[1]*e+r[5]*t+r[9]*i+r[13],n[14]=r[2]*e+r[6]*t+r[10]*i+r[14],n[15]=r[3]*e+r[7]*t+r[11]*i+r[15]):(s=r[0],o=r[1],a=r[2],l=r[3],c=r[4],u=r[5],h=r[6],f=r[7],g=r[8],d=r[9],p=r[10],m=r[11],n[0]=s,n[1]=o,n[2]=a,n[3]=l,n[4]=c,n[5]=u,n[6]=h,n[7]=f,n[8]=g,n[9]=d,n[10]=p,n[11]=m,n[12]=s*e+c*t+g*i+r[12],n[13]=o*e+u*t+d*i+r[13],n[14]=a*e+h*t+p*i+r[14],n[15]=l*e+f*t+m*i+r[15]),n}function zm(r,e,t,i){return i=i??rr(),i[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=r,i[13]=e,i[14]=t,i[15]=1,i}const mi=34962,_i=34963,po=35044,an=35048,km=5121,$m=5123,Vm=5125,Ac=5126,Ya=["experimental-webgl","webgl","webkit-3d","moz-webgl"];function Xm(r,e){e=Object.assign({preserveDrawingBuffer:!0,antialias:!_h},e);const t=Ya.length;for(let i=0;i<t;++i)try{const n=r.getContext(Ya[i],e);if(n)return n}catch{}return null}const Wm={STATIC_DRAW:po};class Tr{constructor(e,t){this.array_=null,this.type_=e,et(e===mi||e===_i,"A `WebGLArrayBuffer` must either be of type `ELEMENT_ARRAY_BUFFER` or `ARRAY_BUFFER`"),this.usage_=t!==void 0?t:Wm.STATIC_DRAW}ofSize(e){return this.array_=new(Oi(this.type_))(e),this}fromArray(e){return this.array_=Oi(this.type_).from(e),this}fromArrayBuffer(e){return this.array_=new(Oi(this.type_))(e),this}getType(){return this.type_}getArray(){return this.array_}setArray(e){const t=Oi(this.type_);if(!(e instanceof t))throw new Error(`Expected ${t}`);this.array_=e}getUsage(){return this.usage_}getSize(){return this.array_?this.array_.length:0}}function Oi(r){switch(r){case mi:return Float32Array;case _i:return Uint32Array;default:return Float32Array}}const Mi={LOST:"webglcontextlost",RESTORED:"webglcontextrestored"},jm=`
  precision mediump float;

  attribute vec2 a_position;
  varying vec2 v_texCoord;
  varying vec2 v_screenCoord;

  uniform vec2 u_screenSize;

  void main() {
    v_texCoord = a_position * 0.5 + 0.5;
    v_screenCoord = v_texCoord * u_screenSize;
    gl_Position = vec4(a_position, 0.0, 1.0);
  }
`,Hm=`
  precision mediump float;

  uniform sampler2D u_image;
  uniform float u_opacity;

  varying vec2 v_texCoord;

  void main() {
    gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
  }
`;class qa{constructor(e){this.gl_=e.webGlContext;const t=this.gl_;this.scaleRatio_=e.scaleRatio||1,this.renderTargetTexture_=t.createTexture(),this.renderTargetTextureSize_=null,this.frameBuffer_=t.createFramebuffer(),this.depthBuffer_=t.createRenderbuffer();const i=t.createShader(t.VERTEX_SHADER);t.shaderSource(i,e.vertexShader||jm),t.compileShader(i);const n=t.createShader(t.FRAGMENT_SHADER);t.shaderSource(n,e.fragmentShader||Hm),t.compileShader(n),this.renderTargetProgram_=t.createProgram(),t.attachShader(this.renderTargetProgram_,i),t.attachShader(this.renderTargetProgram_,n),t.linkProgram(this.renderTargetProgram_),this.renderTargetVerticesBuffer_=t.createBuffer();const s=[-1,-1,1,-1,-1,1,1,-1,1,1,-1,1];t.bindBuffer(t.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW),this.renderTargetAttribLocation_=t.getAttribLocation(this.renderTargetProgram_,"a_position"),this.renderTargetUniformLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_screenSize"),this.renderTargetOpacityLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_opacity"),this.renderTargetTextureLocation_=t.getUniformLocation(this.renderTargetProgram_,"u_image"),this.uniforms_=[],e.uniforms&&Object.keys(e.uniforms).forEach(o=>{this.uniforms_.push({value:e.uniforms[o],location:t.getUniformLocation(this.renderTargetProgram_,o)})})}getRenderTargetTexture(){return this.renderTargetTexture_}getGL(){return this.gl_}init(e){const t=this.getGL(),i=[t.drawingBufferWidth*this.scaleRatio_,t.drawingBufferHeight*this.scaleRatio_];if(t.bindFramebuffer(t.FRAMEBUFFER,this.getFrameBuffer()),t.bindRenderbuffer(t.RENDERBUFFER,this.getDepthBuffer()),t.viewport(0,0,i[0],i[1]),!this.renderTargetTextureSize_||this.renderTargetTextureSize_[0]!==i[0]||this.renderTargetTextureSize_[1]!==i[1]){this.renderTargetTextureSize_=i;const n=0,s=t.RGBA,o=0,a=t.RGBA,l=t.UNSIGNED_BYTE,c=null;t.bindTexture(t.TEXTURE_2D,this.renderTargetTexture_),t.texImage2D(t.TEXTURE_2D,n,s,i[0],i[1],o,a,l,c),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.renderTargetTexture_,0),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i[0],i[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthBuffer_)}}apply(e,t,i,n){const s=this.getGL(),o=e.size;if(s.bindFramebuffer(s.FRAMEBUFFER,t?t.getFrameBuffer():null),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.renderTargetTexture_),!t){const l=he(s.canvas);if(!e.renderTargets[l]){const c=s.getContextAttributes();c&&c.preserveDrawingBuffer&&(s.clearColor(0,0,0,0),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT)),e.renderTargets[l]=!0}}s.disable(s.DEPTH_TEST),s.enable(s.BLEND),s.blendFunc(s.ONE,s.ONE_MINUS_SRC_ALPHA),s.viewport(0,0,s.drawingBufferWidth,s.drawingBufferHeight),s.bindBuffer(s.ARRAY_BUFFER,this.renderTargetVerticesBuffer_),s.useProgram(this.renderTargetProgram_),s.enableVertexAttribArray(this.renderTargetAttribLocation_),s.vertexAttribPointer(this.renderTargetAttribLocation_,2,s.FLOAT,!1,0,0),s.uniform2f(this.renderTargetUniformLocation_,o[0],o[1]),s.uniform1i(this.renderTargetTextureLocation_,0);const a=e.layerStatesArray[e.layerIndex].opacity;s.uniform1f(this.renderTargetOpacityLocation_,a),this.applyUniforms(e),i&&i(s,e),s.drawArrays(s.TRIANGLES,0,6),n&&n(s,e)}getFrameBuffer(){return this.frameBuffer_}getDepthBuffer(){return this.depthBuffer_}applyUniforms(e){const t=this.getGL();let i,n=1;this.uniforms_.forEach(function(s){if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof ImageData)s.texture||(s.texture=t.createTexture()),t.activeTexture(t[`TEXTURE${n}`]),t.bindTexture(t.TEXTURE_2D,s.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),i instanceof ImageData?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,i.width,i.height,0,t.UNSIGNED_BYTE,new Uint8Array(i.data)):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i),t.uniform1i(s.location,n++);else if(Array.isArray(i))switch(i.length){case 2:t.uniform2f(s.location,i[0],i[1]);return;case 3:t.uniform3f(s.location,i[0],i[1],i[2]);return;case 4:t.uniform4f(s.location,i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&t.uniform1f(s.location,i)})}}const pt={PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix",TIME:"u_time",ZOOM:"u_zoom",RESOLUTION:"u_resolution",ROTATION:"u_rotation",VIEWPORT_SIZE_PX:"u_viewportSizePx",PIXEL_RATIO:"u_pixelRatio",HIT_DETECTION:"u_hitDetection"},Se={UNSIGNED_BYTE:km,UNSIGNED_SHORT:$m,UNSIGNED_INT:Vm,FLOAT:Ac},ln={};function Ka(r){return"shared/"+r}let Ja=0;function Zm(){const r="unique/"+Ja;return Ja+=1,r}function Ym(r){let e=ln[r];if(!e){const t=document.createElement("canvas");t.width=1,t.height=1,t.style.position="absolute",t.style.left="0",e={users:0,context:Xm(t)},ln[r]=e}return e.users+=1,e.context}function qm(r){const e=ln[r];if(!e||(e.users-=1,e.users>0))return;const t=e.context,i=t.getExtension("WEBGL_lose_context");i&&i.loseContext();const n=t.canvas;n.width=1,n.height=1,delete ln[r]}class Km extends rc{constructor(e){super(),e=e||{},this.boundHandleWebGLContextLost_=this.handleWebGLContextLost.bind(this),this.boundHandleWebGLContextRestored_=this.handleWebGLContextRestored.bind(this),this.canvasCacheKey_=e.canvasCacheKey?Ka(e.canvasCacheKey):Zm(),this.gl_=Ym(this.canvasCacheKey_),this.bufferCache_={},this.extensionCache_={},this.currentProgram_=null,this.needsToBeRecreated_=!1;const t=this.gl_.canvas;t.addEventListener(Mi.LOST,this.boundHandleWebGLContextLost_),t.addEventListener(Mi.RESTORED,this.boundHandleWebGLContextRestored_),this.offsetRotateMatrix_=Ce(),this.offsetScaleMatrix_=Ce(),this.tmpMat4_=rr(),this.uniformLocationsByProgram_={},this.attribLocationsByProgram_={},this.uniforms_=[],e.uniforms&&this.setUniforms(e.uniforms),this.postProcessPasses_=e.postProcesses?e.postProcesses.map(i=>new qa({webGlContext:this.gl_,scaleRatio:i.scaleRatio,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader,uniforms:i.uniforms})):[new qa({webGlContext:this.gl_})],this.shaderCompileErrors_=null,this.startTime_=Date.now()}setUniforms(e){this.uniforms_=[],this.addUniforms(e)}addUniforms(e){for(const t in e)this.uniforms_.push({name:t,value:e[t]})}canvasCacheKeyMatches(e){return this.canvasCacheKey_===Ka(e)}getExtension(e){if(e in this.extensionCache_)return this.extensionCache_[e];const t=this.gl_.getExtension(e);return this.extensionCache_[e]=t,t}bindBuffer(e){const t=this.gl_,i=he(e);let n=this.bufferCache_[i];if(!n){const s=t.createBuffer();n={buffer:e,webGlBuffer:s},this.bufferCache_[i]=n}t.bindBuffer(e.getType(),n.webGlBuffer)}flushBufferData(e){const t=this.gl_;this.bindBuffer(e),t.bufferData(e.getType(),e.getArray(),e.getUsage())}deleteBuffer(e){const t=he(e);delete this.bufferCache_[t]}disposeInternal(){const e=this.gl_.canvas;e.removeEventListener(Mi.LOST,this.boundHandleWebGLContextLost_),e.removeEventListener(Mi.RESTORED,this.boundHandleWebGLContextRestored_),qm(this.canvasCacheKey_),delete this.gl_}prepareDraw(e,t,i){const n=this.gl_,s=this.getCanvas(),o=e.size,a=e.pixelRatio;(s.width!==o[0]*a||s.height!==o[1]*a)&&(s.width=o[0]*a,s.height=o[1]*a,s.style.width=o[0]+"px",s.style.height=o[1]+"px");for(let l=this.postProcessPasses_.length-1;l>=0;l--)this.postProcessPasses_[l].init(e);n.bindTexture(n.TEXTURE_2D,null),n.clearColor(0,0,0,0),n.depthRange(0,1),n.clearDepth(1),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,t?n.ZERO:n.ONE_MINUS_SRC_ALPHA),i?(n.enable(n.DEPTH_TEST),n.depthFunc(n.LEQUAL)):n.disable(n.DEPTH_TEST)}bindFrameBuffer(e,t){const i=this.getGL();i.bindFramebuffer(i.FRAMEBUFFER,e),t&&i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,t,0)}bindInitialFrameBuffer(){const e=this.getGL(),t=this.postProcessPasses_[0].getFrameBuffer();e.bindFramebuffer(e.FRAMEBUFFER,t);const i=this.postProcessPasses_[0].getRenderTargetTexture();e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0)}bindTexture(e,t,i){const n=this.gl_;n.activeTexture(n.TEXTURE0+t),n.bindTexture(n.TEXTURE_2D,e),n.uniform1i(this.getUniformLocation(i),t)}bindAttribute(e,t,i){const n=this.getGL();this.bindBuffer(e);const s=this.getAttributeLocation(t);n.enableVertexAttribArray(s),n.vertexAttribPointer(s,i,n.FLOAT,!1,0,0)}prepareDrawToRenderTarget(e,t,i,n){const s=this.gl_,o=t.getSize();s.bindFramebuffer(s.FRAMEBUFFER,t.getFramebuffer()),s.bindRenderbuffer(s.RENDERBUFFER,t.getDepthbuffer()),s.viewport(0,0,o[0],o[1]),s.bindTexture(s.TEXTURE_2D,t.getTexture()),s.clearColor(0,0,0,0),s.depthRange(0,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.enable(s.BLEND),s.blendFunc(s.ONE,i?s.ZERO:s.ONE_MINUS_SRC_ALPHA),n?(s.enable(s.DEPTH_TEST),s.depthFunc(s.LEQUAL)):s.disable(s.DEPTH_TEST)}drawElements(e,t){const i=this.gl_;this.getExtension("OES_element_index_uint");const n=i.UNSIGNED_INT,s=4,o=t-e,a=e*s;i.drawElements(i.TRIANGLES,o,n,a)}finalizeDraw(e,t,i){for(let n=0,s=this.postProcessPasses_.length;n<s;n++)n===s-1?this.postProcessPasses_[n].apply(e,null,t,i):this.postProcessPasses_[n].apply(e,this.postProcessPasses_[n+1])}getCanvas(){return this.gl_.canvas}getGL(){return this.gl_}applyFrameState(e){const t=e.size,i=e.viewState.rotation,n=e.pixelRatio;this.setUniformFloatValue(pt.TIME,(Date.now()-this.startTime_)*.001),this.setUniformFloatValue(pt.ZOOM,e.viewState.zoom),this.setUniformFloatValue(pt.RESOLUTION,e.viewState.resolution),this.setUniformFloatValue(pt.PIXEL_RATIO,n),this.setUniformFloatVec2(pt.VIEWPORT_SIZE_PX,[t[0],t[1]]),this.setUniformFloatValue(pt.ROTATION,i)}applyHitDetectionUniform(e){const t=this.getUniformLocation(pt.HIT_DETECTION);this.getGL().uniform1i(t,e?1:0),e&&this.setUniformFloatValue(pt.PIXEL_RATIO,.5)}applyUniforms(e){const t=this.gl_;let i,n=0;this.uniforms_.forEach(s=>{if(i=typeof s.value=="function"?s.value(e):s.value,i instanceof HTMLCanvasElement||i instanceof HTMLImageElement||i instanceof ImageData||i instanceof WebGLTexture){i instanceof WebGLTexture&&!s.texture?(s.prevValue=void 0,s.texture=i):s.texture||(s.prevValue=void 0,s.texture=t.createTexture()),this.bindTexture(s.texture,n,s.name),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);const o=!(i instanceof HTMLImageElement)||i.complete;!(i instanceof WebGLTexture)&&o&&s.prevValue!==i&&(s.prevValue=i,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,i)),n++}else if(Array.isArray(i)&&i.length===6)this.setUniformMatrixValue(s.name,on(this.tmpMat4_,i));else if(Array.isArray(i)&&i.length<=4)switch(i.length){case 2:t.uniform2f(this.getUniformLocation(s.name),i[0],i[1]);return;case 3:t.uniform3f(this.getUniformLocation(s.name),i[0],i[1],i[2]);return;case 4:t.uniform4f(this.getUniformLocation(s.name),i[0],i[1],i[2],i[3]);return;default:return}else typeof i=="number"&&t.uniform1f(this.getUniformLocation(s.name),i)})}useProgram(e,t){this.gl_.useProgram(e),this.currentProgram_=e,t&&(this.applyFrameState(t),this.applyUniforms(t))}compileShader(e,t){const i=this.gl_,n=i.createShader(t);return i.shaderSource(n,e),i.compileShader(n),n}getProgram(e,t){const i=this.gl_,n=this.compileShader(e,i.FRAGMENT_SHADER),s=this.compileShader(t,i.VERTEX_SHADER),o=i.createProgram();if(i.attachShader(o,n),i.attachShader(o,s),i.linkProgram(o),!i.getShaderParameter(n,i.COMPILE_STATUS)){const a=`Fragment shader compilation failed: ${i.getShaderInfoLog(n)}`;throw new Error(a)}if(i.deleteShader(n),!i.getShaderParameter(s,i.COMPILE_STATUS)){const a=`Vertex shader compilation failed: ${i.getShaderInfoLog(s)}`;throw new Error(a)}if(i.deleteShader(s),!i.getProgramParameter(o,i.LINK_STATUS)){const a=`GL program linking failed: ${i.getProgramInfoLog(o)}`;throw new Error(a)}return o}getUniformLocation(e){const t=he(this.currentProgram_);return this.uniformLocationsByProgram_[t]===void 0&&(this.uniformLocationsByProgram_[t]={}),this.uniformLocationsByProgram_[t][e]===void 0&&(this.uniformLocationsByProgram_[t][e]=this.gl_.getUniformLocation(this.currentProgram_,e)),this.uniformLocationsByProgram_[t][e]}getAttributeLocation(e){const t=he(this.currentProgram_);return this.attribLocationsByProgram_[t]===void 0&&(this.attribLocationsByProgram_[t]={}),this.attribLocationsByProgram_[t][e]===void 0&&(this.attribLocationsByProgram_[t][e]=this.gl_.getAttribLocation(this.currentProgram_,e)),this.attribLocationsByProgram_[t][e]}makeProjectionTransform(e,t){const i=e.size,n=e.viewState.rotation,s=e.viewState.resolution,o=e.viewState.center;return Ys(t,0,0,2/(s*i[0]),2/(s*i[1]),-n,-o[0],-o[1]),t}setUniformFloatValue(e,t){this.gl_.uniform1f(this.getUniformLocation(e),t)}setUniformFloatVec2(e,t){this.gl_.uniform2fv(this.getUniformLocation(e),t)}setUniformFloatVec4(e,t){this.gl_.uniform4fv(this.getUniformLocation(e),t)}setUniformMatrixValue(e,t){this.gl_.uniformMatrix4fv(this.getUniformLocation(e),!1,t)}enableAttributeArray_(e,t,i,n,s){const o=this.getAttributeLocation(e);o<0||(this.gl_.enableVertexAttribArray(o),this.gl_.vertexAttribPointer(o,t,i,!1,n,s))}enableAttributes(e){const t=Jm(e);let i=0;for(let n=0;n<e.length;n++){const s=e[n];this.enableAttributeArray_(s.name,s.size,s.type||Ac,t,i),i+=s.size*Pc(s.type)}}handleWebGLContextLost(e){Rf(this.bufferCache_),this.currentProgram_=null,e.preventDefault()}handleWebGLContextRestored(){this.needsToBeRecreated_=!0}needsToBeRecreated(){return this.needsToBeRecreated_}createTexture(e,t,i,n){const s=this.gl_;i=i||s.createTexture();const o=n?s.NEAREST:s.LINEAR;s.bindTexture(s.TEXTURE_2D,i),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,o),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);const a=0,l=s.RGBA,c=0,u=s.RGBA,h=s.UNSIGNED_BYTE;return t instanceof Uint8Array?s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,t):t?s.texImage2D(s.TEXTURE_2D,a,l,u,h,t):s.texImage2D(s.TEXTURE_2D,a,l,e[0],e[1],c,u,h,null),i}}function Jm(r){let e=0;for(let t=0;t<r.length;t++){const i=r[t];e+=i.size*Pc(i.type)}return e}function Pc(r){switch(r){case Se.UNSIGNED_BYTE:return Uint8Array.BYTES_PER_ELEMENT;case Se.UNSIGNED_SHORT:return Uint16Array.BYTES_PER_ELEMENT;case Se.UNSIGNED_INT:return Uint32Array.BYTES_PER_ELEMENT;case Se.FLOAT:default:return Float32Array.BYTES_PER_ELEMENT}}class Qm extends Af{constructor(e){super(),this.tile,this.handleTileChange_=this.handleTileChange_.bind(this),this.gutter=e.gutter||0,this.helper=e.helper,this.loaded=!1,this.ready=!1}setTile(e){if(e!==this.tile)if(this.tile&&this.tile.removeEventListener(ze.CHANGE,this.handleTileChange_),this.tile=e,this.loaded=e.getState()===K.LOADED,this.loaded)this.uploadTile();else{if(e instanceof Gs){const t=e.getImage();t instanceof Image&&!t.crossOrigin&&(t.crossOrigin="anonymous")}e.addEventListener(ze.CHANGE,this.handleTileChange_)}}uploadTile(){Js()}setReady(){this.ready=!0,this.dispatchEvent(ze.CHANGE)}handleTileChange_(){this.tile.getState()===K.LOADED&&(this.loaded=!0,this.uploadTile())}setHelper(e){this.helper=e,this.helper&&this.loaded&&this.uploadTile()}disposeInternal(){this.setHelper(null),this.tile.removeEventListener(ze.CHANGE,this.handleTileChange_)}}function Lc(r,e,t){const i=t?r.LINEAR:r.NEAREST;r.bindTexture(r.TEXTURE_2D,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,i)}function e_(r,e,t,i){Lc(r,e,i),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,r.RGBA,r.UNSIGNED_BYTE,t)}function Qa(r,e,t,i,n,s){const o=r.getGL();let a,l;t instanceof Float32Array?(a=o.FLOAT,r.getExtension("OES_texture_float"),l=r.getExtension("OES_texture_float_linear")!==null):(a=o.UNSIGNED_BYTE,l=!0),Lc(o,e,s&&l);const c=t.byteLength/i[1];let u=1;c%8===0?u=8:c%4===0?u=4:c%2===0&&(u=2);let h;switch(n){case 1:{h=o.LUMINANCE;break}case 2:{h=o.LUMINANCE_ALPHA;break}case 3:{h=o.RGB;break}case 4:{h=o.RGBA;break}default:throw new Error(`Unsupported number of bands: ${n}`)}const f=o.getParameter(o.UNPACK_ALIGNMENT);o.pixelStorei(o.UNPACK_ALIGNMENT,u),o.texImage2D(o.TEXTURE_2D,0,h,i[0],i[1],0,h,a,t),o.pixelStorei(o.UNPACK_ALIGNMENT,f)}let fr=null;function t_(){fr=zt(1,1,void 0,{willReadFrequently:!0})}class r_ extends Qm{constructor(e){super(e),this.textures=[],this.renderSize_=st(e.grid.getTileSize(e.tile.tileCoord[0])),this.bandCount=NaN;const t=new Tr(mi,po);t.fromArray([0,1,1,1,1,0,0,0]),this.helper.flushBufferData(t),this.coords=t,this.setTile(e.tile)}setHelper(e){var i;const t=(i=this.helper)==null?void 0:i.getGL();if(t){this.helper.deleteBuffer(this.coords);for(let n=0;n<this.textures.length;++n)t.deleteTexture(this.textures[n])}super.setHelper(e),e&&e.flushBufferData(this.coords)}uploadTile(){const e=this.helper,t=e.getGL(),i=this.tile;this.textures.length=0;let n;i instanceof Gs||i instanceof yh?n=i.getImage():n=i.getData();const s=as(n);if(s){const _=t.createTexture();this.textures.push(_),this.bandCount=4,e_(t,_,s,i.interpolate),this.setReady();return}n=os(n);const o=i.getSize(),a=[o[0]+2*this.gutter,o[1]+2*this.gutter],l=n instanceof Float32Array,c=a[0]*a[1],u=l?Float32Array:Uint8Array,h=u.BYTES_PER_ELEMENT,f=n.byteLength/a[1];this.bandCount=Math.floor(f/h/a[0]);const g=Math.ceil(this.bandCount/4);if(g===1){const _=t.createTexture();this.textures.push(_),Qa(e,_,n,a,this.bandCount,i.interpolate),this.setReady();return}const d=new Array(g);for(let _=0;_<g;++_){const E=t.createTexture();this.textures.push(E);const S=_<g-1?4:(this.bandCount-1)%4+1;d[_]=new u(c*S)}let p=0,m=0;const y=a[0]*this.bandCount;for(let _=0;_<a[1];++_){for(let E=0;E<y;++E){const S=n[m+E],v=Math.floor(p/this.bandCount),w=E%this.bandCount,A=Math.floor(w/4),C=d[A],P=C.length/c,R=w%4;C[v*P+R]=S,++p}m+=f/h}for(let _=0;_<g;++_){const E=this.textures[_],S=d[_],v=S.length/c;Qa(e,E,S,a,v,i.interpolate)}this.setReady()}getImagePixelData_(e,t,i){const n=this.gutter,s=this.renderSize_[0],o=this.renderSize_[1];fr||t_(),fr.clearRect(0,0,1,1);const a=e.width,l=e.height,c=a-2*n,u=l-2*n,h=n+Math.floor(c*(t/s)),f=n+Math.floor(u*(i/o));let g;try{fr.drawImage(e,h,f,1,1,0,0,1,1),g=fr.getImageData(0,0,1,1).data}catch{return fr=null,null}return g}getArrayPixelData_(e,t,i,n){const s=this.gutter,o=this.renderSize_[0],a=this.renderSize_[1],l=t[0],c=t[1],u=l+2*s,h=c+2*s,f=s+Math.floor(l*(i/o)),g=s+Math.floor(c*(n/a));if(e instanceof DataView){const p=e.byteLength/(u*h),m=p*(g*u+f),y=e.buffer.slice(m,m+p);return new DataView(y)}const d=this.bandCount*(g*u+f);return e.slice(d,d+this.bandCount)}getPixelData(e,t){if(!this.loaded)return null;if(this.tile instanceof zs){const i=this.tile.getData(),n=os(i);if(n){const s=this.tile.getSize();return this.getArrayPixelData_(n,s,e,t)}return this.getImagePixelData_(as(i),e,t)}return this.getImagePixelData_(this.tile.getImage(),e,t)}}class yi extends xh{constructor(e,t){super(e),t=t||{},this.inversePixelTransform_=Ce(),this.postProcesses_=t.postProcesses,this.uniforms_=t.uniforms,this.helper,this.onMapChanged_=()=>{this.clearCache(),this.removeHelper()},e.addChangeListener(gs.MAP,this.onMapChanged_),this.dispatchPreComposeEvent=this.dispatchPreComposeEvent.bind(this),this.dispatchPostComposeEvent=this.dispatchPostComposeEvent.bind(this)}dispatchPreComposeEvent(e,t){const i=this.getLayer();if(i.hasListener(Zt.PRECOMPOSE)){const n=new zn(Zt.PRECOMPOSE,void 0,t,e);i.dispatchEvent(n)}}dispatchPostComposeEvent(e,t){const i=this.getLayer();if(i.hasListener(Zt.POSTCOMPOSE)){const n=new zn(Zt.POSTCOMPOSE,void 0,t,e);i.dispatchEvent(n)}}reset(e){this.uniforms_=e.uniforms,this.helper&&this.helper.setUniforms(this.uniforms_)}removeHelper(){this.helper&&(this.helper.dispose(),delete this.helper)}prepareFrame(e){if(this.getLayer().getRenderSource()){let t=!0,i=-1,n;for(let o=0,a=e.layerStatesArray.length;o<a;o++){const l=e.layerStatesArray[o].layer,c=l.getRenderer();if(!(c instanceof yi)){t=!0;continue}const u=l.getClassName();if((t||u!==n)&&(i+=1,t=!1),n=u,c===this)break}const s="map/"+e.mapId+"/group/"+i;(!this.helper||!this.helper.canvasCacheKeyMatches(s)||this.helper.needsToBeRecreated())&&(this.removeHelper(),this.helper=new Km({postProcesses:this.postProcesses_,uniforms:this.uniforms_,canvasCacheKey:s}),n&&(this.helper.getCanvas().className=n),this.afterHelperCreated())}return this.prepareFrameInternal(e)}afterHelperCreated(){}prepareFrameInternal(e){return!0}clearCache(){}disposeInternal(){var e;this.clearCache(),this.removeHelper(),(e=this.getLayer())==null||e.removeChangeListener(gs.MAP,this.onMapChanged_),super.disposeInternal()}dispatchRenderEvent_(e,t,i){const n=this.getLayer();if(n.hasListener(e)){Ys(this.inversePixelTransform_,0,0,i.pixelRatio,-i.pixelRatio,0,0,-i.size[1]);const s=new zn(e,this.inversePixelTransform_,i,t);n.dispatchEvent(s)}}preRender(e,t){this.dispatchRenderEvent_(Zt.PRERENDER,e,t)}postRender(e,t){this.dispatchRenderEvent_(Zt.POSTRENDER,e,t)}}const i_={TILE_TRANSFORM:"u_tileTransform",TRANSITION_ALPHA:"u_transitionAlpha",DEPTH:"u_depth",RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",RESOLUTION:"u_resolution",ZOOM:"u_zoom",GLOBAL_ALPHA:"u_globalAlpha",PROJECTION_MATRIX:"u_projectionMatrix",SCREEN_TO_WORLD_MATRIX:"u_screenToWorldMatrix"};function el(r){return 1/(r+2)}function n_(){return{tileIds:new Set,representationsByZ:{}}}function tl(r,e){return r.tileIds.has(he(e))}function rl(r,e,t){const i=r.representationsByZ;t in i||(i[t]=new Set),i[t].add(e),r.tileIds.add(he(e.tile))}function Wn(r,e){const t=r.layerStatesArray[r.layerIndex];t.extent&&(e=Et(e,Jl(t.extent,r.viewState.projection)));const i=t.layer.getRenderSource();if(!i.getWrapX()){const n=i.getTileGridForProjection(r.viewState.projection).getExtent();n&&(e=Et(e,n))}return e}function bs(r,e){return`${r.getKey()},${r.getRevision()},${hr(e)}`}class s_ extends yi{constructor(e,t){super(e,{uniforms:t.uniforms,postProcesses:t.postProcesses}),this.renderComplete=!1,this.tileTransform_=Ce(),this.tempMat4=rr(),this.tempTileRange_=new Eh(0,0,0,0),this.tempTileCoord_=ls(0,0,0),this.tempSize_=[0,0];const i=t.cacheSize!==void 0?t.cacheSize:512;this.tileRepresentationCache=new $l(i),this.frameState=null,this.renderedProjection_=void 0}reset(e){super.reset({uniforms:e.uniforms})}prepareFrameInternal(e){this.renderedProjection_?e.viewState.projection!==this.renderedProjection_&&(this.clearCache(),this.renderedProjection_=e.viewState.projection):this.renderedProjection_=e.viewState.projection;const i=this.getLayer().getRenderSource();return!i||An(Wn(e,e.extent))?!1:i.getState()==="ready"}createTileRepresentation(e){return Js()}enqueueTiles(e,t,i,n,s){const o=e.viewState,a=this.getLayer(),l=a.getRenderSource(),c=l.getTileGridForProjection(o.projection),u=l.getGutterForProjection(o.projection),h=he(l);h in e.wantedTiles||(e.wantedTiles[h]={});const f=e.wantedTiles[h],g=this.tileRepresentationCache,d=a.getMapInternal(),p=Math.max(i-s,c.getMinZoom(),c.getZForResolution(Math.min(a.getMaxResolution(),d?d.getView().getResolutionForZoom(Math.max(a.getMinZoom(),0)):c.getResolution(0)),l.zDirection)),m=o.rotation,y=m?Pf(o.center,o.resolution,m,e.size):void 0;for(let _=i;_>=p;--_){const E=c.getTileRangeForExtentAndZ(t,_,this.tempTileRange_),S=c.getResolution(_);for(let v=E.minX;v<=E.maxX;++v)for(let w=E.minY;w<=E.maxY;++w){if(m&&!c.tileCoordIntersectsViewport([_,v,w],y))continue;const A=ls(_,v,w,this.tempTileCoord_),C=bs(l,A);let P,R;if(g.containsKey(C)&&(P=g.get(C),R=P.tile),(!P||P.tile.key!==l.getKey())&&(R=l.getTile(_,v,w,e.pixelRatio,o.projection),!R)||tl(n,R))continue;P?P.setTile(R):(P=this.createTileRepresentation({tile:R,grid:c,helper:this.helper,gutter:u}),g.set(C,P)),rl(n,P,_);const U=R.getKey();f[U]=!0,R.getState()===K.IDLE&&(e.tileQueue.isKeyQueued(U)||e.tileQueue.enqueue([R,h,c.getTileCoordCenter(A),S]))}}}beforeTilesRender(e,t){this.helper.prepareDraw(this.frameState,!t,!0)}beforeTilesMaskRender(e){return!1}renderTile(e,t,i,n,s,o,a,l,c,u,h){}renderTileMask(e,t,i,n){}drawTile_(e,t,i,n,s,o,a){if(!t.ready)return;const c=t.tile.tileCoord,u=hr(c),h=u in o?o[u]:1,f=a.getResolution(i),g=st(a.getTileSize(i),this.tempSize_),d=a.getOrigin(i),p=a.getTileCoordExtent(c),m=h<1?-1:el(i);h<1&&(e.animate=!0);const y=e.viewState,_=y.center[0],E=y.center[1],S=g[0]+2*n,v=g[1]+2*n,w=S/v,A=(_-d[0])/(g[0]*f),C=(d[1]-E)/(g[1]*f),P=y.resolution/f,R=c[1],U=c[2];ff(this.tileTransform_),ua(this.tileTransform_,2/(e.size[0]*P/S),-2/(e.size[1]*P/S)),df(this.tileTransform_,y.rotation),ua(this.tileTransform_,1,1/w),qs(this.tileTransform_,(g[0]*(R-A)-n)/S,(g[1]*(U-C)-n)/v),this.renderTile(t,this.tileTransform_,e,s,f,g,d,p,m,n,h)}renderFrame(e){this.frameState=e,this.renderComplete=!0;const t=this.helper.getGL();this.preRender(t,e);const i=e.viewState,n=this.getLayer(),s=n.getRenderSource(),o=s.getTileGridForProjection(i.projection),a=s.getGutterForProjection(i.projection),l=Wn(e,e.extent),c=o.getZForResolution(i.resolution,s.zDirection),u=n_(),h=n.getPreload();if(e.nextExtent){const E=o.getZForResolution(i.nextResolution,s.zDirection),S=Wn(e,e.nextExtent);this.enqueueTiles(e,S,E,u,h)}this.enqueueTiles(e,l,c,u,0),h>0&&setTimeout(()=>{this.enqueueTiles(e,l,c-1,u,h-1)},0);const f={};let g=!1;const d=u.representationsByZ;if(c in d){const E=he(this),S=e.time;for(const v of d[c]){const w=v.tile;if(w.getState()===K.EMPTY)continue;const A=w.tileCoord;if(v.ready){const R=w.getAlpha(E,S);if(R===1){w.endTransition(E);continue}g=!0;const U=hr(A);f[U]=R}if(this.renderComplete=!1,this.findAltTiles_(o,A,c+1,u))continue;const P=o.getMinZoom();for(let R=c-1;R>=P&&!this.findAltTiles_(o,A,R,u);--R);}}const p=Object.keys(d).map(Number).sort(Lf);if(this.beforeTilesMaskRender(e))for(let E=0,S=p.length;E<S;++E){const v=p[E];for(const w of d[v]){const A=w.tile.tileCoord;if(hr(A)in f)continue;const P=o.getTileCoordExtent(A);this.renderTileMask(w,v,P,el(v))}}this.beforeTilesRender(e,g);for(let E=0,S=p.length;E<S;++E){const v=p[E];for(const w of d[v]){const A=w.tile.tileCoord;hr(A)in f||this.drawTile_(e,w,v,a,l,f,o)}}if(c in d)for(const E of d[c]){const S=E.tile.tileCoord;hr(S)in f&&this.drawTile_(e,E,c,a,l,f,o)}this.beforeFinalize(e),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const y=this.helper.getCanvas(),_=this.tileRepresentationCache;for(;_.canExpireCache();)_.pop().dispose();return this.postRender(t,e),y}beforeFinalize(e){}findAltTiles_(e,t,i,n){const s=e.getTileRangeForTileCoordAndZ(t,i,this.tempTileRange_);if(!s)return!1;let o=!0;const a=this.tileRepresentationCache,l=this.getLayer().getRenderSource();for(let c=s.minX;c<=s.maxX;++c)for(let u=s.minY;u<=s.maxY;++u){const h=bs(l,[i,c,u]);let f=!1;if(a.containsKey(h)){const g=a.get(h);g.ready&&!tl(n,g.tile)&&(rl(n,g,i),f=!0)}f||(o=!1)}return o}clearCache(){super.clearCache();const e=this.tileRepresentationCache;e.forEach(t=>t.dispose()),e.clear()}afterHelperCreated(){super.afterHelperCreated(),this.tileRepresentationCache.forEach(e=>e.setHelper(this.helper))}disposeInternal(){super.disposeInternal(),delete this.frameState}}const j={...i_,TILE_TEXTURE_ARRAY:"u_tileTextures",TEXTURE_PIXEL_WIDTH:"u_texturePixelWidth",TEXTURE_PIXEL_HEIGHT:"u_texturePixelHeight",TEXTURE_RESOLUTION:"u_textureResolution",TEXTURE_ORIGIN_X:"u_textureOriginX",TEXTURE_ORIGIN_Y:"u_textureOriginY"},$i={TEXTURE_COORD:"a_textureCoord"},o_=[{name:$i.TEXTURE_COORD,size:2,type:Se.FLOAT}];class a_ extends s_{constructor(e,t){super(e,t),this.program_,this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.indices_=new Tr(_i,po),this.indices_.fromArray([0,1,3,1,2,3]),this.paletteTextures_=t.paletteTextures||[]}reset(e){if(super.reset(e),this.helper){const t=this.helper.getGL();for(const i of this.paletteTextures_)i.delete(t)}if(this.vertexShader_=e.vertexShader,this.fragmentShader_=e.fragmentShader,this.paletteTextures_=e.paletteTextures||[],this.helper){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_);const t=this.helper.getGL();for(const i of this.paletteTextures_)i.getTexture(t)}}afterHelperCreated(){super.afterHelperCreated();const e=this.helper.getGL();for(const t of this.paletteTextures_)t.getTexture(e);this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.helper.flushBufferData(this.indices_)}removeHelper(){if(this.helper){const e=this.helper.getGL();for(const t of this.paletteTextures_)t.delete(e)}super.removeHelper()}createTileRepresentation(e){return new r_(e)}beforeTilesRender(e,t){super.beforeTilesRender(e,t),this.helper.useProgram(this.program_,e)}renderTile(e,t,i,n,s,o,a,l,c,u,h){const f=this.helper.getGL();this.helper.bindBuffer(e.coords),this.helper.bindBuffer(this.indices_),this.helper.enableAttributes(o_);let g=0;for(;g<e.textures.length;){const w=`${j.TILE_TEXTURE_ARRAY}[${g}]`;this.helper.bindTexture(e.textures[g],g,w),++g}for(let w=0;w<this.paletteTextures_.length;++w){const A=this.paletteTextures_[w],C=A.getTexture(f);this.helper.bindTexture(C,g,A.name),++g}const d=i.viewState,p=o[0]+2*u,m=o[1]+2*u,_=e.tile.tileCoord,E=_[1],S=_[2];this.helper.setUniformMatrixValue(j.TILE_TRANSFORM,on(this.tempMat4,t)),this.helper.setUniformFloatValue(j.TRANSITION_ALPHA,h),this.helper.setUniformFloatValue(j.DEPTH,c);let v=n;u>0&&(v=l,Et(v,n,v)),this.helper.setUniformFloatVec4(j.RENDER_EXTENT,v),this.helper.setUniformFloatValue(j.RESOLUTION,d.resolution),this.helper.setUniformFloatValue(j.ZOOM,d.zoom),this.helper.setUniformFloatValue(j.TEXTURE_PIXEL_WIDTH,p),this.helper.setUniformFloatValue(j.TEXTURE_PIXEL_HEIGHT,m),this.helper.setUniformFloatValue(j.TEXTURE_RESOLUTION,s),this.helper.setUniformFloatValue(j.TEXTURE_ORIGIN_X,a[0]+E*o[0]*s-u*s),this.helper.setUniformFloatValue(j.TEXTURE_ORIGIN_Y,a[1]-S*o[1]*s+u*s),this.helper.drawElements(0,this.indices_.getSize())}getData(e){if(!this.helper.getGL())return null;const i=this.frameState;if(!i)return null;const n=this.getLayer(),s=It(i.pixelToCoordinateTransform,e.slice()),o=i.viewState,a=n.getExtent();if(a&&!pr(Jl(a,o.projection),s))return null;const l=n.getSources(Qs([s]),o.resolution);let c,u,h;for(c=l.length-1;c>=0;--c)if(u=l[c],u.getState()==="ready"){if(h=u.getTileGridForProjection(o.projection),u.getWrapX())break;const g=h.getExtent();if(!g||pr(g,s))break}if(c<0)return null;const f=this.tileRepresentationCache;for(let g=h.getZForResolution(o.resolution);g>=h.getMinZoom();--g){const d=h.getTileCoordForCoordAndZ(s,g),p=bs(u,d);if(!f.containsKey(p))continue;const m=f.get(p);if(m.tile.getState()===K.EMPTY)return null;if(!m.loaded)continue;const _=h.getOrigin(g),E=st(h.getTileSize(g)),S=h.getResolution(g),v=(s[0]-_[0])/S-d[1]*E[0],w=(_[1]-s[1])/S-d[2]*E[1];return m.getPixelData(v,w)}return null}disposeInternal(){const e=this.helper;if(e){const t=e.getGL();for(const i of this.paletteTextures_)i.delete(t);this.paletteTextures_.length=0,t.deleteProgram(this.program_),delete this.program_,e.deleteBuffer(this.indices_)}super.disposeInternal(),delete this.indices_}}class l_{constructor(e,t){this.name=e,this.data=t,this.texture_=null}getTexture(e){if(!this.texture_){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.data.length/4,1,0,e.RGBA,e.UNSIGNED_BYTE,this.data),this.texture_=t}return this.texture_}delete(e){this.texture_&&e.deleteTexture(this.texture_),this.texture_=null}}function c_(r,e){return`operator_${r}_${Object.keys(e.functions).length}`}function Gt(r){const e=r.toString();return e.includes(".")?e:e+".0"}function mo(r){if(r.length<2||r.length>4)throw new Error("`formatArray` can only output `vec2`, `vec3` or `vec4` arrays.");return`vec${r.length}(${r.map(Gt).join(", ")})`}function Vi(r){const e=ci(r),t=e.length>3?e[3]:1;return mo([e[0]/255,e[1]/255,e[2]/255,t])}function u_(r){const e=st(r);return mo(e)}const jn={};let h_=0;function wr(r){return r in jn||(jn[r]=h_++),jn[r]}function vt(r){return Gt(wr(r))}function On(r){return"u_var_"+r}function _o(){return{variables:{},properties:{},functions:{},bandCount:0,featureId:!1,geometryType:!1}}const Hn="getBandValue",Ic="u_paletteTextures",Cc="featureId",Fc="geometryType",Ts=-9999999;function f_(r,e,t,i){const n=bh(r,e,t);return yo(n,e,i)}function le(r){return(e,t,i)=>{const n=t.args.length,s=new Array(n);for(let o=0;o<n;++o)s[o]=yo(t.args[o],i,e);return r(s,e)}}const d_={[Z.Get]:(r,e)=>{const i=e.args[0].value;return i in r.properties||(r.properties[i]={name:i,type:e.type}),"a_prop_"+i},[Z.Id]:r=>(r.featureId=!0,"a_"+Cc),[Z.GeometryType]:r=>(r.geometryType=!0,"a_"+Fc),[Z.LineMetric]:()=>"currentLineMetric",[Z.Var]:(r,e)=>{const i=e.args[0].value;return i in r.variables||(r.variables[i]={name:i,type:e.type}),On(i)},[Z.Has]:(r,e)=>{const i=e.args[0].value;return i in r.properties||(r.properties[i]={name:i,type:e.type}),`(a_prop_${i} != ${Gt(Ts)})`},[Z.Resolution]:()=>"u_resolution",[Z.Zoom]:()=>"u_zoom",[Z.Time]:()=>"u_time",[Z.Any]:le(r=>`(${r.join(" || ")})`),[Z.All]:le(r=>`(${r.join(" && ")})`),[Z.Not]:le(([r])=>`(!${r})`),[Z.Equal]:le(([r,e])=>`(${r} == ${e})`),[Z.NotEqual]:le(([r,e])=>`(${r} != ${e})`),[Z.GreaterThan]:le(([r,e])=>`(${r} > ${e})`),[Z.GreaterThanOrEqualTo]:le(([r,e])=>`(${r} >= ${e})`),[Z.LessThan]:le(([r,e])=>`(${r} < ${e})`),[Z.LessThanOrEqualTo]:le(([r,e])=>`(${r} <= ${e})`),[Z.Multiply]:le(r=>`(${r.join(" * ")})`),[Z.Divide]:le(([r,e])=>`(${r} / ${e})`),[Z.Add]:le(r=>`(${r.join(" + ")})`),[Z.Subtract]:le(([r,e])=>`(${r} - ${e})`),[Z.Clamp]:le(([r,e,t])=>`clamp(${r}, ${e}, ${t})`),[Z.Mod]:le(([r,e])=>`mod(${r}, ${e})`),[Z.Pow]:le(([r,e])=>`pow(${r}, ${e})`),[Z.Abs]:le(([r])=>`abs(${r})`),[Z.Floor]:le(([r])=>`floor(${r})`),[Z.Ceil]:le(([r])=>`ceil(${r})`),[Z.Round]:le(([r])=>`floor(${r} + 0.5)`),[Z.Sin]:le(([r])=>`sin(${r})`),[Z.Cos]:le(([r])=>`cos(${r})`),[Z.Atan]:le(([r,e])=>e!==void 0?`atan(${r}, ${e})`:`atan(${r})`),[Z.Sqrt]:le(([r])=>`sqrt(${r})`),[Z.Match]:le(r=>{const e=r[0],t=r[r.length-1];let i=null;for(let n=r.length-3;n>=1;n-=2){const s=r[n],o=r[n+1];i=`(${e} == ${s} ? ${o} : ${i||t})`}return i}),[Z.Between]:le(([r,e,t])=>`(${r} >= ${e} && ${r} <= ${t})`),[Z.Interpolate]:le(([r,e,...t])=>{let i="";for(let n=0;n<t.length-2;n+=2){const s=t[n],o=i||t[n+1],a=t[n+2],l=t[n+3];let c;r===Gt(1)?c=`(${e} - ${s}) / (${a} - ${s})`:c=`(pow(${r}, (${e} - ${s})) - 1.0) / (pow(${r}, (${a} - ${s})) - 1.0)`,i=`mix(${o}, ${l}, clamp(${c}, 0.0, 1.0))`}return i}),[Z.Case]:le(r=>{const e=r[r.length-1];let t=null;for(let i=r.length-3;i>=0;i-=2){const n=r[i],s=r[i+1];t=`(${n} ? ${s} : ${t||e})`}return t}),[Z.In]:le(([r,...e],t)=>{const i=c_("in",t),n=[];for(let s=0;s<e.length;s+=1)n.push(`  if (inputValue == ${e[s]}) { return true; }`);return t.functions[i]=`bool ${i}(float inputValue) {
${n.join(`
`)}
  return false;
}`,`${i}(${r})`}),[Z.Array]:le(r=>`vec${r.length}(${r.join(", ")})`),[Z.Color]:le(r=>{if(r.length===1)return`vec4(vec3(${r[0]} / 255.0), 1.0)`;if(r.length===2)return`vec4(vec3(${r[0]} / 255.0), ${r[1]})`;const e=r.slice(0,3).map(i=>`${i} / 255.0`);if(r.length===3)return`vec4(${e.join(", ")}, 1.0)`;const t=r[3];return`vec4(${e.join(", ")}, ${t})`}),[Z.Band]:le(([r,e,t],i)=>{if(!(Hn in i.functions)){let n="";const s=i.bandCount||1;for(let o=0;o<s;o++){const a=Math.floor(o/4);let l=o%4;o===s-1&&l===1&&(l=3);const c=`${j.TILE_TEXTURE_ARRAY}[${a}]`;n+=`  if (band == ${o+1}.0) {
    return texture2D(${c}, v_textureCoord + vec2(dx, dy))[${l}];
  }
`}i.functions[Hn]=`float getBandValue(float band, float xOffset, float yOffset) {
  float dx = xOffset / ${j.TEXTURE_PIXEL_WIDTH};
  float dy = yOffset / ${j.TEXTURE_PIXEL_HEIGHT};
${n}
}`}return`${Hn}(${r}, ${e??"0.0"}, ${t??"0.0"})`}),[Z.Palette]:(r,e)=>{const[t,...i]=e.args,n=i.length,s=new Uint8Array(n*4);for(let c=0;c<i.length;c++){const u=i[c].value,h=ci(u),f=c*4;s[f]=h[0],s[f+1]=h[1],s[f+2]=h[2],s[f+3]=h[3]*255}r.paletteTextures||(r.paletteTextures=[]);const o=`${Ic}[${r.paletteTextures.length}]`,a=new l_(o,s);r.paletteTextures.push(a);const l=yo(t,oe,r);return`texture2D(${o}, vec2((${l} + 0.5) / ${n}.0, 0.5))`}};function yo(r,e,t){if(r instanceof Th){const i=d_[r.operator];if(i===void 0)throw new Error(`No compiler defined for this operator: ${JSON.stringify(r.operator)}`);return i(t,r,e)}if((r.type&oe)>0)return Gt(r.value);if((r.type&Tn)>0)return r.value.toString();if((r.type&ei)>0)return vt(r.value.toString());if((r.type&We)>0)return Vi(r.value);if((r.type&kt)>0)return mo(r.value);if((r.type&Pr)>0)return u_(r.value);throw new Error(`Unexpected expression ${r.value} (expected type ${wh(e)})`)}function g_(){return{"fill-color":"rgba(255,255,255,0.4)","stroke-color":"#3399CC","stroke-width":1.25,"circle-radius":5,"circle-fill-color":"rgba(255,255,255,0.4)","circle-stroke-width":1.25,"circle-stroke-color":"#3399CC"}}const il=.985,or=`#ifdef GL_FRAGMENT_PRECISION_HIGH
precision highp float;
#else
precision mediump float;
#endif
uniform mat4 u_projectionMatrix;
uniform mat4 u_screenToWorldMatrix;
uniform vec2 u_viewportSizePx;
uniform float u_pixelRatio;
uniform float u_globalAlpha;
uniform float u_time;
uniform float u_zoom;
uniform float u_resolution;
uniform float u_rotation;
uniform vec4 u_renderExtent;
uniform vec2 u_patternOrigin;
uniform float u_depth;
uniform mediump int u_hitDetection;

const float PI = 3.141592653589793238;
const float TWO_PI = 2.0 * PI;
float currentLineMetric = 0.; // an actual value will be used in the stroke shaders
`,ar=g_();class Oc{constructor(){this.uniforms_=[],this.attributes_=[],this.hasSymbol_=!1,this.symbolSizeExpression_=`vec2(${Gt(ar["circle-radius"])} + ${Gt(ar["circle-stroke-width"]*.5)})`,this.symbolRotationExpression_="0.0",this.symbolOffsetExpression_="vec2(0.0)",this.symbolColorExpression_=Vi(ar["circle-fill-color"]),this.texCoordExpression_="vec4(0.0, 0.0, 1.0, 1.0)",this.discardExpression_="false",this.symbolRotateWithView_=!1,this.hasStroke_=!1,this.strokeWidthExpression_=Gt(ar["stroke-width"]),this.strokeColorExpression_=Vi(ar["stroke-color"]),this.strokeOffsetExpression_="0.",this.strokeCapExpression_=vt("round"),this.strokeJoinExpression_=vt("round"),this.strokeMiterLimitExpression_="10.",this.strokeDistanceFieldExpression_="-1000.",this.hasFill_=!1,this.fillColorExpression_=Vi(ar["fill-color"]),this.vertexShaderFunctions_=[],this.fragmentShaderFunctions_=[]}addUniform(e){return this.uniforms_.push(e),this}addAttribute(e,t,i,n){return this.attributes_.push({name:e,type:t,varyingName:e.replace(/^a_/,"v_"),varyingType:n??t,varyingExpression:i??e}),this}setSymbolSizeExpression(e){return this.hasSymbol_=!0,this.symbolSizeExpression_=e,this}getSymbolSizeExpression(){return this.symbolSizeExpression_}setSymbolRotationExpression(e){return this.symbolRotationExpression_=e,this}setSymbolOffsetExpression(e){return this.symbolOffsetExpression_=e,this}getSymbolOffsetExpression(){return this.symbolOffsetExpression_}setSymbolColorExpression(e){return this.hasSymbol_=!0,this.symbolColorExpression_=e,this}getSymbolColorExpression(){return this.symbolColorExpression_}setTextureCoordinateExpression(e){return this.texCoordExpression_=e,this}setFragmentDiscardExpression(e){return this.discardExpression_=e,this}getFragmentDiscardExpression(){return this.discardExpression_}setSymbolRotateWithView(e){return this.symbolRotateWithView_=e,this}setStrokeWidthExpression(e){return this.hasStroke_=!0,this.strokeWidthExpression_=e,this}setStrokeColorExpression(e){return this.hasStroke_=!0,this.strokeColorExpression_=e,this}getStrokeColorExpression(){return this.strokeColorExpression_}setStrokeOffsetExpression(e){return this.strokeOffsetExpression_=e,this}setStrokeCapExpression(e){return this.strokeCapExpression_=e,this}setStrokeJoinExpression(e){return this.strokeJoinExpression_=e,this}setStrokeMiterLimitExpression(e){return this.strokeMiterLimitExpression_=e,this}setStrokeDistanceFieldExpression(e){return this.strokeDistanceFieldExpression_=e,this}setFillColorExpression(e){return this.hasFill_=!0,this.fillColorExpression_=e,this}getFillColorExpression(){return this.fillColorExpression_}addVertexShaderFunction(e){return this.vertexShaderFunctions_.includes(e)?this:(this.vertexShaderFunctions_.push(e),this)}addFragmentShaderFunction(e){return this.fragmentShaderFunctions_.includes(e)?this:(this.fragmentShaderFunctions_.push(e),this)}getSymbolVertexShader(){return this.hasSymbol_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute float a_index;
attribute vec4 a_hitColor;

varying vec2 v_texCoord;
varying vec2 v_quadCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 pxToScreen(vec2 coordPx) {
  vec2 scaled = coordPx / u_viewportSizePx / 0.5;
  return scaled;
}

vec2 screenToPx(vec2 coordScreen) {
  return (coordScreen * 0.5 + 0.5) * u_viewportSizePx;
}

void main(void) {
  v_quadSizePx = ${this.symbolSizeExpression_};
  vec2 halfSizePx = v_quadSizePx * 0.5;
  vec2 centerOffsetPx = ${this.symbolOffsetExpression_};
  vec2 offsetPx = centerOffsetPx;
  if (a_index == 0.0) {
    offsetPx -= halfSizePx;
  } else if (a_index == 1.0) {
    offsetPx += halfSizePx * vec2(1., -1.);
  } else if (a_index == 2.0) {
    offsetPx += halfSizePx;
  } else {
    offsetPx += halfSizePx * vec2(-1., 1.);
  }
  float angle = ${this.symbolRotationExpression_};
  ${this.symbolRotateWithView_?"angle += u_rotation;":""}
  float c = cos(-angle);
  float s = sin(-angle);
  offsetPx = vec2(c * offsetPx.x - s * offsetPx.y, s * offsetPx.x + c * offsetPx.y);
  vec4 center = u_projectionMatrix * vec4(a_position, 0.0, 1.0);
  gl_Position = center + vec4(pxToScreen(offsetPx), u_depth, 0.);
  vec4 texCoord = ${this.texCoordExpression_};
  float u = a_index == 0.0 || a_index == 3.0 ? texCoord.s : texCoord.p;
  float v = a_index == 2.0 || a_index == 3.0 ? texCoord.t : texCoord.q;
  v_texCoord = vec2(u, v);
  v_hitColor = a_hitColor;
  v_angle = angle;
  c = cos(-v_angle);
  s = sin(-v_angle);
  centerOffsetPx = vec2(c * centerOffsetPx.x - s * centerOffsetPx.y, s * centerOffsetPx.x + c * centerOffsetPx.y); 
  v_centerPx = screenToPx(center.xy) + centerOffsetPx;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getSymbolFragmentShader(){return this.hasSymbol_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_texCoord;
varying vec4 v_hitColor;
varying vec2 v_centerPx;
varying float v_angle;
varying vec2 v_quadSizePx;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  if (${this.discardExpression_}) { discard; }
  vec2 coordsPx = gl_FragCoord.xy / u_pixelRatio - v_centerPx; // relative to center
  float c = cos(v_angle);
  float s = sin(v_angle);
  coordsPx = vec2(c * coordsPx.x - s * coordsPx.y, s * coordsPx.x + c * coordsPx.y);
  gl_FragColor = ${this.symbolColorExpression_};
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.05) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getStrokeVertexShader(){return this.hasStroke_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_segmentStart;
attribute vec2 a_segmentEnd;
attribute float a_measureStart;
attribute float a_measureEnd;
attribute float a_parameters;
attribute float a_distance;
attribute vec2 a_joinAngles;
attribute vec4 a_hitColor;

varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

vec4 pxToScreen(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return vec4(screenPos, u_depth, 1.0);
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

vec2 getJoinOffsetDirection(vec2 normalPx, float joinAngle) {
  float halfAngle = joinAngle / 2.0;
  float c = cos(halfAngle);
  float s = sin(halfAngle);
  vec2 angleBisectorNormal = vec2(s * normalPx.x + c * normalPx.y, -c * normalPx.x + s * normalPx.y);
  float length = 1.0 / s;
  return angleBisectorNormal * length;
}

vec2 getOffsetPoint(vec2 point, vec2 normal, float joinAngle, float offsetPx) {
  // if on a cap or the join angle is too high, offset the line along the segment normal
  if (cos(joinAngle) > 0.998 || isCap(joinAngle)) {
    return point - normal * offsetPx;
  }
  // offset is applied along the inverted normal (positive offset goes "right" relative to line direction)
  return point - getJoinOffsetDirection(normal, joinAngle) * offsetPx;
}

void main(void) {
  v_angleStart = a_joinAngles.x;
  v_angleEnd = a_joinAngles.y;
  float vertexNumber = floor(abs(a_parameters) / 10000. + 0.5);
  currentLineMetric = vertexNumber < 1.5 ? a_measureStart : a_measureEnd;
  // we're reading the fractional part while keeping the sign (so -4.12 gives -0.12, 3.45 gives 0.45)
  float angleTangentSum = fract(abs(a_parameters) / 10000.) * 10000. * sign(a_parameters);

  float lineWidth = ${this.strokeWidthExpression_};
  float lineOffsetPx = ${this.strokeOffsetExpression_};

  // compute segment start/end in px with offset
  vec2 segmentStartPx = worldToPx(a_segmentStart);
  vec2 segmentEndPx = worldToPx(a_segmentEnd);
  vec2 tangentPx = normalize(segmentEndPx - segmentStartPx);
  vec2 normalPx = vec2(-tangentPx.y, tangentPx.x);
  segmentStartPx = getOffsetPoint(segmentStartPx, normalPx, v_angleStart, lineOffsetPx),
  segmentEndPx = getOffsetPoint(segmentEndPx, normalPx, v_angleEnd, lineOffsetPx);
  
  // compute current vertex position
  float normalDir = vertexNumber < 0.5 || (vertexNumber > 1.5 && vertexNumber < 2.5) ? 1.0 : -1.0;
  float tangentDir = vertexNumber < 1.5 ? 1.0 : -1.0;
  float angle = vertexNumber < 1.5 ? v_angleStart : v_angleEnd;
  vec2 joinDirection;
  vec2 positionPx = vertexNumber < 1.5 ? segmentStartPx : segmentEndPx;
  // if angle is too high, do not make a proper join
  if (cos(angle) > ${il} || isCap(angle)) {
    joinDirection = normalPx * normalDir - tangentPx * tangentDir;
  } else {
    joinDirection = getJoinOffsetDirection(normalPx * normalDir, angle);
  }
  positionPx = positionPx + joinDirection * (lineWidth * 0.5 + 1.); // adding 1 pixel for antialiasing
  gl_Position = pxToScreen(positionPx);

  v_segmentStart = segmentStartPx;
  v_segmentEnd = segmentEndPx;
  v_width = lineWidth;
  v_hitColor = a_hitColor;
  v_distanceOffsetPx = a_distance / u_resolution - (lineOffsetPx * angleTangentSum);
  v_measureStart = a_measureStart;
  v_measureEnd = a_measureEnd;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getStrokeFragmentShader(){return this.hasStroke_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec2 v_segmentStart;
varying vec2 v_segmentEnd;
varying float v_angleStart;
varying float v_angleEnd;
varying float v_width;
varying vec4 v_hitColor;
varying float v_distanceOffsetPx;
varying float v_measureStart;
varying float v_measureEnd;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}

vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

bool isCap(float joinAngle) {
  return joinAngle < -0.1;
}

float segmentDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  vec2 tangent = normalize(end - start);
  vec2 normal = vec2(-tangent.y, tangent.x);
  vec2 startToPoint = point - start;
  return abs(dot(startToPoint, normal)) - width * 0.5;
}

float buttCapDistanceField(vec2 point, vec2 start, vec2 end) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  return dot(startToPoint, -tangent);
}

float squareCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return buttCapDistanceField(point, start, end) - width * 0.5;
}

float roundCapDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  float onSegment = max(0., 1000. * dot(point - start, end - start)); // this is very high when inside the segment
  return length(point - start) - width * 0.5 - onSegment;
}

float roundJoinDistanceField(vec2 point, vec2 start, vec2 end, float width) {
  return roundCapDistanceField(point, start, end, width);
}

float bevelJoinField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  vec2 startToPoint = point - start;
  vec2 tangent = normalize(end - start);
  float c = cos(joinAngle * 0.5);
  float s = sin(joinAngle * 0.5);
  float direction = -sign(sin(joinAngle));
  vec2 bisector = vec2(c * tangent.x - s * tangent.y, s * tangent.x + c * tangent.y);
  float radius = width * 0.5 * s;
  return dot(startToPoint, bisector * direction) - radius;
}

float miterJoinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle) {
  if (cos(joinAngle) > ${il}) { // avoid risking a division by zero
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  float miterLength = 1. / sin(joinAngle * 0.5);
  float miterLimit = ${this.strokeMiterLimitExpression_};
  if (miterLength > miterLimit) {
    return bevelJoinField(point, start, end, width, joinAngle);
  }
  return -1000.;
}

float capDistanceField(vec2 point, vec2 start, vec2 end, float width, float capType) {
   if (capType == ${vt("butt")}) {
    return buttCapDistanceField(point, start, end);
  } else if (capType == ${vt("square")}) {
    return squareCapDistanceField(point, start, end, width);
  }
  return roundCapDistanceField(point, start, end, width);
}

float joinDistanceField(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float joinType) {
  if (joinType == ${vt("bevel")}) {
    return bevelJoinField(point, start, end, width, joinAngle);
  } else if (joinType == ${vt("miter")}) {
    return miterJoinDistanceField(point, start, end, width, joinAngle);
  }
  return roundJoinDistanceField(point, start, end, width);
}

float computeSegmentPointDistance(vec2 point, vec2 start, vec2 end, float width, float joinAngle, float capType, float joinType) {
  if (isCap(joinAngle)) {
    return capDistanceField(point, start, end, width, capType);
  }
  return joinDistanceField(point, start, end, width, joinAngle, joinType);
}

float distanceFromSegment(vec2 point, vec2 start, vec2 end) {
  vec2 tangent = end - start;
  vec2 startToPoint = point - start;
  // inspire by capsule fn in https://iquilezles.org/articles/distfunctions/
  float h = clamp(dot(startToPoint, tangent) / dot(tangent, tangent), 0.0, 1.0);
  return length(startToPoint - tangent * h);
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
      
  vec2 currentPoint = gl_FragCoord.xy / u_pixelRatio;
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(currentPoint);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif

  float segmentLength = length(v_segmentEnd - v_segmentStart);
  vec2 segmentTangent = (v_segmentEnd - v_segmentStart) / segmentLength;
  vec2 segmentNormal = vec2(-segmentTangent.y, segmentTangent.x);
  vec2 startToPoint = currentPoint - v_segmentStart;
  float lengthToPoint = max(0., min(dot(segmentTangent, startToPoint), segmentLength));
  float currentLengthPx = lengthToPoint + v_distanceOffsetPx;
  float currentRadiusPx = distanceFromSegment(currentPoint, v_segmentStart, v_segmentEnd);
  float currentRadiusRatio = dot(segmentNormal, startToPoint) * 2. / v_width;
  currentLineMetric = mix(v_measureStart, v_measureEnd, lengthToPoint / segmentLength);

  if (${this.discardExpression_}) { discard; }

  float capType = ${this.strokeCapExpression_};
  float joinType = ${this.strokeJoinExpression_};
  float segmentStartDistance = computeSegmentPointDistance(currentPoint, v_segmentStart, v_segmentEnd, v_width, v_angleStart, capType, joinType);
  float segmentEndDistance = computeSegmentPointDistance(currentPoint, v_segmentEnd, v_segmentStart, v_width, v_angleEnd, capType, joinType);
  float distanceField = max(
    segmentDistanceField(currentPoint, v_segmentStart, v_segmentEnd, v_width),
    max(segmentStartDistance, segmentEndDistance)
  );
  distanceField = max(distanceField, ${this.strokeDistanceFieldExpression_});

  vec4 color = ${this.strokeColorExpression_};
  color.a *= smoothstep(0.5, -0.5, distanceField);
  gl_FragColor = color;
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}getFillVertexShader(){return this.hasFill_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
attribute vec2 a_position;
attribute vec4 a_hitColor;

varying vec4 v_hitColor;

${this.attributes_.map(e=>`attribute ${e.type} ${e.name};
varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.vertexShaderFunctions_.join(`
`)}
void main(void) {
  gl_Position = u_projectionMatrix * vec4(a_position, u_depth, 1.0);
  v_hitColor = a_hitColor;
${this.attributes_.map(e=>`  ${e.varyingName} = ${e.varyingExpression};`).join(`
`)}
}`:null}getFillFragmentShader(){return this.hasFill_?`${or}
${this.uniforms_.map(e=>`uniform ${e};`).join(`
`)}
varying vec4 v_hitColor;
${this.attributes_.map(e=>`varying ${e.varyingType} ${e.varyingName};`).join(`
`)}
${this.fragmentShaderFunctions_.join(`
`)}
vec2 pxToWorld(vec2 pxPos) {
  vec2 screenPos = 2.0 * pxPos / u_viewportSizePx - 1.0;
  return (u_screenToWorldMatrix * vec4(screenPos, 0.0, 1.0)).xy;
}

vec2 worldToPx(vec2 worldPos) {
  vec4 screenPos = u_projectionMatrix * vec4(worldPos, 0.0, 1.0);
  return (0.5 * screenPos.xy + 0.5) * u_viewportSizePx;
}

void main(void) {
${this.attributes_.map(e=>`  ${e.varyingType} ${e.name} = ${e.varyingName}; // assign to original attribute name`).join(`
`)}
  vec2 pxPos = gl_FragCoord.xy / u_pixelRatio;
  vec2 pxOrigin = worldToPx(u_patternOrigin);
  #ifdef GL_FRAGMENT_PRECISION_HIGH
  vec2 worldPos = pxToWorld(pxPos);
  if (
    abs(u_renderExtent[0] - u_renderExtent[2]) > 0.0 && (
      worldPos[0] < u_renderExtent[0] ||
      worldPos[1] < u_renderExtent[1] ||
      worldPos[0] > u_renderExtent[2] ||
      worldPos[1] > u_renderExtent[3]
    )
  ) {
    discard;
  }
  #endif
  if (${this.discardExpression_}) { discard; }
  gl_FragColor = ${this.fillColorExpression_};
  gl_FragColor.a *= u_globalAlpha;
  gl_FragColor.rgb *= gl_FragColor.a;
  if (u_hitDetection > 0) {
    if (gl_FragColor.a < 0.1) { discard; };
    gl_FragColor = v_hitColor;
  }
}`:null}}function X(r,e,t){const i=Vl();return f_(e,t,i,r)}function p_(r){const e=ci(r),t=e[0]*256,i=e[1],n=e[2]*256,s=Math.round(e[3]*255);return[t+i,n+s]}const m_=`vec4 unpackColor(vec2 packedColor) {
  return vec4(
    fract(floor(packedColor[0] / 256.0) / 256.0),
    fract(packedColor[0] / 256.0),
    fract(floor(packedColor[1] / 256.0) / 256.0),
    fract(packedColor[1] / 256.0)
  );
}`;function xo(r){return r===We||r===Pr?2:r===kt?4:1}function ws(r){const e=xo(r);return e>1?`vec${e}`:"float"}function Mc(r,e){for(const t in e.variables){const i=e.variables[t],n=On(i.name);let s=ws(i.type);i.type===We&&(s="vec4"),r.addUniform(`${s} ${n}`)}for(const t in e.properties){const i=e.properties[t],n=ws(i.type),s=`a_prop_${i.name}`;i.type===We?(r.addAttribute(s,n,`unpackColor(${s})`,"vec4"),r.addVertexShaderFunction(m_)):r.addAttribute(s,n)}for(const t in e.functions)r.addVertexShaderFunction(e.functions[t]),r.addFragmentShaderFunction(e.functions[t])}function Nc(r,e){const t={};for(const i in r.variables){const n=r.variables[i],s=On(n.name);t[s]=()=>{const o=e[n.name];return typeof o=="number"?o:typeof o=="boolean"?o?1:0:n.type===We?ci(o||"#eee"):typeof o=="string"?wr(o):o}}return t}function Dc(r){const e={};for(const t in r.properties){const i=r.properties[t],n=s=>{const o=s.get(i.name);return i.type===We?p_([...ci(o||"#eee")]):typeof o=="string"?wr(o):typeof o=="boolean"?o?1:0:o};e[`prop_${i.name}`]={size:xo(i.type),callback:n}}return e}class cn{constructor(){this.globalCounter_=0,this.refToFeature_=new Map,this.uidToRef_=new Map,this.freeGlobalRef_=[],this.polygonBatch={entries:{},geometriesCount:0,verticesCount:0,ringsCount:0},this.pointBatch={entries:{},geometriesCount:0},this.lineStringBatch={entries:{},geometriesCount:0,verticesCount:0}}addFeatures(e,t){for(let i=0;i<e.length;i++)this.addFeature(e[i],t)}addFeature(e,t){let i=e.getGeometry();i&&(t&&(i=i.clone(),i.applyTransform(t)),this.addGeometry_(i,e))}clearFeatureEntryInPointBatch_(e){const t=he(e),i=this.pointBatch.entries[t];if(i)return this.pointBatch.geometriesCount-=i.flatCoordss.length,delete this.pointBatch.entries[t],i}clearFeatureEntryInLineStringBatch_(e){const t=he(e),i=this.lineStringBatch.entries[t];if(i)return this.lineStringBatch.verticesCount-=i.verticesCount,this.lineStringBatch.geometriesCount-=i.flatCoordss.length,delete this.lineStringBatch.entries[t],i}clearFeatureEntryInPolygonBatch_(e){const t=he(e),i=this.polygonBatch.entries[t];if(i)return this.polygonBatch.verticesCount-=i.verticesCount,this.polygonBatch.ringsCount-=i.ringsCount,this.polygonBatch.geometriesCount-=i.flatCoordss.length,delete this.polygonBatch.entries[t],i}addGeometry_(e,t){var n;const i=e.getType();switch(i){case"GeometryCollection":{const s=e.getGeometriesArray();for(const o of s)this.addGeometry_(o,t);break}case"MultiPolygon":{const s=e;this.addCoordinates_(i,s.getFlatCoordinates(),s.getEndss(),t,he(t),s.getStride());break}case"MultiLineString":{const s=e;this.addCoordinates_(i,s.getFlatCoordinates(),s.getEnds(),t,he(t),s.getStride());break}case"MultiPoint":{const s=e;this.addCoordinates_(i,s.getFlatCoordinates(),null,t,he(t),s.getStride());break}case"Polygon":{const s=e;this.addCoordinates_(i,s.getFlatCoordinates(),s.getEnds(),t,he(t),s.getStride());break}case"Point":{const s=e;this.addCoordinates_(i,s.getFlatCoordinates(),null,t,he(t),s.getStride());break}case"LineString":case"LinearRing":{const s=e,o=s.getStride();this.addCoordinates_(i,s.getFlatCoordinates(),null,t,he(t),o,(n=s.getLayout)==null?void 0:n.call(s));break}}}addCoordinates_(e,t,i,n,s,o,a){let l;switch(e){case"MultiPolygon":{const c=i;for(let u=0,h=c.length;u<h;u++){let f=c[u];const g=u>0?c[u-1]:null,d=g?g[g.length-1]:0,p=f[f.length-1];f=d>0?f.map(m=>m-d):f,this.addCoordinates_("Polygon",t.slice(d,p),f,n,s,o,a)}break}case"MultiLineString":{const c=i;for(let u=0,h=c.length;u<h;u++){const f=u>0?c[u-1]:0;this.addCoordinates_("LineString",t.slice(f,c[u]),null,n,s,o,a)}break}case"MultiPoint":for(let c=0,u=t.length;c<u;c+=o)this.addCoordinates_("Point",t.slice(c,c+2),null,n,s,null,null);break;case"Polygon":{const c=i;if(n instanceof gf){const f=pf(t,c);if(f.length>1){this.addCoordinates_("MultiPolygon",t,f,n,s,o,a);return}}this.polygonBatch.entries[s]||(this.polygonBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0,ringsCount:0,ringsVerticesCounts:[]})),l=t.length/o;const u=i.length,h=i.map((f,g,d)=>g>0?(f-d[g-1])/o:f/o);this.polygonBatch.verticesCount+=l,this.polygonBatch.ringsCount+=u,this.polygonBatch.geometriesCount++,this.polygonBatch.entries[s].flatCoordss.push(__(t,o)),this.polygonBatch.entries[s].ringsVerticesCounts.push(h),this.polygonBatch.entries[s].verticesCount+=l,this.polygonBatch.entries[s].ringsCount+=u;for(let f=0,g=c.length;f<g;f++){const d=f>0?c[f-1]:0;this.addCoordinates_("LinearRing",t.slice(d,c[f]),null,n,s,o,a)}break}case"Point":this.pointBatch.entries[s]||(this.pointBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[]})),this.pointBatch.geometriesCount++,this.pointBatch.entries[s].flatCoordss.push(t);break;case"LineString":case"LinearRing":this.lineStringBatch.entries[s]||(this.lineStringBatch.entries[s]=this.addRefToEntry_(s,{feature:n,flatCoordss:[],verticesCount:0})),l=t.length/o,this.lineStringBatch.verticesCount+=l,this.lineStringBatch.geometriesCount++,this.lineStringBatch.entries[s].flatCoordss.push(y_(t,o,a)),this.lineStringBatch.entries[s].verticesCount+=l;break}}addRefToEntry_(e,t){const i=this.uidToRef_.get(e),n=i||this.freeGlobalRef_.pop()||++this.globalCounter_;return t.ref=n,i||(this.refToFeature_.set(n,t.feature),this.uidToRef_.set(e,n)),t}removeRef_(e,t){if(!e)throw new Error("This feature has no ref: "+t);this.refToFeature_.delete(e),this.uidToRef_.delete(t),this.freeGlobalRef_.push(e)}changeFeature(e){if(!this.uidToRef_.get(he(e)))return;this.removeFeature(e);const t=e.getGeometry();t&&this.addGeometry_(t,e)}removeFeature(e){let t=this.clearFeatureEntryInPointBatch_(e);t=this.clearFeatureEntryInPolygonBatch_(e)||t,t=this.clearFeatureEntryInLineStringBatch_(e)||t,t&&this.removeRef_(t.ref,he(t.feature))}clear(){this.polygonBatch.entries={},this.polygonBatch.geometriesCount=0,this.polygonBatch.verticesCount=0,this.polygonBatch.ringsCount=0,this.lineStringBatch.entries={},this.lineStringBatch.geometriesCount=0,this.lineStringBatch.verticesCount=0,this.pointBatch.entries={},this.pointBatch.geometriesCount=0,this.globalCounter_=0,this.freeGlobalRef_=[],this.refToFeature_.clear(),this.uidToRef_.clear()}getFeatureFromRef(e){return this.refToFeature_.get(e)}isEmpty(){return this.globalCounter_===0}filter(e){const t=new cn;t.globalCounter_=this.globalCounter_,t.uidToRef_=this.uidToRef_,t.refToFeature_=this.refToFeature_;let i=!0;for(const n of this.refToFeature_.values())e(n)&&(t.addFeature(n),i=!1);return i?new cn:t}}function __(r,e){return e===2?r:r.filter((t,i)=>i%e<2)}function y_(r,e,t){return e===3&&t==="XYM"?r:e===4?r.filter((i,n)=>n%e!==2):e===3?r.map((i,n)=>n%e!==2?i:0):new Array(r.length*1.5).fill(0).map((i,n)=>n%3===2?0:r[Math.round(n/1.5)])}function Uc(){const r='function t(t,n,x=2){const o=n&&n.length,i=o?n[0]*x:t.length;let u=e(t,0,i,x,!0);const l=[];if(!u||u.next===u.prev)return l;let c,h,y;if(o&&(u=function(t,n,r,x){const o=[];for(let r=0,i=n.length;r<i;r++){const u=e(t,n[r]*x,r<i-1?n[r+1]*x:t.length,x,!1);u===u.next&&(u.steiner=!0),o.push(a(u))}o.sort(f);for(let t=0;t<o.length;t++)r=s(o[t],r);return r}(t,n,u,x)),t.length>80*x){c=1/0,h=1/0;let e=-1/0,n=-1/0;for(let r=x;r<i;r+=x){const x=t[r],o=t[r+1];x<c&&(c=x),o<h&&(h=o),x>e&&(e=x),o>n&&(n=o)}y=Math.max(e-c,n-h),y=0!==y?32767/y:0}return r(u,l,x,c,h,y,0),l}function e(t,e,n,r,x){let o;if(x===function(t,e,n,r){let x=0;for(let o=e,i=n-r;o<n;o+=r)x+=(t[i]-t[o])*(t[o+1]+t[i+1]),i=o;return x}(t,e,n,r)>0)for(let x=e;x<n;x+=r)o=w(x/r|0,t[x],t[x+1],o);else for(let x=n-r;x>=e;x-=r)o=w(x/r|0,t[x],t[x+1],o);return o&&g(o,o.next)&&(A(o),o=o.next),o}function n(t,e){if(!t)return t;e||(e=t);let n,r=t;do{if(n=!1,r.steiner||!g(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(A(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function r(t,e,f,s,l,a,h){if(!t)return;!h&&a&&function(t,e,n,r){let x=t;do{0===x.z&&(x.z=c(x.x,x.y,e,n,r)),x.prevZ=x.prev,x.nextZ=x.next,x=x.next}while(x!==t);x.prevZ.nextZ=null,x.prevZ=null,function(t){let e,n=1;do{let r,x=t;t=null;let o=null;for(e=0;x;){e++;let i=x,u=0;for(let t=0;t<n&&(u++,i=i.nextZ,i);t++);let f=n;for(;u>0||f>0&&i;)0!==u&&(0===f||!i||x.z<=i.z)?(r=x,x=x.nextZ,u--):(r=i,i=i.nextZ,f--),o?o.nextZ=r:t=r,r.prevZ=o,o=r;x=i}o.nextZ=null,n*=2}while(e>1)}(x)}(t,s,l,a);let y=t;for(;t.prev!==t.next;){const c=t.prev,p=t.next;if(a?o(t,s,l,a):x(t))e.push(c.i,t.i,p.i),A(t),t=p.next,y=p.next;else if((t=p)===y){h?1===h?r(t=i(n(t),e),e,f,s,l,a,2):2===h&&u(t,e,f,s,l,a):r(n(t),e,f,s,l,a,1);break}}}function x(t){const e=t.prev,n=t,r=t.next;if(v(e,n,r)>=0)return!1;const x=e.x,o=n.x,i=r.x,u=e.y,f=n.y,s=r.y,l=Math.min(x,o,i),c=Math.min(u,f,s),a=Math.max(x,o,i),h=Math.max(u,f,s);let p=r.next;for(;p!==e;){if(p.x>=l&&p.x<=a&&p.y>=c&&p.y<=h&&y(x,u,o,f,i,s,p.x,p.y)&&v(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function o(t,e,n,r){const x=t.prev,o=t,i=t.next;if(v(x,o,i)>=0)return!1;const u=x.x,f=o.x,s=i.x,l=x.y,a=o.y,h=i.y,p=Math.min(u,f,s),g=Math.min(l,a,h),b=Math.max(u,f,s),M=Math.max(l,a,h),m=c(p,g,e,n,r),Z=c(b,M,e,n,r);let d=t.prevZ,w=t.nextZ;for(;d&&d.z>=m&&w&&w.z<=Z;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;d&&d.z>=m;){if(d.x>=p&&d.x<=b&&d.y>=g&&d.y<=M&&d!==x&&d!==i&&y(u,l,f,a,s,h,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;w&&w.z<=Z;){if(w.x>=p&&w.x<=b&&w.y>=g&&w.y<=M&&w!==x&&w!==i&&y(u,l,f,a,s,h,w.x,w.y)&&v(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function i(t,e){let r=t;do{const n=r.prev,x=r.next.next;!g(n,x)&&b(n,r,r.next,x)&&Z(n,x)&&Z(x,n)&&(e.push(n.i,r.i,x.i),A(r),A(r.next),r=t=x),r=r.next}while(r!==t);return n(r)}function u(t,e,x,o,i,u){let f=t;do{let t=f.next.next;for(;t!==f.prev;){if(f.i!==t.i&&p(f,t)){let s=d(f,t);return f=n(f,f.next),s=n(s,s.next),r(f,e,x,o,i,u,0),void r(s,e,x,o,i,u,0)}t=t.next}f=f.next}while(f!==t)}function f(t,e){let n=t.x-e.x;if(0===n&&(n=t.y-e.y,0===n)){n=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return n}function s(t,e){const r=function(t,e){let n=e;const r=t.x,x=t.y;let o,i=-1/0;if(g(t,n))return n;do{if(g(t,n.next))return n.next;if(x<=n.y&&x>=n.next.y&&n.next.y!==n.y){const t=n.x+(x-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(t<=r&&t>i&&(i=t,o=n.x<n.next.x?n:n.next,t===r))return o}n=n.next}while(n!==e);if(!o)return null;const u=o,f=o.x,s=o.y;let c=1/0;n=o;do{if(r>=n.x&&n.x>=f&&r!==n.x&&h(x<s?r:i,x,f,s,x<s?i:r,x,n.x,n.y)){const e=Math.abs(x-n.y)/(r-n.x);Z(n,t)&&(e<c||e===c&&(n.x>o.x||n.x===o.x&&l(o,n)))&&(o=n,c=e)}n=n.next}while(n!==u);return o}(t,e);if(!r)return e;const x=d(r,t);return n(x,x.next),n(r,r.next)}function l(t,e){return v(t.prev,t,e.prev)<0&&v(e.next,t,t.next)<0}function c(t,e,n,r,x){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*x|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*x|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function a(t){let e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function h(t,e,n,r,x,o,i,u){return(x-i)*(e-u)>=(t-i)*(o-u)&&(t-i)*(r-u)>=(n-i)*(e-u)&&(n-i)*(o-u)>=(x-i)*(r-u)}function y(t,e,n,r,x,o,i,u){return!(t===i&&e===u)&&h(t,e,n,r,x,o,i,u)}function p(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&b(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Z(t,e)&&Z(e,t)&&function(t,e){let n=t,r=!1;const x=(t.x+e.x)/2,o=(t.y+e.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&x<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(v(t.prev,t,e.prev)||v(t,e.prev,e))||g(t,e)&&v(t.prev,t,t.next)>0&&v(e.prev,e,e.next)>0)}function v(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function g(t,e){return t.x===e.x&&t.y===e.y}function b(t,e,n,r){const x=m(v(t,e,n)),o=m(v(t,e,r)),i=m(v(n,r,t)),u=m(v(n,r,e));return x!==o&&i!==u||(!(0!==x||!M(t,n,e))||(!(0!==o||!M(t,r,e))||(!(0!==i||!M(n,t,r))||!(0!==u||!M(n,e,r)))))}function M(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function m(t){return t>0?1:t<0?-1:0}function Z(t,e){return v(t.prev,t,t.next)<0?v(t,e,t.next)>=0&&v(t,t.prev,e)>=0:v(t,e,t.prev)<0||v(t,t.next,e)<0}function d(t,e){const n=E(t.i,t.x,t.y),r=E(e.i,e.x,e.y),x=t.next,o=e.prev;return t.next=e,e.prev=t,n.next=x,x.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function w(t,e,n,r){const x=E(t,e,n);return r?(x.next=r.next,x.prev=r,r.next.prev=x,r.next=x):(x.prev=x,x.next=x),x}function A(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function E(t,e,n){return{i:t,x:e,y:n,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function I(t,e){const n=e[0],r=e[1];return e[0]=t[0]*n+t[2]*r+t[4],e[1]=t[1]*n+t[3]*r+t[5],e}function z(t,e){const n=(r=e)[0]*r[3]-r[1]*r[2];var r;!function(t,e){if(!t)throw new Error(e)}(0!==n,"Transformation matrix cannot be inverted");const x=e[0],o=e[1],i=e[2],u=e[3],f=e[4],s=e[5];return t[0]=u/n,t[1]=-o/n,t[2]=-i/n,t[3]=x/n,t[4]=(i*s-u*f)/n,t[5]=-(x*s-o*f)/n,t}new Array(6);const F=[],P={vertexPosition:0,indexPosition:0};function B(t,e,n,r,x){t[e+0]=n,t[e+1]=r,t[e+2]=x}function N(t,e,n,r,x,o){const i=3+x,u=t[e+0],f=t[e+1],s=F;s.length=x;for(let n=0;n<s.length;n++)s[n]=t[e+2+n];let l=o?o.vertexPosition:0,c=o?o.indexPosition:0;const a=l/i;return B(n,l,u,f,0),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,1),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,2),s.length&&n.set(s,l+3),l+=i,B(n,l,u,f,3),s.length&&n.set(s,l+3),l+=i,r[c++]=a,r[c++]=a+1,r[c++]=a+3,r[c++]=a+1,r[c++]=a+2,r[c++]=a+3,P.vertexPosition=l,P.indexPosition=c,P}function R(t,e,n,r,x,o,i,u,f,s,l){const c=10+u.length,a=o.length/c,h=[t[e+0],t[e+1]],y=[t[n],t[n+1]],p=t[e+2],v=t[n+2],g=I(f,[...h]),b=I(f,[...y]);function M(t,e,n){const r=Math.sqrt((e[0]-t[0])*(e[0]-t[0])+(e[1]-t[1])*(e[1]-t[1])),x=[(e[0]-t[0])/r,(e[1]-t[1])/r],o=[-x[1],x[0]],i=Math.sqrt((n[0]-t[0])*(n[0]-t[0])+(n[1]-t[1])*(n[1]-t[1])),u=[(n[0]-t[0])/i,(n[1]-t[1])/i],f=0===r||0===i?0:Math.acos((s=u[0]*x[0]+u[1]*x[1],l=-1,c=1,Math.min(Math.max(s,l),c)));var s,l,c;return u[0]*o[0]+u[1]*o[1]>0?f:2*Math.PI-f}let m=-1,Z=-1,d=l;const w=null!==x;if(null!==r){m=M(g,b,I(f,[...[t[r],t[r+1]]])),Math.cos(m)<=.985&&(d+=Math.tan((m-Math.PI)/2))}if(w){Z=M(b,g,I(f,[...[t[x],t[x+1]]])),Math.cos(Z)<=.985&&(d+=Math.tan((Math.PI-Z)/2))}function A(t,e){return 0===e?1e4*t:Math.sign(e)*(1e4*t+Math.abs(e))}return o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(0,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(1,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(2,l)),o.push(...u),o.push(h[0],h[1],p,y[0],y[1],v,m,Z,s,A(3,l)),o.push(...u),i.push(a,a+1,a+2,a+1,a+3,a+2),{length:s+Math.sqrt((b[0]-g[0])*(b[0]-g[0])+(b[1]-g[1])*(b[1]-g[1])),angle:d}}function S(e,n,r,x,o){const i=2+o;let u=n;const f=e.slice(u,u+o);u+=o;const s=e[u++];let l=0;const c=new Array(s-1);for(let t=0;t<s;t++)l+=e[u++],t<s-1&&(c[t]=l);const a=e.slice(u,u+2*l),h=t(a,c,2);for(let t=0;t<h.length;t++)x.push(h[t]+r.length/i);for(let t=0;t<a.length;t+=2)r.push(a[t],a[t+1],...f);return u+2*l}const T="GENERATE_POLYGON_BUFFERS",_="GENERATE_POINT_BUFFERS",O="GENERATE_LINE_STRING_BUFFERS",U=self;U.onmessage=t=>{const e=t.data;switch(e.type){case _:{const t=3,n=2,r=e.customAttributesSize,x=n+r,o=new Float32Array(e.renderInstructions),i=o.length/x,u=4*i*(r+t),f=new Uint32Array(6*i),s=new Float32Array(u);let l;for(let t=0;t<o.length;t+=x)l=N(o,t,s,f,r,l);const c=Object.assign({vertexBuffer:s.buffer,indexBuffer:f.buffer,renderInstructions:o.buffer},e);U.postMessage(c,[s.buffer,f.buffer,o.buffer]);break}case O:{const t=[],n=[],r=e.customAttributesSize,x=3,o=new Float32Array(e.renderInstructions);let i=0;const u=[1,0,0,1,0,0];let f,s;for(z(u,e.renderInstructionsTransform);i<o.length;){s=Array.from(o.slice(i,i+r)),i+=r,f=o[i++];const e=i,l=i+(f-1)*x,c=o[e]===o[l]&&o[e+1]===o[l+1];let a=0,h=0;for(let r=0;r<f-1;r++){let y=null;r>0?y=i+(r-1)*x:c&&(y=l-x);let p=null;r<f-2?p=i+(r+2)*x:c&&(p=e+x);const v=R(o,i+r*x,i+(r+1)*x,y,p,t,n,s,u,a,h);a=v.length,h=v.angle}i+=f*x}const l=Uint32Array.from(n),c=Float32Array.from(t),a=Object.assign({vertexBuffer:c.buffer,indexBuffer:l.buffer,renderInstructions:o.buffer},e);U.postMessage(a,[c.buffer,l.buffer,o.buffer]);break}case T:{const t=[],n=[],r=e.customAttributesSize,x=new Float32Array(e.renderInstructions);let o=0;for(;o<x.length;)o=S(x,o,t,n,r);const i=Uint32Array.from(n),u=Float32Array.from(t),f=Object.assign({vertexBuffer:u.buffer,indexBuffer:i.buffer,renderInstructions:x.buffer},e);U.postMessage(f,[u.buffer,i.buffer,x.buffer]);break}}};';return new Worker(typeof Blob>"u"?"data:application/javascript;base64,"+Buffer.from(r,"binary").toString("base64"):URL.createObjectURL(new Blob([r],{type:"application/javascript"})))}const Zr={GENERATE_POLYGON_BUFFERS:"GENERATE_POLYGON_BUFFERS",GENERATE_POINT_BUFFERS:"GENERATE_POINT_BUFFERS",GENERATE_LINE_STRING_BUFFERS:"GENERATE_LINE_STRING_BUFFERS"};function Bc(r,e){e=e||[];const t=256,i=t-1;return e[0]=Math.floor(r/t/t/t)/i,e[1]=Math.floor(r/t/t)%t/i,e[2]=Math.floor(r/t)%t/i,e[3]=r%t/i,e}function Gc(r){let e=0;const t=256,i=t-1;return e+=Math.round(r[0]*t*t*t*i),e+=Math.round(r[1]*t*t*i),e+=Math.round(r[2]*t*i),e+=Math.round(r[3]*i),e}function Eo(r,e,t,i){let n=0;for(const s in e){const o=e[s],a=o.callback.call(t,t.feature);let l=(a==null?void 0:a[0])??a;l===Ts&&console.warn('The "has" operator might return false positives.'),l===void 0?l=Ts:l===null&&(l=0),r[i+n++]=l,!(!o.size||o.size===1)&&(r[i+n++]=a[1],!(o.size<3)&&(r[i+n++]=a[2],!(o.size<4)&&(r[i+n++]=a[3])))}return n}function Mn(r){return Object.keys(r).reduce((e,t)=>e+(r[t].size||1),0)}function x_(r,e,t,i){const n=(2+Mn(t))*r.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++)s[0]=l.flatCoordss[c][0],s[1]=l.flatCoordss[c][1],It(i,s),e[o++]=s[0],e[o++]=s[1],o+=Eo(e,t,l,o)}return e}function E_(r,e,t,i){const n=3*r.verticesCount+(1+Mn(t))*r.geometriesCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,Ql(l.flatCoordss[c],0,s.length,3,i,s,3),o+=Eo(e,t,l,o),e[o++]=s.length/3;for(let h=0,f=s.length;h<f;h+=3)e[o++]=s[h],e[o++]=s[h+1],e[o++]=s[h+2]}}return e}function b_(r,e,t,i){const n=2*r.verticesCount+(1+Mn(t))*r.geometriesCount+r.ringsCount;(!e||e.length!==n)&&(e=new Float32Array(n));const s=[];let o=0;for(const a in r.entries){const l=r.entries[a];for(let c=0,u=l.flatCoordss.length;c<u;c++){s.length=l.flatCoordss[c].length,Ql(l.flatCoordss[c],0,s.length,2,i,s),o+=Eo(e,t,l,o),e[o++]=l.ringsVerticesCounts[c].length;for(let h=0,f=l.ringsVerticesCounts[c].length;h<f;h++)e[o++]=l.ringsVerticesCounts[c][h];for(let h=0,f=s.length;h<f;h+=2)e[o++]=s[h],e[o++]=s[h+1]}}return e}function un(r){return(JSON.stringify(r).split("").reduce((t,i)=>(t<<5)-t+i.charCodeAt(0),0)>>>0).toString()}function bo(r,e,t,i){if(`${i}radius`in r&&i!=="icon-"){let n=X(t,r[`${i}radius`],oe);if(`${i}radius2`in r){const s=X(t,r[`${i}radius2`],oe);n=`max(${n}, ${s})`}`${i}stroke-width`in r&&(n=`(${n} + ${X(t,r[`${i}stroke-width`],oe)} * 0.5)`),e.setSymbolSizeExpression(`vec2(${n} * 2. + 0.5)`)}if(`${i}scale`in r){const n=X(t,r[`${i}scale`],Pr);e.setSymbolSizeExpression(`${e.getSymbolSizeExpression()} * ${n}`)}`${i}displacement`in r&&e.setSymbolOffsetExpression(X(t,r[`${i}displacement`],kt)),`${i}rotation`in r&&e.setSymbolRotationExpression(X(t,r[`${i}rotation`],oe)),`${i}rotate-with-view`in r&&e.setSymbolRotateWithView(!!r[`${i}rotate-with-view`])}function zc(r,e,t,i,n){let s="vec4(0.)";if(e!==null&&(s=e),t!==null&&i!==null){const l=`smoothstep(-${i} + 0.63, -${i} - 0.58, ${r})`;s=`mix(${t}, ${s}, ${l})`}const o=`(1.0 - smoothstep(-0.63, 0.58, ${r}))`;let a=`${s} * vec4(1.0, 1.0, 1.0, ${o})`;return n!==null&&(a=`${a} * vec4(1.0, 1.0, 1.0, ${n})`),a}function To(r,e,t,i,n){const s=new Image;s.crossOrigin=r[`${i}cross-origin`]===void 0?"anonymous":r[`${i}cross-origin`],et(typeof r[`${i}src`]=="string",`WebGL layers do not support expressions for the ${i}src style property`),s.src=r[`${i}src`],t[`u_texture${n}_size`]=()=>s.complete?[s.width,s.height]:[0,0],e.addUniform(`vec2 u_texture${n}_size`);const o=`u_texture${n}_size`;return t[`u_texture${n}`]=s,e.addUniform(`sampler2D u_texture${n}`),o}function wo(r,e,t,i,n){let s=X(t,r[`${e}offset`],kt);if(`${e}offset-origin`in r)switch(r[`${e}offset-origin`]){case"top-right":s=`vec2(${i}.x, 0.) + ${n} * vec2(-1., 0.) + ${s} * vec2(-1., 1.)`;break;case"bottom-left":s=`vec2(0., ${i}.y) + ${n} * vec2(0., -1.) + ${s} * vec2(1., -1.)`;break;case"bottom-right":s=`${i} - ${n} - ${s}`;break}return s}function T_(r,e,t,i){i.functions.circleDistanceField=`float circleDistanceField(vec2 point, float radius) {
  return length(point) - radius;
}`,bo(r,e,i,"circle-");let n=null;"circle-opacity"in r&&(n=X(i,r["circle-opacity"],oe));let s="coordsPx";"circle-scale"in r&&(s=`coordsPx / ${X(i,r["circle-scale"],Pr)}`);let o=null;"circle-fill-color"in r&&(o=X(i,r["circle-fill-color"],We));let a=null;"circle-stroke-color"in r&&(a=X(i,r["circle-stroke-color"],We));let l=X(i,r["circle-radius"],oe),c=null;"circle-stroke-width"in r&&(c=X(i,r["circle-stroke-width"],oe),l=`(${l} + ${c} * 0.5)`);const u=`circleDistanceField(${s}, ${l})`,h=zc(u,o,a,c,n);e.setSymbolColorExpression(h)}function w_(r,e,t,i){i.functions.round=`float round(float v) {
  return sign(v) * floor(abs(v) + 0.5);
}`,i.functions.starDistanceField=`float starDistanceField(vec2 point, float numPoints, float radius, float radius2, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round(beta / alpha) * alpha; // angle in sector
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  vec2 tipToPoint = inSector + vec2(-radius, 0.);
  vec2 edgeNormal = vec2(radius2 * sin(alpha * 0.5), -radius2 * cos(alpha * 0.5) + radius);
  return dot(normalize(edgeNormal), tipToPoint);
}`,i.functions.regularDistanceField=`float regularDistanceField(vec2 point, float numPoints, float radius, float angle) {
  float startAngle = -PI * 0.5 + angle; // tip starts upwards and rotates clockwise with angle
  float c = cos(startAngle);
  float s = sin(startAngle);
  vec2 pointRotated = vec2(c * point.x - s * point.y, s * point.x + c * point.y);
  float alpha = TWO_PI / numPoints; // the angle of one sector
  float radiusIn = radius * cos(PI / numPoints);
  float beta = atan(pointRotated.y, pointRotated.x);
  float gamma = round((beta - alpha * 0.5) / alpha) * alpha + alpha * 0.5; // angle in sector from mid
  c = cos(-gamma);
  s = sin(-gamma);
  vec2 inSector = vec2(c * pointRotated.x - s * pointRotated.y, abs(s * pointRotated.x + c * pointRotated.y));
  return inSector.x - radiusIn;
}`,bo(r,e,i,"shape-");let n=null;"shape-opacity"in r&&(n=X(i,r["shape-opacity"],oe));let s="coordsPx";"shape-scale"in r&&(s=`coordsPx / ${X(i,r["shape-scale"],Pr)}`);let o=null;"shape-fill-color"in r&&(o=X(i,r["shape-fill-color"],We));let a=null;"shape-stroke-color"in r&&(a=X(i,r["shape-stroke-color"],We));let l=null;"shape-stroke-width"in r&&(l=X(i,r["shape-stroke-width"],oe));const c=X(i,r["shape-points"],oe);let u="0.";"shape-angle"in r&&(u=X(i,r["shape-angle"],oe));let h,f=X(i,r["shape-radius"],oe);if(l!==null&&(f=`${f} + ${l} * 0.5`),"shape-radius2"in r){let d=X(i,r["shape-radius2"],oe);l!==null&&(d=`${d} + ${l} * 0.5`),h=`starDistanceField(${s}, ${c}, ${f}, ${d}, ${u})`}else h=`regularDistanceField(${s}, ${c}, ${f}, ${u})`;const g=zc(h,o,a,l,n);e.setSymbolColorExpression(g)}function S_(r,e,t,i){let n="vec4(1.0)";"icon-color"in r&&(n=X(i,r["icon-color"],We)),"icon-opacity"in r&&(n=`${n} * vec4(1.0, 1.0, 1.0, ${X(i,r["icon-opacity"],oe)})`);const s=un(r["icon-src"]),o=To(r,e,t,"icon-",s);if(e.setSymbolColorExpression(`${n} * texture2D(u_texture${s}, v_texCoord)`).setSymbolSizeExpression(o),"icon-width"in r&&"icon-height"in r&&e.setSymbolSizeExpression(`vec2(${X(i,r["icon-width"],oe)}, ${X(i,r["icon-height"],oe)})`),"icon-offset"in r&&"icon-size"in r){const a=X(i,r["icon-size"],kt),l=e.getSymbolSizeExpression();e.setSymbolSizeExpression(a);const c=wo(r,"icon-",i,"v_quadSizePx",a);e.setTextureCoordinateExpression(`(vec4((${c}).xyxy) + vec4(0., 0., ${a})) / (${l}).xyxy`)}if(bo(r,e,i,"icon-"),"icon-anchor"in r){const a=X(i,r["icon-anchor"],kt);let l="1.0";"icon-scale"in r&&(l=X(i,r["icon-scale"],Pr));let c;r["icon-anchor-x-units"]==="pixels"&&r["icon-anchor-y-units"]==="pixels"?c=`${a} * ${l}`:r["icon-anchor-x-units"]==="pixels"?c=`${a} * vec2(vec2(${l}).x, v_quadSizePx.y)`:r["icon-anchor-y-units"]==="pixels"?c=`${a} * vec2(v_quadSizePx.x, vec2(${l}).x)`:c=`${a} * v_quadSizePx`;let u=`v_quadSizePx * vec2(0.5, -0.5) + ${c} * vec2(-1., 1.)`;if("icon-anchor-origin"in r)switch(r["icon-anchor-origin"]){case"top-right":u=`v_quadSizePx * -0.5 + ${c}`;break;case"bottom-left":u=`v_quadSizePx * 0.5 - ${c}`;break;case"bottom-right":u=`v_quadSizePx * vec2(-0.5, 0.5) + ${c} * vec2(1., -1.)`;break}e.setSymbolOffsetExpression(`${e.getSymbolOffsetExpression()} + ${u}`)}}function v_(r,e,t,i){if("stroke-color"in r&&e.setStrokeColorExpression(X(i,r["stroke-color"],We)),"stroke-pattern-src"in r){const n=un(r["stroke-pattern-src"]),s=To(r,e,t,"stroke-pattern-",n);let o=s,a="vec2(0.)";"stroke-pattern-offset"in r&&"stroke-pattern-size"in r&&(o=X(i,r["stroke-pattern-size"],kt),a=wo(r,"stroke-pattern-",i,s,o));let l="0.";"stroke-pattern-spacing"in r&&(l=X(i,r["stroke-pattern-spacing"],oe)),i.functions.sampleStrokePattern=`vec4 sampleStrokePattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, float spacingPx, float currentLengthPx, float currentRadiusRatio, float lineWidth) {
  float currentLengthScaled = currentLengthPx * sampleSize.y / lineWidth;
  float spacingScaled = spacingPx * sampleSize.y / lineWidth;
  float uCoordPx = mod(currentLengthScaled, (sampleSize.x + spacingScaled));
  // make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  uCoordPx = clamp(uCoordPx, 0.5, sampleSize.x - 0.5);
  float vCoordPx = (-currentRadiusRatio * 0.5 + 0.5) * sampleSize.y;
  vec2 texCoord = (vec2(uCoordPx, vCoordPx) + textureOffset) / textureSize;
  return texture2D(texture, texCoord);
}`;const c=`u_texture${n}`;let u="1.";"stroke-color"in r&&(u=e.getStrokeColorExpression()),e.setStrokeColorExpression(`${u} * sampleStrokePattern(${c}, ${s}, ${a}, ${o}, ${l}, currentLengthPx, currentRadiusRatio, v_width)`)}if("stroke-width"in r&&e.setStrokeWidthExpression(X(i,r["stroke-width"],oe)),"stroke-offset"in r&&e.setStrokeOffsetExpression(X(i,r["stroke-offset"],oe)),"stroke-line-cap"in r&&e.setStrokeCapExpression(X(i,r["stroke-line-cap"],ei)),"stroke-line-join"in r&&e.setStrokeJoinExpression(X(i,r["stroke-line-join"],ei)),"stroke-miter-limit"in r&&e.setStrokeMiterLimitExpression(X(i,r["stroke-miter-limit"],oe)),"stroke-line-dash"in r){i.functions.getSingleDashDistance=`float getSingleDashDistance(float distance, float radius, float dashOffset, float dashLength, float dashLengthTotal, float capType, float lineWidth) {
  float localDistance = mod(distance, dashLengthTotal);
  float distanceSegment = abs(localDistance - dashOffset - dashLength * 0.5) - dashLength * 0.5;
  distanceSegment = min(distanceSegment, dashLengthTotal - localDistance);
  if (capType == ${vt("square")}) {
    distanceSegment -= lineWidth * 0.5;
  } else if (capType == ${vt("round")}) {
    distanceSegment = min(distanceSegment, sqrt(distanceSegment * distanceSegment + radius * radius) - lineWidth * 0.5);
  }
  return distanceSegment;
}`;let n=r["stroke-line-dash"].map(f=>X(i,f,oe));n.length%2===1&&(n=[...n,...n]);let s="0.";"stroke-line-dash-offset"in r&&(s=X(i,r["stroke-line-dash-offset"],oe));const a=`dashDistanceField_${un(r["stroke-line-dash"])}`,l=n.map((f,g)=>`float dashLength${g} = ${f};`),c=n.map((f,g)=>`dashLength${g}`).join(" + ");let u="0.",h=`getSingleDashDistance(distance, radius, ${u}, dashLength0, totalDashLength, capType, lineWidth)`;for(let f=2;f<n.length;f+=2)u=`${u} + dashLength${f-2} + dashLength${f-1}`,h=`min(${h}, getSingleDashDistance(distance, radius, ${u}, dashLength${f}, totalDashLength, capType, lineWidth))`;i.functions[a]=`float ${a}(float distance, float radius, float capType, float lineWidth) {
  ${l.join(`
  `)}
  float totalDashLength = ${c};
  return ${h};
}`,e.setStrokeDistanceFieldExpression(`${a}(currentLengthPx + ${s}, currentRadiusPx, capType, v_width)`)}}function R_(r,e,t,i){if("fill-color"in r&&e.setFillColorExpression(X(i,r["fill-color"],We)),"fill-pattern-src"in r){const n=un(r["fill-pattern-src"]),s=To(r,e,t,"fill-pattern-",n);let o=s,a="vec2(0.)";"fill-pattern-offset"in r&&"fill-pattern-size"in r&&(o=X(i,r["fill-pattern-size"],kt),a=wo(r,"fill-pattern-",i,s,o)),i.functions.sampleFillPattern=`vec4 sampleFillPattern(sampler2D texture, vec2 textureSize, vec2 textureOffset, vec2 sampleSize, vec2 pxOrigin, vec2 pxPosition) {
  float scaleRatio = pow(2., mod(u_zoom + 0.5, 1.) - 0.5);
  vec2 pxRelativePos = pxPosition - pxOrigin;
  // rotate the relative position from origin by the current view rotation
  pxRelativePos = vec2(pxRelativePos.x * cos(u_rotation) - pxRelativePos.y * sin(u_rotation), pxRelativePos.x * sin(u_rotation) + pxRelativePos.y * cos(u_rotation));
  // sample position is computed according to the sample offset & size
  vec2 samplePos = mod(pxRelativePos / scaleRatio, sampleSize);
  // also make sure that we're not sampling too close to the borders to avoid interpolation with outside pixels
  samplePos = clamp(samplePos, vec2(0.5), sampleSize - vec2(0.5));
  samplePos.y = sampleSize.y - samplePos.y; // invert y axis so that images appear upright
  return texture2D(texture, (samplePos + textureOffset) / textureSize);
}`;const l=`u_texture${n}`;let c="1.";"fill-color"in r&&(c=e.getFillColorExpression()),e.setFillColorExpression(`${c} * sampleFillPattern(${l}, ${s}, ${a}, ${o}, pxOrigin, pxPos)`)}}function kc(r,e,t){const i=_o(),n=new Oc,s={};if("icon-src"in r?S_(r,n,s,i):"shape-points"in r?w_(r,n,s,i):"circle-radius"in r&&T_(r,n,s,i),v_(r,n,s,i),R_(r,n,s,i),t){const l=X(i,t,Tn);n.setFragmentDiscardExpression(`!${l}`)}const o={};function a(l,c,u,h){if(!i[l])return;const f=ws(u),g=xo(u);n.addAttribute(`a_${c}`,f),o[c]={size:g,callback:h}}return a("geometryType",Fc,ei,l=>wr(Xl(l.getGeometry()))),a("featureId",Cc,ei|oe,l=>{const c=l.getId()??null;return typeof c=="string"?wr(c):c}),Mc(n,i),{builder:n,attributes:{...o,...Dc(i)},uniforms:{...s,...Nc(i,e)}}}function A_(r){const e=Array.isArray(r)?r:[r];if("style"in e[0]){const t=[],i=e,n=[];for(const s of i){const o=Array.isArray(s.style)?s.style:[s.style];let a=s.filter;s.else&&n.length&&(a=["all",...n.map(c=>["!",c])],s.filter&&a.push(s.filter),a.length<3&&(a=a[1])),s.filter&&n.push(s.filter);const l=o.map(c=>({style:c,...a&&{filter:a}}));t.push(...l)}return t}return"builder"in e[0]?e:e.map(t=>({style:t}))}const P_=[];let Zn;function L_(){return Zn||(Zn=Uc()),Zn}let I_=0;const ut={POSITION:"a_position",INDEX:"a_index",SEGMENT_START:"a_segmentStart",SEGMENT_END:"a_segmentEnd",MEASURE_START:"a_measureStart",MEASURE_END:"a_measureEnd",PARAMETERS:"a_parameters",JOIN_ANGLES:"a_joinAngles",DISTANCE:"a_distance"};class C_{constructor(e,t,i,n,s){this.helper_,this.hitDetectionEnabled_=!!n;let o=e;if(!("builder"in e)){const u=e,h=kc(u.style,t,u.filter);o={builder:h.builder,attributes:h.attributes,uniforms:h.uniforms}}this.fillProgram_,this.strokeProgram_,this.symbolProgram_,this.hasFill_=!!o.builder.getFillVertexShader(),this.hasFill_&&(this.fillVertexShader_=o.builder.getFillVertexShader(),this.fillFragmentShader_=o.builder.getFillFragmentShader()),this.hasStroke_=!!o.builder.getStrokeVertexShader(),this.hasStroke_&&(this.strokeVertexShader_=o.builder.getStrokeVertexShader(),this.strokeFragmentShader_=o.builder.getStrokeFragmentShader()),this.hasSymbol_=!!o.builder.getSymbolVertexShader(),this.hasSymbol_&&(this.symbolVertexShader_=o.builder.getSymbolVertexShader(),this.symbolFragmentShader_=o.builder.getSymbolFragmentShader()),this.featureFilter_=null,s&&(this.featureFilter_=this.computeFeatureFilter(s));const l=this.hitDetectionEnabled_?{hitColor:{callback(){return Bc(this.ref,P_)},size:4}}:{};this.customAttributes_=Object.assign({},l,o.attributes),this.uniforms_=o.uniforms;const c=Object.entries(this.customAttributes_).map(([u,h])=>({name:`a_${u}`,size:h.size||1,type:Se.FLOAT}));this.polygonAttributesDesc_=[{name:ut.POSITION,size:2,type:Se.FLOAT},...c],this.lineStringAttributesDesc_=[{name:ut.SEGMENT_START,size:2,type:Se.FLOAT},{name:ut.MEASURE_START,size:1,type:Se.FLOAT},{name:ut.SEGMENT_END,size:2,type:Se.FLOAT},{name:ut.MEASURE_END,size:1,type:Se.FLOAT},{name:ut.JOIN_ANGLES,size:2,type:Se.FLOAT},{name:ut.DISTANCE,size:1,type:Se.FLOAT},{name:ut.PARAMETERS,size:1,type:Se.FLOAT},...c],this.pointAttributesDesc_=[{name:ut.POSITION,size:2,type:Se.FLOAT},{name:ut.INDEX,size:1,type:Se.FLOAT},...c],this.setHelper(i)}computeFeatureFilter(e){const t=Vl();let i;try{i=Sh(e,Tn,t)}catch{return null}if(t.mapState||t.variables.size>0)return null;const n=vh();return s=>{if(n.properties=s.getPropertiesInternal(),t.featureId){const o=s.getId();o!==void 0?n.featureId=o:n.featureId=null}return n.geometryType=Xl(s.getGeometry()),i(n)}}async generateBuffers(e,t){let i=e;if(this.featureFilter_&&(i=i.filter(this.featureFilter_),i.isEmpty()))return null;const n=this.generateRenderInstructions_(i,t),[s,o,a]=await Promise.all([this.generateBuffersForType_(n.polygonInstructions,"Polygon",t),this.generateBuffersForType_(n.lineStringInstructions,"LineString",t),this.generateBuffersForType_(n.pointInstructions,"Point",t)]),l=ii(Ce(),t);return{polygonBuffers:s,lineStringBuffers:o,pointBuffers:a,invertVerticesTransform:l}}generateRenderInstructions_(e,t){const i=this.hasFill_?b_(e.polygonBatch,new Float32Array(0),this.customAttributes_,t):null,n=this.hasStroke_?E_(e.lineStringBatch,new Float32Array(0),this.customAttributes_,t):null,s=this.hasSymbol_?x_(e.pointBatch,new Float32Array(0),this.customAttributes_,t):null;return{polygonInstructions:i,lineStringInstructions:n,pointInstructions:s}}generateBuffersForType_(e,t,i){if(e===null)return null;const n=I_++;let s;switch(t){case"Polygon":s=Zr.GENERATE_POLYGON_BUFFERS;break;case"LineString":s=Zr.GENERATE_LINE_STRING_BUFFERS;break;case"Point":s=Zr.GENERATE_POINT_BUFFERS;break}const o={id:n,type:s,renderInstructions:e.buffer,renderInstructionsTransform:i,customAttributesSize:Mn(this.customAttributes_)},a=L_();return a.postMessage(o,[e.buffer]),e=null,new Promise(l=>{const c=u=>{const h=u.data;if(h.id!==n||(a.removeEventListener("message",c),!this.helper_.getGL()))return;const f=new Tr(mi,an).fromArrayBuffer(h.vertexBuffer),g=new Tr(_i,an).fromArrayBuffer(h.indexBuffer);this.helper_.flushBufferData(f),this.helper_.flushBufferData(g),l([g,f])};a.addEventListener("message",c)})}render(e,t,i){this.hasFill_&&this.renderInternal_(e.polygonBuffers[0],e.polygonBuffers[1],this.fillProgram_,this.polygonAttributesDesc_,t,i),this.hasStroke_&&this.renderInternal_(e.lineStringBuffers[0],e.lineStringBuffers[1],this.strokeProgram_,this.lineStringAttributesDesc_,t,i),this.hasSymbol_&&this.renderInternal_(e.pointBuffers[0],e.pointBuffers[1],this.symbolProgram_,this.pointAttributesDesc_,t,i)}renderInternal_(e,t,i,n,s,o){const a=e.getSize();a!==0&&(this.helper_.useProgram(i,s),this.helper_.bindBuffer(t),this.helper_.bindBuffer(e),this.helper_.enableAttributes(n),o(),this.helper_.drawElements(0,a))}setHelper(e,t=null){this.helper_=e,this.hasFill_&&(this.fillProgram_=this.helper_.getProgram(this.fillFragmentShader_,this.fillVertexShader_)),this.hasStroke_&&(this.strokeProgram_=this.helper_.getProgram(this.strokeFragmentShader_,this.strokeVertexShader_)),this.hasSymbol_&&(this.symbolProgram_=this.helper_.getProgram(this.symbolFragmentShader_,this.symbolVertexShader_)),this.helper_.addUniforms(this.uniforms_),t&&(t.polygonBuffers&&(this.helper_.flushBufferData(t.polygonBuffers[0]),this.helper_.flushBufferData(t.polygonBuffers[1])),t.lineStringBuffers&&(this.helper_.flushBufferData(t.lineStringBuffers[0]),this.helper_.flushBufferData(t.lineStringBuffers[1])),t.pointBuffers&&(this.helper_.flushBufferData(t.pointBuffers[0]),this.helper_.flushBufferData(t.pointBuffers[1])))}}const ht=new Uint8Array(4);class $c{constructor(e,t){this.helper_=e;const i=e.getGL();this.texture_=i.createTexture(),this.framebuffer_=i.createFramebuffer(),this.depthbuffer_=i.createRenderbuffer(),this.size_=t||[1,1],this.data_=new Uint8Array(0),this.dataCacheDirty_=!0,this.updateSize_()}setSize(e){If(e,this.size_)||(this.size_[0]=e[0],this.size_[1]=e[1],this.updateSize_())}getSize(){return this.size_}clearCachedData(){this.dataCacheDirty_=!0}readAll(){if(this.dataCacheDirty_){const e=this.size_,t=this.helper_.getGL();t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.readPixels(0,0,e[0],e[1],t.RGBA,t.UNSIGNED_BYTE,this.data_),this.dataCacheDirty_=!1}return this.data_}readPixel(e,t){if(e<0||t<0||e>this.size_[0]||t>=this.size_[1])return ht[0]=0,ht[1]=0,ht[2]=0,ht[3]=0,ht;this.readAll();const i=Math.floor(e)+(this.size_[1]-Math.floor(t)-1)*this.size_[0];return ht[0]=this.data_[i*4],ht[1]=this.data_[i*4+1],ht[2]=this.data_[i*4+2],ht[3]=this.data_[i*4+3],ht}getTexture(){return this.texture_}getFramebuffer(){return this.framebuffer_}getDepthbuffer(){return this.depthbuffer_}updateSize_(){const e=this.size_,t=this.helper_.getGL();this.texture_=this.helper_.createTexture(e,null,this.texture_),t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer_),t.viewport(0,0,e[0],e[1]),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture_,0),t.bindRenderbuffer(t.RENDERBUFFER,this.depthbuffer_),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,e[0],e[1]),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,this.depthbuffer_),this.data_=new Uint8Array(e[0]*e[1]*4)}}function Vc(r,e){const t=r.viewState.projection,n=e.getSource().getWrapX()&&t.canWrapX(),s=t.getExtent(),o=r.extent,a=n?Fe(s):null,l=n?Math.ceil((o[2]-s[2])/a)+1:1;return[n?Math.floor((o[0]-s[0])/a):0,l,a]}const lr={...pt,RENDER_EXTENT:"u_renderExtent",PATTERN_ORIGIN:"u_patternOrigin",GLOBAL_ALPHA:"u_globalAlpha"};class Xc extends yi{constructor(e,t){const i={[lr.RENDER_EXTENT]:[0,0,0,0],[lr.PATTERN_ORIGIN]:[0,0],[lr.GLOBAL_ALPHA]:1};super(e,{uniforms:i,postProcesses:t.postProcesses}),this.hitDetectionEnabled_=!t.disableHitDetection,this.hitRenderTarget_,this.sourceRevision_=-1,this.previousExtent_=di(),this.currentTransform_=Ce(),this.tmpCoords_=[0,0],this.tmpTransform_=Ce(),this.tmpMat4_=rr(),this.currentFrameStateTransform_=Ce(),this.styleVariables_={},this.styles_=[],this.styleRenderers_=[],this.buffers_=[],this.applyOptions_(t),this.batch_=new cn,this.initialFeaturesAdded_=!1,this.sourceListenKeys_=null}addInitialFeatures_(e){const t=this.getLayer().getSource();let i;this.batch_.addFeatures(t.getFeatures(),i),this.sourceListenKeys_=[Rt(t,Dt.ADDFEATURE,this.handleSourceFeatureAdded_.bind(this,i)),Rt(t,Dt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),Rt(t,Dt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Rt(t,Dt.CLEAR,this.handleSourceFeatureClear_,this)]}applyOptions_(e){this.styleVariables_=e.variables,this.styles_=A_(e.style)}createRenderers_(){this.buffers_=[],this.styleRenderers_=this.styles_.map(e=>new C_(e,this.styleVariables_,this.helper,this.hitDetectionEnabled_,"filter"in e?e.filter:null))}reset(e){this.applyOptions_(e),this.helper&&this.createRenderers_(),super.reset(e)}afterHelperCreated(){this.styleRenderers_.length?this.styleRenderers_.forEach((e,t)=>e.setHelper(this.helper,this.buffers_[t])):this.createRenderers_(),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new $c(this.helper))}handleSourceFeatureAdded_(e,t){const i=t.feature;this.batch_.addFeature(i,e)}handleSourceFeatureChanged_(e){const t=e.feature;this.batch_.changeFeature(t)}handleSourceFeatureDelete_(e){const t=e.feature;this.batch_.removeFeature(t)}handleSourceFeatureClear_(){this.batch_.clear()}applyUniforms_(e){mf(this.tmpTransform_,this.currentFrameStateTransform_),ri(this.tmpTransform_,e),this.helper.setUniformMatrixValue(lr.PROJECTION_MATRIX,on(this.tmpMat4_,this.tmpTransform_)),ii(this.tmpTransform_,this.tmpTransform_),this.helper.setUniformMatrixValue(lr.SCREEN_TO_WORLD_MATRIX,on(this.tmpMat4_,this.tmpTransform_)),this.tmpCoords_[0]=0,this.tmpCoords_[1]=0,ii(this.tmpTransform_,e),It(this.tmpTransform_,this.tmpCoords_),this.helper.setUniformFloatVec2(lr.PATTERN_ORIGIN,this.tmpCoords_)}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[i,n,s]=Vc(e,this.getLayer());this.helper.prepareDraw(e),this.renderWorlds(e,!1,i,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent);const o=this.helper.getCanvas();return this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,i,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),o}prepareFrameInternal(e){this.initialFeaturesAdded_||(this.addInitialFeatures_(e),this.initialFeaturesAdded_=!0);const t=this.getLayer(),i=t.getSource(),n=e.viewState,s=!e.viewHints[$t.ANIMATING]&&!e.viewHints[$t.INTERACTING],o=!si(this.previousExtent_,e.extent),a=this.sourceRevision_<i.getRevision();if(a&&(this.sourceRevision_=i.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof wn?t.getRenderBuffer():0,h=eo(e.extent,u*c);i.loadFeatures(h,c,l),this.ready=!1;const f=this.helper.makeProjectionTransform(e,Ce()),g=this.styleRenderers_.map((d,p)=>d.generateBuffers(this.batch_,f).then(m=>{this.buffers_[p]&&this.disposeBuffers(this.buffers_[p]),this.buffers_[p]=m}));Promise.all(g).then(()=>{this.ready=!0,this.getLayer().changed()}),this.previousExtent_=e.extent.slice()}return!0}renderWorlds(e,t,i,n,s){let o=i;t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0));do{this.helper.makeProjectionTransform(e,this.currentFrameStateTransform_),qs(this.currentFrameStateTransform_,o*s,0);for(let a=0,l=this.styleRenderers_.length;a<l;a++){const c=this.styleRenderers_[a],u=this.buffers_[a];u&&c.render(u,e,()=>{this.applyUniforms_(u.invertVerticesTransform),this.helper.applyHitDetectionUniform(t)})}}while(++o<n)}forEachFeatureAtCoordinate(e,t,i,n,s){if(et(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.styleRenderers_.length||!this.hitDetectionEnabled_)return;const o=It(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=Gc(l),u=this.batch_.getFeatureFromRef(c);if(u)return n(u,this.getLayer(),null)}disposeBuffers(e){const t=i=>{for(const n of i)n&&this.helper.deleteBuffer(n)};e.pointBuffers&&t(e.pointBuffers),e.lineStringBuffers&&t(e.lineStringBuffers),e.polygonBuffers&&t(e.polygonBuffers)}disposeInternal(){this.buffers_.forEach(e=>{e&&this.disposeBuffers(e)}),this.sourceListenKeys_&&(this.sourceListenKeys_.forEach(function(e){rn(e)}),this.sourceListenKeys_=null),super.disposeInternal()}renderDeclutter(){}}const wt={BLUR:"blur",GRADIENT:"gradient",RADIUS:"radius"},F_=["#00f","#0ff","#0f0","#ff0","#f00"];class O_ extends wn{constructor(e){e=e||{};const t=Object.assign({},e);delete t.gradient,delete t.radius,delete t.blur,delete t.weight,super(t),this.filter_=e.filter??!0,this.styleVariables_=e.variables||{},this.gradient_=null,this.addChangeListener(wt.GRADIENT,this.handleGradientChanged_),this.setGradient(e.gradient?e.gradient:F_),this.setBlur(e.blur!==void 0?e.blur:15),this.setRadius(e.radius!==void 0?e.radius:8);const i=e.weight?e.weight:"weight";this.weight_=i,this.setRenderOrder(null)}getBlur(){return this.get(wt.BLUR)}getGradient(){return this.get(wt.GRADIENT)}getRadius(){return this.get(wt.RADIUS)}handleGradientChanged_(){this.gradient_=M_(this.getGradient())}setBlur(e){const t=this.get(wt.BLUR);if(this.set(wt.BLUR,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setGradient(e){this.set(wt.GRADIENT,e)}setRadius(e){const t=this.get(wt.RADIUS);if(this.set(wt.RADIUS,e),typeof e=="number"&&typeof t=="number"){this.changed();return}this.clearRenderer()}setFilter(e){this.filter_=e,this.changed(),this.clearRenderer()}setWeight(e){this.weight_=e,this.changed(),this.clearRenderer()}createRenderer(){const e=new Oc,t=_o(),i=X(t,this.filter_,Tn);let n=X(t,this.getRadius(),oe),s=X(t,this.getBlur(),oe);const o={};typeof this.getBlur()=="number"&&(s="a_blur",o.a_blur=()=>this.getBlur(),e.addUniform("float a_blur")),typeof this.getRadius()=="number"&&(n="a_radius",o.a_radius=()=>this.getRadius(),e.addUniform("float a_radius"));const a={};let l=null;if(typeof this.weight_=="string"||typeof this.weight_=="function"){const h=typeof this.weight_=="string"?f=>f.get(this.weight_):this.weight_;a.prop_weight={size:1,callback:f=>{const g=h(f);return g!==void 0?Ee(g,0,1):1}},l="a_prop_weight",e.addAttribute("a_prop_weight","float")}else{const h=["clamp",this.weight_,0,1];l=X(t,h,oe)}e.addFragmentShaderFunction(`float getBlurSlope() {
  float blur = max(1., ${s});
  float radius = ${n};
  return radius / blur;
}`).setSymbolSizeExpression(`vec2(${n} + ${s}) * 2.`).setSymbolColorExpression(`vec4(smoothstep(0., 1., (1. - length(coordsPx * 2. / v_quadSizePx)) * getBlurSlope()) * ${l})`).setStrokeColorExpression(`vec4(smoothstep(0., 1., (1. - length(currentRadiusPx * 2. / v_width)) * getBlurSlope()) * ${l})`).setStrokeWidthExpression(`(${n} + ${s}) * 2.`).setFillColorExpression(`vec4(${l})`).setFragmentDiscardExpression(`!${i}`),Mc(e,t);const c=Dc(t),u=Nc(t,this.styleVariables_);return new Xc(this,{className:this.getClassName(),variables:this.styleVariables_,style:{builder:e,attributes:{...c,...a},uniforms:{...u,...o}},disableHitDetection:!1,postProcesses:[{fragmentShader:`
            precision mediump float;

            uniform sampler2D u_image;
            uniform sampler2D u_gradientTexture;
            uniform float u_opacity;

            varying vec2 v_texCoord;

            void main() {
              vec4 color = texture2D(u_image, v_texCoord);
              gl_FragColor.a = color.a * u_opacity;
              gl_FragColor.rgb = texture2D(u_gradientTexture, vec2(0.5, color.a)).rgb;
              gl_FragColor.rgb *= gl_FragColor.a;
            }`,uniforms:{u_gradientTexture:()=>this.gradient_,u_opacity:()=>this.getOpacity()}}]})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}renderDeclutter(){}}function M_(r){const i=zt(1,256),n=i.createLinearGradient(0,0,1,256),s=1/(r.length-1);for(let o=0,a=r.length;o<a;++o)n.addColorStop(o*s,r[o]);return i.fillStyle=n,i.fillRect(0,0,1,256),i.canvas}class So extends Wl{constructor(e,t,i,n,s){const o=s!==void 0?Yt.IDLE:Yt.LOADED;super(e,t,i,o),this.loader_=s!==void 0?s:null,this.canvas_=n,this.error_=null}getError(){return this.error_}handleLoad_(e){e?(this.error_=e,this.state=Yt.ERROR):this.state=Yt.LOADED,this.changed()}load(){this.state==Yt.IDLE&&(this.state=Yt.LOADING,this.changed(),this.loader_(this.handleLoad_.bind(this)))}getImage(){return this.canvas_}}class N_ extends Rh{constructor(e){super(e),this.vectorRenderer_=new Ah(e),this.layerImageRatio_=e.getImageRatio(),this.coordinateToVectorPixelTransform_=Ce(),this.renderedPixelToCoordinateTransform_=null}disposeInternal(){this.vectorRenderer_.dispose(),super.disposeInternal()}getFeatures(e){if(!this.vectorRenderer_)return Promise.resolve([]);const t=It(this.coordinateToVectorPixelTransform_,It(this.renderedPixelToCoordinateTransform_,e.slice()));return this.vectorRenderer_.getFeatures(t)}handleFontsChanged(){this.vectorRenderer_.handleFontsChanged()}prepareFrame(e){const t=e.pixelRatio,i=e.viewState,n=i.resolution,s=e.viewHints,o=this.vectorRenderer_;let a=e.extent;this.layerImageRatio_!==1&&(a=a.slice(0),ic(a,this.layerImageRatio_));const l=Fe(a)/n,c=ot(a)/n;if(!s[$t.ANIMATING]&&!s[$t.INTERACTING]&&!An(a)){o.useContainer(null,null);const u=o.context,h=e.layerStatesArray[e.layerIndex],f=Object.assign({},h,{opacity:1}),g=Object.assign({},e,{extent:a,size:[l,c],viewState:Object.assign({},e.viewState,{rotation:0}),layerStatesArray:[f],layerIndex:0,declutter:null}),d=this.getLayer().getDeclutter();d&&(g.declutter={[d]:new Ph(9)});const p=new So(a,n,t,u.canvas,function(m){o.prepareFrame(g)&&o.replayGroupChanged&&(o.clipping=!1,o.renderFrame(g,null),o.renderDeclutter(g),o.renderDeferred(g),m())});p.addEventListener(ze.CHANGE,()=>{if(p.getState()!==Yt.LOADED)return;this.image=p;const m=p.getPixelRatio(),y=Lh(p.getResolution())*t/m;this.renderedResolution=y,this.coordinateToVectorPixelTransform_=Ys(this.coordinateToVectorPixelTransform_,l/2,c/2,1/y,-1/y,0,-i.center[0],-i.center[1])}),p.load()}return this.image&&(this.renderedPixelToCoordinateTransform_=e.pixelToCoordinateTransform.slice()),!this.getLayer().getSource().loading&&!!this.image}preRender(){}postRender(){}renderDeclutter(){}forEachFeatureAtCoordinate(e,t,i,n,s){return this.vectorRenderer_?this.vectorRenderer_.forEachFeatureAtCoordinate(e,t,i,n,s):super.forEachFeatureAtCoordinate(e,t,i,n,s)}}class D_ extends wn{constructor(e){e=e||{};const t=Object.assign({},e);delete t.imageRatio,super(t),this.imageRatio_=e.imageRatio!==void 0?e.imageRatio:1}getImageRatio(){return this.imageRatio_}createRenderer(){return new N_(this)}}class U_ extends yi{constructor(e,t){const i=t.uniforms||{},n=Ce();i[pt.PROJECTION_MATRIX]=n,super(e,{uniforms:i,postProcesses:t.postProcesses}),this.sourceRevision_=-1,this.verticesBuffer_=new Tr(mi,an),this.indicesBuffer_=new Tr(_i,an),this.vertexShader_=t.vertexShader,this.fragmentShader_=t.fragmentShader,this.program_,this.hitDetectionEnabled_=t.hitDetectionEnabled??!0;const s=t.attributes?t.attributes.map(function(a){return{name:"a_"+a.name,size:1,type:Se.FLOAT}}):[];this.attributes=[{name:"a_position",size:2,type:Se.FLOAT},{name:"a_index",size:1,type:Se.FLOAT}],this.hitDetectionEnabled_&&(this.attributes.push({name:"a_hitColor",size:4,type:Se.FLOAT}),this.attributes.push({name:"a_featureUid",size:1,type:Se.FLOAT})),this.attributes.push(...s),this.customAttributes=t.attributes?t.attributes:[],this.previousExtent_=di(),this.currentTransform_=n,this.renderTransform_=Ce(),this.invertRenderTransform_=Ce(),this.renderInstructions_=new Float32Array(0),this.hitRenderTarget_,this.lastSentId=0,this.worker_=Uc(),this.worker_.addEventListener("message",a=>{const l=a.data;if(l.type===Zr.GENERATE_POINT_BUFFERS){const c=l.projectionTransform;this.verticesBuffer_.fromArrayBuffer(l.vertexBuffer),this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.fromArrayBuffer(l.indexBuffer),this.helper.flushBufferData(this.indicesBuffer_),this.renderTransform_=c,ii(this.invertRenderTransform_,this.renderTransform_),this.renderInstructions_=new Float32Array(a.data.renderInstructions),l.id===this.lastSentId&&(this.ready=!0),this.getLayer().changed()}}),this.featureCache_={},this.featureCount_=0;const o=this.getLayer().getSource();this.sourceListenKeys_=[Rt(o,Dt.ADDFEATURE,this.handleSourceFeatureAdded_,this),Rt(o,Dt.CHANGEFEATURE,this.handleSourceFeatureChanged_,this),Rt(o,Dt.REMOVEFEATURE,this.handleSourceFeatureDelete_,this),Rt(o,Dt.CLEAR,this.handleSourceFeatureClear_,this)],o.forEachFeature(a=>{const l=a.getGeometry();l&&l.getType()==="Point"&&(this.featureCache_[he(a)]={feature:a,properties:a.getProperties(),flatCoordinates:l.getFlatCoordinates()},this.featureCount_++)})}afterHelperCreated(){this.program_=this.helper.getProgram(this.fragmentShader_,this.vertexShader_),this.hitDetectionEnabled_&&(this.hitRenderTarget_=new $c(this.helper)),this.verticesBuffer_.getArray()&&this.helper.flushBufferData(this.verticesBuffer_),this.indicesBuffer_.getArray()&&this.helper.flushBufferData(this.indicesBuffer_)}handleSourceFeatureAdded_(e){const t=e.feature,i=t.getGeometry();i&&i.getType()==="Point"&&(this.featureCache_[he(t)]={feature:t,properties:t.getProperties(),flatCoordinates:i.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureChanged_(e){const t=e.feature,i=he(t),n=this.featureCache_[i],s=t.getGeometry();n?s&&s.getType()==="Point"?(n.properties=t.getProperties(),n.flatCoordinates=s.getFlatCoordinates()):(delete this.featureCache_[i],this.featureCount_--):s&&s.getType()==="Point"&&(this.featureCache_[i]={feature:t,properties:t.getProperties(),flatCoordinates:s.getFlatCoordinates()},this.featureCount_++)}handleSourceFeatureDelete_(e){const t=e.feature,i=he(t);i in this.featureCache_&&(delete this.featureCache_[i],this.featureCount_--)}handleSourceFeatureClear_(){this.featureCache_={},this.featureCount_=0}renderFrame(e){const t=this.helper.getGL();this.preRender(t,e);const[i,n,s]=Vc(e,this.getLayer());return this.renderWorlds(e,!1,i,n,s),this.helper.finalizeDraw(e,this.dispatchPreComposeEvent,this.dispatchPostComposeEvent),this.hitDetectionEnabled_&&(this.renderWorlds(e,!0,i,n,s),this.hitRenderTarget_.clearCachedData()),this.postRender(t,e),this.helper.getCanvas()}prepareFrameInternal(e){const t=this.getLayer(),i=t.getSource(),n=e.viewState,s=!e.viewHints[$t.ANIMATING]&&!e.viewHints[$t.INTERACTING],o=!si(this.previousExtent_,e.extent),a=this.sourceRevision_<i.getRevision();if(a&&(this.sourceRevision_=i.getRevision()),s&&(o||a)){const l=n.projection,c=n.resolution,u=t instanceof wn?t.getRenderBuffer():0,h=eo(e.extent,u*c);i.loadFeatures(h,c,l),this.rebuildBuffers_(e),this.previousExtent_=e.extent.slice()}return this.helper.useProgram(this.program_,e),this.helper.prepareDraw(e),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes),!0}rebuildBuffers_(e){const t=Ce();this.helper.makeProjectionTransform(e,t);const n=(this.hitDetectionEnabled_?7:2)+this.customAttributes.length,s=n*this.featureCount_,o=this.renderInstructions_&&this.renderInstructions_.length===s?this.renderInstructions_:new Float32Array(s);this.renderInstructions_=null;let a=[];const l=[];let c=-1;e.viewState.projection;for(const h in this.featureCache_){const f=this.featureCache_[h];if(a[0]=f.flatCoordinates[0],a[1]=f.flatCoordinates[1],It(t,a),o[++c]=a[0],o[++c]=a[1],this.hitDetectionEnabled_){const g=Bc(c+5,l);o[++c]=g[0],o[++c]=g[1],o[++c]=g[2],o[++c]=g[3],o[++c]=Number(h)}for(let g=0;g<this.customAttributes.length;g++){const d=this.customAttributes[g].callback(f.feature,f.properties);o[++c]=d}}const u={id:++this.lastSentId,type:Zr.GENERATE_POINT_BUFFERS,renderInstructions:o.buffer,customAttributesSize:n-2};u.projectionTransform=t,this.ready=!1,this.worker_.postMessage(u,[o.buffer])}forEachFeatureAtCoordinate(e,t,i,n,s){if(et(this.hitDetectionEnabled_,"`forEachFeatureAtCoordinate` cannot be used on a WebGL layer if the hit detection logic has been disabled using the `disableHitDetection: true` option."),!this.renderInstructions_||!this.hitDetectionEnabled_)return;const o=It(t.coordinateToPixelTransform,e.slice()),a=this.hitRenderTarget_.readPixel(o[0]/2,o[1]/2),l=[a[0]/255,a[1]/255,a[2]/255,a[3]/255],c=Gc(l),u=this.renderInstructions_[c],h=Math.floor(u).toString(),g=this.getLayer().getSource().getFeatureByUid(h);if(g)return n(g,this.getLayer(),null)}renderWorlds(e,t,i,n,s){let o=i;this.helper.useProgram(this.program_,e),t&&(this.hitRenderTarget_.setSize([Math.floor(e.size[0]/2),Math.floor(e.size[1]/2)]),this.helper.prepareDrawToRenderTarget(e,this.hitRenderTarget_,!0)),this.helper.bindBuffer(this.verticesBuffer_),this.helper.bindBuffer(this.indicesBuffer_),this.helper.enableAttributes(this.attributes);do{this.helper.makeProjectionTransform(e,this.currentTransform_),qs(this.currentTransform_,o*s,0),ri(this.currentTransform_,this.invertRenderTransform_),this.helper.applyUniforms(e),this.helper.applyHitDetectionUniform(t);const a=this.indicesBuffer_.getSize();this.helper.drawElements(0,a)}while(++o<n)}disposeInternal(){this.worker_.terminate(),this.sourceListenKeys_.forEach(function(e){rn(e)}),this.sourceListenKeys_=null,super.disposeInternal()}renderDeclutter(){}}class B_ extends ks{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.parseResult_=kc(e.style,this.styleVariables_,e.filter),this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){const e=Object.keys(this.parseResult_.attributes).map(t=>({name:t,...this.parseResult_.attributes[t]}));return new U_(this,{vertexShader:this.parseResult_.builder.getSymbolVertexShader(),fragmentShader:this.parseResult_.builder.getSymbolFragmentShader(),hitDetectionEnabled:!this.hitDetectionDisabled_,uniforms:this.parseResult_.uniforms,attributes:e})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}function nl(r,e){const t=`
    attribute vec2 ${$i.TEXTURE_COORD};
    uniform mat4 ${j.TILE_TRANSFORM};
    uniform float ${j.TEXTURE_PIXEL_WIDTH};
    uniform float ${j.TEXTURE_PIXEL_HEIGHT};
    uniform float ${j.TEXTURE_RESOLUTION};
    uniform float ${j.TEXTURE_ORIGIN_X};
    uniform float ${j.TEXTURE_ORIGIN_Y};
    uniform float ${j.DEPTH};

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;

    void main() {
      v_textureCoord = ${$i.TEXTURE_COORD};
      v_mapCoord = vec2(
        ${j.TEXTURE_ORIGIN_X} + ${j.TEXTURE_RESOLUTION} * ${j.TEXTURE_PIXEL_WIDTH} * v_textureCoord[0],
        ${j.TEXTURE_ORIGIN_Y} - ${j.TEXTURE_RESOLUTION} * ${j.TEXTURE_PIXEL_HEIGHT} * v_textureCoord[1]
      );
      gl_Position = ${j.TILE_TRANSFORM} * vec4(${$i.TEXTURE_COORD}, ${j.DEPTH}, 1.0);
    }
  `,i={..._o(),bandCount:e},n=[];if(r.color!==void 0){const h=X(i,r.color,We);n.push(`color = ${h};`)}if(r.contrast!==void 0){const h=X(i,r.contrast,oe);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb - (${h} / 2.0), vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.exposure!==void 0){const h=X(i,r.exposure,oe);n.push(`color.rgb = clamp((${h} + 1.0) * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}if(r.saturation!==void 0){const h=X(i,r.saturation,oe);n.push(`
      float saturation = ${h} + 1.0;
      float sr = (1.0 - saturation) * 0.2126;
      float sg = (1.0 - saturation) * 0.7152;
      float sb = (1.0 - saturation) * 0.0722;
      mat3 saturationMatrix = mat3(
        sr + saturation, sr, sr,
        sg, sg + saturation, sg,
        sb, sb, sb + saturation
      );
      color.rgb = clamp(saturationMatrix * color.rgb, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));
    `)}if(r.gamma!==void 0){const h=X(i,r.gamma,oe);n.push(`color.rgb = pow(color.rgb, vec3(1.0 / ${h}));`)}if(r.brightness!==void 0){const h=X(i,r.brightness,oe);n.push(`color.rgb = clamp(color.rgb + ${h}, vec3(0.0, 0.0, 0.0), vec3(1.0, 1.0, 1.0));`)}const s={},o=Object.keys(i.variables).length;if(o>1&&!r.variables)throw new Error(`Missing variables in style (expected ${i.variables})`);for(let h=0;h<o;++h){const f=i.variables[Object.keys(i.variables)[h]];if(!(f.name in r.variables))throw new Error(`Missing '${f.name}' in style variables`);const g=On(f.name);s[g]=function(){let d=r.variables[f.name];return typeof d=="string"&&(d=wr(d)),d!==void 0?d:-9999999}}const a=Object.keys(s).map(function(h){return`uniform float ${h};`}),l=Math.ceil(e/4);a.push(`uniform sampler2D ${j.TILE_TEXTURE_ARRAY}[${l}];`),i.paletteTextures&&a.push(`uniform sampler2D ${Ic}[${i.paletteTextures.length}];`);const c=Object.keys(i.functions).map(function(h){return i.functions[h]}),u=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
    precision highp float;
    #else
    precision mediump float;
    #endif

    varying vec2 v_textureCoord;
    varying vec2 v_mapCoord;
    uniform vec4 ${j.RENDER_EXTENT};
    uniform float ${j.TRANSITION_ALPHA};
    uniform float ${j.TEXTURE_PIXEL_WIDTH};
    uniform float ${j.TEXTURE_PIXEL_HEIGHT};
    uniform float ${j.RESOLUTION};
    uniform float ${j.ZOOM};

    ${a.join(`
`)}

    ${c.join(`
`)}

    void main() {
      if (
        v_mapCoord[0] < ${j.RENDER_EXTENT}[0] ||
        v_mapCoord[1] < ${j.RENDER_EXTENT}[1] ||
        v_mapCoord[0] > ${j.RENDER_EXTENT}[2] ||
        v_mapCoord[1] > ${j.RENDER_EXTENT}[3]
      ) {
        discard;
      }

      vec4 color = texture2D(${j.TILE_TEXTURE_ARRAY}[0],  v_textureCoord);

      ${n.join(`
`)}

      gl_FragColor = color;
      gl_FragColor.rgb *= gl_FragColor.a;
      gl_FragColor *= ${j.TRANSITION_ALPHA};
    }`;return{vertexShader:t,fragmentShader:u,uniforms:s,paletteTextures:i.paletteTextures}}class hn extends Ih{constructor(e){e=e?Object.assign({},e):{};const t=e.style||{};delete e.style,super(e),this.sources_=e.sources,this.renderedSource_=null,this.renderedResolution_=NaN,this.style_=t,this.styleVariables_=this.style_.variables||{},this.handleSourceUpdate_(),this.addChangeListener(gs.SOURCE,this.handleSourceUpdate_)}getSources(e,t){const i=this.getSource();return this.sources_?typeof this.sources_=="function"?this.sources_(e,t):this.sources_:i?[i]:[]}getRenderSource(){return this.renderedSource_||this.getSource()}getSourceState(){const e=this.getRenderSource();return e?e.getState():"undefined"}handleSourceUpdate_(){this.hasRenderer()&&this.getRenderer().clearCache();const e=this.getSource();if(e)if(e.getState()==="loading"){const t=()=>{e.getState()==="ready"&&(e.removeEventListener("change",t),this.setStyle(this.style_))};e.addEventListener("change",t)}else this.setStyle(this.style_)}getSourceBandCount_(){const e=Number.MAX_SAFE_INTEGER,t=this.getSources([-e,-e,e,e],e);return t&&t.length&&"bandCount"in t[0]?t[0].bandCount:4}createRenderer(){const e=nl(this.style_,this.getSourceBandCount_());return new a_(this,{vertexShader:e.vertexShader,fragmentShader:e.fragmentShader,uniforms:e.uniforms,cacheSize:this.getCacheSize(),paletteTextures:e.paletteTextures})}renderSources(e,t){const i=this.getRenderer();let n;for(let s=0,o=t.length;s<o;++s)this.renderedSource_=t[s],i.prepareFrame(e)&&(n=i.renderFrame(e));return n}render(e,t){this.rendered=!0;const i=e.viewState,n=this.getSources(e.extent,i.resolution);let s=!0;for(let a=0,l=n.length;a<l;++a){const c=n[a],u=c.getState();if(u=="loading"){const h=()=>{c.getState()=="ready"&&(c.removeEventListener("change",h),this.changed())};c.addEventListener("change",h)}s=s&&u=="ready"}const o=this.renderSources(e,n);if(this.getRenderer().renderComplete&&s)return this.renderedResolution_=i.resolution,o;if(this.renderedResolution_>.5*i.resolution){const a=this.getSources(e.extent,this.renderedResolution_).filter(l=>!n.includes(l));if(a.length>0)return this.renderSources(e,a)}return o}setStyle(e){if(this.styleVariables_=e.variables||{},this.style_=e,this.hasRenderer()){const t=nl(this.style_,this.getSourceBandCount_());this.getRenderer().reset({vertexShader:t.vertexShader,fragmentShader:t.fragmentShader,uniforms:t.uniforms,paletteTextures:t.paletteTextures}),this.changed()}}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}}hn.prototype.dispose;class G_ extends ks{constructor(e){const t=Object.assign({},e);super(t),this.styleVariables_=e.variables||{},this.style_=e.style,this.hitDetectionDisabled_=!!e.disableHitDetection}createRenderer(){return new Xc(this,{style:this.style_,variables:this.styleVariables_,disableHitDetection:this.hitDetectionDisabled_})}updateStyleVariables(e){Object.assign(this.styleVariables_,e),this.changed()}setStyle(e){this.style_=e,this.clearRenderer(),this.changed()}}var Ge=(r,e,t)=>new Promise((i,n)=>{var s=l=>{try{a(t.next(l))}catch(c){n(c)}},o=l=>{try{a(t.throw(l))}catch(c){n(c)}},a=l=>l.done?i(l.value):Promise.resolve(l.value).then(s,o);a((t=t.apply(r,e)).next())}),Ze=Uint8Array,Yr=Uint16Array,z_=Int32Array,Wc=new Ze([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),jc=new Ze([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),k_=new Ze([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Hc=function(r,e){for(var t=new Yr(31),i=0;i<31;++i)t[i]=e+=1<<r[i-1];for(var n=new z_(t[30]),i=1;i<30;++i)for(var s=t[i];s<t[i+1];++s)n[s]=s-t[i]<<5|i;return{b:t,r:n}},Zc=Hc(Wc,2),Yc=Zc.b,$_=Zc.r;Yc[28]=258,$_[258]=28;var V_=Hc(jc,0),X_=V_.b,qc=new Yr(32768);for(de=0;de<32768;++de)St=(de&43690)>>1|(de&21845)<<1,St=(St&52428)>>2|(St&13107)<<2,St=(St&61680)>>4|(St&3855)<<4,qc[de]=((St&65280)>>8|(St&255)<<8)>>1;var St,de,qr=function(r,e,t){for(var i=r.length,n=0,s=new Yr(e);n<i;++n)r[n]&&++s[r[n]-1];var o=new Yr(e);for(n=1;n<e;++n)o[n]=o[n-1]+s[n-1]<<1;var a;{a=new Yr(1<<e);var l=15-e;for(n=0;n<i;++n)if(r[n])for(var c=n<<4|r[n],u=e-r[n],h=o[r[n]-1]++<<u,f=h|(1<<u)-1;h<=f;++h)a[qc[h]>>l]=c}return a},xi=new Ze(288);for(de=0;de<144;++de)xi[de]=8;var de;for(de=144;de<256;++de)xi[de]=9;var de;for(de=256;de<280;++de)xi[de]=7;var de;for(de=280;de<288;++de)xi[de]=8;var de,Kc=new Ze(32);for(de=0;de<32;++de)Kc[de]=5;var de,W_=qr(xi,9),j_=qr(Kc,5),Yn=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},tt=function(r,e,t){var i=e/8|0;return(r[i]|r[i+1]<<8)>>(e&7)&t},qn=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},H_=function(r){return(r+7)/8|0},Z_=function(r,e,t){(t==null||t>r.length)&&(t=r.length);var i=new Ze(t-e);return i.set(r.subarray(e,t)),i},Y_=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],He=function(r,e,t){var i=new Error(e||Y_[r]);if(i.code=r,Error.captureStackTrace&&Error.captureStackTrace(i,He),!t)throw i;return i},vo=function(r,e,t,i){var n=r.length,s=0;if(!n||e.f&&!e.l)return t||new Ze(0);var o=!t||e.i!=2,a=e.i;t||(t=new Ze(n*3));var l=function(Tt){var Ai=t.length;if(Tt>Ai){var Pi=new Ze(Math.max(Ai*2,Tt));Pi.set(t),t=Pi}},c=e.f||0,u=e.p||0,h=e.b||0,f=e.l,g=e.d,d=e.m,p=e.n,m=n*8;do{if(!f){c=tt(r,u,1);var y=tt(r,u+1,3);if(u+=3,y)if(y==1)f=W_,g=j_,d=9,p=5;else if(y==2){var v=tt(r,u,31)+257,w=tt(r,u+10,15)+4,A=v+tt(r,u+5,31)+1;u+=14;for(var C=new Ze(A),P=new Ze(19),R=0;R<w;++R)P[k_[R]]=tt(r,u+R*3,7);u+=w*3;for(var U=Yn(P),M=(1<<U)-1,z=qr(P,U),R=0;R<A;){var N=z[tt(r,u,M)];u+=N&15;var _=N>>4;if(_<16)C[R++]=_;else{var G=0,ie=0;for(_==16?(ie=3+tt(r,u,3),u+=2,G=C[R-1]):_==17?(ie=3+tt(r,u,7),u+=3):_==18&&(ie=11+tt(r,u,127),u+=7);ie--;)C[R++]=G}}var W=C.subarray(0,v),q=C.subarray(v);d=Yn(W),p=Yn(q),f=qr(W,d),g=qr(q,p)}else He(1);else{var _=H_(u)+4,E=r[_-4]|r[_-3]<<8,S=_+E;if(S>n){a&&He(0);break}o&&l(h+E),t.set(r.subarray(_,S),h),e.b=h+=E,e.p=u=S*8,e.f=c;continue}if(u>m){a&&He(0);break}}o&&l(h+131072);for(var ne=(1<<d)-1,ae=(1<<p)-1,pe=u;;pe=u){var G=f[qn(r,u)&ne],be=G>>4;if(u+=G&15,u>m){a&&He(0);break}if(G||He(2),be<256)t[h++]=be;else if(be==256){pe=u,f=null;break}else{var me=be-254;if(be>264){var R=be-257,we=Wc[R];me=tt(r,u,(1<<we)-1)+Yc[R],u+=we}var Le=g[qn(r,u)&ae],Ae=Le>>4;Le||He(3),u+=Le&15;var q=X_[Ae];if(Ae>3){var we=jc[Ae];q+=qn(r,u)&(1<<we)-1,u+=we}if(u>m){a&&He(0);break}o&&l(h+131072);var Me=h+me;if(h<q){var ir=s-q,nr=Math.min(q,Me);for(ir+h<0&&He(3);h<nr;++h)t[h]=i[ir+h]}for(;h<Me;h+=4)t[h]=t[h-q],t[h+1]=t[h+1-q],t[h+2]=t[h+2-q],t[h+3]=t[h+3-q];h=Me}}e.l=f,e.p=pe,e.b=h,e.f=c,f&&(c=1,e.m=d,e.d=g,e.n=p)}while(!c);return h==t.length?t:Z_(t,0,h)},q_=new Ze(0),K_=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&He(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=(r[10]|r[11]<<8)+2);for(var i=(e>>3&1)+(e>>4&1);i>0;i-=!r[t++]);return t+(e&2)},J_=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Q_=function(r,e){return((r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31)&&He(6,"invalid zlib data"),(r[1]>>5&1)==1&&He(6,"invalid zlib data: "+(r[1]&32?"need":"unexpected")+" dictionary"),(r[1]>>3&4)+2};function ey(r,e){return vo(r,{i:2},e,e)}function ty(r,e){var t=K_(r);return t+8>r.length&&He(6,"invalid gzip data"),vo(r.subarray(t,-8),{i:2},new Ze(J_(r)),e)}function ry(r,e){return vo(r.subarray(Q_(r),-4),{i:2},e,e)}function Ss(r,e){return r[0]==31&&r[1]==139&&r[2]==8?ty(r,e):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?ey(r,e):ry(r,e)}var iy=typeof TextDecoder<"u"&&new TextDecoder,ny=0;try{iy.decode(q_,{stream:!0}),ny=1}catch{}var Jc=(r,e)=>r*Math.pow(2,e),Gr=(r,e)=>Math.floor(r/Math.pow(2,e)),fn=(r,e)=>Jc(r.getUint16(e+1,!0),8)+r.getUint8(e),Qc=(r,e)=>Jc(r.getUint32(e+2,!0),16)+r.getUint16(e,!0),sy=(r,e,t,i,n)=>{if(r!=i.getUint8(n))return r-i.getUint8(n);const s=fn(i,n+1);if(e!=s)return e-s;const o=fn(i,n+4);return t!=o?t-o:0},oy=(r,e,t,i)=>{const n=eu(r,e|128,t,i);return n?{z:e,x:t,y:i,offset:n[0],length:n[1],is_dir:!0}:null},sl=(r,e,t,i)=>{const n=eu(r,e,t,i);return n?{z:e,x:t,y:i,offset:n[0],length:n[1],is_dir:!1}:null},eu=(r,e,t,i)=>{let n=0,s=r.byteLength/17-1;for(;n<=s;){const o=s+n>>1,a=sy(e,t,i,r,o*17);if(a>0)n=o+1;else if(a<0)s=o-1;else return[Qc(r,o*17+7),r.getUint32(o*17+13,!0)]}return null},ay=(r,e)=>r.is_dir&&!e.is_dir?1:!r.is_dir&&e.is_dir?-1:r.z!==e.z?r.z-e.z:r.x!==e.x?r.x-e.x:r.y-e.y,tu=(r,e)=>{const t=r.getUint8(e*17);return{z:t&127,x:fn(r,e*17+1),y:fn(r,e*17+4),offset:Qc(r,e*17+7),length:r.getUint32(e*17+13,!0),is_dir:t>>7===1}},ol=r=>{const e=[],t=new DataView(r);for(let i=0;i<t.byteLength/17;i++)e.push(tu(t,i));return ly(e)},ly=r=>{r.sort(ay);const e=new ArrayBuffer(17*r.length),t=new Uint8Array(e);for(let i=0;i<r.length;i++){const n=r[i];let s=n.z;n.is_dir&&(s=s|128),t[i*17]=s,t[i*17+1]=n.x&255,t[i*17+2]=n.x>>8&255,t[i*17+3]=n.x>>16&255,t[i*17+4]=n.y&255,t[i*17+5]=n.y>>8&255,t[i*17+6]=n.y>>16&255,t[i*17+7]=n.offset&255,t[i*17+8]=Gr(n.offset,8)&255,t[i*17+9]=Gr(n.offset,16)&255,t[i*17+10]=Gr(n.offset,24)&255,t[i*17+11]=Gr(n.offset,32)&255,t[i*17+12]=Gr(n.offset,48)&255,t[i*17+13]=n.length&255,t[i*17+14]=n.length>>8&255,t[i*17+15]=n.length>>16&255,t[i*17+16]=n.length>>24&255}return e},cy=(r,e)=>{if(r.byteLength<17)return null;const t=r.byteLength/17,i=tu(r,t-1);if(i.is_dir){const n=i.z,s=e.z-n,o=Math.trunc(e.x/(1<<s)),a=Math.trunc(e.y/(1<<s));return{z:n,x:o,y:a}}return null};function uy(r){return Ge(this,null,function*(){const e=yield r.getBytes(0,512e3),t=new DataView(e.data),i=t.getUint32(4,!0),n=t.getUint16(8,!0),s=new TextDecoder("utf-8"),o=JSON.parse(s.decode(new DataView(e.data,10,i)));let a=0;o.compression==="gzip"&&(a=2);let l=0;"minzoom"in o&&(l=+o.minzoom);let c=0;"maxzoom"in o&&(c=+o.maxzoom);let u=0,h=0,f=0,g=-180,d=-85,p=180,m=85;if(o.bounds){const _=o.bounds.split(",");g=+_[0],d=+_[1],p=+_[2],m=+_[3]}if(o.center){const _=o.center.split(",");u=+_[0],h=+_[1],f=+_[2]}return{specVersion:t.getUint16(2,!0),rootDirectoryOffset:10+i,rootDirectoryLength:n*17,jsonMetadataOffset:10,jsonMetadataLength:i,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:a,tileType:1,minZoom:l,maxZoom:c,minLon:g,minLat:d,maxLon:p,maxLat:m,centerZoom:f,centerLon:u,centerLat:h,etag:e.etag}})}function hy(r,e,t,i,n,s,o){return Ge(this,null,function*(){let a=yield t.getArrayBuffer(e,r.rootDirectoryOffset,r.rootDirectoryLength,r);r.specVersion===1&&(a=ol(a));const l=sl(new DataView(a),i,n,s);if(l){let h=(yield e.getBytes(l.offset,l.length,o)).data;const f=new DataView(h);return f.getUint8(0)==31&&f.getUint8(1)==139&&(h=Ss(new Uint8Array(h))),{data:h}}const c=cy(new DataView(a),{z:i,x:n,y:s});if(c){const u=oy(new DataView(a),c.z,c.x,c.y);if(u){let h=yield t.getArrayBuffer(e,u.offset,u.length,r);r.specVersion===1&&(h=ol(h));const f=sl(new DataView(h),i,n,s);if(f){let d=(yield e.getBytes(f.offset,f.length,o)).data;const p=new DataView(d);return p.getUint8(0)==31&&p.getUint8(1)==139&&(d=Ss(new Uint8Array(d))),{data:d}}}}})}var ru={getHeader:uy,getZxy:hy};function cr(r,e){return(e>>>0)*4294967296+(r>>>0)}function fy(r,e){const t=e.buf;let i,n;if(n=t[e.pos++],i=(n&112)>>4,n<128||(n=t[e.pos++],i|=(n&127)<<3,n<128)||(n=t[e.pos++],i|=(n&127)<<10,n<128)||(n=t[e.pos++],i|=(n&127)<<17,n<128)||(n=t[e.pos++],i|=(n&127)<<24,n<128)||(n=t[e.pos++],i|=(n&1)<<31,n<128))return cr(r,i);throw new Error("Expected varint not more than 10 bytes")}function zr(r){const e=r.buf;let t,i;return i=e[r.pos++],t=i&127,i<128||(i=e[r.pos++],t|=(i&127)<<7,i<128)||(i=e[r.pos++],t|=(i&127)<<14,i<128)||(i=e[r.pos++],t|=(i&127)<<21,i<128)?t:(i=e[r.pos],t|=(i&15)<<28,fy(t,r))}function dy(r,e,t,i){if(i==0){t==1&&(e[0]=r-1-e[0],e[1]=r-1-e[1]);const n=e[0];e[0]=e[1],e[1]=n}}var gy=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function py(r,e,t){if(r>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(e>Math.pow(2,r)-1||t>Math.pow(2,r)-1)throw Error("tile x/y outside zoom level bounds");const i=gy[r],n=Math.pow(2,r);let s=0,o=0,a=0;const l=[e,t];let c=n/2;for(;c>0;)s=(l[0]&c)>0?1:0,o=(l[1]&c)>0?1:0,a+=c*c*(3*s^o),dy(c,l,s,o),c=c/2;return i+a}function iu(r,e){return Ge(this,null,function*(){if(e===1||e===0)return r;if(e===2){if(typeof globalThis.DecompressionStream>"u")return Ss(new Uint8Array(r));{let i=new Response(r).body.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(i).arrayBuffer()}}else throw Error("Compression method not supported")})}var dr=(r=>(r[r.Unknown=0]="Unknown",r[r.Mvt=1]="Mvt",r[r.Png=2]="Png",r[r.Jpeg=3]="Jpeg",r[r.Webp=4]="Webp",r[r.Avif=5]="Avif",r))(dr||{}),my=127;function _y(r,e){let t=0,i=r.length-1;for(;t<=i;){const n=i+t>>1,s=e-r[n].tileId;if(s>0)t=n+1;else if(s<0)i=n-1;else return r[n]}return i>=0&&(r[i].runLength===0||e-r[i].tileId<r[i].runLength)?r[i]:null}var yy=class{constructor(r,e=new Headers){this.url=r,this.customHeaders=e}getKey(){return this.url}setHeaders(r){this.customHeaders=r}getBytes(r,e,t){return Ge(this,null,function*(){let i;t||(i=new AbortController,t=i.signal);const n=new Headers(this.customHeaders);n.set("Range","bytes="+r+"-"+(r+e-1));let s=yield fetch(this.url,{signal:t,headers:n});if(s.status===416&&r===0){const l=s.headers.get("Content-Range");if(!l||!l.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const c=+l.substr(8);s=yield fetch(this.url,{signal:t,headers:{Range:"bytes=0-"+(c-1)}})}if(s.status>=300)throw Error("Bad response code: "+s.status);const o=s.headers.get("Content-Length");if(s.status===200&&(!o||+o>e))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield s.arrayBuffer(),etag:s.headers.get("ETag")||void 0,cacheControl:s.headers.get("Cache-Control")||void 0,expires:s.headers.get("Expires")||void 0}})}};function rt(r,e){const t=r.getUint32(e+4,!0),i=r.getUint32(e+0,!0);return t*Math.pow(2,32)+i}function xy(r,e){const t=new DataView(r),i=t.getUint8(7);if(i>3)throw Error(`Archive is spec version ${i} but this library supports up to spec version 3`);return{specVersion:i,rootDirectoryOffset:rt(t,8),rootDirectoryLength:rt(t,16),jsonMetadataOffset:rt(t,24),jsonMetadataLength:rt(t,32),leafDirectoryOffset:rt(t,40),leafDirectoryLength:rt(t,48),tileDataOffset:rt(t,56),tileDataLength:rt(t,64),numAddressedTiles:rt(t,72),numTileEntries:rt(t,80),numTileContents:rt(t,88),clustered:t.getUint8(96)===1,internalCompression:t.getUint8(97),tileCompression:t.getUint8(98),tileType:t.getUint8(99),minZoom:t.getUint8(100),maxZoom:t.getUint8(101),minLon:t.getInt32(102,!0)/1e7,minLat:t.getInt32(106,!0)/1e7,maxLon:t.getInt32(110,!0)/1e7,maxLat:t.getInt32(114,!0)/1e7,centerZoom:t.getUint8(118),centerLon:t.getInt32(119,!0)/1e7,centerLat:t.getInt32(123,!0)/1e7,etag:e}}function nu(r){const e={buf:new Uint8Array(r),pos:0},t=zr(e),i=[];let n=0;for(let s=0;s<t;s++){const o=zr(e);i.push({tileId:n+o,offset:0,length:0,runLength:1}),n+=o}for(let s=0;s<t;s++)i[s].runLength=zr(e);for(let s=0;s<t;s++)i[s].length=zr(e);for(let s=0;s<t;s++){const o=zr(e);o===0&&s>0?i[s].offset=i[s-1].offset+i[s-1].length:i[s].offset=o-1}return i}function Ey(r){const e=new DataView(r);return e.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):e.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var mr=class extends Error{};function by(r,e,t,i){return Ge(this,null,function*(){const n=yield r.getBytes(0,16384);if(new DataView(n.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(Ey(n.data)<3)return[yield ru.getHeader(r)];const o=n.data.slice(0,my);let a=n.etag;i&&n.etag!=i&&(console.warn("ETag conflict detected; your HTTP server might not support content-based ETag headers. ETags disabled for "+r.getKey()),a=void 0);const l=xy(o,a);if(t){const c=n.data.slice(l.rootDirectoryOffset,l.rootDirectoryOffset+l.rootDirectoryLength),u=r.getKey()+"|"+(l.etag||"")+"|"+l.rootDirectoryOffset+"|"+l.rootDirectoryLength,h=nu(yield e(c,l.internalCompression));return[l,[u,h.length,h]]}return[l,void 0]})}function Ty(r,e,t,i,n){return Ge(this,null,function*(){const s=yield r.getBytes(t,i);if(n.etag&&n.etag!==s.etag)throw new mr(s.etag);const o=yield e(s.data,n.internalCompression),a=nu(o);if(a.length===0)throw new Error("Empty directory is invalid");return a})}var wy=class{constructor(r=100,e=!0,t=iu){this.cache=new Map,this.maxCacheEntries=r,this.counter=1,this.prefetch=e,this.decompress=t}getHeader(r,e){return Ge(this,null,function*(){const t=r.getKey();if(this.cache.has(t))return this.cache.get(t).lastUsed=this.counter++,yield this.cache.get(t).data;const i=new Promise((n,s)=>{by(r,this.decompress,this.prefetch,e).then(o=>{o[1]&&this.cache.set(o[1][0],{lastUsed:this.counter++,data:Promise.resolve(o[1][2])}),n(o[0]),this.prune()}).catch(o=>{s(o)})});return this.cache.set(t,{lastUsed:this.counter++,data:i}),i})}getDirectory(r,e,t,i){return Ge(this,null,function*(){const n=r.getKey()+"|"+(i.etag||"")+"|"+e+"|"+t;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const s=new Promise((o,a)=>{Ty(r,this.decompress,e,t,i).then(l=>{o(l),this.prune()}).catch(l=>{a(l)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}getArrayBuffer(r,e,t,i){return Ge(this,null,function*(){const n=r.getKey()+"|"+(i.etag||"")+"|"+e+"|"+t;if(this.cache.has(n))return this.cache.get(n).lastUsed=this.counter++,yield this.cache.get(n).data;const s=new Promise((o,a)=>{r.getBytes(e,t).then(l=>{if(i.etag&&i.etag!==l.etag)throw new mr(l.etag);o(l.data),this.cache.has(n),this.prune()}).catch(l=>{a(l)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}prune(){if(this.cache.size>=this.maxCacheEntries){let r=1/0,e;this.cache.forEach((t,i)=>{t.lastUsed<r&&(r=t.lastUsed,e=i)}),e&&this.cache.delete(e)}}invalidate(r,e){return Ge(this,null,function*(){this.cache.delete(r.getKey()),yield this.getHeader(r,e)})}},Ro=class{constructor(r,e,t){typeof r=="string"?this.source=new yy(r):this.source=r,t?this.decompress=t:this.decompress=iu,e?this.cache=e:this.cache=new wy}getHeader(){return Ge(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(r,e,t,i){return Ge(this,null,function*(){const n=py(r,e,t),s=yield this.cache.getHeader(this.source);if(s.specVersion<3)return ru.getZxy(s,this.source,this.cache,r,e,t,i);if(r<s.minZoom||r>s.maxZoom)return;let o=s.rootDirectoryOffset,a=s.rootDirectoryLength;for(let l=0;l<=3;l++){const c=yield this.cache.getDirectory(this.source,o,a,s),u=_y(c,n);if(u)if(u.runLength>0){const h=yield this.source.getBytes(s.tileDataOffset+u.offset,u.length,i);if(s.etag&&s.etag!==h.etag)throw new mr(h.etag);return{data:yield this.decompress(h.data,s.tileCompression),cacheControl:h.cacheControl,expires:h.expires}}else o=s.leafDirectoryOffset+u.offset,a=u.length;else return}throw Error("Maximum directory depth exceeded")})}getZxy(r,e,t,i){return Ge(this,null,function*(){try{return yield this.getZxyAttempt(r,e,t,i)}catch(n){if(n instanceof mr)return this.cache.invalidate(this.source,n.message),yield this.getZxyAttempt(r,e,t,i);throw n}})}getMetadataAttempt(){return Ge(this,null,function*(){const r=yield this.cache.getHeader(this.source),e=yield this.source.getBytes(r.jsonMetadataOffset,r.jsonMetadataLength);if(r.etag&&r.etag!==e.etag)throw new mr(e.etag);const t=yield this.decompress(e.data,r.internalCompression),i=new TextDecoder("utf-8");return JSON.parse(i.decode(t))})}getMetadata(){return Ge(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(r){if(r instanceof mr)return this.cache.invalidate(this.source,r.message),yield this.getMetadataAttempt();throw r}})}};class Sy extends nc{constructor(e){super(ze.ERROR),this.error=e}}function Oe(r){return(e,...t)=>vy(r,e,t)}function Nr(r,e){return Oe(su(r,e).get)}const{apply:vy,getOwnPropertyDescriptor:su,getPrototypeOf:Ao,ownKeys:Ry}=Reflect,{iterator:Ei,toStringTag:Ay}=Symbol,Py=Object,{create:Po,defineProperty:Ly}=Py,Iy=Array,Cy=Iy.prototype,ou=Cy[Ei],Fy=Oe(ou),au=ArrayBuffer,Oy=au.prototype;Nr(Oy,"byteLength");const al=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:null;al&&Nr(al.prototype,"byteLength");const lu=Ao(Uint8Array);lu.from;const ke=lu.prototype;ke[Ei];Oe(ke.keys);Oe(ke.values);Oe(ke.entries);Oe(ke.set);Oe(ke.reverse);Oe(ke.fill);Oe(ke.copyWithin);Oe(ke.sort);Oe(ke.slice);Oe(ke.subarray);Nr(ke,"buffer");Nr(ke,"byteOffset");Nr(ke,"length");Nr(ke,Ay);const My=Uint8Array,cu=Uint16Array,Lo=Uint32Array,Ny=Float32Array,oi=Ao([][Ei]()),uu=Oe(oi.next),Dy=Oe(function*(){}().next),Uy=Ao(oi),By=DataView.prototype,Gy=Oe(By.getUint16),Io=WeakMap,hu=Io.prototype,fu=Oe(hu.get),zy=Oe(hu.set),du=new Io,ky=Po(null,{next:{value:function(){const e=fu(du,this);return uu(e)}},[Ei]:{value:function(){return this}}});function $y(r){if(r[Ei]===ou&&oi.next===uu)return r;const e=Po(ky);return zy(du,e,Fy(r)),e}const Vy=new Io,Xy=Po(Uy,{next:{value:function(){const e=fu(Vy,this);return Dy(e)},writable:!0,configurable:!0}});for(const r of Ry(oi))r!=="next"&&Ly(Xy,r,su(oi,r));const gu=new au(4),Wy=new Ny(gu),jy=new Lo(gu),ft=new cu(512),dt=new My(512);for(let r=0;r<256;++r){const e=r-127;e<-24?(ft[r]=0,ft[r|256]=32768,dt[r]=24,dt[r|256]=24):e<-14?(ft[r]=1024>>-e-14,ft[r|256]=1024>>-e-14|32768,dt[r]=-e-1,dt[r|256]=-e-1):e<=15?(ft[r]=e+15<<10,ft[r|256]=e+15<<10|32768,dt[r]=13,dt[r|256]=13):e<128?(ft[r]=31744,ft[r|256]=64512,dt[r]=24,dt[r|256]=24):(ft[r]=31744,ft[r|256]=64512,dt[r]=13,dt[r|256]=13)}const Co=new Lo(2048);for(let r=1;r<1024;++r){let e=r<<13,t=0;for(;!(e&8388608);)e<<=1,t-=8388608;e&=-8388609,t+=947912704,Co[r]=e|t}for(let r=1024;r<2048;++r)Co[r]=939524096+(r-1024<<13);const Dr=new Lo(64);for(let r=1;r<31;++r)Dr[r]=r<<23;Dr[31]=1199570944;Dr[32]=2147483648;for(let r=33;r<63;++r)Dr[r]=2147483648+(r-32<<23);Dr[63]=3347054592;const pu=new cu(64);for(let r=1;r<64;++r)r!==32&&(pu[r]=1024);function Hy(r){const e=r>>10;return jy[0]=Co[pu[e]+(r&1023)]+Dr[e],Wy[0]}function mu(r,e,...t){return Hy(Gy(r,e,...$y(t)))}var Fo={exports:{}};function _u(r,e,t){const i=t&&t.debug||!1;i&&console.log("[xml-utils] getting "+e+" in "+r);const n=typeof r=="object"?r.outer:r,s=n.slice(0,n.indexOf(">")+1),o=['"',"'"];for(let a=0;a<o.length;a++){const l=o[a],c=e+"\\="+l+"([^"+l+"]*)"+l;i&&console.log("[xml-utils] pattern:",c);const h=new RegExp(c).exec(s);if(i&&console.log("[xml-utils] match:",h),h)return h[1]}}Fo.exports=_u;Fo.exports.default=_u;var Zy=Fo.exports;const Kn=to(Zy);var Oo={exports:{}},Mo={exports:{}},No={exports:{}};function yu(r,e,t){const n=new RegExp(e).exec(r.slice(t));return n?t+n.index:-1}No.exports=yu;No.exports.default=yu;var Yy=No.exports,Do={exports:{}};function xu(r,e,t){const n=new RegExp(e).exec(r.slice(t));return n?t+n.index+n[0].length-1:-1}Do.exports=xu;Do.exports.default=xu;var qy=Do.exports,Uo={exports:{}};function Eu(r,e){const t=new RegExp(e,"g"),i=r.match(t);return i?i.length:0}Uo.exports=Eu;Uo.exports.default=Eu;var Ky=Uo.exports;const Jy=Yy,Jn=qy,ll=Ky;function bu(r,e,t){const i=t&&t.debug||!1,n=!(t&&typeof t.nested===!1),s=t&&t.startIndex||0;i&&console.log("[xml-utils] starting findTagByName with",e," and ",t);const o=Jy(r,`<${e}[ 
>/]`,s);if(i&&console.log("[xml-utils] start:",o),o===-1)return;const a=r.slice(o+e.length);let l=Jn(a,"^[^<]*[ /]>",0);const c=l!==-1&&a[l-1]==="/";if(i&&console.log("[xml-utils] selfClosing:",c),c===!1)if(n){let g=0,d=1,p=0;for(;(l=Jn(a,"[ /]"+e+">",g))!==-1;){const m=a.substring(g,l+1);if(d+=ll(m,"<"+e+`[ 
	>]`),p+=ll(m,"</"+e+">"),p>=d)break;g=l}}else l=Jn(a,"[ /]"+e+">",0);const u=o+e.length+l+1;if(i&&console.log("[xml-utils] end:",u),u===-1)return;const h=r.slice(o,u);let f;return c?f=null:f=h.slice(h.indexOf(">")+1,h.lastIndexOf("<")),{inner:f,outer:h,start:o,end:u}}Mo.exports=bu;Mo.exports.default=bu;var Qy=Mo.exports;const e0=Qy;function Tu(r,e,t){const i=[],n=t&&t.debug||!1,s=t&&typeof t.nested=="boolean"?t.nested:!0;let o=t&&t.startIndex||0,a;for(;a=e0(r,e,{debug:n,startIndex:o});)s?o=a.start+1+e.length:o=a.end,i.push(a);return n&&console.log("findTagsByName found",i.length,"tags"),i}Oo.exports=Tu;Oo.exports.default=Tu;var t0=Oo.exports;const r0=to(t0),Kr={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",340:"SMinSampleValue",341:"SMaxSampleValue",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop",33550:"ModelPixelScale",33922:"ModelTiepoint",34264:"ModelTransformation",34735:"GeoKeyDirectory",34736:"GeoDoubleParams",34737:"GeoAsciiParams",50674:"LercParameters"},gt={};for(const r in Kr)Kr.hasOwnProperty(r)&&(gt[Kr[r]]=parseInt(r,10));const i0=[gt.BitsPerSample,gt.ExtraSamples,gt.SampleFormat,gt.StripByteCounts,gt.StripOffsets,gt.StripRowCounts,gt.TileByteCounts,gt.TileOffsets,gt.SubIFDs],Qn={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE",13:"IFD",16:"LONG8",17:"SLONG8",18:"IFD8"},Y={};for(const r in Qn)Qn.hasOwnProperty(r)&&(Y[Qn[r]]=parseInt(r,10));const $e={WhiteIsZero:0,BlackIsZero:1,RGB:2,Palette:3,CMYK:5,YCbCr:6,CIELab:8,ICCLab:9},n0={Unspecified:0},Ab={AddCompression:1},Pb={None:0,Deflate:1,Zstandard:2},s0={1024:"GTModelTypeGeoKey",1025:"GTRasterTypeGeoKey",1026:"GTCitationGeoKey",2048:"GeographicTypeGeoKey",2049:"GeogCitationGeoKey",2050:"GeogGeodeticDatumGeoKey",2051:"GeogPrimeMeridianGeoKey",2052:"GeogLinearUnitsGeoKey",2053:"GeogLinearUnitSizeGeoKey",2054:"GeogAngularUnitsGeoKey",2055:"GeogAngularUnitSizeGeoKey",2056:"GeogEllipsoidGeoKey",2057:"GeogSemiMajorAxisGeoKey",2058:"GeogSemiMinorAxisGeoKey",2059:"GeogInvFlatteningGeoKey",2060:"GeogAzimuthUnitsGeoKey",2061:"GeogPrimeMeridianLongGeoKey",2062:"GeogTOWGS84GeoKey",3072:"ProjectedCSTypeGeoKey",3073:"PCSCitationGeoKey",3074:"ProjectionGeoKey",3075:"ProjCoordTransGeoKey",3076:"ProjLinearUnitsGeoKey",3077:"ProjLinearUnitSizeGeoKey",3078:"ProjStdParallel1GeoKey",3079:"ProjStdParallel2GeoKey",3080:"ProjNatOriginLongGeoKey",3081:"ProjNatOriginLatGeoKey",3082:"ProjFalseEastingGeoKey",3083:"ProjFalseNorthingGeoKey",3084:"ProjFalseOriginLongGeoKey",3085:"ProjFalseOriginLatGeoKey",3086:"ProjFalseOriginEastingGeoKey",3087:"ProjFalseOriginNorthingGeoKey",3088:"ProjCenterLongGeoKey",3089:"ProjCenterLatGeoKey",3090:"ProjCenterEastingGeoKey",3091:"ProjCenterNorthingGeoKey",3092:"ProjScaleAtNatOriginGeoKey",3093:"ProjScaleAtCenterGeoKey",3094:"ProjAzimuthAngleGeoKey",3095:"ProjStraightVertPoleLongGeoKey",3096:"ProjRectifiedGridAngleGeoKey",4096:"VerticalCSTypeGeoKey",4097:"VerticalCitationGeoKey",4098:"VerticalDatumGeoKey",4099:"VerticalUnitsGeoKey"};function o0(r,e){const{width:t,height:i}=r,n=new Uint8Array(t*i*3);let s;for(let o=0,a=0;o<r.length;++o,a+=3)s=256-r[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function a0(r,e){const{width:t,height:i}=r,n=new Uint8Array(t*i*3);let s;for(let o=0,a=0;o<r.length;++o,a+=3)s=r[o]/e*256,n[a]=s,n[a+1]=s,n[a+2]=s;return n}function l0(r,e){const{width:t,height:i}=r,n=new Uint8Array(t*i*3),s=e.length/3,o=e.length/3*2;for(let a=0,l=0;a<r.length;++a,l+=3){const c=r[a];n[l]=e[c]/65536*256,n[l+1]=e[c+s]/65536*256,n[l+2]=e[c+o]/65536*256}return n}function c0(r){const{width:e,height:t}=r,i=new Uint8Array(e*t*3);for(let n=0,s=0;n<r.length;n+=4,s+=3){const o=r[n],a=r[n+1],l=r[n+2],c=r[n+3];i[s]=255*((255-o)/256)*((255-c)/256),i[s+1]=255*((255-a)/256)*((255-c)/256),i[s+2]=255*((255-l)/256)*((255-c)/256)}return i}function u0(r){const{width:e,height:t}=r,i=new Uint8ClampedArray(e*t*3);for(let n=0,s=0;n<r.length;n+=3,s+=3){const o=r[n],a=r[n+1],l=r[n+2];i[s]=o+1.402*(l-128),i[s+1]=o-.34414*(a-128)-.71414*(l-128),i[s+2]=o+1.772*(a-128)}return i}const h0=.95047,f0=1,d0=1.08883;function g0(r){const{width:e,height:t}=r,i=new Uint8Array(e*t*3);for(let n=0,s=0;n<r.length;n+=3,s+=3){const o=r[n+0],a=r[n+1]<<24>>24,l=r[n+2]<<24>>24;let c=(o+16)/116,u=a/500+c,h=c-l/200,f,g,d;u=h0*(u*u*u>.008856?u*u*u:(u-16/116)/7.787),c=f0*(c*c*c>.008856?c*c*c:(c-16/116)/7.787),h=d0*(h*h*h>.008856?h*h*h:(h-16/116)/7.787),f=u*3.2406+c*-1.5372+h*-.4986,g=u*-.9689+c*1.8758+h*.0415,d=u*.0557+c*-.204+h*1.057,f=f>.0031308?1.055*f**(1/2.4)-.055:12.92*f,g=g>.0031308?1.055*g**(1/2.4)-.055:12.92*g,d=d>.0031308?1.055*d**(1/2.4)-.055:12.92*d,i[s]=Math.max(0,Math.min(1,f))*255,i[s+1]=Math.max(0,Math.min(1,g))*255,i[s+2]=Math.max(0,Math.min(1,d))*255}return i}const wu=new Map;function Wt(r,e){Array.isArray(r)||(r=[r]),r.forEach(t=>wu.set(t,e))}async function Su(r){const e=wu.get(r.Compression);if(!e)throw new Error(`Unknown compression method identifier: ${r.Compression}`);const t=await e();return new t(r)}Wt([void 0,1],()=>Xt(()=>import("./raw.DxtaBMev.js"),__vite__mapDeps([0,1])).then(r=>r.default));Wt(5,()=>Xt(()=>import("./lzw.BikwkTY2.js"),__vite__mapDeps([2,1])).then(r=>r.default));Wt(6,()=>{throw new Error("old style JPEG compression is not supported.")});Wt(7,()=>Xt(()=>import("./jpeg.CbvpOiPg.js"),__vite__mapDeps([3,1])).then(r=>r.default));Wt([8,32946],()=>Xt(()=>import("./deflate.B4_27dB1.js"),__vite__mapDeps([4,5,1])).then(r=>r.default));Wt(32773,()=>Xt(()=>import("./packbits.D6Qr5eNi.js"),__vite__mapDeps([6,1])).then(r=>r.default));Wt(34887,()=>Xt(()=>import("./lerc.bDO2HJ0q.js"),__vite__mapDeps([7,5,8,1,9,10,11,12,13,14,15,16])).then(async r=>(await r.zstd.init(),r)).then(r=>r.default));Wt(50001,()=>Xt(()=>import("./webimage.CU41Mh7j.js"),__vite__mapDeps([17,1])).then(r=>r.default));function Nn(r,e,t,i=1){return new(Object.getPrototypeOf(r)).constructor(e*t*i)}function p0(r,e,t,i,n){const s=e/i,o=t/n;return r.map(a=>{const l=Nn(a,i,n);for(let c=0;c<n;++c){const u=Math.min(Math.round(o*c),t-1);for(let h=0;h<i;++h){const f=Math.min(Math.round(s*h),e-1),g=a[u*e+f];l[c*i+h]=g}}return l})}function yr(r,e,t){return(1-t)*r+t*e}function m0(r,e,t,i,n){const s=e/i,o=t/n;return r.map(a=>{const l=Nn(a,i,n);for(let c=0;c<n;++c){const u=o*c,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let g=0;g<i;++g){const d=s*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1),_=a[h*e+m],E=a[h*e+y],S=a[f*e+m],v=a[f*e+y],w=yr(yr(_,E,p),yr(S,v,p),u%1);l[c*i+g]=w}}return l})}function _0(r,e,t,i,n,s="nearest"){switch(s.toLowerCase()){case"nearest":return p0(r,e,t,i,n);case"bilinear":case"linear":return m0(r,e,t,i,n);default:throw new Error(`Unsupported resampling method: '${s}'`)}}function y0(r,e,t,i,n,s){const o=e/i,a=t/n,l=Nn(r,i,n,s);for(let c=0;c<n;++c){const u=Math.min(Math.round(a*c),t-1);for(let h=0;h<i;++h){const f=Math.min(Math.round(o*h),e-1);for(let g=0;g<s;++g){const d=r[u*e*s+f*s+g];l[c*i*s+h*s+g]=d}}}return l}function x0(r,e,t,i,n,s){const o=e/i,a=t/n,l=Nn(r,i,n,s);for(let c=0;c<n;++c){const u=a*c,h=Math.floor(u),f=Math.min(Math.ceil(u),t-1);for(let g=0;g<i;++g){const d=o*g,p=d%1,m=Math.floor(d),y=Math.min(Math.ceil(d),e-1);for(let _=0;_<s;++_){const E=r[h*e*s+m*s+_],S=r[h*e*s+y*s+_],v=r[f*e*s+m*s+_],w=r[f*e*s+y*s+_],A=yr(yr(E,S,p),yr(v,w,p),u%1);l[c*i*s+g*s+_]=A}}}return l}function E0(r,e,t,i,n,s,o="nearest"){switch(o.toLowerCase()){case"nearest":return y0(r,e,t,i,n,s);case"bilinear":case"linear":return x0(r,e,t,i,n,s);default:throw new Error(`Unsupported resampling method: '${o}'`)}}function b0(r,e,t){let i=0;for(let n=e;n<t;++n)i+=r[n];return i}function vs(r,e,t){switch(r){case 1:if(e<=8)return new Uint8Array(t);if(e<=16)return new Uint16Array(t);if(e<=32)return new Uint32Array(t);break;case 2:if(e===8)return new Int8Array(t);if(e===16)return new Int16Array(t);if(e===32)return new Int32Array(t);break;case 3:switch(e){case 16:case 32:return new Float32Array(t);case 64:return new Float64Array(t)}break}throw Error("Unsupported data format/bitsPerSample")}function T0(r,e){return(r===1||r===2)&&e<=32&&e%8===0?!1:!(r===3&&(e===16||e===32||e===64))}function w0(r,e,t,i,n,s,o){const a=new DataView(r),l=t===2?o*s:o*s*i,c=t===2?1:i,u=vs(e,n,l),h=parseInt("1".repeat(n),2);if(e===1){let f;t===1?f=i*n:f=n;let g=s*f;g&7&&(g=g+7&-8);for(let d=0;d<o;++d){const p=d*g;for(let m=0;m<s;++m){const y=p+m*c*n;for(let _=0;_<c;++_){const E=y+_*n,S=(d*s+m)*c+_,v=Math.floor(E/8),w=E%8;if(w+n<=8)u[S]=a.getUint8(v)>>8-n-w&h;else if(w+n<=16)u[S]=a.getUint16(v)>>16-n-w&h;else if(w+n<=24){const A=a.getUint16(v)<<8|a.getUint8(v+2);u[S]=A>>24-n-w&h}else u[S]=a.getUint32(v)>>32-n-w&h}}}}return u.buffer}class vu{constructor(e,t,i,n,s,o){this.fileDirectory=e,this.geoKeys=t,this.dataView=i,this.littleEndian=n,this.tiles=s?{}:null,this.isTiled=!e.StripOffsets;const a=e.PlanarConfiguration;if(this.planarConfiguration=typeof a>"u"?1:a,this.planarConfiguration!==1&&this.planarConfiguration!==2)throw new Error("Invalid planar configuration.");this.source=o}getFileDirectory(){return this.fileDirectory}getGeoKeys(){return this.geoKeys}getWidth(){return this.fileDirectory.ImageWidth}getHeight(){return this.fileDirectory.ImageLength}getSamplesPerPixel(){return typeof this.fileDirectory.SamplesPerPixel<"u"?this.fileDirectory.SamplesPerPixel:1}getTileWidth(){return this.isTiled?this.fileDirectory.TileWidth:this.getWidth()}getTileHeight(){return this.isTiled?this.fileDirectory.TileLength:typeof this.fileDirectory.RowsPerStrip<"u"?Math.min(this.fileDirectory.RowsPerStrip,this.getHeight()):this.getHeight()}getBlockWidth(){return this.getTileWidth()}getBlockHeight(e){return this.isTiled||(e+1)*this.getTileHeight()<=this.getHeight()?this.getTileHeight():this.getHeight()-e*this.getTileHeight()}getBytesPerPixel(){let e=0;for(let t=0;t<this.fileDirectory.BitsPerSample.length;++t)e+=this.getSampleByteSize(t);return e}getSampleByteSize(e){if(e>=this.fileDirectory.BitsPerSample.length)throw new RangeError(`Sample index ${e} is out of range.`);return Math.ceil(this.fileDirectory.BitsPerSample[e]/8)}getReaderForSample(e){const t=this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1,i=this.fileDirectory.BitsPerSample[e];switch(t){case 1:if(i<=8)return DataView.prototype.getUint8;if(i<=16)return DataView.prototype.getUint16;if(i<=32)return DataView.prototype.getUint32;break;case 2:if(i<=8)return DataView.prototype.getInt8;if(i<=16)return DataView.prototype.getInt16;if(i<=32)return DataView.prototype.getInt32;break;case 3:switch(i){case 16:return function(n,s){return mu(this,n,s)};case 32:return DataView.prototype.getFloat32;case 64:return DataView.prototype.getFloat64}break}throw Error("Unsupported data format/bitsPerSample")}getSampleFormat(e=0){return this.fileDirectory.SampleFormat?this.fileDirectory.SampleFormat[e]:1}getBitsPerSample(e=0){return this.fileDirectory.BitsPerSample[e]}getArrayForSample(e,t){const i=this.getSampleFormat(e),n=this.getBitsPerSample(e);return vs(i,n,t)}async getTileOrStrip(e,t,i,n,s){const o=Math.ceil(this.getWidth()/this.getTileWidth()),a=Math.ceil(this.getHeight()/this.getTileHeight());let l;const{tiles:c}=this;this.planarConfiguration===1?l=t*o+e:this.planarConfiguration===2&&(l=i*o*a+t*o+e);let u,h;this.isTiled?(u=this.fileDirectory.TileOffsets[l],h=this.fileDirectory.TileByteCounts[l]):(u=this.fileDirectory.StripOffsets[l],h=this.fileDirectory.StripByteCounts[l]);const f=(await this.source.fetch([{offset:u,length:h}],s))[0];let g;return c===null||!c[l]?(g=(async()=>{let d=await n.decode(this.fileDirectory,f);const p=this.getSampleFormat(),m=this.getBitsPerSample();return T0(p,m)&&(d=w0(d,p,this.planarConfiguration,this.getSamplesPerPixel(),m,this.getTileWidth(),this.getBlockHeight(t))),d})(),c!==null&&(c[l]=g)):g=c[l],{x:e,y:t,sample:i,data:await g}}async _readRaster(e,t,i,n,s,o,a,l,c){const u=this.getTileWidth(),h=this.getTileHeight(),f=this.getWidth(),g=this.getHeight(),d=Math.max(Math.floor(e[0]/u),0),p=Math.min(Math.ceil(e[2]/u),Math.ceil(f/u)),m=Math.max(Math.floor(e[1]/h),0),y=Math.min(Math.ceil(e[3]/h),Math.ceil(g/h)),_=e[2]-e[0];let E=this.getBytesPerPixel();const S=[],v=[];for(let C=0;C<t.length;++C)this.planarConfiguration===1?S.push(b0(this.fileDirectory.BitsPerSample,0,t[C])/8):S.push(0),v.push(this.getReaderForSample(t[C]));const w=[],{littleEndian:A}=this;for(let C=m;C<y;++C)for(let P=d;P<p;++P){let R;this.planarConfiguration===1&&(R=this.getTileOrStrip(P,C,0,s,c));for(let U=0;U<t.length;++U){const M=U,z=t[U];this.planarConfiguration===2&&(E=this.getSampleByteSize(z),R=this.getTileOrStrip(P,C,z,s,c));const N=R.then(G=>{const ie=G.data,W=new DataView(ie),q=this.getBlockHeight(G.y),ne=G.y*h,ae=G.x*u,pe=ne+q,be=(G.x+1)*u,me=v[M],we=Math.min(q,q-(pe-e[3]),g-ne),Le=Math.min(u,u-(be-e[2]),f-ae);for(let Ae=Math.max(0,e[1]-ne);Ae<we;++Ae)for(let Me=Math.max(0,e[0]-ae);Me<Le;++Me){const ir=(Ae*u+Me)*E,nr=me.call(W,ir+S[M],A);let Tt;n?(Tt=(Ae+ne-e[1])*_*t.length+(Me+ae-e[0])*t.length+M,i[Tt]=nr):(Tt=(Ae+ne-e[1])*_+Me+ae-e[0],i[M][Tt]=nr)}});w.push(N)}}if(await Promise.all(w),o&&e[2]-e[0]!==o||a&&e[3]-e[1]!==a){let C;return n?C=E0(i,e[2]-e[0],e[3]-e[1],o,a,t.length,l):C=_0(i,e[2]-e[0],e[3]-e[1],o,a,l),C.width=o,C.height=a,C}return i.width=o||e[2]-e[0],i.height=a||e[3]-e[1],i}async readRasters({window:e,samples:t=[],interleave:i,pool:n=null,width:s,height:o,resampleMethod:a,fillValue:l,signal:c}={}){const u=e||[0,0,this.getWidth(),this.getHeight()];if(u[0]>u[2]||u[1]>u[3])throw new Error("Invalid subsets");const h=u[2]-u[0],f=u[3]-u[1],g=h*f,d=this.getSamplesPerPixel();if(!t||!t.length)for(let _=0;_<d;++_)t.push(_);else for(let _=0;_<t.length;++_)if(t[_]>=d)return Promise.reject(new RangeError(`Invalid sample index '${t[_]}'.`));let p;if(i){const _=this.fileDirectory.SampleFormat?Math.max.apply(null,this.fileDirectory.SampleFormat):1,E=Math.max.apply(null,this.fileDirectory.BitsPerSample);p=vs(_,E,g*t.length),l&&p.fill(l)}else{p=[];for(let _=0;_<t.length;++_){const E=this.getArrayForSample(t[_],g);Array.isArray(l)&&_<l.length?E.fill(l[_]):l&&!Array.isArray(l)&&E.fill(l),p.push(E)}}const m=n||await Su(this.fileDirectory);return await this._readRaster(u,t,p,i,m,s,o,a,c)}async readRGB({window:e,interleave:t=!0,pool:i=null,width:n,height:s,resampleMethod:o,enableAlpha:a=!1,signal:l}={}){const c=e||[0,0,this.getWidth(),this.getHeight()];if(c[0]>c[2]||c[1]>c[3])throw new Error("Invalid subsets");const u=this.fileDirectory.PhotometricInterpretation;if(u===$e.RGB){let y=[0,1,2];if(this.fileDirectory.ExtraSamples!==n0.Unspecified&&a){y=[];for(let _=0;_<this.fileDirectory.BitsPerSample.length;_+=1)y.push(_)}return this.readRasters({window:e,interleave:t,samples:y,pool:i,width:n,height:s,resampleMethod:o,signal:l})}let h;switch(u){case $e.WhiteIsZero:case $e.BlackIsZero:case $e.Palette:h=[0];break;case $e.CMYK:h=[0,1,2,3];break;case $e.YCbCr:case $e.CIELab:h=[0,1,2];break;default:throw new Error("Invalid or unsupported photometric interpretation.")}const f={window:c,interleave:!0,samples:h,pool:i,width:n,height:s,resampleMethod:o,signal:l},{fileDirectory:g}=this,d=await this.readRasters(f),p=2**this.fileDirectory.BitsPerSample[0];let m;switch(u){case $e.WhiteIsZero:m=o0(d,p);break;case $e.BlackIsZero:m=a0(d,p);break;case $e.Palette:m=l0(d,g.ColorMap);break;case $e.CMYK:m=c0(d);break;case $e.YCbCr:m=u0(d);break;case $e.CIELab:m=g0(d);break;default:throw new Error("Unsupported photometric interpretation.")}if(!t){const y=new Uint8Array(m.length/3),_=new Uint8Array(m.length/3),E=new Uint8Array(m.length/3);for(let S=0,v=0;S<m.length;S+=3,++v)y[v]=m[S],_[v]=m[S+1],E[v]=m[S+2];m=[y,_,E]}return m.width=d.width,m.height=d.height,m}getTiePoints(){if(!this.fileDirectory.ModelTiepoint)return[];const e=[];for(let t=0;t<this.fileDirectory.ModelTiepoint.length;t+=6)e.push({i:this.fileDirectory.ModelTiepoint[t],j:this.fileDirectory.ModelTiepoint[t+1],k:this.fileDirectory.ModelTiepoint[t+2],x:this.fileDirectory.ModelTiepoint[t+3],y:this.fileDirectory.ModelTiepoint[t+4],z:this.fileDirectory.ModelTiepoint[t+5]});return e}getGDALMetadata(e=null){const t={};if(!this.fileDirectory.GDAL_METADATA)return null;const i=this.fileDirectory.GDAL_METADATA;let n=r0(i,"Item");e===null?n=n.filter(s=>Kn(s,"sample")===void 0):n=n.filter(s=>Number(Kn(s,"sample"))===e);for(let s=0;s<n.length;++s){const o=n[s];t[Kn(o,"name")]=o.inner}return t}getGDALNoData(){if(!this.fileDirectory.GDAL_NODATA)return null;const e=this.fileDirectory.GDAL_NODATA;return Number(e.substring(0,e.length-1))}getOrigin(){const e=this.fileDirectory.ModelTiepoint,t=this.fileDirectory.ModelTransformation;if(e&&e.length===6)return[e[3],e[4],e[5]];if(t)return[t[3],t[7],t[11]];throw new Error("The image does not have an affine transformation.")}getResolution(e=null){const t=this.fileDirectory.ModelPixelScale,i=this.fileDirectory.ModelTransformation;if(t)return[t[0],-t[1],t[2]];if(i)return i[1]===0&&i[4]===0?[i[0],-i[5],i[10]]:[Math.sqrt(i[0]*i[0]+i[4]*i[4]),-Math.sqrt(i[1]*i[1]+i[5]*i[5]),i[10]];if(e){const[n,s,o]=e.getResolution();return[n*e.getWidth()/this.getWidth(),s*e.getHeight()/this.getHeight(),o*e.getWidth()/this.getWidth()]}throw new Error("The image does not have an affine transformation.")}pixelIsArea(){return this.geoKeys.GTRasterTypeGeoKey===1}getBoundingBox(e=!1){const t=this.getHeight(),i=this.getWidth();if(this.fileDirectory.ModelTransformation&&!e){const[n,s,o,a,l,c,u,h]=this.fileDirectory.ModelTransformation,g=[[0,0],[0,t],[i,0],[i,t]].map(([m,y])=>[a+n*m+s*y,h+l*m+c*y]),d=g.map(m=>m[0]),p=g.map(m=>m[1]);return[Math.min(...d),Math.min(...p),Math.max(...d),Math.max(...p)]}else{const n=this.getOrigin(),s=this.getResolution(),o=n[0],a=n[1],l=o+s[0]*i,c=a+s[1]*t;return[Math.min(o,l),Math.min(a,c),Math.max(o,l),Math.max(a,c)]}}}class S0{constructor(e){this._dataView=new DataView(e)}get buffer(){return this._dataView.buffer}getUint64(e,t){const i=this.getUint32(e,t),n=this.getUint32(e+4,t);let s;if(t){if(s=i+2**32*n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}if(s=2**32*i+n,!Number.isSafeInteger(s))throw new Error(`${s} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return s}getInt64(e,t){let i=0;const n=(this._dataView.getUint8(e+(t?7:0))&128)>0;let s=!0;for(let o=0;o<8;o++){let a=this._dataView.getUint8(e+(t?o:7-o));n&&(s?a!==0&&(a=~(a-1)&255,s=!1):a=~a&255),i+=a*256**o}return n&&(i=-i),i}getUint8(e,t){return this._dataView.getUint8(e,t)}getInt8(e,t){return this._dataView.getInt8(e,t)}getUint16(e,t){return this._dataView.getUint16(e,t)}getInt16(e,t){return this._dataView.getInt16(e,t)}getUint32(e,t){return this._dataView.getUint32(e,t)}getInt32(e,t){return this._dataView.getInt32(e,t)}getFloat16(e,t){return mu(this._dataView,e,t)}getFloat32(e,t){return this._dataView.getFloat32(e,t)}getFloat64(e,t){return this._dataView.getFloat64(e,t)}}class v0{constructor(e,t,i,n){this._dataView=new DataView(e),this._sliceOffset=t,this._littleEndian=i,this._bigTiff=n}get sliceOffset(){return this._sliceOffset}get sliceTop(){return this._sliceOffset+this.buffer.byteLength}get littleEndian(){return this._littleEndian}get bigTiff(){return this._bigTiff}get buffer(){return this._dataView.buffer}covers(e,t){return this.sliceOffset<=e&&this.sliceTop>=e+t}readUint8(e){return this._dataView.getUint8(e-this._sliceOffset,this._littleEndian)}readInt8(e){return this._dataView.getInt8(e-this._sliceOffset,this._littleEndian)}readUint16(e){return this._dataView.getUint16(e-this._sliceOffset,this._littleEndian)}readInt16(e){return this._dataView.getInt16(e-this._sliceOffset,this._littleEndian)}readUint32(e){return this._dataView.getUint32(e-this._sliceOffset,this._littleEndian)}readInt32(e){return this._dataView.getInt32(e-this._sliceOffset,this._littleEndian)}readFloat32(e){return this._dataView.getFloat32(e-this._sliceOffset,this._littleEndian)}readFloat64(e){return this._dataView.getFloat64(e-this._sliceOffset,this._littleEndian)}readUint64(e){const t=this.readUint32(e),i=this.readUint32(e+4);let n;if(this._littleEndian){if(n=t+2**32*i,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}if(n=2**32*t+i,!Number.isSafeInteger(n))throw new Error(`${n} exceeds MAX_SAFE_INTEGER. Precision may be lost. Please report if you get this message to https://github.com/geotiffjs/geotiff.js/issues`);return n}readInt64(e){let t=0;const i=(this._dataView.getUint8(e+(this._littleEndian?7:0))&128)>0;let n=!0;for(let s=0;s<8;s++){let o=this._dataView.getUint8(e+(this._littleEndian?s:7-s));i&&(n?o!==0&&(o=~(o-1)&255,n=!1):o=~o&255),t+=o*256**s}return i&&(t=-t),t}readOffset(e){return this._bigTiff?this.readUint64(e):this.readUint32(e)}}const R0=typeof navigator<"u"&&navigator.hardwareConcurrency||2;class A0{constructor(e=R0,t){this.workers=null,this._awaitingDecoder=null,this.size=e,this.messageId=0,e&&(this._awaitingDecoder=t?Promise.resolve(t):new Promise(i=>{Xt(()=>import("./decoder.tqM1uIvc.js"),[]).then(n=>{i(n.create)})}),this._awaitingDecoder.then(i=>{this._awaitingDecoder=null,this.workers=[];for(let n=0;n<e;n++)this.workers.push({worker:i(),idle:!0})}))}async decode(e,t){return this._awaitingDecoder&&await this._awaitingDecoder,this.size===0?Su(e).then(i=>i.decode(e,t)):new Promise(i=>{const n=this.workers.find(a=>a.idle)||this.workers[Math.floor(Math.random()*this.size)];n.idle=!1;const s=this.messageId++,o=a=>{a.data.id===s&&(n.idle=!0,i(a.data.decoded),n.worker.removeEventListener("message",o))};n.worker.addEventListener("message",o),n.worker.postMessage({fileDirectory:e,buffer:t,id:s},[t])})}destroy(){this.workers&&(this.workers.forEach(e=>{e.worker.terminate()}),this.workers=null)}}const cl=`\r
\r
`;function Ru(r){if(typeof Object.fromEntries<"u")return Object.fromEntries(r);const e={};for(const[t,i]of r)e[t.toLowerCase()]=i;return e}function P0(r){const e=r.split(`\r
`).map(t=>{const i=t.split(":").map(n=>n.trim());return i[0]=i[0].toLowerCase(),i});return Ru(e)}function L0(r){const[e,...t]=r.split(";").map(n=>n.trim()),i=t.map(n=>n.split("="));return{type:e,params:Ru(i)}}function Rs(r){let e,t,i;return r&&([,e,t,i]=r.match(/bytes (\d+)-(\d+)\/(\d+)/),e=parseInt(e,10),t=parseInt(t,10),i=parseInt(i,10)),{start:e,end:t,total:i}}function I0(r,e){let t=null;const i=new TextDecoder("ascii"),n=[],s=`--${e}`,o=`${s}--`;for(let a=0;a<10;++a)i.decode(new Uint8Array(r,a,s.length))===s&&(t=a);if(t===null)throw new Error("Could not find initial boundary");for(;t<r.byteLength;){const a=i.decode(new Uint8Array(r,t,Math.min(s.length+1024,r.byteLength-t)));if(a.length===0||a.startsWith(o))break;if(!a.startsWith(s))throw new Error("Part does not start with boundary");const l=a.substr(s.length+2);if(l.length===0)break;const c=l.indexOf(cl),u=P0(l.substr(0,c)),{start:h,end:f,total:g}=Rs(u["content-range"]),d=t+s.length+c+cl.length,p=parseInt(f,10)+1-parseInt(h,10);n.push({headers:u,data:r.slice(d,d+p),offset:h,length:p,fileSize:g}),t=d+p+4}return n}class Bo{async fetch(e,t=void 0){return Promise.all(e.map(i=>this.fetchSlice(i,t)))}async fetchSlice(e){throw new Error(`fetching of slice ${e} not possible, not implemented`)}get fileSize(){return null}async close(){}}class C0 extends Map{constructor(e={}){if(super(),!(e.maxSize&&e.maxSize>0))throw new TypeError("`maxSize` must be a number greater than 0");if(typeof e.maxAge=="number"&&e.maxAge===0)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if(typeof this.onEviction=="function")for(const[t,i]of e)this.onEviction(t,i.value)}_deleteIfExpired(e,t){return typeof t.expiry=="number"&&t.expiry<=Date.now()?(typeof this.onEviction=="function"&&this.onEviction(e,t.value),this.delete(e)):!1}_getOrDeleteIfExpired(e,t){if(this._deleteIfExpired(e,t)===!1)return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){const i=t.get(e);return this._getItemValue(e,i)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const e of this.oldCache){const[t,i]=e;this.cache.has(t)||this._deleteIfExpired(t,i)===!1&&(yield e)}for(const e of this.cache){const[t,i]=e;this._deleteIfExpired(t,i)===!1&&(yield e)}}get(e){if(this.cache.has(e)){const t=this.cache.get(e);return this._getItemValue(e,t)}if(this.oldCache.has(e)){const t=this.oldCache.get(e);if(this._deleteIfExpired(e,t)===!1)return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:i=this.maxAge}={}){const n=typeof i=="number"&&i!==Number.POSITIVE_INFINITY?Date.now()+i:void 0;return this.cache.has(e)?this.cache.set(e,{value:t,expiry:n}):this._set(e,{value:t,expiry:n}),this}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):this.oldCache.has(e)?!this._deleteIfExpired(e,this.oldCache.get(e)):!1}peek(e){if(this.cache.has(e))return this._peek(e,this.cache);if(this.oldCache.has(e))return this._peek(e,this.oldCache)}delete(e){const t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&e>0))throw new TypeError("`maxSize` must be a number greater than 0");const t=[...this._entriesAscending()],i=t.length-e;i<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(i>0&&this._emitEvictions(t.slice(0,i)),this.oldCache=new Map(t.slice(i)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(const[e]of this)yield e}*values(){for(const[,e]of this)yield e}*[Symbol.iterator](){for(const e of this.cache){const[t,i]=e;this._deleteIfExpired(t,i)===!1&&(yield[t,i.value])}for(const e of this.oldCache){const[t,i]=e;this.cache.has(t)||this._deleteIfExpired(t,i)===!1&&(yield[t,i.value])}}*entriesDescending(){let e=[...this.cache];for(let t=e.length-1;t>=0;--t){const i=e[t],[n,s]=i;this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}e=[...this.oldCache];for(let t=e.length-1;t>=0;--t){const i=e[t],[n,s]=i;this.cache.has(n)||this._deleteIfExpired(n,s)===!1&&(yield[n,s.value])}}*entriesAscending(){for(const[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(const[i,n]of this.entriesAscending())e.call(t,n,i,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}async function F0(r){return new Promise(e=>setTimeout(e,r))}function O0(r,e){const t=Array.isArray(r)?r:Array.from(r),i=Array.isArray(e)?e:Array.from(e);return t.map((n,s)=>[n,i[s]])}class Sr extends Error{constructor(e){super(e),Error.captureStackTrace&&Error.captureStackTrace(this,Sr),this.name="AbortError"}}class M0 extends Error{constructor(e,t){super(t),this.errors=e,this.message=t,this.name="AggregateError"}}const N0=M0;class D0{constructor(e,t,i=null){this.offset=e,this.length=t,this.data=i}get top(){return this.offset+this.length}}class ul{constructor(e,t,i){this.offset=e,this.length=t,this.blockIds=i}}class U0 extends Bo{constructor(e,{blockSize:t=65536,cacheSize:i=100}={}){super(),this.source=e,this.blockSize=t,this.blockCache=new C0({maxSize:i,onEviction:(n,s)=>{this.evictedBlocks.set(n,s)}}),this.evictedBlocks=new Map,this.blockRequests=new Map,this.blockIdsToFetch=new Set,this.abortedBlockIds=new Set}get fileSize(){return this.source.fileSize}async fetch(e,t){const i=[],n=[],s=[];this.evictedBlocks.clear();for(const{offset:f,length:g}of e){let d=f+g;const{fileSize:p}=this;p!==null&&(d=Math.min(d,p));const m=Math.floor(f/this.blockSize)*this.blockSize;for(let y=m;y<d;y+=this.blockSize){const _=Math.floor(y/this.blockSize);!this.blockCache.has(_)&&!this.blockRequests.has(_)&&(this.blockIdsToFetch.add(_),n.push(_)),this.blockRequests.has(_)&&i.push(this.blockRequests.get(_)),s.push(_)}}await F0(),this.fetchBlocks(t);const o=[];for(const f of n)this.blockRequests.has(f)&&o.push(this.blockRequests.get(f));await Promise.allSettled(i),await Promise.allSettled(o);const a=[],l=s.filter(f=>this.abortedBlockIds.has(f)||!this.blockCache.has(f));if(l.forEach(f=>this.blockIdsToFetch.add(f)),l.length>0&&t&&!t.aborted){this.fetchBlocks(null);for(const f of l){const g=this.blockRequests.get(f);if(!g)throw new Error(`Block ${f} is not in the block requests`);a.push(g)}await Promise.allSettled(a)}if(t&&t.aborted)throw new Sr("Request was aborted");const c=s.map(f=>this.blockCache.get(f)||this.evictedBlocks.get(f)),u=c.filter(f=>!f);if(u.length)throw new N0(u,"Request failed");const h=new Map(O0(s,c));return this.readSliceData(e,h)}fetchBlocks(e){if(this.blockIdsToFetch.size>0){const t=this.groupBlocks(this.blockIdsToFetch),i=this.source.fetch(t,e);for(let n=0;n<t.length;++n){const s=t[n];for(const o of s.blockIds)this.blockRequests.set(o,(async()=>{try{const a=(await i)[n],l=o*this.blockSize,c=l-a.offset,u=Math.min(c+this.blockSize,a.data.byteLength),h=a.data.slice(c,u),f=new D0(l,h.byteLength,h,o);this.blockCache.set(o,f),this.abortedBlockIds.delete(o)}catch(a){if(a.name==="AbortError")a.signal=e,this.blockCache.delete(o),this.abortedBlockIds.add(o);else throw a}finally{this.blockRequests.delete(o)}})())}this.blockIdsToFetch.clear()}}groupBlocks(e){const t=Array.from(e).sort((o,a)=>o-a);if(t.length===0)return[];let i=[],n=null;const s=[];for(const o of t)n===null||n+1===o?(i.push(o),n=o):(s.push(new ul(i[0]*this.blockSize,i.length*this.blockSize,i)),i=[o],n=o);return s.push(new ul(i[0]*this.blockSize,i.length*this.blockSize,i)),s}readSliceData(e,t){return e.map(i=>{let n=i.offset+i.length;this.fileSize!==null&&(n=Math.min(this.fileSize,n));const s=Math.floor(i.offset/this.blockSize),o=Math.floor(n/this.blockSize),a=new ArrayBuffer(i.length),l=new Uint8Array(a);for(let c=s;c<=o;++c){const u=t.get(c),h=u.offset-i.offset,f=u.top-n;let g=0,d=0,p;h<0?g=-h:h>0&&(d=h),f<0?p=u.length-g:p=n-u.offset-g;const m=new Uint8Array(u.data,g,p);l.set(m,d)}return a})}}class Go{get ok(){return this.status>=200&&this.status<=299}get status(){throw new Error("not implemented")}getHeader(e){throw new Error("not implemented")}async getData(){throw new Error("not implemented")}}class zo{constructor(e){this.url=e}async request({headers:e,signal:t}={}){throw new Error("request is not implemented")}}class B0 extends Go{constructor(e){super(),this.response=e}get status(){return this.response.status}getHeader(e){return this.response.headers.get(e)}async getData(){return this.response.arrayBuffer?await this.response.arrayBuffer():(await this.response.buffer()).buffer}}class G0 extends zo{constructor(e,t){super(e),this.credentials=t}async request({headers:e,signal:t}={}){const i=await fetch(this.url,{headers:e,credentials:this.credentials,signal:t});return new B0(i)}}class z0 extends Go{constructor(e,t){super(),this.xhr=e,this.data=t}get status(){return this.xhr.status}getHeader(e){return this.xhr.getResponseHeader(e)}async getData(){return this.data}}class k0 extends zo{constructRequest(e,t){return new Promise((i,n)=>{const s=new XMLHttpRequest;s.open("GET",this.url),s.responseType="arraybuffer";for(const[o,a]of Object.entries(e))s.setRequestHeader(o,a);s.onload=()=>{const o=s.response;i(new z0(s,o))},s.onerror=n,s.onabort=()=>n(new Sr("Request aborted")),s.send(),t&&(t.aborted&&s.abort(),t.addEventListener("abort",()=>s.abort()))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}const es={};class $0 extends Go{constructor(e,t){super(),this.response=e,this.dataPromise=t}get status(){return this.response.statusCode}getHeader(e){return this.response.headers[e]}async getData(){return await this.dataPromise}}class V0 extends zo{constructor(e){super(e),this.parsedUrl=es.parse(this.url),this.httpApi=(this.parsedUrl.protocol==="http:",es)}constructRequest(e,t){return new Promise((i,n)=>{const s=this.httpApi.get({...this.parsedUrl,headers:e},o=>{const a=new Promise(l=>{const c=[];o.on("data",u=>{c.push(u)}),o.on("end",()=>{const u=Buffer.concat(c).buffer;l(u)}),o.on("error",n)});i(new $0(o,a))});s.on("error",n),t&&(t.aborted&&s.destroy(new Sr("Request aborted")),t.addEventListener("abort",()=>s.destroy(new Sr("Request aborted"))))})}async request({headers:e,signal:t}={}){return await this.constructRequest(e,t)}}class ko extends Bo{constructor(e,t,i,n){super(),this.client=e,this.headers=t,this.maxRanges=i,this.allowFullFile=n,this._fileSize=null}async fetch(e,t){return this.maxRanges>=e.length?this.fetchSlices(e,t):(this.maxRanges>0&&e.length>1,Promise.all(e.map(i=>this.fetchSlice(i,t))))}async fetchSlices(e,t){const i=await this.client.request({headers:{...this.headers,Range:`bytes=${e.map(({offset:n,length:s})=>`${n}-${n+s}`).join(",")}`},signal:t});if(i.ok)if(i.status===206){const{type:n,params:s}=L0(i.getHeader("content-type"));if(n==="multipart/byteranges"){const h=I0(await i.getData(),s.boundary);return this._fileSize=h[0].fileSize||null,h}const o=await i.getData(),{start:a,end:l,total:c}=Rs(i.getHeader("content-range"));this._fileSize=c||null;const u=[{data:o,offset:a,length:l-a}];if(e.length>1){const h=await Promise.all(e.slice(1).map(f=>this.fetchSlice(f,t)));return u.concat(h)}return u}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const n=await i.getData();return this._fileSize=n.byteLength,[{data:n,offset:0,length:n.byteLength}]}else throw new Error("Error fetching data.")}async fetchSlice(e,t){const{offset:i,length:n}=e,s=await this.client.request({headers:{...this.headers,Range:`bytes=${i}-${i+n}`},signal:t});if(s.ok)if(s.status===206){const o=await s.getData(),{total:a}=Rs(s.getHeader("content-range"));return this._fileSize=a||null,{data:o,offset:i,length:n}}else{if(!this.allowFullFile)throw new Error("Server responded with full file");const o=await s.getData();return this._fileSize=o.byteLength,{data:o,offset:0,length:o.byteLength}}else throw new Error("Error fetching data.")}get fileSize(){return this._fileSize}}function $o(r,{blockSize:e,cacheSize:t}){return e===null?r:new U0(r,{blockSize:e,cacheSize:t})}function X0(r,{headers:e={},credentials:t,maxRanges:i=0,allowFullFile:n=!1,...s}={}){const o=new G0(r,t),a=new ko(o,e,i,n);return $o(a,s)}function W0(r,{headers:e={},maxRanges:t=0,allowFullFile:i=!1,...n}={}){const s=new k0(r),o=new ko(s,e,t,i);return $o(o,n)}function j0(r,{headers:e={},maxRanges:t=0,allowFullFile:i=!1,...n}={}){const s=new V0(r),o=new ko(s,e,t,i);return $o(o,n)}function As(r,{forceXHR:e=!1,...t}={}){return typeof fetch=="function"&&!e?X0(r,t):typeof XMLHttpRequest<"u"?W0(r,t):j0(r,t)}class H0 extends Bo{constructor(e){super(),this.file=e}async fetchSlice(e,t){return new Promise((i,n)=>{const s=this.file.slice(e.offset,e.offset+e.length),o=new FileReader;o.onload=a=>i(a.target.result),o.onerror=n,o.onabort=n,o.readAsArrayBuffer(s),t&&t.addEventListener("abort",()=>o.abort())})}}function Z0(r){return new H0(r)}function Ps(r){switch(r){case Y.BYTE:case Y.ASCII:case Y.SBYTE:case Y.UNDEFINED:return 1;case Y.SHORT:case Y.SSHORT:return 2;case Y.LONG:case Y.SLONG:case Y.FLOAT:case Y.IFD:return 4;case Y.RATIONAL:case Y.SRATIONAL:case Y.DOUBLE:case Y.LONG8:case Y.SLONG8:case Y.IFD8:return 8;default:throw new RangeError(`Invalid field type: ${r}`)}}function Y0(r){const e=r.GeoKeyDirectory;if(!e)return null;const t={};for(let i=4;i<=e[3]*4;i+=4){const n=s0[e[i]],s=e[i+1]?Kr[e[i+1]]:null,o=e[i+2],a=e[i+3];let l=null;if(!s)l=a;else{if(l=r[s],typeof l>"u"||l===null)throw new Error(`Could not get value of geoKey '${n}'.`);typeof l=="string"?l=l.substring(a,a+o-1):l.subarray&&(l=l.subarray(a,a+o),o===1&&(l=l[0]))}t[n]=l}return t}function ur(r,e,t,i){let n=null,s=null;const o=Ps(e);switch(e){case Y.BYTE:case Y.ASCII:case Y.UNDEFINED:n=new Uint8Array(t),s=r.readUint8;break;case Y.SBYTE:n=new Int8Array(t),s=r.readInt8;break;case Y.SHORT:n=new Uint16Array(t),s=r.readUint16;break;case Y.SSHORT:n=new Int16Array(t),s=r.readInt16;break;case Y.LONG:case Y.IFD:n=new Uint32Array(t),s=r.readUint32;break;case Y.SLONG:n=new Int32Array(t),s=r.readInt32;break;case Y.LONG8:case Y.IFD8:n=new Array(t),s=r.readUint64;break;case Y.SLONG8:n=new Array(t),s=r.readInt64;break;case Y.RATIONAL:n=new Uint32Array(t*2),s=r.readUint32;break;case Y.SRATIONAL:n=new Int32Array(t*2),s=r.readInt32;break;case Y.FLOAT:n=new Float32Array(t),s=r.readFloat32;break;case Y.DOUBLE:n=new Float64Array(t),s=r.readFloat64;break;default:throw new RangeError(`Invalid field type: ${e}`)}if(e===Y.RATIONAL||e===Y.SRATIONAL)for(let a=0;a<t;a+=2)n[a]=s.call(r,i+a*o),n[a+1]=s.call(r,i+(a*o+4));else for(let a=0;a<t;++a)n[a]=s.call(r,i+a*o);return e===Y.ASCII?new TextDecoder("utf-8").decode(n):n}class q0{constructor(e,t,i){this.fileDirectory=e,this.geoKeyDirectory=t,this.nextIFDByteOffset=i}}class Ni extends Error{constructor(e){super(`No image at index ${e}`),this.index=e}}class Au{async readRasters(e={}){const{window:t,width:i,height:n}=e;let{resX:s,resY:o,bbox:a}=e;const l=await this.getImage();let c=l;const u=await this.getImageCount(),h=l.getBoundingBox();if(t&&a)throw new Error('Both "bbox" and "window" passed.');if(i||n){if(t){const[d,p]=l.getOrigin(),[m,y]=l.getResolution();a=[d+t[0]*m,p+t[1]*y,d+t[2]*m,p+t[3]*y]}const g=a||h;if(i){if(s)throw new Error("Both width and resX passed");s=(g[2]-g[0])/i}if(n){if(o)throw new Error("Both width and resY passed");o=(g[3]-g[1])/n}}if(s||o){const g=[];for(let d=0;d<u;++d){const p=await this.getImage(d),{SubfileType:m,NewSubfileType:y}=p.fileDirectory;(d===0||m===2||y&1)&&g.push(p)}g.sort((d,p)=>d.getWidth()-p.getWidth());for(let d=0;d<g.length;++d){const p=g[d],m=(h[2]-h[0])/p.getWidth(),y=(h[3]-h[1])/p.getHeight();if(c=p,s&&s>m||o&&o>y)break}}let f=t;if(a){const[g,d]=l.getOrigin(),[p,m]=c.getResolution(l);f=[Math.round((a[0]-g)/p),Math.round((a[1]-d)/m),Math.round((a[2]-g)/p),Math.round((a[3]-d)/m)],f=[Math.min(f[0],f[2]),Math.min(f[1],f[3]),Math.max(f[0],f[2]),Math.max(f[1],f[3])]}return c.readRasters({...e,window:f})}}class vr extends Au{constructor(e,t,i,n,s={}){super(),this.source=e,this.littleEndian=t,this.bigTiff=i,this.firstIFDOffset=n,this.cache=s.cache||!1,this.ifdRequests=[],this.ghostValues=null}async getSlice(e,t){const i=this.bigTiff?4048:1024;return new v0((await this.source.fetch([{offset:e,length:typeof t<"u"?t:i}]))[0],e,this.littleEndian,this.bigTiff)}async parseFileDirectoryAt(e){const t=this.bigTiff?20:12,i=this.bigTiff?8:2;let n=await this.getSlice(e);const s=this.bigTiff?n.readUint64(e):n.readUint16(e),o=s*t+(this.bigTiff?16:6);n.covers(e,o)||(n=await this.getSlice(e,o));const a={};let l=e+(this.bigTiff?8:2);for(let h=0;h<s;l+=t,++h){const f=n.readUint16(l),g=n.readUint16(l+2),d=this.bigTiff?n.readUint64(l+4):n.readUint32(l+4);let p,m;const y=Ps(g),_=l+(this.bigTiff?12:8);if(y*d<=(this.bigTiff?8:4))p=ur(n,g,d,_);else{const E=n.readOffset(_),S=Ps(g)*d;if(n.covers(E,S))p=ur(n,g,d,E);else{const v=await this.getSlice(E,S);p=ur(v,g,d,E)}}d===1&&i0.indexOf(f)===-1&&!(g===Y.RATIONAL||g===Y.SRATIONAL)?m=p[0]:m=p,a[Kr[f]]=m}const c=Y0(a),u=n.readOffset(e+i+t*s);return new q0(a,c,u)}async requestIFD(e){if(this.ifdRequests[e])return this.ifdRequests[e];if(e===0)return this.ifdRequests[e]=this.parseFileDirectoryAt(this.firstIFDOffset),this.ifdRequests[e];if(!this.ifdRequests[e-1])try{this.ifdRequests[e-1]=this.requestIFD(e-1)}catch(t){throw t instanceof Ni?new Ni(e):t}return this.ifdRequests[e]=(async()=>{const t=await this.ifdRequests[e-1];if(t.nextIFDByteOffset===0)throw new Ni(e);return this.parseFileDirectoryAt(t.nextIFDByteOffset)})(),this.ifdRequests[e]}async getImage(e=0){const t=await this.requestIFD(e);return new vu(t.fileDirectory,t.geoKeyDirectory,this.dataView,this.littleEndian,this.cache,this.source)}async getImageCount(){let e=0,t=!0;for(;t;)try{await this.requestIFD(e),++e}catch(i){if(i instanceof Ni)t=!1;else throw i}return e}async getGhostValues(){const e=this.bigTiff?16:8;if(this.ghostValues)return this.ghostValues;const t="GDAL_STRUCTURAL_METADATA_SIZE=",i=t.length+100;let n=await this.getSlice(e,i);if(t===ur(n,Y.ASCII,t.length,e)){const o=ur(n,Y.ASCII,i,e).split(`
`)[0],a=Number(o.split("=")[1].split(" ")[0])+o.length;a>i&&(n=await this.getSlice(e,a));const l=ur(n,Y.ASCII,a,e);this.ghostValues={},l.split(`
`).filter(c=>c.length>0).map(c=>c.split("=")).forEach(([c,u])=>{this.ghostValues[c]=u})}return this.ghostValues}static async fromSource(e,t,i){const n=(await e.fetch([{offset:0,length:1024}],i))[0],s=new S0(n),o=s.getUint16(0,0);let a;if(o===18761)a=!0;else if(o===19789)a=!1;else throw new TypeError("Invalid byte order value.");const l=s.getUint16(2,a);let c;if(l===42)c=!1;else if(l===43){if(c=!0,s.getUint16(4,a)!==8)throw new Error("Unsupported offset byte-size.")}else throw new TypeError("Invalid magic number.");const u=c?s.getUint64(8,a):s.getUint32(4,a);return new vr(e,a,c,u,t)}close(){return typeof this.source.close=="function"?this.source.close():!1}}class K0 extends Au{constructor(e,t){super(),this.mainFile=e,this.overviewFiles=t,this.imageFiles=[e].concat(t),this.fileDirectoriesPerFile=null,this.fileDirectoriesPerFileParsing=null,this.imageCount=null}async parseFileDirectoriesPerFile(){const e=[this.mainFile.parseFileDirectoryAt(this.mainFile.firstIFDOffset)].concat(this.overviewFiles.map(t=>t.parseFileDirectoryAt(t.firstIFDOffset)));return this.fileDirectoriesPerFile=await Promise.all(e),this.fileDirectoriesPerFile}async getImage(e=0){await this.getImageCount(),await this.parseFileDirectoriesPerFile();let t=0,i=0;for(let n=0;n<this.imageFiles.length;n++){const s=this.imageFiles[n];for(let o=0;o<this.imageCounts[n];o++){if(e===t){const a=await s.requestIFD(i);return new vu(a.fileDirectory,a.geoKeyDirectory,s.dataView,s.littleEndian,s.cache,s.source)}t++,i++}i=0}throw new RangeError("Invalid image index")}async getImageCount(){if(this.imageCount!==null)return this.imageCount;const e=[this.mainFile.getImageCount()].concat(this.overviewFiles.map(t=>t.getImageCount()));return this.imageCounts=await Promise.all(e),this.imageCount=this.imageCounts.reduce((t,i)=>t+i,0),this.imageCount}}async function J0(r,e={},t){return vr.fromSource(As(r,e),t)}async function Q0(r,e){return vr.fromSource(Z0(r),e)}async function ex(r,e=[],t={},i){const n=await vr.fromSource(As(r,t),i),s=await Promise.all(e.map(o=>vr.fromSource(As(o,t))));return new K0(n,s)}const tx=`
  attribute vec4 a_position;
  attribute vec4 a_texcoord;

  uniform mat4 u_matrix;
  uniform mat4 u_textureMatrix;

  varying vec2 v_texcoord;

  void main() {
    gl_Position = u_matrix * a_position;
    vec2 texcoord = (u_textureMatrix * a_texcoord).xy;
    v_texcoord = texcoord;
  }
`,rx=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (
      v_texcoord.x < 0.0 ||
      v_texcoord.y < 0.0 ||
      v_texcoord.x > 1.0 ||
      v_texcoord.y > 1.0
    ) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;class ix{constructor(e){this.gl_=e,this.program_=Ls(e,rx,tx),this.positionLocation=e.getAttribLocation(this.program_,"a_position"),this.texcoordLocation=e.getAttribLocation(this.program_,"a_texcoord"),this.matrixLocation=e.getUniformLocation(this.program_,"u_matrix"),this.textureMatrixLocation=e.getUniformLocation(this.program_,"u_textureMatrix"),this.textureLocation=e.getUniformLocation(this.program_,"u_texture"),this.positionBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.positionBuffer),this.positions=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.positions),e.STATIC_DRAW),this.texcoordBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.texcoordBuffer),this.texcoords=[0,0,0,1,1,0,1,0,0,1,1,1],e.bufferData(e.ARRAY_BUFFER,new Float32Array(this.texcoords),e.STATIC_DRAW)}drawImage(e,t,i,n,s,o,a,l,c,u,h,f,g){const d=this.gl_;l===void 0&&(l=n),c===void 0&&(c=s),o===void 0&&(o=t),a===void 0&&(a=i),u===void 0&&(u=o),h===void 0&&(h=a),f===void 0&&(f=d.canvas.width),g===void 0&&(g=d.canvas.height),d.bindTexture(d.TEXTURE_2D,e),d.useProgram(this.program_),d.bindBuffer(d.ARRAY_BUFFER,this.positionBuffer),d.enableVertexAttribArray(this.positionLocation),d.vertexAttribPointer(this.positionLocation,2,d.FLOAT,!1,0,0),d.bindBuffer(d.ARRAY_BUFFER,this.texcoordBuffer),d.enableVertexAttribArray(this.texcoordLocation),d.vertexAttribPointer(this.texcoordLocation,2,d.FLOAT,!1,0,0);let p=Es(0,f,0,g,-1,1);p=Gm(p,l,c,0),p=Za(p,u,h,1),d.uniformMatrix4fv(this.matrixLocation,!1,p);let m=zm(n/t,s/i,0);m=Za(m,o/t,a/i,1),d.uniformMatrix4fv(this.textureMatrixLocation,!1,m),d.uniform1i(this.textureLocation,0),d.drawArrays(d.TRIANGLES,0,this.positions.length/2)}}function hl(r,e,t){const i=r.createShader(e);if(i===null)throw new Error("Shader compilation failed");if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS)){const n=r.getShaderInfoLog(i);throw n===null?new Error("Shader info log creation failed"):new Error(n)}return i}function Ls(r,e,t){const i=r.createProgram(),n=hl(r,r.VERTEX_SHADER,t),s=hl(r,r.FRAGMENT_SHADER,e);if(i===null)throw new Error("Program creation failed");if(r.attachShader(i,n),r.attachShader(i,s),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))throw r.getProgramInfoLog(i)===null?new Error("Program info log creation failed"):new Error;return i}const nx=`
  attribute vec4 a_position;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
  }
`,sx=`
  precision mediump float;

  uniform vec4 u_val;
  void main() {
     gl_FragColor = u_val;
  }
`,ox=`
  attribute vec4 a_position;
  attribute vec2 a_texcoord;

  varying vec2 v_texcoord;

  uniform mat4 u_matrix;

  void main() {
     gl_Position = u_matrix * a_position;
     v_texcoord = a_texcoord;
  }
`,ax=`
  precision mediump float;

  varying vec2 v_texcoord;

  uniform sampler2D u_texture;

  void main() {
    if (v_texcoord.x < 0.0 || v_texcoord.x > 1.0 || v_texcoord.y < 0.0 || v_texcoord.y > 1.0) {
      discard;
    }
    gl_FragColor = texture2D(u_texture, v_texcoord);
  }
`;function lx(r,e,t,i){let n;return t&&t.length?n=t.shift():Ch?n=new OffscreenCanvas(r||300,e||300):n=document.createElement("canvas"),r&&(n.width=r),e&&(n.height=e),n.getContext("webgl",i)}function cx(r){const e=r.canvas;e.width=1,e.height=1,r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT)}const fl=[];function ux(r,e,t,i,n,s,o,a,l,c,u,h,f,g){const d=Math.round(i*e),p=Math.round(i*t);r.canvas.width=d,r.canvas.height=p;let m,y;if(y=r.createTexture(),r.bindTexture(r.TEXTURE_2D,y),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),f?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,d,p,0,r.RGBA,u,null),m=r.createFramebuffer(),r.bindFramebuffer(r.FRAMEBUFFER,m),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,y,0),m===null)throw new Error("Could not create framebuffer");if(y===null)throw new Error("Could not create texture");if(l.length===0)return{width:d,height:p,framebuffer:m,texture:y};const _=di();l.forEach(function(R,U,M){Cf(_,R.extent)});let E,S,v;const w=1/n;{if(E=r.createTexture(),y===null)throw new Error("Could not create texture");S=Math.round(Fe(_)*w),v=Math.round(ot(_)*w);const R=r.getParameter(r.MAX_TEXTURE_SIZE),U=Math.max(S,v),M=U>R?R/U:1,z=Math.round(S*M),N=Math.round(v*M);r.bindTexture(r.TEXTURE_2D,E),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),f?(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR)):(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST)),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,z,N,0,r.RGBA,u,null);const G=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,G),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,E,0);const ie=new ix(r);l.forEach(function(W,q,ne){const ae=(W.extent[0]-_[0])*w*M,pe=-(W.extent[3]-_[3])*w*M,be=Fe(W.extent)*w*M,me=ot(W.extent)*w*M;if(r.bindFramebuffer(r.FRAMEBUFFER,G),r.viewport(0,0,z,N),W.clipExtent){const we=(W.clipExtent[0]-_[0])*w*M,Le=-(W.clipExtent[3]-_[3])*w*M,Ae=Fe(W.clipExtent)*w*M,Me=ot(W.clipExtent)*w*M;r.enable(r.SCISSOR_TEST),r.scissor(f?we:Math.round(we),f?Le:Math.round(Le),f?Ae:Math.round(we+Ae)-Math.round(we),f?Me:Math.round(Le+Me)-Math.round(Le))}ie.drawImage(W.texture,W.width,W.height,c,c,W.width-2*c,W.height-2*c,f?ae:Math.round(ae),f?pe:Math.round(pe),f?be:Math.round(ae+be)-Math.round(ae),f?me:Math.round(pe+me)-Math.round(pe),z,N),r.disable(r.SCISSOR_TEST)}),r.deleteFramebuffer(G)}const A=ds(o),C=ds(_),P=R=>{const U=(R[0][0]-A[0])/s*i,M=-(R[0][1]-A[1])/s*i,z=(R[1][0]-A[0])/s*i,N=-(R[1][1]-A[1])/s*i,G=(R[2][0]-A[0])/s*i,ie=-(R[2][1]-A[1])/s*i;return{u1:z,v1:N,u0:U,v0:M,u2:G,v2:ie}};r.bindFramebuffer(r.FRAMEBUFFER,m),r.viewport(0,0,d,p);{const R=[],U=[],M=Ls(r,ax,ox);r.useProgram(M);const z=r.getUniformLocation(M,"u_texture");r.bindTexture(r.TEXTURE_2D,E),r.uniform1i(z,0),a.getTriangles().forEach(function(ae,pe,be){const me=ae.source,we=ae.target,{u1:Le,v1:Ae,u0:Me,v0:ir,u2:nr,v2:Tt}=P(we),Ai=(me[0][0]-C[0])/n/S,Pi=-(me[0][1]-C[1])/n/v,sh=(me[1][0]-C[0])/n/S,oh=-(me[1][1]-C[1])/n/v,ah=(me[2][0]-C[0])/n/S,lh=-(me[2][1]-C[1])/n/v;R.push(Le,Ae,Me,ir,nr,Tt),U.push(sh,oh,Ai,Pi,ah,lh)});const N=Es(0,d,p,0,-1,1),G=r.getUniformLocation(M,"u_matrix");r.uniformMatrix4fv(G,!1,N);const ie=r.getAttribLocation(M,"a_position"),W=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,W),r.bufferData(r.ARRAY_BUFFER,new Float32Array(R),r.STATIC_DRAW),r.vertexAttribPointer(ie,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(ie);const q=r.getAttribLocation(M,"a_texcoord"),ne=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,ne),r.bufferData(r.ARRAY_BUFFER,new Float32Array(U),r.STATIC_DRAW),r.vertexAttribPointer(q,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(q),r.drawArrays(r.TRIANGLES,0,R.length/2)}if(h){const R=Ls(r,sx,nx);r.useProgram(R);const U=Es(0,d,p,0,-1,1),M=r.getUniformLocation(R,"u_matrix");r.uniformMatrix4fv(M,!1,U);const z=Array.isArray(h)?h:[0,0,0,255],N=r.getUniformLocation(R,"u_val");r.uniform4fv(N,z);const G=r.getAttribLocation(R,"a_position"),ie=r.createBuffer();r.bindBuffer(r.ARRAY_BUFFER,ie),r.vertexAttribPointer(G,2,r.FLOAT,!1,0,0),r.enableVertexAttribArray(G);const W=a.getTriangles().reduce(function(q,ne){const ae=ne.target,{u1:pe,v1:be,u0:me,v0:we,u2:Le,v2:Ae}=P(ae);return q.concat([pe,be,me,we,me,we,Le,Ae,Le,Ae,pe,be])},[]);r.bufferData(r.ARRAY_BUFFER,new Float32Array(W),r.STATIC_DRAW),r.drawArrays(r.LINES,0,W.length/2)}return{width:d,height:p,framebuffer:m,texture:y}}class hx extends zs{constructor(e){super({tileCoord:e.tileCoord,loader:()=>Promise.resolve(new Uint8ClampedArray(4)),interpolate:e.interpolate,transition:e.transition}),this.renderEdges_=e.renderEdges!==void 0?e.renderEdges:!1,this.pixelRatio_=e.pixelRatio,this.gutter_=e.gutter,this.reprojData_=null,this.reprojError_=null,this.reprojSize_=void 0,this.sourceTileGrid_=e.sourceTileGrid,this.targetTileGrid_=e.targetTileGrid,this.wrappedTileCoord_=e.wrappedTileCoord||e.tileCoord,this.sourceTiles_=[],this.sourcesListenerKeys_=null,this.sourceZ_=0;const t=e.sourceProj,i=t.getExtent(),n=e.sourceTileGrid.getExtent();this.clipExtent_=t.canWrapX()?n?Et(i,n):i:n;const s=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),o=this.targetTileGrid_.getExtent();let a=this.sourceTileGrid_.getExtent();const l=o?Et(s,o):s;if(ga(l)===0){this.state=K.EMPTY;return}i&&(a?a=Et(a,i):a=i);const c=this.targetTileGrid_.getResolution(this.wrappedTileCoord_[0]),u=e.targetProj,h=Fh(t,u,l,c);if(!isFinite(h)||h<=0){this.state=K.EMPTY;return}const f=e.errorThreshold!==void 0?e.errorThreshold:Oh;if(this.triangulation_=new Mh(t,u,l,a,h*f,c,e.transformMatrix),this.triangulation_.getTriangles().length===0){this.state=K.EMPTY;return}this.sourceZ_=this.sourceTileGrid_.getZForResolution(h);let g=this.triangulation_.calculateSourceExtent();if(a&&(t.canWrapX()?(g[1]=Ee(g[1],a[1],a[3]),g[3]=Ee(g[3],a[1],a[3])):g=Et(g,a)),!ga(g))this.state=K.EMPTY;else{let d=0,p=0;t.canWrapX()&&(d=Fe(i),p=Math.floor((g[0]-i[0])/d)),Ff(g.slice(),t,!0).forEach(y=>{const _=this.sourceTileGrid_.getTileRangeForExtentAndZ(y,this.sourceZ_),E=e.getTileFunction;for(let S=_.minX;S<=_.maxX;S++)for(let v=_.minY;v<=_.maxY;v++){const w=E(this.sourceZ_,S,v,this.pixelRatio_);if(w){const A=p*d;this.sourceTiles_.push({tile:w,offset:A})}}++p}),this.sourceTiles_.length===0&&(this.state=K.EMPTY)}}getSize(){return this.reprojSize_}getData(){return this.reprojData_}getError(){return this.reprojError_}reproject_(){const e=[];let t=!1;if(this.sourceTiles_.forEach(S=>{var pe;const v=S.tile;if(!v||v.getState()!==K.LOADED)return;const w=v.getSize(),A=this.gutter_;let C;const P=os(v.getData());P?C=P:(t=!0,C=Nh(as(v.getData())));const R=[w[0]+2*A,w[1]+2*A],U=C instanceof Float32Array,M=R[0]*R[1],z=U?Float32Array:Uint8ClampedArray,N=new z(C.buffer),G=z.BYTES_PER_ELEMENT,ie=G*N.length/M,W=N.byteLength/R[1],q=Math.floor(W/G/R[0]),ne=this.sourceTileGrid_.getTileCoordExtent(v.tileCoord);ne[0]+=S.offset,ne[2]+=S.offset;const ae=(pe=this.clipExtent_)==null?void 0:pe.slice();ae&&(ae[0]+=S.offset,ae[2]+=S.offset),e.push({extent:ne,clipExtent:ae,data:N,dataType:z,bytesPerPixel:ie,pixelSize:R,bandCount:q})}),this.sourceTiles_.length=0,e.length===0){this.state=K.ERROR,this.changed();return}const i=this.wrappedTileCoord_[0],n=this.targetTileGrid_.getTileSize(i),s=typeof n=="number"?n:n[0],o=typeof n=="number"?n:n[1],a=s*this.pixelRatio_,l=o*this.pixelRatio_,c=this.targetTileGrid_.getResolution(i),u=this.sourceTileGrid_.getResolution(this.sourceZ_),h=this.targetTileGrid_.getTileCoordExtent(this.wrappedTileCoord_),f=e[0].bandCount,g=new e[0].dataType(f*a*l),d=lx(a,l,fl,{premultipliedAlpha:!1,antialias:!1});let p;const m=d.RGBA;let y;e[0].dataType==Float32Array?(y=d.FLOAT,d.getExtension("WEBGL_color_buffer_float"),d.getExtension("OES_texture_float"),d.getExtension("EXT_float_blend"),p=d.getExtension("OES_texture_float_linear")!==null&&this.interpolate):(y=d.UNSIGNED_BYTE,p=this.interpolate);const _=4,E=Math.ceil(f/_);for(let S=E-1;S>=0;--S){const v=[];for(let z=0,N=e.length;z<N;++z){const G=e[z],ie=G.pixelSize,W=ie[0],q=ie[1],ne=new G.dataType(_*W*q),ae=G.data;let pe=S*_;for(let me=0,we=ne.length;me<we;me+=_)ne[me]=ae[pe],ne[me+1]=ae[pe+1],ne[me+2]=ae[pe+2],ne[me+3]=ae[pe+3],pe+=f;const be=d.createTexture();d.bindTexture(d.TEXTURE_2D,be),p?(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.LINEAR),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.LINEAR)):(d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST)),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,m,W,q,0,m,y,ne),v.push({extent:G.extent,clipExtent:G.clipExtent,texture:be,width:W,height:q})}const{framebuffer:w,width:A,height:C}=ux(d,s,o,this.pixelRatio_,u,c,h,this.triangulation_,v,this.gutter_,y,this.renderEdges_,p),P=A,R=C*_,U=new e[0].dataType(P*R);d.bindFramebuffer(d.FRAMEBUFFER,w),d.readPixels(0,0,A,C,d.RGBA,y,U);let M=S*_;for(let z=0,N=U.length;z<N;z+=_){const G=(P-1-(z/R|0))*R+z%R;g[M]=U[G],g[M+1]=U[G+1],g[M+2]=U[G+2],g[M+3]=U[G+3],M+=f}}if(cx(d),fl.push(d.canvas),t){const S=zt(s,o),v=new ImageData(g,s);S.putImageData(v,0,0),this.reprojData_=S.canvas}else this.reprojData_=g;this.reprojSize_=[Math.round(a),Math.round(l)],this.state=K.LOADED,this.changed()}load(){if(this.state!==K.IDLE&&this.state!==K.ERROR)return;this.state=K.LOADING,this.changed();let e=0;this.sourcesListenerKeys_=[],this.sourceTiles_.forEach(({tile:t})=>{const i=t.getState();if(i!==K.IDLE&&i!==K.LOADING)return;e++;const n=Rt(t,ze.CHANGE,()=>{const s=t.getState();(s==K.LOADED||s==K.ERROR||s==K.EMPTY)&&(rn(n),e--,e===0&&(this.unlistenSources_(),this.reproject_()))});this.sourcesListenerKeys_.push(n)}),e===0?setTimeout(this.reproject_.bind(this),0):this.sourceTiles_.forEach(function({tile:t}){t.getState()==K.IDLE&&t.load()})}unlistenSources_(){this.sourcesListenerKeys_.forEach(rn),this.sourcesListenerKeys_=null}}class bi extends $s{constructor(e){const t=e.projection===void 0?"EPSG:3857":e.projection;let i=e.tileGrid;i===void 0&&t&&(i=ui({extent:hi(t),maxResolution:e.maxResolution,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize})),super({cacheSize:.1,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,projection:t,tileGrid:i,state:e.state,wrapX:e.wrapX,transition:e.transition,interpolate:e.interpolate,key:e.key,zDirection:e.zDirection}),this.gutter_=e.gutter!==void 0?e.gutter:0,this.tileSize_=e.tileSize?st(e.tileSize):null,this.tileSizes_=null,this.tileLoadingKeys_={},this.loader_=e.loader,this.handleTileChange_=this.handleTileChange_.bind(this),this.bandCount=e.bandCount===void 0?4:e.bandCount,this.tileGridForProjection_={},this.crossOrigin_=e.crossOrigin||"anonymous",this.transformMatrix=null}setTileSizes(e){this.tileSizes_=e}getTileSize(e){if(this.tileSizes_)return this.tileSizes_[e];if(this.tileSize_)return this.tileSize_;const t=this.getTileGrid();return t?st(t.getTileSize(e)):[256,256]}getGutterForProjection(e){const t=this.getProjection();return(!t||ki(t,e))&&!this.transformMatrix?this.gutter_:0}setLoader(e){this.loader_=e}getReprojTile_(e,t,i,n,s){const o=this.tileGrid||this.getTileGridForProjection(s||n),a=Math.max.apply(null,o.getResolutions().map((g,d)=>{const p=st(o.getTileSize(d)),m=this.getTileSize(d);return Math.max(m[0]/p[0],m[1]/p[1])})),l=this.getTileGridForProjection(n),c=[e,t,i],u=this.getTileCoordForTileUrlFunction(c,n),h=Object.assign({sourceProj:s||n,sourceTileGrid:o,targetProj:n,targetTileGrid:l,tileCoord:c,wrappedTileCoord:u,pixelRatio:a,gutter:this.gutter_,getTileFunction:(g,d,p,m)=>this.getTile(g,d,p,m),transformMatrix:this.transformMatrix},this.tileOptions),f=new hx(h);return f.key=this.getKey(),f}getTile(e,t,i,n,s){var E;const o=this.getProjection();if(s&&(o&&!ki(o,s)||this.transformMatrix))return this.getReprojTile_(e,t,i,s,o);const a=this.getTileSize(e),l=this.loader_,c=new AbortController,u={signal:c.signal,crossOrigin:this.crossOrigin_},h=this.getTileCoordForTileUrlFunction([e,t,i]);if(!h)return null;const f=h[0],g=h[1],d=h[2],p=(E=this.getTileGrid())==null?void 0:E.getFullTileRange(f);p&&(u.maxY=p.getHeight()-1);function m(){return Of(function(){return l(f,g,d,u)})}const y=Object.assign({tileCoord:[e,t,i],loader:m,size:a,controller:c},this.tileOptions),_=new zs(y);return _.key=this.getKey(),_.addEventListener(ze.CHANGE,this.handleTileChange_),_}handleTileChange_(e){const t=e.target,i=he(t),n=t.getState();let s;n==K.LOADING?(this.tileLoadingKeys_[i]=!0,s=kn.TILELOADSTART):i in this.tileLoadingKeys_&&(delete this.tileLoadingKeys_[i],s=n==K.ERROR?kn.TILELOADERROR:n==K.LOADED?kn.TILELOADEND:void 0),s&&this.dispatchEvent(new Dh(s,t))}getTileGridForProjection(e){const t=this.getProjection();if(this.tileGrid&&(!t||ki(t,e))&&!this.transformMatrix)return this.tileGrid;const i=he(e);return i in this.tileGridForProjection_||(this.tileGridForProjection_[i]=Uh(e)),this.tileGridForProjection_[i]}setTileGridForProjection(e,t){const i=ce(e);if(i){const n=he(i);n in this.tileGridForProjection_||(this.tileGridForProjection_[n]=t)}}}function fx(r){return((r.fileDirectory.NewSubfileType||0)&4)===4}function dx(r,e){if(!r)return!1;if(r===!0)return!0;if(e.getSamplesPerPixel()!==3)return!1;const t=e.fileDirectory.PhotometricInterpretation,i=$e;return t===i.CMYK||t===i.YCbCr||t===i.CIELab||t===i.ICCLab}const dl="STATISTICS_MAXIMUM",gl="STATISTICS_MINIMUM",ts=256;let rs;function gx(){return rs||(rs=new A0),rs}function px(r){try{return r.getBoundingBox(!0)}catch{return[0,0,r.getWidth(),r.getHeight()]}}function mx(r){try{return r.getOrigin().slice(0,2)}catch{return[0,r.getHeight()]}}function _x(r,e){try{return r.getResolution(e)}catch{return[e.getWidth()/r.getWidth(),e.getHeight()/r.getHeight()]}}function yx(r){const e=r.geoKeys;if(!e)return null;if(e.ProjectedCSTypeGeoKey&&e.ProjectedCSTypeGeoKey!==32767){const t="EPSG:"+e.ProjectedCSTypeGeoKey;let i=ce(t);if(!i){const n=ha(e.ProjLinearUnitsGeoKey);n&&(i=new fa({code:t,units:n}))}return i}if(e.GeographicTypeGeoKey&&e.GeographicTypeGeoKey!==32767){const t="EPSG:"+e.GeographicTypeGeoKey;let i=ce(t);if(!i){const n=ha(e.GeogAngularUnitsGeoKey);n&&(i=new fa({code:t,units:n}))}return i}return null}function xx(r){return r.getImageCount().then(function(e){const t=new Array(e);for(let i=0;i<e;++i)t[i]=r.getImage(i);return Promise.all(t)})}function Ex(r,e){let t;return r.blob?t=Q0(r.blob):r.overviews?t=ex(r.url,r.overviews,e):t=J0(r.url,e),t.then(xx)}function Xr(r,e,t,i,n){if(Array.isArray(r)){const s=r.length;if(!Array.isArray(e)||s!=e.length){const o=new Error(i);throw n(o),o}for(let o=0;o<s;++o)Xr(r[o],e[o],t,i,n);return}if(e=e,Math.abs(r-e)>t*r)throw new Error(i)}function bx(r){return r instanceof Int8Array?-128:r instanceof Int16Array?-32768:r instanceof Int32Array?-2147483648:r instanceof Float32Array?12e-39:0}function Tx(r){return r instanceof Int8Array?127:r instanceof Uint8Array||r instanceof Uint8ClampedArray?255:r instanceof Int16Array?32767:r instanceof Uint16Array?65535:r instanceof Int32Array?2147483647:r instanceof Uint32Array?4294967295:r instanceof Float32Array?34e37:255}class Vo extends bi{constructor(e){super({state:"loading",tileGrid:null,projection:e.projection||null,transition:e.transition,interpolate:e.interpolate!==!1,wrapX:e.wrapX}),this.sourceInfo_=e.sources;const t=this.sourceInfo_.length;this.sourceOptions_=e.sourceOptions,this.sourceImagery_=new Array(t),this.sourceMasks_=new Array(t),this.resolutionFactors_=new Array(t),this.samplesPerPixel_,this.nodataValues_,this.metadata_,this.normalize_=e.normalize!==!1,this.addAlpha_=!1,this.error_=null,this.convertToRGB_=e.convertToRGB||!1,this.setKey(this.sourceInfo_.map(s=>s.url).join(","));const i=this,n=new Array(t);for(let s=0;s<t;++s)n[s]=Ex(this.sourceInfo_[s],this.sourceOptions_);Promise.all(n).then(function(s){i.configure_(s)}).catch(function(s){ni(s),i.error_=s,i.setState("error")})}getError(){return this.error_}determineProjection(e){const t=e[0];for(let i=t.length-1;i>=0;--i){const n=t[i],s=yx(n);if(s){this.projection=s;break}}}determineTransformMatrix(e){const t=e[0];for(let i=t.length-1;i>=0;--i){const s=t[i].fileDirectory.ModelTransformation;if(s){const[o,a,l,c,u,h,f,g]=s,d=ri(ri([1/Math.sqrt(o*o+u*u),0,0,-1/Math.sqrt(a*a+h*h),c,g],[o,u,a,h,0,0]),[1,0,0,1,-c,-g]);this.transformMatrix=d,this.addAlpha_=!0;break}}}configure_(e){let t,i,n,s,o;const a=new Array(e.length),l=new Array(e.length),c=new Array(e.length);let u=0;const h=e.length;for(let m=0;m<h;++m){const y=[],_=[];e[m].forEach(P=>{fx(P)?_.push(P):y.push(P)});const E=y.length;if(_.length>0&&_.length!==E)throw new Error(`Expected one mask per image found ${_.length} masks and ${E} images`);let S,v;const w=new Array(E),A=new Array(E),C=new Array(E);l[m]=new Array(E),c[m]=new Array(E);for(let P=0;P<E;++P){const R=y[P],U=R.getGDALNoData();c[m][P]=R.getGDALMetadata(0),l[m][P]=U;const M=this.sourceInfo_[m].bands;a[m]=M?M.length:R.getSamplesPerPixel();const z=E-(P+1);S||(S=px(R)),v||(v=mx(R));const N=_x(R,y[0]);C[z]=N[0];const G=[R.getTileWidth(),R.getTileHeight()];G[0]!==G[1]&&G[1]<ts&&(G[0]=ts,G[1]=ts),w[z]=G;const ie=N[0]/Math.abs(N[1]);A[z]=[G[0],G[1]/ie]}if(t?Et(t,S,t):t=S,!i)i=v;else{const P=`Origin mismatch for source ${m}, got [${v}] but expected [${i}]`;Xr(i,v,0,P,this.viewRejector)}if(!o)o=C,this.resolutionFactors_[m]=1;else{o.length-u>C.length&&(u=o.length-C.length);const P=o[o.length-1]/C[C.length-1];this.resolutionFactors_[m]=P;const R=C.map(M=>M*=P),U=`Resolution mismatch for source ${m}, got [${R}] but expected [${o}]`;Xr(o.slice(u,o.length),R,.02,U,this.viewRejector)}n?Xr(n.slice(u,n.length),A,.01,`Tile size mismatch for source ${m}`,this.viewRejector):n=A,s?Xr(s.slice(u,s.length),w,0,`Tile size mismatch for source ${m}`,this.viewRejector):s=w,this.sourceImagery_[m]=y.reverse(),this.sourceMasks_[m]=_.reverse()}for(let m=0,y=this.sourceImagery_.length;m<y;++m){const _=this.sourceImagery_[m];for(;_.length<o.length;)_.unshift(void 0)}this.getProjection()||this.determineProjection(e),this.determineTransformMatrix(e),this.samplesPerPixel_=a,this.nodataValues_=l,this.metadata_=c;e:for(let m=0;m<h;++m){if(this.sourceInfo_[m].nodata!==void 0){this.addAlpha_=!0;break}if(this.sourceMasks_[m].length){this.addAlpha_=!0;break}const y=l[m],_=this.sourceInfo_[m].bands;if(_){for(let E=0;E<_.length;++E)if(y[_[E]-1]!==null){this.addAlpha_=!0;break e}continue}for(let E=0;E<y.length;++E)if(y[E]!==null){this.addAlpha_=!0;break e}}let f=this.addAlpha_?1:0;for(let m=0;m<h;++m)f+=a[m];this.bandCount=f;const g=new Sn({extent:t,minZoom:u,origin:i,resolutions:o,tileSizes:n});this.tileGrid=g,this.setTileSizes(s),this.setLoader(this.loadTile_.bind(this)),this.setState("ready");const d=1;o.length===2?o=[o[0],o[1],o[1]/2]:o.length===1&&(o=[o[0]*2,o[0],o[0]/2]);let p=t;if(this.transformMatrix){const m=ii(Ce(),this.transformMatrix.slice()),y=_f(_=>It(m,_));p=br(t,y)}this.viewResolver({showFullExtent:!0,projection:this.projection,resolutions:o,center:xf(Bt(p),this.projection),extent:yf(p,this.projection),zoom:d})}loadTile_(e,t,i,n){const s=this.getTileSize(e),o=this.sourceImagery_.length,a=new Array(o*2),l=this.nodataValues_,c=this.sourceInfo_,u=gx();for(let h=0;h<o;++h){const f=c[h],g=this.resolutionFactors_[h],d=[Math.round(t*(s[0]*g)),Math.round(i*(s[1]*g)),Math.round((t+1)*(s[0]*g)),Math.round((i+1)*(s[1]*g))],p=this.sourceImagery_[h][e];let m;f.bands&&(m=f.bands.map(function(v){return v-1}));let y;"nodata"in f&&f.nodata!==null?y=f.nodata:m?y=m.map(function(v){return l[h][v]}):y=l[h];const _={window:d,width:s[0],height:s[1],samples:m,fillValue:y,pool:u,interleave:!1,signal:n.signal};dx(this.convertToRGB_,p)?a[h]=p.readRGB(_):a[h]=p.readRasters(_);const E=o+h,S=this.sourceMasks_[h][e];if(!S){a[E]=Promise.resolve(null);continue}a[E]=S.readRasters({window:d,width:s[0],height:s[1],samples:[0],pool:u,interleave:!1})}return Promise.all(a).then(this.composeTile_.bind(this,s)).catch(function(h){throw ni(h),h})}composeTile_(e,t){const i=this.metadata_,n=this.sourceInfo_,s=this.sourceImagery_.length,o=this.bandCount,a=this.samplesPerPixel_,l=this.nodataValues_,c=this.normalize_,u=this.addAlpha_,h=e[0]*e[1],f=h*o;let g;c?g=new Uint8Array(f):g=new Float32Array(f);let d=0;for(let p=0;p<h;++p){let m=u;for(let y=0;y<s;++y){const _=n[y];let E=_.min,S=_.max,v,w;if(c){const A=i[y][0];E===void 0&&(A&&gl in A?E=parseFloat(A[gl]):E=bx(t[y][0])),S===void 0&&(A&&dl in A?S=parseFloat(A[dl]):S=Tx(t[y][0])),v=255/(S-E),w=-E*v}for(let A=0;A<a[y];++A){const C=t[y][A][p];let P;if(c?P=Ee(v*C+w,0,255):P=C,!u)g[d]=P;else{let R=_.nodata;if(R===void 0){let M;_.bands?M=_.bands[A]-1:M=A,R=l[y][M]}const U=isNaN(R);(!U&&C!==R||U&&!isNaN(C))&&(m=!1,g[d]=P)}d++}if(!m){const A=s+y,C=t[A];C&&!C[0][p]&&(m=!0)}}u&&(m||(g[d]=255),d++)}return g}}Vo.prototype.getView;class ye{constructor(e){this.name=e}toString(){return this.name}}ye.GeoTIFF=new ye("GeoTIFF");ye.ImageStatic=new ye("ImageStatic");ye.PMTilesRaster=new ye("PMTilesRaster");ye.PMTilesVector=new ye("PMTilesVector");ye.TileJSON=new ye("TileJSON");ye.TileWMS=new ye("TileWMS");ye.WMTS=new ye("WMTS");ye.XYZ=new ye("XYZ");function wx(r){const e=r.load||Lr,t=r.imageExtent,i=r.crossOrigin??null;return()=>{const n=new Image;return n.crossOrigin=i,e(n,r.url).then(s=>{const o=Fe(t)/s.width,a=ot(t)/s.height;return{image:s,extent:t,resolution:o!==a?[o,a]:a,pixelRatio:1}})}}class Pu extends tr{constructor(e){const t=e.crossOrigin!==void 0?e.crossOrigin:null,i=e.imageLoadFunction!==void 0?e.imageLoadFunction:Vs;super({attributions:e.attributions,interpolate:e.interpolate,projection:ce(e.projection)}),this.url_=e.url,this.imageExtent_=e.imageExtent,this.image=null,this.image=new Wl(this.imageExtent_,void 0,1,wx({url:e.url,imageExtent:e.imageExtent,crossOrigin:t,load:(n,s)=>(this.image.setImage(n),i(this.image,s),Lr(n))})),this.image.addEventListener(ze.CHANGE,this.handleImageChange.bind(this))}getImageExtent(){return this.imageExtent_}getImageInternal(e,t,i,n){return Er(e,this.image.getExtent())?this.image:null}getUrl(){return this.url_}}function Xo(r,e,t,i){const n=document.createElement("script"),s="olc_"+he(e);function o(){delete window[s],n.parentNode.removeChild(n)}n.async=!0,n.src=r+(r.includes("?")?"&":"?")+"callback="+s;const a=setTimeout(function(){o(),t&&t()},1e4);window[s]=function(l){clearTimeout(a),o(),e(l)},document.head.appendChild(n)}class Sx extends Error{constructor(e){const t="Unexpected response status: "+e.status;super(t),this.name="ResponseError",this.response=e}}class vx extends Error{constructor(e){super("Failed to issue request"),this.name="ClientError",this.client=e}}function Lu(r){return new Promise(function(e,t){function i(o){const a=o.target;if(!a.status||a.status>=200&&a.status<300){let l;try{l=JSON.parse(a.responseText)}catch(c){const u="Error parsing response text as JSON: "+c.message;t(new Error(u));return}e(l);return}t(new Sx(a))}function n(o){t(new vx(o.target))}const s=new XMLHttpRequest;s.addEventListener("load",i),s.addEventListener("error",n),s.open("GET",r),s.setRequestHeader("Accept","application/json"),s.send()})}function Iu(r,e){return e.includes("://")?e:new URL(e,r).href}class Cu extends Ft{constructor(e){if(super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:ce("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.tileJSON_=null,this.tileSize_=e.tileSize,e.url)if(e.jsonp)Xo(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let i;try{i=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(i)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTileJSON(){return this.tileJSON_}handleTileJSONResponse(e){const t=ce("EPSG:4326"),i=this.getProjection();let n;if(e.bounds!==void 0){const c=Ks(t,i);n=br(e.bounds,c)}const s=hi(i),o=e.minzoom||0,a=e.maxzoom||22,l=ui({extent:s,maxZoom:a,minZoom:o,tileSize:this.tileSize_});if(this.tileGrid=l,this.tileUrlFunction=jl(e.tiles,l),e.attribution&&!this.getAttributions()){const c=n!==void 0?n:s;this.setAttributions(function(u){return Er(c,u.extent)?[e.attribution]:null})}this.tileJSON_=e,this.setState("ready")}handleTileJSONError(){this.setState("error")}}var Is=Hf;const Wo="1.1.0",L=!0,k={classification:"https://stac-extensions.github.io/classification/v2.0.0/schema.json",datacube:"https://stac-extensions.github.io/datacube/v2.2.0/schema.json",eo:"https://stac-extensions.github.io/eo/v2.0.0/schema.json",file:"https://stac-extensions.github.io/file/v2.1.0/schema.json","item-assets":"https://stac-extensions.github.io/item-assets/v1.0.0/schema.json",label:"https://stac-extensions.github.io/label/v1.0.1/schema.json",pointcloud:"https://stac-extensions.github.io/pointcloud/v1.0.0/schema.json",processing:"https://stac-extensions.github.io/processing/v1.2.0/schema.json",projection:"https://stac-extensions.github.io/projection/v2.0.0/schema.json",raster:"https://stac-extensions.github.io/raster/v2.0.0/schema.json",sar:"https://stac-extensions.github.io/sar/v1.0.0/schema.json",sat:"https://stac-extensions.github.io/sat/v1.0.0/schema.json",scientific:"https://stac-extensions.github.io/scientific/v1.0.0/schema.json",table:"https://stac-extensions.github.io/table/v1.2.0/schema.json",timestamps:"https://stac-extensions.github.io/timestamps/v1.1.0/schema.json",version:"https://stac-extensions.github.io/version/v1.2.0/schema.json",view:"https://stac-extensions.github.io/view/v1.0.0/schema.json"},Jt={itemAndCollection:{"classification:":k.classification,"cube:":k.datacube,"eo:":k.eo,"file:":k.file,"label:":k.label,"pc:":k.pointcloud,"processing:":k.processing,"proj:":k.projection,"raster:":k.raster,"sar:":k.sar,"sat:":k.sat,"sci:":k.scientific,"view:":k.view,version:k.version,deprecated:k.version,published:k.timestamps,expires:k.timestamps,unpublished:k.timestamps},catalog:{},collection:{},item:{}};Jt.collection=Object.assign(Jt.collection,Jt.itemAndCollection);Jt.item=Object.assign(Jt.item,Jt.itemAndCollection);var Wr={parseExtension(r){let e=r.match(/^https?:\/\/stac-extensions.github.io\/([^\/]+)\/v([^\/]+)\/[^.]+.json$/i);if(e)return{id:e[1],version:e[2]};let t=r.match(/(\d+\.\d+(\.\d+)([a-z_.-][\w.-]+)?)/i);if(t)return{id:r,version:t[1]};if(r in k)return{id:r,version:"0.0.0"}}},J={version:Wo,extensions:{},set(r){if(typeof r.stac_version!="string"?J.version="0.6.0":J.version=r.stac_version,Array.isArray(r.stac_extensions))for(let e of r.stac_extensions){let t=Wr.parseExtension(e);t&&(J.extensions[t.id]=t.version)}},before(r,e=null){return J.compare("<",r,e)},compare(r,e,t=null){let i=t?J.extensions[t]:J.version;return typeof i>"u"?!1:Is.compare(i,e,r)}},x={type(r){let e=typeof r;if(e==="object"){if(r===null)return"null";if(Array.isArray(r))return"array"}return e},is(r,e){return Array.isArray(e)?e.includes(x.type(r)):x.type(r)===e},isDefined(r){return typeof r<"u"},isObject(r){return typeof r=="object"&&r===Object(r)&&!Array.isArray(r)},rename(r,e,t){return typeof r[e]<"u"&&typeof r[t]>"u"?(r[t]=r[e],delete r[e],!0):!1},copy(r,e,t){return typeof r[e]<"u"&&typeof r[t]>"u"?(r[t]=r[e],!0):!1},forAll(r,e,t){if(r[e]&&typeof r[e]=="object")for(let i in r[e])t(r[e][i])},toArray(r,e){return typeof r[e]<"u"&&!Array.isArray(r[e])?(r[e]=[r[e]],!0):!1},flattenArray(r,e,t,i=!1){if(Array.isArray(r[e])){for(let n in r[e])if(typeof t[n]=="string"){let s=r[e][n];r[t[n]]=i?[s]:s}return delete r[e],!0}return!1},flattenOneElementArray(r,e,t=!1){return!t&&Array.isArray(r[e])?r[e].length===1?(r[e]=r[e][0],!0):!1:!0},removeFromArray(r,e,t){if(Array.isArray(r[e])){let i=r[e].indexOf(t);return i>-1&&r[e].splice(i,1),!0}return!1},pickFirst(r,e){return Array.isArray(r[e])&&r[e].length>0?(r[e]=r[e][0],!0):(delete r[e],!1)},ensure(r,e,t){return x.type(t)!==x.type(r[e])&&(r[e]=t),!0},upgradeExtension(r,e){let{id:t,version:i}=Wr.parseExtension(e),n=r.stac_extensions.findIndex(s=>{let o=Wr.parseExtension(s);return o&&o.id===t&&Is.compare(o.version,i,"<")});return n!==-1?(r.stac_extensions[n]=e,!0):!1},addExtension(r,e){let{id:t,version:i}=Wr.parseExtension(e),n=r.stac_extensions.findIndex(s=>{if(s===e)return!0;let o=Wr.parseExtension(s);return!!(o&&o.id===t&&Is.compare(o.version,i,"<"))});return n===-1?r.stac_extensions.push(e):r.stac_extensions[n]=e,r.stac_extensions.sort(),!0},removeExtension(r,e){return x.removeFromArray(r,"stac_extensions",e)},migrateExtensionShortnames(r){let e=Object.keys(k),t=Object.values(k);return x.mapValues(r,"stac_extensions",e,t)},populateExtensions(r,e){let t=[];(e=="catalog"||e=="collection")&&t.push(r),(e=="item"||e=="collection")&&x.isObject(r.assets)&&(t=t.concat(Object.values(r.assets))),e=="collection"&&x.isObject(r.item_assets)&&(t=t.concat(Object.values(r.item_assets))),e=="collection"&&x.isObject(r.summaries)&&t.push(r.summaries),e=="item"&&x.isObject(r.properties)&&t.push(r.properties),t.push(r.links);let i;for(;i=t.pop();)Object.keys(i).forEach(n=>{Array.isArray(i.bands)&&(t=t.concat(i.bands));let s=n.match(/^(\w+:|[^:]+$)/i);if(Array.isArray(s)){let o=Jt[e][s[0]];x.is(o,"string")&&x.addExtension(r,o)}})},mapValues(r,e,t,i){let n=s=>{let o=t.indexOf(s);return o>=0?i[o]:s};return Array.isArray(r[e])?r[e]=r[e].map(n):typeof r[e]<"u"&&(r[e]=n(r[e])),!0},mapObject(r,e){for(let t in r)r[t]=e(r[t],t)},moveTo(r,e,t,i=!1,n=!1){let s;return i?n?s=o=>Array.isArray(o):s=o=>Array.isArray(o)&&o.length===1:s=x.isDefined,s(r[e])?(t[e]=i&&!n?r[e][0]:r[e],delete r[e],!0):!1},runAll(r,e,t,i){for(let n in r)n.startsWith("migrate")||r[n](e,t,i)},toUTC(r,e){if(x.is(r[e],"string"))try{return r[e]=this.toISOString(r[e]),!0}catch{}return delete r[e],!1},toISOString(r){return r instanceof Date||(r=new Date(r)),r.toISOString().replace(/\.0+(?=[-\+Z])/,"")},formatString(r,e,t){const i=n=>x.is(n,["string","number"])?t.replaceAll("{}",n):n;Array.isArray(r[e])?r[e]=r[e].map(i):r[e]=i(r[e])}},yt={multihash:null,hexToUint8(r){if(r.length===0||r.length%2!==0)throw new Error(`The string "${r}" is not valid hex.`);return new Uint8Array(r.match(/.{1,2}/g).map(e=>parseInt(e,16)))},uint8ToHex(r){return r.reduce((e,t)=>e+t.toString(16).padStart(2,"0"),"")},toMultihash(r,e,t){if(!yt.multihash||!x.is(r[e],"string"))return!1;try{const i=yt.multihash.encode(yt.hexToUint8(r[e]),t);return r[e]=yt.uint8ToHex(i),!0}catch(i){return console.warn(i),!1}}},jo={migrate(r,e=!0){return J.set(r),e&&(r.stac_version=Wo),r.type="Catalog",x.ensure(r,"stac_extensions",[]),J.before("1.0.0-rc.1")&&x.migrateExtensionShortnames(r),x.ensure(r,"id",""),x.ensure(r,"description",""),x.ensure(r,"links",[]),x.runAll(jo,r,r),J.before("0.8.0")&&x.populateExtensions(r,"catalog"),r}},Ho={migrate(r,e=!0){return jo.migrate(r,e),r.type="Collection",J.before("1.0.0-rc.1")&&x.migrateExtensionShortnames(r),x.ensure(r,"license","other"),x.ensure(r,"extent",{spatial:{bbox:[]},temporal:{interval:[]}}),x.runAll(Ho,r,r),x.isObject(r.properties)&&(x.removeFromArray(r,"stac_extensions","commons"),delete r.properties),J.before("0.8.0")&&x.populateExtensions(r,"collection"),J.before("1.0.0-beta.1")&&x.mapValues(r,"stac_extensions",["assets"],["item-assets"]),r},extent(r){if(x.ensure(r,"extent",{}),J.before("0.8.0")&&(Array.isArray(r.extent.spatial)&&(r.extent.spatial={bbox:[r.extent.spatial]}),Array.isArray(r.extent.temporal)&&(r.extent.temporal={interval:[r.extent.temporal]})),x.ensure(r.extent,"spatial",{}),x.ensure(r.extent.spatial,"bbox",[]),x.ensure(r.extent,"temporal",{}),x.ensure(r.extent.temporal,"interval",[]),J.before("1.0.0-rc.3")){if(r.extent.temporal.interval.length>1){let e,t;for(let i of r.extent.temporal.interval){if(i[0]===null)e=null;else if(typeof i[0]=="string"&&e!==null)try{let n=new Date(i[0]);(typeof e>"u"||n<e)&&(e=n)}catch{}if(i[1]===null)t=null;else if(typeof i[1]=="string"&&t!==null)try{let n=new Date(i[1]);(typeof t>"u"||n>t)&&(t=n)}catch{}}r.extent.temporal.interval.unshift([e?x.toISOString(e):null,t?x.toISOString(t):null])}if(r.extent.spatial.bbox.length>1){let e=r.extent.spatial.bbox.reduce((t,i)=>Array.isArray(i)?Math.max(i.length,t):t,4);if(e>=4){let t=new Array(e).fill(null),i=e/2;for(let n of r.extent.spatial.bbox){if(!Array.isArray(n)||n.length<4)break;for(let s in n){let o=n[s];t[s]===null?t[s]=o:s<i?t[s]=Math.min(o,t[s]):t[s]=Math.max(o,t[s])}}t.findIndex(n=>n===null)===-1&&r.extent.spatial.bbox.unshift(t)}}}},collectionAssets(r){J.before("1.0.0-rc.1")&&x.removeExtension(r,"collection-assets"),ai.migrateAll(r)},itemAsset(r){J.before("1.0.0-beta.2")&&x.rename(r,"item_assets","assets"),x.removeExtension(r,k["item-assets"]),ai.migrateAll(r,"item_assets")},summaries(r){if(x.ensure(r,"summaries",{}),J.before("0.8.0")&&x.isObject(r.other_properties)){for(let e in r.other_properties){let t=r.other_properties[e];Array.isArray(t.extent)&&t.extent.length===2?r.summaries[e]={minimum:t.extent[0],maximum:t.extent[1]}:Array.isArray(t.values)&&(t.values.filter(i=>Array.isArray(i)).length===t.values.length?r.summaries[e]=t.values.reduce((i,n)=>i.concat(n),[]):r.summaries[e]=t.values)}delete r.other_properties}if(J.before("1.0.0-beta.1")&&x.isObject(r.properties)&&!r.links.find(e=>["child","item"].includes(e.rel)))for(let e in r.properties){let t=r.properties[e];Array.isArray(t)||(t=[t]),r.summaries[e]=t}J.before("1.0.0-rc.1")&&x.mapObject(r.summaries,e=>(x.rename(e,"min","minimum"),x.rename(e,"max","maximum"),e)),Ti.migrate(r.summaries,r,!0),x.moveTo(r.summaries,"sci:doi",r,!0)&&x.addExtension(r,k.scientific),x.moveTo(r.summaries,"sci:publications",r,!0,!0)&&x.addExtension(r,k.scientific),x.moveTo(r.summaries,"sci:citation",r,!0)&&x.addExtension(r,k.scientific),x.moveTo(r.summaries,"cube:dimensions",r,!0)&&x.addExtension(r,k.datacube),Object.keys(r.summaries).length===0&&delete r.summaries}},Zo={migrate(r,e=null,t=!0){J.set(r),t&&(r.stac_version=Wo),x.ensure(r,"stac_extensions",[]),J.before("1.0.0-rc.1")&&x.migrateExtensionShortnames(r),x.ensure(r,"id",""),x.ensure(r,"type","Feature"),x.isObject(r.geometry)||(r.geometry=null),r.geometry!==null&&x.ensure(r,"bbox",[]),x.ensure(r,"properties",{}),x.ensure(r,"links",[]),x.ensure(r,"assets",{});let i=!1;return x.isObject(e)&&x.isObject(e.properties)&&(x.removeFromArray(r,"stac_extensions","commons"),r.properties=Object.assign({},e.properties,r.properties),i=!0),x.runAll(Zo,r,r),Ti.migrate(r.properties,r),ai.migrateAll(r),(J.before("0.8.0")||i)&&x.populateExtensions(r,"item"),r}},Fu={migrate(r,e=!0){return x.ensure(r,"collections",[]),x.ensure(r,"links",[]),x.runAll(Fu,r,r),r.collections=r.collections.map(t=>Ho.migrate(t,e)),r}},Ou={migrate(r,e=!0){return x.ensure(r,"type","FeatureCollection"),x.ensure(r,"features",[]),x.ensure(r,"links",[]),x.runAll(Ou,r,r),r.features=r.features.map(t=>Zo.migrate(t,null,e)),r}},ai={migrateAll(r,e="assets"){for(let t in r[e])ai.migrate(r[e][t],r)},migrate(r,e){return x.runAll(ai,r,e),Ti.migrate(r,e),r},mediaTypes(r){x.is(r.type,"string")&&x.mapValues(r,"type",["image/vnd.stac.geotiff","image/vnd.stac.geotiff; cloud-optimized=true"],["image/tiff; application=geotiff","image/tiff; application=geotiff; profile=cloud-optimized"])}},Cs={migrateAll(r,e){if(J.before("1.0.0")){const t=x.isObject(e.properties)&&Array.isArray(e.properties.bands)?e.properties.bands:[];if(Array.isArray(r["eo:bands"]))for(let i in r["eo:bands"]){let n=r["eo:bands"][i];x.is(n,"number")&&x.isObject(t[n])&&(n=t[n]),x.isObject(n)||(n={}),r["eo:bands"][i]=n}}if(J.before("1.1.0-beta.1")&&(Array.isArray(r["raster:bands"])||Array.isArray(r["eo:bands"]))){x.ensure(r,"bands",[]);const t=r["raster:bands"]||[],i=r["eo:bands"]||[],n=Math.max(t.length,i.length);for(let s=0;s<n;s++)x.ensure(r.bands,s,{}),Object.assign(r.bands[s],t[s],i[s]),r.bands[s]=Cs.migrate(r.bands[s],e);delete r["raster:bands"],delete r["eo:bands"]}},migrate(r,e){return x.runAll(Cs,r,e),Ti.migrate(r,e),r},eo(r){J.before("2.0.0-beta.1","eo")&&(x.rename(r,"common_name","eo:common_name"),x.rename(r,"center_wavelength","eo:center_wavelength"),x.rename(r,"full_width_half_max","eo:full_width_half_max"),x.rename(r,"solar_illumination","eo:solar_illumination"))},raster(r){J.before("2.0.0-beta.1","raster")&&(x.rename(r,"sampling","raster:sampling"),x.rename(r,"bits_per_sample","raster:bits_per_sample"),x.rename(r,"spatial_resolution","raster:spatial_resolution"),x.rename(r,"scale","raster:scale"),x.rename(r,"offset","raster:offset"),x.rename(r,"histogram","raster:histogram"))}},Ti={migrate(r,e,t=!1){return x.runAll(Ti,r,e,t),r},_commonMetadata(r,e){J.before("1.0.0-rc.3")&&(x.toUTC(r,"created"),x.toUTC(r,"updated")),Cs.migrateAll(r,e)},_timestamps(r,e){x.toUTC(r,"published"),x.toUTC(r,"expires"),x.toUTC(r,"unpublished"),x.upgradeExtension(e,k.timestamps)},_versioningIndicator(r,e){x.upgradeExtension(e,k.version)},checksum(r,e){J.before("0.9.0")&&yt.multihash&&(x.rename(r,"checksum:md5","checksum:multihash")&&yt.toMultihash(r,"checksum:multihash","md5"),x.rename(r,"checksum:sha1","checksum:multihash")&&yt.toMultihash(r,"checksum:multihash","sha1"),x.rename(r,"checksum:sha2","checksum:multihash")&&yt.toMultihash(r,"checksum:multihash","sha2-256"),x.rename(r,"checksum:sha3","checksum:multihash")&&yt.toMultihash(r,"checksum:multihash","sha3-256")),J.before("1.0.0-rc.1")&&x.rename(r,"checksum:multihash","file:checksum")&&x.addExtension(e,k.file),x.removeExtension(e,"checksum")},classification(r,e){J.before("1.1.0","classification")&&x.forAll(r,"classification:classes",t=>x.rename(t,"color-hint","color_hint")),J.before("2.0.0","classification")&&x.forAll(r,"classification:classes",t=>x.ensure(t,"name",t.description)),x.upgradeExtension(e,k.classification)},cube(r,e){x.upgradeExtension(e,k.datacube)},dtr(r,e){J.before("0.9.0")&&(x.rename(r,"dtr:start_datetime","start_datetime"),x.rename(r,"dtr:end_datetime","end_datetime"),x.removeExtension(e,"datetime-range"))},eo(r,e){J.before("0.9.0")&&(x.rename(r,"eo:epsg","proj:epsg")&&x.addExtension(e,k.projection),x.rename(r,"eo:platform","platform"),x.rename(r,"eo:instrument","instruments")&&x.toArray(r,"instruments"),x.rename(r,"eo:constellation","constellation"),x.rename(r,"eo:off_nadir","view:off_nadir")&&x.addExtension(e,k.view),x.rename(r,"eo:azimuth","view:azimuth")&&x.addExtension(e,k.view),x.rename(r,"eo:incidence_angle","view:incidence_angle")&&x.addExtension(e,k.view),x.rename(r,"eo:sun_azimuth","view:sun_azimuth")&&x.addExtension(e,k.view),x.rename(r,"eo:sun_elevation","view:sun_elevation")&&x.addExtension(e,k.view)),J.before("1.0.0-beta.1")&&x.rename(r,"eo:gsd","gsd"),x.upgradeExtension(e,k.eo)},file(r,e,t){x.rename(r,"file:bits_per_sample","raster:bits_per_sample")&&x.addExtension(e,k.raster),x.rename(r,"file:data_type","data_type"),x.rename(r,"file:unit","unit"),Array.isArray(r["file:nodata"])&&r["file:nodata"].length>1&&x.copy(r,"file:nodata","nodata:values"),x.rename(r,"file:nodata","nodata")&&!t&&x.pickFirst(r,"nodata"),x.upgradeExtension(e,k.file)},label(r,e){J.before("0.8.0")&&(x.rename(r,"label:property","label:properties"),x.rename(r,"label:task","label:tasks"),x.rename(r,"label:overview","label:overviews")&&x.toArray(r,"label:overviews"),x.rename(r,"label:method","label:methods"),x.toArray(r,"label:classes")),x.upgradeExtension(e,k.label)},pc(r,e){J.before("0.8.0")&&x.rename(r,"pc:schema","pc:schemas"),x.upgradeExtension(e,k.pointcloud)},processing(r,e){x.upgradeExtension(e,k.processing)},proj(r,e){x.rename(r,"proj:epsg","proj:code")&&x.formatString(r,"proj:code","EPSG:{}"),x.upgradeExtension(e,k.projection)},raster(r,e){x.upgradeExtension(e,k.raster)},sar(r,e,t){x.rename(r,"sar:incidence_angle","view:incidence_angle")&&x.addExtension(e,k.view),x.rename(r,"sar:pass_direction","sat:orbit_state")&&x.mapValues(r,"sat:orbit_state",[null],["geostationary"])&&x.addExtension(e,k.sat),J.before("0.7.0")&&(x.flattenArray(r,"sar:resolution",["sar:resolution_range","sar:resolution_azimuth"],t),x.flattenArray(r,"sar:pixel_spacing",["sar:pixel_spacing_range","sar:pixel_spacing_azimuth"],t),x.flattenArray(r,"sar:looks",["sar:looks_range","sar:looks_azimuth","sar:looks_equivalent_number"],t),x.rename(r,"sar:off_nadir","view:off_nadir")&&x.addExtension(e,k.view)),J.before("0.9.0")&&(x.rename(r,"sar:platform","platform"),x.rename(r,"sar:instrument","instruments")&&x.toArray(r,"instruments"),x.rename(r,"sar:constellation","constellation"),x.rename(r,"sar:type","sar:product_type"),x.rename(r,"sar:polarization","sar:polarizations"),x.flattenOneElementArray(r,"sar:absolute_orbit",t)&&x.rename(r,"sar:absolute_orbit","sat:absolute_orbit")&&x.addExtension(e,k.sat),x.flattenOneElementArray(r,"sar:relative_orbit",t)&&x.rename(r,"sar:relative_orbit","sat:relative_orbit")&&x.addExtension(e,k.sat)),x.upgradeExtension(e,k.sar)},sat(r,e){J.before("0.9.0")&&(x.rename(r,"sat:off_nadir_angle","sat:off_nadir"),x.rename(r,"sat:azimuth_angle","sat:azimuth"),x.rename(r,"sat:sun_azimuth_angle","sat:sun_azimuth"),x.rename(r,"sat:sun_elevation_angle","sat:sun_elevation")),x.upgradeExtension(e,k.sat)},sci(r,e){x.upgradeExtension(e,k.scientific)},item(r){J.before("0.8.0")&&(x.rename(r,"item:license","license"),x.rename(r,"item:providers","providers"))},table(r,e){x.upgradeExtension(e,k.table)},view(r,e){x.upgradeExtension(e,k.view)}},gr={item(r,e=null,t=!0){return Zo.migrate(r,e,t)},catalog(r,e=!0){return jo.migrate(r,e)},collection(r,e=!0){return Ho.migrate(r,e)},collectionCollection(r,e=!0){return Fu.migrate(r,e)},itemCollection(r,e=!0){return Ou.migrate(r,e)},stac(r,e=!0){return r.type==="Feature"?gr.item(r,null,e):r.type==="FeatureCollection"?gr.itemCollection(r,e):r.type==="Collection"||!r.type&&x.isDefined(r.extent)&&x.isDefined(r.license)?gr.collection(r,e):!r.type&&Array.isArray(r.collections)?gr.collectionCollection(r,e):gr.catalog(r,e)},enableMultihash(r){yt.multihash=r}},Rx=gr;const Ax=to(Rx);function Ve(r){return typeof r=="string"&&r.length>0}function _r(r,e,t,i=1e-8){if(typeof r!="number")return null;const n=e-i,s=t+i;return r<n||r>s?null:Math.min(Math.max(r,e),t)}function Xe(r){return typeof r=="object"&&r===Object(r)&&!Array.isArray(r)}function Px(r){switch(r){case"int8":return-128;case"int16":return-32768;case"int32":return-2147483648}return r.startsWith("u")?0:null}function Lx(r){switch(r){case"int8":return 127;case"uint8":return 255;case"int16":return 32767;case"uint16":return 65535;case"int32":return 2147483647;case"uint32":return 4294967295}return null}function Mu(r){const e={minimum:null,maximum:null},t=l=>l.minimum!==null&&l.maximum!==null,i=r.getMetadata("statistics");if(Xe(i)&&(typeof i.minimum=="number"&&(e.minimum=i.minimum),typeof i.maximum=="number"&&(e.maximum=i.maximum),t(e)))return e;const n=r.getMetadata("raster:histogram");if(Xe(n)&&(typeof n.min=="number"&&(e.minimum=n.min),typeof n.max=="number"&&(e.maximum=n.max),t(e)))return e;const s=r.getMetadata("classification:classes");if(Array.isArray(s)&&(s.reduce((l,c)=>(l.minimum=Math.min(l.minimum,c.value),l.maximum=Math.max(l.maximum,c.value),l),e),t(e)))return e;const o=r.getMetadata("file:values");if(Array.isArray(o)&&(o.reduce((l,c)=>(l.minimum=Math.min(l.minimum,...c.values),l.maximum=Math.max(l.maximum,...c.values),l),e),t(e)))return e;const a=r.getMetadata("data_type");return a&&(e.minimum=Px(a),e.maximum=Lx(a)),e}function Nu(r){let e=[];const t=r.getMetadata("nodata");if(typeof t<"u")e.push(t);else{const i=r.getMetadata("file:nodata");if(typeof i<"u")e=i;else{const n=r.getMetadata("classification:classes");Array.isArray(n)&&(e=n.filter(s=>!!s.nodata).map(s=>s.value))}}return e.map(i=>i==="nan"?NaN:i==="+inf"?1/0:i==="-inf"?-1/0:i)}function Ur(r){let e=r.length>=6,t=r[0],i=r[e?3:2],n=r[1],s=r[e?4:3],o={west:t,east:i,south:n,north:s};return e&&(o.base=r[2],o.height=r[5]),o}function is(r){let{west:e,east:t,south:i,north:n}=Ur(r);return[[[e,n],[e,i],[t,i],[t,n],[e,n]]]}function Ix(r){if(r=at(r,!0),!r)return null;let e=Ur(r),t=[];if(Bu(r)){let i=(e.west+360+e.east)/2;i>180&&(i-=360),t.push(i)}else t.push((e.west+e.east)/2);return t.push((e.south+e.north)/2),typeof e.base<"u"&&t.push((e.base+e.height)/2),t}function Du(r){if(Array.isArray(r[0]))return r.map(Du);const[e,t]=r;return[_r(e,-180,180),_r(t,-90,90)]}function Xi(r){return Xe(r)&&(r.bbox&&(r.bbox=at(r.bbox)),r.type==="FeatureCollection"?r.features.forEach(e=>Xi(e)):r.type==="Feature"?r.geometry=Xi(r.geometry):r.type==="GeometryCollection"?r.geometries.forEach(e=>Xi(e)):r.coordinates&&(r.coordinates=Du(r.coordinates))),r}function Uu(r){const e=at(r);if(e?r=[e]:Array.isArray(r)&&(r=r.map(n=>at(n)).filter(n=>n!==null)),!Array.isArray(r)||r.length===0)return null;let t=r.reduce((n,s)=>{if(Bu(s)){let{west:o,east:a,south:l,north:c}=Ur(s);n.push(is([-180,l,a,c])),n.push(is([o,l,180,c]))}else n.push(is(s));return n},[]),i=null;if(t.length===1?i={type:"Polygon",coordinates:t[0]}:t.length>1&&(i={type:"MultiPolygon",coordinates:t}),i)return{type:"Feature",geometry:i,properties:{}}}function at(r,e=!1){if(!Array.isArray(r)||![4,6].includes(r.length))return null;let{west:t,east:i,south:n,north:s,base:o,height:a}=Ur(r);return t=_r(t,-180,180),n=_r(n,-90,90),i=_r(i,-180,180),s=_r(s,-90,90),e&&r.length===6?r=[t,n,o,i,s,a]:r=[t,n,i,s],r.some(l=>l===null)?null:r}function Bu(r){if(r=at(r),!r)return!1;let{west:e,east:t}=Ur(r);return e>t}function Yo(r){if(!Array.isArray(r)||r.length===0)return null;let e={west:180,south:90,east:-180,north:-90};r.forEach(i=>{if(i=at(i),!i)return;let n=Ur(i),s=["west","south"];for(let o in n){let a=s.includes(o)?Math.min:Math.max;e[o]=a(e[o],n[o])}});let t=[e.west,e.south,e.east,e.north];return at(t)}class wi{constructor(e,t={},i=[]){if(!Xe(e))throw new Error("Given data is not an object");if(e instanceof wi){for(let n of i)this[n]=e[n];e=e.toJSON()}this._keyMap=t,this._privateKeys=["_keyMap","_privateKeys"].concat(i);for(let n in e)typeof this[n]>"u"&&(n in t?this[n]=t[n](e[n],this):this[n]=e[n])}isItem(){return this.type==="Feature"}isCatalog(){return this.type==="Catalog"}isCatalogLike(){return this.isCatalog()||this.isCollection()}isCollection(){return this.type==="Collection"}isItemCollection(){return this.type==="FeatureCollection"}isCollectionCollection(){return!1}isAsset(){return!1}isLink(){return!1}isBand(){return!1}getObjectType(){}getAbsoluteUrl(){return null}getMetadata(e){return this[e]}toGeoJSON(){return null}getBoundingBox(){return null}getCenter(){return Ix(this.getBoundingBox())}getBoundingBoxes(){return[]}toJSON(){let e={};return Object.keys(this).forEach(t=>{if(typeof this[t]=="function"||this._privateKeys.includes(t))return;let i=this[t];if(t in this._keyMap){let n=Array.isArray(i)?[]:{};for(let s in i)n[s]=i[s].toJSON();i=n}e[t]=i}),e}}const pl=["http","https"];function Cx(r,e,t=!0){return Fx(r,e,!1,t)}function Fx(r,e=null,t=!1,i=!0){let n=ps(r);if(e&&n.is("relative")){let s=ps(e),o=s.path();!o.endsWith("/")&&!o.endsWith(".json")&&s.path(o+"/"),n=n.absoluteTo(s)}return n.normalize(),t&&(n.query(""),n.fragment("")),i?n.toString():n}const Fs="application/geo+json",Ox=["application/json",Fs,"text/json"],ml=["image/gif","image/jpeg","image/apng","image/png","image/webp"],Gu=["image/tiff; application=geotiff; profile=cloud-optimized","image/vnd.stac.geotiff; cloud-optimized=true"],zu=["application/geotiff","image/tiff; application=geotiff","image/vnd.stac.geotiff"].concat(Gu);function qo(r,e,t=!1){return Array.isArray(e)||(e=[e]),t&&typeof r>"u"?!0:typeof r!="string"?!1:(e=e.map(i=>i.toLowerCase()),e.includes(r.toLowerCase()))}function Mx(r,e=!1){return qo(r,Ox,e)}class ku extends wi{constructor(e,t=null,i={},n=[]){super(e,i,["_context"].concat(n)),this._context||(this._context=t)}getAbsoluteUrl(e=!0){return this._context?Cx(this.href,this._context.getAbsoluteUrl(),e):this.href.includes("://")?this.href:null}getContext(){return this._context}canBrowserDisplayImage(e=!1){if(typeof this.href!="string")return!1;if(!e&&typeof this.type>"u")return!1;let t=new ps(this.href),i=t.protocol().toLowerCase(),n=t.suffix().toLowerCase();return Ve(i)&&!pl.includes(i)?!1:Ve(this.type)&&ml.includes(this.type.toLowerCase())?!0:!!(typeof this.type>"u"&&Ve(n)&&(n==="jpg"||ml.includes("image/"+n)))}isType(e){return Ve(this.type)&&qo(this.type,e)}isGeoTIFF(){return this.isType(zu)}isCOG(){return this.isType(Gu)}isHTTP(){let t=this.getAbsoluteUrl(!1).protocol().toLowerCase();return Ve(t)&&pl.includes(t)}isPreview(){return!1}}class Ko extends ku{constructor(e,t=null){super(e,t)}isLink(){return!0}getObjectType(){return"Link"}isPreview(){return this.rel==="preview"}static fromLinks(e,t=null){return Array.isArray(e)?e.map(i=>Xe(i)?new Ko(i,t):i):[]}}class $u extends wi{constructor(e,t=null,i={},n=[]){if(super(e,Object.assign({links:Ko.fromLinks},i),["_url"].concat(n)),!this._url&&(this._url=t,!this._url)){let s=this.getSelfLink();s&&(this._url=s.href)}}getAbsoluteUrl(){return this._url}setAbsoluteUrl(e){this._url=e}getStacLinksWithRel(e,t=!0){return this.getLinksWithRels([e]).filter(i=>Mx(i.type,t))}getStacLinkWithRel(e,t=!0){const i=this.getStacLinksWithRel(e,t);return i.length>0?i[0]:null}getLinks(){return Array.isArray(this.links)?this.links.filter(e=>Xe(e)&&Ve(e.href)):[]}getLinkWithRel(e){return this.getLinks().find(t=>t.rel===e)||null}getLinksWithRels(e){return this.getLinks().filter(t=>e.includes(t.rel))}getLinksWithOtherRels(e){return this.getLinks().filter(t=>!e.includes(t.rel))}getSelfLink(){return this.getStacLinkWithRel("self")}getRootLink(){return this.getStacLinkWithRel("root")}getParentLink(){return this.getStacLinkWithRel("parent")}}class Jo extends $u{constructor(e,t=null,i={},n=[]){super(e,t,i,n)}getAll(){return[]}}class Si extends wi{constructor(e,t=null,i=null){super(e,{},["_index","_context"]),typeof this._index!="number"&&(this._index=typeof t=="string"?parseInt(t,10):t),this._context||(this._context=i)}getContext(){return this._context}getObjectType(){return"Band"}isBand(){return!0}getIndex(){return this._index}getMetadata(e){if(typeof this[e]<"u")return this[e];if(this._context)return this._context.getMetadata(e)}getMinMaxValues(){return Mu(this)}getNoDataValues(){return Nu(this)}static fromBands(e,t=null){let i=[];if(Array.isArray(e))for(let n in e)i[n]=new Si(e[n],n,t);return i}}const Nx=["created","updated","published","expires","unpublished","bands"];class nt extends ku{constructor(e,t=null,i=null){const n={bands:Si.fromBands,alternate:nt.fromAssets};super(e,i,n,["_key"]),this._key||(this._key=t)}getObjectType(){return"Asset"}isAsset(){return!0}getAbsoluteUrl(e=!0){return this.isDefinition()?null:super.getAbsoluteUrl(e)}getKey(){return this._key}getMetadata(e){if(typeof this[e]<"u")return this[e];if(this._context instanceof nt)return this._context.getMetadata(e);if(this._context&&!Nx.includes(e))return this._context.getMetadata(e)}getBands(){return this.bands||[]}findVisualBands(){const e={red:null,green:null,blue:null},t=this.getBands();for(const n in t){const s=parseInt(n,10),o=t[s];Xe(o)&&Ve(o["eo:common_name"])&&o["eo:common_name"]in e&&(e[o["eo:common_name"]]=o)}return Object.values(e).every(n=>n!==null)?e:null}findBand(e,t="name"){Array.isArray(e)||(e=[e]);const i=this.getBands(),n=i.findIndex(s=>Xe(s)&&e.includes(s[t]));return n>=0?i[n]:null}getBand(e){return Xe(e)||e===null?e:this.getBands()[e]||null}getMinMaxValues(){return Mu(this)}getNoDataValues(){return Nu(this)}isDefinition(){return!Ve(this.href)}isHTTP(){return this.isDefinition()?null:super.isHTTP()}isPreview(){const e=["thumbnail","overview"];return e.includes(this.getKey())?!0:Array.isArray(this.roles)&&this.roles.some(t=>e.includes(t))}hasRole(e,t=!1){return Array.isArray(e)||(e=[e]),t&&e.includes(this.getKey())?!0:Array.isArray(this.roles)&&!!this.roles.find(i=>e.includes(i))}static fromAssets(e,t=null){let i={};if(Xe(e))for(let n in e)i[n]=new nt(e[n],n,t);return i}}class _t extends $u{constructor(e,t=null,i={},n=[]){super(e,t,i,n)}getTemporalExtent(){return null}getTemporalExtents(){return[]}getIcons(e=!0){return this.getLinksWithRels(["icon"]).filter(t=>t.canBrowserDisplayImage(e))}getThumbnails(e=!0,t=null){let i=this.getAssets().filter(n=>n.isPreview());if(i.length===0&&(i=this.getLinks().filter(n=>n.isPreview())),e&&(i=i.filter(n=>n.canBrowserDisplayImage())),t&&i.length>1){let n=s=>Array.isArray(s.roles)&&s.roles.includes(t)||s.getKey()===t;i=i.filter(n).concat(i.filter(s=>!n(s)))}return i}getDefaultGeoTIFF(e=!0,t=!1){var n;return(n=this.rankGeoTIFFs(e,t)[0])==null?void 0:n.asset}rankGeoTIFFs(e=!0,t=!1,i=null,n=null){Xe(i)||(i={data:1,visual:2,thumbnail:2,overview:3});let s=[],o=this.getAssetsByTypes(zu);e&&(o=o.filter(l=>l.isHTTP()&&(!t||l.isCOG())));let a=Object.entries(i);for(let l of o){let c=0;if(a.length>0){let u=a.filter(([h])=>l.hasRole(h,!0)).map(([,h])=>h);u.length>0&&(c+=Math.max(...u))}!t&&l.isCOG()&&(c+=2),l.findVisualBands()&&(c+=1),typeof n=="function"&&(c+=n(l)),s.push({asset:l,score:c})}return s.sort((l,c)=>c.score-l.score),s}findVisualAssets(){let e={red:null,green:null,blue:null},t=Object.keys(e),i=this.getAssets();for(let s of i){let o=s.findBand(t,"eo:common_name");o&&(e[o["eo:common_name"]]=s)}return Object.values(e).every(s=>s!==null)?e:null}getAsset(e){return Xe(this.assets)&&this.assets[e]||null}getAssets(){return Xe(this.assets)?Object.values(this.assets):[]}getAssetsWithRoles(e,t=!1){return this.getAssets().filter(i=>i.hasRole(e,t))}getAssetWithRole(e,t=!1){return this.getAssetsWithRoles([e],t)[0]||null}getAssetsByTypes(e){return this.getAssets().filter(t=>qo(t.type,e))}equals(e){return this===e?!0:!(e instanceof _t)||this.getObjectType()!==e.getObjectType()?!1:!!(this.id&&this.id===e.id)}supportsExtension(e){if(!Array.isArray(this.stac_extensions))return!1;let t=new RegExp("^"+e.replaceAll("*","[^/]+")+"$");return this.stac_extensions.some(i=>t.test(i))}}class Vu extends _t{constructor(e,t=null,i={},n=[]){super(e,t,i,n)}getObjectType(){return this.type}getSearchLink(e=null){let t=this.getStacLinksWithRel("search");return e?t[0]||null:t.find(i=>i.method===e||!e&&!i.method)||null}getApiCollectionsLink(){return this.getStacLinkWithRel("data")}getApiItemsLink(){return this.getStacLinkWithRel("items")}getChildLinks(){return this.getStacLinksWithRel("child")}getItemLinks(){return this.getStacLinksWithRel("item")}}class Dx extends Vu{constructor(e,t=null){super(e,t)}}function jr(r){if(Ve(r)&&r.length>=10)try{let t=r.match(/^(-?\d{1,})-(\d\d)-(\d\d)[T ](\d\d):(\d\d):(\d\d)(?:\.(\d*))?(?:Z|[+-]00:00)?$/i).slice(1).map(i=>parseInt(i,10));return new Date(Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5],t[6]||0))}catch{return null}return null}function Ux(r,e){return new Date(r.valueOf()+(e-r)/2)}function Xu(r){if(!Array.isArray(r)||r.length===0)return null;let e,t;const i=(n,s,o)=>typeof n>"u"?s:n===null||s===null?null:o(n,s);return r.forEach(([n,s])=>{e=i(e,n,Math.min),t=i(t,s,Math.max)}),[e===null?null:new Date(e),t===null?null:new Date(t)]}class Wu extends Vu{constructor(e,t=null){const i={assets:nt.fromAssets,item_assets:nt.fromAssets};super(e,t,i)}toGeoJSON(){let e=Uu(this.getBoundingBoxes());return e&&(e.id=this.id),e}getBoundingBox(){let e=this.getRawBoundingBoxes();return e.length>0?at(e[0]):null}getBoundingBoxes(){let e=this.getRawBoundingBoxes();return e.length===1?[at(e[0])]:e.length>1?e.slice(1).map(at):null}getRawBoundingBoxes(){var t,i;let e=(i=(t=this.extent)==null?void 0:t.spatial)==null?void 0:i.bbox;return Array.isArray(e)&&e.length>0?e:[]}getTemporalExtent(){return this.getTemporalExtents()[0]||null}getTemporalExtents(){var t,i;let e=(i=(t=this.extent)==null?void 0:t.temporal)==null?void 0:i.interval;return Array.isArray(e)&&e.length>0?e.filter(n=>Array.isArray(n)&&(Ve(n[0])||Ve(n[1]))).map(n=>n.map(s=>jr(s))):[]}getSummary(e){return this.summaries[e]}getBands(){let e=this.getMetadata("bands");return Array.isArray(e)||(e=this.getSummary("bands")),Array.isArray(e)?Si.fromBands(e,this):[]}}class Bx extends Jo{constructor(e,t=null){const i={collections:n=>n.map(s=>new Wu(s))};super(e,t,i)}getObjectType(){return"CollectionCollection"}getAll(){return this.collections}isCollectionCollection(){return!0}toGeoJSON(){return{type:"FeatureCollection",features:this.collections.map(t=>t.toGeoJSON()).filter(t=>t!==null)}}getBoundingBox(){return Yo(this.getBoundingBoxes())}getBoundingBoxes(){return this.collections.map(e=>e.getBoundingBox())}getTemporalExtent(){return Xu(this.getTemporalExtents())}getTemporalExtents(){return this.collections.map(e=>e.getTemporalExtent())}}class Qo extends _t{constructor(e,t=null){super(e,t,{assets:nt.fromAssets})}getObjectType(){return"Item"}toGeoJSON(){return this.toJSON()}getBoundingBox(){return at(this.bbox)}getBoundingBoxes(){const e=this.getBoundingBox();return e?[e]:[]}getDateTime(){let e=jr(this.properties.datetime);if(!e){let t=jr(this.properties.start_datetime),i=jr(this.properties.end_datetime);return t&&i?Ux(t,i):t||i}return e}getTemporalExtent(){return this.getTemporalExtents()[0]||null}getTemporalExtents(){let e=[];return Ve(this.properties.start_datetime)||Ve(this.properties.end_datetime)?e=[[this.properties.start_datetime||null,this.properties.end_datetime||null]]:Ve(this.properties.datetime)&&(e=[[this.properties.datetime,this.properties.datetime]]),e.map(t=>t.map(i=>jr(i)))}getMetadata(e){return this.properties[e]}getBands(){const e=this.getMetadata("bands");return Array.isArray(e)?Si.fromBands(e,this):[]}getCollectionLink(){return this.getStacLinkWithRel("collection")}}class ju extends Jo{constructor(e,t=null){const i={features:n=>n.map(s=>new Qo(s))};super(e,t,i)}getObjectType(){return"ItemCollection"}getAll(){return this.features}toGeoJSON(){return this.toJSON()}getBoundingBox(){return Yo(this.getBoundingBoxes())}getBoundingBoxes(){return this.features.map(e=>e.getBoundingBox())}getTemporalExtent(){return Xu(this.getTemporalExtents())}getTemporalExtents(){return this.features.map(e=>e.getTemporalExtent())}}function Di(r,e=!0,t=!1){return e&&(r=Ax.stac(r,t)),r.type==="Feature"?new Qo(r):r.type==="FeatureCollection"?new ju(r):r.type==="Collection"||!r.type&&typeof r.extent<"u"&&typeof r.license<"u"?new Wu(r):!r.type&&Array.isArray(r.collections)?new Bx(r):new Dx(r)}const Gx="https://stac-extensions.github.io/label/v1.*/schema.json",Hu=new qi({color:"rgba(0,0,0,0)"});function Zu(r,e,t="rgba(255,255,255,0.4)",i=5){let n=Hu;t&&(n=new qi({color:t}));const s=new Yi({color:r,width:e});return new zi({image:new Bh({fill:n,stroke:s,radius:i}),fill:n,stroke:s})}const zx=Zu("#3399CC",3),_l=Zu("#ff9933",2,null);function kx(r,e){const t={url:r.getAbsoluteUrl()};let i=r;r.getBands().length===1&&(i=r.getBand(0));const{minimum:n,maximum:s}=i.getMinMaxValues();typeof n=="number"&&(t.min=n),typeof s=="number"&&(t.max=s);const o=i.getNoDataValues();return o.length>0&&(t.nodata=o[0]),e.length>0&&(t.bands=e),t}async function yl(r,e=void 0){let t=e;if(Gh()){const i=r.getMetadata("proj:code");if(i)try{if(i.startsWith("EPSG:")){const n=parseInt(i.replace("EPSG:",""),10);t=await zh(n)}}catch{}}return t}function xl(r,e){const t=r.clone();return e.hasOnlyBounds()||t.setFill(Hu),t}function $x(r){let e=r.href;if(e.includes("{s}"))if(Array.isArray(r["href:servers"])&&r["href:servers"].length>0){const t=Math.random()*r["href:servers"].length|0;e=e.replace("{s}",r["href:servers"][t])}else return null;return e}class El extends bi{constructor(t){super({...t,state:"loading"});re(this,"loadImage",t=>new Promise((i,n)=>{const s=new Image;s.addEventListener("load",()=>i(s)),s.addEventListener("error",()=>n(new Error("load failed"))),s.src=t}));const i=new Ro(t.url);i.getHeader().then(n=>{this.tileGrid.minZoom=n.minZoom,this.tileGrid.maxZoom=n.maxZoom,this.setLoader(async(s,o,a)=>{const l=await i.getZxy(s,o,a),c=URL.createObjectURL(new Blob([l.data])),u=await this.loadImage(c);return URL.revokeObjectURL(c),u}),this.setState("ready")})}}class Vx extends Xs{constructor(t){super({...t,state:"loading",url:"pmtiles://"+t.url+"/{z}/{x}/{y}",format:new kh});re(this,"tileLoadFunction",(t,i)=>{const n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=i.match(n),o=+s[2],a=+s[3],l=+s[4];t.setLoader((c,u,h)=>{t.setState(K.LOADING),this.pmtiles_.getZxy(o,a,l).then(f=>{if(f){const g=t.getFormat();t.setFeatures(g.readFeatures(f.data,{extent:c,featureProjection:h})),t.setState(K.LOADED)}else t.setFeatures([]),t.setState(K.EMPTY)}).catch(f=>{t.setFeatures([]),t.setState(K.ERROR)})})});this.pmtiles_=new Ro(t.url),this.pmtiles_.getHeader().then(i=>{this.tileGrid.minZoom=i.minZoom,this.tileGrid.maxZoom=i.maxZoom,this.setTileLoadFunction(this.tileLoadFunction),this.setState("ready")})}}class ea extends $f{constructor(e){const t={};if(["opacity","visible","zIndex","minResolution","maxResolution","minZoom","maxZoom","properties"].forEach(i=>t[i]=e[i]),super(t),this.getSourceOptions_=e.getSourceOptions,this.children_=null,this.childrenOptions_=e.childrenOptions||{},this.assets_=null,this.bands_=[],this.crossOrigin_=e.crossOrigin||null,this.displayFootprint_=e.displayFootprint!==!1,this.displayGeoTiffByDefault_=!!e.displayGeoTiffByDefault,this.displayPreview_=!!e.displayPreview,this.displayOverview_=e.displayOverview!==!1,this.displayWebMapLink_=e.displayWebMapLink||!1,this.buildTileUrlTemplate_=e.buildTileUrlTemplate||null,this.useTileLayerAsFallback_=e.useTileLayerAsFallback||!1,this.boundsStyle_=e.boundsStyle||zx,this.collectionStyle_=e.collectionStyle||_l,this.boundsLayer_=null,this.disableMigration_=e.disableMigration||!1,this.map_=null,this.eventQueue_=[],e.httpRequestFn&&(this.fetch_=e.httpRequestFn),e.data){try{this.configure_(e.data,e.url,e.children,e.assets,e.bands)}catch(i){this.handleError_(i)}return}if(!e.url)throw new Error("Either url or data must be provided");this.fetch_(e.url).then(i=>this.configure_(i,e.url,e.children,e.assets,e.bands)).catch(i=>this.handleError_(i))}async fetch_(e,t="json"){const i=await fetch(e);if(!i.ok)throw new Error(`Unexpected response from ${e}: ${i.status}`);return t==="json"?await i.json():t==="text"?await i.text():null}getBoundsLayer(){return this.boundsLayer_}isEmpty(){var e;if(this.getLayers().getLength()>1)return!1;const i=(e=this.getData())===null||e===void 0?void 0:e.getBoundingBox();return!i||An(i)?!0:!this.boundsLayer_||!this.displayFootprint_}handleError_(e){this.dispatch_(new Sy(e))}configure_(e,t=null,i=null,n=null,s=[]){let o;e instanceof nt||e instanceof _t?o=e:o=Di(e,!this.disableMigration_),t&&t.includes("://")&&o instanceof _t&&o.setAbsoluteUrl(t),this.set("stac",o),this.bands_=s,this.boundsLayer_=this.addFootprint_();const a=()=>{this.boundsLayer_&&this.boundsLayer_.setStyle(xl(this.boundsStyle_,this))};this.getLayers().on("add",a),this.getLayers().on("remove",a);const l=h=>this.handleError_(h),c=this.setChildren(i).catch(l),u=this.setAssets(n).catch(l);Promise.all([c,u]).then(()=>this.dispatch_("layersready")),this.dispatch_("sourceready")}dispatch_(e){this.eventQueue_.push(e),this.flush_()}flush_(){if(this.map_){for(const e of this.eventQueue_)this.dispatchEvent(e);this.eventQueue_=[]}}setMap_(e){this.map_!==e&&(this.map_=e,this.flush_())}async addChildren_(e,t={}){const i=e.map(n=>{const s={data:n,crossOrigin:this.crossOrigin_,boundsStyle:this.collectionStyle_,displayGeoTiffByDefault:this.displayGeoTiffByDefault_,displayOverview:this.displayOverview_,displayPreview:this.displayPreview_,displayFootprint:this.displayFootprint_,useTileLayerAsFallback:this.useTileLayerAsFallback_,buildTileUrlTemplate:this.buildTileUrlTemplate_},o=new ea(Object.assign(s,t));return o.on("sourceready",()=>{o.map_&&this.setMap_(o.map_)}),this.addLayer_(o,null),o});return await Promise.all(i)}async addPreviewImage_(e){const t=await yl(e,"EPSG:4326"),i=e.getContext().getBoundingBoxes();if(i.length!==1)return;const n=i[0];let s={url:e.getAbsoluteUrl(),projection:t,imageExtent:fs(n,"EPSG:4326",t),crossOrigin:this.crossOrigin_};this.getSourceOptions_&&(s=await this.getSourceOptions_(ye.ImageStatic,s,e));const o=new Hl({source:new Pu(s)});return this.addLayer_(o,e),o}async addLayerForLink(e){const t=$x(e);if(!t)return;const i={attributions:e.getMetadata("attribution")||this.getData().getMetadata("attribution"),crossOrigin:this.crossOrigin_,url:t},n=async(o,a)=>(this.getSourceOptions_&&(a=await this.getSourceOptions_(o,a,e)),a),s=[];switch(e.rel){case"pmtiles":const a=await new Ro(i.url).getHeader();let l;switch(a.tileType){case dr.Mvt:l=new Vx(await n(ye.PMTilesVector,i));break;case dr.Avif:case dr.Jpeg:case dr.Png:case dr.Webp:l=new El(await n(ye.PMTilesRaster,i));break;default:return}s.push(l);break;case"tilejson":s.push(new Cu(await n(ye.TileJSON,i)));break;case"wms":if(!Array.isArray(e["wms:layers"]))break;for(const h in e["wms:layers"]){const f=e["wms:layers"][h]||"";let g="";Array.isArray(e["wms:styles"])&&typeof e["wms:styles"][h]=="string"&&(g=e["wms:styles"][h]);const d=Object.assign({LAYERS:f,STYLES:g},e["wms:dimensions"]);typeof e["wms:transparent"]=="boolean"&&(d.TRANSPARENT=String(e["wms:transparent"])),typeof e.type=="string"&&e.type.startsWith("image/")&&(d.FORMAT=e.type);const p=await n(ye.TileWMS,Object.assign({},i,{params:d}));s.push(new Vh(p))}break;case"wmts":const c=await this.getWmtsCapabilities_(t);if(!c)return;const u=Array.isArray(e["wmts:layer"])?e["wmts:layer"]:[e["wmts:layer"]];for(const h of u){let f=Object.assign({},i,{layer:h});typeof e.type=="string"&&e.type.startsWith("image/")&&(f.format=e.type),f=await n(ye.WMTS,f),s.push(new $h(Zl(c,f)))}break;case"xyz":s.push(new Ki(await n(ye.XYZ,i)));break;default:return}return s.map(o=>{let a;return o instanceof Xs?a=new Xh({source:o,declutter:!0}):o instanceof El?a=new hn({source:o}):a=new cs({source:o}),this.addLayer_(a,e),a})}async addGeoTiff_(e){if(this.buildTileUrlTemplate_&&!this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);let i={sources:[kx(e,this.bands_)]};const n=await yl(e);n&&(i.projection=n),this.getSourceOptions_&&(i=await this.getSourceOptions_(ye.GeoTIFF,i,e));const s=new Vo(i),o=new Promise((a,l)=>{s.on("error",l),s.on("change",()=>{s.getState()==="error"?l(s.getError()):a()})});try{await o;const a=new hn({source:s});return this.addLayer_(a,e),a}catch(a){if(this.useTileLayerAsFallback_)return await this.addTileLayerForImagery_(e);this.handleError_(a)}}async addTileLayerForImagery_(e){let t=this.buildTileUrlTemplate_(e);t instanceof Promise&&(t=await t);let i={crossOrigin:this.crossOrigin_,url:t};this.getSourceOptions_&&(i=await this.getSourceOptions_(ye.XYZ,i,e));const n=new cs({source:new Ki(i)});return this.addLayer_(n,e),n}addLayer_(e,t=null,i=0){t&&e.set("stac",t),e.setZIndex(i),this.getLayers().push(e)}addFootprint_(){let e=null;const t=this.getData();if(t.isItemCollection()||t.isCollectionCollection()?e=Uu(t.getBoundingBox()):e=t.toGeoJSON(),e){const i=this.createGeoJsonLayer_(e,xl(this.boundsStyle_,this),this.displayFootprint_);return i.set("bounds",!0),i.on("change",()=>this.setMap_(i.getMapInternal())),this.addLayer_(i,t,1),i}return null}async addGeoJson_(e){try{const t=await this.fetch_(e.getAbsoluteUrl()),i=this.createGeoJsonLayer_(t);return this.addLayer_(i,e),i}catch(t){this.handleError_(t)}}createGeoJsonLayer_(e,t=null,i=!0){const n=new ec,s=new bn({format:n,loader:(o,a,l)=>{e=Xi(e);const c=n.readFeatures(e,{featureProjection:l});s.addFeatures(c)}});return t||(t=_l),new kl({source:s,style:t,visible:i})}async addLabelExtension_(){const e=this.getData();if(!(e instanceof Qo))return;let t=e.getAssetsWithRoles(["labels","labels-vector"],!0),i;t.length>1&&(i=t.find(s=>s.roles.includes("labels-vector"))),i||(i=e.getAsset("vector_labels")),i||(t=e.getAssets().filter(s=>s.type===Fs&&!s.roles),t.length===1&&(i=t[0]));const n=e.getLinksWithRels(["source"]);if(i&&n.length>0){const s=n.map(async a=>{try{const l=await this.fetch_(a.getAbsoluteUrl());return Di(l)}catch(l){return this.handleError_(l),null}}),o=(await Promise.all(s)).filter(a=>a instanceof _t);await this.addChildren_(o,{displayFootprint:!1})}try{await this.addGeoJson_(i)}catch(s){this.handleError_(s)}}async updateLayers_(){const e=this.getLayers();for(let n=e.getLength()-1;n>=0;n--){const s=e.item(n);s.get("stac")&&!s.get("bounds")&&e.removeAt(n)}const t=this.getData();if(Array.isArray(this.displayWebMapLink_)){const n=this.getWebMapLinks().map(async s=>await this.addLayerForLink(s));await Promise.all(n)}this.children_&&await this.addChildren_(this.children_,this.childrenOptions_);const i=this.getAssets();if(i){const n=i.map(async s=>{if(s){if(s.type===Fs)return await this.addGeoJson_(s);if(s.isGeoTIFF())return await this.addGeoTiff_(s);if(s.canBrowserDisplayImage())return await this.addPreviewImage_(s)}});await Promise.all(n)}if(this.hasOnlyBounds()){if(t instanceof Jo)await this.addChildren_(t.getAll(),this.childrenOptions_);else if(t instanceof _t){if(t.isItem()&&t.supportsExtension(Gx)&&t.getMetadata("label:type")==="vector"){await this.addLabelExtension_();return}const n=this.getWebMapLinks();if(n.length>0)await this.addLayerForLink(n[0]);else{const s=t.getDefaultGeoTIFF(!0,!this.displayGeoTiffByDefault_);let o;if(s&&this.displayOverview_&&(o=await this.addGeoTiff_(s)),this.displayPreview_&&(!s||!o)){const a=t.getThumbnails(!0,"overview");a.length>0&&await this.addPreviewImage_(a[0])}}}}}hasOnlyBounds(){const e=this.getBoundsLayer();return typeof this.getLayersArray().find(i=>i!==e)>"u"}getWebMapLinks(){const e=this.getData();if(e instanceof nt)return[];let t=["xyz","tilejson","pmtiles","wmts","wms"];typeof this.displayWebMapLink_=="string"&&(t=[this.displayWebMapLink_]);let i=e.getLinksWithRels(t);return Array.isArray(this.displayWebMapLink_)?i=this.displayWebMapLink_.map(n=>{if(typeof n=="string"){const s=i.find(o=>o.id===n);return s||null}return n}).filter(n=>!!n):i.sort((n,s)=>{const o=t.indexOf(n.rel),a=t.indexOf(s.rel);return o-a}),i}async setAssets(e){if(Array.isArray(e)){const t=this.getData();this.assets_=e.map(i=>t instanceof _t&&typeof i=="string"?t.getAsset(i):i instanceof nt?i:new nt(i))}else this.assets_=null;await this.updateLayers_()}async setChildren(e,t={}){if(!e){this.children_=null,this.childrenOptions_={};return}e instanceof ju?this.children_=e.getAll():Xe(e)&&e.type==="FeatureCollection"?this.children_=Di(e,!this.disableMigration_).getAll():Array.isArray(e)?this.children_=e.map(i=>i instanceof _t?i:Di(i,!this.disableMigration_)):this.children_=null,this.children_&&this.children_.length===0&&(this.children_=null),this.childrenOptions_=t,await this.updateLayers_()}getData(){return this.get("stac")}getChildren(){return this.children_}getAssets(){return this.assets_}getExtent(){if(!this.map_)return;const e=this.map_.getView();if(!e)return;let t;const i=this.getData();i&&(t=i.getBoundingBox());const n=this.getChildren();if(!t&&n){const s=n.map(o=>o.getBoundingBox());t=Yo(s)}if(t)return fs(t,"EPSG:4326",e.getProjection())}getAttributions(){const e=[],t=this.getData();if(t){const i=t.getMetadata("attribution");i&&i.push(i)}return e}getSource(){return null}async getWmtsCapabilities_(e){try{const t=new URL(e);t.searchParams.set("service","wmts"),t.searchParams.set("request","GetCapabilities");const i=await this.fetch_(t.toString(),"text");return new go().read(i)}catch{return null}}}Wh(jh);window.eoxMapAdvancedOlLayers={Graticule:Bm,Heatmap:O_,Image,Layer:ks,VectorImage:D_,WebGLPoints:B_,WebGLTile:hn,WebGLVector:G_,STAC:ea};function Xx(r){const e=r[0],t=new Array(e);let i=1<<e-1,n,s;for(n=0;n<e;++n)s=48,r[1]&i&&(s+=1),r[2]&i&&(s+=2),t[n]=String.fromCharCode(s),i>>=1;return t.join("")}const Wx='<a class="ol-attribution-bing-tos" href="https://www.microsoft.com/maps/product/terms.html" target="_blank">Terms of Use</a>';class jx extends Ft{constructor(e){const t=e.hidpi!==void 0?e.hidpi:!1;super({cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:ce("EPSG:3857"),reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.hidpi_=t,this.culture_=e.culture!==void 0?e.culture:"en-us",this.maxZoom_=e.maxZoom!==void 0?e.maxZoom:-1,this.apiKey_=e.key,this.imagerySet_=e.imagerySet,this.placeholderTiles_=e.placeholderTiles;const i="https://dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.imagerySet_+"?uriScheme=https&include=ImageryProviders&key="+this.apiKey_+"&c="+this.culture_;fetch(i).then(n=>n.json()).then(n=>this.handleImageryMetadataResponse(n))}getApiKey(){return this.apiKey_}getImagerySet(){return this.imagerySet_}handleImageryMetadataResponse(e){if(e.statusCode!=200||e.statusDescription!="OK"||e.authenticationResultCode!="ValidCredentials"||e.resourceSets.length!=1||e.resourceSets[0].resources.length!=1){this.setState("error");return}const t=e.resourceSets[0].resources[0],i=this.maxZoom_==-1?t.zoomMax:this.maxZoom_,n=this.getProjection(),s=hi(n),o=this.hidpi_?2:1,a=t.imageWidth==t.imageHeight?t.imageWidth/o:[t.imageWidth/o,t.imageHeight/o],l=ui({extent:s,minZoom:t.zoomMin,maxZoom:i,tileSize:a});this.tileGrid=l;const c=this.culture_,u=this.hidpi_,h=this.placeholderTiles_;if(this.tileUrlFunction=Ws(t.imageUrlSubdomains.map(function(f){const g=[0,0,0],d=t.imageUrl.replace("{subdomain}",f).replace("{culture}",c);return function(p,m,y){if(!p)return;ls(p[0],p[1],p[2],g);const _=new URL(d.replace("{quadkey}",Xx(g))),E=_.searchParams;return u&&(E.set("dpi","d1"),E.set("device","mobile")),h===!0?E.delete("n"):h===!1&&E.set("n","z"),_.toString()}})),t.imageryProviders){const f=Ks(ce("EPSG:4326"),this.getProjection());this.setAttributions(g=>{const d=[],p=g.viewState,m=this.getTileGrid(),y=m.getZForResolution(p.resolution,this.zDirection),E=m.getTileCoordForCoordAndZ(p.center,y)[0];return t.imageryProviders.map(function(S){let v=!1;const w=S.coverageAreas;for(let A=0,C=w.length;A<C;++A){const P=w[A];if(E>=P.zoomMin&&E<=P.zoomMax){const R=P.bbox,U=[R[1],R[0],R[3],R[2]],M=br(U,f);if(Er(M,g.extent)){v=!0;break}}}v&&d.push(S.attribution)}),d.push(Wx),d})}this.setState("ready")}}class Hx extends Ki{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,maxZoom:e.maxZoom!==void 0?e.maxZoom:18,minZoom:e.minZoom,projection:e.projection,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection}),this.account_=e.account,this.mapId_=e.map||"",this.config_=e.config||{},this.templateCache_={},this.initializeMap_()}getConfig(){return this.config_}updateConfig(e){Object.assign(this.config_,e),this.initializeMap_()}setConfig(e){this.config_=e||{},this.initializeMap_()}initializeMap_(){const e=JSON.stringify(this.config_);if(this.templateCache_[e]){this.applyTemplate_(this.templateCache_[e]);return}let t="https://"+this.account_+".carto.com/api/v1/map";this.mapId_&&(t+="/named/"+this.mapId_);const i=new XMLHttpRequest;i.addEventListener("load",this.handleInitResponse_.bind(this,e)),i.addEventListener("error",this.handleInitError_.bind(this)),i.open("POST",t),i.setRequestHeader("Content-type","application/json"),i.send(JSON.stringify(this.config_))}handleInitResponse_(e,t){const i=t.target;if(!i.status||i.status>=200&&i.status<300){let n;try{n=JSON.parse(i.responseText)}catch{this.setState("error");return}this.applyTemplate_(n),this.templateCache_[e]=n,this.setState("ready")}else this.setState("error")}handleInitError_(e){this.setState("error")}applyTemplate_(e){const t="https://"+e.cdn_url.https+"/"+this.account_+"/api/v1/map/"+e.layergroupid+"/{z}/{x}/{y}.png";this.setUrl(t)}}class Zx extends bn{constructor(e){e=e||{},super({attributions:e.attributions,wrapX:e.wrapX}),this.resolution=void 0,this.distance=e.distance!==void 0?e.distance:20,this.minDistance=e.minDistance||0,this.interpolationRatio=0,this.features=[],this.geometryFunction=e.geometryFunction||function(t){const i=t.getGeometry();return et(!i||i.getType()==="Point","The default `geometryFunction` can only handle `Point` or null geometries"),i},this.createCustomCluster_=e.createCluster,this.source=null,this.boundRefresh_=this.refresh.bind(this),this.updateDistance(this.distance,this.minDistance),this.setSource(e.source||null)}clear(e){this.features.length=0,super.clear(e)}getDistance(){return this.distance}getSource(){return this.source}loadFeatures(e,t,i){var n;(n=this.source)==null||n.loadFeatures(e,t,i),t!==this.resolution&&(this.resolution=t,this.refresh())}setDistance(e){this.updateDistance(e,this.minDistance)}setMinDistance(e){this.updateDistance(this.distance,e)}getMinDistance(){return this.minDistance}setSource(e){this.source&&this.source.removeEventListener(ze.CHANGE,this.boundRefresh_),this.source=e,e&&e.addEventListener(ze.CHANGE,this.boundRefresh_),this.refresh()}refresh(){this.clear(),this.cluster(),this.addFeatures(this.features)}updateDistance(e,t){const i=e===0?0:Math.min(t,e)/e,n=e!==this.distance||this.interpolationRatio!==i;this.distance=e,this.minDistance=t,this.interpolationRatio=i,n&&this.refresh()}cluster(){if(this.resolution===void 0||!this.source)return;const e=di(),t=this.distance*this.resolution,i=this.source.getFeatures(),n={};for(let s=0,o=i.length;s<o;s++){const a=i[s];if(!(he(a)in n)){const l=this.geometryFunction(a);if(l){const c=l.getCoordinates();Mf(c,e),eo(e,t,e);const u=this.source.getFeaturesInExtent(e).filter(function(h){const f=he(h);return f in n?!1:(n[f]=!0,!0)});this.features.push(this.createCluster(u,e))}}}}createCluster(e,t){const i=[0,0];for(let a=e.length-1;a>=0;--a){const l=this.geometryFunction(e[a]);l?Ef(i,l.getCoordinates()):e.splice(a,1)}bf(i,1/e.length);const n=Bt(t),s=this.interpolationRatio,o=new xt([i[0]*(1-s)+n[0]*s,i[1]*(1-s)+n[1]*s]);return this.createCustomCluster_?this.createCustomCluster_(o,e):new lt({geometry:o,features:e})}}const Yx="https://tile.googleapis.com/v1/createSession",qx="https://tile.googleapis.com/v1/2dtiles",Kx="https://tile.googleapis.com/tile/v1/viewport",Jx=22;class Qx extends Ft{constructor(e){const t=!!e.highDpi;super({attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,projection:"EPSG:3857",reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,tilePixelRatio:t?2:1,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.apiKey_=e.key,this.error_=null;const i={mapType:e.mapType||"roadmap",language:e.language||"en-US",region:e.region||"US"};e.imageFormat&&(i.imageFormat=e.imageFormat),e.scale&&(i.scale=e.scale),t&&(i.highDpi=!0),e.layerTypes&&(i.layerTypes=e.layerTypes),e.styles&&(i.styles=e.styles),e.overlay===!0&&(i.overlay=!0),e.apiOptions&&(i.apiOptions=e.apiOptions),this.sessionTokenRequest_=i,this.sessionTokenValue_,this.sessionRefreshId_,this.previousViewportAttribution_,this.previousViewportExtent_,this.createSession_()}getError(){return this.error_}fetchSessionToken(e,t){return fetch(e,t)}async createSession_(){const e=Yx+"?key="+this.apiKey_,t={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.sessionTokenRequest_)},i=await this.fetchSessionToken(e,t);if(!i.ok){try{const h=await i.json();this.error_=new Error(h.error.message)}catch{this.error_=new Error("Error fetching session token")}this.setState("error");return}const n=await i.json(),s=this.getTilePixelRatio(1),o=[n.tileWidth/s,n.tileHeight/s];this.tileGrid=ui({extent:hi(this.getProjection()),maxZoom:Jx,tileSize:o});const a=n.session;this.sessionTokenValue_=a;const l=this.apiKey_;this.tileUrlFunction=function(h,f,g){const d=h[0],p=h[1],m=h[2];return`${qx}/${d}/${p}/${m}?session=${a}&key=${l}`};const c=parseInt(n.expiry,10)*1e3,u=Math.max(c-Date.now()-60*1e3,1);this.sessionRefreshId_=setTimeout(()=>this.createSession_(),u),this.setAttributions(this.fetchAttributions_.bind(this)),this.setState("ready")}async fetchAttributions_(e){if(e.viewHints[$t.ANIMATING]||e.viewHints[$t.INTERACTING]||e.animate)return this.previousViewportAttribution_;const[t,i]=da(Nf(e.extent),e.viewState.projection),[n,s]=da(Df(e.extent),e.viewState.projection),l=`zoom=${this.getTileGrid().getZForResolution(e.viewState.resolution,this.zDirection)}&north=${s}&south=${i}&east=${n}&west=${t}`;if(this.previousViewportExtent_==l)return this.previousViewportAttribution_;this.previousViewportExtent_=l;const c=this.sessionTokenValue_,u=this.apiKey_,h=`${Kx}?session=${c}&key=${u}&${l}`;return this.previousViewportAttribution_=await fetch(h).then(f=>f.json()).then(f=>f.copyright),this.previousViewportAttribution_}disposeInternal(){clearTimeout(this.sessionRefreshId_),super.disposeInternal()}}let Yu=class extends Gs{constructor(e,t,i,n,s,o,a){super(t,i,n,s,o,a),this.zoomifyImage_=null,this.tileSize_=e}getImage(){if(this.zoomifyImage_)return this.zoomifyImage_;const e=super.getImage();if(this.state==K.LOADED){const t=this.tileSize_;if(e.width==t[0]&&e.height==t[1])return this.zoomifyImage_=e,e;const i=zt(t[0],t[1]);return i.drawImage(e,0,0),this.zoomifyImage_=i.canvas,i.canvas}return e}};class eE extends Ft{constructor(e){const t=e.size,i=e.tierSizeCalculation!==void 0?e.tierSizeCalculation:"default",n=e.tilePixelRatio||1,s=t[0],o=t[1],a=[],l=e.tileSize||us;let c=l*n;switch(i){case"default":for(;s>c||o>c;)a.push([Math.ceil(s/c),Math.ceil(o/c)]),c+=c;break;case"truncated":let w=s,A=o;for(;w>c||A>c;)a.push([Math.ceil(w/c),Math.ceil(A/c)]),w>>=1,A>>=1;break;default:throw new Error("Unknown `tierSizeCalculation` configured")}a.push([1,1]),a.reverse();const u=[n],h=[0];for(let w=1,A=a.length;w<A;w++)u.push(n<<w),h.push(a[w-1][0]*a[w-1][1]+h[w-1]);u.reverse();const f=new Sn({tileSize:l,extent:e.extent||[0,-o,s,0],resolutions:u});let g=e.url;g&&!g.includes("{TileGroup}")&&!g.includes("{tileIndex}")&&(g+="{TileGroup}/{z}-{x}-{y}.jpg");const d=Yl(g);let p=l*n;function m(w){return function(A,C,P){if(!A)return;const R=A[0],U=A[1],M=A[2],z=U+M*a[R][0],N=(z+h[R])/p|0,G={z:R,x:U,y:M,tileIndex:z,TileGroup:"TileGroup"+N};return w.replace(/\{(\w+?)\}/g,function(ie,W){return G[W]})}}const y=Ws(d.map(m)),_=Yu.bind(null,st(l*n));super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,tilePixelRatio:n,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileClass:_,tileGrid:f,tileUrlFunction:y,transition:e.transition}),this.zDirection=e.zDirection;const E=f.getTileCoordForCoordAndResolution(Bt(f.getExtent()),u[u.length-1]),S=y(E,1,null),v=new Image;v.addEventListener("error",()=>{p=l,this.changed()}),v.src=S}}function kr(r){return r.toLocaleString("en",{maximumFractionDigits:10})}class tE extends Ft{constructor(e){const t=e||{};let i=t.url||"";i=i+(i.lastIndexOf("/")===i.length-1||i===""?"":"/");const n=t.version||ve.VERSION2,s=t.sizes||[],o=t.size;et(o!=null&&Array.isArray(o)&&o.length==2&&!isNaN(o[0])&&o[0]>0&&!isNaN(o[1])&&o[1]>0,"Missing or invalid `size`");const a=o[0],l=o[1],c=t.tileSize,u=t.tilePixelRatio||1,h=t.format||"jpg",f=t.quality||(t.version==ve.VERSION1?"native":"default");let g=t.resolutions||[];const d=t.supports||[],p=t.extent||[0,-l,a,0],m=s!=null&&Array.isArray(s)&&s.length>0,y=c!==void 0&&(typeof c=="number"&&Number.isInteger(c)&&c>0||Array.isArray(c)&&c.length>0),_=d!=null&&Array.isArray(d)&&(d.includes("regionByPx")||d.includes("regionByPct"))&&(d.includes("sizeByWh")||d.includes("sizeByH")||d.includes("sizeByW")||d.includes("sizeByPct"));let E,S,v;if(g.sort(function(P,R){return R-P}),y||_)if(c!=null&&(typeof c=="number"&&Number.isInteger(c)&&c>0?(E=c,S=c):Array.isArray(c)&&c.length>0&&((c.length==1||c[1]==null&&Number.isInteger(c[0]))&&(E=c[0],S=c[0]),c.length==2&&(Number.isInteger(c[0])&&Number.isInteger(c[1])?(E=c[0],S=c[1]):c[0]==null&&Number.isInteger(c[1])&&(E=c[1],S=c[1])))),(E===void 0||S===void 0)&&(E=us,S=us),g.length==0){v=Math.max(Math.ceil(Math.log(a/E)/Math.LN2),Math.ceil(Math.log(l/S)/Math.LN2));for(let P=v;P>=0;P--)g.push(Math.pow(2,P))}else{const P=Math.max(...g);v=Math.round(Math.log(P)/Math.LN2)}else if(E=a,S=l,g=[],m){s.sort(function(R,U){return R[0]-U[0]}),v=-1;const P=[];for(let R=0;R<s.length;R++){const U=a/s[R][0];if(g.length>0&&g[g.length-1]==U){P.push(R);continue}g.push(U),v++}if(P.length>0)for(let R=0;R<P.length;R++)s.splice(P[R]-R,1)}else g.push(1),s.push([a,l]),v=0;const w=new Sn({tileSize:[E,S],extent:p,origin:ds(p),resolutions:g}),A=function(P,R,U){let M,z;const N=P[0];if(N>v)return;const G=P[1],ie=P[2],W=g[N];if(!(G===void 0||ie===void 0||W===void 0||G<0||Math.ceil(a/W/E)<=G||ie<0||Math.ceil(l/W/S)<=ie)){if(_||y){const q=G*E*W,ne=ie*S*W;let ae=E*W,pe=S*W,be=E,me=S;if(q+ae>a&&(ae=a-q),ne+pe>l&&(pe=l-ne),q+E*W>a&&(be=Math.floor((a-q+W-1)/W)),ne+S*W>l&&(me=Math.floor((l-ne+W-1)/W)),q==0&&ae==a&&ne==0&&pe==l)M="full";else if(!_||d.includes("regionByPx"))M=q+","+ne+","+ae+","+pe;else if(d.includes("regionByPct")){const we=kr(q/a*100),Le=kr(ne/l*100),Ae=kr(ae/a*100),Me=kr(pe/l*100);M="pct:"+we+","+Le+","+Ae+","+Me}n==ve.VERSION3&&(!_||d.includes("sizeByWh"))?z=be+","+me:!_||d.includes("sizeByW")?z=be+",":d.includes("sizeByH")?z=","+me:d.includes("sizeByWh")?z=be+","+me:d.includes("sizeByPct")&&(z="pct:"+kr(100/W))}else if(M="full",m){const q=s[N][0],ne=s[N][1];n==ve.VERSION3?q==a&&ne==l?z="max":z=q+","+ne:q==a?z="full":z=q+","}else z=n==ve.VERSION3?"max":"full";return i+M+"/"+z+"/0/"+f+"."+h}},C=Yu.bind(null,st(c||256).map(function(P){return P*u}));super({attributions:t.attributions,attributionsCollapsible:t.attributionsCollapsible,cacheSize:t.cacheSize,crossOrigin:t.crossOrigin,interpolate:t.interpolate,projection:t.projection,reprojectionErrorThreshold:t.reprojectionErrorThreshold,state:t.state,tileClass:C,tileGrid:w,tilePixelRatio:t.tilePixelRatio,tileUrlFunction:A,transition:t.transition}),this.zDirection=t.zDirection}}function qu(r,e,t,i,n,s){const o=n.getCode().split(/:(?=\d+$)/).pop(),a=t/i,l=[pa(Fe(e)/a,aa),pa(ot(e)/a,aa)];s.SIZE=l[0]+","+l[1],s.BBOX=e.join(","),s.BBOXSR=o,s.IMAGESR=o,s.DPI=Math.round(s.DPI?s.DPI*i:90*i);const c=r.replace(/MapServer\/?$/,"MapServer/export").replace(/ImageServer\/?$/,"ImageServer/exportImage");return Ji(c,s)}function rE(r){const e=r.load?r.load:Lr,t=ce(r.projection||"EPSG:3857"),i=r.ratio??1.5,n=r.crossOrigin??null;return function(s,o,a){a=r.hidpi?a:1;const l={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};Object.assign(l,r.params),s=ql(s,o,a,i);const c=qu(r.url,s,o,a,t,l),u=new Image;return u.crossOrigin=n,e(u,c).then(h=>{const f=Fe(s)/h.width*a;return{image:h,extent:s,resolution:f,pixelRatio:a}})}}class iE extends tr{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Vs,this.params_=Object.assign({},e.params),this.imageSize_=[0,0],this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,i,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=rE({crossOrigin:this.crossOrigin_,params:this.params_,projection:n,hidpi:this.hidpi_,url:this.url_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Lr(s))})),super.getImageInternal(e,t,i,n))}getImageLoadFunction(){return this.imageLoadFunction_}getUrl(){return this.url_}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}setUrl(e){e!=this.url_&&(this.url_=e,this.loader=null,this.changed())}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}changed(){this.image=null,super.changed()}}class nE extends tr{constructor(e){e=e||{},super({attributions:e.attributions,interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions,state:e.state}),this.canvasFunction_=e.canvasFunction,this.canvas_=null,this.renderedRevision_=0,this.ratio_=e.ratio!==void 0?e.ratio:1.5}getImageInternal(e,t,i,n){t=this.findNearestResolution(t);let s=this.canvas_;if(s&&this.renderedRevision_==this.getRevision()&&s.getResolution()==t&&s.getPixelRatio()==i&&en(s.getExtent(),e))return s;e=e.slice(),ic(e,this.ratio_);const o=Fe(e)/t,a=ot(e)/t,l=[o*i,a*i],c=this.canvasFunction_.call(this,e,t,i,l,n);return c&&(s=new So(e,t,i,c)),this.canvas_=s,this.renderedRevision_=this.getRevision(),s}}function sE(r,e,t,i){const n=Fe(r),s=ot(r),o=e[0],a=e[1],l=.0254/i;return a*n>o*s?n*t/(o*l):s*t/(a*l)}function oE(r,e,t,i,n,s,o){const a=sE(t,i,s,o),l=Bt(t),c={OPERATION:n?"GETDYNAMICMAPOVERLAYIMAGE":"GETMAPIMAGE",VERSION:"2.0.0",LOCALE:"en",CLIENTAGENT:"ol/source/ImageMapGuide source",CLIP:"1",SETDISPLAYDPI:o,SETDISPLAYWIDTH:Math.round(i[0]),SETDISPLAYHEIGHT:Math.round(i[1]),SETVIEWSCALE:a,SETVIEWCENTERX:l[0],SETVIEWCENTERY:l[1]};return Object.assign(c,e),Ji(r,c)}function aE(r){const e=r.load||Lr,t=r.useOverlay??!1,i=r.metersPerUnit||1,n=r.displayDpi||96,s=r.ratio??1,o=r.crossOrigin??null;return function(a,l,c){const u=new Image;u.crossOrigin=o,a=ql(a,l,c,s);const h=Fe(a)/l,f=ot(a)/l,g=[h*c,f*c],d=oE(r.url,r.params,a,g,t,i,n);return e(u,d).then(p=>({image:p,extent:a,pixelRatio:c}))}}class lE extends tr{constructor(e){super({interpolate:e.interpolate,projection:e.projection,resolutions:e.resolutions}),this.crossOrigin_=e.crossOrigin!==void 0?e.crossOrigin:null,this.displayDpi_=e.displayDpi!==void 0?e.displayDpi:96,this.params_=Object.assign({},e.params),this.url_=e.url,this.imageLoadFunction_=e.imageLoadFunction!==void 0?e.imageLoadFunction:Vs,this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.metersPerUnit_=e.metersPerUnit!==void 0?e.metersPerUnit:1,this.ratio_=e.ratio!==void 0?e.ratio:1,this.useOverlay_=e.useOverlay!==void 0?e.useOverlay:!1,this.renderedRevision_=0,this.loaderProjection_=null}getParams(){return this.params_}getImageInternal(e,t,i,n){return this.url_===void 0?null:((!this.loader||this.loaderProjection_!==n)&&(this.loaderProjection_=n,this.loader=aE({crossOrigin:this.crossOrigin_,params:this.params_,hidpi:this.hidpi_,metersPerUnit:this.metersPerUnit_,url:this.url_,useOverlay:this.useOverlay_,ratio:this.ratio_,load:(s,o)=>(this.image.setImage(s),this.imageLoadFunction_(this.image,o),Lr(s))})),super.getImageInternal(e,t,i,n))}getImageLoadFunction(){return this.imageLoadFunction_}setParams(e){this.params_=Object.assign({},e),this.changed()}updateParams(e){Object.assign(this.params_,e),this.changed()}setImageLoadFunction(e){this.imageLoadFunction_=e,this.changed()}changed(){this.image=null,super.changed()}}const cE=new Error("Image failed to load");function Ku(r,e,t,i,n){return new Promise((s,o)=>{const a=new Image;a.crossOrigin=n.crossOrigin??null,a.addEventListener("load",()=>s(a)),a.addEventListener("error",()=>o(cE)),a.src=Kl(r,e,t,i,n.maxY)})}function bl(r){return function(e,t,i,n){const s=Hh(r,e,t,i);return Ku(s,e,t,i,n)}}function uE(r){return function(e,t,i,n){const s=r(e,t,i,n);return Ku(s,e,t,i,n)}}function Tl(r){let e;if(Array.isArray(r))e=bl(r);else if(typeof r=="string"){const t=Yl(r);e=bl(t)}else if(typeof r=="function")e=uE(r);else throw new Error("The url option must be a single template, an array of templates, or a function for getting a URL");return e}let wl=0;function Sl(r){return Array.isArray(r)?r.join(`
`):typeof r=="string"?r:(++wl,"url-function-key-"+wl)}class Ju extends bi{constructor(e){e=e||{};let t=e.loader,i;e.url&&(t=Tl(e.url),i=Sl(e.url));const n=t?e.state:"loading",s=e.wrapX===void 0?!0:e.wrapX;super({loader:t,key:i,attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,maxZoom:e.maxZoom,minZoom:e.minZoom,tileSize:e.tileSize,gutter:e.gutter,maxResolution:e.maxResolution,projection:e.projection,tileGrid:e.tileGrid,state:n,wrapX:s,transition:e.transition,interpolate:e.interpolate!==!1,crossOrigin:e.crossOrigin,zDirection:e.zDirection})}setUrl(e){const t=Tl(e);this.setLoader(t),this.setKey(Sl(e)),this.getState()!=="ready"&&this.setState("ready")}}const hE={"image/png":!0,"image/jpeg":!0,"image/gif":!0,"image/webp":!0},fE={"application/vnd.mapbox-vector-tile":!0,"application/geo+json":!0};function Qu(r,e){if(!e.length)return r;const t=new URL(r,"file:/");if(t.pathname.split("/").includes("collections"))return ni('The "collections" query parameter cannot be added to collection endpoints'),r;const i=e.map(o=>encodeURIComponent(o)).join(",");t.searchParams.append("collections",i);const n=r.split("?")[0],s=decodeURIComponent(t.searchParams.toString());return`${n}?${s}`}function dE(r,e,t){let i,n;for(let s=0;s<r.length;++s){const o=r[s];if(o.rel==="item"){if(o.type===e){i=o.href;break}(hE[o.type]||!n&&o.type.startsWith("image/"))&&(n=o.href)}}if(!i)if(n)i=n;else throw new Error('Could not find "item" link');return t&&(i=Qu(i,t)),i}function gE(r,e,t,i){let n,s;const o={};for(let a=0;a<r.length;++a){const l=r[a];if(o[l.type]=l.href,l.rel==="item"){if(l.type===e){n=l.href;break}fE[l.type]&&(s=l.href)}}if(!n&&t)for(let a=0;a<t.length;++a){const l=t[a];if(o[l]){n=o[l];break}}if(!n)if(s)n=s;else throw new Error('Could not find "item" link');return i&&(n=Qu(n,i)),n}function vl(r,e,t,i){let n=r.projection;if(!n&&(typeof e.crs=="string"?n=ce(e.crs):"uri"in e.crs&&(n=ce(e.crs.uri)),!n))throw new Error(`Unsupported CRS: ${JSON.stringify(e.crs)}`);const s=e.orderedAxes,a=!(s?s.slice(0,2).map(w=>w.replace(/E|X|Lon/i,"e").replace(/N|Y|Lat/i,"n")).join(""):n.getAxisOrientation()).startsWith("en"),l=e.tileMatrices,c={};for(let w=0;w<l.length;++w){const A=l[w];c[A.id]=A}const u={},h=[];if(i)for(let w=0;w<i.length;++w){const A=i[w],C=A.tileMatrix;h.push(C),u[C]=A}else for(let w=0;w<l.length;++w){const A=l[w].id;h.push(A)}const f=h.length,g=new Array(f),d=new Array(f),p=new Array(f),m=new Array(f),y=[-1/0,-1/0,1/0,1/0];for(let w=0;w<f;++w){const A=h[w],C=c[A],P=C.pointOfOrigin;a?g[w]=[P[1],P[0]]:g[w]=P,d[w]=C.cellSize,p[w]=[C.matrixWidth,C.matrixHeight],m[w]=[C.tileWidth,C.tileHeight];const R=u[A];if(R){const U=C.cellSize*C.tileWidth,M=g[w][0]+R.minTileCol*U,z=g[w][0]+(R.maxTileCol+1)*U,N=C.cellSize*C.tileHeight,G=C.cornerOfOrigin==="bottomLeft";let ie,W;G?(ie=g[w][1]+R.minTileRow*N,W=g[w][1]+(R.maxTileRow+1)*N):(ie=g[w][1]-(R.maxTileRow+1)*N,W=g[w][1]-R.minTileRow*N),Et(y,[M,ie,z,W],y)}}const _=new Sn({origins:g,resolutions:d,sizes:p,tileSizes:m,extent:i?y:void 0}),E=r.context,S=r.url;function v(w,A,C){if(!w)return;const P=h[w[0]],R=c[P],U=R.cornerOfOrigin==="bottomLeft",M={tileMatrix:P,tileCol:w[1],tileRow:U?-w[2]-1:w[2]};if(i){const N=u[R.id];if(M.tileCol<N.minTileCol||M.tileCol>N.maxTileCol||M.tileRow<N.minTileRow||M.tileRow>N.maxTileRow)return}Object.assign(M,E);const z=t.replace(/\{(\w+?)\}/g,function(N,G){return M[G]});return Iu(S,z)}return{grid:_,projection:n,urlTemplate:t,urlFunction:v}}function pE(r,e){const t=e.tileMatrixSetLimits;let i;if(e.dataType==="map")i=dE(e.links,r.mediaType,r.collections);else if(e.dataType==="vector")i=gE(e.links,r.mediaType,r.supportedMediaTypes,r.collections);else throw new Error('Expected tileset data type to be "map" or "vector"');if(e.tileMatrixSet)return vl(r,e.tileMatrixSet,i,t);const n=e.links.find(a=>a.rel==="http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme");if(!n)throw new Error("Expected http://www.opengis.net/def/rel/ogc/1.0/tiling-scheme link or tileMatrixSet");const s=n.href,o=Iu(r.url,s);return Lu(o).then(function(a){return vl(r,a,i,t)})}function eh(r){return Lu(r.url).then(function(e){return pE(r,e)})}class mE extends Ft{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,state:"loading",tileLoadFunction:e.tileLoadFunction,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,context:e.context||null,collections:e.collections};eh(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){ni(e),this.setState("error")}}class _E extends Xs{constructor(e){super({attributions:e.attributions,attributionsCollapsible:e.attributionsCollapsible,cacheSize:e.cacheSize,format:e.format,overlaps:e.overlaps,projection:e.projection,tileClass:e.tileClass,transition:e.transition,wrapX:e.wrapX,zDirection:e.zDirection,state:"loading"});const t={url:e.url,projection:this.getProjection(),mediaType:e.mediaType,supportedMediaTypes:e.format.supportedMediaTypes,context:e.context||null,collections:e.collections};eh(t).then(this.handleTileSetInfo_.bind(this)).catch(this.handleError_.bind(this))}handleTileSetInfo_(e){this.tileGrid=e.grid,this.projection=e.projection,this.setTileUrlFunction(e.urlFunction,e.urlTemplate),this.setState("ready")}handleError_(e){ni(e),this.setState("error")}}function th(r){return function(e){const t=e.buffers,i=e.meta,n=e.imageOps,s=e.width,o=e.height,a=t.length,l=t[0].byteLength;if(n){const f=new Array(a);for(let d=0;d<a;++d)f[d]=new ImageData(new Uint8ClampedArray(t[d]),s,o);return r(f,i).data.buffer}const c=new Uint8ClampedArray(l),u=new Array(a),h=new Array(a);for(let f=0;f<a;++f)u[f]=new Uint8ClampedArray(t[f]),h[f]=[0,0,0,0];for(let f=0;f<l;f+=4){for(let d=0;d<a;++d){const p=u[d];h[d][0]=p[f],h[d][1]=p[f+1],h[d][2]=p[f+2],h[d][3]=p[f+3]}const g=r(h,i);c[f]=g[0],c[f+1]=g[1],c[f+2]=g[2],c[f+3]=g[3]}return c.buffer}}function yE(r,e){const i=Object.keys(r.lib||{}).map(function(s){return"const "+s+" = "+r.lib[s].toString()+";"}).concat(["const __minion__ = ("+th.toString()+")(",r.operation.toString(),");",'self.addEventListener("message", function(event) {',"  const buffer = __minion__(event.data);","  self.postMessage({buffer: buffer, meta: event.data.meta}, [buffer]);","});"]),n=new Worker(typeof Blob>"u"?"data:text/javascript;base64,"+Buffer.from(i.join(`
`),"binary").toString("base64"):URL.createObjectURL(new Blob(i,{type:"text/javascript"})));return n.addEventListener("message",e),n}function xE(r,e){const t=th(r.operation);let i=!1;return{postMessage:function(n){setTimeout(function(){i||e({data:{buffer:t(n),meta:n.meta}})},0)},terminate:function(){i=!0}}}class EE extends rc{constructor(e){super(),this.imageOps_=!!e.imageOps;let t;e.threads===0?t=0:this.imageOps_?t=1:t=e.threads||1;const i=new Array(t);if(t)for(let n=0;n<t;++n)i[n]=yE(e,this.onWorkerMessage_.bind(this,n));else i[0]=xE(e,this.onWorkerMessage_.bind(this,0));this.workers_=i,this.queue_=[],this.maxQueueLength_=e.queue||1/0,this.running_=0,this.dataLookup_={},this.job_=null}process(e,t,i){this.enqueue_({inputs:e,meta:t,callback:i}),this.dispatch_()}enqueue_(e){for(this.queue_.push(e);this.queue_.length>this.maxQueueLength_;)this.queue_.shift().callback(null,null)}dispatch_(){if(this.running_||this.queue_.length===0)return;const e=this.queue_.shift();this.job_=e;const t=e.inputs[0].width,i=e.inputs[0].height,n=e.inputs.map(function(l){return l.data.buffer}),s=this.workers_.length;if(this.running_=s,s===1){this.workers_[0].postMessage({buffers:n,meta:e.meta,imageOps:this.imageOps_,width:t,height:i},n);return}const o=e.inputs[0].data.length,a=4*Math.ceil(o/4/s);for(let l=0;l<s;++l){const c=l*a,u=[];for(let h=0,f=n.length;h<f;++h)u.push(n[h].slice(c,c+a));this.workers_[l].postMessage({buffers:u,meta:e.meta,imageOps:this.imageOps_,width:t,height:i},u)}}onWorkerMessage_(e,t){this.disposed||(this.dataLookup_[e]=t.data,--this.running_,this.running_===0&&this.resolveJob_())}resolveJob_(){const e=this.job_,t=this.workers_.length;let i,n;if(t===1)i=new Uint8ClampedArray(this.dataLookup_[0].buffer),n=this.dataLookup_[0].meta;else{const s=e.inputs[0].data.length;i=new Uint8ClampedArray(s),n=new Array(t);const o=4*Math.ceil(s/4/t);for(let a=0;a<t;++a){const l=this.dataLookup_[a].buffer,c=a*o;i.set(new Uint8ClampedArray(l),c),n[a]=this.dataLookup_[a].meta}}this.job_=null,this.dataLookup_={},e.callback(null,new ImageData(i,e.inputs[0].width,e.inputs[0].height),n),this.dispatch_()}disposeInternal(){for(let e=0;e<this.workers_.length;++e)this.workers_[e].terminate();this.workers_.length=0}}const Rl={BEFOREOPERATIONS:"beforeoperations",AFTEROPERATIONS:"afteroperations"};class Al extends nc{constructor(e,t,i){super(e),this.extent=t.extent,this.resolution=t.viewState.resolution/t.pixelRatio,this.data=i}}class rh extends tr{constructor(e){super({projection:null}),this.on,this.once,this.un,this.processor_=null,this.operationType_=e.operationType!==void 0?e.operationType:"pixel",this.threads_=e.threads!==void 0?e.threads:1,this.layers_=wE(e.sources);const t=this.changed.bind(this);for(let i=0,n=this.layers_.length;i<n;++i)this.layers_[i].addEventListener(ze.CHANGE,t);this.useResolutions_=e.resolutions!==null,this.tileQueue_=new Zh(function(){return 1},this.processSources_.bind(this)),this.requestedFrameState_,this.renderedImageCanvas_=null,this.renderedRevision_,this.frameState_={animate:!1,coordinateToPixelTransform:Ce(),declutter:null,extent:null,index:0,layerIndex:0,layerStatesArray:TE(this.layers_),pixelRatio:1,pixelToCoordinateTransform:Ce(),postRenderFunctions:[],size:[0,0],tileQueue:this.tileQueue_,time:Date.now(),usedTiles:{},viewState:{rotation:0},viewHints:[],wantedTiles:{},mapId:he(this),renderTargets:{}},this.setAttributions(function(i){var s;const n=[];for(let o=0,a=e.sources.length;o<a;++o){const l=e.sources[o],c=l instanceof js?l:l.getSource();if(!c)continue;const u=(s=c.getAttributions())==null?void 0:s(i);typeof u=="string"?n.push(u):u!==void 0&&n.push(...u)}return n}),e.operation!==void 0&&this.setOperation(e.operation,e.lib)}setOperation(e,t){this.processor_&&this.processor_.dispose(),this.processor_=new EE({operation:e,imageOps:this.operationType_==="image",queue:1,lib:t,threads:this.threads_}),this.changed()}updateFrameState_(e,t,i){const n=Object.assign({},this.frameState_);n.viewState=Object.assign({},n.viewState);const s=Bt(e);n.size[0]=Math.ceil(Fe(e)/t),n.size[1]=Math.ceil(ot(e)/t),n.extent=[s[0]-n.size[0]*t/2,s[1]-n.size[1]*t/2,s[0]+n.size[0]*t/2,s[1]+n.size[1]*t/2],n.time=Date.now();const o=n.viewState;return o.center=s,o.projection=i,o.resolution=t,n}allSourcesReady_(){let e=!0,t;for(let i=0,n=this.layers_.length;i<n;++i)if(t=this.layers_[i].getSource(),!t||t.getState()!=="ready"){e=!1;break}return e}getImage(e,t,i,n){if(!this.allSourcesReady_())return null;this.tileQueue_.loadMoreTiles(16,16),t=this.findNearestResolution(t);const s=this.updateFrameState_(e,t,n);if(this.requestedFrameState_=s,this.renderedImageCanvas_){const o=this.renderedImageCanvas_.getResolution(),a=this.renderedImageCanvas_.getExtent();(t!==o||!si(s.extent,a))&&(this.renderedImageCanvas_=null)}return(!this.renderedImageCanvas_||this.getRevision()!==this.renderedRevision_)&&this.processSources_(),s.animate&&requestAnimationFrame(this.changed.bind(this)),this.renderedImageCanvas_}processSources_(){const e=this.requestedFrameState_,t=this.layers_.length,i=new Array(t);for(let s=0;s<t;++s){e.layerIndex=s,e.renderTargets={};const o=bE(this.layers_[s],e);if(o)i[s]=o;else return}const n={};this.dispatchEvent(new Al(Rl.BEFOREOPERATIONS,e,n)),this.processor_.process(i,n,this.onWorkerComplete_.bind(this,e))}onWorkerComplete_(e,t,i,n){if(t||!i)return;const s=e.extent,o=e.viewState.resolution;if(o!==this.requestedFrameState_.viewState.resolution||!si(s,this.requestedFrameState_.extent))return;let a;if(this.renderedImageCanvas_)a=this.renderedImageCanvas_.getImage().getContext("2d");else{const l=Math.round(Fe(s)/o),c=Math.round(ot(s)/o);a=zt(l,c),this.renderedImageCanvas_=new So(s,o,1,a.canvas)}a.putImageData(i,0,0),e.animate?requestAnimationFrame(this.changed.bind(this)):this.changed(),this.renderedRevision_=this.getRevision(),this.dispatchEvent(new Al(Rl.AFTEROPERATIONS,e,n))}getResolutions(e){if(!this.useResolutions_)return null;let t=super.getResolutions();if(!t)for(let i=0,n=this.layers_.length;i<n&&(t=this.layers_[i].getSource().getResolutions(e),!t);++i);return t}disposeInternal(){this.processor_&&this.processor_.dispose(),super.disposeInternal()}}rh.prototype.dispose;let Ht=null;function bE(r,e){const t=r.getRenderer();if(!t)throw new Error("Unsupported layer type: "+r);if(!t.prepareFrame(e))return null;const i=e.size[0],n=e.size[1];if(i===0||n===0)return null;const s=t.renderFrame(e,null);let o;if(s instanceof HTMLCanvasElement)o=s;else{if(s&&(o=s.firstElementChild),!(o instanceof HTMLCanvasElement))throw new Error("Unsupported rendered element: "+o);if(o.width===i&&o.height===n)return o.getContext("2d").getImageData(0,0,i,n)}if(!Ht)Ht=zt(i,n,void 0,{willReadFrequently:!0});else{const a=Ht.canvas;a.width!==i||a.height!==n?Ht=zt(i,n,void 0,{willReadFrequently:!0}):Ht.clearRect(0,0,i,n)}return Ht.drawImage(o,0,0,i,n),Ht.getImageData(0,0,i,n)}function TE(r){return r.map(function(e){return e.getLayerState()})}function wE(r){const e=r.length,t=new Array(e);for(let i=0;i<e;++i)t[i]=SE(r[i]);return t}function SE(r){let e;return r instanceof js?r instanceof $s?e=new cs({source:r}):r instanceof tr&&(e=new Hl({source:r})):e=r,e}const vE='&copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a>',RE='&copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a>',AE='&copy; <a href="https://stamen.com/" target="_blank">Stamen Design</a>',PE={stamen_terrain:{extension:"png"},stamen_terrain_background:{extension:"png"},stamen_terrain_labels:{extension:"png"},stamen_terrain_lines:{extension:"png"},stamen_toner_background:{extension:"png"},stamen_toner:{extension:"png"},stamen_toner_labels:{extension:"png"},stamen_toner_lines:{extension:"png"},stamen_toner_lite:{extension:"png"},stamen_watercolor:{extension:"jpg"},alidade_smooth:{extension:"png"},alidade_smooth_dark:{extension:"png"},alidade_satellite:{extension:"png"},outdoors:{extension:"png"},osm_bright:{extension:"png"}},LE={stamen_terrain:{minZoom:0,maxZoom:18,retina:!0},stamen_toner:{minZoom:0,maxZoom:20,retina:!0},stamen_watercolor:{minZoom:1,maxZoom:18,retina:!1}};class IE extends Ki{constructor(e){const t=e.layer.indexOf("-"),i=t==-1?e.layer:e.layer.slice(0,t),n=LE[i]||{minZoom:0,maxZoom:20,retina:!0},s=PE[e.layer],o=e.apiKey?"?api_key="+e.apiKey:"",a=n.retina&&e.retina?"@2x":"",l=e.url!==void 0?e.url:"https://tiles.stadiamaps.com/tiles/"+e.layer+"/{z}/{x}/{y}"+a+"."+s.extension+o,c=[vE,RE,Yh];e.layer.startsWith("stamen_")&&c.splice(1,0,AE),super({attributions:c,cacheSize:e.cacheSize,crossOrigin:"anonymous",interpolate:e.interpolate,maxZoom:e.maxZoom!==void 0?e.maxZoom:n.maxZoom,minZoom:e.minZoom!==void 0?e.minZoom:n.minZoom,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileLoadFunction:e.tileLoadFunction,transition:e.transition,url:l,tilePixelRatio:a?2:1,wrapX:e.wrapX,zDirection:e.zDirection})}}class CE extends Ft{constructor(e){e=e||{},super({attributions:e.attributions,cacheSize:e.cacheSize,crossOrigin:e.crossOrigin,interpolate:e.interpolate,projection:e.projection,reprojectionErrorThreshold:e.reprojectionErrorThreshold,tileGrid:e.tileGrid,tileLoadFunction:e.tileLoadFunction,url:e.url,urls:e.urls,wrapX:e.wrapX!==void 0?e.wrapX:!0,transition:e.transition,zDirection:e.zDirection}),this.params_=Object.assign({},e.params),this.hidpi_=e.hidpi!==void 0?e.hidpi:!0,this.tmpExtent_=di(),this.setKey(this.getKeyForParams_())}getKeyForParams_(){let e=0;const t=[];for(const i in this.params_)t[e++]=i+"-"+this.params_[i];return t.join("/")}getParams(){return this.params_}getRequestUrl_(e,t,i,n,s,o){const a=this.urls;if(!a)return;let l;if(a.length==1)l=a[0];else{const c=Uf(qh(e),a.length);l=a[c]}return qu(l,i,(this.tileGrid||this.getTileGridForProjection(s)).getResolution(e[0]),n,s,o)}getTilePixelRatio(e){return this.hidpi_?e:1}setParams(e){this.params_=Object.assign({},e),this.setKey(this.getKeyForParams_())}updateParams(e){Object.assign(this.params_,e),this.setKey(this.getKeyForParams_())}tileUrlFunction(e,t,i){let n=this.getTileGrid();if(n||(n=this.getTileGridForProjection(i)),n.getResolutions().length<=e[0])return;t!=1&&!this.hidpi_&&(t=1);const s=n.getTileCoordExtent(e,this.tmpExtent_);let o=st(n.getTileSize(e[0]),this.tmpSize);t!=1&&(o=Kh(o,t,this.tmpSize));const a={F:"image",FORMAT:"PNG32",TRANSPARENT:!0};return Object.assign(a,this.params_),this.getRequestUrl_(e,o,s,t,i,a)}}class FE extends Ju{constructor(e){e=e||{};const t=e.template||"z:{z} x:{x} y:{y}",i=e.source;super({transition:0,wrapX:e.wrapX!==void 0?e.wrapX:i!==void 0?i.getWrapX():void 0});const n=()=>{var o;this.projection=e.projection!==void 0?ce(e.projection):i!==void 0?i.getProjection():this.projection,this.tileGrid=e.tileGrid!==void 0?e.tileGrid:i!==void 0?i.getTileGrid():this.tileGrid,this.zDirection=e.zDirection!==void 0?e.zDirection:i!==void 0?i.zDirection:this.zDirection,i instanceof bi&&(this.transformMatrix=((o=i.transformMatrix)==null?void 0:o.slice())||null);const s=this.tileGrid;s&&this.setTileSizes(s.getResolutions().map((a,l)=>st(s.getTileSize(l)).map(c=>Math.max(Math.floor(c),1)))),this.setLoader((a,l,c,u)=>{const h=Kl(t,a,l,c,u.maxY),[f,g]=this.getTileSize(a),d=zt(f,g);return d.strokeStyle="grey",d.strokeRect(.5,.5,f+.5,g+.5),d.fillStyle="grey",d.strokeStyle="white",d.textAlign="center",d.textBaseline="middle",d.font="24px sans-serif",d.lineWidth=4,d.strokeText(h,f/2,g/2,f),d.fillText(h,f/2,g/2,f),Promise.resolve(d.canvas)}),this.setState("ready")};if(i===void 0||i.getState()==="ready")n();else{const s=()=>{i.getState()==="ready"&&(i.removeEventListener(ze.CHANGE,s),n())};i.addEventListener(ze.CHANGE,s)}}}class OE extends ef{constructor(e,t,i,n,s,o){super(e,t),this.src_=i,this.extent_=n,this.preemptive_=s,this.grid_=null,this.keys_=null,this.data_=null,this.jsonp_=o}getImage(){return null}getData(e){if(!this.grid_||!this.keys_)return null;const t=(e[0]-this.extent_[0])/(this.extent_[2]-this.extent_[0]),i=(e[1]-this.extent_[1])/(this.extent_[3]-this.extent_[1]),n=this.grid_[Math.floor((1-i)*this.grid_.length)];if(typeof n!="string")return null;let s=n.charCodeAt(Math.floor(t*n.length));s>=93&&s--,s>=35&&s--,s-=32;let o=null;if(s in this.keys_){const a=this.keys_[s];this.data_&&a in this.data_?o=this.data_[a]:o=a}return o}forDataAtCoordinate(e,t,i){this.state==K.EMPTY&&i===!0?(this.state=K.IDLE,Bf(this,ze.CHANGE,n=>{t(this.getData(e))}),this.loadInternal_()):i===!0?setTimeout(()=>{t(this.getData(e))},0):t(this.getData(e))}getKey(){return this.src_}handleError_(){this.state=K.ERROR,this.changed()}handleLoad_(e){this.grid_=e.grid,this.keys_=e.keys,this.data_=e.data,this.state=K.LOADED,this.changed()}loadInternal_(){if(this.state==K.IDLE)if(this.state=K.LOADING,this.jsonp_)Xo(this.src_,this.handleLoad_.bind(this),this.handleError_.bind(this));else{const e=new XMLHttpRequest;e.addEventListener("load",this.onXHRLoad_.bind(this)),e.addEventListener("error",this.onXHRError_.bind(this)),e.open("GET",this.src_),e.send()}}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let i;try{i=JSON.parse(t.responseText)}catch{this.handleError_();return}this.handleLoad_(i)}else this.handleError_()}onXHRError_(e){this.handleError_()}load(){this.preemptive_?this.loadInternal_():this.setState(K.EMPTY)}}class ME extends $s{constructor(e){if(super({projection:ce("EPSG:3857"),state:"loading",wrapX:e.wrapX!==void 0?e.wrapX:!0,zDirection:e.zDirection}),this.preemptive_=e.preemptive!==void 0?e.preemptive:!0,this.tileUrlFunction_=Jh,this.template_=void 0,this.jsonp_=e.jsonp||!1,this.tileCache_=new $l(512),e.url)if(this.jsonp_)Xo(e.url,this.handleTileJSONResponse.bind(this),this.handleTileJSONError.bind(this));else{const t=new XMLHttpRequest;t.addEventListener("load",this.onXHRLoad_.bind(this)),t.addEventListener("error",this.onXHRError_.bind(this)),t.open("GET",e.url),t.send()}else if(e.tileJSON)this.handleTileJSONResponse(e.tileJSON);else throw new Error("Either `url` or `tileJSON` options must be provided")}onXHRLoad_(e){const t=e.target;if(!t.status||t.status>=200&&t.status<300){let i;try{i=JSON.parse(t.responseText)}catch{this.handleTileJSONError();return}this.handleTileJSONResponse(i)}else this.handleTileJSONError()}onXHRError_(e){this.handleTileJSONError()}getTemplate(){return this.template_}forDataAtCoordinateAndResolution(e,t,i,n){if(this.tileGrid){const s=this.tileGrid.getZForResolution(t,this.zDirection),o=this.tileGrid.getTileCoordForCoordAndZ(e,s),a=this.getTile(o[0],o[1],o[2],1,this.getProjection());a.getState()==K.IDLE&&a.load(),a.forDataAtCoordinate(e,i,n)}else n===!0?setTimeout(function(){i(null)},0):i(null)}handleTileJSONError(){this.setState("error")}handleTileJSONResponse(e){const t=ce("EPSG:4326"),i=this.getProjection();let n;if(e.bounds!==void 0){const u=Ks(t,i);n=br(e.bounds,u)}const s=hi(i),o=e.minzoom||0,a=e.maxzoom||22,l=ui({extent:s,maxZoom:a,minZoom:o});this.tileGrid=l,this.template_=e.template;const c=e.grids;if(!c){this.setState("error");return}if(this.tileUrlFunction_=jl(c,l),e.attribution){const u=n!==void 0?n:s;this.setAttributions(function(h){return Er(u,h.extent)?[e.attribution]:null})}this.setState("ready")}getTile(e,t,i,n,s){const o=[e,t,i],a=this.getTileCoordForTileUrlFunction(o,s),l=this.tileUrlFunction_(a,n,s),c=`${this.getKey()},${Qh(e,t,i)}`;if(this.tileCache_.containsKey(c))return this.tileCache_.get(c);this.tileCache_.expireCache();const u=new OE(o,l!==void 0?K.IDLE:K.EMPTY,l!==void 0?l:"",this.tileGrid.getTileCoordExtent(o),this.preemptive_,this.jsonp_);return this.tileCache_.set(c,u),u}}class NE extends Ft{constructor(e){super({attributions:e.attributions,cacheSize:e.cacheSize,tilePixelRatio:e.tilePixelRatio,transition:e.transition,interpolate:e.interpolate!==void 0?e.interpolate:!0,key:e.key,attributionsCollapsible:e.attributionsCollapsible,zDirection:e.zDirection,wrapX:e.wrapX}),this.version_=e.version!==void 0?e.version:"1.0.0",this.dimensions_=e.dimensions!==void 0?e.dimensions:{},this.layer_=e.layer,fetch(e.url).then(t=>t.text()).then(t=>new window.DOMParser().parseFromString(t,"application/xml")).then(t=>{this.handleCapabilitiesResponse(t,e)})}handleCapabilitiesResponse(e,t){const n=new go().read(e),s=Zl(n,t);this.crossOrigin=s.crossOrigin,this.projection=s.projection,this.tileGrid=s.tileGrid,this.requestEncoding_=s.requestEncoding,this.matrixSet_=s.matrixSet,this.style_=s.style,this.format_=s.format,this.dimensions_=s.dimensions,this.setUrls(s.urls),this.urls&&this.urls.length>0&&(this.tileUrlFunction=Ws(this.urls.map(this.createFromWMTSTemplate.bind(this)))),this.setState("ready")}createFromWMTSTemplate(e){const t=this.requestEncoding_,i={layer:this.layer_,style:this.style_,tilematrixset:this.matrixSet_};t==="KVP"&&Object.assign(i,{Service:"WMTS",Request:"GetTile",Version:this.version_,Format:this.format_}),e=t==="KVP"?Ji(e,i):e.replace(/\{(\w+?)\}/g,(o,a)=>a.toLowerCase()in i?i[a.toLowerCase()]:o);const n=this.tileGrid,s=this.dimensions_;return function(o){if(!o)return;const a={TileMatrix:n.getMatrixId(o[0]),TileCol:o[1],TileRow:o[2]};Object.assign(a,s);let l=e;return t==="KVP"?l=Ji(l,a):l=l.replace(/\{(\w+?)\}/g,(c,u)=>a[u]),l}}}const At=new Uint8Array([102,103,98,3,102,103,98,0]),Ye=4,$r=4,Vr=4,vi=4,Mt=new Int32Array(2),Pl=new Float32Array(Mt.buffer),Ll=new Float64Array(Mt.buffer),Ui=new Uint16Array(new Uint8Array([1,0]).buffer)[0]===1;var Os;(function(r){r[r.UTF8_BYTES=1]="UTF8_BYTES",r[r.UTF16_STRING=2]="UTF16_STRING"})(Os||(Os={}));class ct{constructor(e){this.bytes_=e,this.position_=0,this.text_decoder_=new TextDecoder}static allocate(e){return new ct(new Uint8Array(e))}clear(){this.position_=0}bytes(){return this.bytes_}position(){return this.position_}setPosition(e){this.position_=e}capacity(){return this.bytes_.length}readInt8(e){return this.readUint8(e)<<24>>24}readUint8(e){return this.bytes_[e]}readInt16(e){return this.readUint16(e)<<16>>16}readUint16(e){return this.bytes_[e]|this.bytes_[e+1]<<8}readInt32(e){return this.bytes_[e]|this.bytes_[e+1]<<8|this.bytes_[e+2]<<16|this.bytes_[e+3]<<24}readUint32(e){return this.readInt32(e)>>>0}readInt64(e){return BigInt.asIntN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readUint64(e){return BigInt.asUintN(64,BigInt(this.readUint32(e))+(BigInt(this.readUint32(e+4))<<BigInt(32)))}readFloat32(e){return Mt[0]=this.readInt32(e),Pl[0]}readFloat64(e){return Mt[Ui?0:1]=this.readInt32(e),Mt[Ui?1:0]=this.readInt32(e+4),Ll[0]}writeInt8(e,t){this.bytes_[e]=t}writeUint8(e,t){this.bytes_[e]=t}writeInt16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeUint16(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8}writeInt32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeUint32(e,t){this.bytes_[e]=t,this.bytes_[e+1]=t>>8,this.bytes_[e+2]=t>>16,this.bytes_[e+3]=t>>24}writeInt64(e,t){this.writeInt32(e,Number(BigInt.asIntN(32,t))),this.writeInt32(e+4,Number(BigInt.asIntN(32,t>>BigInt(32))))}writeUint64(e,t){this.writeUint32(e,Number(BigInt.asUintN(32,t))),this.writeUint32(e+4,Number(BigInt.asUintN(32,t>>BigInt(32))))}writeFloat32(e,t){Pl[0]=t,this.writeInt32(e,Mt[0])}writeFloat64(e,t){Ll[0]=t,this.writeInt32(e,Mt[Ui?0:1]),this.writeInt32(e+4,Mt[Ui?1:0])}getBufferIdentifier(){if(this.bytes_.length<this.position_+$r+Vr)throw new Error("FlatBuffers: ByteBuffer is too short to contain an identifier.");let e="";for(let t=0;t<Vr;t++)e+=String.fromCharCode(this.readInt8(this.position_+$r+t));return e}__offset(e,t){const i=e-this.readInt32(e);return t<this.readInt16(i)?this.readInt16(i+t):0}__union(e,t){return e.bb_pos=t+this.readInt32(t),e.bb=this,e}__string(e,t){e+=this.readInt32(e);const i=this.readInt32(e);e+=$r;const n=this.bytes_.subarray(e,e+i);return t===Os.UTF8_BYTES?n:this.text_decoder_.decode(n)}__union_with_string(e,t){return typeof e=="string"?this.__string(t):this.__union(e,t)}__indirect(e){return e+this.readInt32(e)}__vector(e){return e+this.readInt32(e)+$r}__vector_len(e){return this.readInt32(e+this.readInt32(e))}__has_identifier(e){if(e.length!=Vr)throw new Error("FlatBuffers: file identifier must be length "+Vr);for(let t=0;t<Vr;t++)if(e.charCodeAt(t)!=this.readInt8(this.position()+$r+t))return!1;return!0}createScalarList(e,t){const i=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&i.push(s)}return i}createObjList(e,t){const i=[];for(let n=0;n<t;++n){const s=e(n);s!==null&&i.push(s.unpack())}return i}}var ue,Ie=((ue={})[ue.Byte=0]="Byte",ue[ue.UByte=1]="UByte",ue[ue.Bool=2]="Bool",ue[ue.Short=3]="Short",ue[ue.UShort=4]="UShort",ue[ue.Int=5]="Int",ue[ue.UInt=6]="UInt",ue[ue.Long=7]="Long",ue[ue.ULong=8]="ULong",ue[ue.Float=9]="Float",ue[ue.Double=10]="Double",ue[ue.String=11]="String",ue[ue.Json=12]="Json",ue[ue.DateTime=13]="DateTime",ue[ue.Binary=14]="Binary",ue);class Pe{constructor(){re(this,"bb",null);re(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsColumn(e,t){return(t||new Pe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsColumn(e,t){return e.setPosition(e.position()+vi),(t||new Pe).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}type(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readUint8(this.bb_pos+e):Ie.Byte}title(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}width(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.readInt32(this.bb_pos+e):-1}precision(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.readInt32(this.bb_pos+e):-1}scale(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readInt32(this.bb_pos+e):-1}nullable(){let e=this.bb.__offset(this.bb_pos,18);return!e||!!this.bb.readInt8(this.bb_pos+e)}unique(){let e=this.bb.__offset(this.bb_pos,20);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}primaryKey(){let e=this.bb.__offset(this.bb_pos,22);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}metadata(e){let t=this.bb.__offset(this.bb_pos,24);return t?this.bb.__string(this.bb_pos+t,e):null}static startColumn(e){e.startObject(11)}static addName(e,t){e.addFieldOffset(0,t,0)}static addType(e,t){e.addFieldInt8(1,t,Ie.Byte)}static addTitle(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWidth(e,t){e.addFieldInt32(4,t,-1)}static addPrecision(e,t){e.addFieldInt32(5,t,-1)}static addScale(e,t){e.addFieldInt32(6,t,-1)}static addNullable(e,t){e.addFieldInt8(7,+t,1)}static addUnique(e,t){e.addFieldInt8(8,+t,0)}static addPrimaryKey(e,t){e.addFieldInt8(9,+t,0)}static addMetadata(e,t){e.addFieldOffset(10,t,0)}static endColumn(e){let t=e.endObject();return e.requiredField(t,4),t}static createColumn(e,t,i,n,s,o,a,l,c,u,h,f){return Pe.startColumn(e),Pe.addName(e,t),Pe.addType(e,i),Pe.addTitle(e,n),Pe.addDescription(e,s),Pe.addWidth(e,o),Pe.addPrecision(e,a),Pe.addScale(e,l),Pe.addNullable(e,c),Pe.addUnique(e,u),Pe.addPrimaryKey(e,h),Pe.addMetadata(e,f),Pe.endColumn(e)}}var te,Ne=((te={})[te.Unknown=0]="Unknown",te[te.Point=1]="Point",te[te.LineString=2]="LineString",te[te.Polygon=3]="Polygon",te[te.MultiPoint=4]="MultiPoint",te[te.MultiLineString=5]="MultiLineString",te[te.MultiPolygon=6]="MultiPolygon",te[te.GeometryCollection=7]="GeometryCollection",te[te.CircularString=8]="CircularString",te[te.CompoundCurve=9]="CompoundCurve",te[te.CurvePolygon=10]="CurvePolygon",te[te.MultiCurve=11]="MultiCurve",te[te.MultiSurface=12]="MultiSurface",te[te.Curve=13]="Curve",te[te.Surface=14]="Surface",te[te.PolyhedralSurface=15]="PolyhedralSurface",te[te.TIN=16]="TIN",te[te.Triangle=17]="Triangle",te);class Be{constructor(){re(this,"bb",null);re(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsGeometry(e,t){return(t||new Be).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsGeometry(e,t){return e.setPosition(e.position()+vi),(t||new Be).__init(e.readInt32(e.position())+e.position(),e)}ends(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.readUint32(this.bb.__vector(this.bb_pos+t)+4*e):0}endsLength(){let e=this.bb.__offset(this.bb_pos,4);return e?this.bb.__vector_len(this.bb_pos+e):0}endsArray(){let e=this.bb.__offset(this.bb_pos,4);return e?new Uint32Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}xy(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}xyLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}xyArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}z(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}zLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}zArray(){let e=this.bb.__offset(this.bb_pos,8);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}m(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}mLength(){let e=this.bb.__offset(this.bb_pos,10);return e?this.bb.__vector_len(this.bb_pos+e):0}mArray(){let e=this.bb.__offset(this.bb_pos,10);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}t(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}tLength(){let e=this.bb.__offset(this.bb_pos,12);return e?this.bb.__vector_len(this.bb_pos+e):0}tArray(){let e=this.bb.__offset(this.bb_pos,12);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}tm(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.readUint64(this.bb.__vector(this.bb_pos+t)+8*e):BigInt(0)}tmLength(){let e=this.bb.__offset(this.bb_pos,14);return e?this.bb.__vector_len(this.bb_pos+e):0}type(){let e=this.bb.__offset(this.bb_pos,16);return e?this.bb.readUint8(this.bb_pos+e):Ne.Unknown}parts(e,t){let i=this.bb.__offset(this.bb_pos,18);return i?(t||new Be).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+i)+4*e),this.bb):null}partsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}static startGeometry(e){e.startObject(8)}static addEnds(e,t){e.addFieldOffset(0,t,0)}static createEndsVector(e,t){e.startVector(4,t.length,4);for(let i=t.length-1;i>=0;i--)e.addInt32(t[i]);return e.endVector()}static startEndsVector(e,t){e.startVector(4,t,4)}static addXy(e,t){e.addFieldOffset(1,t,0)}static createXyVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addFloat64(t[i]);return e.endVector()}static startXyVector(e,t){e.startVector(8,t,8)}static addZ(e,t){e.addFieldOffset(2,t,0)}static createZVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addFloat64(t[i]);return e.endVector()}static startZVector(e,t){e.startVector(8,t,8)}static addM(e,t){e.addFieldOffset(3,t,0)}static createMVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addFloat64(t[i]);return e.endVector()}static startMVector(e,t){e.startVector(8,t,8)}static addT(e,t){e.addFieldOffset(4,t,0)}static createTVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addFloat64(t[i]);return e.endVector()}static startTVector(e,t){e.startVector(8,t,8)}static addTm(e,t){e.addFieldOffset(5,t,0)}static createTmVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addInt64(t[i]);return e.endVector()}static startTmVector(e,t){e.startVector(8,t,8)}static addType(e,t){e.addFieldInt8(6,t,Ne.Unknown)}static addParts(e,t){e.addFieldOffset(7,t,0)}static createPartsVector(e,t){e.startVector(4,t.length,4);for(let i=t.length-1;i>=0;i--)e.addOffset(t[i]);return e.endVector()}static startPartsVector(e,t){e.startVector(4,t,4)}static endGeometry(e){return e.endObject()}static createGeometry(e,t,i,n,s,o,a,l,c){return Be.startGeometry(e),Be.addEnds(e,t),Be.addXy(e,i),Be.addZ(e,n),Be.addM(e,s),Be.addT(e,o),Be.addTm(e,a),Be.addType(e,l),Be.addParts(e,c),Be.endGeometry(e)}}class Qe{constructor(){re(this,"bb",null);re(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsFeature(e,t){return(t||new Qe).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsFeature(e,t){return e.setPosition(e.position()+vi),(t||new Qe).__init(e.readInt32(e.position())+e.position(),e)}geometry(e){let t=this.bb.__offset(this.bb_pos,4);return t?(e||new Be).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}properties(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readUint8(this.bb.__vector(this.bb_pos+t)+e):0}propertiesLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}propertiesArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Uint8Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}columns(e,t){let i=this.bb.__offset(this.bb_pos,8);return i?(t||new Pe).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+i)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.__vector_len(this.bb_pos+e):0}static startFeature(e){e.startObject(3)}static addGeometry(e,t){e.addFieldOffset(0,t,0)}static addProperties(e,t){e.addFieldOffset(1,t,0)}static createPropertiesVector(e,t){e.startVector(1,t.length,1);for(let i=t.length-1;i>=0;i--)e.addInt8(t[i]);return e.endVector()}static startPropertiesVector(e,t){e.startVector(1,t,1)}static addColumns(e,t){e.addFieldOffset(2,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let i=t.length-1;i>=0;i--)e.addOffset(t[i]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static endFeature(e){return e.endObject()}static finishFeatureBuffer(e,t){e.finish(t)}static finishSizePrefixedFeatureBuffer(e,t){e.finish(t,void 0,!0)}static createFeature(e,t,i,n){return Qe.startFeature(e),Qe.addGeometry(e,t),Qe.addProperties(e,i),Qe.addColumns(e,n),Qe.endFeature(e)}}function ns(r,e){let t=[];for(let i=0;i<r.length;i+=2){let n=[r[i],r[i+1]];e&&n.push(e[i>>1]),t.push(n)}return t}new TextEncoder;let Il=new TextDecoder;function DE(r,e){let t={};if(!e||e.length===0)return t;let i=r.propertiesArray();if(!i)return t;let n=new DataView(i.buffer,i.byteOffset),s=r.propertiesLength(),o=0;for(;o<s;){let a=n.getUint16(o,!0);o+=2;let l=e[a],c=l.name;switch(l.type){case Ie.Bool:t[c]=!!n.getUint8(o),o+=1;break;case Ie.Byte:t[c]=n.getInt8(o),o+=1;break;case Ie.UByte:t[c]=n.getUint8(o),o+=1;break;case Ie.Short:t[c]=n.getInt16(o,!0),o+=2;break;case Ie.UShort:t[c]=n.getUint16(o,!0),o+=2;break;case Ie.Int:t[c]=n.getInt32(o,!0),o+=4;break;case Ie.UInt:t[c]=n.getUint32(o,!0),o+=4;break;case Ie.Long:t[c]=Number(n.getBigInt64(o,!0)),o+=8;break;case Ie.ULong:t[c]=Number(n.getBigUint64(o,!0)),o+=8;break;case Ie.Float:t[c]=n.getFloat32(o,!0),o+=4;break;case Ie.Double:t[c]=n.getFloat64(o,!0),o+=8;break;case Ie.DateTime:case Ie.String:{let u=n.getUint32(o,!0);o+=4,t[c]=Il.decode(i.subarray(o,o+u)),o+=u;break}case Ie.Json:{let u=n.getUint32(o,!0);o+=4;let h=Il.decode(i.subarray(o,o+u));t[c]=JSON.parse(h),o+=u;break}case Ie.Binary:{let u=n.getUint32(o,!0);o+=4,t[c]=i.subarray(o,o+u),o+=u;break}default:throw Error(`Unknown type ${l.type}`)}}return t}const ta=new Uint8Array(0);function UE(){return this._source.cancel()}function BE(r,e){if(!r.length)return e;if(!e.length)return r;var t=new Uint8Array(r.length+e.length);return t.set(r),t.set(e,r.length),t}function GE(){var r=this,e=r._array.subarray(r._index);return r._source.read().then(function(t){return r._array=ta,r._index=0,t.done?e.length>0?{done:!1,value:e}:{done:!0,value:void 0}:{done:!1,value:BE(e,t.value)}})}function zE(r){if((r|=0)<0)throw new Error("invalid length");var e=this,t=this._array.length-this._index;if(this._index+r<=this._array.length)return Promise.resolve(this._array.subarray(this._index,this._index+=r));var i=new Uint8Array(r);return i.set(this._array.subarray(this._index)),function n(){return e._source.read().then(function(s){return s.done?(e._array=ta,e._index=0,t>0?i.subarray(0,t):null):t+s.value.length>=r?(e._array=s.value,e._index=r-t,i.set(s.value.subarray(0,r-t),t),i):(i.set(s.value,t),t+=s.value.length,n())})}()}function kE(r){return typeof r.slice=="function"?r:new Dn(typeof r.read=="function"?r:r.getReader())}function Dn(r){this._source=r,this._array=ta,this._index=0}Dn.prototype.read=GE;Dn.prototype.slice=zE;Dn.prototype.cancel=UE;class Je{constructor(){re(this,"bb",null);re(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsCrs(e,t){return(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsCrs(e,t){return e.setPosition(e.position()+vi),(t||new Je).__init(e.readInt32(e.position())+e.position(),e)}org(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}code(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.readInt32(this.bb_pos+e):0}name(e){let t=this.bb.__offset(this.bb_pos,8);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,10);return t?this.bb.__string(this.bb_pos+t,e):null}wkt(e){let t=this.bb.__offset(this.bb_pos,12);return t?this.bb.__string(this.bb_pos+t,e):null}codeString(e){let t=this.bb.__offset(this.bb_pos,14);return t?this.bb.__string(this.bb_pos+t,e):null}static startCrs(e){e.startObject(6)}static addOrg(e,t){e.addFieldOffset(0,t,0)}static addCode(e,t){e.addFieldInt32(1,t,0)}static addName(e,t){e.addFieldOffset(2,t,0)}static addDescription(e,t){e.addFieldOffset(3,t,0)}static addWkt(e,t){e.addFieldOffset(4,t,0)}static addCodeString(e,t){e.addFieldOffset(5,t,0)}static endCrs(e){return e.endObject()}static createCrs(e,t,i,n,s,o,a){return Je.startCrs(e),Je.addOrg(e,t),Je.addCode(e,i),Je.addName(e,n),Je.addDescription(e,s),Je.addWkt(e,o),Je.addCodeString(e,a),Je.endCrs(e)}}class dn{constructor(){re(this,"bb",null);re(this,"bb_pos",0)}__init(e,t){return this.bb_pos=e,this.bb=t,this}static getRootAsHeader(e,t){return(t||new dn).__init(e.readInt32(e.position())+e.position(),e)}static getSizePrefixedRootAsHeader(e,t){return e.setPosition(e.position()+vi),(t||new dn).__init(e.readInt32(e.position())+e.position(),e)}name(e){let t=this.bb.__offset(this.bb_pos,4);return t?this.bb.__string(this.bb_pos+t,e):null}envelope(e){let t=this.bb.__offset(this.bb_pos,6);return t?this.bb.readFloat64(this.bb.__vector(this.bb_pos+t)+8*e):0}envelopeLength(){let e=this.bb.__offset(this.bb_pos,6);return e?this.bb.__vector_len(this.bb_pos+e):0}envelopeArray(){let e=this.bb.__offset(this.bb_pos,6);return e?new Float64Array(this.bb.bytes().buffer,this.bb.bytes().byteOffset+this.bb.__vector(this.bb_pos+e),this.bb.__vector_len(this.bb_pos+e)):null}geometryType(){let e=this.bb.__offset(this.bb_pos,8);return e?this.bb.readUint8(this.bb_pos+e):Ne.Unknown}hasZ(){let e=this.bb.__offset(this.bb_pos,10);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasM(){let e=this.bb.__offset(this.bb_pos,12);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasT(){let e=this.bb.__offset(this.bb_pos,14);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}hasTm(){let e=this.bb.__offset(this.bb_pos,16);return!!e&&!!this.bb.readInt8(this.bb_pos+e)}columns(e,t){let i=this.bb.__offset(this.bb_pos,18);return i?(t||new Pe).__init(this.bb.__indirect(this.bb.__vector(this.bb_pos+i)+4*e),this.bb):null}columnsLength(){let e=this.bb.__offset(this.bb_pos,18);return e?this.bb.__vector_len(this.bb_pos+e):0}featuresCount(){let e=this.bb.__offset(this.bb_pos,20);return e?this.bb.readUint64(this.bb_pos+e):BigInt("0")}indexNodeSize(){let e=this.bb.__offset(this.bb_pos,22);return e?this.bb.readUint16(this.bb_pos+e):16}crs(e){let t=this.bb.__offset(this.bb_pos,24);return t?(e||new Je).__init(this.bb.__indirect(this.bb_pos+t),this.bb):null}title(e){let t=this.bb.__offset(this.bb_pos,26);return t?this.bb.__string(this.bb_pos+t,e):null}description(e){let t=this.bb.__offset(this.bb_pos,28);return t?this.bb.__string(this.bb_pos+t,e):null}metadata(e){let t=this.bb.__offset(this.bb_pos,30);return t?this.bb.__string(this.bb_pos+t,e):null}static startHeader(e){e.startObject(14)}static addName(e,t){e.addFieldOffset(0,t,0)}static addEnvelope(e,t){e.addFieldOffset(1,t,0)}static createEnvelopeVector(e,t){e.startVector(8,t.length,8);for(let i=t.length-1;i>=0;i--)e.addFloat64(t[i]);return e.endVector()}static startEnvelopeVector(e,t){e.startVector(8,t,8)}static addGeometryType(e,t){e.addFieldInt8(2,t,Ne.Unknown)}static addHasZ(e,t){e.addFieldInt8(3,+t,0)}static addHasM(e,t){e.addFieldInt8(4,+t,0)}static addHasT(e,t){e.addFieldInt8(5,+t,0)}static addHasTm(e,t){e.addFieldInt8(6,+t,0)}static addColumns(e,t){e.addFieldOffset(7,t,0)}static createColumnsVector(e,t){e.startVector(4,t.length,4);for(let i=t.length-1;i>=0;i--)e.addOffset(t[i]);return e.endVector()}static startColumnsVector(e,t){e.startVector(4,t,4)}static addFeaturesCount(e,t){e.addFieldInt64(8,t,BigInt("0"))}static addIndexNodeSize(e,t){e.addFieldInt16(9,t,16)}static addCrs(e,t){e.addFieldOffset(10,t,0)}static addTitle(e,t){e.addFieldOffset(11,t,0)}static addDescription(e,t){e.addFieldOffset(12,t,0)}static addMetadata(e,t){e.addFieldOffset(13,t,0)}static endHeader(e){return e.endObject()}static finishHeaderBuffer(e,t){e.finish(t)}static finishSizePrefixedHeaderBuffer(e,t){e.finish(t,void 0,!0)}}function Un(r){let e=dn.getRootAsHeader(r),t=e.featuresCount(),i=e.indexNodeSize(),n=[];for(let a=0;a<e.columnsLength();a++){let l=e.columns(a);if(!l)throw Error("Column unexpectedly missing");if(!l.name())throw Error("Column name unexpectedly missing");n.push({name:l.name(),type:l.type(),title:l.title(),description:l.description(),width:l.width(),precision:l.precision(),scale:l.scale(),nullable:l.nullable(),unique:l.unique(),primary_key:l.primaryKey()})}let s=e.crs(),o=s?{org:s.org(),code:s.code(),name:s.name(),description:s.description(),wkt:s.wkt(),code_string:s.codeString()}:null;return{geometryType:e.geometryType(),columns:n,envelope:null,featuresCount:Number(t),indexNodeSize:i,crs:o,title:e.title(),description:e.description(),metadata:e.metadata()}}const yn=class yn{constructor(){re(this,"_extraRequestThreshold",262144)}extraRequestThreshold(){return this._extraRequestThreshold}setExtraRequestThreshold(e){if(e<0)throw Error("extraRequestThreshold cannot be negative");this._extraRequestThreshold=e}};re(yn,"global",new yn);let gn=yn;const $E=40,VE=16;function Bn(r,e){e=Math.min(Math.max(+e,2),65535);let t=r,i=t;do i+=t=Math.ceil(t/e);while(t!==1);return 40*i}function XE(r,e){if(e<2)throw Error("Node size must be at least 2");if(r===0)throw Error("Number of items must be greater than 0");let t=r,i=t,n=[t];do i+=t=Math.ceil(t/e),n.push(t);while(t!==1);let s=[];for(let a of(t=i,n))s.push(t-a),t-=a;let o=[];for(let a=0;a<n.length;a++)o.push([s[a],s[a]+n[a]]);return o}async function*ih(r,e,t,i){class n{constructor(g,d){re(this,"_level");re(this,"nodes");this._level=d,this.nodes=g}level(){return this._level}startNodeIdx(){return this.nodes[0]}endNodeIdx(){return this.nodes[1]}extendEndNodeIdx(g){this.nodes[1]=g}toString(){return`[NodeRange level: ${this._level}, nodes: ${this.nodes[0]}-${this.nodes[1]}]`}}let{minX:s,minY:o,maxX:a,maxY:l}=t,c=XE(r,e),u=c[0][0],h=[new n([0,1],c.length-1)];for(;h.length!==0;){let f=h.shift(),g=f.startNodeIdx(),d=g>=u,p=(()=>{let[,_]=c[f.level()],E=Math.min(f.endNodeIdx()+e,_);return d&&E<_?E+1:E})(),m=p-g,y=new DataView(await i(40*g,40*m));for(let _=g;_<p;_++){let E=_-g,S=40*E;if(a<y.getFloat64(S+0,!0)||l<y.getFloat64(S+8,!0)||s>y.getFloat64(S+16,!0)||o>y.getFloat64(S+24,!0))continue;let v=y.getBigUint64(S+32,!0);if(d){let P=(()=>{if(_<r-1){let U=(E+1)*40;return y.getBigUint64(U+32,!0)-v}return null})(),R=_-u;yield[Number(v),R,Number(P)];continue}let w=gn.global.extraRequestThreshold()/40,A=h[h.length-1];if(A!==void 0&&A.level()===f.level()-1&&v<A.endNodeIdx()+w){A.extendEndNodeIdx(Number(v));continue}let C=(()=>{let P=f.level()-1;return new n([Number(v),Number(v)+1],P)})();A!==void 0&&(A.level(),C.level()),h.push(C)}}}class ra{constructor(e,t,i,n){re(this,"bytes");re(this,"header");re(this,"headerLength");re(this,"indexLength");this.bytes=e,this.header=t,this.headerLength=i,this.indexLength=n}static open(e){if(!e.subarray(0,3).every((o,a)=>At[a]===o))throw Error("Not a FlatGeobuf file");let t=new DataView(e.buffer).getUint32(8,!0);if(t>10485760||t<8)throw Error("Invalid header size");let i=e.subarray(12,12+t),n=Un(new ct(i)),s=Bn(n.featuresCount,n.indexNodeSize);return new ra(e,n,t,s)}async*selectBbox(e){let t=this.lengthBeforeTree(),i=async(n,s)=>{let o=t+n;return this.bytes.slice(o,o+s).buffer};for await(let n of ih(this.header.featuresCount,this.header.indexNodeSize,e,i)){let[s,o]=n,a=this.readFeature(s);yield{id:o,feature:a}}}lengthBeforeTree(){return At.length+Ye+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}readFeature(e){let t=e+this.lengthBeforeFeatures(),i=new DataView(this.bytes.buffer).getUint32(t,!0),n=this.bytes.subarray(t+4,t+4+i),s=new Uint8Array(i+Ye);s.set(n,Ye);let o=new ct(s);return o.setPosition(Ye),Qe.getRootAsFeature(o)}}/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Ms=function(r,e){return Ms=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var n in i)i.hasOwnProperty(n)&&(t[n]=i[n])},Ms(r,e)};function WE(r,e){Ms(r,e);function t(){this.constructor=r}r.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function Rr(r,e,t,i){function n(s){return s instanceof t?s:new t(function(o){o(s)})}return new(t||(t=Promise))(function(s,o){function a(u){try{c(i.next(u))}catch(h){o(h)}}function l(u){try{c(i.throw(u))}catch(h){o(h)}}function c(u){u.done?s(u.value):n(u.value).then(a,l)}c((i=i.apply(r,[])).next())})}function Vt(r,e){var t={label:0,sent:function(){if(s[0]&1)throw s[1];return s[1]},trys:[],ops:[]},i,n,s,o;return o={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function a(c){return function(u){return l([c,u])}}function l(c){if(i)throw new TypeError("Generator is already executing.");for(;t;)try{if(i=1,n&&(s=c[0]&2?n.return:c[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,c[1])).done)return s;switch(n=0,s&&(c=[c[0]&2,s.value]),c[0]){case 0:case 1:s=c;break;case 4:return t.label++,{value:c[1],done:!1};case 5:t.label++,n=c[1],c=[0];continue;case 7:c=t.ops.pop(),t.trys.pop();continue;default:if(s=t.trys,!(s=s.length>0&&s[s.length-1])&&(c[0]===6||c[0]===2)){t=0;continue}if(c[0]===3&&(!s||c[1]>s[0]&&c[1]<s[3])){t.label=c[1];break}if(c[0]===6&&t.label<s[1]){t.label=s[1],s=c;break}if(s&&t.label<s[2]){t.label=s[2],t.ops.push(c);break}s[2]&&t.ops.pop(),t.trys.pop();continue}c=e.call(r,t)}catch(u){c=[6,u],n=0}finally{i=s=0}if(c[0]&5)throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}function Br(r){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&r[e],i=0;if(t)return t.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&i>=r.length&&(r=void 0),{value:r&&r[i++],done:!r}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function li(r){return this instanceof li?(this.v=r,this):new li(r)}function jE(r,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var i=t.apply(r,e||[]),n,s=[];return n={},o("next"),o("throw"),o("return"),n[Symbol.asyncIterator]=function(){return this},n;function o(f){i[f]&&(n[f]=function(g){return new Promise(function(d,p){s.push([f,g,d,p])>1||a(f,g)})})}function a(f,g){try{l(i[f](g))}catch(d){h(s[0][3],d)}}function l(f){f.value instanceof li?Promise.resolve(f.value.v).then(c,u):h(s[0][2],f)}function c(f){a("next",f)}function u(f){a("throw",f)}function h(f,g){f(g),s.shift(),s.length&&a(s[0][0],s[0][1])}}var nh=function(r){WE(e,r);function e(t){var i=r.call(this,t)||this;return Object.defineProperty(i,"name",{value:"RepeaterOverflowError",enumerable:!1}),typeof Object.setPrototypeOf=="function"?Object.setPrototypeOf(i,i.constructor.prototype):i.__proto__=i.constructor.prototype,typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(i,i.constructor),i}return e}(Error);(function(){function r(e){if(e<0)throw new RangeError("Capacity may not be less than 0");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return this._q.length>=this._c},enumerable:!1,configurable:!0}),r.prototype.add=function(e){if(this.full)throw new Error("Buffer full");this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();(function(){function r(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),r.prototype.add=function(e){for(;this._q.length>=this._c;)this._q.shift();this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();(function(){function r(e){if(e<1)throw new RangeError("Capacity may not be less than 1");this._c=e,this._q=[]}return Object.defineProperty(r.prototype,"empty",{get:function(){return this._q.length===0},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"full",{get:function(){return!1},enumerable:!1,configurable:!0}),r.prototype.add=function(e){this._q.length<this._c&&this._q.push(e)},r.prototype.remove=function(){if(this.empty)throw new Error("Buffer empty");return this._q.shift()},r})();function Ns(r){r!=null&&typeof r.then=="function"&&r.then(_n,_n)}var ss=0,Cl=1,er=2,pn=3,Ds=4,mn=1024,_n=function(){};function xr(r){var e=r.err,t=Promise.resolve(r.execution).then(function(i){if(e!=null)throw e;return i});return r.err=void 0,r.execution=t.then(function(){},function(){}),r.pending===void 0?t:r.pending.then(function(){return t})}function Kt(r,e){var t=r.state>=pn;return Promise.resolve(e).then(function(i){return!t&&r.state>=Ds?xr(r).then(function(n){return{value:n,done:!0}}):{value:i,done:t}})}function ia(r,e){var t,i;if(!(r.state>=er))if(r.state=er,r.onnext(),r.onstop(),r.err==null&&(r.err=e),r.pushes.length===0&&(typeof r.buffer>"u"||r.buffer.empty))Jr(r);else try{for(var n=Br(r.pushes),s=n.next();!s.done;s=n.next()){var o=s.value;o.resolve()}}catch(a){t={error:a}}finally{try{s&&!s.done&&(i=n.return)&&i.call(n)}finally{if(t)throw t.error}}}function Jr(r){var e,t;if(!(r.state>=pn)){r.state<er&&ia(r),r.state=pn,r.buffer=void 0;try{for(var i=Br(r.nexts),n=i.next();!n.done;n=i.next()){var s=n.value,o=r.pending===void 0?xr(r):r.pending.then(function(){return xr(r)});s.resolve(Kt(r,o))}}catch(a){e={error:a}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}r.pushes=[],r.nexts=[]}}function Fl(r){r.state>=Ds||(r.state<pn&&Jr(r),r.state=Ds)}function HE(r,e){if(Ns(e),r.pushes.length>=mn)throw new nh("No more than "+mn+" pending calls to push are allowed on a single repeater.");if(r.state>=er)return Promise.resolve(void 0);var t=r.pending===void 0?Promise.resolve(e):r.pending.then(function(){return e});t=t.catch(function(l){r.state<er&&(r.err=l),Fl(r)});var i;if(r.nexts.length){var n=r.nexts.shift();n.resolve(Kt(r,t)),r.nexts.length?i=Promise.resolve(r.nexts[0].value):typeof r.buffer<"u"&&!r.buffer.full?i=Promise.resolve(void 0):i=new Promise(function(l){return r.onnext=l})}else typeof r.buffer<"u"&&!r.buffer.full?(r.buffer.add(t),i=Promise.resolve(void 0)):i=new Promise(function(l){return r.pushes.push({resolve:l,value:t})});var s=!0,o={},a=i.catch(function(l){if(s)throw l});return o.then=function(l,c){return s=!1,Promise.prototype.then.call(i,l,c)},o.catch=function(l){return s=!1,Promise.prototype.catch.call(i,l)},o.finally=i.finally.bind(i),r.pending=t.then(function(){return a}).catch(function(l){r.err=l,Fl(r)}),o}function ZE(r){var e=ia.bind(null,r),t=new Promise(function(i){return r.onstop=i});return e.then=t.then.bind(t),e.catch=t.catch.bind(t),e.finally=t.finally.bind(t),e}function YE(r){if(!(r.state>=Cl)){r.state=Cl;var e=HE.bind(null,r),t=ZE(r);r.execution=new Promise(function(i){return i(r.executor(e,t))}),r.execution.catch(function(){return ia(r)})}}var Bi=new WeakMap,Ri=function(){function r(e,t){Bi.set(this,{executor:e,buffer:t,err:void 0,state:ss,pushes:[],nexts:[],pending:void 0,execution:void 0,onnext:_n,onstop:_n})}return r.prototype.next=function(e){Ns(e);var t=Bi.get(this);if(t===void 0)throw new Error("WeakMap error");if(t.nexts.length>=mn)throw new nh("No more than "+mn+" pending calls to next are allowed on a single repeater.");if(t.state<=ss&&YE(t),t.onnext(e),typeof t.buffer<"u"&&!t.buffer.empty){var i=Kt(t,t.buffer.remove());if(t.pushes.length){var n=t.pushes.shift();t.buffer.add(n.value),t.onnext=n.resolve}return i}else if(t.pushes.length){var s=t.pushes.shift();return t.onnext=s.resolve,Kt(t,s.value)}else if(t.state>=er)return Jr(t),Kt(t,xr(t));return new Promise(function(o){return t.nexts.push({resolve:o,value:e})})},r.prototype.return=function(e){Ns(e);var t=Bi.get(this);if(t===void 0)throw new Error("WeakMap error");return Jr(t),t.execution=Promise.resolve(t.execution).then(function(){return e}),Kt(t,xr(t))},r.prototype.throw=function(e){var t=Bi.get(this);if(t===void 0)throw new Error("WeakMap error");return t.state<=ss||t.state>=er||typeof t.buffer<"u"&&!t.buffer.empty?(Jr(t),t.err==null&&(t.err=e),Kt(t,xr(t))):this.next(Promise.reject(e))},r.prototype[Symbol.asyncIterator]=function(){return this},r.race=qE,r.merge=KE,r.zip=JE,r.latest=QE,r}();function Gn(r,e){var t,i,n=[],s=function(c){c!=null&&typeof c[Symbol.asyncIterator]=="function"?n.push(c[Symbol.asyncIterator]()):c!=null&&typeof c[Symbol.iterator]=="function"?n.push(c[Symbol.iterator]()):n.push(function(){return jE(this,arguments,function(){return Vt(this,function(f){switch(f.label){case 0:return e.yieldValues?[4,li(c)]:[3,3];case 1:return[4,f.sent()];case 2:f.sent(),f.label=3;case 3:return e.returnValues?[4,li(c)]:[3,5];case 4:return[2,f.sent()];case 5:return[2]}})})}())};try{for(var o=Br(r),a=o.next();!a.done;a=o.next()){var l=a.value;s(l)}}catch(c){t={error:c}}finally{try{a&&!a.done&&(i=o.return)&&i.call(o)}finally{if(t)throw t.error}}return n}function qE(r){var e=this,t=Gn(r,{returnValues:!0});return new Ri(function(i,n){return Rr(e,void 0,void 0,function(){var s,o,a,l,c,u;return Vt(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2];o=!1,n.then(function(){s(),o=!0}),h.label=1;case 1:h.trys.push([1,,5,7]),l=void 0,c=0,u=function(){var f,g,d,p,m,y;return Vt(this,function(_){switch(_.label){case 0:f=c;try{for(g=(m=void 0,Br(t)),d=g.next();!d.done;d=g.next())p=d.value,Promise.resolve(p.next()).then(function(E){E.done?(n(),a===void 0&&(a=E)):c===f&&(c++,s(E))},function(E){return n(E)})}catch(E){m={error:E}}finally{try{d&&!d.done&&(y=g.return)&&y.call(g)}finally{if(m)throw m.error}}return[4,new Promise(function(E){return s=E})];case 1:return l=_.sent(),l===void 0?[3,3]:[4,i(l.value)];case 2:_.sent(),_.label=3;case 3:return[2]}})},h.label=2;case 2:return o?[3,4]:[5,u()];case 3:return h.sent(),[3,2];case 4:return[2,a&&a.value];case 5:return n(),[4,Promise.race(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}function KE(r){var e=this,t=Gn(r,{yieldValues:!0});return new Ri(function(i,n){return Rr(e,void 0,void 0,function(){var s,o,a,l=this;return Vt(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2];s=[],o=!1,n.then(function(){var u,h;o=!0;try{for(var f=Br(s),g=f.next();!g.done;g=f.next()){var d=g.value;d()}}catch(p){u={error:p}}finally{try{g&&!g.done&&(h=f.return)&&h.call(f)}finally{if(u)throw u.error}}}),c.label=1;case 1:return c.trys.push([1,,3,4]),[4,Promise.all(t.map(function(u,h){return Rr(l,void 0,void 0,function(){var f,g;return Vt(this,function(d){switch(d.label){case 0:d.trys.push([0,,6,9]),d.label=1;case 1:return o?[3,5]:(Promise.resolve(u.next()).then(function(p){return s[h](p)},function(p){return n(p)}),[4,new Promise(function(p){s[h]=p})]);case 2:return f=d.sent(),f===void 0?[3,4]:f.done?(a=f,[2]):[4,i(f.value)];case 3:d.sent(),d.label=4;case 4:return[3,1];case 5:return[3,9];case 6:return g=u.return,g?[4,u.return()]:[3,8];case 7:g=d.sent(),d.label=8;case 8:return[7];case 9:return[2]}})})}))];case 2:return c.sent(),[2,a&&a.value];case 3:return n(),[7];case 4:return[2]}})})})}function JE(r){var e=this,t=Gn(r,{returnValues:!0});return new Ri(function(i,n){return Rr(e,void 0,void 0,function(){var s,o,a,l;return Vt(this,function(c){switch(c.label){case 0:if(!t.length)return n(),[2,[]];o=!1,n.then(function(){s(),o=!0}),c.label=1;case 1:c.trys.push([1,,6,8]),c.label=2;case 2:return o?[3,5]:(Promise.all(t.map(function(u){return u.next()})).then(function(u){return s(u)},function(u){return n(u)}),[4,new Promise(function(u){return s=u})]);case 3:return a=c.sent(),a===void 0?[2]:(l=a.map(function(u){return u.value}),a.some(function(u){return u.done})?[2,l]:[4,i(l)]);case 4:return c.sent(),[3,2];case 5:return[3,8];case 6:return n(),[4,Promise.all(t.map(function(u){return u.return&&u.return()}))];case 7:return c.sent(),[7];case 8:return[2]}})})})}function QE(r){var e=this,t=Gn(r,{yieldValues:!0,returnValues:!0});return new Ri(function(i,n){return Rr(e,void 0,void 0,function(){var s,o,a,l,c,u=this;return Vt(this,function(h){switch(h.label){case 0:if(!t.length)return n(),[2,[]];o=[],a=!1,n.then(function(){var f,g;s();try{for(var d=Br(o),p=d.next();!p.done;p=d.next()){var m=p.value;m()}}catch(y){f={error:y}}finally{try{p&&!p.done&&(g=d.return)&&g.call(d)}finally{if(f)throw f.error}}a=!0}),h.label=1;case 1:return h.trys.push([1,,5,7]),Promise.all(t.map(function(f){return f.next()})).then(function(f){return s(f)},function(f){return n(f)}),[4,new Promise(function(f){return s=f})];case 2:return l=h.sent(),l===void 0?[2]:(c=l.map(function(f){return f.value}),l.every(function(f){return f.done})?[2,c]:[4,i(c.slice())]);case 3:return h.sent(),[4,Promise.all(t.map(function(f,g){return Rr(u,void 0,void 0,function(){var d;return Vt(this,function(p){switch(p.label){case 0:if(l[g].done)return[2,l[g].value];p.label=1;case 1:return a?[3,4]:(Promise.resolve(f.next()).then(function(m){return o[g](m)},function(m){return n(m)}),[4,new Promise(function(m){return o[g]=m})]);case 2:return d=p.sent(),d===void 0?[2,l[g].value]:d.done?[2,d.value]:(c[g]=d.value,[4,i(c.slice())]);case 3:return p.sent(),[3,1];case 4:return[2]}})})}))];case 4:return[2,h.sent()];case 5:return n(),[4,Promise.all(t.map(function(f){return f.return&&f.return()}))];case 6:return h.sent(),[7];case 7:return[2]}})})})}class na{constructor(e,t,i,n,s){re(this,"headerClient");re(this,"header");re(this,"headerLength");re(this,"indexLength");re(this,"nocache");this.headerClient=e,this.header=t,this.headerLength=i,this.indexLength=n,this.nocache=s}static async open(e,t){let i,n=new Ol(e,t),s=2024+(()=>{let c,u=0;for(c=0;c<3;c++)u+=VE**c*$E;return u})();if(!new Uint8Array(await n.getRange(0,8,s,"header")).subarray(0,3).every((c,u)=>At[u]===c))throw Error("Not a FlatGeobuf file");if((i=new DataView(await n.getRange(8,4,s,"header")).getUint32(0,!0))>10485760||i<8)throw Error("Invalid header size");let o=await n.getRange(12,i,s,"header"),a=Un(new ct(new Uint8Array(o))),l=Bn(a.featuresCount,a.indexNodeSize);return new na(n,a,i,l,t)}async*selectBbox(e){let t=this.lengthBeforeTree(),i=this.headerClient,n=async(l,c)=>i.getRange(t+l,c,0,"index"),s=[],o=[];for await(let l of ih(this.header.featuresCount,this.header.indexNodeSize,e,n)){let[c,u]=l,[,,h]=l;if(h||(h=4),o.length===0){o.push([c,h,u]);continue}let f=o[o.length-1];c-(f[0]+f[1])>gn.global.extraRequestThreshold()&&(s.push(o),o=[]),o.push([c,h,u])}this.headerClient.logUsage("header+index"),o.length>0&&s.push(o);let a=s.flatMap(l=>this.readFeatureBatch(l,this.nocache));yield*Ri.merge(a)}lengthBeforeTree(){return At.length+Ye+this.headerLength}lengthBeforeFeatures(){return this.lengthBeforeTree()+this.indexLength}buildFeatureClient(e){return new Ol(this.headerClient.httpClient,e)}async*readFeatureBatch(e,t){let[i]=e[0],[n,s]=e[e.length-1],o=this.buildFeatureClient(t),a=n+s-i;for(let[l,,c]of e){let u=await this.readFeature(o,l,a);yield{id:c,feature:u},a=0}o.logUsage("feature")}async readFeature(e,t,i){let n,s=t+this.lengthBeforeFeatures();n=new DataView(await e.getRange(s,4,i,"feature length")).getUint32(0,!0);let o=new Uint8Array(await e.getRange(s+4,n,i,"feature data")),a=new Uint8Array(n+Ye);a.set(o,Ye);let l=new ct(a);return l.setPosition(Ye),Qe.getRootAsFeature(l)}}class Ol{constructor(e,t){re(this,"httpClient");re(this,"bytesEverUsed",0);re(this,"bytesEverFetched",0);re(this,"buffer",new ArrayBuffer(0));re(this,"head",0);if(typeof e=="string")this.httpClient=new Ml(e,t);else if(e instanceof Ml)this.httpClient=e;else throw Error("Unknown source ")}async getRange(e,t,i,n){this.bytesEverUsed+=t;let s=e-this.head,o=s+t;if(s>=0&&o<=this.buffer.byteLength)return this.buffer.slice(s,o);let a=Math.max(t,i);return this.bytesEverFetched+=a,this.buffer=await this.httpClient.getRange(e,a,n),this.head=e,this.buffer.slice(0,t)}logUsage(e){e.split(" ")[0],(100*this.bytesEverUsed/this.bytesEverFetched).toFixed(2)}}class Ml{constructor(e,t){re(this,"url");re(this,"nocache");re(this,"requestsEverMade",0);re(this,"bytesEverRequested",0);this.url=e,this.nocache=t}async getRange(e,t,i){this.requestsEverMade+=1,this.bytesEverRequested+=t;let n={Range:`bytes=${e}-${e+t-1}`};return this.nocache&&(n["Cache-Control"]="no-cache, no-store"),await(await fetch(this.url,{headers:n})).arrayBuffer()}}async function*eb(r,e,t,i){if(!r.subarray(0,3).every((h,f)=>At[f]===h))throw Error("Not a FlatGeobuf file");if(t){let h=ra.open(r);for await(let f of h.selectBbox(t))yield e(f.id,f.feature,h.header);return}let n=new ct(r),s=n.readUint32(At.length);n.setPosition(At.length+Ye);let o=Un(n),a=At.length+Ye+s,{indexNodeSize:l,featuresCount:c}=o;l>0&&(a+=Bn(c,l));let u=0;for(;a<n.capacity();){let h=n.readUint32(a);n.setPosition(a+Ye);let f=Qe.getRootAsFeature(n);yield e(u++,f,o),a+=Ye+h}}async function*tb(r,e,t){let i,n=kE(r),s=async g=>await n.slice(g),o=new Uint8Array(await s(8));if(!o.subarray(0,3).every((g,d)=>At[d]===g))throw Error("Not a FlatGeobuf file");o=new Uint8Array(await s(4));let a=new ct(o),l=a.readUint32(0);o=new Uint8Array(await s(l));let c=Un(a=new ct(o)),{indexNodeSize:u,featuresCount:h}=c;if(u>0){let g=Bn(h,u);await s(g)}let f=0;for(;i=await ib(s,c,e,f++);)yield i}async function*rb(r,e,t,i,n=!1){let s=await na.open(r,n);for await(let o of s.selectBbox(e))yield t(o.id,o.feature,s.header)}async function ib(r,e,t,i){let n=new Uint8Array(await r(4,"feature length"));if(n.byteLength===0)return;let s=new ct(n),o=s.readUint32(0);n=new Uint8Array(await r(o,"feature data"));let a=new Uint8Array(o+4);return a.set(n,4),(s=new ct(a)).setPosition(Ye),t(i,Qe.getRootAsFeature(s),e)}function Us(r,e){let t=e;if(t===Ne.Unknown&&(t=r.type()),t===Ne.GeometryCollection){let n=[];for(let s=0;s<r.partsLength();s++){let o=r.parts(s),a=o.type();n.push(Us(o,a))}return{type:Ne[t],geometries:n}}if(t===Ne.MultiPolygon){let n=[];for(let s=0;s<r.partsLength();s++)n.push(Us(r.parts(s),Ne.Polygon));return{type:Ne[t],coordinates:n.map(s=>s.coordinates)}}let i=function(n,s){let o=n.xyArray(),a=n.zArray();switch(s){case Ne.Point:{let l=Array.from(o);return a&&l.push(a[0]),l}case Ne.MultiPoint:case Ne.LineString:return ns(o,a);case Ne.MultiLineString:case Ne.Polygon:return function(l,c,u){let h;if(!u||u.length===0)return[ns(l,c)];let f=0,g=Array.from(u).map(d=>l.slice(f,f=d<<1));return c&&(f=0,h=Array.from(u).map(d=>c.slice(f,f=d))),g.map((d,p)=>ns(d,h?h[p]:void 0))}(o,a,n.endsArray())}}(r,t);return{type:Ne[t],coordinates:i}}function sa(r,e,t){let i=t.columns;return{type:"Feature",id:r,geometry:Us(e.geometry(),t.geometryType),properties:DE(e,i)}}async function*nb(r,e,t){yield*eb(r,sa,e)}function sb(r,e){return tb(r,sa)}function ob(r,e,t,i=!1){return rb(r,e,sa,t,i)}function ab(r,e,t,i=!1){return r instanceof Uint8Array?nb(r,e):r instanceof ReadableStream?sb(r):ob(r,e,t,i)}const Nl=new ec({featureProjection:"EPSG:3857"});class lb extends bn{constructor(e){super({url:e.url,attributions:e.attributions,wrapX:e.wrapX,format:Nl,strategy:tf}),this.ressourceURL=e.url,super.setLoader(this.loader)}fgbBoundingBox(e,t){const i=fs(e,t.getCode(),"EPSG:4326");return{minX:i[0],minY:i[1],maxX:i[2],maxY:i[3]}}async loader(e,t,i,n,s){const o=this.fgbBoundingBox(e,i);try{if(o.minX!==-1/0){const a=[],l=ab(this.ressourceURL,o);for await(const c of l){const u=Nl.readFeature(c);a.push(u)}super.clear(),super.addFeatures(a),n(a)}}catch{s()}}}window.eoxMapAdvancedOlSources={BingMaps:jx,CartoDB:Hx,Cluster:Zx,DataTile:bi,GeoTIFF:Vo,Google:Qx,IIIF:tE,Image:tr,ImageArcGISRest:iE,ImageCanvas:nE,ImageMapGuide:lE,ImageStatic:Pu,ImageTile:Ju,OGCMapTile:mE,OGCVectorTile:_E,Raster:rh,Source:js,StadiaMaps:IE,TileArcGISRest:CE,TileDebug:FE,TileImage:Ft,TileJSON:Cu,UrlTile:rf,UTFGrid:ME,Zoomify:eE,WMTSCapabilities:NE,FlatGeoBuf:lb};const Dl=async(r,e,t)=>{qt.debug("Creating layers config",r,e,t);const i=[],n={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const h of e){let f;t?f=await h.createLayersJson(new Date(t)):f=await h.createLayersJson(),f.forEach(g=>{g.properties.layerControlExpand=!0,g.properties.layerControlToolsExpand=!0}),n.layers.push(...f)}i.push(n);const s=await ba.getIndicatorLayers(r),o=ba.getGeoDBLayer(e);o&&n.layers.unshift(o);const a={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},l=s.filter(h=>h.properties.group==="baselayer");if(l.length){let h=0,f=0;for(let g=0;g<l.length;g++){const d=l[g];"visible"in d.properties||(d.properties.visible=!1),d.properties.visible&&(h++,f=g)}h===0&&(l[0].properties.visible=!0),h>0&&l.forEach((g,d)=>{d!==f?g.properties.visible=!1:g.properties.visible=!0}),a.layers.push(...l),a.layers.forEach(g=>{g.properties.layerControlExclusive=!0})}else a.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});a.layers.length&&i.push(a);const c={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},u=s.filter(h=>h.properties.group==="overlay");return u.length&&(c.layers.push(...u),i.unshift(c)),i};let Gi=null;const cb=(r,e)=>{const t=i=>{var a;const n=i.map,s=(a=r.value)==null?void 0:a.lonLatCenter,o=n==null?void 0:n.getView().getZoom();s&&!Number.isNaN(s[0])&&!Number.isNaN(s[1])&&!Number.isNaN(o)&&(e.value=[s[0],s[1],o],Hr.value&&(Hr.value=!1))};oc(()=>{var i,n;(n=(i=r.value)==null?void 0:i.map)==null||n.on("moveend",t)}),ac(()=>{var i,n;(n=(i=r.value)==null?void 0:i.map)==null||n.un("moveend",t)})},Ul=(r,e,t,i,n,s,o)=>{qt.debug("InitMap",r.value,e.value,t.values,i.value);const a=jf(td),l=Wf([e,i],async([c,u],[h,f])=>{var g,d,p,m,y,_,E,S,v,w,A,C;if(c){qt.debug("Selected Indicator watch triggered",c,u),((g=r==null?void 0:r.value)==null?void 0:g.id)==="main"&&Gi!==null&&((d=r==null?void 0:r.value)==null||d.map.setView(Gi),Gi=null);let P=[];const R=(c==null?void 0:c.id)===(h==null?void 0:h.id)&&u!==f,{selectedCompareStac:U}=ms(_s());if(((p=r==null?void 0:r.value)==null?void 0:p.id)==="main"?await ed(c):U.value!==null&&(Gi=((m=r==null?void 0:r.value)==null?void 0:m.map.getView())??null,r.value.sync=s.value),R){P=await Dl(c,t,u),qt.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(P))),n.value=P,await xa(()=>{a.emit("time:updated",n.value)});return}P=await Dl(c,t,i.value);let M=null;const z=(_=(y=c==null?void 0:c.extent)==null?void 0:y.temporal)==null?void 0:_.interval;if(z&&z.length>0&&z[0].length>1&&(M=new Date(z[0][1]),qt.debug("Indicator load: found stac extent, setting time to latest value",M)),M!==null&&M.toISOString()!==i.value&&(i.value=M.toISOString()),o&&((E=r==null?void 0:r.value)==null?void 0:E.id)==="main"&&(S=c.extent)!=null&&S.spatial.bbox&&!Hr.value){const N=(v=c.extent)==null?void 0:v.spatial.bbox[0],G=[(N==null?void 0:N[0])>-180?N==null?void 0:N[0]:-180,(N==null?void 0:N[1])>-90?N==null?void 0:N[1]:-90,(N==null?void 0:N[2])<180?N==null?void 0:N[2]:180,(N==null?void 0:N[3])<90?N==null?void 0:N[3]:90],ie=(C=r.value)==null?void 0:C.transformExtent(G,"EPSG:4326",(A=(w=r.value)==null?void 0:w.map)==null?void 0:A.getView().getProjection());r.value.zoomExtent=ie}Hr.value&&(Hr.value=!1),qt.debug("Assigned layers",JSON.parse(JSON.stringify(P))),n.value=P,await xa(()=>{var N;(N=r.value)==null||N.updateComplete.then(()=>{a.emit("layers:updated",n.value)})})}},{immediate:!0});ac(()=>{l()})},Bl=(r,e)=>{qf(async()=>{const t=[];for(const i of r)t.push(...await i.getToolTipProperties());e.value=t,qt.debug("Updated tooltip properties",e.value)})};function ub(r){return 3*r*r-2*r*r*r}const hb=[".enabled"],fb=[".center",".zoom",".layers"],db=[".propertyTransform"],gb=[".layers"],pb=[".propertyTransform"],mb={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>[15,48]},zoom:{type:Number,default:4},zoomToExtent:{type:Boolean,default:!0}},setup(r){var y,_,E,S,v;const e=r,t=sr([]),i=sr([]),n={Attribution:{collapsible:!0}},s=ma([((y=Ii.value)==null?void 0:y[0])??((_=e.center)==null?void 0:_[0]),((E=Ii.value)==null?void 0:E[1])??((S=e.center)==null?void 0:S[1])]),o=ma(((v=Ii.value)==null?void 0:v[2])??e.zoom),a=sr([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),l=sr([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),c={duration:1200,easing:ub},u=sr(null),h=sr(null),{selectedCompareStac:f}=ms(_s()),g=$n(()=>e.enableCompare&&f.value?"":"first");cb(u,Ii),oc(()=>{const{selectedCompareStac:w,selectedStac:A}=ms(_s());Zf.value=u.value,e.enableCompare&&(Yf.value=h.value),e.enableCompare&&(Ul(h,w,Qf,Ea,l,u,!1),Bl(Vn,i)),Ul(u,A,Vn,Ea,a,h,e.zoomToExtent)}),Bl(Vn,t);const d=$n(()=>({visibility:t.value.length?"visible":"hidden"})),p=$n(()=>({visibility:i.value.length?"visible":"hidden"})),m=w=>{const A=w==="main"?t:i,C=w=="main"?Kf:Jf;return P=>{const R=JSON.parse(zf.render(JSON.stringify(A.value),{...C.value??{}})),U=R==null?void 0:R.find(M=>M.id===P.key);if(U)return typeof P.value=="object"&&(P.value=JSON.stringify(P.value)),isNaN(Number(P.value))||(P.value=Number(P.value).toFixed(4).toString()),{key:U.title||U.id,value:P.value+" "+(U.appendix||"")}}};return(w,A)=>(Xf(),Vf("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":g.value},[Li("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:u,id:"main",".animationOptions":c,".center":ya(s),".zoom":ya(o),".layers":a.value,".controls":n},[Li("eox-map-tooltip",{style:_a(d.value),".propertyTransform":m("main")},null,44,db)],40,fb),Li("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:h,".layers":l.value},[Li("eox-map-tooltip",{style:_a(p.value),".propertyTransform":m("compare")},null,44,pb)],40,gb)],40,hb))}},Ib=Object.freeze(Object.defineProperty({__proto__:null,default:mb},Symbol.toStringTag,{value:"Module"}));export{Ab as L,Pb as a,Ib as i};
