import{d as $,H as J,G as z,aV as g,aW as k,a as _,aX as E,aY as S,l as G,t as w,x as U,aZ as K,a_ as N,a$ as H,b0 as M,g as W}from"./eo-dash.CGZK6l7i.js";import{u as X,g as L,e as Y,a as Z,s as T,c as Q,p as j,b as ee,d as D,f as te,h as re}from"./async-B2-WW9U7.C6JF2uYr.js";import{t as ae}from"./item.koN_VtZd.js";async function ne({links:t,jsonformValue:a,specUrl:n,customEndpointsHandler:e,jsonformSchema:r,selectedStac:o,isPolling:l,jobs:c,enableCompare:s=!1}){if(!n||!t)return[null,null];const u=await g.get(n).then(h=>h.data),i={},[d,f]=T(t,"service",void 0),p=e&&a&&await e({jsonformSchema:r,jsonformValue:a,links:f,selectedStac:o,isPolling:l,jobs:c,enableCompare:s});if(p&&p.length)return u.data.values=p,[u,i];const v=d.filter(h=>h.rel==="service");try{e:for(const h of v??[])switch(h.type){case void 0:continue;case"application/json":await oe(u,{url:h.href,jsonformValue:a,link:h,flatstyleUrl:h["eox:flatstyle"]});break e;case"text/csv":await se(u,{url:h.href,jsonformValue:a,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[u,i]}async function oe(t,{url:a,jsonformValue:n,link:e,flatstyleUrl:r}){if(t.data){if(e.method=="GET"){const o=await V(a,n,r);t.data.values=await g.get(o).then(l=>l.data)}else if(e.method=="POST"){if(!e.body)return console.error("[eodash] Inline data POST request requires a body template"),t;const o=await g.get(e.body,{responseType:"text"}).then(c=>c.data),l=JSON.parse(w.render(o,{...n??{}}));t.data.values=await g.post(a,l).then(c=>c.data)}return t}}async function se(t,{url:a,jsonformValue:n,flatstyleUrl:e}){if(!t.data)return;const r=await V(a,n,e);return t.data.url=r,t}async function V(t,a,n){let e={};return n&&(e=await g.get(n).then(r=>r.data)),w.render(t,{...a??{},...e})}async function ie({links:t,jsonformValue:a,layerId:n,projection:e}){if(!t)return;const[r,o]=T(t,"service","image/tiff");if(!r.length)return;let l=[],c="";for(const u of r??[])l.push(w.render(u.href,{...a??{}}));return await Promise.all(r.map(u=>Q(u,n,l,e,c))).then(u=>u.filter(i=>!!i))}function le(t,a,n){if(!t)return;const e=t.filter(o=>o.rel==="service"&&o.type==="image/png"),r=[];for(const o of e)r.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:n,url:w.render(o.href,{...a??{}})}});return r}async function ce(t,a,n){if(!t)return;const e=[],r=t.filter(l=>l.rel==="service"&&l.type==="application/geo+json");if(!r.length)return e;let o=null;for(const l of r){"eox:flatstyle"in(l??{})&&(o=await g.get(l["eox:flatstyle"]).then(i=>i.data));let c,s;if(o){const i=K(n??"",o);c=i.layerConfig,s=i.style}const u={type:"Vector",source:{type:"Vector",url:w.render(l.href,{...a??{}}),format:"GeoJSON"},properties:{id:l.id+"_process",title:"Results "+n,...c&&{...c}},...s&&{style:s}};e.push(u)}return e}async function ue({links:t,jsonformValue:a,layerId:n,projection:e,origBbox:r,isPolling:o,selectedStac:l,jsonformSchema:c,jobs:s,customLayersHandler:u,enableCompare:i=!1}){if(!t)return[];const d=[],[f,p]=T(t,"service",void 0);if(u&&a&&l&&c&&p.length>0){const m=await u({jsonformValue:a,links:p,selectedStac:l,isPolling:o,jsonformSchema:c,jobs:s,enableCompare:i});m.length&&d.push(...m)}const v=await ce(f,a,n),h=le(f,a,r),C=await ie({links:f,jsonformValue:a,layerId:n,projection:e});return d.push(...v??[],...h??[],...C??[]),d}async function de(t,a,n=!1){const e=t.find(c=>c.rel==="service"&&c.type=="application/json; profile=collection"&&c.endpoint==="STAC");if(!e)return;let r=w.render(e.href,{...a??{}});U.value&&(U.value=!1);const o=_();await(n?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(r,!0)}async function fe({links:t,jsonformValue:a,isPolling:n,selectedStac:e,jobs:r,enableCompare:o=!1}){if(!n)return;const l=t.filter(s=>s.rel==="service"&&s.endpoint==="eoxhub_workspaces"),c=[];for(const s of l){const u=await g.get(s.body,{responseType:"text"}).then(f=>f.data),i=JSON.parse(w.render(u,{...a??{}})),d=o?S:k;try{const f=await g.post(s.href,i,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(d.value)||"[]");p.push(f.headers.location),localStorage.setItem(d.value,JSON.stringify(p));const v=await j({jobs:r,processUrl:f.headers.location,isPolling:n,enableCompare:o}).then(h=>ee(h)).catch(h=>(h instanceof Error?console.error("Polling failed:",h.message):console.error("Unknown error occurred during polling:",h),[]));await D(r,d.value),c.push(...await te(v,s,e))}catch(f){await D(r,d.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return c}const he=pe([fe]);function pe(t){return async a=>await Promise.all(t.map(n=>n(a))).then(n=>{const e=[];for(const r of n)e.push(...(r==null?void 0:r.filter(ge))??[]);return e})}function ge(t){return!!t&&!!t.type&&(!!t.source||!!t.layers)}async function ve({links:t,jsonformValue:a,jsonformSchema:n,selectedStac:e,enableCompare:r=!1}){const o=t.find(f=>f.rel==="service"&&f.endpoint==="sentinelhub");if(!o)return;const l=await be(e,r?N.value:H.value);if(!l){console.error("[eodash] evalscript link for sentinel hub not found in indicator",l);return}if(!o)return;const c=o.href,s=L(n),u=a[s],i=await ye();if(!i){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const d=re(e.extent.temporal.interval[0],[a.start_date,a.end_date],a.distribution);return await Promise.all(d.map(([f,p])=>we({url:c,bearer:i,bbox:u,from:p,to:f,exampleLink:l}).catch(v=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",v)))).then(f=>f.flat().map(p=>p.outputs.data))}async function ye(t,a){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function we({url:t,bearer:a,bbox:n,from:e,to:r,timeout:o=2e4,exampleLink:l}){if(!l){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!n){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!e||!r||new Date(e)>new Date(r)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",e,r);return}const c=await g.get(l.href,{responseType:"text"}).then(i=>i.data);if(!c||c.error){console.error("[eodash] Error (sentinelhub): evalscript not found",c);return}const s={input:{bounds:{bbox:n},data:[{dataFilter:{},type:l.dataId}]},aggregation:{evalscript:c,timeRange:{from:e,to:r},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},u={headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await g.post(t,s,u).then(i=>{const d=i.data.data;return d.forEach(f=>{f.outputs.data.date=e}),d}).catch(i=>{var d,f;if(((d=i.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=i.response)==null?void 0:f.data),[]})}async function be(t,a){const n=t.links.find(e=>e.rel==="example"&&e.title==="evalscript");if(n)return n;for(const e of M(t,a)){const r=g.get(e).then(o=>o.data.links.find(l=>l.rel==="example"&&l.title==="evalscript"));if(r)return r}}async function me({links:t,jsonformSchema:a,jsonformValue:n,selectedStac:e,enableCompare:r=!1}){const o=t.find(i=>i.rel==="service"&&i.endpoint==="veda");if(!o)return;const l=o==null?void 0:o.href,c=L(a),s=JSON.parse(n[c]),u=await xe(e,r?N.value:H.value);return await Promise.all(u.map(({endpoint:i,datetime:d})=>g.post(l+`?url=${i}`,{type:"Feature",properties:{},geometry:s}).then(f=>{const p=f.data.properties.statistics;return p.date=d,p}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function xe(t,a){const n=t.links.filter(s=>s.rel=="child"),e=[];n.length?e.push(...await Promise.all(n.map(s=>g.get(ae(s.href,a)).then(u=>u.data)))):e.push(t);const r=[];for(const s of e){const u=W(s.links);let i=s.links.filter(d=>d.rel=="item");r.push(...i.map(d=>({endpoint:d.cog_href,datetime:d[u]})))}r.sort((s,u)=>new Date(s.datetime).getTime()-new Date(u.datetime).getTime());const o=50;if(r.length<=o)return r;const l=r.length,c=[];for(let s=0;s<o;s++){const u=Math.floor(s*(l-1)/(o-1));c.push(r[u])}return c}const Ce=ke([ve,me]);function ke(t){return async a=>{for(const n of t){const e=await n(a);if(G.debug("Custom endpoint data:",e,"for callback:",n.name,"inputs:",a),!(!e||!e.length||e.some(o=>!o)))return e}return null}}async function Ie({selectedStac:t,jsonformEl:a,jsonformSchema:n,chartSpec:e,isProcessed:r,processResults:o,loading:l,isPolling:c,enableCompare:s}){var d,f;const u=s?!!J.value:!!z.value;let i=null;if((d=t.value)!=null&&d["eodash:jsonform"]&&(i=await g.get(t.value["eodash:jsonform"]).then(p=>p.data)),!i&&u){n.value=null;return}Pe({loading:l,isProcessed:r,chartSpec:e,jsonformSchema:n,isPolling:c,processResults:o}),await((f=a.value)==null?void 0:f.editor.destroy()),i&&(s&&(i=X(i)),n.value=i)}async function Oe({loading:t,selectedStac:a,jsonformEl:n,jsonformSchema:e,chartSpec:r,chartData:o,isPolling:l,processResults:c,mapElement:s,jobs:u}){var i,d,f,p,v,h,C,m,I,O,A;if(!(!n.value||!e.value||!a.value)){G.debug("Processing..."),t.value=!0;try{const b=(d=(i=a.value)==null?void 0:i.links)==null?void 0:d.filter(y=>y.rel==="service"),F=L(e.value),x=(f=n.value)==null?void 0:f.value;Y(x,e.value);const B=x[F],q=(p=a.value)==null?void 0:p["eodash:vegadefinition"],R=((v=a.value)==null?void 0:v.id)??"";[r.value,o.value]=await ne({links:b,jsonformValue:{...x??{}},jsonformSchema:e.value,enableCompare:(s==null?void 0:s.id)==="compare",selectedStac:a.value,specUrl:q,isPolling:l,jobs:u,customEndpointsHandler:Ce}),Object.keys(o.value??{}).length&&c.value.push(o.value),(m=(C=(h=r.value)==null?void 0:h.data)==null?void 0:C.values)!=null&&m.length&&c.value.push((I=r.value)==null?void 0:I.data.values),r.value&&!("background"in r.value)&&(r.value.background="transparent"),await de(b,x,(s==null?void 0:s.id)==="compare");const P=await ue({isPolling:l,links:b,jsonformValue:{...x??{}},jsonformSchema:e.value,selectedStac:a.value,enableCompare:(s==null?void 0:s.id)==="compare",layerId:R,origBbox:B,jobs:u,customLayersHandler:he,projection:(O=a.value["eodash:mapProjection"])==null?void 0:O.name});if(P.length)for(const y of P)y.type==="WebGLTile"&&((A=y.source)==null?void 0:A.type)==="GeoTIFF"?c.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&c.value.push(y.source.url);Z(s,P),t.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),t.value=!1,b}}}function Pe({loading:t,isProcessed:a,chartSpec:n,jsonformSchema:e,processResults:r,isPolling:o}){t.value=!1,a.value=!1,o.value=!1,n.value=null,r.value=[],e.value=null}const Ae=t=>{var r,o,l,c,s,u;const a=(r=t.target)==null?void 0:r.spec;if(!a||!((l=(o=t.detail)==null?void 0:o.item)!=null&&l.datum)||!((s=(c=t.detail)==null?void 0:c.item)!=null&&s.datum.datum))return;const n=Object.keys(a.encoding??{}).find(i=>{var d;return((d=a.encoding)==null?void 0:d[i].type)==="temporal"});if(!n)return;const e=(u=a.encoding)==null?void 0:u[n].field;if(e)try{const i=t.detail.item;let d="";i.datum&&i.datum.datum?d=i.datum.datum[e]:d=i.datum[e];const f=new Date(d);$.value=f.toISOString()}catch(i){console.warn("[eodash] Error while setting datetime from eox-chart:",i)}},Ee=()=>{var n,e;k.value||(k.value=new URLSearchParams(window.location.search).get("indicator")??"");const t=_(),a=(n=t.stac)==null?void 0:n.find(r=>E(r)===k.value);if(t.loadSelectedSTAC(a==null?void 0:a.href),J.value)if(S.value){const r=(e=t.stac)==null?void 0:e.find(o=>E(o)===S.value);t.loadSelectedCompareSTAC(r==null?void 0:r.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else t.resetSelectedCompareSTAC()};export{Oe as h,Ie as i,Ee as l,Ae as o};
